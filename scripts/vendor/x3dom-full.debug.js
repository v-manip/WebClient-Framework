function defineClass(a,b,c){function d(){}if(a&&(d.prototype=a.prototype,b.prototype=new d,b.prototype.constructor=b,b.superClass=a),c)for(var e in c)b.prototype[e]=c[e];return b}function array_to_object(a){for(var b={},c=0;c<a.length;c++)b[a[c]]="";return b}function startDashVideo(a,b){var c,d,e,f=function(){var a={};return window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(b,c,d){a[c]=d}),a},g=a;f&&f.hasOwnProperty("url")&&(g=f.url),c=document.querySelector(b),d=new Dash.di.DashContext,e=new MediaPlayer(d),e.startup(),e.attachView(c),e.setAutoPlay(!1),e.attachSource(g)}function setNamespace(a,b,c){b instanceof Element&&void 0!==b.__setAttribute&&(b.hasAttribute("id")?b.__setAttribute("id",a.toString().replace(" ","")+"__"+b.getAttribute("id")):b.hasAttribute("DEF")&&c&&b.__setAttribute("id",a.toString().replace(" ","")+"__"+b.getAttribute("DEF"))),b.hasChildNodes()&&Array.forEach(b.childNodes,function(b){setNamespace(a,b,c)})}function NodeProducer(){var a=null,b=1e6,c=1e6;this.AddNewNode=function(d,e){d.Level()<c&&(c=d.Level(),a=d),d.Level()===c&&b>e&&(e=b,a=d)},this.CreateNewNode=function(){null!==a&&a.CreateChildren(),a=null,c=1e3}}function QuadtreeNode2dWMTS(a,b,c,d,e,f,g,h){function i(){var c=new x3dom.nodeTypes.Appearance(a),d=new x3dom.nodeTypes.ImageTexture(a);n._nameSpace=b._nameSpace;var f=new x3dom.nodeTypes.TextureProperties(a);f._vf.boundaryModeS="CLAMP_TO_EDGE",f._vf.boundaryModeT="CLAMP_TO_EDGE",f._vf.boundaryModeR="CLAMP_TO_EDGE",f._vf.minificationFilter="LINEAR",f._vf.magnificationFilter="LINEAR",d.addChild(f,"textureProperties"),d.nodeChanged(),d._nameSpace=b._nameSpace,d._vf.url[0]=r,o=e.e3(),c.addChild(d),d.nodeChanged(),n.addChild(c),c.nodeChanged(),n.addChild(h),h.nodeChanged(),b.addChild(n),n.nodeChanged(),t.boundedNode=n,t.volume=n.getVolume()}function j(){var i=Math.sqrt(Math.pow(4,c)),j=Math.sqrt(Math.pow(4,c+1)),k=4*Math.floor(d/i)*i+2*(d%i),l=k+1,n=k+j,o=n+1,p=b._vf.size.multiply(.25);m.push(new QuadtreeNode2dWMTS(a,b,c+1,k,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-p.x,p.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f,2*g,h)),m.push(new QuadtreeNode2dWMTS(a,b,c+1,l,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(p.x,p.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f+1,2*g,h)),m.push(new QuadtreeNode2dWMTS(a,b,c+1,n,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-p.x,-p.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f,2*g+1,h)),m.push(new QuadtreeNode2dWMTS(a,b,c+1,o,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(p.x,-p.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f+1,2*g+1,h))}function k(){p=!0;for(var a=0;a<n._webgl.texture.length;a++)n._webgl.texture[a].texture.ready||(p=!1);return p}function l(a,b){q=!0;for(var c=0;c<m.length;c++)m[c].Ready()||(q=!1);if(m.length<4)q=!1;else if(q)for(var c=0;c<m.length;c++)m[c].Shape()._vf.render=!0;void 0===n._webgl||void 0===n._webgl.texture?a.context.setupShape(a.gl,{shape:n,transform:b},a.viewarea):k()}var m=[],n=new x3dom.nodeTypes.Shape,o=null,p=!1,q=!1,r=b._vf.textureUrl+"/"+c+"/"+f+"/"+g+"."+b._vf.textureFormat.toLowerCase(),s=(b._vf.size.x+b._vf.size.y)/2,t={};this.CreateChildren=function(){j()},this.Shape=function(){return n},this.Ready=function(){return void 0!==n._webgl&&void 0!==n._webgl.texture?k():!1},this.collectDrawables=function(a,d,f,g,h){if(t.localMatrix=e,h=d.cull(e,t,f,h),p&&q||l(d,e),p&&h>0){var i=d.viewMatrix,j=i.multMatrixPnt(e.multMatrixPnt(o)),k=Math.sqrt(Math.pow(j.x,2)+Math.pow(j.y,2)+Math.pow(j.z,2));if(k<Math.pow(b._vf.maxDepth-c,2)*s/b._vf.factor||c<b._vf.minDepth)if(b.view.isMovingOrAnimating()&&0===m.length||b.view.isMovingOrAnimating()&&c>=b._vf.interactionDepth)n.collectDrawableObjects(e,d,f,g,h);else if(0===m.length)b.nodeProducer.AddNewNode(u,k),n.collectDrawableObjects(e,d,f,g,h);else if(q)for(var r=0;r<m.length;r++)m[r].collectDrawables(e,d,f,g,h);else{n.collectDrawableObjects(e,d,f,g,h);for(var r=0;r<m.length;r++)m[r].collectDrawables(e,d,f,g,h),m[r].Shape()._vf.render=!1}else n.collectDrawableObjects(e,d,f,g,h)}},this.getVolume=function(){return n.getVolume()},this.Level=function(){return c};var u=this;i()}function QuadtreeNode2D(a,b,c,d,e,f,g,h,i,j){function k(){var c=new x3dom.nodeTypes.Appearance(a),d=new x3dom.nodeTypes.ImageTexture(a);p._nameSpace=b._nameSpace;var f=new x3dom.nodeTypes.TextureProperties(a);f._vf.boundaryModeS="CLAMP_TO_EDGE",f._vf.boundaryModeT="CLAMP_TO_EDGE",f._vf.boundaryModeR="CLAMP_TO_EDGE",f._vf.minificationFilter="LINEAR",f._vf.magnificationFilter="LINEAR",d.addChild(f,"textureProperties"),d.nodeChanged(),d._nameSpace=b._nameSpace,d._vf.url[0]=t,q=e.e3(),c.addChild(d),d.nodeChanged(),p.addChild(c),c.nodeChanged(),p.addChild(h),h.nodeChanged(),b.addChild(p),p.nodeChanged(),v.boundedNode=p,v.volume=p.getVolume()}function l(){var k=Math.sqrt(Math.pow(4,c)),l=Math.sqrt(Math.pow(4,c+1)),m=4*Math.floor(d/k)*k+2*(d%k),n=m+1,p=m+l,q=p+1,r=b._vf.size.multiply(.25);o.push(new QuadtreeNode2D(a,b,c+1,m,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-r.x,r.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f,2*g,h,i+j+"/",1)),o.push(new QuadtreeNode2D(a,b,c+1,n,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(r.x,r.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f+1,2*g,h,i+j+"/",3)),o.push(new QuadtreeNode2D(a,b,c+1,p,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-r.x,-r.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f,2*g+1,h,i+j+"/",2)),o.push(new QuadtreeNode2D(a,b,c+1,q,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(r.x,-r.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f+1,2*g+1,h,i+j+"/",4))}function m(){r=!0;for(var a=0;a<p._webgl.texture.length;a++)p._webgl.texture[a].texture.ready||(r=!1);return r}function n(a,b){s=!0;for(var c=0;c<o.length;c++)o[c].Ready()||(s=!1);if(o.length<4)s=!1;else if(s)for(var c=0;c<o.length;c++)o[c].Shape()._vf.render=!0;void 0===p._webgl||void 0===p._webgl.texture?a.context.setupShape(a.gl,{shape:p,transform:b},a.viewarea):m()}var o=[],p=new x3dom.nodeTypes.Shape,q=null,r=!1,s=!1,t=b._vf.textureUrl+i+j+"."+b._vf.textureFormat,u=(b._vf.size.x+b._vf.size.y)/2,v={};this.CreateChildren=function(){l()},this.Shape=function(){return p},this.Ready=function(){return void 0!==p._webgl&&void 0!==p._webgl.texture?m():!1},this.collectDrawables=function(a,d,f,g,h){if(v.localMatrix=e,r&&s||n(d,e),r&&(h=d.cull(e,v,f,h))>0){var i=d.viewMatrix,j=i.multMatrixPnt(e.multMatrixPnt(q)),k=Math.sqrt(Math.pow(j.x,2)+Math.pow(j.y,2)+Math.pow(j.z,2));if(k<Math.pow(b._vf.maxDepth-c,2)*u/b._vf.factor||c<b._vf.minDepth)if(b.view.isMovingOrAnimating()&&0===o.length||b.view.isMovingOrAnimating()&&c>=b._vf.interactionDepth)p.collectDrawableObjects(e,d,f,g,h);else if(0===o.length)b.nodeProducer.AddNewNode(w,k),p.collectDrawableObjects(e,d,f,g,h);else if(s)for(var l=0;l<o.length;l++)o[l].collectDrawables(e,d,f,g,h);else{p.collectDrawableObjects(e,d,f,g,h);for(var l=0;l<o.length;l++)o[l].collectDrawables(e,d,f,g,h),o[l].Shape()._vf.render=!1}else p.collectDrawableObjects(e,d,f,g,h)}},this.getVolume=function(){return p.getVolume()},this.Level=function(){return c};var w=this;k()}function QuadtreeNode3D(a,b,c,d,e,f,g,h){function i(){var c=new x3dom.nodeTypes.Appearance(a),d=new x3dom.nodeTypes.MultiTexture(a),f=new x3dom.nodeTypes.ImageTexture(a),g=new x3dom.nodeTypes.ImageTexture(a),i=new x3dom.nodeTypes.ImageTexture(a),m=new x3dom.nodeTypes.ComposedShader(a);s._nameSpace=b._nameSpace,t=e.e3(),t.z=b._vf.maxElevation/2;var n=new x3dom.nodeTypes.ShaderPart(a);n._vf.type="vertex",n._vf.url[0]=k();var o=new x3dom.nodeTypes.ShaderPart(a);o._vf.type="fragment",o._vf.url[0]=l(),m.addChild(n,"parts"),m.addChild(o,"parts");var p=new x3dom.nodeTypes.TextureProperties(a);p._vf.boundaryModeS="CLAMP_TO_EDGE",p._vf.boundaryModeT="CLAMP_TO_EDGE",p._vf.boundaryModeR="CLAMP_TO_EDGE",p._vf.minificationFilter="LINEAR",p._vf.magnificationFilter="LINEAR",f.addChild(p,"textureProperties"),f.nodeChanged(),f._nameSpace=b._nameSpace,f._vf.url[0]=u,f._vf.repeatT=!1,f._vf.repeatS=!1,d.addChild(f,"texture"),f.nodeChanged();var q=new x3dom.nodeTypes.Field(a);q._vf.name="texColor",q._vf.type="SFInt32",q._vf.value=0,m.addChild(q,"fields"),q.nodeChanged();var r=new x3dom.nodeTypes.TextureProperties(a);r._vf.boundaryModeS="CLAMP_TO_EDGE",r._vf.boundaryModeT="CLAMP_TO_EDGE",r._vf.boundaryModeR="CLAMP_TO_EDGE",r._vf.minificationFilter="NEAREST",r._vf.magnificationFilter="NEAREST",g.addChild(r,"textureProperties"),g.nodeChanged(),g._nameSpace=b._nameSpace,g._vf.url[0]=v,g._vf.repeatT=!1,g._vf.repeatS=!1,g._vf.scale=!1,d.addChild(g,"texture"),g.nodeChanged();var x=new x3dom.nodeTypes.Field(a);if(x._vf.name="texHeight",x._vf.type="SFInt32",x._vf.value=1,m.addChild(x,"fields"),x.nodeChanged(),""!==b._vf.normalUrl){var y=new x3dom.nodeTypes.TextureProperties(a);y._vf.boundaryModeS="CLAMP_TO_EDGE",y._vf.boundaryModeT="CLAMP_TO_EDGE",y._vf.boundaryModeR="CLAMP_TO_EDGE",y._vf.minificationFilter="LINEAR",y._vf.magnificationFilter="LINEAR",i.addChild(y,"textureProperties"),i.nodeChanged(),i._nameSpace=b._nameSpace,i._vf.url[0]=w,i._vf.repeatT=!1,i._vf.repeatS=!1,d.addChild(i,"texture"),i.nodeChanged();var z=new x3dom.nodeTypes.Field(a);z._vf.name="texNormal",z._vf.type="SFInt32",z._vf.value=2,m.addChild(z,"fields"),z.nodeChanged()}var B=new x3dom.nodeTypes.Field(a);B._vf.name="maxElevation",B._vf.type="SFFloat",B._vf.value=b._vf.maxElevation,m.addChild(B,"fields"),B.nodeChanged(),c.addChild(d),d.nodeChanged(),c.addChild(m),m.nodeChanged(),s.addChild(c),c.nodeChanged(),s.addChild(h),b.addChild(s),s.nodeChanged(),A.boundedNode=s,A.volume=s.getVolume(),A.volume.max.z=b._vf.maxElevation,A.volume.min.z=0,A.volume.center=A.volume.min.add(A.volume.max).multiply(.5),A.volume.transform(e),j()}function j(){for(var a=0,e=0;c>e;e++)a+=Math.pow(4,e);var h=a+d;b.nodeList[h]=D;var i=Math.sqrt(Math.pow(4,c));r[0]=a+(Math.ceil((d+1)/i-1)*i+(d+(i-1))%i),r[1]=a+(Math.ceil((d+1)/i-1)*i+(d+1)%i),r[3]=a+(d+i*(i-1))%Math.pow(4,c),r[2]=a+(d+i)%Math.pow(4,c),0===f&&(r[0]=-1),0===g&&(r[3]=-1),f===i-1&&(r[1]=-1),g===i-1&&(r[2]=-1)}function k(){return""!==b._vf.normalUrl?"attribute vec3 position;\nattribute vec3 texcoord;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform sampler2D texColor;\nuniform sampler2D texHeight;\nuniform float maxElevation;\nuniform sampler2D texNormal;\nvarying vec2 texC;\nvarying vec3 vLight;\nconst float shininess = 32.0;\n\nvoid main(void) {\n    vec3 uLightPosition = vec3(160.0, -9346.0, 4806.0);\n    vec4 colr = texture2D(texColor, vec2(texcoord[0], 1.0-texcoord[1]));\n    vec3 uAmbientMaterial = vec3(1.0, 1.0, 0.9);    vec3 uAmbientLight = vec3(0.5, 0.5, 0.5);    vec3 uDiffuseMaterial = vec3(0.7, 0.7, 0.7);    vec3 uDiffuseLight = vec3(1.0, 1.0, 1.0);    vec4 vertexPositionEye4 = modelViewMatrix * vec4(position, 1.0);    vec3 vertexPositionEye3 = vec3((modelViewMatrix * vec4(vertexPositionEye4.xyz, 1.0)).xyz);    vec3 vectorToLightSource = normalize(uLightPosition - vertexPositionEye3);    vec4 height = texture2D(texHeight, vec2(texcoord[0], 1.0 - texcoord[1]));\n    vec4 normalEye = 2.0 * texture2D(texNormal, vec2(texcoord[0], 1.0-texcoord[1])) - 1.0;\n    float diffuseLightWeighting = max(dot(normalEye.xyz, vectorToLightSource), 0.0);    texC = vec2(texcoord[0], 1.0-texcoord[1]);\n    vec3 diffuseReflectance = uDiffuseMaterial * uDiffuseLight * diffuseLightWeighting;    vec3 uSpecularMaterial = vec3(0.0, 0.0, 0.0);    vec3 uSpecularLight = vec3(1.0, 1.0, 1.0);    vec3 reflectionVector = normalize(reflect(-vectorToLightSource, normalEye.xyz));    vec3 viewVectorEye = -normalize(vertexPositionEye3);    float rdotv = max(dot(reflectionVector, viewVectorEye), 0.0);    float specularLightWeight = pow(rdotv, shininess);    vec3 specularReflection = uSpecularMaterial * uSpecularLight * specularLightWeight;    vLight = vec4(uAmbientMaterial * uAmbientLight + diffuseReflectance + specularReflection, 1.0).xyz;    gl_Position = modelViewProjectionMatrix * vec4(position.xy, height.x * maxElevation, 1.0);\n}\n":"attribute vec3 position;\nattribute vec3 texcoord;\nuniform mat4 modelViewProjectionMatrix;\nuniform sampler2D texHeight;\nuniform float maxElevation;\nvarying vec2 texC;\n\nvoid main(void) {\n    vec4 height = texture2D(texHeight, vec2(texcoord[0], 1.0 - texcoord[1]));\n    texC = vec2(texcoord[0], 1.0-texcoord[1]);\n    gl_Position = modelViewProjectionMatrix * vec4(position.xy, height.x * maxElevation, 1.0);\n}\n"}function l(){return""!==b._vf.normalUrl?"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D texColor;\nuniform sampler2D texNormal;\nvarying vec2 texC;\nvarying vec3 vLight;\n\n\nvoid main(void) {\n    vec4 normal = 2.0 * texture2D(texNormal, texC) - 1.0;\n    vec4 colr = texture2D(texColor, texC);\n    gl_FragColor = vec4(colr.xyz * vLight, colr.w);\n}\n":"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D texColor;\nvarying vec2 texC;\n\n\nvoid main(void) {\n    gl_FragColor = texture2D(texColor, texC);\n}\n"}function m(){var i=Math.sqrt(Math.pow(4,c)),j=Math.sqrt(Math.pow(4,c+1)),k=4*Math.floor(d/i)*i+2*(d%i),l=k+1,m=k+j,n=m+1,o=b._vf.size.multiply(.25);q.push(new QuadtreeNode3D(a,b,c+1,k,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-o.x,o.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f,2*g,h)),q.push(new QuadtreeNode3D(a,b,c+1,l,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(o.x,o.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f+1,2*g,h)),q.push(new QuadtreeNode3D(a,b,c+1,m,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-o.x,-o.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f,2*g+1,h)),q.push(new QuadtreeNode3D(a,b,c+1,n,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(o.x,-o.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f+1,2*g+1,h))}function n(){x=!0;for(var a=0;a<s._webgl.texture.length;a++)s._webgl.texture[a].texture.ready||(x=!1);return x}function o(a,b){y=!0;for(var c=0;c<q.length;c++)q[c].Ready()||(y=!1);if(q.length<4)y=!1;else if(y)for(var c=0;c<q.length;c++)q[c].Shape()._vf.render=!0;void 0===s._webgl||void 0===s._webgl.texture?a.context.setupShape(a.gl,{shape:s,transform:b},a.viewarea):n()}function p(a,c,d,f,g){for(var h=[],i=0;i<r.length;i++)void 0!==b.nodeList[r[i]]?b.nodeList[r[i]].ChildrenReady()&&b.nodeList[r[i]].hasHigherRenderLevel(c)?h.push(!0):h.push(!1):h.push(!1);var j=0;h[3]?j=h[1]?5:h[0]?6:4:h[2]?j=h[1]?8:h[0]?7:3:h[0]?j=1:h[1]&&(j=2),(B!==j||null===C)&&(C=s._cf.geometry.node.getTriangulationAttributes(j),B=j),s._tessellationProperties=[C],s.collectDrawableObjects(e,c,d,f,g)}var q=[],r=[],s=new x3dom.nodeTypes.Shape,t=null,u=b._vf.textureUrl+"/"+c+"/"+f+"/"+g+"."+b._vf.textureFormat.toLowerCase(),v=b._vf.elevationUrl+"/"+c+"/"+f+"/"+g+"."+b._vf.elevationFormat.toLowerCase();if(""!==b._vf.normalUrl)var w=b._vf.normalUrl+"/"+c+"/"+f+"/"+g+"."+b._vf.normalFormat.toLowerCase();var x=!1,y=!1,z=(b._vf.size.x+b._vf.size.y)/2,A={},B=0,C=null;this.CreateChildren=function(){m()},this.Shape=function(){return s},this.ChildrenReady=function(){return y},this.Ready=function(){return void 0!==s._webgl&&void 0!==s._webgl.texture?n():!1},this.collectDrawables=function(a,d,f,g,h){d.frustumCulling=!1,A.localMatrix=e,x&&y||o(d,e);var i=d.viewMatrix,j=i.multMatrixPnt(e.multMatrixPnt(t)),k=Math.sqrt(Math.pow(j.x,2)+Math.pow(j.y,2)+Math.pow(j.z,2));if(x&&j.z-A.volume.diameter/2<0)if(k<Math.pow(b._vf.maxDepth-c,2)*z/b._vf.factor||c<b._vf.minDepth)if(b.view.isMovingOrAnimating()&&(0==q.length||c>=b._vf.interactionDepth))p(e,d,f,g,h);else if(0===q.length)b.nodeProducer.AddNewNode(D,k),p(e,d,f,g,h);else if(y)for(var l=0;l<q.length;l++)q[l].collectDrawables(e,d,f,g,h);else{p(e,d,f,g,h);for(var l=0;l<q.length;l++)q[l].collectDrawables(e,d,f,g,h),q[l].Shape()._vf.render=!1}else p(e,d,f,g,h)},this.hasHigherRenderLevel=function(a){var d=a.viewMatrix,f=d.multMatrixPnt(e.multMatrixPnt(t)),g=Math.sqrt(Math.pow(f.x,2)+Math.pow(f.y,2)+Math.pow(f.z,2));return g<Math.pow(b._vf.maxDepth-c,2)*z/b._vf.factor?!0:!1},this.getVolume=function(){return s.getVolume()},this.Level=function(){return c};var D=this;i()}function QuadtreeNodeBin(a,b,c,d,e,f){function g(){this._nameSpace=new x3dom.NodeNameSpace("",b._nameSpace.doc),this._nameSpace.setBaseURL(b._nameSpace.baseURL+u);var c=A.getElementsByTagName("Shape")[0];if(y=this._nameSpace.setupTree(c),!b._vf.useNormals){var d=new x3dom.nodeTypes.Appearance(a),e=new x3dom.nodeTypes.Material(a);d.addChild(e),y._cf.appearance=d}w=x3dom.fields.SFVec3f.copy(y._cf.geometry.node._vf.position)}function h(){o.boundedNode=y,o.volume=y.getVolume()}function i(){q.push(new QuadtreeNodeBin(a,b,c+1,2*d,2*e,f)),q.push(new QuadtreeNodeBin(a,b,c+1,2*d+1,2*e,f)),q.push(new QuadtreeNodeBin(a,b,c+1,2*d,2*e+1,f)),q.push(new QuadtreeNodeBin(a,b,c+1,2*d+1,2*e+1,f))}function j(){return s=!0,y._webgl.internalDownloadCount>0&&(s=!1),s}function k(a,b){t=!0;for(var c=0;c<q.length;c++)q[c].Ready()||(t=!1);if(t)for(var c=0;c<q.length;c++)q[c].Shape()._vf.render=!0;null!==y._cf.geometry.node&&(void 0===y._webgl||void 0===y._webgl.internalDownloadCount?a.context.setupShape(a.gl,{shape:y,transform:b},a.viewarea):j())}var l,m,n,o={},p=.1*(.25*Math.pow(c,2)+1.5)*b._vf.factor,q=[],r=!1,s=!1,t=!1,u=b._vf.url+"/"+c+"/"+d+"/",v=u+e+".x3d",w=new x3dom.fields.SFVec3f(0,0,0),x=!1,y=new x3dom.nodeTypes.Shape(a),z=new XMLHttpRequest;z.open("GET",v,!1);try{z.send();var A=z.responseXML;null!==A&&(new RegExp('"',"g"),g(y),h(),x=!0)}catch(B){x3dom.debug.logException("Error loading file '"+v+"': "+B)}this.Exists=function(){return x},this.Shape=function(){return y},this.CreateChildren=function(){i()},this.Ready=function(){return void 0!==y._webgl&&void 0!==y._webgl.internalDownloadCount?j():!1},this.collectDrawables=function(a,d,e,f,g){if(p=.1*(.25*Math.pow(c,2)+1.5)*b._vf.factor,o.localMatrix=a,s&&t||k(d,a),s&&x&&(g=d.cull(a,o,e,g))>0)if(l=d.viewMatrix,m=l.multMatrixPnt(a.multMatrixPnt(w)),n=Math.sqrt(Math.pow(m.x,2)+Math.pow(m.y,2)+Math.pow(m.z,2)),n<1e3*(Math.pow(b._vf.maxDepth-c,2)/p)||c<b._vf.minDepth)if(b.view.isMovingOrAnimating()&&c>=b._vf.interactionDepth)y.collectDrawableObjects(a,d,e,f,g);else if(0===q.length)b.nodeProducer.AddNewNode(C,n),y.collectDrawableObjects(a,d,e,f,g);else if(0===q.length&&b.createChildren>0)y.collectDrawableObjects(a,d,e,f,g);else{if(!r)for(var h=0;h<q.length;h++)if(q[h].Exists()){r=!0;break}if(r&&t)for(var h=0;h<q.length;h++)q[h].collectDrawables(a,d,e,f,g);else{for(var h=0;h<q.length;h++)q[h].collectDrawables(a,d,e,f,g),q[h].Shape()._vf.render=!1;y.collectDrawableObjects(a,d,e,f,g)}}else y.collectDrawableObjects(a,d,e,f,g)},this.getVolume=function(){return y.getVolume()},this.Level=function(){return c};var C=this;h()}function BVHNode(a,b,c,d,e,f){function g(){this._nameSpace=new x3dom.NodeNameSpace("",b._nameSpace.doc),this._nameSpace.setBaseURL(b._nameSpace.baseURL+b._vf.url+d);var c=z.getElementsByTagName("Shape")[0];if(x=this._nameSpace.setupTree(c),!b._vf.useNormals){var e=new x3dom.nodeTypes.Appearance(a),f=new x3dom.nodeTypes.Material(a);e.addChild(f),x._cf.appearance=e}v=x3dom.fields.SFVec3f.copy(x._cf.geometry.node._vf.position)}function h(){o.boundedNode=x,o.volume=x.getVolume()}function i(){for(var g=0;f>g;g++)q.push(new BVHNode(a,b,c+1,d+e+"/",g+1,f))}function j(){return x._webgl.internalDownloadCount<=0}function k(a,b){for(var c=0;c<q.length;c++)t=!0,q[c].Ready()?q[c].Shape()._vf.render=!0:t=!1;null!==x._cf.geometry.node&&(void 0===x._webgl||void 0===x._webgl.internalDownloadCount?a.context.setupShape(a.gl,{shape:x,transform:b},a.viewarea):j())}var l,m,n,o={},p=.1*(.25*Math.pow(c,2)+1.5)*b._vf.factor,q=[],r=!1,s=!1,t=!1,u=b._vf.url+d+e+".x3d",v=new x3dom.fields.SFVec3f(0,0,0),w=!1,x=new x3dom.nodeTypes.Shape(a);this.RecalcFactor=function(){p=.1*(.25*Math.pow(c,2)+1.5)*b._vf.factor;for(var a=0;a<q.length;a++)q[a].RecalcFactor()};var y=new XMLHttpRequest;y.open("GET",u,!1);try{y.send();var z=y.responseXML;null!==z&&(new RegExp('"',"g"),g(x),h(),w=!0)}catch(A){x3dom.debug.logException("Error loading file '"+u+"': "+A)}this.Exists=function(){return w},this.Shape=function(){return x},this.CreateChildren=function(){i()},this.Ready=function(){return void 0!==x._webgl&&void 0!==x._webgl.internalDownloadCount?j():!1},this.collectDrawables=function(a,d,e,f,g){if(p=.1*(.25*Math.pow(c,2)+1.5)*b._vf.factor,o.localMatrix=a,s&&t||k(d,a),s&&w&&(g=d.cull(a,o,e,g))>0)if(l=d.viewMatrix,m=l.multMatrixPnt(a.multMatrixPnt(v)),n=Math.sqrt(Math.pow(m.x,2)+Math.pow(m.y,2)+Math.pow(m.z,2)),n<Math.pow(b._vf.maxDepth-c,2)/p||c<b._vf.minDepth)if(b.view.isMovingOrAnimating()&&c>=b._vf.interactionDepth)x.collectDrawableObjects(a,d,e,f,g);else if(0===q.length)b.nodeProducer.AddNewNode(B,n),x.collectDrawableObjects(a,d,e,f,g);else if(0===q.length&&b.createChildren>0)x.collectDrawableObjects(a,d,e,f,g);else{if(!r)for(var h=0;h<q.length;h++)if(q[h].Exists()){r=!0;break}if(r&&t)for(var h=0;h<q.length;h++)q[h].collectDrawables(a,d,e,f,g);else{for(var h=0;h<q.length;h++)q[h].collectDrawables(a,d,e,f,g),q[h].Shape()._vf.render=!1;x.collectDrawableObjects(a,d,e,f,g)}}else x.collectDrawableObjects(a,d,e,f,g)},this.getVolume=function(){return x.getVolume()},this.Level=function(){return c};var B=this;h()}function QuadtreeNode3D_NEW(a,b,c,d,e,f,g,h){function i(){var c=new x3dom.nodeTypes.Appearance(a),d=new x3dom.nodeTypes.CommonSurfaceShader(a),f=new x3dom.nodeTypes.SurfaceShaderTexture(a),g=new x3dom.nodeTypes.ImageTexture(a),i=new x3dom.nodeTypes.SurfaceShaderTexture(a),j=new x3dom.nodeTypes.ImageTexture(a);l._nameSpace=b._nameSpace,m=e.e3(),d._vf.displacementFactor=b._vf.maxElevation,g._nameSpace=b._nameSpace,g._vf.url[0]=n,g._vf.repeatT=!1,g._vf.repeatS=!1,f.addChild(g,"texture"),g.nodeChanged(),d.addChild(f,"diffuseTexture"),f.nodeChanged(),j._nameSpace=b._nameSpace,j._vf.url[0]=o,j._vf.repeatT=!1,j._vf.repeatS=!1,i.addChild(j,"texture"),j.nodeChanged(),d.addChild(i,"displacementTexture"),j.nodeChanged(),c.addChild(d,"shaders"),d.nodeChanged(),l.addChild(c),c.nodeChanged(),l.addChild(h),h.nodeChanged(),b.addChild(l),l.nodeChanged(),r.boundedNode=l,r.volume=l.getVolume(),r.volume.max.z=Math.round(b._vf.maxElevation/2),r.volume.min.z=-r.volume.max.z}function j(){var i=Math.sqrt(Math.pow(4,c)),j=Math.sqrt(Math.pow(4,c+1)),l=4*Math.floor(d/i)*i+2*(d%i),m=l+1,n=l+j,o=n+1,p=b._vf.size.multiply(.25);k.push(new QuadtreeNode3D_NEW(a,b,c+1,l,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-p.x,p.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f,2*g,h)),k.push(new QuadtreeNode3D_NEW(a,b,c+1,m,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(p.x,p.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f+1,2*g,h)),k.push(new QuadtreeNode3D_NEW(a,b,c+1,n,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-p.x,-p.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f,2*g+1,h)),k.push(new QuadtreeNode3D_NEW(a,b,c+1,o,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(p.x,-p.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f+1,2*g+1,h))}var k=[],l=new x3dom.nodeTypes.Shape,m=null,n=b._vf.textureUrl+"/"+c+"/"+f+"/"+g+"."+b._vf.textureFormat.toLowerCase(),o=b._vf.elevationUrl+"/"+c+"/"+f+"/"+g+"."+b._vf.elevationFormat.toLowerCase();b._vf.normalUrl+"/"+c+"/"+f+"/"+g+"."+b._vf.normalFormat.toLowerCase();var p=!0,q=(b._vf.size.x+b._vf.size.y)/2,r={};this.collectDrawables=function(a,d,f,g,h){if(r.localMatrix=e,p&&(h=d.cull(a,r,f,h))>0){var i=d.viewMatrix,n=i.multMatrixPnt(a.multMatrixPnt(m)),o=Math.sqrt(Math.pow(n.x,2)+Math.pow(n.y,2)+Math.pow(n.z,2));if(o<Math.pow(b._vf.maxDepth-c,2)*q/b._vf.factor)if(0===k.length&&0===b.createChildren)b.createChildren++,j(),l.collectDrawableObjects(e,d,f,g,h);else if(0===k.length&&b.createChildren>0)l.collectDrawableObjects(e,d,f,g,h);else for(var s=0;s<k.length;s++)k[s].collectDrawables(e,d,f,g,h);else l.collectDrawableObjects(e,d,f,g,h)}},this.getVolume=function(){return l.getVolume()},i()}function OctreeNode(a,b,c,d){function e(){var c=new x3dom.nodeTypes.Appearance(a),d=new x3dom.nodeTypes.Box(a);d._vf.size=b._vf.octSize,d.fieldChanged("size"),i._nameSpace=new x3dom.NodeNameSpace("",b._nameSpace.doc),i._nameSpace.setBaseURL(b._nameSpace.baseURL),i.addChild(c),c.nodeChanged(),i.addChild(d),d.nodeChanged(),i.nodeChanged(),j.boundedNode=i,j.volume=i.getVolume()}function f(){var e=b._vf.octSize.multiply(.25);g.push(new OctreeNode(a,b,c+1,d.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-e.x,e.y,e.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),g.push(new OctreeNode(a,b,c+1,d.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(e.x,e.y,e.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),g.push(new OctreeNode(a,b,c+1,d.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-e.x,-e.y,e.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),g.push(new OctreeNode(a,b,c+1,d.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(e.x,-e.y,e.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),g.push(new OctreeNode(a,b,c+1,d.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-e.x,e.y,-e.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),g.push(new OctreeNode(a,b,c+1,d.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(e.x,e.y,-e.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),g.push(new OctreeNode(a,b,c+1,d.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-e.x,-e.y,-e.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),g.push(new OctreeNode(a,b,c+1,d.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(e.x,-e.y,-e.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5)))))}var g=[],h=d.e3(),i=new x3dom.nodeTypes.Shape(a),j={},k=(b._vf.octSize.x+b._vf.octSize.y+b._vf.octSize.z)/3;this.collectDrawables=function(a,e,l,m,n){if(j.localMatrix=d,(n=e.cull(a,j,l,n))>0){var o=e.viewMatrix,p=o.multMatrixPnt(a.multMatrixPnt(h)),q=Math.sqrt(Math.pow(p.x,2)+Math.pow(p.y,2)+Math.pow(p.z,2));if(q<Math.pow(b._vf.maxDepth-c,2)*k/b._vf.factor)if(0===g.length)f();else for(var r=0;r<g.length;r++)g[r].collectDrawables(d,e,l,m,n);else i.collectDrawableObjects(d,e,l,m,n)}},this.getVolume=function(){return i.getVolume()},e()}function QuadtreeNode3D_32bit(a,b,c,d,e,f,g,h){function i(){var c=new x3dom.nodeTypes.Appearance(a),d=new x3dom.nodeTypes.MultiTexture(a),f=new x3dom.nodeTypes.ImageTexture(a),g=new x3dom.nodeTypes.ImageTexture(a),i=new x3dom.nodeTypes.ImageTexture(a),l=new x3dom.nodeTypes.ComposedShader(a);n._nameSpace=b._nameSpace,o=e.e3();var m=new x3dom.nodeTypes.ShaderPart(a);m._vf.type="vertex",m._vf.url[0]=j();var s=new x3dom.nodeTypes.ShaderPart(a);s._vf.type="fragment",s._vf.url[0]=k(),l.addChild(m,"parts"),l.addChild(s,"parts"),f._nameSpace=b._nameSpace,f._vf.url[0]=p,f._vf.repeatT=!1,f._vf.repeatS=!1,f._vf.generateMipMaps=!1,d.addChild(f,"texture"),f.nodeChanged();var t=new x3dom.nodeTypes.Field(a);t._vf.name="texColor",t._vf.type="SFInt32",t._vf.value=0,l.addChild(t,"fields"),t.nodeChanged(),g._nameSpace=b._nameSpace,g._vf.url[0]=q,g._vf.repeatT=!1,g._vf.repeatS=!1,d.addChild(g,"texture"),g.nodeChanged();var v=new x3dom.nodeTypes.Field(a);v._vf.name="texHeight",v._vf.type="SFInt32",v._vf.value=1,l.addChild(v,"fields"),v.nodeChanged(),i._nameSpace=b._nameSpace,i._vf.url[0]=r,i._vf.repeatT=!1,i._vf.repeatS=!1,d.addChild(i,"texture"),i.nodeChanged();var w=new x3dom.nodeTypes.Field(a);w._vf.name="texNormal",w._vf.type="SFInt32",w._vf.value=2,l.addChild(w,"fields"),w.nodeChanged();var x=new x3dom.nodeTypes.Field(a);x._vf.name="maxElevation",x._vf.type="SFFloat",x._vf.value=b._vf.maxElevation,l.addChild(x,"fields"),x.nodeChanged(),c.addChild(d),d.nodeChanged(),c.addChild(l),l.nodeChanged(),n.addChild(c),c.nodeChanged(),n.addChild(h),h.nodeChanged(),b.addChild(n),n.nodeChanged(),u.boundedNode=n,u.volume=n.getVolume(),u.volume.max.z=Math.round(b._vf.maxElevation),u.volume.min.z=-u.volume.max.z}function j(){return"attribute vec3 position;\nattribute vec3 texcoord;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform sampler2D texColor;\nuniform sampler2D texHeight;\nuniform float maxElevation;\nuniform sampler2D texNormal;\nvarying vec2 texC;\nvarying vec3 vLight;\nconst float shininess = 32.0;\n\nvoid main(void) {\n    vec3 uLightPosition = vec3(160.0, -9346.0, 4806.0);\n    vec4 colr = texture2D(texColor, vec2(texcoord[0], 1.0-texcoord[1]));\n    vec3 uAmbientMaterial = vec3(1.0, 1.0, 0.9);    vec3 uAmbientLight = vec3(0.5, 0.5, 0.5);    vec3 uDiffuseMaterial = vec3(0.7, 0.7, 0.7);    vec3 uDiffuseLight = vec3(1.0, 1.0, 1.0);    vec4 vertexPositionEye4 = modelViewMatrix * vec4(position, 1.0);    vec3 vertexPositionEye3 = vec3((modelViewMatrix * vec4(vertexPositionEye4.xyz, 1.0)).xyz);    vec3 vectorToLightSource = normalize(uLightPosition - vertexPositionEye3);    vec4 height = texture2D(texHeight, vec2(texcoord[0], 1.0 - texcoord[1]));\n    vec4 normalEye = 2.0 * texture2D(texNormal, vec2(texcoord[0], 1.0-texcoord[1])) - 1.0;\n    float diffuseLightWeighting = max(dot(normalEye.xyz, vectorToLightSource), 0.0);    texC = vec2(texcoord[0], 1.0-texcoord[1]);\n    vec3 diffuseReflectance = uDiffuseMaterial * uDiffuseLight * diffuseLightWeighting;    vec3 uSpecularMaterial = vec3(0.0, 0.0, 0.0);    vec3 uSpecularLight = vec3(1.0, 1.0, 1.0);    vec3 reflectionVector = normalize(reflect(-vectorToLightSource, normalEye.xyz));    vec3 viewVectorEye = -normalize(vertexPositionEye3);    float rdotv = max(dot(reflectionVector, viewVectorEye), 0.0);    float specularLightWeight = pow(rdotv, shininess);    vec3 specularReflection = uSpecularMaterial * uSpecularLight * specularLightWeight;    vLight = vec4(uAmbientMaterial * uAmbientLight + diffuseReflectance + specularReflection, 1.0).xyz;    gl_Position = modelViewProjectionMatrix * vec4(position.xy, ((height.g * 256.0)+height.b) * maxElevation, 1.0);\n}\n"}function k(){return"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D texColor;\nuniform sampler2D texNormal;\nvarying vec2 texC;\nvarying vec3 vLight;\n\n\nvoid main(void) {\n    vec4 normal = 2.0 * texture2D(texNormal, texC) - 1.0;\n    vec4 colr = texture2D(texColor, texC);\n    float coler = ((colr.g * 256.0)+colr.b);    gl_FragColor = vec4(vLight * coler, 1.0);\n}\n"}function l(){var i=Math.sqrt(Math.pow(4,c)),j=Math.sqrt(Math.pow(4,c+1)),k=4*Math.floor(d/i)*i+2*(d%i),l=k+1,n=k+j,o=n+1,p=b._vf.size.multiply(.25);m.push(new QuadtreeNode3D_32bit(a,b,c+1,k,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-p.x,p.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f,2*g,h)),m.push(new QuadtreeNode3D_32bit(a,b,c+1,l,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(p.x,p.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f+1,2*g,h)),m.push(new QuadtreeNode3D_32bit(a,b,c+1,n,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-p.x,-p.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f,2*g+1,h)),m.push(new QuadtreeNode3D_32bit(a,b,c+1,o,e.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(p.x,-p.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*f+1,2*g+1,h))
}var m=[],n=new x3dom.nodeTypes.Shape,o=null,p=b._vf.textureUrl+"/"+c+"/"+f+"/"+g+"."+b._vf.textureFormat.toLowerCase(),q=b._vf.elevationUrl+"/"+c+"/"+f+"/"+g+"."+b._vf.elevationFormat.toLowerCase(),r=b._vf.normalUrl+"/"+c+"/"+f+"/"+g+"."+b._vf.normalFormat.toLowerCase(),s=!0,t=(b._vf.size.x+b._vf.size.y)/2,u={};this.collectDrawables=function(a,d,f,g,h){if(u.localMatrix=e,s&&(h=d.cull(a,u,f,h))>0){var i=d.viewMatrix,j=i.multMatrixPnt(a.multMatrixPnt(o)),k=Math.sqrt(Math.pow(j.x,2)+Math.pow(j.y,2)+Math.pow(j.z,2));if(k<Math.pow(b._vf.maxDepth-c,2)*t/b._vf.factor)if(0===m.length&&0===b.createChildren)b.createChildren++,l(),n.collectDrawableObjects(e,d,f,g,h);else if(0===m.length&&b.createChildren>0)n.collectDrawableObjects(e,d,f,g,h);else for(var p=0;p<m.length;p++)m[p].collectDrawables(e,d,f,g,h);else n.collectDrawableObjects(e,d,f,g,h)}},this.getVolume=function(){return n.getVolume()},i()}Array.forEach||(Array.forEach=function(a,b,c){for(var d=a.length,e=0;d>e;e++)e in a&&b.call(c,a[e],e,a)}),Array.map||(Array.map=function(a,b,c){for(var d=a.length,e=[],f=0;d>f;f++)f in a&&(e[f]=b.call(c,a[f],f,a));return e}),Array.filter||(Array.filter=function(a,b,c){for(var d=a.length,e=[],f=0;d>f;f++)if(f in a){var g=a[f];b.call(c,g,f,a)&&e.push(g)}return e});var x3dom={canvases:[]};x3dom.x3dNS="http://www.web3d.org/specifications/x3d-namespace",x3dom.x3dextNS="http://philip.html5.org/x3d/ext",x3dom.xsltNS="http://www.w3.org/1999/XSL/x3dom.Transform",x3dom.xhtmlNS="http://www.w3.org/1999/xhtml",x3dom.nodeTypes={},x3dom.nodeTypesLC={},x3dom.components={},x3dom.geoCache=[],x3dom.caps={PLATFORM:navigator.platform,AGENT:navigator.userAgent},x3dom.registerNodeType=function(a,b,c){void 0===x3dom.components[b]&&(x3dom.components[b]={}),c._typeName=a,c._compName=b,x3dom.components[b][a]=c,x3dom.nodeTypes[a]=c,x3dom.nodeTypesLC[a.toLowerCase()]=c},x3dom.isX3DElement=function(a){return a.nodeType===Node.ELEMENT_NODE&&a.localName&&(x3dom.nodeTypes[a.localName]||x3dom.nodeTypesLC[a.localName.toLowerCase()]||"x3d"===a.localName.toLowerCase()||"websg"===a.localName.toLowerCase()||"scene"===a.localName.toLowerCase()||"route"===a.localName.toLowerCase())},x3dom.extend=function(a){function b(){}return b.prototype=a.prototype||a,new b},x3dom.getStyle=function(a,b){var c="";return document.defaultView.getComputedStyle&&document.defaultView.getComputedStyle(a,null)?c=document.defaultView.getComputedStyle(a,null).getPropertyValue(b):a.currentStyle&&(b=b.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()}),c=a.currentStyle[b]),c},x3dom.isa=function(a,b){function c(a){return a===b?!0:a.prototype&&a.prototype.constructor&&a.prototype.constructor.superClass?c(a.prototype.constructor.superClass):!1}return a?a.constructor===b?!0:void 0===a.constructor.superClass?!1:c(a.constructor.superClass):!1},x3dom.getGlobal=function(){return function(){return this}.call(null)},x3dom.loadJS=function(src,path_prefix,blocking){var blocking=blocking===!1?blocking:!0;if(blocking){var url=path_prefix?path_prefix.trim()+src:src,req=new XMLHttpRequest;req&&(req.open("GET",url,!1),req.send(null),eval(req.responseText))}else{var head=document.getElementsByTagName("HEAD").item(0),script=document.createElement("script"),loadpath=path_prefix?path_prefix.trim()+src:src;head?(x3dom.debug.logError("Trying to load external JS file: "+loadpath),script.type="text/javascript",script.src=loadpath,head.appendChild(script,head.firstChild)):alert("No document object found. Can't load components!")}},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,16)}}(),x3dom.toggleFullScreen=function(){if(document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen)document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen();else{var a=document.documentElement;a.requestFullScreen?a.requestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullScreen&&a.webkitRequestFullScreen()}},x3dom.debug={INFO:"INFO",WARNING:"WARNING",ERROR:"ERROR",EXCEPTION:"EXCEPTION",isActive:!1,isFirebugAvailable:!1,isSetup:!1,isAppend:!1,numLinesLogged:0,maxLinesToLog:1e4,logContainer:null,setup:function(){if(!x3dom.debug.isSetup){try{void 0!==window.console.firebug&&(x3dom.debug.isFirebugAvailable=!0)}catch(a){x3dom.debug.isFirebugAvailable=!1}x3dom.debug.setupLogContainer(),x3dom.debug.isSetup=!0}},activate:function(a){x3dom.debug.isActive=!0,x3dom.debug.logContainer.style.display=a?"block":"none",x3dom.debug.isAppend||("Microsoft Internet Explorer"==navigator.appName?(x3dom.debug.logContainer.style.marginLeft="8px",document.documentElement.appendChild(x3dom.debug.logContainer)):document.body.appendChild(x3dom.debug.logContainer),x3dom.debug.isAppend=!0)},setupLogContainer:function(){x3dom.debug.logContainer=document.createElement("div"),x3dom.debug.logContainer.id="x3dom_logdiv",x3dom.debug.logContainer.setAttribute("class","x3dom-logContainer"),x3dom.debug.logContainer.style.clear="both"},doLog:function(a,b){if(x3dom.debug.isActive&&(x3dom.debug.numLinesLogged===x3dom.debug.maxLinesToLog&&(a="Maximum number of log lines (="+x3dom.debug.maxLinesToLog+") reached. Deactivating logging..."),!(x3dom.debug.numLinesLogged>x3dom.debug.maxLinesToLog))){var c=document.createElement("p");switch(c.style.margin=0,b){case x3dom.debug.INFO:c.style.color="#00ff00";break;case x3dom.debug.WARNING:c.style.color="#cd853f";break;case x3dom.debug.ERROR:c.style.color="#ff4500";break;case x3dom.debug.EXCEPTION:c.style.color="#ffff00";break;default:c.style.color="#00ff00"}try{c.innerHTML=b+": "+a,x3dom.debug.logContainer.insertBefore(c,x3dom.debug.logContainer.firstChild)}catch(d){void 0!==window.console.firebug&&window.console.warn(a)}if(x3dom.debug.isFirebugAvailable)switch(b){case x3dom.debug.INFO:window.console.info(a);break;case x3dom.debug.WARNING:window.console.warn(a);break;case x3dom.debug.ERROR:window.console.error(a);break;case x3dom.debug.EXCEPTION:window.console.debug(a)}x3dom.debug.numLinesLogged++}},logInfo:function(a){x3dom.debug.doLog(a,x3dom.debug.INFO)},logWarning:function(a){x3dom.debug.doLog(a,x3dom.debug.WARNING)},logError:function(a){x3dom.debug.doLog(a,x3dom.debug.ERROR)},logException:function(a){x3dom.debug.doLog(a,x3dom.debug.EXCEPTION)},assert:function(a,b){a||x3dom.debug.doLog("Assertion failed in "+x3dom.debug.assert.caller.name+": "+b,x3dom.debug.ERROR)},typeOf:function(a){var b=typeof a;return"object"!==b||a?b:"null"},exists:function(a,b,c){return c=c||"function",(a?this.typeOf(a[b]):"null")===c},dumpFields:function(a){var b="";for(var c in a)b+=c+", ";return b+="\n",x3dom.debug.logInfo(b),b}},x3dom.debug.setup(),x3dom.arc={},x3dom.arc.instance=null,x3dom.arc.Limits=function(a,b){this._min=a,this._max=b,this.getValue=function(a){return a=this._min+(this._max-this._min)*a,this._max>=a?this._min<=a?a:this._min:this._max}},x3dom.arc.ARF=function(a,b,c,d,e,f,g,h){this._name=a,this._stateValue=[.5,.5],this._limits=new x3dom.arc.Limits(b,c),this._factorGetterFunc=e,this._factorSetterFunc=f,this._setterFunc=h,this._getterFunc=g,this._dirFac=d,this.getFactor=function(){return this._factorGetterFunc()},this.update=function(a,b){var c=this._stateValue[a]+b*this._dirFac;this._stateValue[a]=c>=0?1>=c?c:1:0,this._setterFunc(this._limits.getValue(this._stateValue[a]))},this.reset=function(){this._stateValue[0]=.5,this._stateValue[1]=.5}},x3dom.arc.AdaptiveRenderControl=defineClass(null,function(a){x3dom.arc.instance=this,this._scene=a,this._targetFrameRate=[],this._targetFrameRate[0]=this._scene._vf.minFrameRate,this._targetFrameRate[1]=this._scene._vf.maxFrameRate,this._currentState=0;var b=this,c=b._scene.getEnvironment();this._arfs=[],this._arfs.push(new x3dom.arc.ARF("smallFeatureCulling",0,10,-1,function(){return c._vf.smallFeatureFactor},function(a){c._vf.smallFeatureFactor=a},function(){return c._vf.smallFeatureThreshold},function(a){c._vf.smallFeatureThreshold=a})),this._arfs.push(new x3dom.arc.ARF("lowPriorityCulling",0,100,1,function(){return c._vf.lowPriorityFactor},function(a){c._vf.lowPriorityFactor=a},function(){return 100*c._vf.lowPriorityThreshold},function(a){c._vf.lowPriorityThreshold=a/100})),this._arfs.push(new x3dom.arc.ARF("tessellationDetailCulling",1,12,-1,function(){return c._vf.tessellationErrorFactor},function(a){c._vf.tessellationErrorFactor=a},function(){return c.tessellationErrorThreshold},function(a){c.tessellationErrorThreshold=a})),this._stepWidth=.1},{update:function(a,b){this._currentState=a;var c=b-this._targetFrameRate[a];this._stepWidth=Math.abs(c)>10?.1:.01;var d,e=0,f=[],g=this._arfs.length;for(d=0;g>d;++d)f[d]=this._arfs[d].getFactor(),f[d]>0&&(e+=f[d]);var h=0>c?-1:1;for(d=0;g>d;++d)f[d]>0&&(f[d]/=e,this._arfs[d].update(a,this._stepWidth*f[d]*h))},reset:function(){for(var a=0,b=this._arfs.length;b>a;++a)this._arfs[a].reset()}});var Request=function(a,b,c){this.url=a,this.priority=c,this.xhr=new XMLHttpRequest,this.onloadCallbacks=[b];var d=this;this.xhr.onload=function(){if(x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager received data for URL '"+d.url+"'."),--x3dom.DownloadManager.activeDownloads,x3dom.DownloadManager.stallToKeepOrder===!1||x3dom.DownloadManager.resultGetsStalled(d.priority)===!1){var a;for(a=0;a<d.onloadCallbacks.length;++a)d.onloadCallbacks[a](d.xhr.response);x3dom.DownloadManager.removeDownload(d),x3dom.DownloadManager.updateStalledResults()}else x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager stalled downloaded result for URL '"+d.url+"'.");x3dom.DownloadManager.tryNextDownload()}};Request.prototype.send=function(){this.xhr.open("GET",encodeURI(this.url),!0),this.xhr.responseType="arraybuffer",this.xhr.send(null),x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager posted XHR for URL '"+this.url+"'.")},x3dom.DownloadManager={requests:[],maxDownloads:6,activeDownloads:0,debugOutput:!1,stallToKeepOrder:!1,toggleDebugOutput:function(a){this.debugOutput=a},toggleStrictReturnOrder:function(){this.stallToKeepOrder=!1},removeDownload:function(a){var b,c,d=!1;for(b=0;b<this.requests.length&&!d;++b)if(this.requests[b])for(c=0;c<this.requests[b].length;++c)if(this.requests[b][c]===a){this.requests[b].splice(c,1),d=!0;break}},tryNextDownload:function(){var a,b,c;if(this.activeDownloads<this.maxDownloads){for(b=0;b<this.requests.length&&!a;++b)if(this.requests[b])for(c=0;c<this.requests[b].length;++c)if(this.requests[b][c].xhr.readyState===XMLHttpRequest.UNSENT){a=this.requests[b][c];break}a&&(a.send(),++this.activeDownloads)}},resultGetsStalled:function(a){var b;for(b=0;a>b;++b)if(this.requests[b]&&this.requests[b].length)return!0;return!1},updateStalledResults:function(){if(x3dom.DownloadManager.stallToKeepOrder){var a,b,c,d,e=!1;for(a=0;a<this.requests.length&&!e;++a)if(this.requests[a])for(b=0;b<this.requests[a].length;++b)if(d=this.requests[a][b],d.xhr.readyState===XMLHttpRequest.DONE){for(x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager releases stalled result for URL '"+d.url+"'."),c=0;c<d.onloadCallbacks.length;++c)d.onloadCallbacks[c](d.xhr.response);this.requests[a].splice(b,1)}else e=!0}},get:function(a,b,c){var d,e,f,g,h,i,j,k=!1;if(a.length!==b.length||a.length!==c.length)return x3dom.debug.logError("DownloadManager: The number of given urls, onload callbacks and priorities is not equal. Ignoring requests."),void 0;for(f=0;f<a.length;++f)if(void 0!==!b[f]&&void 0!==!c[f]){for(h=a[f],i=b[f],j=c[f],d=0;d<this.requests.length&&!k;++d)if(this.requests[d])for(e=0;e<this.requests[d].length;++e)if(this.requests[d][e].url===h){this.requests[d][e].onloadCallbacks.push(i),x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager appended onload callback for URL '"+h+"' to a registered request using the same URL."),k=!0;break}k||(g=new Request(h,i,j),this.requests[j]?this.requests[j].push(g):this.requests[j]=[g])}else x3dom.debug.logError('DownloadManager: No onload callback and / or priority specified. Ignoring request for "'+h+'"');for(d=0;d<a.length&&this.activeDownloads<this.maxDownloads;++d)this.tryNextDownload()}};var JOB_WAITING_FOR_DATA=0,JOB_DATA_AVAILABLE=1,JOB_GETTING_PROCESSED=2,JOB_FINISHED=3;x3dom.RefinementJobManager=function(){var a=this;"undefined"!=typeof Worker?(this.worker=new Worker((new x3dom.RefinementJobWorker).toBlob()),this.worker.postMessage=this.worker.webkitPostMessage||this.worker.postMessage,this.worker.addEventListener("message",function(b){return a.messageFromWorker(b)},!1)):x3dom.RefinementJobManager.suppressOnWorkersNotSupported||(x3dom.RefinementJobManager.suppressOnWorkersNotSupported=!0,x3dom.RefinementJobManager.onWorkersNotSupported()),this.attributes=[]},x3dom.RefinementJobManager.suppressOnTransferablesNotSupported=!0,x3dom.RefinementJobManager.suppressOnWorkersNotSupported=!1,x3dom.RefinementJobManager.onTransferablesNotSupported=function(){alert("Your browser does not support transferables.\nThis application might run slower than expected due to data cloning operations.")},x3dom.RefinementJobManager.onWorkersNotSupported=function(){alert("WebWorkers are not supported by your browser. Unable to use RefinementJobManager.")},x3dom.RefinementJobManager.prototype.addResultBuffer=function(a,b){this.attributes[a]={resultBuffer:b.buffer,resultBufferBytesPerElement:b.BYTES_PER_ELEMENT,jobs:[]}},x3dom.RefinementJobManager.prototype.addRefinementJob=function(a,b,c,d,e,f,g,h,i,j){var k=this,l={priority:b,url:c,level:d,finishedCallback:e,stride:f,numComponentsList:g,bitsPerLevelList:h,readOffsetList:i,writeOffsetList:j,state:JOB_WAITING_FOR_DATA,dataBuffer:{}};this.attributes[a].jobs.push(l);var m;!function(a,b){m=function(c){k.jobInputDataLoaded(a,b,c)}}(a,c),x3dom.DownloadManager.get([c],[m],[b])},x3dom.RefinementJobManager.prototype.jobInputDataLoaded=function(a,b,c){var d,e=this.attributes[a].jobs;for(d=0;d<e.length;++d)e[d].url===b&&(e[d].state=JOB_DATA_AVAILABLE,e[d].dataBuffer=c,this.tryNextJob(a))},x3dom.RefinementJobManager.prototype.tryNextJob=function(a){var b,c,d=this.attributes[a].jobs,e=!0,f=-1;for(b=0;b<d.length;++b){if(d[b].state===JOB_GETTING_PROCESSED){e=!1;break}-1===f&&d[b].state===JOB_DATA_AVAILABLE&&(f=b)}e&&-1!==f&&(c=d[f],c.state=JOB_GETTING_PROCESSED,this.worker.postMessage({msg:"processJob",attributeId:a,level:c.level,stride:c.stride,numComponentsList:c.numComponentsList,bitsPerLevelList:c.bitsPerLevelList,readOffsetList:c.readOffsetList,writeOffsetList:c.writeOffsetList,resultBufferBytesPerElement:this.attributes[a].resultBufferBytesPerElement,dataBuffer:c.dataBuffer,resultBuffer:this.attributes[a].resultBuffer},[c.dataBuffer,this.attributes[a].resultBuffer]),(c.dataBuffer.byteLength>0||this.attributes[a].resultBuffer.byteLength>0)&&!x3dom.RefinementJobManager.suppressOnTransferablesNotSupported&&(x3dom.RefinementJobManager.suppressOnTransferablesNotSupported=!0,x3dom.RefinementJobManager.onTransferablesNotSupported()))},x3dom.RefinementJobManager.prototype.processedDataAvailable=function(a,b){var c,d=this.attributes[a].jobs;for(this.attributes[a].resultBuffer=b,c=0;c<d.length;++c)if(d[c].state===JOB_GETTING_PROCESSED){d[c].state=JOB_FINISHED,d[c].finishedCallback(a,this.getBufferView(a));break}},x3dom.RefinementJobManager.prototype.continueProcessing=function(a){this.tryNextJob(a)},x3dom.RefinementJobManager.prototype.messageFromWorker=function(a){if(a.data.msg)switch(a.data.msg){case"jobFinished":this.processedDataAvailable(a.data.attributeId,a.data.resultBuffer);break;case"log":x3dom.debug.logInfo("Message from Worker Context: "+a.data.txt)}},x3dom.RefinementJobManager.prototype.getBufferView=function(a){var b=this.attributes[a];switch(b.resultBufferBytesPerElement){case 1:return new Uint8Array(b.resultBuffer);case 2:return new Uint16Array(b.resultBuffer);case 4:return new Uint32Array(b.resultBuffer);default:x3dom.debug.logError("Unable to create BufferView: the given number of "+b.resultBufferBytesPerElement+" bytes per element does not match any Uint buffer type.")}},URL="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:void 0,x3dom.RefinementJobWorker=function(){},x3dom.RefinementJobWorker.prototype.subtract=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},x3dom.RefinementJobWorker.prototype.normalize=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return b=1/b,[a[0]*b,a[1]*b,a[2]*b]},x3dom.RefinementJobWorker.prototype.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},x3dom.RefinementJobWorker.prototype.log=function(a){postMessage({msg:"log",txt:a})},x3dom.RefinementJobWorker.prototype.processJob=function(a,b,c,d,e,f,g,h,i){var j,k;2===d.length&&3===d[0]&&2===d[1]&&6===e[0]&&2===e[1]?(j=8*i.BYTES_PER_ELEMENT-2-2*b,k=8*i.BYTES_PER_ELEMENT-1-1*b,addBits_3x2_2x1(h,i,j,k)):2===d.length&&3===d[0]&&3===d[1]&&6===e[0]&&0===e[1]?(j=8*i.BYTES_PER_ELEMENT-2-2*b,addBits_3x2_3x2_computeNormals(h,i,j)):addBits(b,c,d,e,f,g,h,i),postMessage({msg:"jobFinished",attributeId:a,resultBuffer:i.buffer},[i.buffer])},x3dom.RefinementJobWorker.prototype.onmessage=function(a){var b,c;if(a.data.msg)switch(a.data.msg){case"processJob":for(c=0,b=0;b<a.data.bitsPerLevelList.length;++b)c+=a.data.bitsPerLevelList[b];c=Math.ceil(c/8),processJob(a.data.attributeId,a.data.level,a.data.stride,a.data.numComponentsList,a.data.bitsPerLevelList,a.data.readOffsetList,a.data.writeOffsetList,getBufferView(c,a.data.dataBuffer),getBufferView(a.data.resultBufferBytesPerElement,a.data.resultBuffer))}},x3dom.RefinementJobWorker.prototype.getBufferView=function(a,b){switch(a){case 1:return new Uint8Array(b);case 2:return new Uint16Array(b);case 4:return new Uint32Array(b);default:log("ERROR: The estimated element length of "+a+" bytes does not match any known Uint buffer type.")}},x3dom.RefinementJobWorker.prototype.addBits_3x2_2x1=function(a,b,c,d){var e,f,g,h,i,j,k,l=0,m=a.length;for(e=0;m>e;++e)f=a[e],g=(192&f)>>>6,g<<=c,h=(48&f)>>>4,h<<=c,i=(12&f)>>>2,i<<=c,b[l++]|=g,b[l++]|=h,b[l++]|=i,++l,j=(2&f)>>>1,j<<=d,k=1&f,k<<=d,b[l++]|=j,b[l++]|=k},x3dom.RefinementJobWorker.prototype.addBits_3x2_3x2_computeNormals=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o=0,p=a.length,q=0,r=[];for(d=0;p>d;++d)e=a[d],f=(192&e)>>>6,f<<=c,g=(48&e)>>>4,g<<=c,h=(12&e)>>>2,h<<=c,b[o++]|=f,b[o++]|=g,b[o++]|=h,r[q]=[b[o-3],b[o-2],b[o-1]],++o,3===++q&&(q=0,l=this.normalize(this.subtract(r[1],r[0])),m=this.normalize(this.subtract(r[2],r[0])),n=this.normalize(this.cross(l,m)),i=32767*n[0]+32767,j=32767*n[1]+32767,k=32767*n[2]+32767,b[o]=i,b[o+1]=j,b[o+2]=k,b[o-8]=i,b[o+1-8]=j,b[o+2-8]=k,b[o-16]=i,b[o+1-16]=j,b[o+2-16]=k),o+=4},x3dom.RefinementJobWorker.prototype.addBits=function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n,o,p,q,r,s=[],t=[],u=[],v=c.length,w=b/(8*h.BYTES_PER_ELEMENT);for(i=0;v>i;++i){for(l=c[i],r=d[i]/c[i],m=8*g.BYTES_PER_ELEMENT-e[i]-r*l,u[i]=8*h.BYTES_PER_ELEMENT-r-a*r,o=[],p=[],k=0;l>k;++k)p[k]=m+(l-k-1)*r,o[k]=0|Math.pow(2,r)-1,o[k]<<=p[k];s.push(o),t.push(p)}var x,y,z,A=g.length;for(j=0;v>j;++j)for(l=c[j],x=f[j]/(8*h.BYTES_PER_ELEMENT),o=s[j],p=t[j],q=u[j],i=0;A>i;++i){for(n=g[i],k=0;l>k;++k)z=n&o[k],z>>>=p[k],z<<=q,y=x+k,h[y]|=z;x+=w}},x3dom.RefinementJobWorker.prototype.toBlob=function(){var a="";a+='postMessage = (typeof webkitPostMessage !== "undefined") ? webkitPostMessage : postMessage;\n';for(var b in this)this[b]!=x3dom.RefinementJobWorker.prototype.toBlob&&(a+=b+" = ",a+=this[b]instanceof String?'"'+this[b]+'"':this[b]instanceof Array?"[];\n":this[b]+";\n");var c=new Blob([a]);return URL.createObjectURL(c)},x3dom.Properties=function(){this.properties={}},x3dom.Properties.prototype.setProperty=function(a,b){x3dom.debug.logInfo("Properties: Setting property '"+a+"' to value '"+b+"'"),this.properties[a]=b},x3dom.Properties.prototype.getProperty=function(a,b){return this.properties[a]?this.properties[a]:b},x3dom.Properties.prototype.merge=function(a){for(var b in a.properties)this.properties[b]=a.properties[b]},x3dom.Properties.prototype.toString=function(){var a="";for(var b in this.properties)a+="Name: "+b+" Value: "+this.properties[b]+"\n";return a},x3dom.DoublyLinkedList=function(){this.length=0,this.first=null,this.last=null},x3dom.DoublyLinkedList.ListNode=function(a,b,c,d,e){this.point=a,this.point_index=b,this.normals=c,this.colors=d,this.texCoords=e,this.next=null,this.prev=null},x3dom.DoublyLinkedList.prototype.appendNode=function(a){null===this.first?(a.prev=a,a.next=a,this.first=a,this.last=a):(a.prev=this.last,a.next=this.first,this.first.prev=a,this.last.next=a,this.last=a),this.length++},x3dom.DoublyLinkedList.prototype.insertAfterNode=function(a,b){b.prev=a,b.next=a.next,a.next.prev=b,a.next=b,b.prev==this.last&&(this.last=b),this.length++},x3dom.DoublyLinkedList.prototype.deleteNode=function(a){this.length>1?(a.prev.next=a.next,a.next.prev=a.prev,a==this.first&&(this.first=a.next),a==this.last&&(this.last=a.prev)):(this.first=null,this.last=null),a.prev=null,a.next=null,this.length--},x3dom.DoublyLinkedList.prototype.getNode=function(a){var b=null;if(a>this.length)return b;for(var c=0;c<this.length;c++)if(b=0==c?this.first:b.next,c==a)return b;return null},x3dom.DoublyLinkedList.prototype.invert=function(){for(var a=null,b=this.first,c=0;c<this.length;c++)a=b.prev,b.prev=b.next,b.next=a,b=b.prev;a=this.first,this.first=this.last,this.last=a},x3dom.EarClipping={reversePointDirection:function(a,b){var c,d,e,f,g,h=0,i=0;if(a.length<3)return!1;for(var j=0;j<a.length;j++)c=(j+1)%a.length,d=(j+2)%a.length,e=a.getNode(j),f=a.getNode(c),g=a.getNode(d),"YZ"==b?(i=(f.point.y-e.point.y)*(g.point.z-f.point.z),i-=(f.point.z-e.point.z)*(g.point.y-f.point.y)):"XZ"==b?(i=(f.point.z-e.point.z)*(g.point.x-f.point.x),i-=(f.point.x-e.point.x)*(g.point.z-f.point.z)):(i=(f.point.x-e.point.x)*(g.point.y-f.point.y),i-=(f.point.y-e.point.y)*(g.point.x-f.point.x)),0>i?h--:h++;return 0>h?(a.invert(),!0):!1},getIndexes:function(a){var b=a.first.next,c=this.identifyPlane(b.prev.point,b.point,b.next.point),d=this.reversePointDirection(a,c),e=[];b=a.first.next;for(var f=null,g=0,h=!0;a.length>=3&&15>g;){f=b.next;for(var i=0;i<a.length;i++)this.isNotEar(a.getNode(i).point,b.prev.point,b.point,b.next.point,c)&&(h=!1);h&&(this.isKonvex(b.prev.point,b.point,b.next.point,c)?(e.push(b.prev.point_index,b.point_index,b.next.point_index),a.deleteNode(b)):g++),b=f,h=!0}return d?e.reverse():e},getMultiIndexes:function(a){var b=a.first.next,c=this.identifyPlane(b.prev.point,b.point,b.next.point),d=this.reversePointDirection(a,c),e={};e.indices=[],e.point=[],e.normals=[],e.colors=[],e.texCoords=[],b=a.first.next;for(var f=null,g=0,h=!0;a.length>=3&&15>g;){f=b.next;for(var i=0;i<a.length;i++)this.isNotEar(a.getNode(i).point,b.prev.point,b.point,b.next.point,c)&&(h=!1);h&&(this.isKonvex(b.prev.point,b.point,b.next.point,c)?(e.indices.push(b.prev.point_index,b.point_index,b.next.point_index),e.point.push(b.prev.point,b.point,b.next.point),b.normals&&e.normals.push(b.prev.normals,b.normals,b.next.normals),b.colors&&e.colors.push(b.prev.colors,b.colors,b.next.colors),b.texCoords&&e.texCoords.push(b.prev.texCoords,b.texCoords,b.next.texCoords),a.deleteNode(b)):g++),b=f,h=!0}return d&&(e.indices=e.indices.reverse(),e.point=e.point.reverse(),e.normals=e.normals.reverse(),e.colors=e.colors.reverse(),e.texCoords=e.texCoords.reverse()),e},isNotEar:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q;return"YZ"==e?(j=a.y,k=a.z,l=b.y,m=b.z,n=c.y,o=c.z,p=d.y,q=d.z):"XZ"==e?(j=a.z,k=a.x,l=b.z,m=b.x,n=c.z,o=c.x,p=d.z,q=d.x):(j=a.x,k=a.y,l=b.x,m=b.y,n=c.x,o=c.y,p=d.x,q=d.y),f=(n-l)*(q-m)-(p-l)*(o-m),0!=f?(g=((n-j)*(q-k)-(p-j)*(o-k))/f,h=((p-j)*(m-k)-(l-j)*(q-k))/f,i=1-g-h,g>0&&h>0&&i>0):!1},isKonvex:function(a,b,c,d){var e,f,g,h,i,j;"YZ"==d?(e=a.y,f=a.z,g=b.y,h=b.z,i=c.y,j=c.z):"XZ"==d?(e=a.z,f=a.x,g=b.z,h=b.x,i=c.z,j=c.x):(e=a.x,f=a.y,g=b.x,h=b.y,i=c.x,j=c.y);var k=(g-e)*(j-f)-(h-f)*(i-e);return k>=0},identifyPlane:function(a,b,c){var d,e,f,g,h,i,j,k,l;d=b.x-a.x,e=b.y-a.y,f=b.z-a.z,g=c.x-a.x,h=c.y-a.y,i=c.z-a.z,j=Math.abs(e*i-f*h),k=Math.abs(f*g-d*i),l=Math.abs(d*h-e*g);var m=Math.max(j,k,l);return m==j?"YZ":m==k?"XZ":m==l?"XY":"XZ"}},x3dom.Utils={},x3dom.Utils.maxIndexableCoords=65535,x3dom.Utils.measurements=[],window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}(),x3dom.Utils.startMeasure=function(a){var b=a.toUpperCase();x3dom.Utils.measurements[b]||(x3dom.Utils.measurements[b]=performance&&performance.now?performance.now():(new Date).getTime())},x3dom.Utils.stopMeasure=function(a){var b=a.toUpperCase();if(x3dom.Utils.measurements[b]){var c=x3dom.Utils.measurements[b];return delete x3dom.Utils.measurements[b],performance&&performance.now?performance.now()-c:(new Date).getTime()-c}return 0},x3dom.Utils.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},x3dom.Utils.createTexture2D=function(a,b,c,d,e,f){var g=a.createTexture(),h=new Uint8Array([0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255]);if(a.bindTexture(a.TEXTURE_2D,g),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,2,2,0,a.RGBA,a.UNSIGNED_BYTE,h),a.bindTexture(a.TEXTURE_2D,null),g.ready=!1,null==c||""==c)return g;var i=new Image;return i.crossOrigin=e?"use-credentials":"",i.src=c,b.downloadCount++,i.onload=function(){f&&(i=x3dom.Utils.scaleImage(i)),1==d&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),a.bindTexture(a.TEXTURE_2D,g),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,i),a.bindTexture(a.TEXTURE_2D,null),1==d&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),g.width=i.width,g.height=i.height,g.ready=!0,b.downloadCount--,b.needRender=!0},i.onerror=function(){x3dom.debug.logError("[Utils|createTexture2D] Can't load Image: "+c),b.downloadCount--},g},x3dom.Utils.createTextureCube=function(a,b,c,d,e,f){var g,h=a.createTexture();g=d?[a.TEXTURE_CUBE_MAP_POSITIVE_Z,a.TEXTURE_CUBE_MAP_NEGATIVE_Z,a.TEXTURE_CUBE_MAP_POSITIVE_Y,a.TEXTURE_CUBE_MAP_NEGATIVE_Y,a.TEXTURE_CUBE_MAP_POSITIVE_X,a.TEXTURE_CUBE_MAP_NEGATIVE_X]:[a.TEXTURE_CUBE_MAP_NEGATIVE_Z,a.TEXTURE_CUBE_MAP_POSITIVE_Z,a.TEXTURE_CUBE_MAP_NEGATIVE_Y,a.TEXTURE_CUBE_MAP_POSITIVE_Y,a.TEXTURE_CUBE_MAP_NEGATIVE_X,a.TEXTURE_CUBE_MAP_POSITIVE_X],h.ready=!1,h.pendingTextureLoads=-1,h.textureCubeReady=!1;for(var i=0,j=0,k=0;k<g.length;k++){var l=g[k],m=new Image;m.crossOrigin=e?"use-credentials":"",h.pendingTextureLoads++,b.downloadCount++,m.onload=function(c,d,e,g){return function(){0==i&&0==j?(i=e.width,j=e.height):!f||i==e.width&&j==e.height||(x3dom.debug.logWarning("[Utils|createTextureCube] Rescaling CubeMap images, which are of different size!"),e=x3dom.Utils.rescaleImage(e,i,j)),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,g),a.bindTexture(a.TEXTURE_CUBE_MAP,c),a.texImage2D(d,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,e),a.bindTexture(a.TEXTURE_CUBE_MAP,null),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),c.pendingTextureLoads--,b.downloadCount--,c.pendingTextureLoads<0&&(c.width=i,c.height=j,c.textureCubeReady=!0,x3dom.debug.logInfo("[Utils|createTextureCube] Loading CubeMap finished..."),b.needRender=!0)}}(h,l,m,d),m.onerror=function(){b.downloadCount--,x3dom.debug.logError("[Utils|createTextureCube] Can't load CubeMap!")},m.src=c[k]}return h},x3dom.Utils.getFileName=function(a){var b;return b=a.lastIndexOf("/")>-1?a.substr(a.lastIndexOf("/")+1):a.lastIndexOf("\\")>-1?a.substr(a.lastIndexOf("\\")+1):a},x3dom.Utils.findTextureByName=function(a,b){for(var c=0;c<a.length;++c)if(b==a[c].samplerName)return a[c];return!1},x3dom.Utils.rescaleImage=function(a,b,c){var d=document.createElement("canvas");return d.width=b,d.height=c,d.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,d.width,d.height),d},x3dom.Utils.scaleImage=function(a){if(!x3dom.Utils.isPowerOfTwo(a.width)||!x3dom.Utils.isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=x3dom.Utils.nextHighestPowerOfTwo(a.width),b.height=x3dom.Utils.nextHighestPowerOfTwo(a.height);var c=b.getContext("2d");c.drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b}return a},x3dom.Utils.isPowerOfTwo=function(a){return 0===(a&a-1)},x3dom.Utils.nextHighestPowerOfTwo=function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},x3dom.Utils.nextBestPowerOfTwo=function(a){var b=Math.log(a)/.693147180559945;return Math.pow(2,Math.round(b))},x3dom.Utils.getDataTypeSize=function(a){switch(a){case"Int8":case"Uint8":return 1;case"Int16":case"Uint16":return 2;case"Int32":case"Uint32":case"Float32":return 4;case"Float64":default:return 8}},x3dom.Utils.getOffsetMultiplier=function(a,b){switch(a){case b.UNSIGNED_SHORT:return 1;case b.UNSIGNED_INT:return 2;case b.UNSIGNED_BYTE:return.5;default:return 1}},x3dom.Utils.getByteAwareOffset=function(a,b,c){switch(b){case c.UNSIGNED_SHORT:return 2*a;case c.UNSIGNED_INT:return 4*a;case c.UNSIGNED_BYTE:return a;default:return 2*a}},x3dom.Utils.getVertexAttribType=function(a,b){var c=b.NONE;switch(a){case"Int8":c=b.BYTE;break;case"Uint8":c=b.UNSIGNED_BYTE;break;case"Int16":c=b.SHORT;break;case"Uint16":c=b.UNSIGNED_SHORT;break;case"Int32":c=b.INT;break;case"Uint32":c=b.UNSIGNED_INT;break;case"Float32":c=b.FLOAT;break;case"Float64":default:x3dom.debug.logError("Can't find this.gl data type for "+a+", getting FLOAT..."),c=b.FLOAT}return c},x3dom.Utils.getArrayBufferView=function(a,b){var c=null;switch(a){case"Int8":c=new Int8Array(b);break;case"Uint8":c=new Uint8Array(b);break;case"Int16":c=new Int16Array(b);break;case"Uint16":c=new Uint16Array(b);break;case"Int32":c=new Int32Array(b);break;case"Uint32":c=new Uint32Array(b);break;case"Float32":c=new Float32Array(b);break;case"Float64":c=new Float64Array(b);break;default:x3dom.debug.logError("Can't create typed array view of type "+a+", trying Float32..."),c=new Float32Array(b)}return c},x3dom.Utils.isUnsignedType=function(a){return"Uint8"==a||"Uint16"==a||"Uint16"==a||"Uint32"==a},x3dom.Utils.checkDirtyLighting=function(a){return a.getLights().length+a._scene.getNavigationInfo()._vf.headlight},x3dom.Utils.minFilterDic=function(a,b){switch(b.toUpperCase()){case"NEAREST":return a.NEAREST;case"LINEAR":return a.LINEAR;case"NEAREST_MIPMAP_NEAREST":return a.NEAREST_MIPMAP_NEAREST;case"NEAREST_MIPMAP_LINEAR":return a.NEAREST_MIPMAP_LINEAR;case"LINEAR_MIPMAP_NEAREST":return a.LINEAR_MIPMAP_NEAREST;case"LINEAR_MIPMAP_LINEAR":return a.LINEAR_MIPMAP_LINEAR;case"AVG_PIXEL":return a.LINEAR;case"AVG_PIXEL_AVG_MIPMAP":return a.LINEAR_MIPMAP_LINEAR;case"AVG_PIXEL_NEAREST_MIPMAP":return a.LINEAR_MIPMAP_NEAREST;case"DEFAULT":return a.LINEAR_MIPMAP_LINEAR;case"FASTEST":return a.NEAREST;case"NEAREST_PIXEL":return a.NEAREST;case"NEAREST_PIXEL_AVG_MIPMAP":return a.NEAREST_MIPMAP_LINEAR;case"NEAREST_PIXEL_NEAREST_MIPMAP":return a.NEAREST_MIPMAP_NEAREST;case"NICEST":return a.LINEAR_MIPMAP_LINEAR;default:return a.LINEAR}},x3dom.Utils.magFilterDic=function(a,b){switch(b.toUpperCase()){case"NEAREST":return a.NEAREST;case"LINEAR":return a.LINEAR;case"AVG_PIXEL":return a.LINEAR;case"DEFAULT":return a.LINEAR;case"FASTEST":return a.NEAREST;case"NEAREST_PIXEL":return a.NEAREST;case"NICEST":return a.LINEAR;default:return a.LINEAR}},x3dom.Utils.boundaryModesDic=function(a,b){switch(b.toUpperCase()){case"CLAMP":return a.CLAMP_TO_EDGE;case"CLAMP_TO_EDGE":return a.CLAMP_TO_EDGE;case"CLAMP_TO_BOUNDARY":return a.CLAMP_TO_EDGE;case"MIRRORED_REPEAT":return a.MIRRORED_REPEAT;case"REPEAT":return a.REPEAT;default:return a.REPEAT}},x3dom.Utils.primTypeDic=function(a,b){switch(b.toUpperCase()){case"POINTS":return a.POINTS;case"LINES":return a.LINES;case"LINELOOP":return a.LINE_LOOP;case"LINESTRIP":return a.LINE_STRIP;case"TRIANGLES":return a.TRIANGLES;case"TRIANGLESTRIP":return a.TRIANGLE_STRIP;case"TRIANGLEFAN":return a.TRIANGLE_FAN;default:return a.TRIANGLES}},x3dom.Utils.depthFunc=function(a,b){switch(b.toUpperCase()){case"NEVER":return a.NEVER;case"ALWAYS":return a.ALWAYS;
case"LESS":return a.LESS;case"EQUAL":return a.EQUAL;case"LEQUAL":return a.LEQUAL;case"GREATER":return a.GREATER;case"GEQUAL":return a.GEQUAL;case"NOTEQUAL":return a.NOTEQUAL;default:return a.LEQUAL}},x3dom.Utils.blendFunc=function(a,b){switch(b.toLowerCase()){case"zero":return a.ZERO;case"one":return a.ONE;case"dst_color":return a.DST_COLOR;case"dst_alpha":return a.DST_ALPHA;case"src_color":return a.SRC_COLOR;case"src_alpha":return a.SRC_ALPHA;case"one_minus_dst_color":return a.ONE_MINUS_DST_COLOR;case"one_minus_dst_alpha":return a.ONE_MINUS_DST_ALPHA;case"one_minus_src_color":return a.ONE_MINUS_SRC_COLOR;case"one_minus_src_alpha":return a.ONE_MINUS_SRC_ALPHA;case"src_alpha_saturate":return a.SRC_ALPHA_SATURATE;case"constant_color":return a.CONSTANT_COLOR;case"constant_alpha":return a.CONSTANT_ALPHA;case"one_minus_constant_color":return a.ONE_MINUS_CONSTANT_COLOR;case"one_minus_constant_alpha":return a.ONE_MINUS_CONSTANT_ALPHA;default:return 0}},x3dom.Utils.blendEquation=function(a,b){switch(b.toLowerCase()){case"func_add":return a.FUNC_ADD;case"func_subtract":return a.FUNC_SUBTRACT;case"func_reverse_subtract":return a.FUNC_REVERSE_SUBTRACT;case"min":return 0;case"max":return 0;case"logic_op":return 0;default:return 0}},x3dom.Utils.generateProperties=function(a,b){var c={},d=b._cf.geometry.node,e=b._cf.appearance.node,f=e?e._cf.texture.node:null,g=e?e._cf.material.node:null,h=a._scene.getEnvironment();return e&&e._shader&&x3dom.isa(e._shader,x3dom.nodeTypes.ComposedShader)?c.CSHADER=b._objectID:d&&(c.CSHADER=-1,c.SOLID=b.isSolid()?1:0,c.TEXT=x3dom.isa(d,x3dom.nodeTypes.Text)?1:0,c.POPGEOMETRY=x3dom.isa(d,x3dom.nodeTypes.PopGeometry)?1:0,c.BITLODGEOMETRY=x3dom.isa(d,x3dom.nodeTypes.BitLODGeometry)?1:0,c.IMAGEGEOMETRY=x3dom.isa(d,x3dom.nodeTypes.ImageGeometry)?1:0,c.IG_PRECISION=c.IMAGEGEOMETRY?d.numCoordinateTextures():0,c.IG_INDEXED=c.IMAGEGEOMETRY&&null!=d.getIndexTexture()?1:0,c.POINTLINE2D=x3dom.isa(d,x3dom.nodeTypes.PointSet)||x3dom.isa(d,x3dom.nodeTypes.IndexedLineSet)||x3dom.isa(d,x3dom.nodeTypes.Polypoint2D)||x3dom.isa(d,x3dom.nodeTypes.Polyline2D)||x3dom.isa(d,x3dom.nodeTypes.Arc2D)||x3dom.isa(d,x3dom.nodeTypes.Circle2D)?1:0,c.APPMAT=e&&(g||c.CSSHADER)?1:0,c.SHADOW=a.getLightsShadow()?1:0,c.FOG=a._scene.getFog()._vf.visibilityRange>0?1:0,c.CSSHADER=e&&e._shader&&x3dom.isa(e._shader,x3dom.nodeTypes.CommonSurfaceShader)?1:0,c.LIGHTS=!c.POINTLINE2D&&e&&(g||c.CSSHADER)?a.getLights().length+a._scene.getNavigationInfo()._vf.headlight:0,c.TEXTURED=f||c.TEXT?1:0,c.TEXTRAFO=e&&e._cf.textureTransform.node?1:0,c.DIFFUSEMAP=c.CSSHADER&&e._shader.getDiffuseMap()?1:0,c.NORMALMAP=c.CSSHADER&&e._shader.getNormalMap()?1:0,c.SPECMAP=c.CSSHADER&&e._shader.getSpecularMap()?1:0,c.DISPLACEMENTMAP=c.CSSHADER&&e._shader.getDisplacementMap()?1:0,c.DIFFPLACEMENTMAP=c.CSSHADER&&e._shader.getDiffuseDisplacementMap()?1:0,c.CUBEMAP=f&&x3dom.isa(f,x3dom.nodeTypes.X3DEnvironmentTextureNode)?1:0,c.BLENDING=c.TEXT||c.CUBEMAP||f&&f._blending?1:0,c.REQUIREBBOX=void 0!==d._vf.coordType&&"Float32"!=d._vf.coordType?1:0,c.REQUIREBBOXNOR=void 0!==d._vf.normalType&&"Float32"!=d._vf.normalType?1:0,c.REQUIREBBOXCOL=void 0!==d._vf.colorType&&"Float32"!=d._vf.colorType?1:0,c.REQUIREBBOXTEX=void 0!==d._vf.texCoordType&&"Float32"!=d._vf.texCoordType?1:0,c.COLCOMPONENTS=d._mesh._numColComponents,c.NORCOMPONENTS=d._mesh._numNormComponents,c.POSCOMPONENTS=d._mesh._numPosComponents,c.SPHEREMAPPING=void 0!==d._cf.texCoord&&null!==d._cf.texCoord.node&&d._cf.texCoord.node._vf.mode&&"sphere"==d._cf.texCoord.node._vf.mode.toLowerCase()?1:0,c.VERTEXCOLOR=d._mesh._colors[0].length>0||c.IMAGEGEOMETRY&&d.getColorTexture()||c.BITLODGEOMETRY&&d.hasColor()||c.POPGEOMETRY&&d.hasColor()||void 0!==d._vf.color&&d._vf.color.length>0?1:0,c.GAMMACORRECTION=h._vf.gammaCorrectionDefault),c.toIdentifier=function(){var a="";for(var b in this)this[b]!=this.toIdentifier&&this[b]!=this.toString&&(a+=this[b]);return this.id=a,a},c.toString=function(){var a="";for(var b in this)this[b]!=this.toIdentifier&&this[b]!=this.toString&&(a+=b+": "+this[b]+", ");return a},c.toIdentifier(),c},x3dom.Utils.wrapProgram=function(a,b,c){var d={shaderID:c,program:b};d.bind=function(){a.useProgram(b)};var e,f,g=null,h=null,i=a.getProgramParameter(b,a.ACTIVE_UNIFORMS);for(e=0;i>e;++e){try{h=a.getActiveUniform(b,e)}catch(j){if(!h)continue}switch(f=a.getError(),f&&x3dom.debug.logError("GL-Error (on searching uniforms): "+f),g=a.getUniformLocation(b,h.name),h.type){case a.SAMPLER_2D:d.__defineSetter__(h.name,function(b){return function(c){a.uniform1i(b,c)}}(g));break;case a.SAMPLER_CUBE:d.__defineSetter__(h.name,function(b){return function(c){a.uniform1i(b,c)}}(g));break;case a.BOOL:d.__defineSetter__(h.name,function(b){return function(c){a.uniform1i(b,c)}}(g));break;case a.FLOAT:-1!=h.name.indexOf("[0]")?d.__defineSetter__(h.name.substring(0,h.name.length-3),function(b){return function(c){a.uniform1fv(b,new Float32Array(c))}}(g)):d.__defineSetter__(h.name,function(b){return function(c){a.uniform1f(b,c)}}(g));break;case a.FLOAT_VEC2:d.__defineSetter__(h.name,function(b){return function(c){a.uniform2f(b,c[0],c[1])}}(g));break;case a.FLOAT_VEC3:d.__defineSetter__(h.name,function(b){return function(c){a.uniform3f(b,c[0],c[1],c[2])}}(g));break;case a.FLOAT_VEC4:d.__defineSetter__(h.name,function(b){return function(c){a.uniform4f(b,c[0],c[1],c[2],c[3])}}(g));break;case a.FLOAT_MAT2:d.__defineSetter__(h.name,function(b){return function(c){a.uniformMatrix2fv(b,!1,new Float32Array(c))}}(g));break;case a.FLOAT_MAT3:d.__defineSetter__(h.name,function(b){return function(c){a.uniformMatrix3fv(b,!1,new Float32Array(c))}}(g));break;case a.FLOAT_MAT4:d.__defineSetter__(h.name,function(b){return function(c){a.uniformMatrix4fv(b,!1,new Float32Array(c))}}(g));break;case a.INT:d.__defineSetter__(h.name,function(b){return function(c){a.uniform1i(b,c)}}(g));break;default:x3dom.debug.logWarning("GLSL program variable "+h.name+" has unknown type "+h.type)}}var k=a.getProgramParameter(b,a.ACTIVE_ATTRIBUTES);for(e=0;k>e;++e){try{h=a.getActiveAttrib(b,e)}catch(l){if(!h)continue}f=a.getError(),f&&x3dom.debug.logError("GL-Error (on searching attributes): "+f),g=a.getAttribLocation(b,h.name),d[h.name]=g}return d},x3dom.States=function(a){var b=this;this.active=!1,this.viewer=document.createElement("div"),this.viewer.id="x3dom-state-viewer";var c=document.createElement("div");c.className="x3dom-states-head";var d=document.createElement("span");d.className="x3dom-states-head2",c.appendChild(d),this.measureList=document.createElement("ul"),this.measureList.className="x3dom-states-list",this.infoList=document.createElement("ul"),this.infoList.className="x3dom-states-list",this.viewer.appendChild(c),this.viewer.appendChild(this.measureList),this.viewer.appendChild(this.infoList),this.disableContextMenu=function(a){return a.preventDefault(),a.stopPropagation(),a.returnValue=!1,!1},this.thousandSeperator=function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},this.toFixed=function(a){var b=1>a?2:10>a?2:2;return a.toFixed(b)},this.update=function(){var b=a.runtime.states.infos,c=a.runtime.states.measurements;this.measureList.innerHTML="";for(var d in c)c.hasOwnProperty(d)&&(f=document.createElement("li"),f.className="x3dom-states-item",g=document.createElement("div"),g.className="x3dom-states-item-title",g.appendChild(document.createTextNode(d)),h=document.createElement("div"),h.className="x3dom-states-item-value",h.appendChild(document.createTextNode(this.toFixed(c[d]))),f.appendChild(g),f.appendChild(h),this.measureList.appendChild(f));this.infoList.innerHTML="";for(var e in b){var f=document.createElement("li");f.className="x3dom-states-item";var g=document.createElement("div");g.className="x3dom-states-item-title",g.appendChild(document.createTextNode(e));var h=document.createElement("div");h.className="x3dom-states-item-value",h.appendChild(document.createTextNode(this.thousandSeperator(b[e]))),f.appendChild(g),f.appendChild(h),this.infoList.appendChild(f)}},window.setInterval(function(){b.update()},1e3),this.viewer.addEventListener("contextmenu",b.disableContextMenu)},x3dom.States.prototype.display=function(a){this.active=void 0!==a?a:!this.active,this.viewer.style.display=this.active?"block":"none"},x3dom.StateManager=function(a){this.gl=a,this.states=[],this.initStates()},x3dom.StateManager.prototype.initStates=function(){this.states.shaderID=null,this.states.colorMask={red:null,green:null,blue:null,alpha:null},this.states.depthMask=null,this.states.stencilMask=null,this.states.cullFace=null,this.states.frontFace=null,this.states.lineWidth=null,this.states.blendColor={red:null,green:null,blue:null,alpha:null},this.states.blendEquation=null,this.states.blendEquationSeparate={modeRGB:null,modeAlpha:null},this.states.blendFunc={sfactor:null,dfactor:null},this.states.blendFuncSeparate={srcRGB:null,dstRGB:null,srcAlpha:null,dstAlpha:null},this.states.depthFunc=null,this.states.viewport={x:null,y:null,width:null,height:null},this.states.depthRange={zNear:null,zFar:null}},x3dom.StateManager.prototype.useProgram=function(a){return this.states.shaderID!=a.shaderID?(this.gl.useProgram(a.program),this.states.shaderID=a.shaderID,!0):!1},x3dom.StateManager.prototype.unsetProgram=function(){this.states.shaderID=null},x3dom.StateManager.prototype.enable=function(a){this.states[a]!==!0&&(this.gl.enable(a),this.states[a]=!0)},x3dom.StateManager.prototype.disable=function(a){this.states[a]!==!1&&(this.gl.disable(a),this.states[a]=!1)},x3dom.StateManager.prototype.colorMask=function(a,b,c,d){(this.states.colorMask.red!=a||this.states.colorMask.green!=b||this.states.colorMask.blue!=c||this.states.colorMask.alpha!=d)&&(this.gl.colorMask(a,b,c,d),this.states.colorMask.red=a,this.states.colorMask.green=b,this.states.colorMask.blue=c,this.states.colorMask.alpha=d)},x3dom.StateManager.prototype.depthMask=function(a){this.states.depthMask!=a&&(this.gl.depthMask(a),this.states.depthMask=a)},x3dom.StateManager.prototype.stencilMask=function(a){this.states.stencilMask!=a&&(this.gl.stencilMask(a),this.states.stencilMask=a)},x3dom.StateManager.prototype.cullFace=function(a){this.states.cullFace!=a&&(this.gl.cullFace(a),this.states.cullFace=a)},x3dom.StateManager.prototype.frontFace=function(a){this.states.frontFace!=a&&(this.gl.frontFace(a),this.states.frontFace=a)},x3dom.StateManager.prototype.lineWidth=function(a){a=1>=a?1:a,this.states.lineWidth!=a&&(this.gl.lineWidth(a),this.states.lineWidth=a)},x3dom.StateManager.prototype.blendColor=function(a,b,c,d){(this.states.blendColor.red!=a||this.states.blendColor.green!=b||this.states.blendColor.blue!=c||this.states.blendColor.alpha!=d)&&(this.gl.blendColor(a,b,c,d),this.states.blendColor.red=a,this.states.blendColor.green=b,this.states.blendColor.blue=c,this.states.blendColor.alpha=d)},x3dom.StateManager.prototype.blendEquation=function(a){a&&this.states.blendEquation!=a&&(this.gl.blendEquation(a),this.states.blendEquation=a)},x3dom.StateManager.prototype.blendEquationSeparate=function(a,b){(this.states.blendEquationSeparate.modeRGB!=a||this.states.blendEquationSeparate.modeAlpha!=b)&&(this.gl.blendEquationSeparate(a,b),this.states.blendEquationSeparate.modeRGB=a,this.states.blendEquationSeparate.modeAlpha=b)},x3dom.StateManager.prototype.blendFunc=function(a,b){(this.states.blendFunc.sfactor!=a||this.states.blendFunc.dfactor!=b)&&(this.gl.blendFunc(a,b),this.states.blendFunc.sfactor=a,this.states.blendFunc.dfactor=b)},x3dom.StateManager.prototype.blendFuncSeparate=function(a,b,c,d){(this.states.blendFuncSeparate.srcRGB!=a||this.states.blendFuncSeparate.dstRGB!=b||this.states.blendFuncSeparate.srcAlpha!=c||this.states.blendFuncSeparate.dstAlpha!=d)&&(this.gl.blendFuncSeparate(a,b,c,d),this.states.blendFuncSeparate.srcRGB=a,this.states.blendFuncSeparate.dstRGB=b,this.states.blendFuncSeparate.srcAlpha=c,this.states.blendFuncSeparate.dstAlpha=d)},x3dom.StateManager.prototype.depthFunc=function(a){this.states.depthFunc!=a&&(this.gl.depthFunc(a),this.states.depthFunc=a)},x3dom.StateManager.prototype.depthRange=function(a,b){0>a||0>b||a>b||(a=a>1?1:a,b=b>1?1:b,(this.states.depthRange.zNear!=a||this.states.depthRange.zFar!=b)&&(this.gl.depthRange(a,b),this.states.depthRange.zNear=a,this.states.depthRange.zFar=b))},x3dom.StateManager.prototype.viewport=function(a,b,c,d){(this.states.viewport.x!=a||this.states.viewport.y!=b||this.states.viewport.width!=c||this.states.viewport.height!=d)&&(this.gl.viewport(a,b,c,d),this.states.viewport.x=a,this.states.viewport.y=b,this.states.viewport.width=c,this.states.viewport.height=d)},x3dom.StateManager.prototype.bindFramebuffer=function(a,b){this.gl.bindFramebuffer(a,b),this.initStates()},x3dom.BinaryContainerLoader={outOfMemory:!1,checkError:function(a){var b=a.getError();b&&(b==a.OUT_OF_MEMORY?(this.outOfMemory=!0,x3dom.debug.logError("GL-Error "+b+" on loading binary geometry (out of memory)."),console.error("WebGL: OUT_OF_MEMORY")):x3dom.debug.logError("GL-Error "+b+" on loading binary geometry."))}},x3dom.BinaryContainerLoader.setupBinGeo=function(a,b,c,d,e){if(!this.outOfMemory){var f=(new Date).getTime(),g=this,h=a._cf.geometry.node;a._webgl.binaryGeometry=-1,a._webgl.internalDownloadCount=(h._vf.index.length>0?1:0)+(h._hasStrideOffset&&h._vf.coord.length>0?1:0)+(!h._hasStrideOffset&&h._vf.coord.length>0?1:0)+(!h._hasStrideOffset&&h._vf.normal.length>0?1:0)+(!h._hasStrideOffset&&h._vf.texCoord.length>0?1:0)+(!h._hasStrideOffset&&h._vf.color.length>0?1:0);var i=0==h._vf.normalPerVertex||h._vf.index.length>0&&("Int32"==h._vf.indexType||"Uint32"==h._vf.indexType&&!x3dom.caps.INDEX_UINT);if(a._webgl.makeSeparateTris={index:null,coord:null,normal:null,texCoord:null,color:null,pushBuffer:function(b,c){this[b]=c,0==--a._webgl.internalDownloadCount&&(this.coord&&this.createMesh(),a._nameSpace.doc.needRender=!0),0==--a._nameSpace.doc.downloadCount&&(a._nameSpace.doc.needRender=!0)},createMesh:function(){var f=h;if(f._hasStrideOffset)return x3dom.debug.logError(f._vf.indexType+" index type and per-face normals not supported for interleaved arrays."),void 0;for(var i=0;i<a._webgl.primType.length;i++)if(a._webgl.primType[i]==c.TRIANGLE_STRIP)return x3dom.debug.logError("makeSeparateTris: triangle strips not yet supported for per-face normals."),void 0;var j=f._vf.coordType;a._webgl.coordType=x3dom.Utils.getVertexAttribType(j,c);var k,l,m;a._webgl.coordType!=c.FLOAT?(k=4==f._mesh._numPosComponents&&x3dom.Utils.isUnsignedType(f._vf.coordType)?x3dom.fields.SFVec3f.copy(f.getMin()):x3dom.fields.SFVec3f.copy(f._vf.position),l=x3dom.fields.SFVec3f.copy(f._vf.size),m=f.getPrecisionMax("coordType")):(k=new x3dom.fields.SFVec3f(0,0,0),l=new x3dom.fields.SFVec3f(1,1,1),m=1);var n=a._coordStrideOffset[0]/x3dom.Utils.getDataTypeSize(f._vf.coordType);n=0==n?3:n,x3dom.debug.logWarning("makeSeparateTris.createMesh called with coord length "+n),this.color&&n!=a._colorStrideOffset[0]/x3dom.Utils.getDataTypeSize(f._vf.colorType)&&(this.color=null,x3dom.debug.logWarning("Color format not supported."));var o=this.texCoord?a._texCoordStrideOffset[0]/x3dom.Utils.getDataTypeSize(f._vf.texCoordType):0;f._vf.normalType="Float32",a._webgl.normalType=c.FLOAT,f._mesh._numNormComponents=3,a._normalStrideOffset=[0,0];var p,q,r,s=[],t=[],u=[],v=[],w=this.index?this.index.length-2:this.coord.length/3-2;for(p=0;w>p;p+=3){q=n*(this.index?this.index[p]:p);var x=new x3dom.fields.SFVec3f(l.x*this.coord[q]/m,l.y*this.coord[q+1]/m,l.z*this.coord[q+2]/m);s.push(this.coord[q]),s.push(this.coord[q+1]),s.push(this.coord[q+2]),n>3&&s.push(this.coord[q+3]),this.color&&(v.push(this.color[q]),v.push(this.color[q+1]),v.push(this.color[q+2]),n>3&&v.push(this.color[q+3])),this.texCoord&&(r=o*(this.index?this.index[p]:p),u.push(this.texCoord[r]),u.push(this.texCoord[r+1]),o>3&&(u.push(this.texCoord[r+2]),u.push(this.texCoord[r+3]))),q=n*(this.index?this.index[p+1]:p+1);var y=new x3dom.fields.SFVec3f(l.x*this.coord[q]/m,l.y*this.coord[q+1]/m,l.z*this.coord[q+2]/m);s.push(this.coord[q]),s.push(this.coord[q+1]),s.push(this.coord[q+2]),n>3&&s.push(this.coord[q+3]),this.color&&(v.push(this.color[q]),v.push(this.color[q+1]),v.push(this.color[q+2]),n>3&&v.push(this.color[q+3])),this.texCoord&&(r=o*(this.index?this.index[p+1]:p+1),u.push(this.texCoord[r]),u.push(this.texCoord[r+1]),o>3&&(u.push(this.texCoord[r+2]),u.push(this.texCoord[r+3]))),q=n*(this.index?this.index[p+2]:p+2);var z=new x3dom.fields.SFVec3f(l.x*this.coord[q]/m,l.y*this.coord[q+1]/m,l.z*this.coord[q+2]/m);s.push(this.coord[q]),s.push(this.coord[q+1]),s.push(this.coord[q+2]),n>3&&s.push(this.coord[q+3]),this.color&&(v.push(this.color[q]),v.push(this.color[q+1]),v.push(this.color[q+2]),n>3&&v.push(this.color[q+3])),this.texCoord&&(r=o*(this.index?this.index[p+2]:p+2),u.push(this.texCoord[r]),u.push(this.texCoord[r+1]),o>3&&(u.push(this.texCoord[r+2]),u.push(this.texCoord[r+3])));var A=x.subtract(y),B=y.subtract(z),C=A.cross(B).normalize();for(q=0;3>q;q++)t.push(C.x),t.push(C.y),t.push(C.z)}var D=c.createBuffer();a._webgl.buffers[1]=D,c.bindBuffer(c.ARRAY_BUFFER,D),c.bufferData(c.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(f._vf.coordType,s),c.STATIC_DRAW),c.vertexAttribPointer(b.position,f._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]),c.enableVertexAttribArray(b.position),D=c.createBuffer(),a._webgl.buffers[2]=D,c.bindBuffer(c.ARRAY_BUFFER,D),c.bufferData(c.ARRAY_BUFFER,new Float32Array(t),c.STATIC_DRAW),c.vertexAttribPointer(b.normal,f._mesh._numNormComponents,a._webgl.normalType,!1,a._normalStrideOffset[0],a._normalStrideOffset[1]),c.enableVertexAttribArray(b.normal),this.texCoord&&(D=c.createBuffer(),a._webgl.buffers[3]=D,c.bindBuffer(c.ARRAY_BUFFER,D),c.bufferData(c.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(f._vf.texCoordType,u),c.STATIC_DRAW),c.vertexAttribPointer(b.texcoord,f._mesh._numTexComponents,a._webgl.texCoordType,!1,a._texCoordStrideOffset[0],a._texCoordStrideOffset[1]),c.enableVertexAttribArray(b.texcoord)),this.color&&(D=c.createBuffer(),a._webgl.buffers[4]=D,c.bindBuffer(c.ARRAY_BUFFER,D),c.bufferData(c.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(f._vf.colorType,v),c.STATIC_DRAW),c.vertexAttribPointer(b.color,f._mesh._numColComponents,a._webgl.colorType,!1,a._colorStrideOffset[0],a._colorStrideOffset[1]),c.enableVertexAttribArray(b.color)),f._vf.vertexCount=[],f._vf.vertexCount[0]=s.length/n,f._mesh._numCoords=f._vf.vertexCount[0],f._mesh._numFaces=f._vf.vertexCount[0]/3,a._webgl.primType=[],a._webgl.primType[0]=c.TRIANGLES,s=null,t=null,u=null,v=null,this.index=null,this.coord=null,this.normal=null,this.texCoord=null,this.color=null,g.checkError(c),delete a._webgl.shader,a._webgl.shader=e.cache.getDynamicShader(c,d,a)}},h._vf.index.length>0){var j=new XMLHttpRequest;j.open("GET",encodeURI(a._nameSpace.getURL(h._vf.index)),!0),j.responseType="arraybuffer",a._nameSpace.doc.downloadCount+=1,j.send(null),j.onload=function(){if(a._webgl){var b=j.response,d=h,e=d._vf.indexType,k=x3dom.Utils.getArrayBufferView(e,b);if(i)return a._webgl.makeSeparateTris.pushBuffer("index",k),void 0;var l=c.createBuffer();a._webgl.buffers[0]=l,a._webgl.indexType=x3dom.caps.INDEX_UINT&&"Uint32"==e?c.UNSIGNED_INT:c.UNSIGNED_SHORT,c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,l),c.bufferData(c.ELEMENT_ARRAY_BUFFER,k,c.STATIC_DRAW),a._webgl.binaryGeometry=1,0==d._vf.vertexCount[0]&&(d._vf.vertexCount[0]=k.length),d._mesh._numFaces=0;for(var m=0;m<d._vf.vertexCount.length;m++)d._mesh._numFaces+=a._webgl.primType[m]==c.TRIANGLE_STRIP?d._vf.vertexCount[m]-2:d._vf.vertexCount[m]/3;k=null,a._nameSpace.doc.downloadCount-=1,a._webgl.internalDownloadCount-=1,0==a._webgl.internalDownloadCount&&(a._nameSpace.doc.needRender=!0),g.checkError(c);var n=(new Date).getTime()-f;x3dom.debug.logInfo("XHR0/ index load time: "+n+" ms")}}}if(h._hasStrideOffset&&h._vf.coord.length>0){var k=new XMLHttpRequest;k.open("GET",encodeURI(a._nameSpace.getURL(h._vf.coord)),!0),k.responseType="arraybuffer",a._nameSpace.doc.downloadCount+=1,k.send(null),k.onload=function(){if(a._webgl){var d=k.response,e=h,i=e._vf.coordType;a._webgl.coordType=x3dom.Utils.getVertexAttribType(i,c),a._webgl.normalType=a._webgl.coordType,a._webgl.texCoordType=a._webgl.coordType,a._webgl.colorType=a._webgl.coordType;var j=x3dom.Utils.getArrayBufferView(i,d),l=a._coordStrideOffset[0]/x3dom.Utils.getDataTypeSize(i);if(l&&(e._mesh._numCoords=j.length/l),0==e._vf.index.length)for(var m=0;m<e._vf.vertexCount.length;m++)e._mesh._numFaces+=a._webgl.primType[m]==c.TRIANGLE_STRIP?e._vf.vertexCount[m]-2:e._vf.vertexCount[m]/3;var n=c.createBuffer();a._webgl.buffers[1]=n,c.bindBuffer(c.ARRAY_BUFFER,n),c.bufferData(c.ARRAY_BUFFER,j,c.STATIC_DRAW),c.vertexAttribPointer(b.position,e._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]),c.enableVertexAttribArray(b.position),e._vf.normal.length>0&&(a._webgl.buffers[2]=n,c.bindBuffer(c.ARRAY_BUFFER,n),c.bufferData(c.ARRAY_BUFFER,j,c.STATIC_DRAW),c.vertexAttribPointer(b.normal,e._mesh._numNormComponents,a._webgl.normalType,!1,a._normalStrideOffset[0],a._normalStrideOffset[1]),c.enableVertexAttribArray(b.normal)),e._vf.texCoord.length>0&&(a._webgl.buffers[3]=n,c.bindBuffer(c.ARRAY_BUFFER,n),c.bufferData(c.ARRAY_BUFFER,j,c.STATIC_DRAW),c.vertexAttribPointer(b.texcoord,e._mesh._numTexComponents,a._webgl.texCoordType,!1,a._texCoordStrideOffset[0],a._texCoordStrideOffset[1]),c.enableVertexAttribArray(b.texcoord)),e._vf.color.length>0&&(a._webgl.buffers[4]=n,c.bindBuffer(c.ARRAY_BUFFER,n),c.bufferData(c.ARRAY_BUFFER,j,c.STATIC_DRAW),c.vertexAttribPointer(b.color,e._mesh._numColComponents,a._webgl.colorType,!1,a._colorStrideOffset[0],a._colorStrideOffset[1]),c.enableVertexAttribArray(b.color)),j=null,a._nameSpace.doc.downloadCount-=1,a._webgl.internalDownloadCount-=1,0==a._webgl.internalDownloadCount&&(a._nameSpace.doc.needRender=!0),g.checkError(c);var o=(new Date).getTime()-f;x3dom.debug.logInfo("XHR/ interleaved array load time: "+o+" ms")}}}if(!h._hasStrideOffset&&h._vf.coord.length>0){var l=new XMLHttpRequest;l.open("GET",encodeURI(a._nameSpace.getURL(h._vf.coord)),!0),l.responseType="arraybuffer",a._nameSpace.doc.downloadCount+=1,l.send(null),l.onload=function(){if(a._webgl){var d=l.response,e=h,j=0,k=e._vf.coordType;a._webgl.coordType=x3dom.Utils.getVertexAttribType(k,c);var m=x3dom.Utils.getArrayBufferView(k,d);if(i)return a._webgl.makeSeparateTris.pushBuffer("coord",m),void 0;c.bindAttribLocation(b.program,0,"position");var n=c.createBuffer();if(a._webgl.buffers[1]=n,c.bindBuffer(c.ARRAY_BUFFER,n),c.bufferData(c.ARRAY_BUFFER,m,c.STATIC_DRAW),c.bindBuffer(c.ARRAY_BUFFER,n),c.vertexAttribPointer(b.position,e._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]),c.enableVertexAttribArray(b.position),e._mesh._numCoords=m.length/e._mesh._numPosComponents,0==e._vf.index.length)for(j=0;j<e._vf.vertexCount.length;j++)e._mesh._numFaces+=a._webgl.primType[j]==c.TRIANGLE_STRIP?e._vf.vertexCount[j]-2:e._vf.vertexCount[j]/3;if("Float32"==k&&(a._vf.bboxSize.x<0||a._vf.bboxSize.y<0||a._vf.bboxSize.z<0)){var o=new x3dom.fields.SFVec3f(m[0],m[1],m[2]),p=new x3dom.fields.SFVec3f(m[0],m[1],m[2]);for(j=3;j<m.length;j+=3)o.x>m[j+0]&&(o.x=m[j+0]),o.y>m[j+1]&&(o.y=m[j+1]),o.z>m[j+2]&&(o.z=m[j+2]),p.x<m[j+0]&&(p.x=m[j+0]),p.y<m[j+1]&&(p.y=m[j+1]),p.z<m[j+2]&&(p.z=m[j+2]);a._vf.bboxCenter.setValues(o.add(p).multiply(.5)),a._vf.bboxSize.setValues(p.subtract(o))}m=null,a._nameSpace.doc.downloadCount-=1,a._webgl.internalDownloadCount-=1,0==a._webgl.internalDownloadCount&&(a._nameSpace.doc.needRender=!0),g.checkError(c);var q=(new Date).getTime()-f;x3dom.debug.logInfo("XHR1/ coord load time: "+q+" ms")}}}if(!h._hasStrideOffset&&h._vf.normal.length>0){var m=new XMLHttpRequest;m.open("GET",encodeURI(a._nameSpace.getURL(h._vf.normal)),!0),m.responseType="arraybuffer",a._nameSpace.doc.downloadCount+=1,m.send(null),m.onload=function(){if(a._webgl){var d=m.response,e=h._vf.normalType;a._webgl.normalType=x3dom.Utils.getVertexAttribType(e,c);var j=x3dom.Utils.getArrayBufferView(e,d);if(i)return a._webgl.makeSeparateTris.pushBuffer("normal",j),void 0;var k=c.createBuffer();a._webgl.buffers[2]=k,c.bindBuffer(c.ARRAY_BUFFER,k),c.bufferData(c.ARRAY_BUFFER,j,c.STATIC_DRAW),c.vertexAttribPointer(b.normal,h._mesh._numNormComponents,a._webgl.normalType,!1,a._normalStrideOffset[0],a._normalStrideOffset[1]),c.enableVertexAttribArray(b.normal),j=null,a._nameSpace.doc.downloadCount-=1,a._webgl.internalDownloadCount-=1,0==a._webgl.internalDownloadCount&&(a._nameSpace.doc.needRender=!0),g.checkError(c);var l=(new Date).getTime()-f;x3dom.debug.logInfo("XHR2/ normal load time: "+l+" ms")}}}if(!h._hasStrideOffset&&h._vf.texCoord.length>0){var n=new XMLHttpRequest;n.open("GET",encodeURI(a._nameSpace.getURL(h._vf.texCoord)),!0),n.responseType="arraybuffer",a._nameSpace.doc.downloadCount+=1,n.send(null),n.onload=function(){if(a._webgl){var d=n.response,e=h._vf.texCoordType;a._webgl.texCoordType=x3dom.Utils.getVertexAttribType(e,c);var j=x3dom.Utils.getArrayBufferView(e,d);if(i)return a._webgl.makeSeparateTris.pushBuffer("texCoord",j),void 0;var k=c.createBuffer();a._webgl.buffers[3]=k,c.bindBuffer(c.ARRAY_BUFFER,k),c.bufferData(c.ARRAY_BUFFER,j,c.STATIC_DRAW),c.vertexAttribPointer(b.texcoord,h._mesh._numTexComponents,a._webgl.texCoordType,!1,a._texCoordStrideOffset[0],a._texCoordStrideOffset[1]),c.enableVertexAttribArray(b.texcoord),j=null,a._nameSpace.doc.downloadCount-=1,a._webgl.internalDownloadCount-=1,0==a._webgl.internalDownloadCount&&(a._nameSpace.doc.needRender=!0),g.checkError(c);var l=(new Date).getTime()-f;x3dom.debug.logInfo("XHR3/ texCoord load time: "+l+" ms")}}}if(!h._hasStrideOffset&&h._vf.color.length>0){var o=new XMLHttpRequest;o.open("GET",encodeURI(a._nameSpace.getURL(h._vf.color)),!0),o.responseType="arraybuffer",a._nameSpace.doc.downloadCount+=1,o.send(null),o.onload=function(){if(a._webgl){var d=o.response,e=h._vf.colorType;a._webgl.colorType=x3dom.Utils.getVertexAttribType(e,c);var j=x3dom.Utils.getArrayBufferView(e,d);if(i)return a._webgl.makeSeparateTris.pushBuffer("color",j),void 0;var k=c.createBuffer();a._webgl.buffers[4]=k,c.bindBuffer(c.ARRAY_BUFFER,k),c.bufferData(c.ARRAY_BUFFER,j,c.STATIC_DRAW),c.vertexAttribPointer(b.color,h._mesh._numColComponents,a._webgl.colorType,!1,a._colorStrideOffset[0],a._colorStrideOffset[1]),c.enableVertexAttribArray(b.color),j=null,a._nameSpace.doc.downloadCount-=1,a._webgl.internalDownloadCount-=1,0==a._webgl.internalDownloadCount&&(a._nameSpace.doc.needRender=!0),g.checkError(c);var l=(new Date).getTime()-f;x3dom.debug.logInfo("XHR4/ color load time: "+l+" ms")}}}}},x3dom.BinaryContainerLoader.setupPopGeo=function(a,b,c){if(!this.outOfMemory){var d=a._cf.geometry.node;if(d.hasIndex()){a._webgl.popGeometry=1,a._webgl.buffers[0]=c.createBuffer(),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,a._webgl.buffers[0]),c.bufferData(c.ELEMENT_ARRAY_BUFFER,2*d.getTotalNumberOfIndices(),c.STATIC_DRAW),a._webgl.buffers[5]=c.createBuffer();var e=new Float32Array(d._vf.vertexBufferSize);!function(){for(var a=0;a<e.length;++a)e[a]=a}(),c.bindBuffer(c.ARRAY_BUFFER,a._webgl.buffers[5]),c.bufferData(c.ARRAY_BUFFER,e,c.STATIC_DRAW)}else a._webgl.popGeometry=-1;a._webgl.buffers[1]=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,a._webgl.buffers[1]),c.bufferData(c.ARRAY_BUFFER,d._vf.attributeStride*d._vf.vertexBufferSize,c.STATIC_DRAW);var f=d._vf.coordType;a._webgl.coordType=x3dom.Utils.getVertexAttribType(f,c),a._coordStrideOffset[0]=d.getAttributeStride(),a._coordStrideOffset[1]=d.getPositionOffset(),c.vertexAttribPointer(b.position,a._cf.geometry.node._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]),c.enableVertexAttribArray(b.position),d.hasNormal()&&(f=d._vf.normalType,a._webgl.normalType=x3dom.Utils.getVertexAttribType(f,c),a._normalStrideOffset[0]=d.getAttributeStride(),a._normalStrideOffset[1]=d.getNormalOffset(),a._webgl.buffers[2]=a._webgl.buffers[1],c.vertexAttribPointer(b.normal,a._cf.geometry.node._mesh._numNormComponents,a._webgl.normalType,!1,a._normalStrideOffset[0],a._normalStrideOffset[1]),c.enableVertexAttribArray(b.normal)),d.hasTexCoord()&&(f=d._vf.texCoordType,a._webgl.texCoordType=x3dom.Utils.getVertexAttribType(f,c),a._webgl.buffers[3]=a._webgl.buffers[1],a._texCoordStrideOffset[0]=d.getAttributeStride(),a._texCoordStrideOffset[1]=d.getTexCoordOffset(),c.vertexAttribPointer(b.texcoord,a._cf.geometry.node._mesh._numTexComponents,a._webgl.texCoordType,!1,a._texCoordStrideOffset[0],a._texCoordStrideOffset[1]),c.enableVertexAttribArray(b.texcoord)),d.hasColor()&&(f=d._vf.colorType,a._webgl.colorType=x3dom.Utils.getVertexAttribType(f,c),a._webgl.buffers[4]=a._webgl.buffers[1],a._colorStrideOffset[0]=d.getAttributeStride(),a._colorStrideOffset[1]=d.getColorOffset(),c.vertexAttribPointer(b.color,a._cf.geometry.node._mesh._numColComponents,a._webgl.colorType,!1,a._colorStrideOffset[0],a._colorStrideOffset[1]),c.enableVertexAttribArray(b.color)),a._webgl.currentNumIndices=0,a._webgl.currentNumVertices=0,a._webgl.numVerticesAtLevel=[],a._webgl.levelsAvailable=0,this.checkError(c),a._webgl.levelLoaded=[],function(){for(var b=0;b<d.getNumLevels();++b)a._webgl.levelLoaded.push(!1)}();var g=function(b,e){if(a._webgl.levelLoaded[e]=!0,a._webgl.numVerticesAtLevel[e]=0,b){var f=0,g=!1;if(d.hasIndex()&&(f=2*d.getNumIndicesByLevel(e),f>0)){g=!0;var h=new Uint8Array(b,0,f);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,a._webgl.buffers[0]),function(){for(var a=0,b=0;e>b;++b)a+=d.getNumIndicesByLevel(b);c.bufferSubData(c.ELEMENT_ARRAY_BUFFER,2*a,h)}()}var i=b.byteLength-f;if(i>0){g=!0;var j=new Uint8Array(b,f,i);c.bindBuffer(c.ARRAY_BUFFER,a._webgl.buffers[1]),d.hasIndex()?c.bufferSubData(c.ARRAY_BUFFER,d.getVertexDataBufferOffset(e)*d.getAttributeStride(),j):c.bufferSubData(c.ARRAY_BUFFER,a._webgl.currentNumVertices*d.getAttributeStride(),j),a._webgl.numVerticesAtLevel[e]=i/d.getAttributeStride(),a._webgl.currentNumVertices+=a._webgl.numVerticesAtLevel[e]}!function(){for(var b=0,c=a._webgl.levelsAvailable;c<d.getNumLevels()&&a._webgl.levelLoaded[c]!==!1;++c)b+=d.getNumIndicesByLevel(c),++a._webgl.levelsAvailable;a._webgl.currentNumIndices=b}(),d._mesh._numCoords=a._webgl.currentNumVertices,d._mesh._numFaces=(d.hasIndex()?a._webgl.currentNumIndices:a._webgl.currentNumVertices)/3,d.adaptVertexCount(d.hasIndex()?3*d._mesh._numFaces:d._mesh._numCoords),g&&(a._nameSpace.doc.needRender=!0)}},h=d.getDataURLs(),i=[],j=[];a._webgl.downloadStartTimer=(new Date).getTime();for(var k=0;k<h.length;++k)a._nameSpace.doc.downloadCount+=1,function(b){i.push(function(c){return a._nameSpace.doc.downloadCount-=1,g(c,b)})}(k),j.push(k);x3dom.DownloadManager.get(h,i,j)}},x3dom.BinaryContainerLoader.setupBitLODGeo=function(a,b,c){function d(d,f){if("undefined"==typeof a._webgl.loadedLevels&&(a._webgl.loadedLevels=0,e.loadedLevels=0),a._webgl.loadedLevels++,e.loadedLevels++,e.hasIndex()&&e.usesClientSideNormals())"undefined"==typeof a._webgl.dataBuffers&&(a._webgl.dataBuffers=[]),0===d?a._webgl.dataBuffers[1]=f:1===d?a._webgl.dataBuffers[3]=f:2===d&&(a._webgl.dataBuffers[4]=f),a._webgl.generateTriangleBuffer();else{var g=c.createBuffer();if(0===d){var h=e._vf.coordType;a._webgl.coordType=x3dom.Utils.getVertexAttribType(h,c),a._webgl.normalType=a._webgl.coordType;var i=a._coordStrideOffset[0]/x3dom.Utils.getDataTypeSize(h);i&&e._vf.normalPerVertex&&(e._mesh._numCoords=f.length/i),a._webgl.buffers[1]=g,c.bindBuffer(c.ARRAY_BUFFER,g),c.bufferData(c.ARRAY_BUFFER,f,c.STATIC_DRAW),c.vertexAttribPointer(b.position,a._cf.geometry.node._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]),c.enableVertexAttribArray(b.position),a._webgl.buffers[2]=g,c.bindBuffer(c.ARRAY_BUFFER,g),c.bufferData(c.ARRAY_BUFFER,f,c.STATIC_DRAW),c.vertexAttribPointer(b.normal,a._cf.geometry.node._mesh._numNormComponents,a._webgl.normalType,!1,a._normalStrideOffset[0],a._normalStrideOffset[1]),c.enableVertexAttribArray(b.normal)}else 1===d?(a._webgl.texCoordType=a._webgl.coordType,a._webgl.buffers[3]=g,c.bindBuffer(c.ARRAY_BUFFER,g),c.bufferData(c.ARRAY_BUFFER,f,c.STATIC_DRAW),c.vertexAttribPointer(b.texcoord,a._cf.geometry.node._mesh._numTexComponents,a._webgl.texCoordType,!1,a._texCoordStrideOffset[0],a._texCoordStrideOffset[1]),c.enableVertexAttribArray(b.texcoord)):2===d&&(a._webgl.colorType=a._webgl.coordType,a._webgl.buffers[4]=g,c.bindBuffer(c.ARRAY_BUFFER,g),c.bufferData(c.ARRAY_BUFFER,f,c.STATIC_DRAW),c.vertexAttribPointer(b.color,a._cf.geometry.node._mesh._numColComponents,a._webgl.colorType,!1,a._colorStrideOffset[0],a._colorStrideOffset[1]),c.enableVertexAttribArray(b.color));
f=null}a._nameSpace.doc.needRender=!0,a._webgl.refinementJobManager.continueProcessing(d)}if(!this.outOfMemory){a._webgl.bitLODGeometry=-1;var e=a._cf.geometry.node;if(!e._vf.normalPerVertex)for(a._webgl.bitLODtotalVertexCount=0,k=0;k<e._vf.vertexCount.length;k++)a._webgl.primType[k]==c.TRIANGLES?a._webgl.bitLODtotalVertexCount+=e._vf.vertexCount[k]:a._webgl.primType[k]==c.TRIANGLE_STRIP&&(a._webgl.bitLODtotalVertexCount+=3*(e._vf.vertexCount[k]-2));var f=e.getNumComponents();if(f){if(e.hasIndex()){a._webgl.generateTriangleBuffer=function(){if("undefined"!=typeof a._webgl.dataBuffers[0]&&("undefined"!=typeof a._webgl.dataBuffers[1]||"undefined"!=typeof a._webgl.dataBuffers[3]||"undefined"!=typeof a._webgl.dataBuffers[4])){var d,f,g,h,i,j=a._webgl.dataBuffers[0],k=0,l=[new x3dom.fields.SFVec3f(0,0,0),new x3dom.fields.SFVec3f(0,0,0),new x3dom.fields.SFVec3f(0,0,0)],m=new x3dom.fields.SFVec3f(0,0,0),n=new x3dom.fields.SFVec3f(0,0,0),o=new x3dom.fields.SFVec3f(0,0,0),p="undefined"!=typeof a._webgl.dataBuffers[1]&&a._webgl.dataBuffers[1].length>0,q="undefined"!=typeof a._webgl.dataBuffers[3]&&a._webgl.dataBuffers[3].length>0,r="undefined"!=typeof a._webgl.dataBuffers[4]&&a._webgl.dataBuffers[4].length>0,s=2==a._cf.geometry.node._mesh._numNormComponents?6:8,t=s+(e.hasTexCoord()?2:0)+(e.hasColor()?4:0);for("undefined"==typeof a._webgl.triangleBuffer&&(a._webgl.triangleBuffer=new Uint16Array(j.length*t)),i=0;i<j.length;++i)h=i*t,p&&(d=6*j[i],a._webgl.triangleBuffer[h]=a._webgl.dataBuffers[1][d],a._webgl.triangleBuffer[h+1]=a._webgl.dataBuffers[1][d+1],a._webgl.triangleBuffer[h+2]=a._webgl.dataBuffers[1][d+2],a._webgl.triangleBuffer[h+3]=0,e._vf.normalPerVertex?(a._webgl.triangleBuffer[h+4]=a._webgl.dataBuffers[1][d+4],a._webgl.triangleBuffer[h+5]=a._webgl.dataBuffers[1][d+5]):8===a._webgl.loadedLevels&&(l[k].x=a._webgl.dataBuffers[1][d],l[k].y=a._webgl.dataBuffers[1][d+1],l[k].z=a._webgl.dataBuffers[1][d+2],3===++k&&(n=l[1].subtract(l[0]),o=l[2].subtract(l[0]),m=n.cross(o),m=m.normalize(),m=m.add(new x3dom.fields.SFVec3f(1,1,1)),m=m.multiply(.5),m=m.multiply(a._cf.geometry.node.getPrecisionMax("normalType")),a._webgl.triangleBuffer[h+4-2*t]=m.x.toFixed(0),a._webgl.triangleBuffer[h+5-2*t]=m.y.toFixed(0),a._webgl.triangleBuffer[h+6-2*t]=m.z.toFixed(0),a._webgl.triangleBuffer[h+4-t]=m.x.toFixed(0),a._webgl.triangleBuffer[h+5-t]=m.y.toFixed(0),a._webgl.triangleBuffer[h+6-t]=m.z.toFixed(0),a._webgl.triangleBuffer[h+4]=m.x.toFixed(0),a._webgl.triangleBuffer[h+5]=m.y.toFixed(0),a._webgl.triangleBuffer[h+6]=m.z.toFixed(0),k=0))),h+=s,q&&(f=2*j[i],a._webgl.triangleBuffer[h]=a._webgl.dataBuffers[3][f],a._webgl.triangleBuffer[h+1]=a._webgl.dataBuffers[3][f+1],h+=2),r&&(g=4*j[i],a._webgl.triangleBuffer[h]=a._webgl.dataBuffers[4][g],a._webgl.triangleBuffer[h+1]=a._webgl.dataBuffers[4][g+1],a._webgl.triangleBuffer[h+2]=a._webgl.dataBuffers[4][g+2],a._webgl.triangleBuffer[h+3]=0,h+=4);var u=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,u),c.bufferData(c.ARRAY_BUFFER,a._webgl.triangleBuffer,c.STATIC_DRAW);var v=e._vf.coordType;a._webgl.coordType=x3dom.Utils.getVertexAttribType(v,c),a._webgl.normalType=a._webgl.coordType,a._coordStrideOffset[0]=a._normalStrideOffset[0]=2*t,a._coordStrideOffset[1]=0,a._normalStrideOffset[1]=8,a._webgl.buffers[1]=u,a._webgl.buffers[2]=u,c.vertexAttribPointer(b.position,a._cf.geometry.node._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]),c.enableVertexAttribArray(b.position),c.vertexAttribPointer(b.normal,a._cf.geometry.node._mesh._numNormComponents,a._webgl.normalType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]),c.enableVertexAttribArray(b.normal),e.hasTexCoord()&&(a._webgl.texCoordType=a._webgl.coordType,a._webgl.buffers[3]=u,a._texCoordStrideOffset[0]=2*t,a._texCoordStrideOffset[1]=2*s,c.vertexAttribPointer(b.texcoord,a._cf.geometry.node._mesh._numTexComponents,a._webgl.texCoordType,!1,a._texCoordStrideOffset[0],a._texCoordStrideOffset[1]),c.enableVertexAttribArray(b.texcoord)),e.hasColor()&&(a._webgl.colorType=a._webgl.coordType,a._webgl.buffers[4]=u,a._colorStrideOffset[0]=2*t,a._colorStrideOffset[1]=e.hasTexCoord()?2*(s+2):2*s,c.vertexAttribPointer(b.color,a._cf.geometry.node._mesh._numColComponents,a._webgl.colorType,!1,a._colorStrideOffset[0],a._colorStrideOffset[1]),c.enableVertexAttribArray(b.color))}},a._webgl.bitLODGeometry=1;var g=new XMLHttpRequest;g.open("GET",encodeURI(a._nameSpace.getURL(e._vf.index)),!0),g.responseType="arraybuffer",a._nameSpace.doc.downloadCount+=1,g.send(null),g.onload=function(){var b,d=g.response;if(e.usesClientSideNormals()&&e.usesVLCIndices())!function(){"undefined"==typeof a._webgl.dataBuffers&&(a._webgl.dataBuffers=[]),a._webgl.dataBuffers[0]=[];for(var b,e,f,g=x3dom.Utils.getArrayBufferView("Uint8",d),h=0,i=0,j=0,k=0,l=-1,m=-1;h<g.length;){for(j>=a._cf.geometry.node._vf.vertexCount[k]&&(++k,j=0),b=g[h++],e=0,f=128;b>=128;)e|=b-128,e<<=7,f<<=7,b=g[h++];e|=b,f/=2,e-=f,i+=e,a._webgl.primType[k]==c.TRIANGLE_STRIP?(3>j?a._webgl.dataBuffers[0].push(i):0==j%2?(a._webgl.dataBuffers[0].push(m),a._webgl.dataBuffers[0].push(l),a._webgl.dataBuffers[0].push(i)):(a._webgl.dataBuffers[0].push(l),a._webgl.dataBuffers[0].push(m),a._webgl.dataBuffers[0].push(i)),m=l,l=i):a._webgl.dataBuffers[0].push(i),++j}}(),a._webgl.bitLODGeometry=-1,a._webgl.generateTriangleBuffer(),e._mesh._numFaces=a._webgl.dataBuffers[0].length/3,e._mesh._numCoords=a._webgl.dataBuffers[0].length;else{var f=c.createBuffer();if(a._webgl.buffers[0]=f,e.usesVLCIndices()){var h=[];!function(){for(var b,c,e,f=x3dom.Utils.getArrayBufferView("Uint8",d),g=0,i=0,j=0,k=0;g<f.length;){for(j>=a._cf.geometry.node._vf.vertexCount[k]&&(++k,j=0),b=f[g++],c=0,e=128;b>=128;)c|=b-128,c<<=7,e<<=7,b=f[g++];c|=b,e/=2,c-=e,i+=c,h.push(i),++j}}(),b=new Uint16Array(h)}else b=x3dom.Utils.getArrayBufferView("Uint16",d);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,f),c.bufferData(c.ELEMENT_ARRAY_BUFFER,b,c.STATIC_DRAW),0==e.getVertexCount(0)&&e.setVertexCount(0,b.length),e._mesh._numFaces=0;for(var i=0;i<e.getNumPrimTypes();i++)e._mesh._numFaces+=a._webgl.primType[i]==c.TRIANGLE_STRIP?e.getVertexCount(i)-2:e.getVertexCount(i)/3}b=null,a._nameSpace.doc.downloadCount-=1,a._nameSpace.doc.needRender=!0}}a._webgl.refinementJobManager=new x3dom.RefinementJobManager;var h=e.getNumVertices(),i=new ArrayBuffer(12*h),j=new Uint16Array(i);a._webgl.refinementJobManager.addResultBuffer(0,j);for(var k=0;k<e.getCoordNormalURLs().length;++k)a._webgl.refinementJobManager.addRefinementJob(0,k,e.getCoordNormalURLs()[k],k,d,96,[3,2],[6,2],[0,6],[0,64]);if(e.hasTexCoord()){var l=new ArrayBuffer(4*h),m=new Uint16Array(l);for(a._webgl.refinementJobManager.addResultBuffer(1,m),k=0;k<e.getTexCoordURLs().length;++k)a._webgl.refinementJobManager.addRefinementJob(1,k,e.getTexCoordURLs()[k],k,d,32,[2],[8],[0],[0])}if(e.hasColor()){var n=new ArrayBuffer(6*h),o=new Uint16Array(n);for(a._webgl.refinementJobManager.addResultBuffer(2,o),k=0;k<e.getColorURLs().length;++k)a._webgl.refinementJobManager.addRefinementJob(2,k,e.getColorURLs()[k],k,d,48,[3],[6],[0],[0])}}}},x3dom.BinaryContainerLoader.setupImgGeo=function(a,b,c,d,e){if(!this.outOfMemory){var f=a._cf.geometry.node;a._webgl.imageGeometry=f.getIndexTexture()?1:-1,f.unsetGeoDirty(),null==e.IG_PositionBuffer&&(e.IG_PositionBuffer=c.createBuffer()),a._webgl.buffers[1]=e.IG_PositionBuffer,c.bindBuffer(c.ARRAY_BUFFER,e.IG_PositionBuffer);var g=new Float32Array(a._webgl.positions[0]);c.bufferData(c.ARRAY_BUFFER,g,c.STATIC_DRAW),c.bindBuffer(c.ARRAY_BUFFER,e.IG_PositionBuffer),c.vertexAttribPointer(b.position,f._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]),c.enableVertexAttribArray(b.position),g=null,this.checkError(c)}},x3dom.DrawableCollection=function(a){this.collection=[],this.viewMatrix=a.viewMatrix,this.projMatrix=a.projMatrix,this.sceneMatrix=a.sceneMatrix,this.viewarea=a.viewArea;var b=this.viewarea._scene,c=b.getEnvironment(),d=b.getViewpoint();this.near=d.getNear(),this.pixelHeightAtDistOne=d.getImgPlaneHeightAtDistOne()/this.viewarea._height,this.context=a.context,this.gl=a.gl,this.viewFrustum=this.viewarea.getViewfrustum(this.sceneMatrix),this.worldVol=new x3dom.fields.BoxVolume,this.frustumCulling=a.frustumCulling&&null!=this.viewFrustum,this.smallFeatureThreshold=a.smallFeatureThreshold,this.sortOpaque=this.smallFeatureThreshold>0&&c._lowPriorityThreshold<1,this.sortTrans=a.sortTrans,this.prioLevels=10,this.maxTreshold=100,this.sortBySortKey=!1,this.sortByPriority=!1,this.numberOfNodes=0,this.length=0},x3dom.DrawableCollection.prototype.cull=function(a,b,c,d){var e=b.boundedNode;if(!e||!e._vf.render)return 0;var f=e.getVolume(),g=63;if(this.frustumCulling){var h;if(c&&!b.worldVolume.isValid()?(b.worldVolume.transformFrom(a,f),h=b.worldVolume):g>d&&(this.worldVol.transformFrom(a,f),h=this.worldVol),g>d&&(d=this.viewFrustum.intersect(h,d)),0>=d)return-1}else d=g;if(b.coverage=-1,this.smallFeatureThreshold>0||e.forceUpdateCoverage()){var i=this.viewMatrix.mult(a);b.center=i.multMatrixPnt(f.getCenter());var j=i.multMatrixVec(f.getRadialVec()),k=j.length(),l=Math.max(-b.center.z-k,this.near),m=l*this.pixelHeightAtDistOne;if(b.coverage=2*k/m,this.smallFeatureThreshold>0&&b.coverage<this.smallFeatureThreshold)return 0}return this.numberOfNodes++,d},x3dom.DrawableCollection.prototype.addShape=function(a,b,c){var d={};d.shape=a,d.transform=b,d.localTransform=c.localMatrix,d.localVolume=c.volume,d.worldVolume=x3dom.fields.BoxVolume.copy(c.worldVolume),d.priority=Math.max(0,c.coverage),d.shaderID=a.getShaderProperties(this.viewarea).id;var e=a._cf.appearance.node;if(d.sortType=e?e._vf.sortType.toLowerCase():"opaque",d.sortKey=e?e._vf.sortKey:0,"transparent"==d.sortType)if(this.smallFeatureThreshold>0)d.zPos=c.center.z;else{var f=b.multMatrixPnt(a.getCenter());f=this.viewMatrix.multMatrixPnt(f),d.zPos=f.z}this.sortBySortKey||0==d.sortKey||(this.sortBySortKey=!0),void 0===this.collection[d.sortType]&&(this.collection[d.sortType]=[]),this.collection[d.sortType].push(d),this.length++,this.context&&this.gl&&this.context.setupShape(this.gl,d,this.viewarea)},x3dom.DrawableCollection.prototype.addDrawable=function(a){a.shaderID=a.shape.getShaderProperties(this.viewarea).id;var b=a.shape._cf.appearance.node;if(a.sortType=b?b._vf.sortType.toLowerCase():"opaque",a.sortKey=b?b._vf.sortKey:0,"transparent"==a.sortType){var c=a.transform.multMatrixPnt(a.shape.getCenter());c=this.viewMatrix.multMatrixPnt(c),a.zPos=c.z}this.sortBySortKey||0==a.sortKey||(this.sortBySortKey=!0),void 0===this.collection[a.sortType]&&(this.collection[a.sortType]=[]),this.collection[a.sortType].push(a),this.length++,this.context&&this.gl&&this.context.setupShape(this.gl,a,this.viewarea)},x3dom.DrawableCollection.prototype.calculatePriority=function(a){var b=Math.max(0,a.coverage),c=this.prioLevels-1;return b=Math.min(Math.round(b/(this.maxTreshold/c)),c)},x3dom.DrawableCollection.prototype.concat=function(){var a=void 0!==this.collection.opaque?this.collection.opaque:[],b=void 0!==this.collection.transparent?this.collection.transparent:[];this.collection=a.concat(b)},x3dom.DrawableCollection.prototype.get=function(a){return this.collection[a]},x3dom.DrawableCollection.prototype.sort=function(){var a=[],b=[];void 0!==this.collection.opaque&&(this.sortOpaque&&this.collection.opaque.sort(function(a,b){return a.sortKey!=b.sortKey&&this.sortBySortKey?a.sortKey-b.sortKey:b.priority-a.priority}),a=this.collection.opaque),void 0!==this.collection.transparent&&(this.sortTrans&&this.collection.transparent.sort(function(a,b){return a.sortKey!=b.sortKey&&this.sortBySortKey?a.sortKey-b.sortKey:a.priority!=b.priority&&this.sortByPriority?b.priority-a.priority:a.zPos-b.zPos}),b=this.collection.transparent),this.collection=a.concat(b)},x3dom.DrawableCollection.prototype.forEach=function(a,b){b="undefined"!=typeof b?Math.min(b,this.prioLevels):this.prioLevels;var c,d,e,f;for(c=0;c<this.collection.opaque.length;++c)if(void 0!==this.collection.opaque[sortkey])for(d=this.collection.opaque[c].length;d>0;--d)if(void 0!==this.collection.opaque[c][d])for(e in this.collection.opaque[c][d])for(f=0;f<this.collection.opaque[c][d][e].lenght;++f)a(this.collection.opaque[c][d][e][f]);for(c=0;c<this.collection.transparent.length;++c)if(void 0!==this.collection.transparent[sortkey])for(d=this.collection.transparent[c].length;d>0;--d)if(void 0!==this.collection.transparent[c][d])for(var g in this.collection.transparent[c][d])for(this.collection.transparent[c][d][g].sort(function(a,b){return a.zPos-b.zPos}),f=0;f<this.collection.transparent[c][d][g].lenght;++f)a(this.collection.transparent[c][d][g][f])},x3dom.bvh={},x3dom.bvh.Settings=defineClass(null,function(a,b,c,d,e,f){this.debug=a,this.showDebugBoxVolumes=b,this.bvhType=c,this.maxObjectsPerNode=d,this.maxDepth=e,this.minRelativeBBoxSize="undefined"!==f?f:.01,this.MASK_SET=63}),x3dom.bvh.DataNode=defineClass(null,function(a){this.drawable=a,this.bbox=new x3dom.fields.BoxVolume,this.bbox.transformFrom(a.transform,a.shape.getVolume()),a.worldVolume=x3dom.fields.BoxVolume.copy(this.bbox)}),x3dom.bvh.Base=defineClass(null,function(a){this.dataNodes=[],this.drawableCollection=null,this.coveredBoxVolume=null,this.settings=a},{addDrawable:function(a){this.dataNodes.push(new x3dom.bvh.DataNode(a))},getHierarchyNodeBoxVolume:function(a){return this.dataNodes.length>a?this.dataNodes[a].bbox:null},build:function(){},collectDrawables:function(){},getLongestAxisForBox:function(a){var b=new x3dom.fields.SFVec3f,c=new x3dom.fields.SFVec3f;a.getBounds(b,c);var d=Math.abs(c.x-b.x),e=Math.abs(c.y-b.y),f=Math.abs(c.z-b.z),g="x";return e>d&&(d=e,g="y"),f>d?"z":g},calculateBBoxForDataNodes:function(){var a=x3dom.fields.BoxVolume.copy(this.dataNodes[0].bbox),b=new x3dom.fields.SFVec3f,c=new x3dom.fields.SFVec3f,d=new x3dom.fields.SFVec3f,e=new x3dom.fields.SFVec3f;a.getBounds(b,c);for(var f=1,g=this.dataNodes.length;g>f;++f)this.dataNodes[f].bbox.getBounds(d,e),d.x<b.x&&(b.x=d.x),e.x>c.x&&(c.x=e.x),d.y<b.y&&(b.y=d.y),e.y>c.y&&(c.y=e.y),d.z<b.z&&(b.z=d.z),e.z>c.z&&(c.z=e.z);return a.setBounds(b,c),a},splitBoxVolume:function(a,b,c,d){var e=new x3dom.fields.SFVec3f,f=new x3dom.fields.SFVec3f;a.getBounds(e,f);var g=x3dom.fields.SFVec3f.copy(e),h=x3dom.fields.SFVec3f.copy(f),i=x3dom.fields.SFVec3f.copy(e),j=x3dom.fields.SFVec3f.copy(f);return h[b]=c,i[b]=d,[new x3dom.fields.BoxVolume(g,h),new x3dom.fields.BoxVolume(i,j)]},calculateCoverage:function(a){var b=this.drawableCollection.viewMatrix,c=b.multMatrixPnt(a.getCenter()),d=b.multMatrixVec(a.getRadialVec()),e=d.length(),f=Math.max(-c.z-e,this.drawableCollection.near),g=f*this.drawableCollection.pixelHeightAtDistOne;return 2*e/g}}),x3dom.bvh.DebugDecorator=defineClass(null,function(a,b){this.bvh=a,this.scene=b,this.debugShape=null,this.renderedDrawablesCount=0},{addDrawable:function(a){this.bvh.addDrawable(a)},compile:function(){this.bvh.settings.showDebugBoxVolumes&&null!=this.scene&&this.createDebugShape(),"jsBIH"==this.bvh.settings.bvhType&&x3dom.Utils.startMeasure("buildBVH"),this.bvh.compile(),this.bvh.settings.debug&&"jsBIH"==this.bvh.settings.bvhType&&(console.log("Compile time: "+x3dom.Utils.stopMeasure("buildBVH")),console.log("BVH : %o",this.bvh)),this.bvh.settings.showDebugBoxVolumes&&("jsBIH"==this.bvh.settings.bvhType&&this.addHierarchyBoxVolumes(),this.createLineRenderersFromBoxVolumes())},showCompileStats:function(){this.bvh.showCompileStats()},collectDrawables:function(a){this.renderedDrawablesCount=a.length,this.bvh.collectDrawables(a),this.renderedDrawablesCount=a.length-this.renderedDrawablesCount},createDebugShape:function(){if(this.debugShape=new x3dom.nodeTypes.Shape,this.debugShape._nameSpace=this.scene._nameSpace,this.bvh.geo=null,this.bvh.coords=null,!this.debugShape._cf.appearance.node){var a=x3dom.nodeTypes.Appearance.defaultNode(),b=x3dom.nodeTypes.Material.defaultNode();b._vf.diffuseColor=new x3dom.fields.SFColor(1,0,0),b._vf.specularColor=new x3dom.fields.SFColor(1,0,0),b._vf.emissiveColor=new x3dom.fields.SFColor(1,0,0),a.addChild(b),this.debugShape.addChild(a)}this.debugShape._cf.geometry.node||(this.bvh.geo=new x3dom.nodeTypes.IndexedLineSet,this.bvh.coords=new x3dom.nodeTypes.Coordinate)},addHierarchyBoxVolumes:function(){for(var a,b=0;null!=(a=this.bvh.getHierarchyNodeBoxVolume(b));)this.addBoxVolumeToGeometry(a,this.bvh.geo),b++},createLineRenderersFromBoxVolumes:function(){for(var a=0,b=this.bvh.geo._mesh._positions[0].length;b>a;++a)this.bvh.coords._vf.point.push(this.bvh.geo._mesh._positions[0][a]);for(var a=0,b=this.bvh.geo._mesh._indices[0].length;b>a;++a)this.bvh.geo._vf.coordIndex.push(this.bvh.geo._mesh._indices[0][a]),this.bvh.geo._vf.colorIndex.push(0);this.bvh.geo.addChild(this.bvh.coords),this.debugShape.addChild(this.bvh.geo),this.bvh.geo.nodeChanged(),this.scene.addChild(this.debugShape),this.debugShape.nodeChanged(),this.scene.nodeChanged()},addBoxVolumeToGeometry:function(a,b){var c=new x3dom.fields.SFVec3f,d=new x3dom.fields.SFVec3f;a.getBounds(c,d);var e=b._mesh._positions[0].length;b._mesh._positions[0].push(new x3dom.fields.SFVec3f(c.x,c.y,c.z),new x3dom.fields.SFVec3f(c.x,c.y,d.z),new x3dom.fields.SFVec3f(c.x,d.y,c.z),new x3dom.fields.SFVec3f(c.x,d.y,d.z),new x3dom.fields.SFVec3f(d.x,c.y,c.z),new x3dom.fields.SFVec3f(d.x,c.y,d.z),new x3dom.fields.SFVec3f(d.x,d.y,c.z),new x3dom.fields.SFVec3f(d.x,d.y,d.z)),b._mesh._indices[0].push(e,e+1,-1,e,e+2,-1,e,e+4,-1,e+1,e+3,-1,e+1,e+5,-1,e+2,e+3,-1,e+2,e+6,-1,e+4,e+5,-1,e+4,e+6,-1,e+7,e+3,-1,e+7,e+5,-1,e+7,e+6,-1)},showTraverseStats:function(a){this.bvh.showTraverseStats(a)}}),x3dom.bvh.BihNode=defineClass(null,function(){this.rightChild=null,this.leftChild=null,this.split_axis=-1,this.clip=[0,0],this.bbox=null,this.dataIndex=[0,0]}),x3dom.bvh.BIH=defineClass(x3dom.bvh.Base,function(a,b){x3dom.bvh.BIH.superClass.call(this,b),this.bihNodes=[],this.index=[],this.env=a.getEnvironment()},{getNodeForIndex:function(a){for(;this.bihNodes.length<=a;)this.bihNodes.push(new x3dom.bvh.BihNode);return this.bihNodes[a]},bucketSort:function(a,b,c,d){for(var e,f,g=0,h=0;b>h;++h)e=this.dataNodes[this.index[a+h]].bbox.getCenter(),f=-1,e[d]<c&&(f=this.index[a+h],this.index[a+h]=this.index[a+g],this.index[a+g]=f,g+=1);return g},processNode:function(a,b,c,d,e){var f=this.getNodeForIndex(a);f.bbox=d,f.split_axis=this.getLongestAxisForBox(d);var g=d.getCenter()[f.split_axis],h=this.bucketSort(b,c,g,f.split_axis),i=c-h;f.clip[0]=d.min[f.split_axis],f.clip[1]=d.max[f.split_axis];var j=b+h,k=0,l=0;for(k=b;j>k;++k)l=this.dataNodes[this.index[k]].bbox.max[f.split_axis],l>f.clip[0]&&(f.clip[0]=l);for(k=j;b+c>k;++k)l=this.dataNodes[this.index[k]].bbox.min[f.split_axis],l<f.clip[1]&&(f.clip[1]=l);var m=d.getDiameter()/this.coveredBoxVolume.getDiameter()<=this.settings.minRelativeBBoxSize,n=this.splitBoxVolume(d,f.split_axis,f.clip[0],f.clip[1]);return h>this.settings.maxObjectsPerNode&&e<this.settings.maxDepth&&!m?f.leftChild=this.processNode(this.bihNodes.length,b,h,n[0],e+1):(f.leftChild=this.getNodeForIndex(this.bihNodes.length),f.leftChild.bbox=1==h?this.dataNodes[this.index[b]].bbox:n[0],f.leftChild.dataIndex[0]=b,f.leftChild.dataIndex[1]=h),i>this.settings.maxObjectsPerNode&&e<this.settings.maxDepth&&!m?f.rightChild=this.processNode(this.bihNodes.length,b+h,i,n[1],e+1):(f.rightChild=this.getNodeForIndex(this.bihNodes.length),f.rightChild.bbox=1==i?this.dataNodes[this.index[b+h]].bbox:n[1],f.rightChild.dataIndex[0]=b+h,f.rightChild.dataIndex[1]=i),f},getHierarchyNodeBoxVolume:function(a){return this.bihNodes.length>a?this.bihNodes[a].bbox:null},compile:function(){if(0!=this.dataNodes.length){this.coveredBoxVolume=this.calculateBBoxForDataNodes();for(var a=0,b=this.dataNodes.length;b>a;++a)this.index.push(a);this.processNode(0,0,this.dataNodes.length,this.coveredBoxVolume,0)}},showCompileStats:function(){},collectDrawables:function(a){if(this.drawableCollection=a,this.bihNodes.length>0){var b=0;this.intersect(this.bihNodes[0],b)}},calculateCoverage:function(a){var b=this.drawableCollection.viewMatrix,c=b.multMatrixPnt(a.getCenter()),d=b.multMatrixVec(a.getRadialVec()),e=d.length(),f=Math.max(-c.z-e,this.drawableCollection.near),g=f*this.drawableCollection.pixelHeightAtDistOne;return 2*e/g},intersect:function(a,b){if(b<this.settings.MASK_SET&&(b=this.drawableCollection.viewFrustum.intersect(a.bbox,b)),b>=0)if(-1==a.split_axis)for(var c=0,d=a.dataIndex[1];d>c;++c){var e=this.dataNodes[this.index[a.dataIndex[0]+c]],f=this.calculateCoverage(e.bbox);f>=this.env._vf.smallFeatureThreshold&&(e.drawable.priority=f,this.drawableCollection.addDrawable(e.drawable))}else{var f=this.calculateCoverage(a.bbox);f>=this.env._vf.smallFeatureThreshold&&(this.intersect(a.leftChild,b),this.intersect(a.rightChild,b))}},showTraverseStats:function(){}}),x3dom.bvh.Culler=defineClass(null,function(a,b,c){this.drawableCollection=a,this.scene=b,this.settings=c,this.frameId=0,this.compileSetup=new Module.CompileSetup,this.compileSetup.poolSize=this.drawableCollection.length,this.compileSetup.debug=this.settings.debug,this.compileSetup.showDebugBoxVolumes=this.settings.showDebugBoxVolumes,this.compileSetup.dataStructureType="OCTREE"==this.settings.bvhType?Module.DataStructureType.OCTREE:Module.DataStructureType.BIH,this.compileSetup.maxObjectsPerNode=this.settings.maxObjectsPerNode,this.compileSetup.maxDepth=this.settings.maxDepth;var d=this,e={addStructureBoxVolume:function(a,b){var c=b.min,e=b.max,f=new x3dom.fields.SFVec3f(c.x,c.y,c.z),g=new x3dom.fields.SFVec3f(e.x,e.y,e.z),h=d.geo._mesh._positions[0].length;d.geo._mesh._positions[0].push(new x3dom.fields.SFVec3f(f.x,f.y,f.z),new x3dom.fields.SFVec3f(f.x,f.y,g.z),new x3dom.fields.SFVec3f(f.x,g.y,f.z),new x3dom.fields.SFVec3f(f.x,g.y,g.z),new x3dom.fields.SFVec3f(g.x,f.y,f.z),new x3dom.fields.SFVec3f(g.x,f.y,g.z),new x3dom.fields.SFVec3f(g.x,g.y,f.z),new x3dom.fields.SFVec3f(g.x,g.y,g.z)),d.geo._mesh._indices[0].push(h,h+1,-1,h,h+2,-1,h,h+4,-1,h+1,h+3,-1,h+1,h+5,-1,h+2,h+3,-1,h+2,h+6,-1,h+4,h+5,-1,h+4,h+6,-1,h+7,h+3,-1,h+7,h+5,-1,h+7,h+6,-1)},timeNow:function(){return performance.now()}};this.compileSetup.setJsCallbacks(Module.JsCallbacks.implement(e)),this.culler=new Module.Culler(this.compileSetup),this.traverseSetup=new Module.TraverseSetup},{addDrawable:function(a){var b=this,c={drawable:a,addDrawableToCollection:function(a){this.drawable.priority=a,b.drawableCollection.addDrawable(this.drawable)},createBoxVolume:function(){var a=new x3dom.fields.BoxVolume;a.transformFrom(this.drawable.transform,this.drawable.shape.getVolume()),this.drawable.worldVolume=x3dom.fields.BoxVolume.copy(a);var b=new x3dom.fields.SFVec3f,c=new x3dom.fields.SFVec3f;a.getBounds(b,c);var d=new Module.BoxVolume(new Module.SFVec3f(b.x,b.y,b.z),new Module.SFVec3f(c.x,c.y,c.z));return d}},d=new Module.DrawableContainer.implement(c);this.culler.addDrawable(d)},compile:function(){this.culler.compile()},showCompileStats:function(){console.log(this.culler.stats())},collectDrawables:function(a){this.drawableCollection=a;var b=this.drawableCollection.viewFrustum,c=this.drawableCollection.viewMatrix,d=new Module.SFMatrix4f(c._00,c._01,c._02,c._03,c._10,c._11,c._12,c._13,c._20,c._21,c._22,c._23,c._30,c._31,c._32,c._33);this.traverseSetup.setModelViewMatrix(d);var e=new Module.FrustumVolume(b.planeNormals[0].x,b.planeNormals[0].y,b.planeNormals[0].z,b.planeDistances[0],b.planeNormals[1].x,b.planeNormals[1].y,b.planeNormals[1].z,b.planeDistances[1],b.planeNormals[2].x,b.planeNormals[2].y,b.planeNormals[2].z,b.planeDistances[2],b.planeNormals[3].x,b.planeNormals[3].y,b.planeNormals[3].z,b.planeDistances[3],b.planeNormals[4].x,b.planeNormals[4].y,b.planeNormals[4].z,b.planeDistances[4],b.planeNormals[5].x,b.planeNormals[5].y,b.planeNormals[5].z,b.planeDistances[5]);this.traverseSetup.setViewFrustum(e),this.traverseSetup.pixelHeightAtDistOne=this.drawableCollection.pixelHeightAtDistOne,this.traverseSetup.nearClippingPlane=this.drawableCollection.near;var f=this.scene.getEnvironment();this.traverseSetup.viewFrustumCulling=f._vf.frustumCulling,this.traverseSetup.smallFeatureCulling=f._vf.smallFeatureCulling,this.traverseSetup.occlusionCulling=f._vf.occlusionCulling,this.traverseSetup.smallFeatureThreshold=f._vf.smallFeatureThreshold,this.traverseSetup.useRenderQueue=!1,this.traverseSetup.frameId=this.frameId++,this.traverseSetup.traverserType=Module.TraverserType.DistanceQueue,this.culler.cull(this.traverseSetup),d.delete(),e.delete()},showTraverseStats:function(a){var b=this.culler.stats().culling;a.addInfo("#CNodes Visited",b.nodesVisited),a.addInfo("#Cull Frustum",b.nodesViewFrustumCulled),a.addInfo("#Cull SFeature",b.nodesSmallFeatureCulled),a.addInfo("#Cull OCC",b.nodesOcclusionCulled),a.addInfo("#Drawables SF",b.drawablesSmallFeatureCulled)}}),x3dom.X3DCanvas=function(a,b){var c=this;this.canvasIdx=b,this.initContext=function(b,c,d,e,f){x3dom.debug.logInfo("Initializing X3DCanvas for ["+b.id+"]");var g=x3dom.gfx_webgl(b,c,d,e,a);if(!g)return x3dom.debug.logError("No 3D context found..."),this.x3dElem.removeChild(b),null;var h=parseFloat(x3dom.caps.VERSION.match(/\d+\.\d+/)[0]);return 1>h&&!f?(x3dom.debug.logError("No valid 3D context found..."),this.x3dElem.removeChild(b),null):g},this.initFlashContext=function(a,b){return x3dom.debug.logInfo("Initializing X3DObject for ["+a.id+"]"),x3dom.gfx_flash(a,b)},this.appendParam=function(a,b,c){var d=document.createElement("param");d.setAttribute("name",b),d.setAttribute("value",c),a.appendChild(d)},this.fileExists=function(a){var b=new XMLHttpRequest;try{return b.open("HEAD",a,!1),b.send(null),404!=b.status}catch(c){return!0}},this.detectFlash=function(a,b){var c=a,d=b,e=0;if("object"==typeof navigator.plugins["Shockwave Flash"]){var f=navigator.plugins["Shockwave Flash"].description;e=f.substr(16,f.indexOf(".",16)-16)}else if("function"==typeof ActiveXObject)for(var g=10;d+1>g;g++)try{"object"==typeof new ActiveXObject("ShockwaveFlash.ShockwaveFlash."+g)&&(e=g+1)}catch(h){}return[e,c]},this.createInitFailedDiv=function(a){var b=document.createElement("div");b.setAttribute("id","x3dom-create-init-failed"),b.style.width=a.getAttribute("width"),b.style.height=a.getAttribute("height"),b.style.backgroundColor="#C00",b.style.color="#FFF",b.style.fontSize="20px",b.style.fontWidth="bold",b.style.padding="10px 10px 10px 10px",b.style.display="inline-block",b.style.fontFamily="Helvetica",b.style.textAlign="center",b.appendChild(document.createTextNode("Your Browser does not support X3DOM")),b.appendChild(document.createElement("br")),b.appendChild(document.createTextNode("Read more about Browser support on:")),b.appendChild(document.createElement("br"));var c=document.createElement("a");c.setAttribute("href","http://www.x3dom.org/?page_id=9"),c.appendChild(document.createTextNode("X3DOM | Browser Support")),b.appendChild(c);var d=a.getAttribute("altImg")||null;if(d){var e=new Image;e.src=d,b.style.backgroundImage="url("+d+")",b.style.backgroundRepeat="no-repeat",b.style.backgroundPosition="50% 50%"}a.appendChild(b),x3dom.debug.logError("Your Browser does not support X3DOM!")},this.createFlashObject=function(a){var b=this.detectFlash(11,11);if(!b[0]||b[0]<b[1])return null;x3dom.debug.logInfo("Creating FlashObject for (X)3D element...");var c=a.getAttribute("id");if(null!==c)c="x3dom-"+c+"-object";else{var d=(new Date).getTime();c="x3dom-"+d+"-object"}var e=a.getAttribute("swfpath");if(null===e&&(e="x3dom.swf"),!this.fileExists(e)){var f;f=void 0===x3dom.versionInfo||-1!=x3dom.versionInfo.version.indexOf("dev")?"dev":x3dom.versionInfo.version.substr(3),e="http://www.x3dom.org/download/"+f+"/x3dom.swf",x3dom.debug.logWarning("Can't find local x3dom.swf ("+f+"). X3DOM now using the online version from x3dom.org."+"The online version needs a <a href='http://examples.x3dom.org/crossdomain.xml'>crossdomain.xml</a> "+"file in the root directory of your domain to access textures")}var g=a.getAttribute("width"),h=-1;null==g?g=550:(h=g.indexOf("px"),-1!=h&&(g=g.substr(0,h)));var i=a.getAttribute("height");null==i?i=400:(h=i.indexOf("px"),-1!=h&&(i=i.substr(0,h)));var j=a.getAttribute("flashrenderer");this.flash_renderType=null==j?"forward":"deferred";var k=document.createElement("object");return k.setAttribute("width","100%"),k.setAttribute("height","100%"),k.setAttribute("id",c),!document.doctype||document.doctype&&-1!=document.doctype.publicId.search(/DTD XHTML/i)?(x3dom.debug.logWarning("Flash backend doesn't like XHTML, please use HTML5!"),k.setAttribute("style","width:"+g+"px; height:"+i+"px;")):null==a.getAttribute("style")&&a.setAttribute("style","width:"+g+"px; height:"+i+"px;"),this.appendParam(k,"menu","false"),this.appendParam(k,"quality","high"),this.appendParam(k,"wmode","direct"),this.appendParam(k,"allowScriptAccess","always"),this.appendParam(k,"flashvars","canvasIdx="+this.canvasIdx+"&renderType="+this.flash_renderType),this.appendParam(k,"movie",e),"Microsoft Internet Explorer"==navigator.appName?(a.appendChild(k),k.setAttribute("classid","clsid:d27cdb6e-ae6d-11cf-96b8-444553540000")):(k.setAttribute("type","application/x-shockwave-flash"),k.setAttribute("data",e),a.appendChild(k)),k},this.createHTMLCanvas=function(a){x3dom.debug.logInfo("Creating canvas for (X)3D element...");var b=document.createElement("canvas");b.setAttribute("class","x3dom-canvas");var d=a.getAttribute("style");d&&x3dom.debug.logInfo("Inline X3D styles detected");for(var e=["onmousedown","onmousemove","onmouseout","onmouseover","onmouseup","onclick","ondblclick","onkeydown","onkeypress","onkeyup","ontouchstart","ontouchmove","ontouchend","ontouchcancel","ontouchleave","ontouchenter","onMozTouchDown","onMozTouchMove","onMozTouchUp","ondragstart","ondrop","ondragover"],f=0;f<e.length;f++){var g=e[f],h=a.getAttribute(g);h&&(x3dom.debug.logInfo(g+", "+h),b.setAttribute(g,h),a.removeAttribute(g))}var i=a.getAttribute("draggable");i&&(x3dom.debug.logInfo("draggable="+i),b.setAttribute("draggable",i)),a.__addEventListener||a.__removeEventListener||(a.__addEventListener=a.addEventListener,a.__removeEventListener=a.removeEventListener,a.addEventListener=function(a,b,d){var f,g=!1;for(f=0;f<e.length&&!g;f++)e[f]===a&&(g=!0);g?(x3dom.debug.logInfo("addEventListener for div.on"+a),c.canvas.addEventListener(a,b,d)):(x3dom.debug.logInfo("addEventListener for X3D.on"+a),this.__addEventListener(a,b,d))},a.removeEventListener=function(a,b,d){var f,g=!1;for(f=0;f<e.length&&!g;f++)e[f]===a&&(g=!0);g?(x3dom.debug.logInfo("removeEventListener for div.on"+a),c.canvas.removeEventListener(a,b,d)):(x3dom.debug.logInfo("removeEventListener for X3D.on"+a),this.__removeEventListener(a,b,d))}),a.appendChild(b);var j=a.getAttribute("id");if(null!==j)b.id="x3dom-"+j+"-canvas";else{var k=(new Date).getTime();b.id="x3dom-"+k+"-canvas"}var l,m;return null!==(l=a.getAttribute("width"))&&(l.indexOf("%")>=0&&x3dom.debug.logWarning("The width attribute is to be specified in pixels not in percent."),b.style.width=l,b.setAttribute("width",l)),null!==(m=a.getAttribute("height"))&&(m.indexOf("%")>=0&&x3dom.debug.logWarning("The height attribute is to be specified in pixels not in percent."),b.style.height=m,b.setAttribute("height",m)),b.setAttribute("tabindex","0"),b};var d=[0,0];if(this.watchForResize=function(){var a=[parseInt(x3dom.getStyle(c.canvas,"width")),parseInt(x3dom.getStyle(c.canvas,"height"))];(d[0]!=a[0]||d[1]!=a[1])&&(d=a,c.x3dElem.setAttribute("width",a[0]+"px"),c.x3dElem.setAttribute("height",a[1]+"px"))},this.createProgressDiv=function(){var a=document.createElement("div");a.setAttribute("class","x3dom-progress");var b=document.createElement("strong");b.appendChild(document.createTextNode("Loading...")),a.appendChild(b);var c=document.createElement("span");return c.setAttribute("style","width: 25%;"),c.appendChild(document.createTextNode(" ")),a.appendChild(c),a.oncontextmenu=a.onmousedown=function(a){return a.preventDefault(),a.stopPropagation(),a.returnValue=!1,!1},a},this.isFlashReady=!1,this.x3dElem=a,x3dom.caps.MOBILE=navigator.appVersion.indexOf("Mobile")>-1,this.backend=this.x3dElem.getAttribute("backend"),this.backend=this.backend?this.backend.toLowerCase():"none","flash"==this.backend){if(this.backend="flash",this.canvas=this.createFlashObject(a),null==this.canvas)return this.createInitFailedDiv(a),void 0;
this.canvas.parent=this,this.gl=this.initFlashContext(this.canvas,this.flash_renderType)}else if(this.canvas=this.createHTMLCanvas(a),this.canvas.parent=this,this.gl=this.initContext(this.canvas,this.backend.search("desktop")>=0,this.backend.search("mobile")>=0,this.backend.search("webgl2")>=0,this.backend.search("ie11")>=0),this.backend="webgl",null==this.gl){if(x3dom.debug.logInfo("Fallback to Flash Renderer"),this.backend="flash",this.canvas=this.createFlashObject(a),null==this.canvas)return this.createInitFailedDiv(a),void 0;this.canvas.parent=this,this.gl=this.initFlashContext(this.canvas,this.flash_renderType)}x3dom.caps.BACKEND=this.backend,this.fps_t0=(new Date).getTime(),this.lastTimeFPSWasTaken=0,this.framesSinceLastTime=0,this.doc=null,a.__setAttribute=a.setAttribute,a.setAttribute=function(a,b){switch(this.__setAttribute(a,b),a){case"width":c.canvas.setAttribute("width",b),c.doc._viewarea&&(c.doc._viewarea._width=parseInt(c.canvas.getAttribute("width"),0));break;case"height":c.canvas.setAttribute("height",b),c.doc._viewarea&&(c.doc._viewarea._height=parseInt(c.canvas.getAttribute("height"),0))}c.doc.needRender=!0};var e=a.getAttribute("runtimeEnabled");if(this.hasRuntime=null!==e?"true"==e.toLowerCase():a.hasRuntime,null===this.gl&&(this.hasRuntime=!1),"flash"!=this.backend&&(this.showStat=a.getAttribute("showStat"),this.stateViewer=new x3dom.States(a),null!==this.showStat&&"true"==this.showStat&&this.stateViewer.display(!0),this.x3dElem.appendChild(this.stateViewer.viewer)),this.showProgress=a.getAttribute("showProgress"),this.progressDiv=this.createProgressDiv(),this.progressDiv.style.display=null!==this.showProgress&&"true"==this.showProgress?"inline":"none",this.x3dElem.appendChild(this.progressDiv),this.showTouchpoints=a.getAttribute("showTouchpoints"),this.showTouchpoints=this.showTouchpoints?!("false"==this.showTouchpoints.toLowerCase()):!0,this.disableTouch=a.getAttribute("disableTouch"),this.disableTouch=this.disableTouch?"true"==this.disableTouch.toLowerCase():!1,null!==this.canvas&&null!==this.gl&&this.hasRuntime&&"flash"!==this.backend){this.canvas.mouse_dragging=!1,this.canvas.mouse_button=0,this.canvas.mouse_drag_x=0,this.canvas.mouse_drag_y=0,this.canvas.isMulti=!1,this.canvas.oncontextmenu=function(a){return a.preventDefault(),a.stopPropagation(),a.returnValue=!1,!1},this.canvas.addEventListener("webglcontextlost",function(a){x3dom.debug.logError("WebGL context lost"),a.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",function(a){x3dom.debug.logError("recover WebGL state and resources on context lost NYI"),a.preventDefault()},!1),this.canvas.addEventListener("mousedown",function(a){if(!this.isMulti){switch(this.focus(),a.button){case 0:this.mouse_button=1;break;case 1:this.mouse_button=4;break;case 2:this.mouse_button=2;break;default:this.mouse_button=0}a.shiftKey&&(this.mouse_button=1),a.ctrlKey&&(this.mouse_button=4),a.altKey&&(this.mouse_button=2);var b=this.parent.mousePosition(a);this.mouse_drag_x=b.x,this.mouse_drag_y=b.y,this.mouse_dragging=!0,this.parent.doc.onMousePress(c.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,a.returnValue=!0}},!1),this.canvas.addEventListener("mouseup",function(a){if(!this.isMulti){var b=this.mouse_button;this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseRelease(c.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button,b),this.parent.doc.needRender=!0,a.returnValue=!0}},!1),this.canvas.addEventListener("mouseover",function(a){this.isMulti||(this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseOver(c.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,a.returnValue=!0)},!1),this.canvas.addEventListener("mouseout",function(a){this.isMulti||(this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseOut(c.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,a.returnValue=!0)},!1),this.canvas.addEventListener("dblclick",function(a){if(!this.isMulti){this.mouse_button=0;var b=this.parent.mousePosition(a);this.mouse_drag_x=b.x,this.mouse_drag_y=b.y,this.mouse_dragging=!1,this.parent.doc.onDoubleClick(c.gl,this.mouse_drag_x,this.mouse_drag_y),this.parent.doc.needRender=!0,a.returnValue=!0}},!1),this.canvas.addEventListener("mousemove",function(a){if(!this.isMulti){a.shiftKey&&(this.mouse_button=1),a.ctrlKey&&(this.mouse_button=4),a.altKey&&(this.mouse_button=2);var b=this.parent.mousePosition(a);this.mouse_drag_x=b.x,this.mouse_drag_y=b.y,this.mouse_dragging?this.parent.doc.onDrag(c.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button):this.parent.doc.onMove(c.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,a.preventDefault(),a.stopPropagation(),a.returnValue=!1}},!1),this.canvas.addEventListener("DOMMouseScroll",function(a){this.isMulti||(this.focus(),this.mouse_drag_y+=2*a.detail,this.parent.doc.onDrag(c.gl,this.mouse_drag_x,this.mouse_drag_y,2),this.parent.doc.needRender=!0,a.preventDefault(),a.stopPropagation(),a.returnValue=!1)},!1),this.canvas.addEventListener("mousewheel",function(a){this.isMulti||(this.focus(),this.mouse_drag_y-=.1*a.wheelDeltaY,this.parent.doc.onDrag(c.gl,this.mouse_drag_x,this.mouse_drag_y,2),this.parent.doc.needRender=!0,a.preventDefault(),a.stopPropagation(),a.returnValue=!1)},!1),this.canvas.addEventListener("keypress",function(a){var b=this.parent.x3dElem.getAttribute("keysEnabled");b&&"true"!=b.toLowerCase()||this.parent.doc.onKeyPress(a.charCode),this.parent.doc.needRender=!0,a.returnValue=!0},!0),this.canvas.addEventListener("keyup",function(a){var b=this.parent.x3dElem.getAttribute("keysEnabled");b&&"true"!=b.toLowerCase()||this.parent.doc.onKeyUp(a.keyCode),this.parent.doc.needRender=!0,a.returnValue=!0},!0),this.canvas.addEventListener("keydown",function(a){var b=this.parent.x3dElem.getAttribute("keysEnabled");b&&"true"!=b.toLowerCase()||this.parent.doc.onKeyDown(a.keyCode),this.parent.doc.needRender=!0,a.returnValue=!0},!0);var f={numTouches:0,firstTouchTime:(new Date).getTime(),firstTouchPoint:new x3dom.fields.SFVec2f(0,0),lastDrag:new x3dom.fields.SFVec2f,lastMiddle:new x3dom.fields.SFVec2f,lastDistance:new x3dom.fields.SFVec2f,lastSquareDistance:0,lastAngle:0,lastLayer:[],examineNavType:!0,calcAngle:function(a){var b=a.normalize().dot(new x3dom.fields.SFVec2f(1,0));return b=Math.acos(b),a.y<0&&(b=Math.PI+(Math.PI-b)),b},disableTouch:this.disableTouch,visMarker:this.showTouchpoints,visMarkerBag:[],visualizeTouches:function(a){if(this.visMarker){for(var b=[],c=null,d=0;d<a.touches.length;d++){var e=a.touches[d].identifier||a.touches[d].streamId;e||(e=0);var f=this.visMarkerBag.indexOf(e);f>=0?(c=document.getElementById("visMarker"+e),c.style.left=a.touches[d].pageX+"px",c.style.top=a.touches[d].pageY+"px"):(c=document.createElement("div"),c.appendChild(document.createTextNode("#"+e)),c.id="visMarker"+e,c.className="x3dom-touch-marker",document.body.appendChild(c),f=this.visMarkerBag.length,this.visMarkerBag[f]=e),b.push(e)}for(var g=this.visMarkerBag.length-1;g>=0;g--){var h=this.visMarkerBag[g];b.indexOf(h)<0&&(this.visMarkerBag.splice(g,1),c=document.getElementById("visMarker"+h),document.body.removeChild(c))}}}},g=[],h={touches:[],preventDefault:function(){}},i=function(a,b){this.isMulti=!0,a.preventDefault(),f.visualizeTouches(a),this.focus(),null==b&&(b=this.parent.doc);var d=b._scene.getNavigationInfo();f.examineNavType="examine"==d.getType(),f.lastLayer=[];var e,g;for(e=0;e<a.touches.length;e++)g=this.parent.mousePosition(a.touches[e]),f.lastLayer.push(new Array(a.touches[e].identifier,new x3dom.fields.SFVec2f(g.x,g.y)));if(f.numTouches<1&&1==a.touches.length)f.numTouches=1,f.lastDrag=new x3dom.fields.SFVec2f(a.touches[0].screenX,a.touches[0].screenY);else if(f.numTouches<2&&a.touches.length>=2){f.numTouches=2;var h=new x3dom.fields.SFVec2f(a.touches[0].screenX,a.touches[0].screenY),i=new x3dom.fields.SFVec2f(a.touches[1].screenX,a.touches[1].screenY),j=i.subtract(h),k=j.multiply(.5).add(h),l=j.dot(j);f.lastDistance=j,f.lastMiddle=k,f.lastSquareDistance=l,f.lastAngle=f.calcAngle(j)}if(b._scene.updateVolume(),f.examineNavType)for(e=0;e<a.touches.length;e++)g=this.parent.mousePosition(a.touches[e]),b.onPick(c.gl,g.x,g.y),b._viewarea.prepareEvents(g.x,g.y,1,"onmousedown"),b._viewarea._pickingInfo.lastClickObj=b._viewarea._pickingInfo.pickObj;else a.touches.length&&(g=this.parent.mousePosition(a.touches[0]),b.onMousePress(c.gl,g.x,g.y,1));b.needRender=!0},j=function(a){this.isMulti=!0,a.preventDefault();for(var b=!0,c=0;c<g.length;++c)g[c]==a.streamId&&(b=!1);1==b&&(a.identifier=a.streamId,g.push(a.streamId),h.touches.push(a)),i(h,this.parent.doc)},k=function(a,b){a.preventDefault(),f.visualizeTouches(a),null==b&&(b=this.parent.doc);var d=null,e=null;if(f.examineNavType){if(1==a.touches.length){var g=new x3dom.fields.SFVec2f(a.touches[0].screenX,a.touches[0].screenY),h=g.subtract(f.lastDrag);f.lastDrag=g;var i=x3dom.fields.SFMatrix4f.rotationY(h.x/100),j=x3dom.fields.SFMatrix4f.rotationX(h.y/100);e=i.mult(j),b.onMoveView(c.gl,null,e)}else if(a.touches.length>=2){var k=new x3dom.fields.SFVec2f(a.touches[0].screenX,a.touches[0].screenY),l=new x3dom.fields.SFVec2f(a.touches[1].screenX,a.touches[1].screenY),m=l.subtract(k),n=m.multiply(.5).add(k),o=m.dot(m),p=n.subtract(f.lastMiddle),q=o-f.lastSquareDistance,r=new x3dom.fields.SFVec3f(p.x/screen.width,-p.y/screen.height,q/(.2*screen.width*screen.height)),s=f.calcAngle(m),t=f.lastAngle-s;f.lastAngle=s,e=x3dom.fields.SFMatrix4f.rotationZ(t),f.lastMiddle=n,f.lastDistance=m,f.lastSquareDistance=o,b.onMoveView(c.gl,r,e)}}else a.touches.length&&(d=this.parent.mousePosition(a.touches[0]),b.onDrag(c.gl,d.x,d.y,1));b.needRender=!0},l=function(a){a.preventDefault();for(var b=0;b<g.length;++b)g[b]==a.streamId&&(h.touches[b]=a);k(h,this.parent.doc)},m=function(a,b){this.isMulti=!1,a.preventDefault(),f.visualizeTouches(a),null==b&&(b=this.parent.doc),b._viewarea._isMoving=!1,2==f.numTouches&&1==a.touches.length&&(f.lastDrag=new x3dom.fields.SFVec2f(a.touches[0].screenX,a.touches[0].screenY));var d=!1;if(a.touches.length<2&&(1==f.numTouches&&(d=!0),f.numTouches=a.touches.length),f.examineNavType){for(var e=0;e<f.lastLayer.length;e++){var g=f.lastLayer[e][1];if(b.onPick(c.gl,g.x,g.y),"box"!==b._scene._vf.pickMode.toLowerCase())b._viewarea.prepareEvents(g.x,g.y,1,"onmouseup"),b._viewarea._pickingInfo.lastClickObj=b._viewarea._pickingInfo.pickObj,b._viewarea._pickingInfo.pickObj&&b._viewarea._pickingInfo.pickObj===b._viewarea._pickingInfo.lastClickObj&&b._viewarea.prepareEvents(g.x,g.y,1,"onclick");else{var h=b._viewarea.calcViewRay(g.x,g.y),i=b._scene.doIntersect(h),j=h.hitObject;i&&j&&(b._viewarea._pick.setValues(h.hitPoint),b._viewarea.checkEvents(j,g.x,g.y,1,"onclick"),x3dom.debug.logInfo("Hit '"+j._xmlNode.localName+"/ "+j._DEF+"' at pos "+b._viewarea._pick))}}if(d){var k=(new Date).getTime(),l=f.firstTouchPoint.subtract(f.lastDrag).length();18>l&&k-f.firstTouchTime<180&&b.onDoubleClick(c.gl,0,0),f.firstTouchTime=k,f.firstTouchPoint=f.lastDrag}}else f.lastLayer.length&&(g=f.lastLayer[0][1],b.onMouseRelease(c.gl,g.x,g.y,0,1));b.needRender=!0},n=function(a){this.isMulti=!1,a.preventDefault();for(var b=-1,c=0;c<g.length;++c)g[c]==a.streamId&&(b=c);-1!=b&&(g.splice(b,1),h.touches.splice(b,1)),m(h,this.parent.doc)};this.disableTouch||(this.canvas.addEventListener("MozTouchDown",j,!0),this.canvas.addEventListener("MozTouchMove",l,!0),this.canvas.addEventListener("MozTouchUp",n,!0),this.canvas.addEventListener("touchstart",i,!0),this.canvas.addEventListener("touchmove",k,!0),this.canvas.addEventListener("touchend",m,!0))}this.mousePosition=function(a){var b=window.webkitConvertPointFromNodeToPage,c=0,d=0;if("getBoundingClientRect"in document.documentElement){var e=a.target.offsetParent,f=e.getBoundingClientRect(),g=window.pageXOffset||document.body.scrollLeft,h=window.pageYOffset||document.body.scrollTop,i=document.defaultView.getComputedStyle(e,null),j=parseFloat(i.getPropertyValue("padding-left")),k=parseFloat(i.getPropertyValue("border-left-width")),l=parseFloat(i.getPropertyValue("padding-top")),m=parseFloat(i.getPropertyValue("border-top-width"));c=Math.round(a.pageX-(f.left+j+k+g)),d=Math.round(a.pageY-(f.top+l+m+h))}else if(b){var n=b(a.target,new WebKitPoint(0,0));c=Math.round(n.x),d=Math.round(n.y)}else x3dom.debug.logError("NO getBoundingClientRect, NO webkitConvertPointFromNodeToPage");return new x3dom.fields.SFVec2f(c,d)}},x3dom.X3DCanvas.prototype.tick=function(){try{var a=this.x3dElem.runtime,b=(new Date).getTime(),c=b-this.lastTimeFPSWasTaken,d=1e3/(b-this.fps_t0);this.fps_t0=b,this.doc.advanceTime(b/1e3);var e=(new Date).getTime()-b;this.doc.needRender&&(c>=1e3&&(a.fps=this.framesSinceLastTime/(c/1e3),a.addMeasurement("FPS",a.fps),this.framesSinceLastTime=0,this.lastTimeFPSWasTaken=b),this.framesSinceLastTime++,a.addMeasurement("ANIM",e),0==a.isReady&&(a.ready(),a.isReady=!0),a.enterFrame(),"flash"==this.backend?this.isFlashReady&&(this.canvas.setFPS({fps:d}),this.doc.needRender=!1,this.doc.render(this.gl)):(this.doc.needRender=!1,this.doc.render(this.gl),this.doc._scene._vf.doPickPass||a.removeMeasurement("PICKING")),a.exitFrame()),this.progressDiv&&(this.doc.downloadCount>0?a.addInfo("#LOADS:",this.doc.downloadCount):a.removeInfo("#LOADS:"),"false"!==this.doc.properties.getProperty("showProgress")?this.progressDiv&&(this.progressDiv.childNodes[0].textContent="Loading: "+ +this.doc.downloadCount,this.progressDiv.style.display=this.doc.downloadCount>0?"inline":"none"):this.progressDiv.style.display="none")}catch(f){throw x3dom.debug.logException(f),f}},x3dom.X3DCanvas.prototype.load=function(a,b,c){this.doc=new x3dom.X3DDocument(this.canvas,this.gl,c);var d=this;this.doc.onload=function(){d.hasRuntime?!function a(){d.watchForResize(),d.tick(),window.requestAnimFrame(a,d)}():d.tick()},this.x3dElem.render=function(){d.hasRuntime?d.doc.needRender=!0:d.doc.render(d.gl)},this.x3dElem.context=d.gl.ctx3d,this.doc.onerror=function(){alert("Failed to load X3D document")},this.doc.load(a,b)},x3dom.runtime={},x3dom.Runtime=function(a,b){this.doc=a,this.canvas=b,this.config={},this.isReady=!1,this.fps=0,this.states={measurements:[],infos:[]}},x3dom.Runtime.prototype.addMeasurement=function(a,b){this.states.measurements[a]=b},x3dom.Runtime.prototype.removeMeasurement=function(a){this.states.measurements[a]&&delete this.states.measurements[a]},x3dom.Runtime.prototype.addInfo=function(a,b){this.states.infos[a]=b},x3dom.Runtime.prototype.removeInfo=function(a){delete this.states.infos[a]},x3dom.Runtime.prototype.initialize=function(a,b){this.doc=a,this.canvas=b,this.config={},this.isReady=!1,this.fps=0},x3dom.Runtime.prototype.noBackendFound=function(){x3dom.debug.logInfo("No backend found. Unable to render.")},x3dom.Runtime.prototype.ready=function(){x3dom.debug.logInfo("System ready.")},x3dom.Runtime.prototype.enterFrame=function(){},x3dom.Runtime.prototype.exitFrame=function(){},x3dom.Runtime.prototype.triggerRedraw=function(){this.canvas.doc.needRender=!0},x3dom.Runtime.prototype.getActiveBindable=function(a){var b,c,d,e,f;if(b=this.canvas.doc._bindableBag._stacks,e=[],f=x3dom.nodeTypesLC[a.toLowerCase()],!f)return x3dom.debug.logError('No node of type "'+a+'" found.'),null;for(c=0;c<b.length;c++)d=b[c].getActive(),void 0!==d._xmlNode&&x3dom.isa(d,f)&&e.push(d);return e[0]?e[0]._xmlNode:null},x3dom.Runtime.prototype.nextView=function(){var a=this.canvas.doc._scene.getViewpoint()._stack;a?a.switchTo("next"):x3dom.debug.logError("No valid ViewBindable stack.")},x3dom.Runtime.prototype.prevView=function(){var a=this.canvas.doc._scene.getViewpoint()._stack;a?a.switchTo("prev"):x3dom.debug.logError("No valid ViewBindable stack.")},x3dom.Runtime.prototype.viewpoint=function(){return this.canvas.doc._scene.getViewpoint()},x3dom.Runtime.prototype.viewMatrix=function(){return this.canvas.doc._viewarea.getViewMatrix()},x3dom.Runtime.prototype.projectionMatrix=function(){return this.canvas.doc._viewarea.getProjectionMatrix()},x3dom.Runtime.prototype.getWorldToCameraCoordinatesMatrix=function(){return this.canvas.doc._viewarea.getWCtoCCMatrix()},x3dom.Runtime.prototype.getCameraToWorldCoordinatesMatrix=function(){return this.canvas.doc._viewarea.getCCtoWCMatrix()},x3dom.Runtime.prototype.getViewingRay=function(a,b){return this.canvas.doc._viewarea.calcViewRay(a,b)},x3dom.Runtime.prototype.shootRay=function(a,b){var c=this.canvas.doc,d=c._viewarea._pickingInfo;return c.onPick(this.canvas.gl,a,b),{pickPosition:d.pickObj?d.pickPos:null,pickNormal:d.pickObj?d.pickNorm:null,pickObject:d.pickObj?d.pickObj._xmlNode:null}},x3dom.Runtime.prototype.getWidth=function(){return this.canvas.doc._viewarea._width},x3dom.Runtime.prototype.getHeight=function(){return this.canvas.doc._viewarea._height},x3dom.Runtime.prototype.mousePosition=function(a){var b=this.canvas.mousePosition(a);return[b.x,b.y]},x3dom.Runtime.prototype.calcCanvasPos=function(a,b,c){var d=new x3dom.fields.SFVec3f(a,b,c),e=this.canvas.doc._viewarea.getWCtoCCMatrix(),f=e.multFullMatrixPnt(d),g=this.canvas.doc._viewarea._width,h=this.canvas.doc._viewarea._height,i=Math.round((f.x+1)*(g-1)/2),j=Math.round((h-1)*(1-f.y)/2);return[i,j]},x3dom.Runtime.prototype.calcPagePos=function(a,b,c){var d=this.canvas.canvas.offsetParent;if(!d)return x3dom.debug.logError("Can't calc page pos without offsetParent."),[0,0];var e=d.getBoundingClientRect(),f=this.calcCanvasPos(a,b,c),g=window.pageXOffset||document.body.scrollLeft,h=window.pageYOffset||document.body.scrollTop,i=document.defaultView.getComputedStyle(d,null),j=parseFloat(i.getPropertyValue("padding-left")),k=parseFloat(i.getPropertyValue("border-left-width")),l=parseFloat(i.getPropertyValue("padding-top")),m=parseFloat(i.getPropertyValue("border-top-width")),n=e.left+j+k+g+f[0],o=e.top+l+m+h+f[1];return[n,o]},x3dom.Runtime.prototype.calcClientPos=function(a,b,c){var d=this.canvas.canvas.offsetParent;if(!d)return x3dom.debug.logError("Can't calc client pos without offsetParent."),[0,0];var e=d.getBoundingClientRect(),f=this.calcCanvasPos(a,b,c),g=document.defaultView.getComputedStyle(d,null),h=parseFloat(g.getPropertyValue("padding-left")),i=parseFloat(g.getPropertyValue("border-left-width")),j=parseFloat(g.getPropertyValue("padding-top")),k=parseFloat(g.getPropertyValue("border-top-width")),l=e.left+h+i+f[0],m=e.top+j+k+f[1];return[l,m]},x3dom.Runtime.prototype.getScreenshot=function(){var a="",b=this.canvas.backend,c=this.canvas.canvas;if(c)if("flash"==b)a=c.getScreenshot();else{var d=document.createElement("canvas");d.width=c.width,d.height=c.height;var e=d.getContext("2d");e.drawImage(c,0,0,c.width,c.height),e.scale(1,-1),e.translate(0,-c.height),a=d.toDataURL()}return a},x3dom.Runtime.prototype.getCanvas=function(){return this.canvas.canvas},x3dom.Runtime.prototype.lightMatrix=function(){this.canvas.doc._viewarea.getLightMatrix()},x3dom.Runtime.prototype.resetView=function(){this.canvas.doc._viewarea.resetView()},x3dom.Runtime.prototype.lightView=function(){return this.canvas.doc._nodeBag.lights.length>0?(this.canvas.doc._viewarea.animateTo(this.canvas.doc._viewarea.getLightMatrix()[0],this.canvas.doc._scene.getViewpoint()),!0):(x3dom.debug.logInfo("No lights to navigate to."),!1)},x3dom.Runtime.prototype.uprightView=function(){this.canvas.doc._viewarea.uprightView()},x3dom.Runtime.prototype.fitAll=function(a){void 0===a&&(a=!0);var b=this.canvas.doc._scene;b.updateVolume();var c=x3dom.fields.SFVec3f.copy(b._lastMin),d=x3dom.fields.SFVec3f.copy(b._lastMax);this.canvas.doc._viewarea.fit(c,d,a)},x3dom.Runtime.prototype.fitObject=function(a,b){if(a&&a._x3domNode){void 0===b&&(b=!0);var c=x3dom.fields.SFVec3f.MAX(),d=x3dom.fields.SFVec3f.MIN(),e=a._x3domNode.getVolume();if(e.getBounds(c,d),!x3dom.isa(a._x3domNode,x3dom.nodeTypes.Transform)){var f=a._x3domNode.getCurrentTransform();c=f.multMatrixPnt(c),d=f.multMatrixPnt(d)}this.canvas.doc._viewarea.fit(c,d,b)}},x3dom.Runtime.prototype.showAll=function(a){this.canvas.doc._viewarea.showAll(a)},x3dom.Runtime.prototype.showObject=function(a){if(a&&a._x3domNode){var b=x3dom.fields.SFVec3f.MAX(),c=x3dom.fields.SFVec3f.MIN(),d=a._x3domNode.getVolume();d.getBounds(b,c);var e=a._x3domNode.getCurrentTransform();b=e.multMatrixPnt(b),c=e.multMatrixPnt(c);var f=this.canvas.doc._viewarea,g=f._width<f._height?f._width:f._height,h=new x3dom.fields.SFVec3f(0,0,1),i=this.canvas.doc._scene.getViewpoint(),j=i.getFieldOfView()/2,k=Math.tan(j);Math.abs(k)>x3dom.fields.Eps&&(g/=k);var l=f._width-1,m=f._height-1,n=.25,o=new x3dom.fields.SFVec2f(n*l,n*m);n=.75;var p=new x3dom.fields.SFVec2f(n*l,n*m),q=c.subtract(b).multiply(.5),r=q.length(),s=b.add(q),t=p.subtract(o).multiply(.5),u=1.5*t.length();t=t.add(o);var v=1;u>x3dom.fields.Eps&&(v=r/u*Math.sqrt(t.x*t.x+t.y*t.y+g*g)),h=e.multMatrixVec(h).normalize(),h=h.multiply(v);var w=s.add(h),x=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,1),h),y=x.toMatrix(),z=x3dom.fields.SFMatrix4f.translation(w.negate()),A=x3dom.fields.SFMatrix4f.translation(w);A=A.mult(y).mult(z).mult(A);var B=A.inverse();f.animateTo(B,i)}},x3dom.Runtime.prototype.getCenter=function(a){return a&&a._x3domNode&&(this.isA(a,"X3DShapeNode")||this.isA(a,"X3DGeometryNode"))?a._x3domNode.getCenter():null},x3dom.Runtime.prototype.getCurrentTransform=function(a){return a&&a._x3domNode?a._x3domNode.getCurrentTransform():null},x3dom.Runtime.prototype.getBBox=function(a){if(a&&a._x3domNode&&this.isA(a,"X3DBoundedNode")){var b=a._x3domNode.getVolume();return{min:x3dom.fields.SFVec3f.copy(b.min),max:x3dom.fields.SFVec3f.copy(b.max)}}return null},x3dom.Runtime.prototype.getSceneBBox=function(){var a=this.canvas.doc._scene;return a.updateVolume(),{min:x3dom.fields.SFVec3f.copy(a._lastMin),max:x3dom.fields.SFVec3f.copy(a._lastMax)}},x3dom.Runtime.prototype.debug=function(a){var b=this.canvas.doc;return void 0===b._viewarea._visDbgBuf&&(b._viewarea._visDbgBuf="true"===b._x3dElem.getAttribute("showLog")),arguments.length>0?a===!0?(b._viewarea._visDbgBuf=!0,x3dom.debug.logContainer.style.display="block"):(b._viewarea._visDbgBuf=!1,x3dom.debug.logContainer.style.display="none"):(b._viewarea._visDbgBuf=!b._viewarea._visDbgBuf,x3dom.debug.logContainer.style.display=1==b._viewarea._visDbgBuf?"block":"none"),b.needRender=!0,b._viewarea._visDbgBuf},x3dom.Runtime.prototype.navigationType=function(){return this.canvas.doc._scene.getNavigationInfo().getType()},x3dom.Runtime.prototype.noNav=function(){this.canvas.doc._scene.getNavigationInfo().setType("none")},x3dom.Runtime.prototype.examine=function(){this.canvas.doc._scene.getNavigationInfo().setType("examine")},x3dom.Runtime.prototype.turnTable=function(){this.canvas.doc._scene.getNavigationInfo().setType("turntable")},x3dom.Runtime.prototype.fly=function(){this.canvas.doc._scene.getNavigationInfo().setType("fly")},x3dom.Runtime.prototype.freeFly=function(){this.canvas.doc._scene.getNavigationInfo().setType("freefly")},x3dom.Runtime.prototype.lookAt=function(){this.canvas.doc._scene.getNavigationInfo().setType("lookat")},x3dom.Runtime.prototype.lookAround=function(){this.canvas.doc._scene.getNavigationInfo().setType("lookaround")},x3dom.Runtime.prototype.walk=function(){this.canvas.doc._scene.getNavigationInfo().setType("walk")},x3dom.Runtime.prototype.game=function(){this.canvas.doc._scene.getNavigationInfo().setType("game")},x3dom.Runtime.prototype.helicopter=function(){this.canvas.doc._scene.getNavigationInfo().setType("helicopter")},x3dom.Runtime.prototype.resetExamin=function(){var a=this.canvas.doc._viewarea;a._rotMat=x3dom.fields.SFMatrix4f.identity(),a._transMat=x3dom.fields.SFMatrix4f.identity(),a._movement=new x3dom.fields.SFVec3f(0,0,0),a._needNavigationMatrixUpdate=!0,this.canvas.doc.needRender=!0},x3dom.Runtime.prototype.togglePoints=function(a){var b=this.canvas.doc,c=a===!0?3:2;return b._viewarea._points=++b._viewarea._points%c,b.needRender=!0,b._viewarea._points},x3dom.Runtime.prototype.pickRect=function(a,b,c,d){return this.canvas.doc.onPickRect(this.canvas.gl,a,b,c,d)},x3dom.Runtime.prototype.pickMode=function(a){return a&&a.internal===!0?this.canvas.doc._scene._vf.pickMode:this.canvas.doc._scene._vf.pickMode.toLowerCase()},x3dom.Runtime.prototype.changePickMode=function(a){switch(a=a.toLowerCase()){case"idbuf":a="idBuf";break;case"idbuf24":a="idBuf24";break;case"idbufid":a="idBufId";break;case"texcoord":a="texCoord";break;case"color":a="color";break;case"box":a="box";break;default:x3dom.debug.logWarning("Switch pickMode to "+a+" unknown intersect type"),a=void 0}return void 0!==a?(this.canvas.doc._scene._vf.pickMode=a,x3dom.debug.logInfo("Switched pickMode to '"+a+"'."),!0):!1},x3dom.Runtime.prototype.speed=function(a){var b=this.canvas.doc._scene.getNavigationInfo();return a&&(b._vf.speed=a,x3dom.debug.logInfo("Changed navigation speed to "+b._vf.speed)),b._vf.speed},x3dom.Runtime.prototype.statistics=function(a){var b=this.canvas.stateViewer;return b?(this.canvas.doc.needRender=!0,a===!0?(b.display(a),!0):a===!1?(b.display(a),!1):(b.display(!b.active),b.active)):!1},x3dom.Runtime.prototype.processIndicator=function(a){var b=this.canvas.progressDiv;return b?a===!0?(b.style.display="inline",!0):a===!1?(b.style.display="none",!1):"none"!=b.style.display:!1},x3dom.Runtime.prototype.properties=function(){return this.canvas.doc.properties},x3dom.Runtime.prototype.backendName=function(){return this.canvas.backend},x3dom.Runtime.prototype.getFPS=function(){return this.fps},x3dom.Runtime.prototype.isA=function(a,b){var c=!1;return b&&a&&a._x3domNode&&(""===b&&(b="X3DNode"),c=x3dom.isa(a._x3domNode,x3dom.nodeTypesLC[b.toLowerCase()])),c},x3dom.detectActiveX=function(){var a=!1;if(window.ActiveXObject){var b=null;try{b=new ActiveXObject("AVALONATX.InstantPluginATXCtrl.1")}catch(c){}b&&(a=!0)}return a},x3dom.rerouteSetAttribute=function(a,b){a._setAttribute=a.setAttribute,a.setAttribute=function(c,d){var e=a.getAttribute("_x3domNode"),f=b.findNode(e);return f?f.parseField(c,d):0};for(var c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];x3dom.rerouteSetAttribute(d,b)}},x3dom.insertActiveX=function(a){"undefined"==typeof x3dom.atxCtrlCounter&&(x3dom.atxCtrlCounter=0);var b=a.getAttribute("height"),c=a.getAttribute("width"),d=a.parentNode,e=document.createElement("div");e.setAttribute("id","x3dplaceholder");var f=d.insertBefore(e,a),g=document.createElement("div");g.style.display="none",d.appendChild(g),d.removeChild(a),g.appendChild(a);var h=document.createElement("object"),i="Avalon"+x3dom.atxCtrlCounter;x3dom.atxCtrlCounter++,h.setAttribute("id",i),h.setAttribute("classid","CLSID:F3254BA0-99FF-4D14-BD81-EDA9873A471E"),h.setAttribute("width",c?c:"500"),h.setAttribute("height",b?b:"500"),f.appendChild(h);var j=document.getElementById(i),k=j.getBrowser(),l=k.importDocument(a);k.replaceWorld(l),a.getBrowser=function(){return j.getBrowser()},x3dom.rerouteSetAttribute(a,k)},x3dom.userAgentFeature={supportsDOMAttrModified:!1},function(){var a=function(){var a,b,c,d,e,f=document.getElementsByTagName("X3D"),g=document.getElementsByTagName("webSG"),h=new x3dom.Properties,i=array_to_object(["showLog","showStat","showProgress","PrimitiveQuality","components","loadpath","disableDoubleClick","backend","altImg","flashrenderer","swfpath","runtimeEnabled","keysEnabled","showTouchpoints","disableTouch","maxActiveDownloads"]),j=!1;for(a=0;a<f.length;a++){for(h.setProperty("showLog",f[a].getAttribute("showLog")||"false"),h.setProperty("showStat",f[a].getAttribute("showStat")||"false"),h.setProperty("showProgress",f[a].getAttribute("showProgress")||"true"),h.setProperty("PrimitiveQuality",f[a].getAttribute("PrimitiveQuality")||"High"),c=f[a].getElementsByTagName("PARAM"),b=0;b<c.length;b++)c[b].getAttribute("name")in i&&h.setProperty(c[b].getAttribute("name"),c[b].getAttribute("value"));if("true"===h.getProperty("showLog")&&(j=!0),"undefined"!=typeof X3DOM_SECURITY_OFF&&X3DOM_SECURITY_OFF===!0&&(d=h.getProperty("components",f[a].getAttribute("components"))))for(e=h.getProperty("loadpath",f[a].getAttribute("loadpath")),d=d.trim().split(","),b=0;b<d.length;b++)x3dom.loadJS(d[b]+".js",e);if("undefined"!=typeof X3DOM_SECURITY_OFF&&X3DOM_SECURITY_OFF===!0&&f[a].getAttribute("src")){var k=document.createElement("scene"),l=document.createElement("Inline");l.setAttribute("url",f[a].getAttribute("src")),k.appendChild(l),f[a].appendChild(k)}}for(1==j?x3dom.debug.activate(!0):x3dom.debug.activate(!1),f=Array.map(f,function(a){return a.hasRuntime=!0,a}),g=Array.map(g,function(a){return a.hasRuntime=!1,a}),a=0;a<g.length;a++)f.push(g[a]);void 0!==x3dom.versionInfo&&x3dom.debug.logInfo("X3DOM version "+x3dom.versionInfo.version+", "+"Revison <a href='https://github.com/x3dom/x3dom/tree/"+x3dom.versionInfo.revision+"'>"+x3dom.versionInfo.revision+"</a>, "+"Date "+x3dom.versionInfo.date),x3dom.debug.logInfo("Found "+(f.length-g.length)+" X3D and "+g.length+" (experimental) WebSG nodes...");var m,n,o,p,q,r,s;for(a=0;a<f.length;a++)m=f[a],x3dom.detectActiveX()?x3dom.insertActiveX(m):(n=new x3dom.X3DCanvas(m,a),null!==n.gl?(r=(new Date).getTime(),f[a].runtime=new x3dom.Runtime(f[a],n),f[a].runtime.initialize(f[a],n),x3dom.runtime.ready&&(f[a].runtime.ready=x3dom.runtime.ready),""==n.backend&&x3dom.runtime.noBackendFound(),n.load(f[a],a,h),"true"===h.getProperty("showStat")?f[a].runtime.statistics(!0):f[a].runtime.statistics(!1),"true"===h.getProperty("showProgress")?("bar"===h.getProperty("showProgress")&&n.progressDiv.setAttribute("class","x3dom-progress bar"),f[a].runtime.processIndicator(!0)):f[a].runtime.processIndicator(!1),x3dom.canvases.push(n),s=(new Date).getTime()-r,x3dom.debug.logInfo("Time for setup and init of GL element no. "+a+": "+s+" ms.")):(o=document.createElement("div"),o.setAttribute("class","x3dom-nox3d"),o.setAttribute("id","x3dom-nox3d"),p=document.createElement("p"),p.appendChild(document.createTextNode("WebGL is not yet supported in your browser. ")),q=document.createElement("a"),q.setAttribute("href","http://www.x3dom.org/?page_id=9"),q.appendChild(document.createTextNode("Follow link for a list of supported browsers... ")),o.appendChild(p),o.appendChild(q),n.x3dElem.appendChild(o),n.stateViewer&&m.removeChild(n.stateViewer.viewer)));!function(a){var b=null;document.createEvent?(b=document.createEvent("Events"),b.initEvent(a,!0,!0),document.dispatchEvent(b)):document.createEventObject&&(b=document.createEventObject(),document.body.fireEvent("on"+a,b))}("load")},b=function(){if(x3dom.canvases){for(var a=0;a<x3dom.canvases.length;a++)x3dom.canvases[a].doc.shutdown(x3dom.canvases[a].gl);x3dom.canvases=[]}};x3dom.reload=function(){b(),a()},-1!=navigator.userAgent.indexOf("Chrome")?(document.__getElementsByTagName=document.getElementsByTagName,document.getElementsByTagName=function(a){var b=[],c=this.__getElementsByTagName("*");if("*"==a)b=c;else{a=a.toUpperCase();for(var d=0;d<c.length;d++){var e=c[d].tagName.toUpperCase();e===a&&b.push(c[d])}}return b},document.__getElementById=document.getElementById,document.getElementById=function(a){var b=this.__getElementById(a);if(!b)for(var c=this.__getElementsByTagName("*"),d=0;d<c.length&&!b;d++)c[d].getAttribute("id")===a&&(b=c[d]);return b}):(document.__getElementById=document.getElementById,document.getElementById=function(a){var b=this.__getElementById(a);if(!b)for(var c=this.getElementsByTagName("*"),d=0;d<c.length&&!b;d++)c[d].getAttribute("id")===a&&(b=c[d]);return b}),window.addEventListener?(window.addEventListener("load",a,!1),window.addEventListener("unload",b,!1),window.addEventListener("reload",b,!1)):window.attachEvent&&(window.attachEvent("onload",a),window.attachEvent("onunload",b),window.attachEvent("onreload",b)),"complete"===document.readyState&&window.setTimeout(function(){a()},20)}(),x3dom.Cache=function(){this.textures=[],this.shaders=[]},x3dom.Cache.prototype.getTexture2D=function(a,b,c,d,e,f){var g=c;return void 0===this.textures[g]&&(this.textures[g]=x3dom.Utils.createTexture2D(a,b,c,d,e,f)),this.textures[g]
},x3dom.Cache.prototype.getTextureCube=function(a,b,c,d,e,f){for(var g="",h=0;h<c.length;++h)g+=c[h]+"|";return void 0===this.textures[g]&&(this.textures[g]=x3dom.Utils.createTextureCube(a,b,c,d,e,f)),this.textures[g]},x3dom.Cache.prototype.getShader=function(a,b){var c=null;if(void 0===this.shaders[b]){switch(b){case x3dom.shader.PICKING:c=new x3dom.shader.PickingShader(a);break;case x3dom.shader.PICKING_24:c=new x3dom.shader.Picking24Shader(a);break;case x3dom.shader.PICKING_ID:c=new x3dom.shader.PickingIdShader(a);break;case x3dom.shader.PICKING_COLOR:c=new x3dom.shader.PickingColorShader(a);break;case x3dom.shader.PICKING_TEXCOORD:c=new x3dom.shader.PickingTexcoordShader(a);break;case x3dom.shader.FRONTGROUND_TEXTURE:c=new x3dom.shader.FrontgroundTextureShader(a);break;case x3dom.shader.BACKGROUND_TEXTURE:c=new x3dom.shader.BackgroundTextureShader(a);break;case x3dom.shader.BACKGROUND_SKYTEXTURE:c=new x3dom.shader.BackgroundSkyTextureShader(a);break;case x3dom.shader.BACKGROUND_CUBETEXTURE:c=new x3dom.shader.BackgroundCubeTextureShader(a);break;case x3dom.shader.SHADOW:c=new x3dom.shader.ShadowShader(a);break;case x3dom.shader.BLUR:c=new x3dom.shader.BlurShader(a);break;case x3dom.shader.DEPTH:break;case x3dom.shader.NORMAL:c=new x3dom.shader.NormalShader(a)}c?this.shaders[b]=x3dom.Utils.wrapProgram(a,c,b):x3dom.debug.logError("Couldn't create shader: "+b)}return this.shaders[b]},x3dom.Cache.prototype.getDynamicShader=function(a,b,c){var d=x3dom.Utils.generateProperties(b,c),e=d.id;if(void 0===this.shaders[e]){var f;f=d.CSHADER>=0?new x3dom.shader.ComposedShader(a,c):x3dom.caps.MOBILE&&!d.CSSHADER?new x3dom.shader.DynamicMobileShader(a,d):new x3dom.shader.DynamicShader(a,d),this.shaders[e]=x3dom.Utils.wrapProgram(a,f,e)}return this.shaders[e]},x3dom.Cache.prototype.getShaderByProperties=function(a,b,c){var d=c.id;if(void 0===this.shaders[d]){var e;e=c.CSHADER>=0?new x3dom.shader.ComposedShader(a,b):x3dom.caps.MOBILE&&!c.CSSHADER?new x3dom.shader.DynamicMobileShader(a,c):new x3dom.shader.DynamicShader(a,c),this.shaders[d]=x3dom.Utils.wrapProgram(a,e,d)}return this.shaders[d]},x3dom.Cache.prototype.getShadowRenderingShader=function(a,b){for(var c="shadow",d=0;d<b.length;d++)c+=x3dom.isa(b[d],x3dom.nodeTypes.SpotLight)?"S":x3dom.isa(b[d],x3dom.nodeTypes.PointLight)?"P":"D";if(void 0===this.shaders[c]){var e=new x3dom.shader.ShadowRenderingShader(a,b);this.shaders[c]=x3dom.Utils.wrapProgram(a,e,c)}return this.shaders[c]},x3dom.Cache.prototype.Release=function(a){for(var b in this.textures)a.deleteTexture(this.textures[b]);this.textures=[];for(var c in this.shaders){for(var d=this.shaders[c],e=a.getAttachedShaders(d.program),f=0;f<e.length;++f)a.detachShader(d.program,e[f]),a.deleteShader(e[f]);a.deleteProgram(d.program)}this.shaders=[]},x3dom.Texture=function(a,b,c,d){this.gl=a,this.doc=b,this.cache=c,this.node=d,this.samplerName="diffuseMap",this.type=a.TEXTURE_2D,this.format=a.RGBA,this.magFilter=a.LINEAR,this.minFilter=a.LINEAR,this.wrapS=a.REPEAT,this.wrapT=a.REPEAT,this.genMipMaps=!1,this.texture=null,this.ready=!1,this.dashtexture=!1;var e=this.node,f="mpd";if(x3dom.isa(e,x3dom.nodeTypes.MovieTexture)&&-1!==e._vf.url[0].indexOf(f,e._vf.url[0].length-f.length)){this.dashtexture=!0;var g=document.getElementById("AdditionalDashVideoScript");g||(g=document.createElement("script"),g.setAttribute("type","text/javascript"),g.setAttribute("src",x3dom.Texture.dashVideoScriptFile),g.setAttribute("id","AdditionalDashVideoScript"),g.onload=function(){for(var a;a=x3dom.Texture.loadDashVideos.pop();)x3dom.Texture.textNum++,a.update();g.ready=!0},document.getElementsByTagName("head")[0].appendChild(g)),g.ready===!0?(x3dom.Texture.textNum++,this.update()):x3dom.Texture.loadDashVideos.push(this)}this.dashtexture||this.update()},x3dom.Texture.dashVideoScriptFile="dash.all.js",x3dom.Texture.loadDashVideos=[],x3dom.Texture.textNum=0,x3dom.Texture.prototype.update=function(){x3dom.isa(this.node,x3dom.nodeTypes.Text)?this.updateText():this.updateTexture()},x3dom.Texture.prototype.updateTexture=function(){var a=this.gl,b=this.doc,c=this.node;if(this.samplerName=c._type,this.type=x3dom.isa(c,x3dom.nodeTypes.X3DEnvironmentTextureNode)?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D,x3dom.isa(c,x3dom.nodeTypes.PixelTexture))switch(c._vf.image.comp){case 1:this.format=a.LUMINANCE;break;case 2:this.format=a.LUMINANCE_ALPHA;break;case 3:this.format=a.RGB;break;case 4:this.format=a.RGBA}else this.format=a.RGBA;var d=void 0!==c._video&&null!==c._video&&void 0!==c._needPerFrameUpdate&&c._needPerFrameUpdate===!0;if(null!==c._cf.textureProperties.node){var e=c._cf.textureProperties.node;this.wrapS=x3dom.Utils.boundaryModesDic(a,e._vf.boundaryModeS),this.wrapT=x3dom.Utils.boundaryModesDic(a,e._vf.boundaryModeT),this.minFilter=x3dom.Utils.minFilterDic(a,e._vf.minificationFilter),this.magFilter=x3dom.Utils.magFilterDic(a,e._vf.magnificationFilter),e._vf.generateMipMaps===!0?(this.genMipMaps=!0,this.minFilter==a.NEAREST?this.minFilter=a.NEAREST_MIPMAP_NEAREST:this.minFilter==a.LINEAR&&(this.minFilter=a.LINEAR_MIPMAP_LINEAR)):(this.genMipMaps=!1,this.minFilter==a.LINEAR_MIPMAP_LINEAR||this.minFilter==a.LINEAR_MIPMAP_NEAREST?this.minFilter=a.LINEAR:(this.minFilter==a.NEAREST_MIPMAP_LINEAR||this.minFilter==a.NEAREST_MIPMAP_NEAREST)&&(this.minFilter=a.NEAREST))}else(0==c._vf.repeatS||"displacementMap"==this.samplerName)&&(this.wrapS=a.CLAMP_TO_EDGE),(0==c._vf.repeatT||"displacementMap"==this.samplerName)&&(this.wrapT=a.CLAMP_TO_EDGE);if(c._isCanvas&&c._canvas)null==this.texture&&(this.texture=a.createTexture()),this.texture.width=c._canvas.width,this.texture.height=c._canvas.height,a.bindTexture(this.type,this.texture),a.texImage2D(this.type,0,this.format,this.format,a.UNSIGNED_BYTE,c._canvas),a.bindTexture(this.type,null);else if(x3dom.isa(c,x3dom.nodeTypes.RenderedTexture))c._webgl&&c._webgl.fbo?this.texture=c._webgl.fbo.tex:(this.texture=null,x3dom.debug.logError("Try updating RenderedTexture without FBO initialized!"));else if(x3dom.isa(c,x3dom.nodeTypes.PixelTexture)){null==this.texture&&(this.texture=a.createTexture()),this.texture.width=c._vf.image.width,this.texture.height=c._vf.image.height;for(var f=c._vf.image.toGL(),g=c._vf.image.width*c._vf.image.height*c._vf.image.comp;f.length<g;)f.push(0);var h=new Uint8Array(f);a.bindTexture(this.type,this.texture),a.pixelStorei(a.UNPACK_ALIGNMENT,1),a.texImage2D(this.type,0,this.format,c._vf.image.width,c._vf.image.height,0,this.format,a.UNSIGNED_BYTE,h),a.bindTexture(this.type,null)}else if(x3dom.isa(c,x3dom.nodeTypes.MovieTexture)||d){var i=this,j=document.getElementsByTagName("body")[0];if(null==this.texture&&(this.texture=a.createTexture()),this.dashtexture){var k=document.createElement("div");k.setAttribute("class","dash-video-player"+x3dom.Texture.textNum),c._video=document.createElement("video"),c._video.setAttribute("autobuffer","true");var l=document.createElement("script");l.setAttribute("type","text/javascript"),l.innerHTML='startDashVideo("'+c._vf.url[0]+'",".dash-video-player'+x3dom.Texture.textNum+' video")',k.appendChild(l),k.appendChild(c._video),j.appendChild(k),c._video.style.visibility="hidden"}else{d||(c._video=document.createElement("video"),c._video.setAttribute("autobuffer","true"),j.appendChild(c._video),c._video.style.visibility="hidden");for(var m=0;m<c._vf.url.length;m++){var n=c._nameSpace.getURL(c._vf.url[m]);x3dom.debug.logInfo("Adding video file: "+n);var o=document.createElement("source");o.setAttribute("src",n),c._video.appendChild(o)}}var p=function(){a.bindTexture(i.type,i.texture),a.texImage2D(i.type,0,i.format,i.format,a.UNSIGNED_BYTE,c._video),a.bindTexture(i.type,null),b.needRender=!0},q=function(){c._video.play(),c._intervalID=setInterval(p,16)},r=function(){clearInterval(c._intervalID),c._vf.loop===!0&&(c._video.play(),c._intervalID=setInterval(p,16))};c._video.addEventListener("canplaythrough",q,!0),c._video.addEventListener("ended",r,!0)}else this.texture=x3dom.isa(c,x3dom.nodeTypes.X3DEnvironmentTextureNode)?this.cache.getTextureCube(a,b,c.getTexUrl(),!1,c._vf.withCredentials,c._vf.scale):this.cache.getTexture2D(a,b,c._nameSpace.getURL(c._vf.url[0]),!1,c._vf.withCredentials,c._vf.scale)},x3dom.Texture.prototype.updateText=function(){var a=this.gl;this.wrapS=a.CLAMP_TO_EDGE,this.wrapT=a.CLAMP_TO_EDGE;var b=this.node._cf.fontStyle.node,c="serif",d="normal",e="left",f=1,g=1,h=!0,i="";if(null!==b){var j=b._vf.family.toString();switch(j=j.trim().replace(/\'/g,"").replace(/\,/," "),j=j.split(" "),c=Array.map(j,function(a){return"SANS"==a?"sans-serif":"SERIF"==a?"serif":"TYPEWRITER"==a?"monospace":""+a}).join(","),d=b._vf.style.toString().replace(/\'/g,""),d.toUpperCase()){case"PLAIN":d="normal";break;case"BOLD":d="bold";break;case"ITALIC":d="italic";break;case"BOLDITALIC":d="italic bold";break;default:d="normal"}var k=b._vf.leftToRight?"ltr":"rtl";switch(b._vf.topToBottom,e=b._vf.justify[0].toString().replace(/\'/g,""),e.toUpperCase()){case"BEGIN":e="left";break;case"END":e="right";break;case"FIRST":e="left";break;case"MIDDLE":e="center";break;default:e="left"}f=b._vf.size,g=b._vf.spacing,h=b._vf.horizontal,i=b._vf.language,.1>f&&(f=.1),f>2.3&&(f=2.3)}var l,m,n=this.node._vf.string,o=document.createElement("canvas");o.dir=k;var p=42*f,q=e;document.body.appendChild(o);var r=o.getContext("2d");r.font=d+" "+p+"px "+c;var s,t=r.measureText(n[0]).width;for(s=1;s<n.length;s++)r.measureText(n[s]).width>t&&(t=r.measureText(n[s]).width);switch(o.width=t,o.height=p*n.length,q){case"left":l=0;break;case"center":l=o.width/2;break;case"right":l=o.width}var u=o.width,v=o.height;for(r.fillStyle="rgba(0,0,0,0)",r.fillRect(0,0,r.canvas.width,r.canvas.height),r.fillStyle="white",r.lineWidth=2.5,r.strokeStyle="grey",r.textBaseline="top",r.font=d+" "+p+"px "+c,r.textAlign=q,s=0;s<n.length;s++)m=s*p,r.fillText(n[s],l,m);null===this.texture&&(this.texture=a.createTexture()),a.bindTexture(this.type,this.texture),a.texImage2D(this.type,0,this.format,this.format,a.UNSIGNED_BYTE,o),a.bindTexture(this.type,null),document.body.removeChild(o);var w=u/100,x=v/100;this.node._mesh._positions[0]=[-w,-x+.4,0,w,-x+.4,0,w,x+.4,0,-w,x+.4,0],this.node.invalidateVolume(),Array.forEach(this.node._parentNodes,function(a){a.setAllDirty()})},x3dom.shader={},x3dom.shader.PICKING="picking",x3dom.shader.PICKING_24="picking24",x3dom.shader.PICKING_ID="pickingId",x3dom.shader.PICKING_COLOR="pickingColor",x3dom.shader.PICKING_TEXCOORD="pickingTexCoord",x3dom.shader.FRONTGROUND_TEXTURE="frontgroundTexture",x3dom.shader.BACKGROUND_TEXTURE="backgroundTexture",x3dom.shader.BACKGROUND_SKYTEXTURE="backgroundSkyTexture",x3dom.shader.BACKGROUND_CUBETEXTURE="backgroundCubeTexture",x3dom.shader.SHADOW="shadow",x3dom.shader.BLUR="blur",x3dom.shader.DEPTH="depth",x3dom.shader.NORMAL="normal",x3dom.shader.material=function(){var a="uniform vec3  diffuseColor;\nuniform vec3  specularColor;\nuniform vec3  emissiveColor;\nuniform float shininess;\nuniform float transparency;\nuniform float ambientIntensity;\n";return a},x3dom.shader.fog=function(){var a="uniform vec3  fogColor;\nuniform float fogType;\nuniform float fogRange;\nvarying vec3 fragEyePosition;\nfloat calcFog(in vec3 eye) {\n   float f0 = 0.0;\n   if(fogType == 0.0) {\n       if(length(eye) < fogRange){\n           f0 = (fogRange-length(eye)) / fogRange;\n       }\n   }else{\n       if(length(eye) < fogRange){\n           f0 = exp(-length(eye) / (fogRange-length(eye) ) );\n       }\n   }\n   f0 = clamp(f0, 0.0, 1.0);\n   return f0;\n}\n";return a},x3dom.shader.gammaCorrectionDecl=function(a){var b="";return"none"===a.GAMMACORRECTION||("fastlinear"===a.GAMMACORRECTION?(b+="vec4 gammaEncode(vec4 color){\n  vec4 tmp = sqrt(color);\n  return vec4(tmp.rgb, color.a);\n}\n",b+="vec4 gammaDecode(vec4 color){\n  vec4 tmp = color * color;\n  return vec4(tmp.rgb, color.a);\n}\n",b+="vec3 gammaEncode(vec3 color){\n  return sqrt(color);\n}\n",b+="vec3 gammaDecode(vec3 color){\n  return (color * color);\n}\n"):(b+="const vec4 gammaEncode4Vector = vec4(0.4545454545454545, 0.4545454545454545, 0.4545454545454545, 1.0);\n",b+="const vec4 gammaDecode4Vector = vec4(2.2, 2.2, 2.2, 1.0);\n",b+="vec4 gammaEncode(vec4 color){\n    return pow(color, gammaEncode4Vector);\n}\n",b+="vec4 gammaDecode(vec4 color){\n    return pow(color, gammaDecode4Vector);\n}\n",b+="const vec3 gammaEncode3Vector = vec3(0.4545454545454545, 0.4545454545454545, 0.4545454545454545);\n",b+="const vec3 gammaDecode3Vector = vec3(2.2, 2.2, 2.2);\n",b+="vec3 gammaEncode(vec3 color){\n    return pow(color, gammaEncode3Vector);\n}\n",b+="vec3 gammaDecode(vec3 color){\n    return pow(color, gammaDecode3Vector);\n}\n")),b},x3dom.shader.encodeGamma=function(a,b){return"none"===a.GAMMACORRECTION?b:"gammaEncode ("+b+")"},x3dom.shader.decodeGamma=function(a,b){return"none"===a.GAMMACORRECTION?b:"gammaDecode ("+b+")"},x3dom.shader.rgbaPacking=function(){var a="";return a+="vec4 packDepth(float depth){\n	depth = (depth + 1.0)*0.5;\n	vec4 outVal = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n	outVal = fract(outVal);\n  	outVal -= outVal.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  	return outVal;\n}\n",a+="float unpackDepth(vec4 color){\n	float depth = dot(color, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0));\n	return (2.0*depth - 1.0);\n}\n"},x3dom.shader.shadowRendering=function(){var a="";return a+="float getLightInfluence(float lType, float lShadowIntensity, float lOn, vec3 lLocation, vec3 lDirection, float lCutOffAngle, float lBeamWidth, vec3 lAttenuation, float lRadius, vec3 eyeCoords) {\n	if (lOn == 0.0 || lShadowIntensity == 0.0){ return 0.0;\n	} else if (lType == 0.0) {\n		return 1.0;\n	} else {\n   	float attenuation = 0.0;\n   	vec3 lightVec = (lLocation - (eyeCoords));\n   	float distance = length(lightVec);\n		lightVec = normalize(lightVec);\n		eyeCoords = normalize(-eyeCoords);\n   	if(lRadius == 0.0 || distance <= lRadius) {\n       	attenuation = 1.0 / max(lAttenuation.x + lAttenuation.y * distance + lAttenuation.z * (distance * distance), 1.0);\n		}\n 		if (lType == 1.0) return attenuation;\n   	float spotAngle = acos(max(0.0, dot(-lightVec, normalize(lDirection))));\n   	if(spotAngle >= lCutOffAngle) return 0.0;\n   	else if(spotAngle <= lBeamWidth) return attenuation;\n   	else return attenuation * (spotAngle - lCutOffAngle) / (lBeamWidth - lCutOffAngle);\n	}\n}\n",a+="void getShadowValues(inout vec4 shadowMapValues, inout float viewSampleDepth, in mat4 lightMatrix, in vec4 worldCoords, in sampler2D shadowMap){\n	vec4 lightSpaceCoords = lightMatrix*worldCoords;\n	vec3 lightSpaceCoordsCart = lightSpaceCoords.xyz / lightSpaceCoords.w;\n	vec2 textureCoords = (lightSpaceCoordsCart.xy + 1.0)*0.5;\n	viewSampleDepth = lightSpaceCoordsCart.z;\n	shadowMapValues = texture2D(shadowMap, textureCoords);\n",(!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE)&&(a+="	shadowMapValues = vec4(1.0,1.0,unpackDepth(shadowMapValues),1.0);\n"),a+="}\n",a+="void getShadowValuesPointLight(inout vec4 shadowMapValues, inout float viewSampleDepth, in vec3 lLocation, in vec4 worldCoords, in mat4 lightViewMatrix,in mat4 lMatrix_0, in mat4 lMatrix_1, in mat4 lMatrix_2, in mat4 lMatrix_3, in mat4 lMatrix_4, in mat4 lMatrix_5,in sampler2D shadowMap_0, in sampler2D shadowMap_1, in sampler2D shadowMap_2, in sampler2D shadowMap_3,in sampler2D shadowMap_4, in sampler2D shadowMap_5){\n	vec4 transformed = lightViewMatrix * worldCoords;\n	vec3 lightVec = normalize(transformed.xyz/transformed.w);\n	vec3 lightVecAbs = abs(lightVec);\n	float maximum = max(max(lightVecAbs.x, lightVecAbs.y),lightVecAbs.z);\n	if (lightVecAbs.x == maximum) {\n		if (lightVec.x < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_3,worldCoords,shadowMap_3);\n		else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_1,worldCoords,shadowMap_1);\n	}\n	else if (lightVecAbs.y == maximum) {\n		if (lightVec.y < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_4,worldCoords,shadowMap_4);\n		else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_5,worldCoords,shadowMap_5);\n	}\n	else if (lightVec.z < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_0,worldCoords,shadowMap_0);\n	else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_2,worldCoords,shadowMap_2);\n}\n",a+="void getShadowValuesCascaded(inout vec4 shadowMapValues, inout float viewSampleDepth, in vec4 worldCoords, in float eyeDepth, in mat4 lMatrix_0, in mat4 lMatrix_1, in mat4 lMatrix_2,in mat4 lMatrix_3, in mat4 lMatrix_4, in mat4 lMatrix_5, in sampler2D shadowMap_0, in sampler2D shadowMap_1, in sampler2D shadowMap_2,in sampler2D shadowMap_3, in sampler2D shadowMap_4, in sampler2D shadowMap_5, in float split_0, in float split_1, in float split_2, in float split_3, in float split_4){\n	if (eyeDepth < split_0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_0, worldCoords, shadowMap_0);\n	else if (eyeDepth < split_1) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_1, worldCoords, shadowMap_1);\n	else if (eyeDepth < split_2) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_2, worldCoords, shadowMap_2);\n	else if (eyeDepth < split_3) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_3, worldCoords, shadowMap_3);\n	else if (eyeDepth < split_4) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_4, worldCoords, shadowMap_4);\n	else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_5, worldCoords, shadowMap_5);\n}\n",a+="float ESM(float shadowMapDepth, float viewSampleDepth, float offset){\n",a+=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?"	return exp(-80.0*(1.0-offset)*(viewSampleDepth - shadowMapDepth));\n":"	return shadowMapDepth * exp(-80.0*(1.0-offset)*viewSampleDepth);\n",a+="}\n",a+="float VSM(vec2 moments, float viewSampleDepth, float offset){\n	viewSampleDepth = (viewSampleDepth + 1.0) * 0.5;\n	if (viewSampleDepth <= moments.x) return 1.0;\n	float variance = moments.y - moments.x * moments.x;\n	variance = max(variance, 0.00002 + offset*0.01);\n	float d = viewSampleDepth - moments.x;\n	return variance/(variance + d*d);\n}\n"},x3dom.shader.light=function(a){for(var b="",c=0;a>c;c++)b+="uniform float light"+c+"_On;\n"+"uniform float light"+c+"_Type;\n"+"uniform vec3  light"+c+"_Location;\n"+"uniform vec3  light"+c+"_Direction;\n"+"uniform vec3  light"+c+"_Color;\n"+"uniform vec3  light"+c+"_Attenuation;\n"+"uniform float light"+c+"_Radius;\n"+"uniform float light"+c+"_Intensity;\n"+"uniform float light"+c+"_AmbientIntensity;\n"+"uniform float light"+c+"_BeamWidth;\n"+"uniform float light"+c+"_CutOffAngle;\n"+"uniform float light"+c+"_ShadowIntensity;\n";return b+="void lighting(in float lType, in vec3 lLocation, in vec3 lDirection, in vec3 lColor, in vec3 lAttenuation, in float lRadius, in float lIntensity, in float lAmbientIntensity, in float lBeamWidth, in float lCutOffAngle, in vec3 N, in vec3 V, inout vec3 ambient, inout vec3 diffuse, inout vec3 specular)\n{\n   vec3 L;\n   float spot = 1.0, attentuation = 0.0;\n   if(lType == 0.0) {\n       L = -normalize(lDirection);\n		V = normalize(V);\n		attentuation = 1.0;\n   } else{\n       L = (lLocation - (-V));\n       float d = length(L);\n		L = normalize(L);\n		V = normalize(V);\n       if(lRadius == 0.0 || d <= lRadius) {\n       	attentuation = 1.0 / max(lAttenuation.x + lAttenuation.y * d + lAttenuation.z * (d * d), 1.0);\n		}\n       if(lType == 2.0) {\n           float spotAngle = acos(max(0.0, dot(-L, normalize(lDirection))));\n           if(spotAngle >= lCutOffAngle) spot = 0.0;\n           else if(spotAngle <= lBeamWidth) spot = 1.0;\n           else spot = (spotAngle - lCutOffAngle ) / (lBeamWidth - lCutOffAngle);\n       }\n   }\n   vec3  H = normalize( L + V );\n   float NdotL = max(0.0, dot(L, N));\n   float NdotH = max(0.0, dot(H, N));\n   float ambientFactor  = lAmbientIntensity * ambientIntensity;\n   float diffuseFactor  = lIntensity * NdotL;\n   float specularFactor = lIntensity * pow(NdotH, shininess*128.0);\n   ambient  += lColor * ambientFactor * attentuation * spot;\n   diffuse  += lColor * diffuseFactor * attentuation * spot;\n   specular += lColor * specularFactor * attentuation * spot;\n}\n"},x3dom.shader.TBNCalculation=function(){var a="";return a+="mat3 cotangent_frame(vec3 N, vec3 p, vec2 uv)\n{\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( p );\n    vec3 dp2 = dFdy( p );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n\n    // solve the linear system\n    vec3 dp2perp = cross( dp2, N );\n    vec3 dp1perp = cross( N, dp1 );\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n    // construct a scale-invariant frame\n    float invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n    return mat3( T * invmax, B * invmax, N );\n}\n\n",a+="vec3 perturb_normal( vec3 N, vec3 V, vec2 texcoord )\n{\n    // assume N, the interpolated vertex normal and\n    // V, the view vector (vertex to eye)\n    vec3 map = texture2D(normalMap, texcoord ).xyz;\n    map = map * 255./127. - 128./127.;\n    mat3 TBN = cotangent_frame(N, -V, texcoord);\n    return normalize(TBN * map);\n}\n\n"},x3dom.shader.DynamicShader=function(a,b){this.program=a.createProgram();var c=this.generateVertexShader(a,b),d=this.generateFragmentShader(a,b);return a.attachShader(this.program,c),a.attachShader(this.program,d),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.DynamicShader.prototype.generateVertexShader=function(a,b){var c="";if(c+="uniform mat4 modelViewMatrix;\n",c+="uniform mat4 modelViewProjectionMatrix;\n",3==b.POSCOMPONENTS?c+="attribute vec3 position;\n":4==b.POSCOMPONENTS&&(c+="attribute vec4 position;\n"),b.IMAGEGEOMETRY){c+="uniform vec3 IG_bboxMin;\n",c+="uniform vec3 IG_bboxMax;\n",c+="uniform float IG_coordTextureWidth;\n",c+="uniform float IG_coordTextureHeight;\n",c+="uniform vec2 IG_implicitMeshSize;\n";for(var d=0;d<b.IG_PRECISION;d++)c+="uniform sampler2D IG_coords"+d+"\n;";b.IG_INDEXED&&(c+="uniform sampler2D IG_index;\n",c+="uniform float IG_indexTextureWidth;\n",c+="uniform float IG_indexTextureHeight;\n")}if(b.POPGEOMETRY&&(c+="uniform float PG_precisionLevel;\n",c+="uniform float PG_powPrecision;\n",c+="uniform vec3 PG_maxBBSize;\n",c+="uniform vec3 PG_bbMin;\n",c+="uniform vec3 PG_bbMaxModF;\n",c+="uniform vec3 PG_bboxShiftVec;\n",c+="uniform float PG_numAnchorVertices;\n",c+="attribute float PG_vertexID;\n"),b.LIGHTS&&(c+="varying vec3 fragNormal;\n",c+="uniform mat4 normalMatrix;\n",b.IMAGEGEOMETRY?c+="uniform sampler2D IG_normals;\n":2==b.NORCOMPONENTS?4!=b.POSCOMPONENTS&&(c+="attribute vec2 normal;\n"):3==b.NORCOMPONENTS&&(c+="attribute vec3 normal;\n")),b.VERTEXCOLOR&&(b.IMAGEGEOMETRY?(c+="uniform sampler2D IG_colors;\n",3==b.COLCOMPONENTS?c+="varying vec3 fragColor;\n":4==b.COLCOMPONENTS&&(c+="varying vec4 fragColor;\n")):3==b.COLCOMPONENTS?(c+="attribute vec3 color;\n",c+="varying vec3 fragColor;\n"):4==b.COLCOMPONENTS&&(c+="attribute vec4 color;\n",c+="varying vec4 fragColor;\n")),(b.TEXTURED||b.CSSHADER)&&(c+="varying vec2 fragTexcoord;\n",b.SPHEREMAPPING||(c+=b.IMAGEGEOMETRY?"uniform sampler2D IG_texCoords;\n":"attribute vec2 texcoord;\n"),b.TEXTRAFO&&(c+="uniform mat4 texTrafoMatrix;\n"),b.NORMALMAP&&!x3dom.caps.STD_DERIVATIVES&&(x3dom.debug.logWarning("Your System doesn't support the 'OES_STANDARD_DERIVATIVES' Extension. You must set tangents and binormals manually via the FloatVertexAttribute-Node to use normal maps"),c+="attribute vec3 tangent;\n",c+="attribute vec3 binormal;\n",c+="varying vec3 fragTangent;\n",c+="varying vec3 fragBinormal;\n"),b.CUBEMAP&&(c+="varying vec3 fragViewDir;\n",c+="uniform mat4 viewMatrix;\n"),b.DISPLACEMENTMAP&&(c+="uniform sampler2D displacementMap;\n",c+="uniform float displacementFactor;\n",c+="uniform float displacementWidth;\n",c+="uniform float displacementHeight;\n",c+="uniform float displacementAxis;\n"),b.DIFFPLACEMENTMAP&&(c+="uniform sampler2D diffuseDisplacementMap;\n",c+="uniform float displacementFactor;\n",c+="uniform float displacementWidth;\n",c+="uniform float displacementHeight;\n",c+="uniform float displacementAxis;\n")),(b.LIGHTS||b.FOG)&&(c+="uniform vec3 eyePosition;\n",c+="varying vec3 fragPosition;\n",b.FOG&&(c+="varying vec3 fragEyePosition;\n")),b.REQUIREBBOX&&(c+="uniform vec3 bgCenter;\n",c+="uniform vec3 bgSize;\n",c+="uniform float bgPrecisionMax;\n"),b.REQUIREBBOXNOR&&(c+="uniform float bgPrecisionNorMax;\n"),b.REQUIREBBOXCOL&&(c+="uniform float bgPrecisionColMax;\n"),b.REQUIREBBOXTEX&&(c+="uniform float bgPrecisionTexMax;\n"),c+="void main(void) {\n",c+="gl_PointSize = 2.0;\n",b.IMAGEGEOMETRY){b.IG_INDEXED?(c+="vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n",c+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n",c+="vec2 IG_indices = texture2D( IG_index, IG_texCoord ).rg;\n",c+="halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);\n",c+="IG_texCoord = (IG_indices * 0.996108948) + halfPixel;\n"):(c+="vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n",c+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n"),c+="vec3 temp = vec3(0.0, 0.0, 0.0);\n",c+="vec3 vertPosition = vec3(0.0, 0.0, 0.0);\n";for(var d=0;d<b.IG_PRECISION;d++)c+="temp = 255.0 * texture2D( IG_coords"+d+", IG_texCoord ).rgb;\n",c+="vertPosition *= 256.0;\n",c+="vertPosition += temp;\n";c+="vertPosition /= (pow(2.0, 8.0 * "+b.IG_PRECISION+".0) - 1.0);\n",c+="vertPosition = vertPosition * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n",b.LIGHTS&&(c+="vec3 vertNormal = texture2D( IG_normals, IG_texCoord ).rgb;\n",c+="vertNormal = vertNormal * 2.0 - 1.0;\n"),b.VERTEXCOLOR&&(3==b.COLCOMPONENTS?c+="fragColor = texture2D( IG_colors, IG_texCoord ).rgb;\n":4==b.COLCOMPONENTS&&(c+="fragColor = texture2D( IG_colors, IG_texCoord ).rgba;\n")),(b.TEXTURED||b.CSSHADER)&&(c+="vec4 IG_doubleTexCoords = texture2D( IG_texCoords, IG_texCoord );\n",c+="vec2 vertTexCoord;",c+="vertTexCoord.r = (IG_doubleTexCoords.r * 0.996108948) + (IG_doubleTexCoords.b * 0.003891051);\n",c+="vertTexCoord.g = (IG_doubleTexCoords.g * 0.996108948) + (IG_doubleTexCoords.a * 0.003891051);\n")}else c+="vec3 vertPosition = position.xyz;\n",b.POPGEOMETRY?(c+="vec3 offsetVec = step(vertPosition / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",c+="if ((PG_precisionLevel <= 2.0) || PG_vertexID >= PG_numAnchorVertices) {\n",c+="   vertPosition = floor(vertPosition / PG_powPrecision) * PG_powPrecision;\n",c+="   vertPosition /= (65536.0 - PG_powPrecision);\n",c+="}\n",c+="else {\n",c+="   vertPosition /= bgPrecisionMax;\n",c+="}\n",c+="vertPosition = (vertPosition + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):b.REQUIREBBOX&&(c+="vertPosition = bgCenter + bgSize * vertPosition / bgPrecisionMax;\n"),b.LIGHTS&&(2==b.NORCOMPONENTS?(4==b.POSCOMPONENTS?(c+="vec3 vertNormal = vec3(position.w / 256.0); \n",c+="vertNormal.x = floor(vertNormal.x) / 255.0; \n",c+="vertNormal.y = fract(vertNormal.y) * 1.00392156862745; \n"):b.REQUIREBBOXNOR&&(c+="vec3 vertNormal = vec3(normal.xy, 0.0) / bgPrecisionNorMax;\n"),c+="vec2 thetaPhi = 3.14159265358979 * vec2(vertNormal.x, vertNormal.y*2.0-1.0); \n",c+="vec4 sinCosThetaPhi = sin( vec4(thetaPhi, thetaPhi + 1.5707963267949) ); \n",c+="vertNormal.x = sinCosThetaPhi.x * sinCosThetaPhi.w; \n",c+="vertNormal.y = sinCosThetaPhi.x * sinCosThetaPhi.y; \n",c+="vertNormal.z = sinCosThetaPhi.z; \n"):(c+="vec3 vertNormal = normal;\n",b.REQUIREBBOXNOR&&(c+="vertNormal = vertNormal / bgPrecisionNorMax;\n"),(b.BITLODGEOMETRY||b.POPGEOMETRY)&&(c+="vertNormal = 2.0*vertNormal - 1.0;\n"))),b.VERTEXCOLOR&&(c+="fragColor = color;\n",b.REQUIREBBOXCOL&&(c+="fragColor = fragColor / bgPrecisionColMax;\n")),!b.TEXTURED&&!b.CSSHADER||b.SPHEREMAPPING||(c+="vec2 vertTexCoord = texcoord;\n",b.REQUIREBBOXTEX&&(c+="vertTexCoord = vertTexCoord / bgPrecisionTexMax;\n"));b.LIGHTS&&(b.DISPLACEMENTMAP||b.DIFFPLACEMENTMAP&&!b.NORMALMAP?(c+="float dx = 1.0 / displacementWidth;\n",c+="float dy = 1.0 / displacementHeight;\n",b.DISPLACEMENTMAP?(c+="float s1 = texture2D(displacementMap, vec2(vertTexCoord.x - dx, 1.0 - vertTexCoord.y)).r;\n",c+="float s2 = texture2D(displacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y - dy)).r;\n",c+="float s3 = texture2D(displacementMap, vec2(vertTexCoord.x + dx, 1.0 - vertTexCoord.y)).r;\n",c+="float s4 = texture2D(displacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y + dy)).r;\n"):b.DIFFPLACEMENTMAP&&(c+="float s1 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x - dx, 1.0 - vertTexCoord.y)).a;\n",c+="float s2 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y - dy)).a;\n",c+="float s3 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x + dx, 1.0 - vertTexCoord.y)).a;\n",c+="float s4 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y + dy)).a;\n"),c+="float coef = displacementFactor;\n",c+="vec3 calcNormal;\n",c+="if (displacementAxis == 0.0) {\n",c+="calcNormal = vec3((s1 - s3) * coef, -5.0, (s2 - s4) * coef);\n",c+="} else if(displacementAxis == 1.0) {\n",c+="calcNormal = vec3((s1 - s3) * coef, -5.0, (s2 - s4) * coef);\n",c+="} else {\n",c+="calcNormal = vec3((s1 - s3) * coef, -(s2 - s4) * coef, 5.0);\n",c+="}\n",c+="calcNormal = normalize(calcNormal);\n",c+="fragNormal = (normalMatrix * vec4(calcNormal, 0.0)).xyz;\n"):c+="fragNormal = (normalMatrix * vec4(vertNormal, 0.0)).xyz;\n"),(b.TEXTURED||b.CSSHADER)&&(b.CUBEMAP?c+="fragViewDir = (viewMatrix[3].xyz);\n":b.SPHEREMAPPING?c+=" fragTexcoord = 0.5 + fragNormal.xy / 2.0;\n":b.TEXTRAFO?c+=" fragTexcoord = (texTrafoMatrix * vec4(vertTexCoord, 1.0, 1.0)).xy;\n":(c+=" fragTexcoord = vertTexCoord;\n",b.POPGEOMETRY&&x3dom.debug.usePrecisionLevelAsTexCoord===!0&&(c+="fragTexcoord = vec2(0.03125 + 0.9375 * (PG_precisionLevel / 16.0), 1.0);")),b.NORMALMAP&&!x3dom.caps.STD_DERIVATIVES&&(c+="fragTangent  = (normalMatrix * vec4(tangent, 0.0)).xyz;\n",c+="fragBinormal = (normalMatrix * vec4(binormal, 0.0)).xyz;\n")),(b.LIGHTS||b.FOG)&&(c+="fragPosition = (modelViewMatrix * vec4(vertPosition, 1.0)).xyz;\n",b.FOG&&(c+="fragEyePosition = eyePosition - fragPosition;\n")),b.DISPLACEMENTMAP?c+="vertPosition += normalize(vertNormal) * texture2D(displacementMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).r * displacementFactor;\n":b.DIFFPLACEMENTMAP&&(c+="vertPosition += normalize(vertNormal) * texture2D(diffuseDisplacementMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).a * displacementFactor;\n"),c+="gl_Position = modelViewProjectionMatrix * vec4(vertPosition, 1.0);\n",c+="}\n";var e=a.createShader(a.VERTEX_SHADER);return a.shaderSource(e,c),a.compileShader(e),a.getShaderParameter(e,a.COMPILE_STATUS)||x3dom.debug.logError("VertexShader "+a.getShaderInfoLog(e)),e},x3dom.shader.DynamicShader.prototype.generateFragmentShader=function(a,b){var c="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";if(c+="precision highp float;\n",c+="#else\n",c+=" precision mediump float;\n",c+="#endif\n\n",c+="uniform mat4 modelMatrix;\n",c+="uniform mat4 modelViewMatrix;\n",c+=x3dom.shader.material(),b.VERTEXCOLOR&&(3==b.COLCOMPONENTS?c+="varying vec3 fragColor;  \n":4==b.COLCOMPONENTS&&(c+="varying vec4 fragColor;  \n")),(b.TEXTURED||b.CSSHADER)&&(c+="varying vec2 fragTexcoord;\n",!b.TEXTURED&&!b.DIFFUSEMAP||b.CUBEMAP?b.CUBEMAP&&(c+="uniform samplerCube cubeMap;\n",c+="varying vec3 fragViewDir;\n",c+="uniform mat4 modelViewMatrixInverse;\n"):c+="uniform sampler2D diffuseMap;\n",b.SPECMAP&&(c+="uniform sampler2D specularMap;\n"),b.DISPLACEMENTMAP&&(c+="uniform sampler2D displacementMap;\n",c+="uniform float displacementWidth;\n",c+="uniform float displacementHeight;\n"),b.DIFFPLACEMENTMAP&&(c+="uniform sampler2D diffuseDisplacementMap;\n",c+="uniform float displacementWidth;\n",c+="uniform float displacementHeight;\n"),b.NORMALMAP&&(c+="uniform sampler2D normalMap;\n",x3dom.caps.STD_DERIVATIVES?(c+="#extension GL_OES_standard_derivatives:enable\n",c+=x3dom.shader.TBNCalculation()):(c+="varying vec3 fragTangent;\n",c+="varying vec3 fragBinormal;\n"))),b.FOG&&(c+=x3dom.shader.fog()),b.LIGHTS&&(c+="varying vec3 fragNormal;\n",c+="varying vec3 fragPosition;\n",c+=x3dom.shader.light(b.LIGHTS)),c+=x3dom.shader.gammaCorrectionDecl(b),c+="void main(void) {\n",c+="vec4 color;\n",c+="color.rgb = "+x3dom.shader.decodeGamma(b,"diffuseColor")+";\n",c+="color.a = 1.0 - transparency;\n",b.VERTEXCOLOR&&(3===b.COLCOMPONENTS?c+="color.rgb = "+x3dom.shader.decodeGamma(b,"fragColor")+";\n":4===b.COLCOMPONENTS&&(c+="color = "+x3dom.shader.decodeGamma(b,"fragColor")+";\n")),b.LIGHTS){c+="vec3 ambient   = vec3(0.0, 0.0, 0.0);\n",c+="vec3 diffuse   = vec3(0.0, 0.0, 0.0);\n",c+="vec3 specular  = vec3(0.0, 0.0, 0.0);\n",c+="vec3 normal 	  = normalize(fragNormal);\n",c+="vec3 eye 	  = -fragPosition;\n",b.NORMALMAP&&(c+="vec3 n = normalize( fragNormal );\n",x3dom.caps.STD_DERIVATIVES?c+="normal = perturb_normal( n, fragPosition, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) );\n":(c+="vec3 t = normalize( fragTangent );\n",c+="vec3 b = normalize( fragBinormal );\n",c+="mat3 tangentToWorld = mat3(t, b, n);\n",c+="normal = texture2D( normalMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) ).rgb;\n",c+="normal = 2.0 * normal - 1.0;\n",c+="normal = normalize( normal * tangentToWorld );\n",c+="normal.y = -normal.y;\n",c+="normal.x = -normal.x;\n")),b.SOLID||(c+="if (dot(normal, eye) < 0.0) {\n",c+="  normal *= -1.0;\n",c+="}\n");
for(var d=0;d<b.LIGHTS;d++)c+=" lighting(light"+d+"_Type, "+"light"+d+"_Location, "+"light"+d+"_Direction, "+"light"+d+"_Color, "+"light"+d+"_Attenuation, "+"light"+d+"_Radius, "+"light"+d+"_Intensity, "+"light"+d+"_AmbientIntensity, "+"light"+d+"_BeamWidth, "+"light"+d+"_CutOffAngle, "+"normal, eye, ambient, diffuse, specular);\n";b.SPECMAP&&(c+="specular *= "+x3dom.shader.decodeGamma(b,"texture2D(specularMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).rgb")+";\n"),b.TEXTURED||b.DIFFUSEMAP||b.DIFFPLACEMENTMAP?(b.CUBEMAP?(c+="vec3 viewDir = normalize(fragViewDir);\n",c+="vec3 reflected = reflect(viewDir, normal);\n",c+="reflected = (modelViewMatrixInverse * vec4(reflected,0.0)).xyz;\n",c+="vec4 texColor = "+x3dom.shader.decodeGamma(b,"textureCube(cubeMap, reflected)")+";\n",c+="color.a *= texColor.a;\n"):b.DIFFPLACEMENTMAP?(c+="vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",c+="vec4 texColor = texture2D(diffuseDisplacementMap, texCoord);\n"):(c+="vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",c+="vec4 texColor = "+x3dom.shader.decodeGamma(b,"texture2D(diffuseMap, texCoord)")+";\n",c+="color.a *= texColor.a;\n"),b.BLENDING?(c+="color.rgb = (emissiveColor + ambient*color.rgb + diffuse*color.rgb + specular*specularColor);\n",c+=b.CUBEMAP?"color.rgb = mix(color.rgb, texColor.rgb, vec3(0.75));\n":"color.rgb *= texColor.rgb;\n"):c+="color.rgb = (emissiveColor + ambient*texColor.rgb + diffuse*texColor.rgb + specular*specularColor);\n"):c+="color.rgb = (emissiveColor + ambient*color.rgb + diffuse*color.rgb + specular*specularColor);\n"}else b.APPMAT&&!b.VERTEXCOLOR&&(c+="color = vec4(0.0, 0.0, 0.0, 1.0 - transparency);\n"),b.TEXTURED||b.DIFFUSEMAP?(c+="vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",c+="vec4 texColor = "+x3dom.shader.decodeGamma(b,"texture2D(diffuseMap, texCoord)")+";\n",c+="color.a = texColor.a;\n",b.BLENDING?(c+="color.rgb += emissiveColor.rgb;\n",c+="color.rgb *= texColor.rgb;\n"):c+="color = texColor;\n"):b.VERTEXCOLOR||b.POINTLINE2D?!b.VERTEXCOLOR&&b.POINTLINE2D&&(c+="color.rgb = emissiveColor;\n"):c+="color.rgb += emissiveColor;\n";b.FOG&&(c+="float f0 = calcFog(fragEyePosition);\n",c+="color.rgb = fogColor * (1.0-f0) + f0 * (color.rgb);\n"),c+=b.TEXT?"if (color.a <= 0.5) discard;\n":"if (color.a <= 0.1) discard;\n",c+="gl_FragColor = "+x3dom.shader.encodeGamma(b,"color")+";\n",c+="}\n";var e=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(e,c),a.compileShader(e),a.getShaderParameter(e,a.COMPILE_STATUS)||x3dom.debug.logError("FragmentShader "+a.getShaderInfoLog(e)),e},x3dom.shader.DynamicMobileShader=function(a,b){this.program=a.createProgram();var c=this.generateVertexShader(a,b),d=this.generateFragmentShader(a,b);return a.attachShader(this.program,c),a.attachShader(this.program,d),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.DynamicMobileShader.prototype.generateVertexShader=function(a,b){var c="";if(c+=x3dom.shader.material(),c+="uniform mat4 normalMatrix;\n",c+="uniform mat4 modelViewMatrix;\n",c+="uniform mat4 modelViewProjectionMatrix;\n",3==b.POSCOMPONENTS?c+="attribute vec3 position;\n":4==b.POSCOMPONENTS&&(c+="attribute vec4 position;\n"),b.IMAGEGEOMETRY){c+="uniform vec3 IG_bboxMin;\n",c+="uniform vec3 IG_bboxMax;\n",c+="uniform float IG_coordTextureWidth;\n",c+="uniform float IG_coordTextureHeight;\n",c+="uniform vec2 IG_implicitMeshSize;\n";for(var d=0;d<b.IG_PRECISION;d++)c+="uniform sampler2D IG_coords"+d+"\n;";b.IG_INDEXED&&(c+="uniform sampler2D IG_index;\n",c+="uniform float IG_indexTextureWidth;\n",c+="uniform float IG_indexTextureHeight;\n")}if(b.POPGEOMETRY&&(c+="uniform float PG_precisionLevel;\n",c+="uniform float PG_powPrecision;\n",c+="uniform vec3 PG_maxBBSize;\n",c+="uniform vec3 PG_bbMin;\n",c+="uniform vec3 PG_bbMaxModF;\n",c+="uniform vec3 PG_bboxShiftVec;\n",c+="uniform float PG_numAnchorVertices;\n",c+="attribute float PG_vertexID;\n"),b.POINTLINE2D||(b.IMAGEGEOMETRY?c+="uniform sampler2D IG_normals;\n":2==b.NORCOMPONENTS?4!=b.POSCOMPONENTS&&(c+="attribute vec2 normal;\n"):3==b.NORCOMPONENTS&&(c+="attribute vec3 normal;\n")),c+="varying vec4 fragColor;\n",b.VERTEXCOLOR&&(b.IMAGEGEOMETRY?c+="uniform sampler2D IG_colors;":3==b.COLCOMPONENTS?c+="attribute vec3 color;":4==b.COLCOMPONENTS&&(c+="attribute vec4 color;")),b.TEXTURED&&(c+="varying vec2 fragTexcoord;\n",c+=b.IMAGEGEOMETRY?"uniform sampler2D IG_texCoords;":"attribute vec2 texcoord;\n",b.TEXTRAFO&&(c+="uniform mat4 texTrafoMatrix;\n"),b.BLENDING||(c+="varying vec3 fragAmbient;\n",c+="varying vec3 fragDiffuse;\n"),b.CUBEMAP&&(c+="varying vec3 fragViewDir;\n",c+="varying vec3 fragNormal;\n",c+="uniform mat4 viewMatrix;\n")),b.FOG&&(c+=x3dom.shader.fog()),b.LIGHTS&&(c+=x3dom.shader.light(b.LIGHTS)),b.REQUIREBBOX&&(c+="uniform vec3 bgCenter;\n",c+="uniform vec3 bgSize;\n",c+="uniform float bgPrecisionMax;\n"),b.REQUIREBBOXNOR&&(c+="uniform float bgPrecisionNorMax;\n"),b.REQUIREBBOXCOL&&(c+="uniform float bgPrecisionColMax;\n"),b.REQUIREBBOXTEX&&(c+="uniform float bgPrecisionTexMax;\n"),c+="void main(void) {\n",c+="gl_PointSize = 2.0;\n",b.IMAGEGEOMETRY){b.IG_INDEXED?(c+="vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n",c+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n",c+="vec2 IG_indices = texture2D( IG_index, IG_texCoord ).rg;\n",c+="halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);\n",c+="IG_texCoord = (IG_indices * 0.996108948) + halfPixel;\n"):(c+="vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n",c+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n"),c+="vec3 temp = vec3(0.0, 0.0, 0.0);\n",c+="vec3 vertPosition = vec3(0.0, 0.0, 0.0);\n";for(var d=0;d<b.IG_PRECISION;d++)c+="temp = 255.0 * texture2D( IG_coords"+d+", IG_texCoord ).rgb;\n",c+="vertPosition *= 256.0;\n",c+="vertPosition += temp;\n";c+="vertPosition /= (pow(2.0, 8.0 * "+b.IG_PRECISION+".0) - 1.0);\n",c+="vertPosition = vertPosition * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n",b.POINTLINE2D||(c+="vec3 vertNormal = texture2D( IG_normals, IG_texCoord ).rgb;\n",c+="vertNormal = vertNormal * 2.0 - 1.0;\n"),b.VERTEXCOLOR&&(3==b.COLCOMPONENTS?c+="vec3 vertColor = texture2D( IG_colors, IG_texCoord ).rgb;":4==b.COLCOMPONENTS&&(c+="vec4 vertColor = texture2D( IG_colors, IG_texCoord ).rgba;")),b.TEXTURED&&(c+="vec4 IG_doubleTexCoords = texture2D( IG_texCoords, IG_texCoord );\n",c+="vec2 vertTexCoord;",c+="vertTexCoord.r = (IG_doubleTexCoords.r * 0.996108948) + (IG_doubleTexCoords.b * 0.003891051);\n",c+="vertTexCoord.g = (IG_doubleTexCoords.g * 0.996108948) + (IG_doubleTexCoords.a * 0.003891051);\n")}else c+="vec3 vertPosition = position.xyz;\n",b.POPGEOMETRY?(c+="vec3 offsetVec = step(vertPosition / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",c+="if ((PG_precisionLevel <= 2.0) || PG_vertexID >= PG_numAnchorVertices) {\n",c+="   vertPosition = floor(vertPosition / PG_powPrecision) * PG_powPrecision;\n",c+="   vertPosition /= (65536.0 - PG_powPrecision);\n",c+="}\n",c+="else {\n",c+="   vertPosition /= bgPrecisionMax;\n",c+="}\n",c+="vertPosition = (vertPosition + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):(b.REQUIREBBOX||b.BITLODGEOMETRY)&&(c+="vertPosition = bgCenter + bgSize * vertPosition / bgPrecisionMax;\n"),b.POINTLINE2D||(2==b.NORCOMPONENTS?(4==b.POSCOMPONENTS?(c+="vec3 vertNormal = vec3(position.w / 256.0); \n",c+="vertNormal.x = floor(vertNormal.x) / 255.0; \n",c+="vertNormal.y = fract(vertNormal.y) * 1.00392156862745; \n"):c+=b.REQUIREBBOXNOR&&!b.BITLODGEOMETRY?"vec3 vertNormal = vec3(normal.xy, 0.0) / bgPrecisionNorMax;\n":"vec3 vertNormal = vec3(normal.xy, 0.0);\n",c+="vec2 thetaPhi = 3.14159265358979 * vec2(vertNormal.x, vertNormal.y*2.0-1.0); \n",c+="vec4 sinCosThetaPhi = vec4(thetaPhi, thetaPhi + 1.5707963267949); \n",c+="vec4 thetaPhiPow2 = sinCosThetaPhi * sinCosThetaPhi; \n",c+="vec4 thetaPhiPow3 =  thetaPhiPow2  * sinCosThetaPhi; \n",c+="vec4 thetaPhiPow5 =  thetaPhiPow3  * thetaPhiPow2; \n",c+="vec4 thetaPhiPow7 =  thetaPhiPow5  * thetaPhiPow2; \n",c+="vec4 thetaPhiPow9 =  thetaPhiPow7  * thetaPhiPow2; \n",c+="sinCosThetaPhi +=  -0.16666666667   * thetaPhiPow3; \n",c+="sinCosThetaPhi +=   0.00833333333   * thetaPhiPow5; \n",c+="sinCosThetaPhi +=  -0.000198412698  * thetaPhiPow7; \n",c+="sinCosThetaPhi +=   0.0000027557319 * thetaPhiPow9; \n",c+="vertNormal.x = sinCosThetaPhi.x * sinCosThetaPhi.w; \n",c+="vertNormal.y = sinCosThetaPhi.x * sinCosThetaPhi.y; \n",c+="vertNormal.z = sinCosThetaPhi.z; \n"):(c+="vec3 vertNormal = normal;\n",b.REQUIREBBOXNOR&&(c+="vertNormal = vertNormal / bgPrecisionNorMax;\n"),(b.BITLODGEOMETRY||b.POPGEOMETRY)&&(c+="vertNormal = 2.0*vertNormal - 1.0;\n"))),b.VERTEXCOLOR&&(3==b.COLCOMPONENTS?c+="vec3 vertColor = color;":4==b.COLCOMPONENTS&&(c+="vec4 vertColor = color;"),b.REQUIREBBOXNOR&&(c+="vertColor = vertColor / bgPrecisionColMax;\n")),b.TEXTURED&&(c+="vec2 vertTexCoord = texcoord;\n",b.REQUIREBBOXTEX&&(c+="vertTexCoord = vertTexCoord / bgPrecisionTexMax;\n"));if(c+="vec3 positionMV = (modelViewMatrix * vec4(vertPosition, 1.0)).xyz;\n",b.POINTLINE2D||(c+="vec3 normalMV = normalize( (normalMatrix * vec4(vertNormal, 0.0)).xyz );\n"),c+="vec3 eye = -positionMV;\n",b.VERTEXCOLOR?(c+="vec3 rgb = vertColor.rgb;\n",4==b.COLCOMPONENTS?c+="float alpha = vertColor.a;\n":3==b.COLCOMPONENTS&&(c+="float alpha = 1.0 - transparency;\n")):(c+="vec3 rgb = diffuseColor;\n",c+="float alpha = 1.0 - transparency;\n"),b.TEXTURED&&(b.CUBEMAP?(c+="fragViewDir = viewMatrix[3].xyz;\n",c+="fragNormal = normalMV;\n"):b.SPHEREMAPPING?c+=" fragTexcoord = 0.5 + normalMV.xy / 2.0;\n":b.TEXTRAFO?c+=" fragTexcoord = (texTrafoMatrix * vec4(vertTexCoord, 1.0, 1.0)).xy;\n":(c+=" fragTexcoord = vertTexCoord;\n",b.POPGEOMETRY&&x3dom.debug.usePrecisionLevelAsTexCoord===!0&&(c+="fragTexcoord = vec2(0.03125 + 0.9375 * (PG_precisionLevel / 16.0), 1.0);"))),b.LIGHTS){c+="vec3 ambient   = vec3(0.0, 0.0, 0.0);\n",c+="vec3 diffuse   = vec3(0.0, 0.0, 0.0);\n",c+="vec3 specular  = vec3(0.0, 0.0, 0.0);\n",b.SOLID||(c+="if (dot(normalMV, eye) < 0.0) {\n",c+="	 normalMV *= -1.0;\n",c+="}\n");for(var d=0;d<b.LIGHTS;d++)c+=" lighting(light"+d+"_Type,"+"light"+d+"_Location,"+"light"+d+"_Direction,"+"light"+d+"_Color,"+"light"+d+"_Attenuation,"+"light"+d+"_Radius,"+"light"+d+"_Intensity,"+"light"+d+"_AmbientIntensity,"+"light"+d+"_BeamWidth,"+"light"+d+"_CutOffAngle,"+"normalMV, eye, ambient, diffuse, specular);\n";b.TEXTURED&&!b.BLENDING?(c+="fragAmbient = ambient;\n",c+="fragDiffuse = diffuse;\n",c+="fragColor.rgb = (emissiveColor + specular*specularColor);\n",c+="fragColor.a = alpha;\n"):(c+="fragColor.rgb = (emissiveColor + ambient*rgb + diffuse*rgb + specular*specularColor);\n",c+="fragColor.a = alpha;\n")}else b.APPMAT&&!b.VERTEXCOLOR&&(c+="rgb = vec3(0.0, 0.0, 0.0);\n"),b.TEXTURED&&!b.BLENDING?(c+="fragAmbient = vec3(0.0);\n",c+="fragDiffuse = vec3(1.0);\n",c+="fragColor.rgb = vec3(0.0);\n",c+="fragColor.a = alpha;\n"):!b.VERTEXCOLOR&&b.POINTLINE2D?(c+="fragColor.rgb = emissiveColor;\n",c+="fragColor.a = alpha;\n"):(c+="fragColor.rgb = rgb + emissiveColor;\n",c+="fragColor.a = alpha;\n");b.FOG&&(c+="float f0 = calcFog(-positionMV);\n",c+="fragColor.rgb = fogColor * (1.0-f0) + f0 * (fragColor.rgb);\n"),c+="gl_Position = modelViewProjectionMatrix * vec4(vertPosition, 1.0);\n",c+="}\n";var e=a.createShader(a.VERTEX_SHADER);return a.shaderSource(e,c),a.compileShader(e),a.getShaderParameter(e,a.COMPILE_STATUS)||x3dom.debug.logError("[DynamicMobileShader] VertexShader "+a.getShaderInfoLog(e)),e},x3dom.shader.DynamicMobileShader.prototype.generateFragmentShader=function(a,b){var c="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";c+="precision highp float;\n",c+="#else\n",c+=" precision mediump float;\n",c+="#endif\n\n",c+="varying vec4 fragColor;\n",b.TEXTURED&&(b.CUBEMAP?(c+="uniform samplerCube cubeMap;\n",c+="varying vec3 fragViewDir;\n",c+="varying vec3 fragNormal;\n",c+="uniform mat4 modelViewMatrixInverse;\n"):(c+="uniform sampler2D diffuseMap;           \n",c+="varying vec2 fragTexcoord;       \n"),b.BLENDING||(c+="varying vec3 fragAmbient;\n",c+="varying vec3 fragDiffuse;\n")),c+="void main(void) {\n",c+="vec4 color = fragColor;\n",b.TEXTURED&&(b.CUBEMAP?(c+="vec3 normal = normalize(fragNormal);\n",c+="vec3 viewDir = normalize(fragViewDir);\n",c+="vec3 reflected = reflect(viewDir, normal);\n",c+="reflected = (modelViewMatrixInverse * vec4(reflected,0.0)).xyz;\n",c+="vec4 texColor = textureCube(cubeMap, reflected);\n"):c+="vec4 texColor = texture2D(diffuseMap, vec2(fragTexcoord.s, 1.0-fragTexcoord.t));\n",b.BLENDING?b.CUBEMAP?(c+="color.rgb = mix(color.rgb, texColor.rgb, vec3(0.75));\n",c+="color.a = texColor.a;\n"):(c+="color.rgb *= texColor.rgb;\n",c+="color.a *= texColor.a;\n"):(c+="color.rgb += fragAmbient*texColor.rgb + fragDiffuse*texColor.rgb;\n",c+="color.a *= texColor.a;\n")),c+=b.TEXT?"if (color.a <= 0.5) discard;\n":"if (color.a <= 0.1) discard;\n",c+="gl_FragColor = color;\n",c+="}\n";var d=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(d,c),a.compileShader(d),a.getShaderParameter(d,a.COMPILE_STATUS)||x3dom.debug.logError("[DynamicMobileShader] FragmentShader "+a.getShaderInfoLog(d)),d},x3dom.shader.ComposedShader=function(a,b){this.program=a.createProgram();var c=this.generateVertexShader(a,b),d=this.generateFragmentShader(a,b);return a.attachShader(this.program,c),a.attachShader(this.program,d),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.ComposedShader.prototype.generateVertexShader=function(a,b){var c=b._cf.appearance.node._shader._vertex._vf.url[0],d=a.createShader(a.VERTEX_SHADER);return a.shaderSource(d,c),a.compileShader(d),a.getShaderParameter(d,a.COMPILE_STATUS)||x3dom.debug.logError("[ComposedShader] VertexShader "+a.getShaderInfoLog(d)),d},x3dom.shader.ComposedShader.prototype.generateFragmentShader=function(a,b){var c=b._cf.appearance.node._shader._fragment._vf.url[0],d=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(d,c),a.compileShader(d),a.getShaderParameter(d,a.COMPILE_STATUS)||x3dom.debug.logError("[ComposedShader] FragmentShader "+a.getShaderInfoLog(d)),d},x3dom.shader.NormalShader=function(a){this.program=a.createProgram();var b=this.generateVertexShader(a),c=this.generateFragmentShader(a);return a.attachShader(this.program,b),a.attachShader(this.program,c),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.NormalShader.prototype.generateVertexShader=function(a){var b="attribute vec3 position;\nattribute vec3 normal;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float bgPrecisionNorMax;\nuniform mat4 normalMatrix;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec3 fragNormal;\nvoid main(void) {\n    vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n    fragNormal = (normalMatrix * vec4(normal / bgPrecisionNorMax, 0.0)).xyz;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n}\n",c=a.createShader(a.VERTEX_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[NormalShader] VertexShader "+a.getShaderInfoLog(c)),c},x3dom.shader.NormalShader.prototype.generateFragmentShader=function(a){var b="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";b+="precision highp float;\n",b+="#else\n",b+=" precision mediump float;\n",b+="#endif\n\n",b+="varying vec3 fragNormal;\nvoid main(void) {\n    gl_FragColor = vec4(normalize(fragNormal) / 2.0 + 0.5, 1.0);\n}\n";var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[NormalShader] FragmentShader "+a.getShaderInfoLog(c)),c},x3dom.shader.PickingShader=function(a){this.program=a.createProgram();var b=this.generateVertexShader(a),c=this.generateFragmentShader(a);return a.attachShader(this.program,b),a.attachShader(this.program,c),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.PickingShader.prototype.generateVertexShader=function(a){var b="",c="",d="";c+="uniform float popGeometry;\nuniform float PG_precisionLevel;\nuniform float PG_powPrecision;\nuniform vec3 PG_maxBBSize;\nuniform vec3 PG_bbMin;\nuniform vec3 PG_bbMaxModF;\nuniform vec3 PG_bboxShiftVec;\n",d+="   else if (popGeometry != 0.0) {\n		vec3 offsetVec = step(pos / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n		if (PG_precisionLevel <= 2.0) {\n   		pos = floor(pos / PG_powPrecision) * PG_powPrecision;\n   		pos /= (65536.0 - PG_powPrecision);\n		}\n		else {\n   		pos /= bgPrecisionMax;\n		}\n		pos = (pos + offsetVec + PG_bbMin) * PG_maxBBSize;\n	}\n   else\n",b=x3dom.caps.MOBILE?"attribute vec3 position;\nattribute vec2 texcoord;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float writeShadowIDs;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 from;\nvarying vec3 worldCoord;\nvarying vec2 idCoord;\n"+c+"void main(void) {\n"+"    gl_PointSize = 2.0;\n"+"    vec3 pos = position;\n"+"    if (writeShadowIDs > 0.0) {\n"+"	    idCoord = vec2((texcoord.x + writeShadowIDs) / 256.0);\n"+"       idCoord.x = floor(idCoord.x) / 255.0;\n"+"       idCoord.y = fract(idCoord.y) * 1.00392156862745;\n"+"	 }\n"+d+"	 {\n"+"       pos = bgCenter + bgSize * pos / bgPrecisionMax;\n"+"	 }\n"+"    worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n"+"    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n"+"}\n":"attribute vec3 position;\nattribute vec2 texcoord;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 from;\nvarying vec3 worldCoord;\nvarying vec2 idCoord;\nuniform float writeShadowIDs;\nuniform float imageGeometry;\nuniform vec3 IG_bboxMin;\nuniform vec3 IG_bboxMax;\nuniform float IG_coordTextureWidth;\nuniform float IG_coordTextureHeight;\nuniform float IG_indexTextureWidth;\nuniform float IG_indexTextureHeight;\nuniform sampler2D IG_indexTexture;\nuniform sampler2D IG_coordinateTexture;\nuniform vec2 IG_implicitMeshSize;\n"+c+"void main(void) {\n"+"   gl_PointSize = 2.0;\n"+"   vec3 pos = position;\n"+"   if (writeShadowIDs > 0.0) {\n"+"	    idCoord = vec2((texcoord.x + writeShadowIDs) / 256.0);\n"+"       idCoord.x = floor(idCoord.x) / 255.0;\n"+"       idCoord.y = fract(idCoord.y) * 1.00392156862745;\n"+"	}\n"+"	if (imageGeometry != 0.0) {\n"+"		vec2 IG_texCoord;\n"+"		if(imageGeometry == 1.0) {\n"+"			vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n"+"			IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n"+"			vec2 IG_index = texture2D( IG_indexTexture, IG_texCoord ).rg;\n"+"			IG_texCoord = IG_index * 0.996108948;\n"+"		} else {\n"+"			vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n"+"			IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n"+"		}\n"+"		pos = texture2D( IG_coordinateTexture, IG_texCoord ).rgb;\n"+"	 	pos = pos * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n"+"	} \n"+d+"   {\n"+"		pos = bgCenter + bgSize * pos / bgPrecisionMax;\n"+"	}\n"+"	worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n"+"	gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n"+"}\n";var e=a.createShader(a.VERTEX_SHADER);return a.shaderSource(e,b),a.compileShader(e),a.getShaderParameter(e,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingShader] VertexShader "+a.getShaderInfoLog(e)),e},x3dom.shader.PickingShader.prototype.generateFragmentShader=function(a){var b="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";b+=" precision highp float;\n",b+="#else\n",b+=" precision mediump float;\n",b+="#endif\n\n",b+="uniform float writeShadowIDs;\nuniform float highBit;\nuniform float lowBit;\nuniform float sceneSize;\nvarying vec3 worldCoord;\nvarying vec2 idCoord;\nvoid main(void) {\n    vec4 col = vec4(0.0, 0.0, highBit, lowBit);\n    if (writeShadowIDs > 0.0) {\n       col.ba = idCoord;\n	 }\n    float d = length(worldCoord) / sceneSize;\n    vec2 comp = fract(d * vec2(256.0, 1.0));\n    col.rg = comp - (comp.rr * vec2(0.0, 1.0/256.0));\n    gl_FragColor = col;\n}\n";var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingShader] FragmentShader "+a.getShaderInfoLog(c)),c},x3dom.shader.Picking24Shader=function(a){this.program=a.createProgram();var b=this.generateVertexShader(a),c=this.generateFragmentShader(a);return a.attachShader(this.program,b),a.attachShader(this.program,c),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.Picking24Shader.prototype.generateVertexShader=function(a){var b="";b=x3dom.caps.MOBILE?"attribute vec3 position;\nattribute vec2 texcoord;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float writeShadowIDs;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 from;\nvarying vec3 worldCoord;\nvarying vec3 idCoord;\nvoid main(void) {\n    gl_PointSize = 2.0;\n    if (writeShadowIDs > 0.0) {\n       float ID = (texcoord.y * 65536.0 + texcoord.x) + writeShadowIDs;\n       float h = floor(ID / 256.0);\n       idCoord.x = ID - (h * 256.0);\n       idCoord.z = floor(h / 256.0);\n       idCoord.y = h - (idCoord.z * 256.0);\n       idCoord = idCoord.zyx / 255.0;\n	 }\n    vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n    worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n}\n":"attribute vec3 position;\nattribute vec2 texcoord;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 from;\nvarying vec3 worldCoord;\nvarying vec3 idCoord;\nuniform float writeShadowIDs;\nuniform float imageGeometry;\nuniform vec3 IG_bboxMin;\nuniform vec3 IG_bboxMax;\nuniform float IG_coordTextureWidth;\nuniform float IG_coordTextureHeight;\nuniform float IG_indexTextureWidth;\nuniform float IG_indexTextureHeight;\nuniform sampler2D IG_indexTexture;\nuniform sampler2D IG_coordinateTexture;\nuniform vec2 IG_implicitMeshSize;\nvoid main(void) {\n   gl_PointSize = 2.0;\n   if (writeShadowIDs > 0.0) {\n       float ID = (texcoord.y * 65536.0 + texcoord.x) + writeShadowIDs;\n       float h = floor(ID / 256.0);\n       idCoord.x = ID - (h * 256.0);\n       idCoord.z = floor(h / 256.0);\n       idCoord.y = h - (idCoord.z * 256.0);\n       idCoord = idCoord.zyx / 255.0;\n	}\n	if (imageGeometry != 0.0) {\n		vec2 IG_texCoord;\n		if(imageGeometry == 1.0) {\n			vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n			IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n			vec2 IG_index = texture2D( IG_indexTexture, IG_texCoord ).rg;\n			IG_texCoord = IG_index * 0.996108948;\n		} else {\n			vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n			IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n		}\n		vec3 pos = texture2D( IG_coordinateTexture, IG_texCoord ).rgb;\n	 	pos = pos * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n    	worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n		gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n	} else {\n		vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n		worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n		gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n	}\n}\n";var c=a.createShader(a.VERTEX_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[Picking24Shader] VertexShader "+a.getShaderInfoLog(c)),c},x3dom.shader.Picking24Shader.prototype.generateFragmentShader=function(a){var b="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";b+="precision highp float;\n",b+="#else\n",b+=" precision mediump float;\n",b+="#endif\n\n",b+="uniform float writeShadowIDs;\nuniform float highBit;\nuniform float lowBit;\nuniform float sceneSize;\nvarying vec3 worldCoord;\nvarying vec3 idCoord;\nvoid main(void) {\n    vec4 col = vec4(0.0, 0.0, highBit, lowBit);\n    if (writeShadowIDs > 0.0) {\n       col.gba = idCoord;\n	 }\n    col.r = length(worldCoord) / sceneSize;\n    gl_FragColor = col;\n}\n";var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[Picking24Shader] FragmentShader "+a.getShaderInfoLog(c)),c},x3dom.shader.PickingIdShader=function(a){this.program=a.createProgram();var b=this.generateVertexShader(a),c=this.generateFragmentShader(a);return a.attachShader(this.program,b),a.attachShader(this.program,c),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.PickingIdShader.prototype.generateVertexShader=function(a){var b="attribute vec3 position;\nattribute vec2 texcoord;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float writeShadowIDs;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec2 idCoord;\nvoid main(void) {\n    if (writeShadowIDs > 0.0) {\n	    idCoord = vec2((texcoord.x + writeShadowIDs) / 256.0);\n       idCoord.x = floor(idCoord.x) / 255.0;\n       idCoord.y = fract(idCoord.y) * 1.00392156862745;\n	 }\n    vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n}\n",c=a.createShader(a.VERTEX_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingIdShader] VertexShader "+a.getShaderInfoLog(c)),c},x3dom.shader.PickingIdShader.prototype.generateFragmentShader=function(a){var b="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";b+=" precision highp float;\n",b+="#else\n",b+=" precision mediump float;\n",b+="#endif\n\n",b+="uniform float writeShadowIDs;\nuniform float highBit;\nuniform float lowBit;\nvarying vec2 idCoord;\nvoid main(void) {\n    vec4 col = vec4(highBit, lowBit, 0.0, 0.0);\n    if (writeShadowIDs > 0.0) {\n       col.ba = idCoord;\n	 }\n    gl_FragColor = col;\n}\n";var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingIdShader] FragmentShader "+a.getShaderInfoLog(c)),c},x3dom.shader.PickingColorShader=function(a){this.program=a.createProgram();var b=this.generateVertexShader(a),c=this.generateFragmentShader(a);return a.attachShader(this.program,b),a.attachShader(this.program,c),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.PickingColorShader.prototype.generateVertexShader=function(a){var b="attribute vec3 position;\nattribute vec3 color;\nvarying vec3 fragColor;\nuniform mat4 modelViewProjectionMatrix;\n\nvoid main(void) {\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n    gl_PointSize = 2.0;\n    fragColor = color;\n}\n",c=a.createShader(a.VERTEX_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingColorShader] VertexShader "+a.getShaderInfoLog(c)),c},x3dom.shader.PickingColorShader.prototype.generateFragmentShader=function(a){var b="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";b+="precision highp float;\n",b+="#else\n",b+=" precision mediump float;\n",b+="#endif\n\n",b+="uniform float lowBit;\nvarying vec3 fragColor;\n\nvoid main(void) {\n    gl_FragColor = vec4(fragColor, lowBit);\n}\n";var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingColorShader] FragmentShader "+a.getShaderInfoLog(c)),c},x3dom.shader.PickingTexcoordShader=function(a){this.program=a.createProgram();var b=this.generateVertexShader(a),c=this.generateFragmentShader(a);return a.attachShader(this.program,b),a.attachShader(this.program,c),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.PickingTexcoordShader.prototype.generateVertexShader=function(a){var b="attribute vec3 position;\nattribute vec2 texcoord;\nvarying vec3 fragColor;\nuniform mat4 modelViewProjectionMatrix;\nvoid main(void) {\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n    fragColor = vec3(abs(texcoord.x), abs(texcoord.y), 0.0);\n}\n",c=a.createShader(a.VERTEX_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingTexcoordShader] VertexShader "+a.getShaderInfoLog(c)),c},x3dom.shader.PickingTexcoordShader.prototype.generateFragmentShader=function(a){var b="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";b+="precision highp float;\n",b+="#else\n",b+=" precision mediump float;\n",b+="#endif\n\n",b+="uniform float lowBit;\nvarying vec3 fragColor;\n\nvoid main(void) {\n    gl_FragColor = vec4(fragColor, lowBit);\n}\n";var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingTexcoordShader] FragmentShader "+a.getShaderInfoLog(c)),c},x3dom.shader.FrontgroundTextureShader=function(a){this.program=a.createProgram();var b=this.generateVertexShader(a),c=this.generateFragmentShader(a);return a.attachShader(this.program,b),a.attachShader(this.program,c),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.FrontgroundTextureShader.prototype.generateVertexShader=function(a){var b="attribute vec3 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    fragTexCoord = texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n",c=a.createShader(a.VERTEX_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[FrontgroundTextureShader] VertexShader "+a.getShaderInfoLog(c)),c},x3dom.shader.FrontgroundTextureShader.prototype.generateFragmentShader=function(a){var b="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";b+="precision highp float;\n",b+="#else\n",b+=" precision mediump float;\n",b+="#endif\n\n",b+="uniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec4 col = texture2D(tex, fragTexCoord);\n    gl_FragColor = vec4(col.rgb, 1.0);\n}\n";var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[FrontgroundTextureShader] FragmentShader "+a.getShaderInfoLog(c)),c},x3dom.shader.BackgroundTextureShader=function(a){this.program=a.createProgram();var b=this.generateVertexShader(a),c=this.generateFragmentShader(a);return a.attachShader(this.program,b),a.attachShader(this.program,c),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.BackgroundTextureShader.prototype.generateVertexShader=function(a){var b="attribute vec3 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    fragTexCoord = texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n",c=a.createShader(a.VERTEX_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundTextureShader] VertexShader "+a.getShaderInfoLog(c)),c
},x3dom.shader.BackgroundTextureShader.prototype.generateFragmentShader=function(a){var b="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";b+="precision highp float;\n",b+="#else\n",b+=" precision mediump float;\n",b+="#endif\n\n",b+="uniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    gl_FragColor = texture2D(tex, fragTexCoord);\n}";var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundTextureShader] FragmentShader "+a.getShaderInfoLog(c)),c},x3dom.shader.BackgroundSkyTextureShader=function(a){this.program=a.createProgram();var b=this.generateVertexShader(a),c=this.generateFragmentShader(a);return a.attachShader(this.program,b),a.attachShader(this.program,c),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.BackgroundSkyTextureShader.prototype.generateVertexShader=function(a){var b="attribute vec3 position;\nattribute vec2 texcoord;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    fragTexCoord = texcoord;\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}\n",c=a.createShader(a.VERTEX_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundSkyTextureShader] VertexShader "+a.getShaderInfoLog(c)),c},x3dom.shader.BackgroundSkyTextureShader.prototype.generateFragmentShader=function(a){var b="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";b+="precision highp float;\n",b+="#else\n",b+=" precision mediump float;\n",b+="#endif\n\n",b+="uniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    gl_FragColor = texture2D(tex, fragTexCoord);\n}\n";var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundSkyTextureShader] FragmentShader "+a.getShaderInfoLog(c)),c},x3dom.shader.BackgroundCubeTextureShader=function(a){this.program=a.createProgram();var b=this.generateVertexShader(a),c=this.generateFragmentShader(a);return a.attachShader(this.program,b),a.attachShader(this.program,c),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.BackgroundCubeTextureShader.prototype.generateVertexShader=function(a){var b="attribute vec3 position;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec3 fragNormal;\n\nvoid main(void) {\n    fragNormal = normalize(position);\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}\n",c=a.createShader(a.VERTEX_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundCubeTextureShader] VertexShader "+a.getShaderInfoLog(c)),c},x3dom.shader.BackgroundCubeTextureShader.prototype.generateFragmentShader=function(a){var b="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";b+="precision highp float;\n",b+="#else\n",b+=" precision mediump float;\n",b+="#endif\n\n",b+="uniform samplerCube tex;\nvarying vec3 fragNormal;\n\nfloat magn(float val) {\n    return ((val >= 0.0) ? val : -1.0 * val);\n}\nvoid main(void) {\n    vec3 normal = -reflect(normalize(fragNormal), vec3(0.0,0.0,1.0));\n    if (magn(normal.y) >= magn(normal.x) && magn(normal.y) >= magn(normal.z))\n        normal.xz = -normal.xz;\n    gl_FragColor = textureCube(tex, normal);\n}\n";var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundCubeTextureShader] FragmentShader "+a.getShaderInfoLog(c)),c},x3dom.shader.ShadowShader=function(a){this.program=a.createProgram();var b=this.generateVertexShader(a),c=this.generateFragmentShader(a);return a.attachShader(this.program,b),a.attachShader(this.program,c),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.ShadowShader.prototype.generateVertexShader=function(a){var b="";x3dom.caps.MOBILE?b="attribute vec3 position;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec4 projCoords;\nvoid main(void) {\n	vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n	projCoords = modelViewProjectionMatrix * vec4(pos, 1.0);\n	gl_Position = projCoords;\n}\n":b+="attribute vec3 position;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec4 projCoords;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float imageGeometry;\nuniform vec3 IG_bboxMin;\nuniform vec3 IG_bboxMax;\nuniform float IG_coordTextureWidth;\nuniform float IG_coordTextureHeight;\nuniform float IG_indexTextureWidth;\nuniform float IG_indexTextureHeight;\nuniform sampler2D IG_indexTexture;\nuniform sampler2D IG_coordinateTexture;\nuniform vec2 IG_implicitMeshSize;\nuniform float popGeometry;\nuniform float PG_precisionLevel;\nuniform float PG_powPrecision;\nuniform vec3 PG_maxBBSize;\nuniform vec3 PG_bbMin;\nuniform vec3 PG_bbMaxModF;\nuniform vec3 PG_bboxShiftVec;\nvoid main(void) {\n	vec3 pos;\n	if (imageGeometry != 0.0) {\n		vec2 IG_texCoord;\n		if(imageGeometry == 1.0) {\n			vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n			IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n			vec2 IG_index = texture2D( IG_indexTexture, IG_texCoord ).rg;\n			IG_texCoord = IG_index * 0.996108948;\n		} else {\n			vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n			IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n		}\n		pos = texture2D( IG_coordinateTexture, IG_texCoord ).rgb;\n	 	pos = pos * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n	} else if (popGeometry != 0.0){\n		pos = position;\n		vec3 offsetVec = step(pos / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n		if (PG_precisionLevel <= 2.0) {\n   		pos = floor(pos / PG_powPrecision) * PG_powPrecision;\n   		pos /= (65536.0 - PG_powPrecision);\n		}\n		else {\n   		pos /= bgPrecisionMax;\n		}\n		pos = (pos + offsetVec + PG_bbMin) * PG_maxBBSize;\n	} else {\n		pos = bgCenter + bgSize * position / bgPrecisionMax;\n	}\n   projCoords = modelViewProjectionMatrix * vec4(pos, 1.0);\n   gl_Position = projCoords;\n}\n";var c=a.createShader(a.VERTEX_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[ShadowShader] VertexShader "+a.getShaderInfoLog(c)),c},x3dom.shader.ShadowShader.prototype.generateFragmentShader=function(a){var b="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";b+="precision highp float;\n",b+="#else\n",b+=" precision mediump float;\n",b+="#endif\n\n",b+="varying vec4 projCoords;\nuniform float offset;\nuniform bool cameraView;\n",(!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE)&&(b+=x3dom.shader.rgbaPacking()),b+="void main(void) {\n    vec3 proj = (projCoords.xyz / projCoords.w);\n",!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?b+="gl_FragColor = packDepth(proj.z);\n":(b+="	if (!cameraView){\n		proj.z = (proj.z + 1.0)*0.5;\n		proj.y = proj.z * proj.z;\n	}\n",b+="	gl_FragColor = vec4(proj, 1.0);\n"),b+="}\n";var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[ShadowShader] FragmentShader "+a.getShaderInfoLog(c)),c},x3dom.shader.ShadowRenderingShader=function(a,b){this.program=a.createProgram();var c=this.generateVertexShader(a),d=this.generateFragmentShader(a,b);return a.attachShader(this.program,c),a.attachShader(this.program,d),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.ShadowRenderingShader.prototype.generateVertexShader=function(a){var b="";b+="attribute vec2 position;\n",b+="varying vec2 vPosition;\n",b+="void main(void) {\n",b+=" vPosition = position;\n",b+=" gl_Position = vec4(position, -1.0, 1.0);\n",b+="}\n";var c=a.createShader(a.VERTEX_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[ShadowRendering] VertexShader "+a.getShaderInfoLog(c)),c},x3dom.shader.ShadowRenderingShader.prototype.generateFragmentShader=function(a,b){var c="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";c+="precision highp float;\n",c+="#else\n",c+=" precision mediump float;\n",c+="#endif\n\n",c+="uniform mat4 inverseViewProj;\n",c+="uniform mat4 inverseProj;\n",c+="varying vec2 vPosition;\n",c+="uniform sampler2D sceneMap;\n";for(var d=0;5>d;d++)c+="uniform float cascade"+d+"_Depth;\n";for(var e=0;e<b.length;e++){c+="uniform float light"+e+"_On;\n"+"uniform float light"+e+"_Type;\n"+"uniform vec3  light"+e+"_Location;\n"+"uniform vec3  light"+e+"_Direction;\n"+"uniform vec3  light"+e+"_Attenuation;\n"+"uniform float light"+e+"_Radius;\n"+"uniform float light"+e+"_BeamWidth;\n"+"uniform float light"+e+"_CutOffAngle;\n"+"uniform float light"+e+"_ShadowIntensity;\n"+"uniform float light"+e+"_ShadowOffset;\n"+"uniform mat4 light"+e+"_ViewMatrix;\n";for(var f=0;6>f;f++)c+="uniform mat4 light"+e+"_"+f+"_Matrix;\n",c+="uniform sampler2D light"+e+"_"+f+"_ShadowMap;\n";for(var f=0;5>f;f++)c+="uniform float light"+e+"_"+f+"_Split;\n"}(!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE)&&(c+=x3dom.shader.rgbaPacking()),c+=x3dom.shader.shadowRendering(),c+=x3dom.shader.gammaCorrectionDecl({}),c+="void main(void) {\n	float shadowValue = 1.0;\n	vec2 texCoordsSceneMap = (vPosition + 1.0)*0.5;\n	vec4 projCoords = texture2D(sceneMap, texCoordsSceneMap);\n	if (projCoords != vec4(1.0,1.0,1.0,0.0)){\n",(!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE)&&(c+="	projCoords.z = unpackDepth(projCoords);\n	projCoords.w = 1.0;\n"),c+="	projCoords = projCoords / projCoords.w;\n	projCoords.xy = vPosition;\n	vec4 eyeCoords = inverseProj*projCoords;\n	vec4 worldCoords = inverseViewProj*projCoords;\n	float lightInfluence = 0.0;\n";for(var e=0;e<b.length;e++)c+="	lightInfluence = getLightInfluence(light"+e+"_Type, light"+e+"_ShadowIntensity, light"+e+"_On, light"+e+"_Location, light"+e+"_Direction, "+"light"+e+"_CutOffAngle, light"+e+"_BeamWidth, light"+e+"_Attenuation, light"+e+"_Radius, eyeCoords.xyz/eyeCoords.w);\n"+"	if (lightInfluence != 0.0){\n"+"		vec4 shadowMapValues;\n"+"		float viewSampleDepth;\n",c+=x3dom.isa(b[e],x3dom.nodeTypes.PointLight)?"		getShadowValuesPointLight(shadowMapValues, viewSampleDepth, light"+e+"_Location, worldCoords, light"+e+"_ViewMatrix, "+"light"+e+"_0_Matrix,light"+e+"_1_Matrix,light"+e+"_2_Matrix,light"+e+"_3_Matrix,light"+e+"_4_Matrix,light"+e+"_5_Matrix,"+"light"+e+"_0_ShadowMap,light"+e+"_1_ShadowMap,light"+e+"_2_ShadowMap,light"+e+"_3_ShadowMap,"+"light"+e+"_4_ShadowMap,light"+e+"_5_ShadowMap);\n":"		getShadowValuesCascaded(shadowMapValues, viewSampleDepth, worldCoords, -eyeCoords.z/eyeCoords.w,light"+e+"_0_Matrix,light"+e+"_1_Matrix,light"+e+"_2_Matrix,light"+e+"_3_Matrix,light"+e+"_4_Matrix,light"+e+"_5_Matrix,"+"light"+e+"_0_ShadowMap,light"+e+"_1_ShadowMap,light"+e+"_2_ShadowMap,light"+e+"_3_ShadowMap,"+"light"+e+"_4_ShadowMap,light"+e+"_5_ShadowMap, light"+e+"_0_Split, light"+e+"_1_Split, light"+e+"_2_Split, light"+e+"_3_Split, \n"+"light"+e+"_4_Split);\n",c+=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?"	shadowValue *= clamp(ESM(shadowMapValues.z, viewSampleDepth, light"+e+"_ShadowOffset), "+"				1.0 - light"+e+"_ShadowIntensity*lightInfluence, 1.0);\n":" 	shadowValue *= clamp(VSM(shadowMapValues.zy, viewSampleDepth, light"+e+"_ShadowOffset), "+"				1.0 - light"+e+"_ShadowIntensity*lightInfluence, 1.0);\n",c+="	}\n";c+="}\n	gl_FragColor = "+x3dom.shader.encodeGamma({},"vec4(shadowValue, shadowValue, shadowValue, 1.0)")+";\n"+"}\n";var g=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(g,c),a.compileShader(g),a.getShaderParameter(g,a.COMPILE_STATUS)||x3dom.debug.logError("[ShadowRendering] FragmentShader "+a.getShaderInfoLog(g)),g},x3dom.shader.BlurShader=function(a){this.program=a.createProgram();var b=this.generateVertexShader(a),c=this.generateFragmentShader(a);return a.attachShader(this.program,b),a.attachShader(this.program,c),a.bindAttribLocation(this.program,0,"position"),a.linkProgram(this.program),this.program},x3dom.shader.BlurShader.prototype.generateVertexShader=function(a){var b="";b+="attribute vec2 position;\n",b+="varying vec2 vPosition;\n",b+="void main(void) {\n",b+=" vPosition = position;\n",b+=" gl_Position = vec4(position, -1.0, 1.0);\n",b+="}\n";var c=a.createShader(a.VERTEX_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[BlurShader] VertexShader "+a.getShaderInfoLog(c)),c},x3dom.shader.BlurShader.prototype.generateFragmentShader=function(a){var b="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";b+="precision highp float;\n",b+="#else\n",b+=" precision mediump float;\n",b+="#endif\n\n",b+="varying vec2 vPosition;\nuniform sampler2D texture;\nuniform bool horizontal;\nuniform float pixelSizeHor;\nuniform float pixelSizeVert;\nuniform int filterSize;\n",b+=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?x3dom.shader.rgbaPacking()+"void main(void) {\n"+"	vec2 texCoords = (vPosition + 1.0)*0.5;\n"+"	vec2 offset;\n"+"	if (horizontal) offset = vec2(pixelSizeHor, 0.0);\n"+"	else offset = vec2(0.0, pixelSizeVert);\n"+"	float depth = unpackDepth(texture2D(texture, texCoords));\n"+"	if (filterSize == 3){\n"+"		depth = depth * 0.3844;\n"+"		depth += 0.3078*unpackDepth(texture2D(texture, texCoords-offset));\n"+"		depth += 0.3078*unpackDepth(texture2D(texture, texCoords+offset));\n"+"	} else if (filterSize == 5){\n"+"		depth = depth * 0.2921;\n"+"		depth += 0.2339*unpackDepth(texture2D(texture, texCoords-offset));\n"+"		depth += 0.2339*unpackDepth(texture2D(texture, texCoords+offset));\n"+"		depth += 0.1201*unpackDepth(texture2D(texture, texCoords-2.0*offset));\n"+"		depth += 0.1201*unpackDepth(texture2D(texture, texCoords+2.0*offset));\n"+"	} else if (filterSize == 7){\n"+"		depth = depth * 0.2161;\n"+"		depth += 0.1907*unpackDepth(texture2D(texture, texCoords-offset));\n"+"		depth += 0.1907*unpackDepth(texture2D(texture, texCoords+offset));\n"+"		depth += 0.1311*unpackDepth(texture2D(texture, texCoords-2.0*offset));\n"+"		depth += 0.1311*unpackDepth(texture2D(texture, texCoords+2.0*offset));\n"+"		depth += 0.0702*unpackDepth(texture2D(texture, texCoords-3.0*offset));\n"+"		depth += 0.0702*unpackDepth(texture2D(texture, texCoords+3.0*offset));\n"+"	}\n"+"	gl_FragColor = packDepth(depth);\n"+"}\n":"void main(void) {\n	vec2 texCoords = (vPosition + 1.0)*0.5;\n	vec2 offset;\n	if (horizontal) offset = vec2(pixelSizeHor, 0.0);\n	else offset = vec2(0.0, pixelSizeVert);\n	vec4 color = texture2D(texture, texCoords);\n	if (filterSize == 3){\n		color = color * 0.3844;\n		color += 0.3078*texture2D(texture, texCoords-offset);\n		color += 0.3078*texture2D(texture, texCoords+offset);\n	} else if (filterSize == 5){\n		color = color * 0.2921;\n		color += 0.2339*texture2D(texture, texCoords-offset);\n		color += 0.2339*texture2D(texture, texCoords+offset);\n		color += 0.1201*texture2D(texture, texCoords-2.0*offset);\n		color += 0.1201*texture2D(texture, texCoords+2.0*offset);\n	} else if (filterSize == 7){\n		color = color * 0.2161;\n		color += 0.1907*texture2D(texture, texCoords-offset);\n		color += 0.1907*texture2D(texture, texCoords+offset);\n		color += 0.1311*texture2D(texture, texCoords-2.0*offset);\n		color += 0.1311*texture2D(texture, texCoords+2.0*offset);\n		color += 0.0702*texture2D(texture, texCoords-3.0*offset);\n		color += 0.0702*texture2D(texture, texCoords+3.0*offset);\n	}\n	gl_FragColor = color;\n}\n";var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,b),a.compileShader(c),a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[BlurShader] FragmentShader "+a.getShaderInfoLog(c)),c},x3dom.gfx_webgl=function(){function a(a,b,c,d){this.ctx3d=a,this.canvas=b,this.name=c,this.x3dElem=d,this.IG_PositionBuffer=null,this.cache=new x3dom.Cache,this.stateManager=new x3dom.StateManager(a),this.activeShader=null}function b(b,c,d,e,f){var g=["webgl","experimental-webgl","moz-webgl","webkit-3d"];e&&(g=["experimental-webgl2"].concat(g));for(var h=null,i={alpha:!0,depth:!0,stencil:!0,antialias:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0},j=0;j<g.length;j++)try{if(h=b.getContext(g[j],i)){var k=new a(h,b,"webgl",f);try{x3dom.caps.VENDOR=h.getParameter(h.VENDOR),x3dom.caps.VERSION=h.getParameter(h.VERSION),x3dom.caps.RENDERER=h.getParameter(h.RENDERER),x3dom.caps.SHADING_LANGUAGE_VERSION=h.getParameter(h.SHADING_LANGUAGE_VERSION),x3dom.caps.RED_BITS=h.getParameter(h.RED_BITS),x3dom.caps.GREEN_BITS=h.getParameter(h.GREEN_BITS),x3dom.caps.BLUE_BITS=h.getParameter(h.BLUE_BITS),x3dom.caps.ALPHA_BITS=h.getParameter(h.ALPHA_BITS),x3dom.caps.DEPTH_BITS=h.getParameter(h.DEPTH_BITS),x3dom.caps.MAX_VERTEX_ATTRIBS=h.getParameter(h.MAX_VERTEX_ATTRIBS),x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS=h.getParameter(h.MAX_VERTEX_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_VARYING_VECTORS=h.getParameter(h.MAX_VARYING_VECTORS),x3dom.caps.MAX_VERTEX_UNIFORM_VECTORS=h.getParameter(h.MAX_VERTEX_UNIFORM_VECTORS),x3dom.caps.MAX_COMBINED_TEXTURE_IMAGE_UNITS=h.getParameter(h.MAX_COMBINED_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_TEXTURE_SIZE=h.getParameter(h.MAX_TEXTURE_SIZE),x3dom.caps.MAX_TEXTURE_IMAGE_UNITS=h.getParameter(h.MAX_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_CUBE_MAP_TEXTURE_SIZE=h.getParameter(h.MAX_CUBE_MAP_TEXTURE_SIZE),x3dom.caps.COMPRESSED_TEXTURE_FORMATS=h.getParameter(h.COMPRESSED_TEXTURE_FORMATS),x3dom.caps.MAX_RENDERBUFFER_SIZE=h.getParameter(h.MAX_RENDERBUFFER_SIZE),x3dom.caps.MAX_VIEWPORT_DIMS=h.getParameter(h.MAX_VIEWPORT_DIMS),x3dom.caps.ALIASED_LINE_WIDTH_RANGE=h.getParameter(h.ALIASED_LINE_WIDTH_RANGE),x3dom.caps.ALIASED_POINT_SIZE_RANGE=h.getParameter(h.ALIASED_POINT_SIZE_RANGE),x3dom.caps.SAMPLES=h.getParameter(h.SAMPLES),x3dom.caps.INDEX_UINT=h.getExtension("OES_element_index_uint"),x3dom.caps.FP_TEXTURES=h.getExtension("OES_texture_float"),x3dom.caps.FPL_TEXTURES=h.getExtension("OES_texture_float_linear"),x3dom.caps.STD_DERIVATIVES=h.getExtension("OES_standard_derivatives"),x3dom.caps.DRAW_BUFFERS=h.getExtension("WEBGL_draw_buffers"),x3dom.caps.EXTENSIONS=h.getSupportedExtensions();var l=x3dom.caps.EXTENSIONS.toString().replace(/,/g,", ");x3dom.debug.logInfo(g[j]+" context found\nVendor: "+x3dom.caps.VENDOR+", Renderer: "+x3dom.caps.RENDERER+", "+"Version: "+x3dom.caps.VERSION+", "+"ShadingLangV.: "+x3dom.caps.SHADING_LANGUAGE_VERSION+", MSAA samples: "+x3dom.caps.SAMPLES+"\nExtensions: "+l),x3dom.caps.INDEX_UINT&&(x3dom.Utils.maxIndexableCoords=4294967295),x3dom.caps.MOBILE=function(a){return/android.+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|e\-|e\/|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(di|rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|xda(\-|2|g)|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))}(navigator.userAgent||navigator.vendor||window.opera),(x3dom.caps.RENDERER.indexOf("PowerVR")>=0||navigator.appVersion.indexOf("Mobile")>-1||x3dom.caps.MAX_VARYING_VECTORS<=8||x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS<2)&&(x3dom.caps.MOBILE=!0),x3dom.caps.MOBILE?c?(x3dom.caps.MOBILE=!1,x3dom.debug.logWarning("Detected mobile graphics card! But being forced to desktop shaders which might not work!")):x3dom.debug.logWarning("Detected mobile graphics card! Using low quality shaders without ImageGeometry support!"):d&&(x3dom.caps.MOBILE=!0,x3dom.debug.logWarning("Detected desktop graphics card! But being forced to mobile shaders with lower quality!"))}catch(m){x3dom.debug.logWarning("Your browser probably supports an older WebGL version. Please try the old mobile runtime instead:\nhttp://www.x3dom.org/x3dom/src_mobile/x3dom.js"),k=null}return k}}catch(n){x3dom.debug.logWarning(n)}return null}return a.prototype.getName=function(){return this.name},a.prototype.setupShape=function(a,b,c){var d,e,f,g,h,i,j,k=0,l=b.shape,m=l._cf.geometry.node;if(void 0!==l._webgl){var n=!1;if(l._dirty.colors===!0&&void 0===l._webgl.shader.color&&m._mesh._colors[0].length&&(n=!0),n&&l._cleanupGLObjects&&l._cleanupGLObjects(!0,!1),l._dirty.texture===!0){if(l._webgl.texture.length!=l.getTextures().length){for(f=0;f<l._webgl.texture.length;++f)l._webgl.texture.pop();for(e=l.getTextures(),f=0;f<e.length;++f)l._webgl.texture.push(new x3dom.Texture(a,l._nameSpace.doc,this.cache,e[f]));l._dirty.shader=!0,void 0===l._webgl.shader.texcoord&&(l._dirty.texcoords=!0)}else for(e=l.getTextures(),f=0;f<e.length;++f)e[f]===l._webgl.texture[f].node?l._webgl.texture[f].update():(l._webgl.texture[f].texture=null,l._webgl.texture[f].node=e[f],l._webgl.texture[f].update());l._dirty.texture=!1}if(l._webgl.shader=this.cache.getShaderByProperties(a,l,l.getShaderProperties(c)),!n&&0==l._webgl.binaryGeometry)for(k=0;k<l._webgl.positions.length;k++)d=5*k,(1==l._dirty.positions||1==l._dirty.indexes)&&(void 0!==l._webgl.shader.position&&(l._webgl.indexes[k]=m._mesh._indices[k],a.deleteBuffer(l._webgl.buffers[d]),i=a.createBuffer(),l._webgl.buffers[d]=i,x3dom.caps.INDEX_UINT&&m._mesh._positions[0].length/3>65535?(j=new Uint32Array(l._webgl.indexes[k]),l._webgl.indexType=a.UNSIGNED_INT):(j=new Uint16Array(l._webgl.indexes[k]),l._webgl.indexType=a.UNSIGNED_SHORT),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,i),a.bufferData(a.ELEMENT_ARRAY_BUFFER,j,a.STATIC_DRAW),j=null,l._webgl.positions[k]=m._mesh._positions[k],a.deleteBuffer(l._webgl.buffers[d+1]),h=a.createBuffer(),l._webgl.buffers[d+1]=h,a.bindBuffer(a.ARRAY_BUFFER,h),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,l._webgl.buffers[d]),g=new Float32Array(l._webgl.positions[k]),a.bufferData(a.ARRAY_BUFFER,g,a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,h),a.vertexAttribPointer(l._webgl.shader.position,m._mesh._numPosComponents,l._webgl.coordType,!1,l._coordStrideOffset[0],l._coordStrideOffset[1]),g=null),l._dirty.positions=!1,l._dirty.indexes=!1),1==l._dirty.colors&&(void 0!==l._webgl.shader.color&&(l._webgl.colors[k]=m._mesh._colors[k],a.deleteBuffer(l._webgl.buffers[d+4]),v=a.createBuffer(),l._webgl.buffers[d+4]=v,w=new Float32Array(l._webgl.colors[k]),a.bindBuffer(a.ARRAY_BUFFER,v),a.bufferData(a.ARRAY_BUFFER,w,a.STATIC_DRAW),a.vertexAttribPointer(l._webgl.shader.color,m._mesh._numColComponents,l._webgl.colorType,!1,l._colorStrideOffset[0],l._colorStrideOffset[1]),w=null),l._dirty.colors=!1),1==l._dirty.normals&&(void 0!==l._webgl.shader.normal&&(l._webgl.normals[k]=m._mesh._normals[k],a.deleteBuffer(l._webgl.buffers[d+2]),r=a.createBuffer(),l._webgl.buffers[d+2]=r,s=new Float32Array(l._webgl.normals[k]),a.bindBuffer(a.ARRAY_BUFFER,r),a.bufferData(a.ARRAY_BUFFER,s,a.STATIC_DRAW),a.vertexAttribPointer(l._webgl.shader.normal,m._mesh._numNormComponents,l._webgl.normalType,!1,l._normalStrideOffset[0],l._normalStrideOffset[1]),s=null),l._dirty.normals=!1),1==l._dirty.texcoords&&(void 0!==l._webgl.shader.texcoord&&(l._webgl.texcoords[k]=m._mesh._texCoords[k],a.deleteBuffer(l._webgl.buffers[d+3]),texCoordBuffer=a.createBuffer(),l._webgl.buffers[d+3]=texCoordBuffer,u=new Float32Array(l._webgl.texcoords[k]),a.bindBuffer(a.ARRAY_BUFFER,texCoordBuffer),a.bufferData(a.ARRAY_BUFFER,u,a.STATIC_DRAW),a.vertexAttribPointer(l._webgl.shader.texCoord,m._mesh._numTexComponents,l._webgl.texCoordType,!1,l._texCoordStrideOffset[0],l._texCoordStrideOffset[1]),u=null),l._dirty.texcoords=!1);if(0!=l._webgl.imageGeometry){for(f=0;f<l._webgl.texture.length;++f)l._webgl.texture[f].updateTexture();m.unsetGeoDirty(),l.unsetGeoDirty()}if(!n)return}else if(!(x3dom.isa(m,x3dom.nodeTypes.Text)||x3dom.isa(m,x3dom.nodeTypes.BinaryGeometry)||x3dom.isa(m,x3dom.nodeTypes.PopGeometry)||x3dom.isa(m,x3dom.nodeTypes.BitLODGeometry))&&(!m||m._mesh._positions[0].length<1))return x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS<2&&x3dom.isa(m,x3dom.nodeTypes.ImageGeometry)?x3dom.debug.logError("Can't render ImageGeometry nodes with only "+x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS+" vertex texture units. Please upgrade your GPU!"):x3dom.debug.logError("NO VALID MESH OR NO VERTEX POSITIONS SET!"),void 0;for(l.unsetDirty(),l._cleanupGLObjects||(l._cleanupGLObjects=function(b,c){if(this._webgl&&(arguments.length>0&&b||0==this._parentNodes.length)){for(var d=this._webgl.shader,e=0;e<this._webgl.positions.length;e++){var f=5*e;void 0!==d.position&&(a.deleteBuffer(this._webgl.buffers[f+1]),a.deleteBuffer(this._webgl.buffers[f])),void 0!==d.normal&&a.deleteBuffer(this._webgl.buffers[f+2]),void 0!==d.texcoord&&a.deleteBuffer(this._webgl.buffers[f+3]),void 0!==d.color&&a.deleteBuffer(this._webgl.buffers[f+4])}for(var g=0;g<this._webgl.dynamicFields.length;g++){var h=this._webgl.dynamicFields[g];void 0!==d[h.name]&&a.deleteBuffer(h.buf)}void 0===c&&(c=!0),c&&(delete this._webgl,x3dom.BinaryContainerLoader.outOfMemory=!1)}}),l._webgl={positions:m._mesh._positions,normals:m._mesh._normals,texcoords:m._mesh._texCoords,colors:m._mesh._colors,indexes:m._mesh._indices,indexType:a.UNSIGNED_SHORT,coordType:a.FLOAT,normalType:a.FLOAT,texCoordType:a.FLOAT,colorType:a.FLOAT,texture:[],dirtyLighting:x3dom.Utils.checkDirtyLighting(c),imageGeometry:0,binaryGeometry:0,popGeometry:0,bitLODGeometry:0},e=l.getTextures(),f=0;f<e.length;++f)l._webgl.texture.push(new x3dom.Texture(a,l._nameSpace.doc,this.cache,e[f]));l._webgl.shader=this.cache.getShaderByProperties(a,l,l.getShaderProperties(c));var o=l._webgl.shader,p=0;if(l._webgl.buffers=[],l._webgl.dynamicFields=[],x3dom.isa(m,x3dom.nodeTypes.X3DBinaryContainerGeometryNode)){l._webgl.primType=[];for(var q=0;q<m._vf.primType.length;++q)l._webgl.primType.push(x3dom.Utils.primTypeDic(a,m._vf.primType[q]))}else l._webgl.primType=x3dom.Utils.primTypeDic(a,m._mesh._primType);if(x3dom.isa(m,x3dom.nodeTypes.BinaryGeometry))x3dom.BinaryContainerLoader.setupBinGeo(l,o,a,c,this);else if(x3dom.isa(m,x3dom.nodeTypes.PopGeometry))x3dom.BinaryContainerLoader.setupPopGeo(l,o,a,c,this);else if(x3dom.isa(m,x3dom.nodeTypes.BitLODGeometry))x3dom.BinaryContainerLoader.setupBitLODGeo(l,o,a,c,this);else if(x3dom.isa(m,x3dom.nodeTypes.ImageGeometry))x3dom.BinaryContainerLoader.setupImgGeo(l,o,a,c,this);else{for(k=0;k<l._webgl.positions.length;k++){if(d=5*k,void 0!==o.position&&(i=a.createBuffer(),l._webgl.buffers[d]=i,x3dom.caps.INDEX_UINT&&l._webgl.positions[0].length/3>65535?(j=new Uint32Array(l._webgl.indexes[k]),l._webgl.indexType=a.UNSIGNED_INT):(j=new Uint16Array(l._webgl.indexes[k]),l._webgl.indexType=a.UNSIGNED_SHORT),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,i),a.bufferData(a.ELEMENT_ARRAY_BUFFER,j,a.STATIC_DRAW),j=null,h=a.createBuffer(),l._webgl.buffers[d+1]=h,a.bindBuffer(a.ARRAY_BUFFER,h),g=new Float32Array(l._webgl.positions[k]),a.bufferData(a.ARRAY_BUFFER,g,a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,h),a.vertexAttribPointer(o.position,m._mesh._numPosComponents,l._webgl.coordType,!1,l._coordStrideOffset[0],l._coordStrideOffset[1]),a.enableVertexAttribArray(o.position),g=null),void 0!==o.normal||l._webgl.normals[k]){var r=a.createBuffer();l._webgl.buffers[d+2]=r;var s=new Float32Array(l._webgl.normals[k]);a.bindBuffer(a.ARRAY_BUFFER,r),a.bufferData(a.ARRAY_BUFFER,s,a.STATIC_DRAW),a.vertexAttribPointer(o.normal,m._mesh._numNormComponents,l._webgl.normalType,!1,l._normalStrideOffset[0],l._normalStrideOffset[1]),a.enableVertexAttribArray(o.normal),s=null}if(void 0!==o.texcoord){var t=a.createBuffer();l._webgl.buffers[d+3]=t;var u=new Float32Array(l._webgl.texcoords[k]);a.bindBuffer(a.ARRAY_BUFFER,t),a.bufferData(a.ARRAY_BUFFER,u,a.STATIC_DRAW),a.vertexAttribPointer(o.texcoord,m._mesh._numTexComponents,l._webgl.texCoordType,!1,l._texCoordStrideOffset[0],l._texCoordStrideOffset[1]),a.enableVertexAttribArray(o.texcoord),u=null}if(void 0!==o.color){var v=a.createBuffer();l._webgl.buffers[d+4]=v;var w=new Float32Array(l._webgl.colors[k]);a.bindBuffer(a.ARRAY_BUFFER,v),a.bufferData(a.ARRAY_BUFFER,w,a.STATIC_DRAW),a.vertexAttribPointer(o.color,m._mesh._numColComponents,l._webgl.colorType,!1,l._colorStrideOffset[0],l._colorStrideOffset[1]),a.enableVertexAttribArray(o.color),w=null}}for(var x in m._mesh._dynamicFields)if(m._mesh._dynamicFields.hasOwnProperty(x)){var y=m._mesh._dynamicFields[x];if(l._webgl.dynamicFields[p]={buf:{},name:x,numComponents:y.numComponents},void 0!==o[x]){var z=a.createBuffer();l._webgl.dynamicFields[p++].buf=z;var A=new Float32Array(y.value);a.bindBuffer(a.ARRAY_BUFFER,z),a.bufferData(a.ARRAY_BUFFER,A,a.STATIC_DRAW),a.vertexAttribPointer(o[x],y.numComponents,a.FLOAT,!1,0,0),A=null}}}},a.prototype.setupScene=function(a,b){var c=null,d=null,e=this;if(void 0!==b._webgl){if(!b._dirty)return;void 0!==b._webgl.texture&&b._webgl.texture&&a.deleteTexture(b._webgl.texture),b._cleanupGLObjects&&b._cleanupGLObjects(),b._webgl={}}b._dirty=!1;var f=b.getTexUrl(),g=0,h=1,i=1;if(f.length>0&&f[0].length>0)f.length>=6&&f[1].length>0&&f[2].length>0&&f[3].length>0&&f[4].length>0&&f[5].length>0?(c=new x3dom.nodeTypes.Sphere,b._webgl={positions:c._mesh._positions[0],indexes:c._mesh._indices[0],buffers:[{},{}]},b._webgl.primType=a.TRIANGLES,b._webgl.shader=this.cache.getShader(a,x3dom.shader.BACKGROUND_CUBETEXTURE),b._webgl.texture=x3dom.Utils.createTextureCube(a,b._nameSpace.doc,f,!0,b._vf.withCredentials,!0)):(b._webgl={positions:[-h,-i,0,-h,i,0,h,-i,0,h,i,0],indexes:[0,1,2,3],buffers:[{},{}]},f=b._nameSpace.getURL(f[0]),b._webgl.texture=x3dom.Utils.createTexture2D(a,b._nameSpace.doc,f,!0,b._vf.withCredentials,!0),b._webgl.primType=a.TRIANGLE_STRIP,b._webgl.shader=this.cache.getShader(a,x3dom.shader.BACKGROUND_TEXTURE));else if(b.getSkyColor().length>1||b.getGroundColor().length){c=new x3dom.nodeTypes.Sphere,d=a.createTexture(),b._webgl={positions:c._mesh._positions[0],texcoords:c._mesh._texCoords[0],indexes:c._mesh._indices[0],buffers:[{},{},{}],texture:d,primType:a.TRIANGLES};var j=x3dom.Utils.nextHighestPowerOfTwo(b.getSkyColor().length+b.getGroundColor().length+2);j=512>j?512:j;var k=b._vf.groundAngle.length,l=[],m=[],n=[],o=[0];for(g=0;g<b._vf.skyColor.length;g++)n[g]=b._vf.skyColor[g];for(g=0;g<b._vf.skyAngle.length;g++)o[g+1]=b._vf.skyAngle[g];if(k>0||1==b._vf.groundColor.length){for(o[o.length-1]<Math.PI/2&&(o[o.length]=Math.PI/2-x3dom.fields.Eps,n[n.length]=n[n.length-1]),g=k-1;g>=0;g--)g==k-1&&Math.PI-b._vf.groundAngle[g]<=Math.PI/2&&(o[o.length]=Math.PI/2,n[n.length]=b._vf.groundColor[b._vf.groundColor.length-1]),o[o.length]=Math.PI-b._vf.groundAngle[g],n[n.length]=b._vf.groundColor[g+1];
0==k&&1==b._vf.groundColor.length&&(o[o.length]=Math.PI/2,n[n.length]=b._vf.groundColor[0]),o[o.length]=Math.PI,n[n.length]=b._vf.groundColor[0]}else o[o.length-1]<Math.PI&&(o[o.length]=Math.PI,n[n.length]=n[n.length-1]);for(g=0;g<o.length;g++)o[g]/=Math.PI;x3dom.debug.assert(o.length==n.length);var p=new x3dom.nodeTypes.ColorInterpolator;for(p._vf.key=new x3dom.fields.MFFloat(o),p._vf.keyValue=new x3dom.fields.MFColor(n),g=0;j>g;g++)p._vf.set_fraction=g/(j-1),p.fieldChanged("set_fraction"),l[g]=p._vf.value_changed;l.reverse();var q=Math.floor(255*(1-b.getTransparency()));for(g=0;g<l.length;g++)m.push(Math.floor(255*l[g].r),Math.floor(255*l[g].g),Math.floor(255*l[g].b),q);var r=new Uint8Array(m),s=a.RGBA;j=r.length/4,a.bindTexture(a.TEXTURE_2D,d),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.pixelStorei(a.UNPACK_ALIGNMENT,1),a.texImage2D(a.TEXTURE_2D,0,s,1,j,0,s,a.UNSIGNED_BYTE,r),a.bindTexture(a.TEXTURE_2D,null),b._webgl.shader=this.cache.getShader(a,x3dom.shader.BACKGROUND_SKYTEXTURE)}else b._webgl={};if(b._webgl.shader){var t=b._webgl.shader,u=a.createBuffer();b._webgl.buffers[1]=u,a.bindBuffer(a.ARRAY_BUFFER,u);var v=new Float32Array(b._webgl.positions);a.bufferData(a.ARRAY_BUFFER,v,a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,u),a.vertexAttribPointer(t.position,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(t.position);var w=a.createBuffer();b._webgl.buffers[0]=w;var x=new Uint16Array(b._webgl.indexes);if(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,w),a.bufferData(a.ELEMENT_ARRAY_BUFFER,x,a.STATIC_DRAW),v=null,x=null,void 0!==t.texcoord){var y=a.createBuffer();b._webgl.buffers[2]=y;var z=new Float32Array(b._webgl.texcoords);a.bindBuffer(a.ARRAY_BUFFER,y),a.bufferData(a.ARRAY_BUFFER,z,a.STATIC_DRAW),a.vertexAttribPointer(t.texcoord,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(t.texcoord),z=null}b._cleanupGLObjects=function(){var b=this._webgl.shader;void 0!==b.position&&(a.deleteBuffer(this._webgl.buffers[0]),a.deleteBuffer(this._webgl.buffers[1])),void 0!==b.texcoord&&a.deleteBuffer(this._webgl.buffers[2])}}b._webgl.render=function(a,c,d){var f=b._webgl.shader,g=1-b.getTransparency(),h=null,i=d._22,j=d._23,k=c.e3();if(void 0!==f&&null!==f&&void 0!==f.texcoord&&null!==f.texcoord&&void 0!==b._webgl.texture&&null!==b._webgl.texture)a.clearColor(0,0,0,g),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT),e.stateManager.frontFace(a.CCW),e.stateManager.disable(a.CULL_FACE),e.stateManager.disable(a.DEPTH_TEST),e.stateManager.disable(a.BLEND),e.stateManager.useProgram(f),f.tex||(f.tex=0),d._22=100001/99999,d._23=2e5/99999,c._03=0,c._13=0,c._23=0,h=d.mult(c),f.modelViewProjectionMatrix=h.toGL(),c._03=k.x,c._13=k.y,c._23=k.z,d._22=i,d._23=j,a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,b._webgl.texture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b._webgl.buffers[0]),a.bindBuffer(a.ARRAY_BUFFER,b._webgl.buffers[1]),a.vertexAttribPointer(f.position,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(f.position),a.bindBuffer(a.ARRAY_BUFFER,b._webgl.buffers[2]),a.vertexAttribPointer(f.texcoord,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(f.texcoord),a.drawElements(b._webgl.primType,b._webgl.indexes.length,a.UNSIGNED_SHORT,0),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),a.disableVertexAttribArray(f.position),a.disableVertexAttribArray(f.texcoord),a.clear(a.DEPTH_BUFFER_BIT);else if(!f||!b._webgl.texture||void 0!==b._webgl.texture.textureCubeReady&&b._webgl.texture.textureCubeReady!==!0){var l=b.getSkyColor().toGL();a.clearColor(l[0],l[1],l[2],g),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT)}else a.clearColor(0,0,0,g),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT),e.stateManager.frontFace(a.CCW),e.stateManager.disable(a.CULL_FACE),e.stateManager.disable(a.DEPTH_TEST),e.stateManager.disable(a.BLEND),e.stateManager.useProgram(f),f.tex||(f.tex=0),b._webgl.texture.textureCubeReady?(d._22=100001/99999,d._23=2e5/99999,c._03=0,c._13=0,c._23=0,h=d.mult(c),f.modelViewProjectionMatrix=h.toGL(),c._03=k.x,c._13=k.y,c._23=k.z,d._22=i,d._23=j,a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_CUBE_MAP,b._webgl.texture),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)):(a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,b._webgl.texture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b._webgl.buffers[0]),a.bindBuffer(a.ARRAY_BUFFER,b._webgl.buffers[1]),a.vertexAttribPointer(f.position,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(f.position),a.drawElements(b._webgl.primType,b._webgl.indexes.length,a.UNSIGNED_SHORT,0),a.disableVertexAttribArray(f.position),a.activeTexture(a.TEXTURE0),b._webgl.texture.textureCubeReady?a.bindTexture(a.TEXTURE_CUBE_MAP,null):a.bindTexture(a.TEXTURE_2D,null),a.clear(a.DEPTH_BUFFER_BIT)}},a.prototype.setupFgnds=function(a,b){if(void 0===b._fgnd){var c=this,d=1,e=1;b._fgnd={},b._fgnd._webgl={positions:[-d,-e,0,-d,e,0,d,-e,0,d,e,0],indexes:[0,1,2,3],buffers:[{},{}]},b._fgnd._webgl.primType=a.TRIANGLE_STRIP,b._fgnd._webgl.shader=this.cache.getShader(a,x3dom.shader.FRONTGROUND_TEXTURE);var f=b._fgnd._webgl.shader,g=a.createBuffer();b._fgnd._webgl.buffers[1]=g,a.bindBuffer(a.ARRAY_BUFFER,g);var h=new Float32Array(b._fgnd._webgl.positions);a.bufferData(a.ARRAY_BUFFER,h,a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,g),a.vertexAttribPointer(f.position,3,a.FLOAT,!1,0,0);var i=a.createBuffer();b._fgnd._webgl.buffers[0]=i;var j=new Uint16Array(b._fgnd._webgl.indexes);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,i),a.bufferData(a.ELEMENT_ARRAY_BUFFER,j,a.STATIC_DRAW),h=null,j=null,b._fgnd._webgl.render=function(a,d){b._fgnd._webgl.texture=d,c.stateManager.frontFace(a.CCW),c.stateManager.disable(a.CULL_FACE),c.stateManager.disable(a.DEPTH_TEST),c.stateManager.useProgram(f),f.tex||(f.tex=0),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,b._fgnd._webgl.texture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b._fgnd._webgl.buffers[0]),a.bindBuffer(a.ARRAY_BUFFER,b._fgnd._webgl.buffers[1]),a.vertexAttribPointer(f.position,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(f.position),a.drawElements(b._fgnd._webgl.primType,b._fgnd._webgl.indexes.length,a.UNSIGNED_SHORT,0),a.disableVertexAttribArray(f.position),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null)}}},a.prototype.renderShadowPass=function(a,b,c,d,e,f,g){var h=b._scene,i=h._webgl.shadowShader;this.stateManager.bindFramebuffer(a.FRAMEBUFFER,e.fbo),this.stateManager.viewport(0,0,e.width,e.height),this.stateManager.useProgram(i),i.cameraView=g,i.offset=f,i.PG_precisionLevel=1,i.PG_powPrecision=1,i.PG_maxBBSize=[0,0,0],i.PG_bbMin=[0,0,0],i.PG_bbMaxModF=[0,0,0],i.PG_bboxShiftVec=[0,0,0],a.clearColor(1,1,1,0),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),this.stateManager.depthFunc(a.LEQUAL),this.stateManager.enable(a.DEPTH_TEST),this.stateManager.enable(a.CULL_FACE),this.stateManager.disable(a.BLEND);var j,k=x3dom.fields.SFVec3f.NullVector.toGL(),l=x3dom.fields.SFVec3f.OneVector.toGL(),m=h.getEnvironment(),n=m._vf.shadowExcludeTransparentObjects,o=h.drawableCollection.length;for(j=0;o>j;j++){var p=h.drawableCollection.get(j),q=p.transform,r=p.shape,s=r._webgl;if(s&&(!n||"transparent"!=p.sortType)){var t=r._cf.geometry.node,u=t._mesh;if(i.modelViewProjectionMatrix=c.mult(q).toGL(),i.imageGeometry=s.imageGeometry,i.popGeometry=s.popGeometry,s.coordType!=a.FLOAT?(i.bgCenter=s.popGeometry||!s.bitLODGeometry&&!x3dom.Utils.isUnsignedType(t._vf.coordType)?t._vf.position.toGL():t.getMin().toGL(),i.bgSize=t._vf.size.toGL(),i.bgPrecisionMax=t.getPrecisionMax("coordType")):(i.bgCenter=k,i.bgSize=l,i.bgPrecisionMax=1),s.colorType!=a.FLOAT&&(i.bgPrecisionColMax=t.getPrecisionMax("colorType")),s.texCoordType!=a.FLOAT&&(i.bgPrecisionTexMax=t.getPrecisionMax("texCoordType")),0!=s.imageGeometry&&!x3dom.caps.MOBILE){i.IG_bboxMin=t.getMin().toGL(),i.IG_bboxMax=t.getMax().toGL(),i.IG_implicitMeshSize=t._vf.implicitMeshSize.toGL();var v=x3dom.Utils.findTextureByName(s.texture,"IG_coords0");if(v&&(i.IG_coordTextureWidth=v.texture.width,i.IG_coordTextureHeight=v.texture.height),1==s.imageGeometry){var w=x3dom.Utils.findTextureByName(s.texture,"IG_index");w&&(i.IG_indexTextureWidth=w.texture.width,i.IG_indexTextureHeight=w.texture.height),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,w.texture),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,v.texture)}else a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,v.texture);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);var x=0;t.getIndexTexture()&&(i.IG_indexTexture||(i.IG_indexTexture=x++)),t.getCoordinateTexture(0)&&(i.IG_coordinateTexture||(i.IG_coordinateTexture=x++))}if(r.isSolid()?(this.stateManager.enable(a.CULL_FACE),r.isCCW()?this.stateManager.frontFace(a.CCW):this.stateManager.frontFace(a.CW)):this.stateManager.disable(a.CULL_FACE),s.popGeometry){var y=d.mult(q);this.updatePopState(p,t,i,s,h,y,b,this.x3dElem.runtime.fps)}for(var z=0,A=s.positions.length;A>z;z++){var B,C,D,E=5*z;if(void 0!==i.position&&s.buffers[E+1]&&s.indexes[z]){if(s.buffers[E]&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,s.buffers[E]),a.bindBuffer(a.ARRAY_BUFFER,s.buffers[E+1]),a.vertexAttribPointer(i.position,u._numPosComponents,s.coordType,!1,r._coordStrideOffset[0],r._coordStrideOffset[1]),a.enableVertexAttribArray(i.position),s.binaryGeometry>0||s.popGeometry>0||s.bitLODGeometry>0)for(B=0,D=0,C=t._vf.vertexCount.length;C>B;B++)a.drawElements(s.primType[B],t._vf.vertexCount[B],s.indexType,x3dom.Utils.getByteAwareOffset(D,s.indexType,a)),D+=t._vf.vertexCount[B];else if(s.binaryGeometry<0||s.popGeometry<0||s.bitLODGeometry<0||s.imageGeometry)if(void 0!==s.bitLODtotalVertexCount)a.drawArrays(a.TRIANGLES,0,s.bitLODtotalVertexCount);else for(B=0,D=0,C=t._vf.vertexCount.length;C>B;B++)a.drawArrays(s.primType[B],D,t._vf.vertexCount[B]),D+=t._vf.vertexCount[B];else if(t.hasIndexOffset()){var F=r.tessellationProperties();for(B=0,C=F.length;C>B;B++)a.drawElements(s.primType,F[B].count,s.indexType,F[B].offset*x3dom.Utils.getOffsetMultiplier(s.indexType,a))}else 0==s.indexes[z].length?a.drawArrays(s.primType,0,s.positions[z].length/3):a.drawElements(s.primType,s.indexes[z].length,s.indexType,0);a.disableVertexAttribArray(i.position)}}0==s.imageGeometry||x3dom.caps.MOBILE||(a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),1==s.imageGeometry&&(a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,null)))}}a.flush(),this.stateManager.bindFramebuffer(a.FRAMEBUFFER,null)},a.prototype.renderPickingPass=function(a,b,c,d,e,f,g,h,i,j,k){var l=b._webgl.pickScale,m=b._webgl.fboPick.height,n=h*l,o=m-1-i*l,p=null;switch(g){case 0:p=b._webgl.pickShader;break;case 1:p=b._webgl.pickColorShader;break;case 2:p=b._webgl.pickTexCoordShader;break;case 3:p=b._webgl.pickShader24;break;case 4:p=b._webgl.pickShaderId}if(p){this.stateManager.bindFramebuffer(a.FRAMEBUFFER,b._webgl.fboPick.fbo),this.stateManager.viewport(0,0,b._webgl.fboPick.width,m),a.clearColor(0,0,0,0),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);var q=b.drawableCollection.viewarea,r=b.getEnvironment(),s=b.drawableCollection.length;r._vf.smallFeatureCulling&&r._lowPriorityThreshold<1&&q.isMovingOrAnimating()&&(s=Math.floor(s*r._lowPriorityThreshold),!s&&b.drawableCollection.length&&(s=1));var t=x3dom.fields.SFVec3f.NullVector.toGL(),u=x3dom.fields.SFVec3f.OneVector.toGL();this.stateManager.depthFunc(a.LEQUAL),this.stateManager.enable(a.DEPTH_TEST),this.stateManager.enable(a.CULL_FACE),this.stateManager.disable(a.BLEND),this.stateManager.useProgram(p),0==g&&(p.PG_precisionLevel=1,p.PG_powPrecision=1,p.PG_maxBBSize=[0,0,0],p.PG_bbMin=[0,0,0],p.PG_bbMaxModF=[0,0,0],p.PG_bboxShiftVec=[0,0,0]),this.stateManager.lineWidth(2);for(var v=0;s>v;v++){var w=b.drawableCollection.get(v),x=w.transform,y=w.shape,z=y._webgl;if(z&&!(y._objectID<1)&&y._vf.isPickable){var A=y._cf.geometry.node,B=A._mesh;if(p.modelMatrix=x.toGL(),p.modelViewProjectionMatrix=d.mult(x).toGL(),p.lowBit=(255&y._objectID)/255,p.highBit=(y._objectID>>>8)/255,p.from=e.toGL(),p.sceneSize=f,p.imageGeometry=z.imageGeometry,p.popGeometry=z.popGeometry,p.writeShadowIDs=0!=z.binaryGeometry&&A._vf.idsPerVertex?x3dom.nodeTypes.Shape.objectID+2:0,z.coordType!=a.FLOAT?(p.bgCenter=z.popGeometry||!z.bitLODGeometry&&!x3dom.Utils.isUnsignedType(A._vf.coordType)?A._vf.position.toGL():A.getMin().toGL(),p.bgSize=A._vf.size.toGL(),p.bgPrecisionMax=A.getPrecisionMax("coordType")):(p.bgCenter=t,p.bgSize=u,p.bgPrecisionMax=1),z.colorType!=a.FLOAT&&(p.bgPrecisionColMax=A.getPrecisionMax("colorType")),z.texCoordType!=a.FLOAT&&(p.bgPrecisionTexMax=A.getPrecisionMax("texCoordType")),0!=z.imageGeometry&&!x3dom.caps.MOBILE){p.IG_bboxMin=A.getMin().toGL(),p.IG_bboxMax=A.getMax().toGL(),p.IG_implicitMeshSize=A._vf.implicitMeshSize.toGL();var C=x3dom.Utils.findTextureByName(z.texture,"IG_coords0");if(C&&(p.IG_coordTextureWidth=C.texture.width,p.IG_coordTextureHeight=C.texture.height),1==z.imageGeometry){var D=x3dom.Utils.findTextureByName(z.texture,"IG_index");D&&(p.IG_indexTextureWidth=D.texture.width,p.IG_indexTextureHeight=D.texture.height),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,D.texture),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,C.texture)}else a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,C.texture);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);var E=0;A.getIndexTexture()&&(p.IG_indexTexture||(p.IG_indexTexture=E++)),A.getCoordinateTexture(0)&&(p.IG_coordinateTexture||(p.IG_coordinateTexture=E++))}if(y.isSolid()?(this.stateManager.enable(a.CULL_FACE),y.isCCW()?this.stateManager.frontFace(a.CCW):this.stateManager.frontFace(a.CW)):this.stateManager.disable(a.CULL_FACE),z.popGeometry){var F=c.mult(x);this.updatePopState(w,A,p,z,b,F,q,this.x3dElem.runtime.fps)}for(var G=0,H=z.positions.length;H>G;G++){var I,J,K,L=5*G;if(void 0!==p.position&&z.buffers[L+1]&&z.indexes[G]){if(z.buffers[L]&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,z.buffers[L]),a.bindBuffer(a.ARRAY_BUFFER,z.buffers[L+1]),a.vertexAttribPointer(p.position,B._numPosComponents,z.coordType,!1,y._coordStrideOffset[0],y._coordStrideOffset[1]),a.enableVertexAttribArray(p.position),void 0!==p.texcoord&&z.buffers[L+3]&&(a.bindBuffer(a.ARRAY_BUFFER,z.buffers[L+3]),a.vertexAttribPointer(p.texcoord,B._numTexComponents,z.texCoordType,!1,y._texCoordStrideOffset[0],y._texCoordStrideOffset[1]),a.enableVertexAttribArray(p.texcoord)),void 0!==p.color&&z.buffers[L+4]&&(a.bindBuffer(a.ARRAY_BUFFER,z.buffers[L+4]),a.vertexAttribPointer(p.color,B._numColComponents,z.colorType,!1,y._colorStrideOffset[0],y._colorStrideOffset[1]),a.enableVertexAttribArray(p.color)),z.binaryGeometry>0||z.popGeometry>0||z.bitLODGeometry>0)for(I=0,K=0,J=A._vf.vertexCount.length;J>I;I++)a.drawElements(z.primType[I],A._vf.vertexCount[I],z.indexType,x3dom.Utils.getByteAwareOffset(K,z.indexType,a)),K+=A._vf.vertexCount[I];else if(z.binaryGeometry<0||z.popGeometry<0||z.bitLODGeometry<0||z.imageGeometry)if(void 0!==z.bitLODtotalVertexCount)a.drawArrays(a.TRIANGLES,0,z.bitLODtotalVertexCount);else for(I=0,K=0,J=A._vf.vertexCount.length;J>I;I++)a.drawArrays(z.primType[I],K,A._vf.vertexCount[I]),K+=A._vf.vertexCount[I];else if(A.hasIndexOffset()){var M=y.tessellationProperties();for(I=0,J=M.length;J>I;I++)a.drawElements(z.primType,M[I].count,z.indexType,M[I].offset*x3dom.Utils.getOffsetMultiplier(z.indexType,a))}else 0==z.indexes[G].length?a.drawArrays(z.primType,0,z.positions[G].length/3):a.drawElements(z.primType,z.indexes[G].length,z.indexType,0);a.disableVertexAttribArray(p.position),void 0!==p.texcoord&&z.buffers[L+3]&&a.disableVertexAttribArray(p.texcoord),void 0!==p.color&&z.buffers[L+4]&&a.disableVertexAttribArray(p.color)}}0==z.imageGeometry||x3dom.caps.MOBILE||(a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),1==z.imageGeometry&&(a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,null)))}}this.stateManager.lineWidth(1),a.flush();try{var N=new Uint8Array(4*j*k);a.readPixels(n,o,j,k,a.RGBA,a.UNSIGNED_BYTE,N),b._webgl.fboPick.pixelData=N}catch(O){b._webgl.fboPick.pixelData=[],x3dom.debug.logException(O+" (cannot pick)")}this.stateManager.bindFramebuffer(a.FRAMEBUFFER,null)}},a.prototype.renderShape=function(a,b,c,d,e,f,g,h,i){var j=a.shape,k=a.transform;if(!j||!j._webgl||!k)return x3dom.debug.logError("[Context|RenderShape] No valid Shape!"),void 0;var l=j._webgl,m=l.shader;if(!m)return x3dom.debug.logError("[Context|RenderShape] No Shader is set!"),void 0;var n=this.stateManager.useProgram(m),o=j._cf.appearance.node,p=j._cf.geometry.node,q=p._mesh,r=b._scene,s=null;l.coordType!=i.FLOAT?(m.bgCenter=l.popGeometry||!l.bitLODGeometry&&!x3dom.Utils.isUnsignedType(p._vf.coordType)?p._vf.position.toGL():p.getMin().toGL(),m.bgSize=p._vf.size.toGL(),m.bgPrecisionMax=p.getPrecisionMax("coordType")):(m.bgCenter=[0,0,0],m.bgSize=[1,1,1],m.bgPrecisionMax=1),m.bgPrecisionColMax=l.colorType!=i.FLOAT?p.getPrecisionMax("colorType"):1,m.bgPrecisionTexMax=l.texCoordType!=i.FLOAT?p.getPrecisionMax("texCoordType"):1,m.bgPrecisionNorMax=l.normalType!=i.FLOAT?p.getPrecisionMax("normalType"):1,0!=l.imageGeometry&&(m.IG_bboxMin=p.getMin().toGL(),m.IG_bboxMax=p.getMax().toGL(),m.IG_implicitMeshSize=p._vf.implicitMeshSize.toGL(),s=x3dom.Utils.findTextureByName(l.texture,"IG_coords0"),s&&(m.IG_coordTextureWidth=s.texture.width,m.IG_coordTextureHeight=s.texture.height),1==l.imageGeometry&&(s=x3dom.Utils.findTextureByName(l.texture,"IG_index"),s&&(m.IG_indexTextureWidth=s.texture.width,m.IG_indexTextureHeight=s.texture.height)),s=null);var t=r.getFog();t&&n&&(m.fogColor=t._vf.color.toGL(),m.fogRange=t._vf.visibilityRange,m.fogType="LINEAR"==t._vf.fogType?0:1);var u=o?o._cf.material.node:null,v=o?o._shader:null;if(l.csshader?(m.diffuseColor=v._vf.diffuseFactor.toGL(),m.specularColor=v._vf.specularFactor.toGL(),m.emissiveColor=v._vf.emissiveFactor.toGL(),m.shininess=v._vf.shininessFactor,m.ambientIntensity=(v._vf.ambientFactor.x+v._vf.ambientFactor.y+v._vf.ambientFactor.z)/3,m.transparency=1-v._vf.alphaFactor,v.getDisplacementMap()?(s=x3dom.Utils.findTextureByName(l.texture,"displacementMap"),m.displacementWidth=s.texture.width,m.displacementHeight=s.texture.height,m.displacementFactor=v._vf.displacementFactor,m.displacementAxis="x"==v._vf.displacementAxis?0:"y"==v._vf.displacementAxis?1:2):v.getDiffuseDisplacementMap()&&(s=x3dom.Utils.findTextureByName(l.texture,"diffuseDisplacementMap"),m.displacementWidth=s.texture.width,m.displacementHeight=s.texture.height,m.displacementFactor=v._vf.displacementFactor,m.displacementAxis="x"==v._vf.displacementAxis?0:"y"==v._vf.displacementAxis?1:2)):u?(m.diffuseColor=u._vf.diffuseColor.toGL(),m.specularColor=u._vf.specularColor.toGL(),m.emissiveColor=u._vf.emissiveColor.toGL(),m.shininess=u._vf.shininess,m.ambientIntensity=u._vf.ambientIntensity,m.transparency=u._vf.transparency):(m.diffuseColor=[1,1,1],m.specularColor=[0,0,0],m.emissiveColor=[0,0,0],m.shininess=0,m.ambientIntensity=1,m.transparency=0),v)if(x3dom.isa(v,x3dom.nodeTypes.ComposedShader)){for(var w in v._vf)if(v._vf.hasOwnProperty(w)&&"language"!==w){var x=v._vf[w];x&&(m[w]=x.toGL?x.toGL():x)}}else x3dom.isa(v,x3dom.nodeTypes.CommonSurfaceShader)&&(l.csshader=v);for(var y=0;d>y&&n;y++){var z=e.mult(c[y].getCurrentTransform());x3dom.isa(c[y],x3dom.nodeTypes.DirectionalLight)?(m["light"+y+"_Type"]=0,m["light"+y+"_On"]=c[y]._vf.on?1:0,m["light"+y+"_Color"]=c[y]._vf.color.toGL(),m["light"+y+"_Intensity"]=c[y]._vf.intensity,m["light"+y+"_AmbientIntensity"]=c[y]._vf.ambientIntensity,m["light"+y+"_Direction"]=z.multMatrixVec(c[y]._vf.direction).toGL(),m["light"+y+"_Attenuation"]=[1,1,1],m["light"+y+"_Location"]=[1,1,1],m["light"+y+"_Radius"]=0,m["light"+y+"_BeamWidth"]=0,m["light"+y+"_CutOffAngle"]=0,m["light"+y+"_ShadowIntensity"]=c[y]._vf.shadowIntensity):x3dom.isa(c[y],x3dom.nodeTypes.PointLight)?(m["light"+y+"_Type"]=1,m["light"+y+"_On"]=c[y]._vf.on?1:0,m["light"+y+"_Color"]=c[y]._vf.color.toGL(),m["light"+y+"_Intensity"]=c[y]._vf.intensity,m["light"+y+"_AmbientIntensity"]=c[y]._vf.ambientIntensity,m["light"+y+"_Direction"]=[1,1,1],m["light"+y+"_Attenuation"]=c[y]._vf.attenuation.toGL(),m["light"+y+"_Location"]=z.multMatrixPnt(c[y]._vf.location).toGL(),m["light"+y+"_Radius"]=c[y]._vf.radius,m["light"+y+"_BeamWidth"]=0,m["light"+y+"_CutOffAngle"]=0,m["light"+y+"_ShadowIntensity"]=c[y]._vf.shadowIntensity):x3dom.isa(c[y],x3dom.nodeTypes.SpotLight)&&(m["light"+y+"_Type"]=2,m["light"+y+"_On"]=c[y]._vf.on?1:0,m["light"+y+"_Color"]=c[y]._vf.color.toGL(),m["light"+y+"_Intensity"]=c[y]._vf.intensity,m["light"+y+"_AmbientIntensity"]=c[y]._vf.ambientIntensity,m["light"+y+"_Direction"]=z.multMatrixVec(c[y]._vf.direction).toGL(),m["light"+y+"_Attenuation"]=c[y]._vf.attenuation.toGL(),m["light"+y+"_Location"]=z.multMatrixPnt(c[y]._vf.location).toGL(),m["light"+y+"_Radius"]=c[y]._vf.radius,m["light"+y+"_BeamWidth"]=c[y]._vf.beamWidth,m["light"+y+"_CutOffAngle"]=c[y]._vf.cutOffAngle,m["light"+y+"_ShadowIntensity"]=c[y]._vf.shadowIntensity)}var A=r.getNavigationInfo();A._vf.headlight&&n&&(d=d?d:0,m["light"+d+"_Type"]=0,m["light"+d+"_On"]=1,m["light"+d+"_Color"]=[1,1,1],m["light"+d+"_Intensity"]=1,m["light"+d+"_AmbientIntensity"]=0,m["light"+d+"_Direction"]=[0,0,-1],m["light"+d+"_Attenuation"]=[1,1,1],m["light"+d+"_Location"]=[1,1,1],m["light"+d+"_Radius"]=0,m["light"+d+"_BeamWidth"]=0,m["light"+d+"_CutOffAngle"]=0,m["light"+d+"_ShadowIntensity"]=0);var B=o?o._cf.depthMode.node:null;B?B._vf.enableDepthTest?(this.stateManager.enable(i.DEPTH_TEST),this.stateManager.depthMask(!B._vf.readOnly),this.stateManager.depthFunc(x3dom.Utils.depthFunc(i,B._vf.depthFunc)),this.stateManager.depthRange(B._vf.zNearRange,B._vf.zFarRange)):this.stateManager.disable(i.DEPTH_TEST):(this.stateManager.enable(i.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(i.LEQUAL));var C=o?o._cf.blendMode.node:null;if(C){var D=x3dom.Utils.blendFunc(i,C._vf.srcFactor),E=x3dom.Utils.blendFunc(i,C._vf.destFactor);D&&E?(this.stateManager.enable(i.BLEND),this.stateManager.blendFuncSeparate(D,E,i.ONE,i.ONE),this.stateManager.blendColor(C._vf.color.r,C._vf.color.g,C._vf.color.b,1-C._vf.colorTransparency),this.stateManager.blendEquation(x3dom.Utils.blendEquation(i,C._vf.equation))):this.stateManager.disable(i.BLEND)}else this.stateManager.enable(i.BLEND),this.stateManager.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE);var F=o?o._cf.colorMaskMode.node:null;F?this.stateManager.colorMask(F._vf.maskR,F._vf.maskG,F._vf.maskB,F._vf.maskA):this.stateManager.colorMask(!0,!0,!0,!0);var G=o?o._cf.lineProperties.node:null;G?this.stateManager.lineWidth(G._vf.linewidthScaleFactor):this.stateManager.lineWidth(1),j.isSolid()?(this.stateManager.enable(i.CULL_FACE),j.isCCW()?this.stateManager.frontFace(i.CCW):this.stateManager.frontFace(i.CW)):this.stateManager.disable(i.CULL_FACE);var H=e.mult(k),I=H.inverse();m.modelViewMatrix=H.toGL(),m.viewMatrix=e.toGL(),m.normalMatrix=I.transpose().toGL(),m.modelViewMatrixInverse=I.toGL(),m.projectionMatrix=h.toGL(),m.modelViewProjectionMatrix=f.mult(k).toGL(),l.popGeometry&&this.updatePopState(a,p,m,l,r,H,b,this.x3dElem.runtime.fps);for(var J=0,K=l.texture.length;K>J;J++)s=l.texture[J],i.activeTexture(i.TEXTURE0+J),i.bindTexture(s.type,s.texture),i.texParameteri(s.type,i.TEXTURE_WRAP_S,s.wrapS),i.texParameteri(s.type,i.TEXTURE_WRAP_T,s.wrapT),i.texParameteri(s.type,i.TEXTURE_MAG_FILTER,s.magFilter),i.texParameteri(s.type,i.TEXTURE_MIN_FILTER,s.minFilter),s.genMipMaps&&i.generateMipmap(s.type),v&&x3dom.isa(v,x3dom.nodeTypes.ComposedShader)||m[s.samplerName]||(m[s.samplerName]=J);if(o&&o._cf.textureTransform.node){var L=o.texTransformMatrix();m.texTrafoMatrix=L.toGL()}var M,N=null,O=l.dynamicFields.length;for(M=0;O>M;M++)N=l.dynamicFields[M],void 0!==m[N.name]&&(i.bindBuffer(i.ARRAY_BUFFER,N.buf),i.vertexAttribPointer(m[N.name],N.numComponents,i.FLOAT,!1,0,0),i.enableVertexAttribArray(m[N.name]));for(var P,Q,R,S=0,T=l.positions.length;T>S;S++){var U=5*S;if(void 0!==m.position&&l.buffers[U+1]&&l.indexes[S]){l.buffers[U]&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,l.buffers[U]),i.bindBuffer(i.ARRAY_BUFFER,l.buffers[U+1]),i.vertexAttribPointer(m.position,q._numPosComponents,l.coordType,!1,j._coordStrideOffset[0],j._coordStrideOffset[1]),i.enableVertexAttribArray(m.position),void 0!==m.normal&&l.buffers[U+2]&&(i.bindBuffer(i.ARRAY_BUFFER,l.buffers[U+2]),i.vertexAttribPointer(m.normal,q._numNormComponents,l.normalType,!1,j._normalStrideOffset[0],j._normalStrideOffset[1]),i.enableVertexAttribArray(m.normal)),void 0!==m.texcoord&&l.buffers[U+3]&&(i.bindBuffer(i.ARRAY_BUFFER,l.buffers[U+3]),i.vertexAttribPointer(m.texcoord,q._numTexComponents,l.texCoordType,!1,j._texCoordStrideOffset[0],j._texCoordStrideOffset[1]),i.enableVertexAttribArray(m.texcoord)),void 0!==m.color&&l.buffers[U+4]&&(i.bindBuffer(i.ARRAY_BUFFER,l.buffers[U+4]),i.vertexAttribPointer(m.color,q._numColComponents,l.colorType,!1,j._colorStrideOffset[0],j._colorStrideOffset[1]),i.enableVertexAttribArray(m.color)),0!=l.popGeometry&&l.buffers[U+5]&&(i.bindBuffer(i.ARRAY_BUFFER,l.buffers[U+5]),i.vertexAttribPointer(m.PG_vertexID,1,i.FLOAT,!1,4,0),i.enableVertexAttribArray(m.PG_vertexID));var V=b.getRenderMode();if(V>0){var W=1==V?i.POINTS:i.LINES;if(l.binaryGeometry>0||l.popGeometry>0||l.bitLODGeometry>0)for(P=0,R=0,Q=p._vf.vertexCount.length;Q>P;P++)i.drawElements(W,p._vf.vertexCount[P],l.indexType,x3dom.Utils.getByteAwareOffset(R,l.indexType,i)),R+=p._vf.vertexCount[P];else if(l.binaryGeometry<0||l.popGeometry<0||l.bitLODGeometry<0||l.imageGeometry)for(P=0,R=0,Q=p._vf.vertexCount.length;Q>P;P++)i.drawArrays(W,R,p._vf.vertexCount[P]),R+=p._vf.vertexCount[P];else 0==l.indexes[S].length?i.drawArrays(W,0,l.positions[S].length/3):i.drawElements(W,l.indexes[S].length,l.indexType,0)}else if(l.binaryGeometry>0||l.popGeometry>0||l.bitLODGeometry>0)for(P=0,R=0,Q=p._vf.vertexCount.length;Q>P;P++)i.drawElements(l.primType[P],p._vf.vertexCount[P],l.indexType,x3dom.Utils.getByteAwareOffset(R,l.indexType,i)),R+=p._vf.vertexCount[P];else if(l.binaryGeometry<0||l.popGeometry<0||l.bitLODGeometry<0||l.imageGeometry)if(void 0!==l.bitLODtotalVertexCount)i.drawArrays(i.TRIANGLES,0,l.bitLODtotalVertexCount);else for(P=0,R=0,Q=p._vf.vertexCount.length;Q>P;P++)i.drawArrays(l.primType[P],R,p._vf.vertexCount[P]),R+=p._vf.vertexCount[P];else if(p.hasIndexOffset()){var X=j.tessellationProperties();for(P=0,Q=X.length;Q>P;P++)i.drawElements(l.primType,X[P].count,l.indexType,X[P].offset*x3dom.Utils.getOffsetMultiplier(l.indexType,i))}else 0==l.indexes[S].length?i.drawArrays(l.primType,0,l.positions[S].length/3):i.drawElements(l.primType,l.indexes[S].length,l.indexType,0);i.disableVertexAttribArray(m.position),void 0!==m.normal&&i.disableVertexAttribArray(m.normal),void 0!==m.texcoord&&i.disableVertexAttribArray(m.texcoord),void 0!==m.color&&i.disableVertexAttribArray(m.color),0!=l.popGeometry&&void 0!==m.PG_vertexID&&i.disableVertexAttribArray(m.PG_vertexID)}}for(M=0;O>M;M++)N=l.dynamicFields[M],void 0!==m[N.name]&&i.disableVertexAttribArray(m[N.name]);if(l.imageGeometry)for(Q=p._vf.vertexCount.length,this.numDrawCalls+=Q,P=0;Q>P;P++)this.numFaces+=l.primType[P]==i.TRIANGLE_STRIP?p._vf.vertexCount[P]-2:p._vf.vertexCount[P]/3,this.numCoords+=p._vf.vertexCount[P];else this.numCoords+=q._numCoords,this.numFaces+=q._numFaces,this.numDrawCalls+=l.binaryGeometry||l.popGeometry||l.bitLODGeometry?p._vf.vertexCount.length:p.hasIndexOffset()?j.tessellationProperties().length:T;B&&(this.stateManager.enable(i.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(i.LEQUAL),this.stateManager.depthRange(0,1)),C&&(this.stateManager.enable(i.BLEND),this.stateManager.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE),this.stateManager.blendColor(1,1,1,1),this.stateManager.blendEquation(i.FUNC_ADD)),F&&this.stateManager.colorMask(!0,!0,!0,!0),G&&this.stateManager.lineWidth(1);var Y=l.texture;for(K=Y?Y.length:0,J=0;K>J;J++)Y[J]&&o&&o._cf.texture.node&&(s=o._cf.texture.node.getTexture(J),i.activeTexture(i.TEXTURE0+J),x3dom.isa(s,x3dom.nodeTypes.X3DEnvironmentTextureNode)?i.bindTexture(i.TEXTURE_CUBE_MAP,null):i.bindTexture(i.TEXTURE_2D,null))},a.prototype.updatePopState=function(a,b,c,d,e,f,g,h){var i=x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor*b._vf.precisionFactor;(1>=h||g.isMovingOrAnimating())&&(i*=x3dom.nodeTypes.PopGeometry.PrecisionFactorOnMove);var j=16;if(i>0){var k=e.getViewpoint(),l=k.getImgPlaneHeightAtDistOne(),m=k.getNear(),n=f.multMatrixPnt(b._vf.position),o=.5*f.multMatrixVec(b._vf.size).length(),p=.5*f.multMatrixVec(b._vf.maxBBSize).length(),q=Math.max(-n.z-o,m),r=q*(l/g._height),s=2*p/(i*r);j=Math.ceil(Math.log(s)/.693147180559945),j=1>j?1:j>16?16:j}var t=b._vf.minPrecisionLevel,u=b._vf.maxPrecisionLevel;j=-1!=t&&t>j?t:j,j=-1!=u&&j>u?u:j;var v=d.levelsAvailable<j?d.levelsAvailable:j;j=v,1>=i&&(j=j==b.getNumLevels()?16:j);var w=b._vf.indexedRendering,x=b._mesh;x._numCoords=0,x._numFaces=0;for(var y=0;v>y;++y){var z=d.numVerticesAtLevel[y];x._numCoords+=z,x._numFaces+=(w?b.getNumIndicesByLevel(y):z)/3}x3dom.nodeTypes.PopGeometry.numRenderedVerts+=x._numCoords,x3dom.nodeTypes.PopGeometry.numRenderedTris+=x._numFaces,x.currentLOD=j,b.adaptVertexCount(w?3*x._numFaces:x._numCoords),c.PG_maxBBSize=b._vf.maxBBSize.toGL(),c.PG_bbMin=b._bbMinBySize,c.PG_numAnchorVertices=b._vf.numAnchorVertices,c.PG_bbMaxModF=b._vf.bbMaxModF.toGL(),c.PG_bboxShiftVec=b._vf.bbShiftVec.toGL(),c.PG_precisionLevel=j,c.PG_powPrecision=x3dom.nodeTypes.PopGeometry.powLUT[j-1]},a.prototype.pickValue=function(a,b,c,d,e,f){var g=this.ctx3d,h=a._scene;if(!(g&&h&&h._webgl&&h.drawableCollection))return!1;var i=h._vf.pickMode.toLowerCase(),j=0;switch(i){case"box":return!1;case"idbuf":j=0;break;case"idbuf24":j=3;break;case"idbufid":j=4;break;case"color":j=1;break;case"texcoord":j=2}x3dom.Utils.startMeasure("picking");var k,l;arguments.length>4?(k=e,l=f):(k=a._last_mat_view,l=a._last_mat_scene);var m=x3dom.fields.SFVec3f.copy(h._lastMin),n=x3dom.fields.SFVec3f.copy(h._lastMax),o=k.inverse().e3(),p=x3dom.fields.SFVec3f.copy(o),q=x3dom.fields.SFVec3f.copy(o);p.x>m.x&&(p.x=m.x),p.y>m.y&&(p.y=m.y),p.z>m.z&&(p.z=m.z),q.x<n.x&&(q.x=n.x),q.y<n.y&&(q.y=n.y),q.z<n.z&&(q.z=n.z),h._lastMin.setValues(p),h._lastMax.setValues(q);var r=h._lastMax.subtract(h._lastMin).length(),s=a.getCCtoWCMatrix();h._lastMin.setValues(m),h._lastMax.setValues(n);var t=x3dom.nodeTypes.Shape.objectID+2;this.renderPickingPass(g,h,k,l,o,r,j,b,c,2,2);var u=h._webgl.fboPick.pixelData;if(u&&u.length){var v,w,x,y,z,A,B=new x3dom.fields.SFVec3f(0,0,0),C=new x3dom.fields.SFVec3f(0,0,1),D=0,E=u[D+3],F=1/h._webgl.pickScale,G=1/256;
0==j?(E+=256*u[D+2],w=u[D]/255*G+u[D+1]/255,x=a.calcViewRay(b,c,s),B=x.pos.add(x.dir.multiply(w*r)),D=4,w=u[D]/255*G+u[D+1]/255,y=a.calcViewRay(b+F,c,s),z=y.pos.add(y.dir.multiply(w*r)),z=z.subtract(B).normalize(),D=8,w=u[D]/255*G+u[D+1]/255,y=a.calcViewRay(b,c-F,s),A=y.pos.add(y.dir.multiply(w*r)),A=A.subtract(B).normalize(),C=z.cross(A).normalize()):3==j?(E+=256*u[D+2]+65536*u[D+1],w=u[D]/255,x=a.calcViewRay(b,c,s),B=x.pos.add(x.dir.multiply(w*r)),D=4,w=u[D]/255,y=a.calcViewRay(b+F,c,s),z=y.pos.add(y.dir.multiply(w*r)),z=z.subtract(B).normalize(),D=8,w=u[D]/255,y=a.calcViewRay(b,c-F,s),A=y.pos.add(y.dir.multiply(w*r)),A=A.subtract(B).normalize(),C=z.cross(A).normalize()):4==j?(E+=256*u[D+2],v=u[D+1],v+=256*u[D],0==E&&v>0&&t>v&&(E=v)):(B.x=u[D],B.y=u[D+1],B.z=u[D+2]);var H,I,J="shadowObjectIdChanged",K=Math.max(d>>>8,255&d);if(E>=t){E-=t;var L;if(4!=j?(a._pickingInfo.pickPos=B,a._pick.setValues(B),a._pickingInfo.pickNorm=C,a._pickNorm.setValues(C),a._pickingInfo.pickObj=null,a._pickingInfo.lastClickObj=null,L=h._xmlNode):(a._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[v],L=a._pickingInfo.pickObj._xmlNode),H=a._pickingInfo.shadowObjectId!=E,a._pickingInfo.shadowObjectId=E,(H||K)&&h._xmlNode&&(h._xmlNode["on"+J]||h._xmlNode.hasAttribute("on"+J)||h._listeners[J])&&(I={target:h._xmlNode,type:J,button:K,mouseup:d>>>8>0,layerX:b,layerY:c,shadowObjectId:E,worldX:B.x,worldY:B.y,worldZ:B.z,normalX:C.x,normalY:C.y,normalZ:C.z,hitPnt:B.toGL(),hitObject:L,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},h.callEvtHandler("on"+J,I)),h._shadowIdMap&&h._shadowIdMap.mapping)for(var M=h._shadowIdMap.mapping[E].usage,N=0;N<M.length;N++){var O=h._nameSpace.defMap[M[N]];if(O.doIntersect(x)){a._pickingInfo.pickObj=O;break}}}else H=-1!=a._pickingInfo.shadowObjectId,a._pickingInfo.shadowObjectId=-1,H&&h._xmlNode&&(h._xmlNode["on"+J]||h._xmlNode.hasAttribute("on"+J)||h._listeners[J])&&(I={target:h._xmlNode,type:J,button:K,mouseup:d>>>8>0,layerX:b,layerY:c,shadowObjectId:a._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},h.callEvtHandler("on"+J,I)),E>0?(a._pickingInfo.pickPos=B,a._pickingInfo.pickNorm=C,a._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[E]):(a._pickingInfo.pickObj=null,a._pickingInfo.lastClickObj=null)}var P=x3dom.Utils.stopMeasure("picking");return this.x3dElem.runtime.addMeasurement("PICKING",P),!0},a.prototype.pickRect=function(a,b,c,d,e){var f=this.ctx3d,g=a?a._scene:null;if(!(f&&g&&g._webgl&&g.drawableCollection))return!1;var h=a._last_mat_view.inverse().e3(),i=g._lastMax.subtract(g._lastMin).length(),j=d>=b?b:d,k=c>=e?c:e,l=(1+Math.abs(d-b))*g._webgl.pickScale,m=(1+Math.abs(e-c))*g._webgl.pickScale;this.renderPickingPass(f,g,a._last_mat_view,a._last_mat_scene,h,i,0,j,k,1>l?1:l,1>m?1:m);var n,o=[];for(n=0;g._webgl.fboPick.pixelData&&n<g._webgl.fboPick.pixelData.length;n+=4){var p=g._webgl.fboPick.pixelData[n+3]+256*g._webgl.fboPick.pixelData[n+2];p>0&&o.push(p)}o.sort();var q=function(a){for(var b=[],c=a.length,d=0;c>d;d++){for(var e=d+1;c>e;e++)a[d]===a[e]&&(e=++d);b.push(a[d])}return b}(o);o=q;var r=[];for(n=0;n<o.length;n++){var s=o[n];s=x3dom.nodeTypes.Shape.idMap.nodeID[s],s=s&&s._xmlNode?s._xmlNode:null,s&&r.push(s)}return r},a.prototype.renderScene=function(a){var b=this.ctx3d,c=a._scene;if(null!==b&&null!==c){var d,e,f=a._doc._nodeBag.renderTextures,g=f.length,h=b.UNSIGNED_BYTE,i=b.UNSIGNED_BYTE,j=!1;x3dom.caps.FP_TEXTURES&&!x3dom.caps.MOBILE&&(h=b.FLOAT,i=b.FLOAT,x3dom.caps.FPL_TEXTURES||(j=!0));var k,l,m,n,o,p,q;if(c.updateVolume(),c._webgl){var r=Math.round(this.canvas.width*c._webgl.pickScale),s=Math.round(this.canvas.height*c._webgl.pickScale);for((c._webgl._currFboWidth!==r||c._webgl._currFboHeight!==s)&&(c._webgl._currFboWidth=r,c._webgl._currFboHeight=s,c._webgl.fboPick=this.initFbo(b,r,s,!0,c._webgl.fboPick.typ),c._webgl.fboPick.pixelData=null,x3dom.debug.logInfo("Refreshed picking FBO to size ("+r+", "+s+")")),e=0;g>e;e++)d=f[e],d._webgl&&d._webgl.fbo&&d._webgl.fbo.width==d._vf.dimensions[0]&&d._webgl.fbo.height==d._vf.dimensions[1]||(d.invalidateGLObject(),d._webgl={},d._webgl.fbo=this.initFbo(b,d._vf.dimensions[0],d._vf.dimensions[1],j,h),x3dom.debug.logInfo("Init/resize RenderedTexture_"+e+" to size "+d._vf.dimensions[0]+" x "+d._vf.dimensions[1]));for(k=a.getShadowedLights(),o=k.length,m=0;o>m;m++)if(p=k[m]._vf.shadowMapSize,l=x3dom.isa(k[m],x3dom.nodeTypes.PointLight)?6:Math.max(1,Math.min(k[m]._vf.shadowCascades,6)),"undefined"==typeof c._webgl.fboShadow[m]||c._webgl.fboShadow[m].length!=l||c._webgl.fboShadow[m][0].height!=p)for(c._webgl.fboShadow[m]=[],n=0;l>n;n++)c._webgl.fboShadow[m][n]=this.initFbo(b,p,p,j,i);for(m=0;o>m;m++){for(p=c._webgl.fboShadow[m][0].height,q=!1,n=0;n<c._webgl.fboBlur.length;n++)p==c._webgl.fboBlur[n].height&&(q=!0);q||(c._webgl.fboBlur[c._webgl.fboBlur.length]=this.initFbo(b,p,p,j,i))}(c._webgl.fboShadow.length>0&&"undefined"==typeof c._webgl.fboScene||c._webgl.fboScene&&(this.canvas.width!=c._webgl.fboScene.width||this.canvas.height!=c._webgl.fboScene.height))&&(c._webgl.fboScene=this.initFbo(b,this.canvas.width,this.canvas.height,j,i))}else{for(c._webgl={},this.setupFgnds(b,c),c._webgl.pickScale=.5,c._webgl._currFboWidth=Math.round(this.canvas.width*c._webgl.pickScale),c._webgl._currFboHeight=Math.round(this.canvas.height*c._webgl.pickScale),c._webgl.fboPick=this.initFbo(b,c._webgl._currFboWidth,c._webgl._currFboHeight,!0,b.UNSIGNED_BYTE),c._webgl.fboPick.pixelData=null,c._webgl.pickShader=this.cache.getShader(b,x3dom.shader.PICKING),c._webgl.pickShader24=this.cache.getShader(b,x3dom.shader.PICKING_24),c._webgl.pickShaderId=this.cache.getShader(b,x3dom.shader.PICKING_ID),c._webgl.pickColorShader=this.cache.getShader(b,x3dom.shader.PICKING_COLOR),c._webgl.pickTexCoordShader=this.cache.getShader(b,x3dom.shader.PICKING_TEXCOORD),c._webgl.normalShader=this.cache.getShader(b,x3dom.shader.NORMAL),c._webgl.fboShadow=[],k=a.getShadowedLights(),o=k.length,m=0;o>m;m++)for(p=k[m]._vf.shadowMapSize,l=x3dom.isa(k[m],x3dom.nodeTypes.PointLight)?6:Math.max(1,Math.min(k[m]._vf.shadowCascades,6)),c._webgl.fboShadow[m]=[],n=0;l>n;n++)c._webgl.fboShadow[m][n]=this.initFbo(b,p,p,j,i);for(c._webgl.fboShadow.length>0&&(c._webgl.fboScene=this.initFbo(b,this.canvas.width,this.canvas.height,j,i)),c._webgl.fboBlur=[],m=0;o>m;m++){for(p=c._webgl.fboShadow[m][0].height,q=!1,n=0;n<c._webgl.fboBlur.length;n++)p==c._webgl.fboBlur[n].height&&(q=!0);q||(c._webgl.fboBlur[c._webgl.fboBlur.length]=this.initFbo(b,p,p,j,i))}c._webgl.ppBuffer=b.createBuffer(),b.bindBuffer(b.ARRAY_BUFFER,c._webgl.ppBuffer);var t=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];for(b.bufferData(b.ARRAY_BUFFER,new Float32Array(t),b.STATIC_DRAW),c._webgl.shadowShader=this.cache.getShader(b,x3dom.shader.SHADOW),e=0;g>e;e++)d=f[e],d._webgl={},d._webgl.fbo=this.initFbo(b,d._vf.dimensions[0],d._vf.dimensions[1],j,h);a._last_mat_view=x3dom.fields.SFMatrix4f.identity(),a._last_mat_proj=x3dom.fields.SFMatrix4f.identity(),a._last_mat_scene=x3dom.fields.SFMatrix4f.identity(),this._calledViewpointChangedHandler=!1}var u=c.getEnvironment();u.checkSanity();var v=c.getBackground();this.setupScene(b,v),this.numFaces=0,this.numCoords=0,this.numDrawCalls=0;var w=a.getProjectionMatrix(),x=a.getViewMatrix();if(!this._calledViewpointChangedHandler||!a._last_mat_view.equals(x)){var y=c.getViewpoint(),z="viewpointChanged";try{if(y._xmlNode&&(y._xmlNode["on"+z]||y._xmlNode.hasAttribute("on"+z)||y._listeners[z])){var A=y.getCurrentTransform();A=A.inverse().mult(x);var B=A.inverse(),C=new x3dom.fields.Quaternion(0,0,1,0);C.setValue(B);var D=B.e3(),E={target:y._xmlNode,type:z,matrix:A,position:D,orientation:C.toAxisAngle(),cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};y.callEvtHandler("on"+z,E),this._calledViewpointChangedHandler=!0}}catch(F){x3dom.debug.logException(F)}}a._last_mat_view=x,a._last_mat_proj=w;var G=w.mult(x);if(a._last_mat_scene=G,c.drawableCollection=null,!c.drawableCollection){var H={viewArea:a,sortTrans:u._vf.sortTrans,viewMatrix:x,projMatrix:w,sceneMatrix:G,frustumCulling:!0,smallFeatureThreshold:u._smallFeatureThreshold,context:this,gl:b};c.drawableCollection=new x3dom.DrawableCollection(H),x3dom.Utils.startMeasure("traverse"),c.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),c.drawableCollection,!0,!1,0);var I=x3dom.Utils.stopMeasure("traverse");this.x3dElem.runtime.addMeasurement("TRAVERSE",I)}x3dom.Utils.startMeasure("sorting"),c.drawableCollection.sort();var J=x3dom.Utils.stopMeasure("sorting");this.x3dElem.runtime.addMeasurement("SORT",J);var K,L=a.getLights(),M=L.length,N=[],O=[],P=0;x3dom.Utils.startMeasure("shadow");for(var Q=0;M>Q;Q++)if(L[Q]._vf.shadowIntensity>0){var R=a.getLightMatrix()[Q];Z=c._webgl.fboShadow[P];var S=Math.max(0,Math.min(1,L[Q]._vf.shadowOffset));if(x3dom.isa(L[Q],x3dom.nodeTypes.PointLight))for(K=a.getWCtoLCMatricesPointLight(R,L[Q],w),m=0;6>m;m++)this.renderShadowPass(b,a,K[m],x,Z[m],S,!1);else{var T=Math.max(1,Math.min(L[Q]._vf.shadowCascades,6));for(K=a.getWCtoLCMatricesCascaded(R,L[Q],w),m=0;T>m;m++)this.renderShadowPass(b,a,K[m],x,Z[m],S,!1)}P++,N[N.length]=K,O[O.length]=R}if(P>0){this.renderShadowPass(b,a,G,x,c._webgl.fboScene,0,!0);var U=x3dom.Utils.stopMeasure("shadow");this.x3dElem.runtime.addMeasurement("SHADOW",U)}else this.x3dElem.runtime.removeMeasurement("SHADOW");for(K=a.getWCtoLCMatrix(a.getLightMatrix()[0]),e=0;g>e;e++)this.renderRTPass(b,a,f[e]);for(x3dom.Utils.startMeasure("render"),this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height),v._webgl.render(b,x,w),x3dom.nodeTypes.PopGeometry.numRenderedVerts=0,x3dom.nodeTypes.PopGeometry.numRenderedTris=0,o=c.drawableCollection.length,u._vf.smallFeatureCulling&&u._lowPriorityThreshold<1&&a.isMovingOrAnimating()&&(o=Math.floor(o*u._lowPriorityThreshold),!o&&c.drawableCollection.length&&(o=1)),this.stateManager.unsetProgram(),m=0;o>m;m++){var V=c.drawableCollection.get(m);this.renderShape(V,a,L,M,x,G,K,w,b)}if(P>0&&this.renderShadows(b,a,k,N,O,x,w,G),this.stateManager.disable(b.BLEND),this.stateManager.disable(b.DEPTH_TEST),a._numRenderedNodes=o,void 0!==a._visDbgBuf&&a._visDbgBuf){var W=c._vf.pickMode.toLowerCase();(0==W.indexOf("idbuf")||"color"==W||"texcoord"==W)&&(this.stateManager.viewport(0,3*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),c._fgnd._webgl.render(b,c._webgl.fboPick.tex)),P>0&&(this.stateManager.viewport(this.canvas.width/4,3*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),c._fgnd._webgl.render(b,c._webgl.fboScene.tex));var X=3,Y=2;for(m=0;P>m;m++){var Z=c._webgl.fboShadow[m];for(n=0;n<Z.length;n++)this.stateManager.viewport(Y*this.canvas.width/4,X*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),c._fgnd._webgl.render(b,Z[n].tex),2>Y?Y++:(Y=0,X--)}for(e=0;g>e;e++)d=f[e],this.stateManager.viewport(e*this.canvas.width/8,5*this.canvas.height/8,this.canvas.width/8,this.canvas.height/8),c._fgnd._webgl.render(b,d._webgl.fbo.tex)}b.finish();var $=x3dom.Utils.stopMeasure("render");this.x3dElem.runtime.addMeasurement("RENDER",$),this.x3dElem.runtime.addMeasurement("DRAW",o?$/o:0),this.x3dElem.runtime.addInfo("#NODES:",c.drawableCollection.numberOfNodes),this.x3dElem.runtime.addInfo("#SHAPES:",a._numRenderedNodes),this.x3dElem.runtime.addInfo("#DRAWS:",this.numDrawCalls),this.x3dElem.runtime.addInfo("#POINTS:",this.numCoords),this.x3dElem.runtime.addInfo("#TRIS:",this.numFaces)}},a.prototype.renderRTPass=function(a,b,c){switch(c._vf.update.toUpperCase()){case"NONE":return;case"NEXT_FRAME_ONLY":if(!c._needRenderUpdate)return;c._needRenderUpdate=!1;break;case"ALWAYS":}var d,e,f=b._scene,g=null,h=c.getViewMatrix(),i=c.getProjectionMatrix(),j=i.mult(h),k=b.getLightMatrix()[0],l=b.getWCtoLCMatrix(k),m=c._cf.excludeNodes.nodes.length,n=new Array(m);for(d=0;m>d;d++){var o=c._cf.excludeNodes.nodes[d]._vf.render;n[d]=void 0===o?-1:o===!0?1:0,c._cf.excludeNodes.nodes[d]._vf.render=!1}this.stateManager.bindFramebuffer(a.FRAMEBUFFER,c._webgl.fbo.fbo),this.stateManager.viewport(0,0,c._webgl.fbo.width,c._webgl.fbo.height),null===c._cf.background.node?(a.clearColor(0,0,0,1),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT)):c._cf.background.node===f.getBackground()?(g=f.getBackground(),g._webgl.render(a,h,i)):(g=c._cf.background.node,this.setupScene(a,g),g._webgl.render(a,h,i)),this.stateManager.depthFunc(a.LEQUAL),this.stateManager.enable(a.DEPTH_TEST),this.stateManager.enable(a.CULL_FACE),this.stateManager.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE),this.stateManager.enable(a.BLEND);var p,q=b.getLights(),r=q.length,s=c._cf.scene.node;if(s&&s!==f){var t=f.getEnvironment(),u={viewArea:b,sortTrans:t._vf.sortTrans,viewMatrix:h,projMatrix:i,sceneMatrix:j,frustumCulling:!1,smallFeatureThreshold:1,context:this,gl:a};if(s.numberOfNodes=0,s.drawableCollection=new x3dom.DrawableCollection(u),s.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),s.drawableCollection,!0,!1,0),s.drawableCollection.sort(),e=s.drawableCollection.length,c._vf.showNormals)this.renderNormals(a,s,f._webgl.normalShader,h,j);else for(this.stateManager.unsetProgram(),d=0;e>d;d++)p=s.drawableCollection.get(d),p.shape._vf.render&&this.renderShape(p,b,q,r,h,j,l,i,a)}else if(e=f.drawableCollection.length,c._vf.showNormals)this.renderNormals(a,f,f._webgl.normalShader,h,j);else for(this.stateManager.unsetProgram(),d=0;e>d;d++)p=f.drawableCollection.get(d),this.renderShape(p,b,q,r,h,j,l,i,a);for(this.stateManager.disable(a.BLEND),this.stateManager.disable(a.DEPTH_TEST),a.flush(),this.stateManager.bindFramebuffer(a.FRAMEBUFFER,null),d=0;m>d;d++)0!==n[d]&&(c._cf.excludeNodes.nodes[d]._vf.render=!0)},a.prototype.renderNormals=function(a,b,c,d,e){if(c&&b){this.stateManager.depthFunc(a.LEQUAL),this.stateManager.enable(a.DEPTH_TEST),this.stateManager.enable(a.CULL_FACE),this.stateManager.disable(a.BLEND),this.stateManager.useProgram(c);for(var f=x3dom.fields.SFVec3f.NullVector.toGL(),g=x3dom.fields.SFVec3f.OneVector.toGL(),h=0,i=b.drawableCollection.length;i>h;h++){var j=b.drawableCollection.get(h),k=j.transform,l=j.shape,m=l._webgl;if(m&&l&&l._vf.render){var n=l._cf.geometry.node,o=n._mesh,p=d.mult(k).inverse();c.normalMatrix=p.transpose().toGL(),c.modelViewProjectionMatrix=e.mult(k).toGL(),c.imageGeometry=m.imageGeometry,m.coordType!=a.FLOAT?(c.bgCenter=0!=m.bitLODGeometry||0!=m.popGeometry||4==o._numPosComponents&&x3dom.Utils.isUnsignedType(n._vf.coordType)?n.getMin().toGL():n._vf.position.toGL(),c.bgSize=n._vf.size.toGL(),c.bgPrecisionMax=n.getPrecisionMax("coordType")):(c.bgCenter=f,c.bgSize=g,c.bgPrecisionMax=1),c.bgPrecisionNorMax=m.normalType!=a.FLOAT?n.getPrecisionMax("normalType"):1,l.isSolid()?(this.stateManager.enable(a.CULL_FACE),l.isCCW()?this.stateManager.frontFace(a.CCW):this.stateManager.frontFace(a.CW)):this.stateManager.disable(a.CULL_FACE);for(var q=0,r=m.positions.length;r>q;q++){var s,t,u,v=5*q;if(void 0!==c.position&&m.buffers[v+1]&&m.indexes[q]){if(m.buffers[v]&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,m.buffers[v]),a.bindBuffer(a.ARRAY_BUFFER,m.buffers[v+1]),a.vertexAttribPointer(c.position,o._numPosComponents,m.coordType,!1,l._coordStrideOffset[0],l._coordStrideOffset[1]),a.enableVertexAttribArray(c.position),void 0!==c.normal&&m.buffers[v+2]&&(a.bindBuffer(a.ARRAY_BUFFER,m.buffers[v+2]),a.vertexAttribPointer(c.normal,o._numNormComponents,m.normalType,!1,l._normalStrideOffset[0],l._normalStrideOffset[1]),a.enableVertexAttribArray(c.normal)),m.binaryGeometry>0||m.popGeometry>0||m.bitLODGeometry>0)for(s=0,u=0,t=n._vf.vertexCount.length;t>s;s++)a.drawElements(m.primType[s],n._vf.vertexCount[s],m.indexType,x3dom.Utils.getByteAwareOffset(u,m.indexType,a)),u+=n._vf.vertexCount[s];else if(m.binaryGeometry<0||m.popGeometry<0||m.bitLODGeometry<0||m.imageGeometry)if(void 0!==m.bitLODtotalVertexCount)a.drawArrays(a.TRIANGLES,0,m.bitLODtotalVertexCount);else for(s=0,u=0,t=n._vf.vertexCount.length;t>s;s++)a.drawArrays(m.primType[s],u,n._vf.vertexCount[s]),u+=n._vf.vertexCount[s];else if(n.hasIndexOffset()){var w=l.tessellationProperties();for(s=0,t=w.length;t>s;s++)a.drawElements(m.primType,w[s].count,m.indexType,w[s].offset*x3dom.Utils.getOffsetMultiplier(m.indexType,a))}else 0==m.indexes[q].length?a.drawArrays(m.primType,0,m.positions[q].length/3):a.drawElements(m.primType,m.indexes[q].length,m.indexType,0);a.disableVertexAttribArray(c.position),void 0!==c.normal&&a.disableVertexAttribArray(c.normal)}}}}}},a.prototype.shutdown=function(a){var b=this.ctx3d,c=a._scene;if(null!=b&&c){var d=c.getBackground();void 0!==d._webgl.position&&(b.deleteBuffer(d._webgl.buffers[1]),b.deleteBuffer(d._webgl.buffers[0]));var e=c._fgnd;void 0!==e._webgl.position&&(b.deleteBuffer(e._webgl.buffers[1]),b.deleteBuffer(e._webgl.buffers[0]));for(var f=c.drawableCollection?c.drawableCollection.length:0,g=0;f>g;g++){var h=c.drawableCollection.get(g).shape;h._cleanupGLObjects&&h._cleanupGLObjects(!0)}this.cache.Release(b)}},a.prototype.emptyTexImage2D=function(a,b,c,d,e,f){try{a.texImage2D(a.TEXTURE_2D,0,b,c,d,0,e,f,null)}catch(g){var h=3;switch(b){case a.DEPTH_COMPONENT:h=3;break;case a.ALPHA:h=1;break;case a.RGB:h=3;break;case a.RGBA:h=4;break;case a.LUMINANCE:h=1;break;case a.LUMINANCE_ALPHA:h=2}var i=new Uint8Array(c*d*h);a.texImage2D(a.TEXTURE_2D,0,b,c,d,0,e,f,i)}},a.prototype.initTex=function(a,b,c,d,e){var f=a.createTexture();return a.bindTexture(a.TEXTURE_2D,f),this.emptyTexImage2D(a,a.RGBA,b,c,a.RGBA,e),d?(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST)):(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR)),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),f.width=b,f.height=c,f},a.prototype.initFbo=function(a,b,c,d,e){var f=a.createFramebuffer(),g=a.createRenderbuffer(),h=this.initTex(a,b,c,d,e);this.stateManager.bindFramebuffer(a.FRAMEBUFFER,f),a.bindRenderbuffer(a.RENDERBUFFER,g),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,b,c),a.bindRenderbuffer(a.RENDERBUFFER,null),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,h,0),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,g),this.stateManager.bindFramebuffer(a.FRAMEBUFFER,null);var i=a.checkFramebufferStatus(a.FRAMEBUFFER);return i!=a.FRAMEBUFFER_COMPLETE&&x3dom.debug.logWarning("[Context|InitFBO] FBO-Status: "+i),{fbo:f,rbo:g,tex:h,width:b,height:c,typ:e}},a.prototype.renderShadows=function(a,b,c,d,e,f,g,h){var i=b._scene,j=x3dom.caps.MAX_TEXTURE_IMAGE_UNITS;if(!(7>j)){var k,l,m,n,o,p=1,q=[0];for(m=0;m<c.length;m++){var r=c[m]._vf.shadowFilterSize;for(k=i._webgl.fboShadow[m],l=k.length,n=0;l>n;n++)this.blurTex(a,i,k[n],r);p+=6,p>j&&(q[q.length]=m,p=7)}q[q.length]=c.length;var s=q.length-1,t=g.inverse(),u=h.inverse();this.stateManager.enable(a.BLEND),this.stateManager.blendFunc(a.DST_COLOR,a.ZERO);for(var v=0;s>v;v++){var w=q[v],x=q[v+1],y=[];for(o=w;x>o;o++)y[y.length]=c[o];var z=this.cache.getShadowRenderingShader(a,y);this.stateManager.useProgram(z),a.bindBuffer(a.ARRAY_BUFFER,i._webgl.ppBuffer),a.vertexAttribPointer(z.position,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(z.position),z.sceneMap=0,a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,i._webgl.fboScene.tex),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),z.inverseProj=t.toGL(),z.inverseViewProj=u.toGL();for(var A,B,C=0,D=0,E=y.length;E>D;D++){for(B=e[D+w],A=d[D+w],k=i._webgl.fboShadow[D+w],l=A.length,m=0;l>m;m++)a.activeTexture(a.TEXTURE1+C),a.bindTexture(a.TEXTURE_2D,k[m].tex),z["light"+D+"_"+m+"_ShadowMap"]=C+1,z["light"+D+"_"+m+"_Matrix"]=A[m].toGL(),C++;if(z["light"+D+"_ViewMatrix"]=B.toGL(),!x3dom.isa(y[D],x3dom.nodeTypes.PointLight))for(n=0;l>n;n++){var F=Math.max(1,Math.min(y[D]._vf.shadowCascades,6)),G=Math.max(0,Math.min(y[D]._vf.shadowSplitFactor,1)),H=Math.max(0,Math.min(y[D]._vf.shadowSplitOffset,1)),I=b.getShadowSplitDepths(F,G,H,!1,g);z["light"+D+"_"+n+"_Split"]=I[n+1]}var J=f.mult(y[D].getCurrentTransform());x3dom.isa(y[D],x3dom.nodeTypes.DirectionalLight)?(z["light"+D+"_Type"]=0,z["light"+D+"_On"]=y[D]._vf.on?1:0,z["light"+D+"_Direction"]=J.multMatrixVec(y[D]._vf.direction).toGL(),z["light"+D+"_Attenuation"]=[1,1,1],z["light"+D+"_Location"]=[1,1,1],z["light"+D+"_Radius"]=0,z["light"+D+"_BeamWidth"]=0,z["light"+D+"_CutOffAngle"]=0,z["light"+D+"_ShadowIntensity"]=y[D]._vf.shadowIntensity,z["light"+D+"_ShadowCascades"]=y[D]._vf.shadowCascades,z["light"+D+"_ShadowOffset"]=Math.max(0,Math.min(1,y[D]._vf.shadowOffset))):x3dom.isa(y[D],x3dom.nodeTypes.PointLight)?(z["light"+D+"_Type"]=1,z["light"+D+"_On"]=y[D]._vf.on?1:0,z["light"+D+"_Direction"]=[1,1,1],z["light"+D+"_Attenuation"]=y[D]._vf.attenuation.toGL(),z["light"+D+"_Location"]=J.multMatrixPnt(y[D]._vf.location).toGL(),z["light"+D+"_Radius"]=y[D]._vf.radius,z["light"+D+"_BeamWidth"]=0,z["light"+D+"_CutOffAngle"]=0,z["light"+D+"_ShadowIntensity"]=y[D]._vf.shadowIntensity,z["light"+D+"_ShadowOffset"]=Math.max(0,Math.min(1,y[D]._vf.shadowOffset))):x3dom.isa(y[D],x3dom.nodeTypes.SpotLight)&&(z["light"+D+"_Type"]=2,z["light"+D+"_On"]=y[D]._vf.on?1:0,z["light"+D+"_Direction"]=J.multMatrixVec(y[D]._vf.direction).toGL(),z["light"+D+"_Attenuation"]=y[D]._vf.attenuation.toGL(),z["light"+D+"_Location"]=J.multMatrixPnt(y[D]._vf.location).toGL(),z["light"+D+"_Radius"]=y[D]._vf.radius,z["light"+D+"_BeamWidth"]=y[D]._vf.beamWidth,z["light"+D+"_CutOffAngle"]=y[D]._vf.cutOffAngle,z["light"+D+"_ShadowIntensity"]=y[D]._vf.shadowIntensity,z["light"+D+"_ShadowCascades"]=y[D]._vf.shadowCascades,z["light"+D+"_ShadowOffset"]=Math.max(0,Math.min(1,y[D]._vf.shadowOffset)))}a.drawArrays(a.TRIANGLES,0,6);var K=C+1;for(o=0;K>o;o++)a.activeTexture(a.TEXTURE0+o),a.bindTexture(a.TEXTURE_2D,null);a.disableVertexAttribArray(z.position)}this.stateManager.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA)}},a.prototype.blurTex=function(a,b,c,d){if(!(0>=d)){d=5>d?3:7>d?5:7;for(var e=c.width,f=c.height,g=null,h=0,i=b._webgl.fboBlur.length;i>h;h++)if(f==b._webgl.fboBlur[h].height){g=b._webgl.fboBlur[h];break}this.stateManager.bindFramebuffer(a.FRAMEBUFFER,g.fbo),this.stateManager.viewport(0,0,e,f),this.stateManager.enable(a.BLEND),this.stateManager.blendFunc(a.ONE,a.ZERO),this.stateManager.disable(a.CULL_FACE),this.stateManager.disable(a.DEPTH_TEST),a.clearColor(1,1,1,0),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);var j=this.cache.getShader(a,x3dom.shader.BLUR);this.stateManager.useProgram(j),a.bindBuffer(a.ARRAY_BUFFER,b._webgl.ppBuffer),a.vertexAttribPointer(j.position,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(j.position),j.pixelSizeHor=1/e,j.pixelSizeVert=1/f,j.filterSize=d,j.horizontal=!0,j.texture=0,a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,c.tex),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.drawArrays(a.TRIANGLES,0,6),this.stateManager.bindFramebuffer(a.FRAMEBUFFER,c.fbo),a.clearColor(1,1,1,0),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),j.horizontal=!1,a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,g.tex),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.drawArrays(a.TRIANGLES,0,6),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),a.disableVertexAttribArray(j.position),a.flush(),this.stateManager.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),this.stateManager.bindFramebuffer(a.FRAMEBUFFER,null),this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height)}},b}(),x3dom.bridge={setFlashReady:function(a,b){var c=x3dom.canvases[b];c.isFlashReady=!0,x3dom.debug.logInfo("Flash is ready for rendering ("+a+")")},onMouseDown:function(a,b,c,d){var e=x3dom.canvases[d];e.doc.onMousePress(e.gl,a,b,c),e.doc.needRender=!0},onMouseUp:function(a,b,c,d){var e=x3dom.canvases[d];e.doc.onMouseRelease(e.gl,a,b,c),e.doc.needRender=!0},onMouseOver:function(a,b,c,d){var e=x3dom.canvases[d];e.doc.onMouseOver(e.gl,a,b,c),e.doc.needRender=!0},onMouseOut:function(a,b,c,d){var e=x3dom.canvases[d];e.doc.onMouseOut(e.gl,a,b,c),e.doc.needRender=!0},onDoubleClick:function(a,b,c){var d=x3dom.canvases[c];d.doc.onDoubleClick(d.gl,a,b),d.doc.needRender=!0,x3dom.debug.logInfo("dblClick")},onMouseDrag:function(a,b,c,d){var e=x3dom.canvases[d];e.doc.onDrag(e.gl,a,b,c),e.doc.needRender=!0},onMouseMove:function(a,b,c,d){var e=x3dom.canvases[d];e.doc.onMove(e.gl,a,b,c),e.doc.needRender=!0},onMouseWheel:function(a,b,c,d){var e=x3dom.canvases[d];e.doc.onDrag(e.gl,a,b,c),e.doc.needRender=!0},onKeyDown:function(a,b){var c=x3dom.canvases[b],d=c.x3dElem.getAttribute("keysEnabled");d&&"true"!==d.toLowerCase()||c.doc.onKeyPress(a),c.doc.needRender=!0},setBBox:function(a){x3dom.nodeTypes.Shape.idMap.nodeID[a]},setShapeDirty:function(a){var b=x3dom.nodeTypes.Shape.idMap.nodeID[a];b.setAllDirty()}},x3dom.gfx_flash=function(){function a(a,b,c){this.object=a,this.name=b,this.isAlreadySet=!1,this.renderType=c}function b(b,c){return x3dom.Utils.maxIndexableCoords=65535,new a(b,"flash",c)}return a.prototype.getName=function(){return this.name},a.prototype.renderScene=function(a){var b=a._scene,c=x3dom.fields.SFVec3f.MAX(),d=x3dom.fields.SFVec3f.MIN(),e=b.getVolume();e.getBounds(c,d),b._lastMin=c,b._lastMax=d,a._last_mat_view=x3dom.fields.SFMatrix4f.identity(),a._last_mat_proj=x3dom.fields.SFMatrix4f.identity(),a._last_mat_scene=x3dom.fields.SFMatrix4f.identity();var f=b.getViewpoint();(-1==f._vf.zNear||-1==f._vf.zFar)&&(f._vf.zFar=2e4,f._vf.zNear=.1);var g=a.getViewMatrix(),h=a.getProjectionMatrix(),i=h.mult(g);this.setupScene(b,a);var j=b.getBackground();this.setupBackground(j),b.drawableCollection=null;var k=b.getEnvironment(),l={viewArea:a,sortTrans:k._vf.sortTrans,viewMatrix:g,projMatrix:h,sceneMatrix:i,frustumCulling:!1,smallFeatureThreshold:!1,context:null,gl:null};b.drawableCollection=new x3dom.DrawableCollection(l),b.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),b.drawableCollection,!0,!1,0),b.drawableCollection.concat();var m=b.drawableCollection.length;if(m>0)for(var n=[],o=0;m>o;o++){var p=b.drawableCollection.get(o),q=p.transform,r=p.shape;void 0!=n[r._objectID]?n[r._objectID]++:n[r._objectID]=0,this.setupShape(r,q,n[r._objectID])}this.object.renderScene()},a.prototype.setupScene=function(a,b){var c=b.getViewMatrix();if(!b._last_mat_view.equals(c)){var d=b._scene.getViewpoint(),e="viewpointChanged";try{if(d._xmlNode&&(d._xmlNode["on"+e]||d._xmlNode.hasAttribute("on"+e)||d._listeners[e])){var f=d.getCurrentTransform();f=f.inverse().mult(c);var g=f.inverse(),h=new x3dom.fields.Quaternion(0,0,1,0),i=g.e3(),j={target:d._xmlNode,type:e,matrix:f,position:i,orientation:h.toAxisAngle(),cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};d.callEvtHandler(e,j)}}catch(k){x3dom.debug.logException(k)}}b._last_mat_view=c;var l=a.getViewpoint(),m=b.getProjectionMatrix();this.object.setViewpoint({fov:l._vf.fov,zFar:l._vf.zFar,zNear:l._vf.zNear,viewMatrix:c.toGL(),projectionMatrix:m.toGL()});var n=a.getNavigationInfo();if(n._vf.headlight&&this.object.setHeadLight({id:-1,on:1,color:[1,1,1],intensity:1,ambientIntensity:0,direction:[0,0,-1]}),"deferred"==this.renderType)for(var o=b.getLights(),p=0;p<o.length;p++)o[p]._dirty&&(x3dom.isa(o[p],x3dom.nodeTypes.DirectionalLight)?this.object.setDirectionalLight({id:o[p]._lightID,on:o[p]._vf.on,color:o[p]._vf.color.toGL(),intensity:o[p]._vf.intensity,ambientIntensity:o[p]._vf.ambientIntensity,direction:o[p]._vf.direction.toGL()}):x3dom.isa(o[p],x3dom.nodeTypes.PointLight)?(c.mult(o[p].getCurrentTransform()),this.object.setPointLight({id:o[p]._lightID,on:o[p]._vf.on,color:o[p]._vf.color.toGL(),intensity:o[p]._vf.intensity,ambientIntensity:o[p]._vf.ambientIntensity,attenuation:o[p]._vf.attenuation.toGL(),location:o[p]._vf.location.toGL(),radius:o[p]._vf.radius})):x3dom.isa(o[p],x3dom.nodeTypes.SpotLight),o[p]._dirty=!1)},a.prototype.setupBackground=function(a){a._dirty&&(this.object.setBackground({texURLs:a.getTexUrl(),skyAngle:a._vf.skyAngle,skyColor:a.getSkyColor().toGL(),groundAngle:a._vf.groundAngle,groundColor:a.getGroundColor().toGL(),transparency:a.getTransparency()}),a._dirty=!1)},a.prototype.setupShape=function(a,b,c){x3dom.isa(a._cf.geometry.node,x3dom.nodeTypes.PointSet)?x3dom.debug.logError("Flash backend doesn't support PointSets yet"):x3dom.isa(a._cf.geometry.node,x3dom.nodeTypes.IndexedLineSet)?x3dom.debug.logError("Flash backend doesn't support LineSets yet"):x3dom.isa(a._cf.geometry.node,x3dom.nodeTypes.Text)?this.setupText(a,b,c):this.setupIndexedFaceSet(a,b,c)},a.prototype.setupIndexedFaceSet=function(a,b,c){if(this.object.setMeshTransform({id:a._objectID,refID:c,transform:b.toGL()}),0==c){var d=x3dom.isa(a._cf.geometry.node,x3dom.nodeTypes.ImageGeometry),e=x3dom.isa(a._cf.geometry.node,x3dom.nodeTypes.BinaryGeometry),f=x3dom.isa(a._cf.geometry.node,x3dom.nodeTypes.BitLODGeometry),g=a._cf.appearance.node,h=g?a._cf.appearance.node._vf.sortType:"auto",i=g?a._cf.appearance.node._vf.sortKey:0;if(d?this.object.setMeshProperties({id:a._objectID,type:"ImageGeometry",sortType:h,sortKey:i,solid:a.isSolid(),bboxMin:a._cf.geometry.node.getMin().toGL(),bboxMax:a._cf.geometry.node.getMax().toGL(),bboxCenter:a._cf.geometry.node.getCenter().toGL(),primType:a._cf.geometry.node._vf.primType,vertexCount:a._cf.geometry.node._vf.vertexCount}):e?this.object.setMeshProperties({id:a._objectID,type:"BinaryGeometry",sortType:h,sortKey:i,solid:a.isSolid(),bgCenter:a._cf.geometry.node._vf.position.toGL(),bgSize:a._cf.geometry.node._vf.size.toGL(),bboxCenter:a._cf.geometry.node.getCenter().toGL(),primType:a._cf.geometry.node._vf.primType,vertexCount:a._cf.geometry.node._vf.vertexCount}):f?this.object.setMeshProperties({id:a._objectID,type:"BitLODGeometry",sortType:h,sortKey:i,solid:a.isSolid(),bboxMin:a._cf.geometry.node.getMin().toGL(),bboxMax:a._cf.geometry.node.getMax().toGL(),bboxCenter:a._cf.geometry.node.getCenter().toGL(),primType:a._cf.geometry.node._vf.primType,vertexCount:a._cf.geometry.node._vf.vertexCount}):this.object.setMeshProperties({id:a._objectID,type:"Default",sortType:h,sortKey:i,solid:a.isSolid()}),a._dirty.indexes===!0){if(d);else if(e)this.object.setMeshIndices({id:a._objectID,idx:0,indices:a._nameSpace.getURL(a._cf.geometry.node._vf.index)});else if(f)this.object.setMeshIndices({id:a._objectID,idx:0,indices:a._nameSpace.getURL(a._cf.geometry.node._vf.index)});else{a._cf.geometry.node._mesh._multiIndIndices&&a._cf.geometry.node._mesh._multiIndIndices.length&&a._cf.geometry.node._mesh.splitMesh(3,!0);for(var j=0;j<a._cf.geometry.node._mesh._indices.length;j++)this.object.setMeshIndices({id:a._objectID,idx:j,indices:a._cf.geometry.node._mesh._indices[j]})}a._dirty.indexes=!1}if(a._dirty.positions===!0){if(d)this.object.setMeshVertices({id:a._objectID,idx:0,coordinateTexture0:a._cf.geometry.node.getCoordinateTextureURL(0),coordinateTexture1:a._cf.geometry.node.getCoordinateTextureURL(1)});else if(e)this.object.setMeshVertices({id:a._objectID,idx:0,interleaved:a._cf.geometry.node._hasStrideOffset,vertices:a._nameSpace.getURL(a._cf.geometry.node._vf.coord),normals:a._nameSpace.getURL(a._cf.geometry.node._vf.normal),texCoords:a._nameSpace.getURL(a._cf.geometry.node._vf.texCoord),colors:a._nameSpace.getURL(a._cf.geometry.node._vf.color),numColorComponents:a._cf.geometry.node._mesh._numColComponents,numNormalComponents:a._cf.geometry.node._mesh._numNormComponents,vertexType:a._cf.geometry.node._vf.coordType,normalType:a._cf.geometry.node._vf.normalType,texCoordType:a._cf.geometry.node._vf.texCoordType,colorType:a._cf.geometry.node._vf.colorType,vertexStrideOffset:a._coordStrideOffset,normalStrideOffset:a._normalStrideOffset,texCoordStrideOffset:a._texCoordStrideOffset,colorStrideOffset:a._colorStrideOffset});
else if(f)this.object.setMeshVertices({id:a._objectID,componentURLs:a._cf.geometry.node.getComponentsURLs(),componentFormats:a._cf.geometry.node.getComponentFormats(),componentAttribs:a._cf.geometry.node.getComponentAttribs()});else for(var j=0;j<a._cf.geometry.node._mesh._positions.length;j++)this.object.setMeshVertices({id:a._objectID,idx:j,vertices:a._cf.geometry.node._mesh._positions[j]});a._dirty.positions=!1}if(a._dirty.normals===!0){if(d)this.object.setMeshNormals({id:a._objectID,idx:0,normalTexture:a._cf.geometry.node.getNormalTextureURL()});else if(e)a._cf.geometry.node._hasStrideOffset||this.object.setMeshNormals({id:a._objectID,idx:0,normals:a._nameSpace.getURL(a._cf.geometry.node._vf.normal)});else if(f);else if(a._cf.geometry.node._mesh._normals[0].length)for(var j=0;j<a._cf.geometry.node._mesh._normals.length;j++)this.object.setMeshNormals({id:a._objectID,idx:j,normals:a._cf.geometry.node._mesh._normals[j]});a._dirty.normals=!1}if(a._dirty.colors===!0){if(d)this.object.setMeshColors({id:a._objectID,idx:0,colorTexture:a._cf.geometry.node.getColorTextureURL(),components:a._cf.geometry.node._mesh._numColComponents});else if(e)a._cf.geometry.node._hasStrideOffset||this.object.setMeshColors({id:a._objectID,idx:0,colors:a._nameSpace.getURL(a._cf.geometry.node._vf.color),components:a._cf.geometry.node._mesh._numColComponents});else if(f);else if(a._cf.geometry.node._mesh._colors[0].length)for(var j=0;j<a._cf.geometry.node._mesh._colors.length;j++)this.object.setMeshColors({id:a._objectID,idx:j,colors:a._cf.geometry.node._mesh._colors[j],components:a._cf.geometry.node._mesh._numColComponents});a._dirty.colors=!1}if(a._dirty.texcoords===!0){if(d)this.object.setMeshTexCoords({id:a._objectID,idx:0,texCoordTexture:a._cf.geometry.node.getTexCoordTextureURL()});else if(e)a._cf.geometry.node._hasStrideOffset||this.object.setMeshTexCoords({id:a._objectID,idx:0,texCoords:a._nameSpace.getURL(a._cf.geometry.node._vf.texCoord)});else if(f);else if(a._cf.geometry.node._mesh._texCoords[0].length)for(var j=0;j<a._cf.geometry.node._mesh._texCoords.length;j++)this.object.setMeshTexCoords({id:a._objectID,idx:j,texCoords:a._cf.geometry.node._mesh._texCoords[j]});a._dirty.texcoords=!1}if(a._dirty.material===!0){if(g){var k=a._cf.appearance.node._cf.material.node;k&&this.object.setMeshMaterial({id:a._objectID,ambientIntensity:k._vf.ambientIntensity,diffuseColor:k._vf.diffuseColor.toGL(),emissiveColor:k._vf.emissiveColor.toGL(),shininess:k._vf.shininess,specularColor:k._vf.specularColor.toGL(),transparency:k._vf.transparency})}a._dirty.material=!1}if(a._dirty.texture===!0){if(g){var l=null;g._cf.textureTransform.node&&(l=g.texTransformMatrix().toGL());var m=a._cf.appearance.node._cf.texture.node;m?x3dom.isa(m,x3dom.nodeTypes.PixelTexture)?this.object.setPixelTexture({id:a._objectID,width:m._vf.image.width,height:m._vf.image.height,comp:m._vf.image.comp,pixels:m._vf.image.toGL()}):x3dom.isa(m,x3dom.nodeTypes.ComposedCubeMapTexture)?this.object.setCubeTexture({id:a._objectID,texURLs:m.getTexUrl()}):m._isCanvas&&m._canvas?this.object.setCanvasTexture({id:a._objectID,width:m._canvas.width,height:m._canvas.height,dataURL:m._canvas.toDataURL()}):x3dom.isa(m,x3dom.nodeTypes.MultiTexture)?x3dom.debug.logError("Flash backend doesn't support MultiTextures yet"):x3dom.isa(m,x3dom.nodeTypes.MovieTexture)?x3dom.debug.logError("Flash backend doesn't support MovieTextures yet"):this.object.setMeshTexture({id:a._objectID,origChannelCount:m._vf.origChannelCount,repeatS:m._vf.repeatS,repeatT:m._vf.repeatT,url:m._vf.url[0],transform:l}):this.object.removeTexture({id:a._objectID})}a._dirty.texture=!1}if(void 0!==a._cf.geometry.node._cf.texCoord&&null!==a._cf.geometry.node._cf.texCoord.node&&!x3dom.isa(a._cf.geometry.node._cf.texCoord.node,x3dom.nodeTypes.X3DTextureNode)&&a._cf.geometry.node._cf.texCoord.node._vf.mode){var n=a._cf.geometry.node._cf.texCoord.node._vf.mode;"sphere"==n.toLowerCase()?this.object.setSphereMapping({id:a._objectID,sphereMapping:1}):this.object.setSphereMapping({id:a._objectID,sphereMapping:0})}else this.object.setSphereMapping({id:a._objectID,sphereMapping:0})}},a.prototype.setupText=function(a,b,c){if(this.object.setMeshTransform({id:a._objectID,refID:c,transform:b.toGL()}),0==c){var d=a._cf.appearance.node,e=d?a._cf.appearance.node._vf.sortType:"auto",f=d?a._cf.appearance.node._vf.sortKey:0;if(a._dirty.text===!0){var g=a._cf.geometry.node._cf.fontStyle.node;null===g?this.object.setMeshProperties({id:a._objectID,type:"Text",sortType:e,sortKey:f,solid:a.isSolid(),text:a._cf.geometry.node._vf.string,fontFamily:["SERIF"],fontStyle:"PLAIN",fontAlign:"BEGIN",fontSize:32,fontSpacing:1,fontHorizontal:!0,fontLanguage:"",fontLeftToRight:!0,fontTopToBottom:!0}):this.object.setMeshProperties({id:a._objectID,type:"Text",sortType:e,sortKey:f,solid:a.isSolid(),text:a._cf.geometry.node._vf.string,fontFamily:g._vf.family.toString(),fontStyle:g._vf.style.toString(),fontAlign:g._vf.justify.toString(),fontSize:g._vf.size,fontSpacing:g._vf.spacing,fontHorizontal:g._vf.horizontal,fontLanguage:g._vf.language,fontLeftToRight:g._vf.leftToRight,fontTopToBottom:g._vf.topToBottom}),a._dirty.text=!1}if(a._dirty.material===!0){if(d){var h=a._cf.appearance.node._cf.material.node;h&&this.object.setMeshMaterial({id:a._objectID,ambientIntensity:h._vf.ambientIntensity,diffuseColor:h._vf.diffuseColor.toGL(),emissiveColor:h._vf.emissiveColor.toGL(),shininess:h._vf.shininess,specularColor:h._vf.specularColor.toGL(),transparency:h._vf.transparency})}a._dirty.material=!1}}},a.prototype.pickValue=function(a){var b=a._scene;if(null===this.object||null===b||void 0===b.drawableCollection||!b.drawableCollection||"box"===b._vf.pickMode.toLowerCase())return!1;var c="color"===b._vf.pickMode.toLowerCase()?1:"texcoord"===b._vf.pickMode.toLowerCase()?2:0,d=this.object.pickValue({pickMode:c});return d.objID>0?(a._pickingInfo.pickPos=new x3dom.fields.SFVec3f(d.pickPosX,d.pickPosY,d.pickPosZ),a._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[d.objID]):(a._pickingInfo.pickObj=null,a._pickingInfo.lastClickObj=null),!0},a.prototype.shutdown=function(){},b}(),x3dom.X3DDocument=function(a,b,c){this.canvas=a,this.ctx=b,this.properties=c,this.needRender=!0,this._x3dElem=null,this._scene=null,this._viewarea=null,this.downloadCount=0,this._nodeBag={timer:[],lights:[],clipPlanes:[],followers:[],trans:[],renderTextures:[],viewarea:[]},this.onload=function(){},this.onerror=function(){}},x3dom.X3DDocument.prototype.load=function(a,b){function c(){if(0===e.length)return f._setup(d[a],d,b),f.onload(),void 0;var g=e.shift();!x3dom.isX3DElement(g)||"x3d"!==g.localName.toLowerCase()&&"websg"!==g.localName.toLowerCase()||(d[g]=g,f._x3dElem=g,c())}var d={},e=[a],f=this;c()},x3dom.findScene=function(a){for(var b=[],c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];d&&d.localName&&"scene"===d.localName.toLowerCase()&&b.push(d)}return b.length>1?(x3dom.debug.logError("X3D element has more than one Scene child (has "+a.childNodes.length+")."),null):b[0]},x3dom.X3DDocument.prototype._setup=function(a){function b(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c]===b){a.splice(c,1);break}}function c(a){for(var e=a.childNodes,f=0,g=e.length;g>f;f++)c(e[f]);if(a._x3domNode){var h=a._x3domNode,i=h._nameSpace;if(x3dom.isa(h,x3dom.nodeTypes.X3DShapeNode))h._cleanupGLObjects&&h._cleanupGLObjects(!0),x3dom.nodeTypes.Shape.idMap.nodeID[h._objectID]&&delete x3dom.nodeTypes.Shape.idMap.nodeID[h._objectID];else if(x3dom.isa(h,x3dom.nodeTypes.TimeSensor))b(d._nodeBag.timer,h);else if(x3dom.isa(h,x3dom.nodeTypes.X3DLightNode))b(d._nodeBag.lights,h);else if(x3dom.isa(h,x3dom.nodeTypes.X3DFollowerNode))b(d._nodeBag.followers,h);else if(x3dom.isa(h,x3dom.nodeTypes.X3DTransformNode))b(d._nodeBag.trans,h);else if(x3dom.isa(h,x3dom.nodeTypes.RenderedTexture))b(d._nodeBag.renderTextures,h);else if(x3dom.isa(h,x3dom.nodeTypes.X3DBindableNode)){var j=h._stack;j&&(h.bind(!1),b(j._bindBag,h)),h._cleanupGLObjects&&h._cleanupGLObjects()}i&&i.removeNode(h._DEF),h._xmlNode=null,delete a._x3domNode}}var d=this,e={onAttrModified:function(a){"_x3domNode"in a.target&&(a.target._x3domNode.updateField(a.attrName,a.newValue),d.needRender=!0)},onNodeRemoved:function(a){var b=a.target;if(b)if("_x3domNode"in b.parentNode&&"_x3domNode"in b){var e=b.parentNode._x3domNode,f=b._x3domNode;e&&f&&(e.removeChild(f),e.nodeChanged(),c(b),d._viewarea&&d._viewarea._scene&&(d._viewarea._scene.nodeChanged(),d._viewarea._scene.updateVolume(),d.needRender=!0))}else if(b.localName&&"ROUTE"==b.localName.toUpperCase()&&b._nodeNameSpace){var g=b._nodeNameSpace.defMap[b.getAttribute("fromNode")],h=b._nodeNameSpace.defMap[b.getAttribute("toNode")];g&&h&&g.removeRoute(b.getAttribute("fromField"),h,b.getAttribute("toField"))}},onNodeInserted:function(a){var b=a.target,e=b.parentNode;if("_x3domNode"in e)if(e.tagName&&"inline"==e.tagName.toLowerCase());else{var f=e._x3domNode;if(f&&f._nameSpace&&b instanceof Element){c(b);var g=f._nameSpace.setupTree(b);f.addChild(g,b.getAttribute("containerField")),f.nodeChanged();var h=e.parentNode;h&&h._x3domNode&&h._x3domNode.nodeChanged(),d._viewarea&&d._viewarea._scene&&(d._viewarea._scene.nodeChanged(),d._viewarea._scene.updateVolume(),d.needRender=!0)}else x3dom.debug.logWarning("No _nameSpace in onNodeInserted")}}};a.addEventListener("DOMNodeRemoved",e.onNodeRemoved,!0),a.addEventListener("DOMNodeInserted",e.onNodeInserted,!0),x3dom.userAgentFeature.supportsDOMAttrModified===!0&&a.addEventListener("DOMAttrModified",e.onAttrModified,!0);var f=x3dom.findScene(a);this._bindableBag=new x3dom.BindableBag(this);var g=new x3dom.NodeNameSpace("scene",d),h=g.setupTree(f);this._scene=h,this._bindableBag.setRefNode(h),this._viewarea=new x3dom.Viewarea(this,h),this._viewarea._width=this.canvas.width,this._viewarea._height=this.canvas.height},x3dom.X3DDocument.prototype.advanceTime=function(a){var b=0;if(this._nodeBag.timer.length)for(b=0;b<this._nodeBag.timer.length;b++)this.needRender|=this._nodeBag.timer[b].tick(a);if(this._nodeBag.followers.length)for(b=0;b<this._nodeBag.followers.length;b++)this.needRender|=this._nodeBag.followers[b].tick(a);if(this._nodeBag.trans.length)for(b=0;b<this._nodeBag.trans.length;b++)this.needRender|=this._nodeBag.trans[b].tick(a);if(this._nodeBag.viewarea.length)for(b=0;b<this._nodeBag.viewarea.length;b++)this.needRender|=this._nodeBag.viewarea[b].tick(a)},x3dom.X3DDocument.prototype.render=function(a){a&&this._viewarea&&a.renderScene(this._viewarea)},x3dom.X3DDocument.prototype.onPick=function(a,b,c){a&&this._viewarea&&a.pickValue(this._viewarea,b,c,1)},x3dom.X3DDocument.prototype.onPickRect=function(a,b,c,d,e){return a&&this._viewarea?a.pickRect(this._viewarea,b,c,d,e):[]},x3dom.X3DDocument.prototype.onMove=function(a,b,c,d){a&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&a.pickValue(this._viewarea,b,c,d),this._viewarea.onMove(b,c,d))},x3dom.X3DDocument.prototype.onMoveView=function(a,b,c){a&&this._viewarea&&this._viewarea.onMoveView(b,c)},x3dom.X3DDocument.prototype.onDrag=function(a,b,c,d){a&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&a.pickValue(this._viewarea,b,c,d),this._viewarea.onDrag(b,c,d))},x3dom.X3DDocument.prototype.onMousePress=function(a,b,c,d){a&&this._viewarea&&(this._viewarea._scene.updateVolume(),a.pickValue(this._viewarea,b,c,d),this._viewarea.onMousePress(b,c,d))},x3dom.X3DDocument.prototype.onMouseRelease=function(a,b,c,d,e){if(a&&this._viewarea){var f=e<<8|d;a.pickValue(this._viewarea,b,c,f),this._viewarea.onMouseRelease(b,c,d,e)}},x3dom.X3DDocument.prototype.onMouseOver=function(a,b,c,d){a&&this._viewarea&&(a.pickValue(this._viewarea,b,c,d),this._viewarea.onMouseOver(b,c,d))},x3dom.X3DDocument.prototype.onMouseOut=function(a,b,c,d){a&&this._viewarea&&(a.pickValue(this._viewarea,b,c,d),this._viewarea.onMouseOut(b,c,d))},x3dom.X3DDocument.prototype.onDoubleClick=function(a,b,c){a&&this._viewarea&&this._viewarea.onDoubleClick(b,c)},x3dom.X3DDocument.prototype.onKeyDown=function(a){switch(a){case 37:this._viewarea.strafeLeft();break;case 38:this._viewarea.moveFwd();break;case 39:this._viewarea.strafeRight();break;case 40:this._viewarea.moveBwd()}},x3dom.X3DDocument.prototype.onKeyUp=function(a){var b=null;switch(a){case 13:x3dom.toggleFullScreen();break;case 27:window.history.back();break;case 33:b=this._scene.getViewpoint()._stack,b?b.switchTo("next"):x3dom.debug.logError("No valid ViewBindable stack.");break;case 34:b=this._scene.getViewpoint()._stack,b?b.switchTo("prev"):x3dom.debug.logError("No valid ViewBindable stack.");break;case 37:break;case 38:break;case 39:break;case 40:}},x3dom.X3DDocument.prototype.onKeyPress=function(a){var b=this._scene.getNavigationInfo(),c=this._scene.getEnvironment();switch(a){case 32:var d=this.canvas.parent.stateViewer;d&&d.display(),x3dom.debug.logInfo("a: show all | d: show helper buffers | s: small feature culling | t: light view | m: toggle render mode | c: frustum culling | p: intersect type | r: reset view | e: examine mode | f: fly mode | y: freefly mode | w: walk mode | h: helicopter mode | l: lookAt mode | o: lookaround | g: game mode | u: upright position | v: print viewpoint info | pageUp: next view | pageDown: prev. view | +: increase speed | -: decrease speed ");break;case 43:b._vf.speed=2*b._vf.speed,x3dom.debug.logInfo("Changed navigation speed to "+b._vf.speed);break;case 45:b._vf.speed=.5*b._vf.speed,x3dom.debug.logInfo("Changed navigation speed to "+b._vf.speed);break;case 51:x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor+=.5,x3dom.debug.logInfo("Changed POP error tolerance to "+x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor);break;case 52:x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor-=.5,x3dom.debug.logInfo("Changed POP error tolerance to "+x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor);break;case 54:b._vf.typeParams[1]+=1,b._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter height to "+b._vf.typeParams[1]);break;case 55:b._vf.typeParams[1]-=1,b._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter height to "+b._vf.typeParams[1]);break;case 56:b._vf.typeParams[0]-=.02,b._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter angle to "+b._vf.typeParams[0]);break;case 57:b._vf.typeParams[0]+=.02,b._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter angle to "+b._vf.typeParams[0]);break;case 97:this._viewarea.showAll();break;case 99:c._vf.frustumCulling=!c._vf.frustumCulling,x3dom.debug.logInfo("Viewfrustum culling "+(c._vf.frustumCulling?"on":"off"));break;case 100:void 0===this._viewarea._visDbgBuf&&(this._viewarea._visDbgBuf="true"===this._x3dElem.getAttribute("showLog")),this._viewarea._visDbgBuf=!this._viewarea._visDbgBuf,x3dom.debug.logContainer.style.display=1==this._viewarea._visDbgBuf?"block":"none";break;case 101:b.setType("examine",this._viewarea);break;case 102:b.setType("fly",this._viewarea);break;case 103:b.setType("game",this._viewarea);break;case 104:b.setType("helicopter",this._viewarea);break;case 108:b.setType("lookat",this._viewarea);break;case 109:this._viewarea._points=++this._viewarea._points%3;break;case 110:b.setType("turntable",this._viewarea);break;case 111:b.setType("lookaround",this._viewarea);break;case 112:switch(this._scene._vf.pickMode.toLowerCase()){case"idbuf":this._scene._vf.pickMode="color";break;case"color":this._scene._vf.pickMode="texCoord";break;case"texcoord":this._scene._vf.pickMode="box";break;default:this._scene._vf.pickMode="idBuf"}x3dom.debug.logInfo("Switch pickMode to '"+this._scene._vf.pickMode+"'.");break;case 114:this._viewarea.resetView();break;case 115:c._vf.smallFeatureCulling=!c._vf.smallFeatureCulling,x3dom.debug.logInfo("Small feature culling "+(c._vf.smallFeatureCulling?"on":"off"));break;case 116:this._nodeBag.lights.length>0&&this._viewarea.animateTo(this._viewarea.getLightMatrix()[0],this._scene.getViewpoint());break;case 117:this._viewarea.uprightView();break;case 118:var e=this;!function(){var a=e._viewarea._scene.getViewpoint(),b=e._viewarea.getViewMatrix().inverse(),c=new x3dom.fields.Quaternion(0,0,1,0);c.setValue(b);var d=c.toAxisAngle(),f=b.e3();x3dom.debug.logInfo('\n&lt;Viewpoint position="'+f.x.toFixed(5)+" "+f.y.toFixed(5)+" "+f.z.toFixed(5)+'" '+'orientation="'+d[0].x.toFixed(5)+" "+d[0].y.toFixed(5)+" "+d[0].z.toFixed(5)+" "+d[1].toFixed(5)+'" \n	'+'zNear="'+a.getNear().toFixed(5)+'" '+'zFar="'+a.getFar().toFixed(5)+'" '+'description="'+a._vf.description+'"&gt;'+"&lt;/Viewpoint&gt;")}();break;case 119:b.setType("walk",this._viewarea);break;case 121:b.setType("freefly",this._viewarea)}},x3dom.X3DDocument.prototype.shutdown=function(a){a&&a.shutdown(this._viewarea)},x3dom.MatrixMixer=function(a,b){0===arguments.length?(this._beginTime=0,this._endTime=1):(this._beginTime=a,this._endTime=b),this._beginMat=x3dom.fields.SFMatrix4f.identity(),this._beginInvMat=x3dom.fields.SFMatrix4f.identity(),this._beginLogMat=x3dom.fields.SFMatrix4f.identity(),this._endMat=x3dom.fields.SFMatrix4f.identity(),this._endLogMat=x3dom.fields.SFMatrix4f.identity()},x3dom.MatrixMixer.prototype.calcFraction=function(a){var b=(a-this._beginTime)/(this._endTime-this._beginTime);return(Math.sin(b*Math.PI-Math.PI/2)+1)/2},x3dom.MatrixMixer.prototype.setBeginMatrix=function(a){this._beginMat.setValues(a),this._beginInvMat=a.inverse(),this._beginLogMat=x3dom.fields.SFMatrix4f.zeroMatrix()},x3dom.MatrixMixer.prototype.setEndMatrix=function(a){this._endMat.setValues(a),this._endLogMat=a.mult(this._beginInvMat).log(),this._logDiffMat=this._endLogMat.addScaled(this._beginLogMat,-1)},x3dom.MatrixMixer.prototype.mix=function(a){var b=null;if(a<=this._beginTime)b=x3dom.fields.SFMatrix4f.copy(this._beginLogMat);else if(a>=this._endTime)b=x3dom.fields.SFMatrix4f.copy(this._endLogMat);else{var c=this.calcFraction(a);b=this._logDiffMat.multiply(c).add(this._beginLogMat)}return b.exp().mult(this._beginMat)},x3dom.Viewarea=function(a,b){this._doc=a,this._scene=b,a._nodeBag.viewarea.push(this),this._pickingInfo={pickPos:new x3dom.fields.SFVec3f(0,0,0),pickNorm:new x3dom.fields.SFVec3f(0,0,1),pickObj:null,firstObj:null,lastObj:null,lastClickObj:null,shadowObjectId:-1},this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0,this._deltaT=0,this._pitch=0,this._yaw=0,this._eyePos=new x3dom.fields.SFVec3f(0,0,0),this._width=400,this._height=300,this._dx=0,this._dy=0,this._lastX=-1,this._lastY=-1,this._pressX=-1,this._pressY=-1,this._lastButton=0,this._points=0,this._numRenderedNodes=0,this._pick=new x3dom.fields.SFVec3f(0,0,0),this._pickNorm=new x3dom.fields.SFVec3f(0,0,1),this._isAnimating=!1,this._isMoving=!1,this._lastTS=0,this._mixer=new x3dom.MatrixMixer,this.arc=null},x3dom.Viewarea.prototype.tick=function(a){var b=!1,c=this._scene.getEnvironment();if(c._vf.enableARC&&null==this.arc&&(this.arc=new x3dom.arc.AdaptiveRenderControl(this._scene)),this._mixer._beginTime>0)if(b=!0,a>=this._mixer._beginTime)if(a<=this._mixer._endTime){var d=this._mixer.mix(a);this._scene.getViewpoint().setView(d)}else this._mixer._beginTime=0,this._mixer._endTime=0,this._scene.getViewpoint().setView(this._mixer._endMat);else this._mixer._beginTime=0,this._mixer._endTime=0,this._scene.getViewpoint().setView(this._mixer._beginMat);var e=this.navigateTo(a),f=this._isAnimating;return this._lastTS=a,this._isAnimating=b||e,null!=this.arc&&this.arc.update(this.isMovingOrAnimating()?1:0,this._doc._x3dElem.runtime.getFPS()),this._isAnimating||f},x3dom.Viewarea.prototype.isMoving=function(){return this._isMoving},x3dom.Viewarea.prototype.isAnimating=function(){return this._isAnimating},x3dom.Viewarea.prototype.isMovingOrAnimating=function(){return this._isMoving||this._isAnimating},x3dom.Viewarea.prototype.navigateTo=function(a){var b=this._scene.getNavigationInfo(),c=b.getType(),d="game"===c||this._lastButton>0&&(c.indexOf("fly")>=0||"walk"===c||"helicopter"===c||"looka"===c.substr(0,5));if(this._deltaT=a-this._lastTS,d){var e=.25,f=1.6,g=.75;b._vf.avatarSize.length>2&&(e=b._vf.avatarSize[0],f=b._vf.avatarSize[1],g=b._vf.avatarSize[2]);var h=this.getViewMatrix(),i=0,j=2&this._lastButton?-1:1;j*=this._deltaT*b._vf.speed;var k=Math.PI*this._deltaT*(this._pressX-this._lastX)/this._width,l=Math.PI*this._deltaT*(this._pressY-this._lastY)/this._height;if(this._needNavigationMatrixUpdate===!0){this._needNavigationMatrixUpdate=!1,this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0);var m=0,n=Math.asin(h._02),o=Math.cos(n);Math.abs(o)>1e-4&&(m=Math.atan2(-h._12/o,h._22/o)),this._flyMat=h.inverse(),this._from=this._flyMat.e3(),this._at=this._from.subtract(this._flyMat.e2()),"helicopter"===c&&(this._at.y=this._from.y),this._up="looka"!==c.substr(0,5)?new x3dom.fields.SFVec3f(0,1,0):this._flyMat.e1(),this._pitch=180*m/Math.PI,this._yaw=180*n/Math.PI,this._eyePos=this._from.negate()}var p,q,r,s,t,u,v=null,w=null,x=null;if("game"===c){this._pitch+=this._dy,this._yaw+=this._dx,this._pitch>=89&&(this._pitch=89),this._pitch<=-89&&(this._pitch=-89),this._yaw>=360&&(this._yaw-=360),this._yaw<0&&(this._yaw=360+this._yaw),this._dx=0,this._dy=0;var y=x3dom.fields.SFMatrix4f.rotationX(this._pitch/180*Math.PI),z=x3dom.fields.SFMatrix4f.rotationY(this._yaw/180*Math.PI),A=x3dom.fields.SFMatrix4f.translation(this._eyePos);this._flyMat=y.mult(z).mult(A);var B=this._flyMat.inverse(),C=B.e3();return w=new x3dom.fields.SFVec3f(0,-1,0),v=C.add(w),w=B.e0().cross(w).normalize(),x=x3dom.fields.SFMatrix4f.lookAt(C,v,w),x=x.inverse(),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton,x,this.getProjectionMatrix().mult(x)),this._pickingInfo.pickObj&&(i=this._pickingInfo.pickPos.subtract(C).length(),C.y+=f-i,B.setTranslate(C),this._eyePos=B.e3().negate(),this._flyMat=B.inverse(),this._pickingInfo.pickObj=null),this._scene.getViewpoint().setView(this._flyMat),d}if("helicopter"===c){var D=b.getTypeParams();if(2&this._lastButton){var E=this._deltaT*this._deltaT*b._vf.speed;E*=.1*(this._pressY-this._lastY)*Math.abs(this._pressY-this._lastY),D[1]+=E,b.setTypeParams(D)}1&this._lastButton?j*=.01*(this._pressY-this._lastY)*Math.abs(this._pressY-this._lastY):j=0,l=D[0],this._from.y=D[1],this._at.y=this._from.y,p=x3dom.fields.Quaternion.axisAngle(this._up,k),q=p.toMatrix(),r=x3dom.fields.SFMatrix4f.translation(this._from),r=r.mult(q),q=x3dom.fields.SFMatrix4f.translation(this._from.negate()),r=r.mult(q),this._at=r.multMatrixPnt(this._at),s=this._at.subtract(this._from).normalize(),t=s.cross(this._up).normalize(),u=t.cross(s).normalize(),s=s.multiply(j),this._from=this._from.add(s),this._at=this._at.add(s),p=x3dom.fields.Quaternion.axisAngle(t,l),q=p.toMatrix(),r=x3dom.fields.SFMatrix4f.translation(this._from),r=r.mult(q),q=x3dom.fields.SFMatrix4f.translation(this._from.negate()),r=r.mult(q);var F=r.multMatrixPnt(this._at);return this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,F,u),this._scene.getViewpoint().setView(this._flyMat.inverse()),d}if(p=x3dom.fields.Quaternion.axisAngle(this._up,k),q=p.toMatrix(),r=x3dom.fields.SFMatrix4f.translation(this._from),r=r.mult(q),q=x3dom.fields.SFMatrix4f.translation(this._from.negate()),r=r.mult(q),this._at=r.multMatrixPnt(this._at),s=this._at.subtract(this._from).normalize(),t=s.cross(this._up).normalize(),u=t.cross(s).normalize(),p=x3dom.fields.Quaternion.axisAngle(t,l),q=p.toMatrix(),r=x3dom.fields.SFMatrix4f.translation(this._from),r=r.mult(q),q=x3dom.fields.SFMatrix4f.translation(this._from.negate()),r=r.mult(q),this._at=r.multMatrixPnt(this._at),"looka"!==c.substr(0,5)){var G=this.getProjectionMatrix();"freefly"!==c&&(0>j?(x=new x3dom.fields.SFMatrix4f,x.setValue(this._last_mat_view.e0(),this._last_mat_view.e1(),this._last_mat_view.e2().negate(),this._last_mat_view.e3()),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton,x,G.mult(x))):this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton),this._pickingInfo.pickObj&&(i=this._pickingInfo.pickPos.subtract(this._from).length(),e>=i&&(j=0))),s=this._at.subtract(this._from).normalize().multiply(j),this._at=this._at.add(s),this._from=this._from.add(s),"walk"===c&&(v=this._from.addScaled(u,-1),w=t.cross(u.negate()).normalize(),x=x3dom.fields.SFMatrix4f.lookAt(this._from,v,w),x=x.inverse(),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton,x,G.mult(x)),this._pickingInfo.pickObj&&(i=this._pickingInfo.pickPos.subtract(this._from).length(),this._at=this._at.add(u.multiply(f-i)),this._from=this._from.add(u.multiply(f-i)))),this._pickingInfo.pickObj=null}this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,u),this._scene.getViewpoint().setView(this._flyMat.inverse())}return d},x3dom.Viewarea.prototype.moveFwd=function(){var a=this._scene.getNavigationInfo();if("game"===a.getType()){var b=.25,c=1.6;a._vf.avatarSize.length>2&&(b=a._vf.avatarSize[0],c=a._vf.avatarSize[1]);var d=5*this._deltaT*a._vf.speed,e=this._yaw/180*Math.PI,f=this._pitch/180*Math.PI,g=0,h=this._flyMat.inverse();this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton),this._pickingInfo.pickObj&&(g=this._pickingInfo.pickPos.subtract(h.e3()).length(),2*b>=g||(this._eyePos.x-=Math.sin(e)*d,this._eyePos.z+=Math.cos(e)*d,this._eyePos.y+=Math.sin(f)*d))}},x3dom.Viewarea.prototype.moveBwd=function(){var a=this._scene.getNavigationInfo();if("game"===a.getType()){var b=5*this._deltaT*a._vf.speed,c=this._yaw/180*Math.PI,d=this._pitch/180*Math.PI;this._eyePos.x+=Math.sin(c)*b,this._eyePos.z-=Math.cos(c)*b,this._eyePos.y-=Math.sin(d)*b}},x3dom.Viewarea.prototype.strafeRight=function(){var a=this._scene.getNavigationInfo();if("game"===a.getType()){var b=5*this._deltaT*a._vf.speed,c=this._yaw/180*Math.PI;this._eyePos.x-=Math.cos(c)*b,this._eyePos.z-=Math.sin(c)*b}},x3dom.Viewarea.prototype.strafeLeft=function(){var a=this._scene.getNavigationInfo();if("game"===a.getType()){var b=5*this._deltaT*a._vf.speed,c=this._yaw/180*Math.PI;this._eyePos.x+=Math.cos(c)*b,this._eyePos.z+=Math.sin(c)*b}},x3dom.Viewarea.prototype.animateTo=function(a,b,c){var d=this._scene.getNavigationInfo();x3dom.isa(a,x3dom.nodeTypes.X3DViewpointNode)&&(a=a.getViewMatrix().mult(a.getCurrentTransform().inverse())),"teleport"!==d._vf.transitionType[0].toLowerCase()&&"game"!==d.getType()?b&&x3dom.isa(b,x3dom.nodeTypes.X3DViewpointNode)?(b=b.getViewMatrix().mult(b.getCurrentTransform().inverse()).mult(this._transMat).mult(this._rotMat),this._mixer._beginTime=this._lastTS,this._mixer._endTime=arguments.length>=3?this._lastTS+c:this._lastTS+d._vf.transitionTime,this._mixer.setBeginMatrix(b),this._mixer.setEndMatrix(a),this._scene.getViewpoint().setView(b)):this._scene.getViewpoint().setView(a):this._scene.getViewpoint().setView(a),this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.getLights=function(){for(var a=[],b=0;b<this._doc._nodeBag.lights.length;b++)1==this._doc._nodeBag.lights[b]._vf.on&&a.push(this._doc._nodeBag.lights[b]);return a},x3dom.Viewarea.prototype.getLightsShadow=function(){for(var a=this._doc._nodeBag.lights,b=0;b<a.length;b++)if(a[b]._vf.shadowIntensity>0)return!0;return!1},x3dom.Viewarea.prototype.updateSpecialNavigation=function(a,b){var c=this._scene.getNavigationInfo(),d=c.getType();if("helicopter"==d&&!c._heliUpdated){var e=c.getTypeParams(),f=e[0],g=a.getViewMatrix().mult(b.inverse()).inverse();this._from=g.e3(),this._at=this._from.subtract(g.e2()),this._up=new x3dom.fields.SFVec3f(0,1,0),this._from.y=e[1],this._at.y=this._from.y;var h=g.e0(),i=x3dom.fields.Quaternion.axisAngle(h,f),j=i.toMatrix(),k=x3dom.fields.SFMatrix4f.translation(this._from);k=k.mult(j),j=x3dom.fields.SFMatrix4f.translation(this._from.negate()),k=k.mult(j),this._at=k.multMatrixPnt(this._at),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,this._up),this._scene.getViewpoint().setView(this._flyMat.inverse()),c._heliUpdated=!0}},x3dom.Viewarea.prototype.getViewpointMatrix=function(){var a=this._scene.getViewpoint(),b=a.getCurrentTransform();return this.updateSpecialNavigation(a,b),a.getViewMatrix().mult(b.inverse())},x3dom.Viewarea.prototype.getViewMatrix=function(){return this.getViewpointMatrix().mult(this._transMat).mult(this._rotMat)},x3dom.Viewarea.prototype.getLightMatrix=function(){var a,b=this._doc._nodeBag.lights,c=b.length;if(c>0){var d=this._scene.getVolume();if(d.isValid()){var e=x3dom.fields.SFVec3f.MAX(),f=x3dom.fields.SFVec3f.MIN();d.getBounds(e,f);var g=[],h=this._scene.getViewpoint(),i=h.getFieldOfView(),j=f.subtract(e),k=j.y/2/Math.tan(i/2)+j.z/2,l=j.x/2/Math.tan(i/2)+j.z/2;for(j=e.add(j.multiply(.5)),a=0;c>a;a++){if(x3dom.isa(b[a],x3dom.nodeTypes.PointLight)){var m=b[a].getCurrentTransform().multMatrixPnt(b[a]._vf.location);j=j.subtract(m).normalize()}else{var n=b[a].getCurrentTransform().multMatrixVec(b[a]._vf.direction);n=n.normalize().negate(),j=j.add(n.multiply(1.2*(k>l?k:l)))}g[a]=b[a].getViewMatrix(j)}return g}}return[this.getViewMatrix()]},x3dom.Viewarea.prototype.getWCtoLCMatrix=function(a){var b,c=this.getProjectionMatrix();return b=0===arguments.length?this.getLightMatrix()[0]:a,c.mult(b)},x3dom.Viewarea.prototype.getWCtoLCMatricesPointLight=function(a,b,c){var d=b._vf.zNear,e=b._vf.zFar,f=this.getLightProjectionMatrix(a,d,e,!1,c);f._00=1,f._11=1;var g=[];g[0]=f.mult(a);for(var h,i=1;3>=i;i++)h=x3dom.fields.SFMatrix4f.rotationY(i*Math.PI/2),g[i]=f.mult(h.mult(a));return h=x3dom.fields.SFMatrix4f.rotationX(Math.PI/2),g[4]=f.mult(h.mult(a)),h=x3dom.fields.SFMatrix4f.rotationX(3*Math.PI/2),g[5]=f.mult(h.mult(a)),g},x3dom.Viewarea.prototype.getWCtoLCMatricesCascaded=function(a,b,c){var d=Math.max(1,Math.min(b._vf.shadowCascades,6)),e=Math.max(0,Math.min(b._vf.shadowSplitFactor,1)),f=Math.max(0,Math.min(b._vf.shadowSplitOffset,1)),g=x3dom.isa(b,x3dom.nodeTypes.SpotLight),h=b._vf.zNear,i=b._vf.zFar,j=this.getLightProjectionMatrix(a,h,i,!0,c);g&&(j._00=1,j._11=1);var k=j.mult(a),l=[];if(1==d)return l[0]=k,l;for(var m=this.getShadowSplitDepths(d,e,f,!0,c),n=0;d>n;n++){var o=this.getLightFittingMatrix(k,m[n],m[n+1],c);l[n]=o.mult(k)}return l},x3dom.Viewarea.prototype.getLightProjectionMatrix=function(a,b,c,d,e){var f=x3dom.fields.SFMatrix4f.copy(e);if(!d||b>0||c>0){var g,h,i=a.inverse().e3(),j=.8,k=1.2,l=x3dom.fields.SFVec3f.copy(this._scene._lastMin),m=x3dom.fields.SFVec3f.copy(this._scene._lastMax),n=m.subtract(l),o=n.length()/2,p=l.add(n.multiply(.5)),q=i.subtract(p).length();return o&&(g=q>o?(q-o)*j:1,h=(q+o)*k),b>0&&(g=b),c>0&&(h=c),f._22=-(h+g)/(h-g),f._23=-2*h*g/(h-g),f}var r=this.getLightCropMatrix(f.mult(a));return r.mult(f)},x3dom.Viewarea.prototype.getProjectionMatrix=function(){var a=this._scene.getViewpoint();return a.getProjectionMatrix(this._width/this._height)},x3dom.Viewarea.prototype.getViewfrustum=function(a){var b=this._scene.getEnvironment();if(1==b._vf.frustumCulling){if(0==arguments.length){var c=this.getProjectionMatrix(),d=this.getViewMatrix();return new x3dom.fields.FrustumVolume(c.mult(d))}return new x3dom.fields.FrustumVolume(a)}return null},x3dom.Viewarea.prototype.getWCtoCCMatrix=function(){var a=this.getViewMatrix(),b=this.getProjectionMatrix();return b.mult(a)},x3dom.Viewarea.prototype.getCCtoWCMatrix=function(){var a=this.getWCtoCCMatrix();return a.inverse()},x3dom.Viewarea.prototype.calcViewRay=function(a,b,c){var d=c?c:this.getCCtoWCMatrix(),e=2*(a/(this._width-1))-1,f=2*((this._height-1-b)/(this._height-1))-1,g=d.multFullMatrixPnt(new x3dom.fields.SFVec3f(e,f,-1)),h=d.multFullMatrixPnt(new x3dom.fields.SFVec3f(e,f,1)),i=h.subtract(g);return new x3dom.fields.Line(g,i)},x3dom.Viewarea.prototype.showAll=function(a){void 0===a&&(a="negZ");var b=this._scene;b.updateVolume();var c,d=x3dom.fields.SFVec3f.copy(b._lastMin),e=x3dom.fields.SFVec3f.copy(b._lastMax),f="x",g="y",h="z",i=1,j=new x3dom.fields.SFVec3f(0,0,-1);
switch(a){case"posX":i=-1;case"negX":h="x",f="y",g="z",c=new x3dom.fields.SFVec3f(i,0,0);break;case"posY":i=-1;case"negY":h="y",f="z",g="x",c=new x3dom.fields.SFVec3f(0,i,0);break;case"posZ":i=-1;case"negZ":default:c=new x3dom.fields.SFVec3f(0,0,-i)}var k=b.getViewpoint(),l=k.getFieldOfView(),m=e.subtract(d),n=m[h]/2,o=Math.tan(l/2),p=m[g]/2/o+n,q=m[f]/2/o+n;m=d.add(m.multiply(.5)),m[h]+=1.01*i*(p>q?p:q);var r=x3dom.fields.Quaternion.rotateFromTo(j,c),s=r.toMatrix();s=s.mult(x3dom.fields.SFMatrix4f.translation(m.negate())),this.animateTo(s,k)},x3dom.Viewarea.prototype.fit=function(a,b,c){void 0===c&&(c=!0);var d=this._scene,e=b.subtract(a).multiply(.5),f=a.add(e),g=a.subtract(f).length(),h=d.getViewpoint(),i=h.getFieldOfView(),j=Math.tan(i/2),k=x3dom.fields.SFMatrix4f.copy(this.getViewMatrix()),l=new x3dom.fields.SFVec3f(k._00,k._01,k._02),m=new x3dom.fields.SFVec3f(k._10,k._11,k._12),n=new x3dom.fields.SFVec3f(k._20,k._21,k._22),o=g/j,p=f,q=p.add(n.multiply(o));k._03=-l.dot(q),k._13=-m.dot(q),k._23=-n.dot(q),c&&(h._vf.centerOfRotation=f),this.animateTo(k,h)},x3dom.Viewarea.prototype.resetView=function(){var a=this._scene.getNavigationInfo();if("teleport"!==a._vf.transitionType[0].toLowerCase()&&"game"!==a.getType()){this._mixer._beginTime=this._lastTS,this._mixer._endTime=this._lastTS+a._vf.transitionTime,this._mixer.setBeginMatrix(this.getViewMatrix());var b=this._scene.getViewpoint();b.resetView(),b=b.getViewMatrix().mult(b.getCurrentTransform().inverse()),this._mixer.setEndMatrix(b)}else this._scene.getViewpoint().resetView();this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0,a._heliUpdated=!1},x3dom.Viewarea.prototype.uprightView=function(){var a=this.getViewMatrix().inverse(),b=a.e3(),c=b.subtract(a.e2()),d=new x3dom.fields.SFVec3f(0,1,0),e=a.e2().cross(d).normalize(),f=e.cross(d).normalize();c=b.add(f),a=x3dom.fields.SFMatrix4f.lookAt(b,c,d),a=a.inverse(),this.animateTo(a,this._scene.getViewpoint())},x3dom.Viewarea.prototype.callEvtHandler=function(a,b,c){if(!a||!a._xmlNode)return null;c.target=a._xmlNode;var d=a._xmlNode[b];try{if("function"==typeof d)d.call(a._xmlNode,c);else{var e=a._xmlNode.getAttribute(b),f=new Function("event",e);f.call(a._xmlNode,c)}var g=a._listeners[c.type];if(g)for(var h=0;h<g.length;h++)g[h].call(a._xmlNode,c)}catch(i){x3dom.debug.logException(i)}return c.cancelBubble},x3dom.Viewarea.prototype.checkEvents=function(a,b,c,d,e){var f=this,g=!0,h={target:{},type:e.substr(2,e.length-2),button:d,layerX:b,layerY:c,worldX:f._pick.x,worldY:f._pick.y,worldZ:f._pick.z,normalX:f._pickNorm.x,normalY:f._pickNorm.y,normalZ:f._pickNorm.z,hitPnt:f._pick.toGL(),hitObject:a&&a._xmlNode?a._xmlNode:null,shadowObjectId:f._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};try{var i=a;i&&i._xmlNode&&i._cf.geometry&&!i._xmlNode[e]&&!i._xmlNode.hasAttribute(e)&&!i._listeners[h.type]&&(i=i._cf.geometry.node),i&&f.callEvtHandler(i,e,h)===!0&&(g=!1)}catch(j){x3dom.debug.logException(j)}var k=function(a){Array.forEach(a._parentNodes,function(a){a._xmlNode&&(a._xmlNode[e]||a._xmlNode.hasAttribute(e)||a._listeners[h.type])&&f.callEvtHandler(a,e,h)===!0&&(g=!1),x3dom.isa(a,x3dom.nodeTypes.Anchor)&&"onclick"===e?(a.handleTouch(),g=!1):g&&k(a)})};return g&&a&&k(a),g},x3dom.Viewarea.prototype.initMouseState=function(){this._deltaT=0,this._dx=0,this._dy=0,this._lastX=-1,this._lastY=-1,this._pressX=-1,this._pressY=-1,this._lastButton=0,this._isMoving=!1,this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.onMousePress=function(a,b,c){this._needNavigationMatrixUpdate=!0,this.prepareEvents(a,b,c,"onmousedown"),this._pickingInfo.lastClickObj=this._pickingInfo.pickObj,this._pickingInfo.firstObj=this._pickingInfo.pickObj,this._dx=0,this._dy=0,this._lastX=a,this._lastY=b,this._pressX=a,this._pressY=b,this._lastButton=c,this._isMoving=!1;var d=this._scene.getNavigationInfo(),e=d.getType();if("turntable"===e){var f=this.getViewMatrix(),g=this._scene.getViewpoint(),h=x3dom.fields.SFVec3f.copy(g.getCenterOfRotation());this._flyMat=f.inverse(),this._from=this._flyMat.e3(),this._at=h,this._up=this._flyMat.e1(),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,this._up);var i=.2/d._vf.speed;this.animateTo(this._flyMat.inverse(),g,i)}},x3dom.Viewarea.prototype.onMouseRelease=function(a,b,c,d){var e,f=3,g=this._scene.getNavigationInfo(),h=g.getType();if("box"!==this._scene._vf.pickMode.toLowerCase()){if(this.prepareEvents(a,b,d,"onmouseup"),this._pickingInfo.pickObj&&this._pickingInfo.pickObj===this._pickingInfo.lastClickObj)this.prepareEvents(a,b,d,"onclick");else if(!this._pickingInfo.pickObj&&!this._pickingInfo.lastClickObj&&!this._pickingInfo.firstObj){var i="backgroundClicked";try{if(this._scene._xmlNode&&(this._scene._xmlNode["on"+i]||this._scene._xmlNode.hasAttribute("on"+i)||this._scene._listeners[i])){var j={target:{},type:i,button:d,layerX:a,layerY:b,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};this._scene.callEvtHandler("on"+i,j)}}catch(k){x3dom.debug.logException("backgroundClicked: "+k)}}}else{var l=(new Date).getTime(),m=this.calcViewRay(a,b),n=this._scene.doIntersect(m),o=m.hitObject;n&&o&&(this._pick.setValues(m.hitPoint),this.checkEvents(o,a,b,c,"onclick"),x3dom.debug.logInfo("Hit '"+o._xmlNode.localName+"/ "+o._DEF+"' at dist="+m.dist.toFixed(4)),x3dom.debug.logInfo("Ray hit at position "+this._pick));var p=(new Date).getTime()-l;if(x3dom.debug.logInfo("Picking time (box): "+p+"ms"),!n){e=this.getViewMatrix().e2().negate();var q=e.dot(m.pos.negate())/e.dot(m.dir);this._pick=m.pos.add(m.dir.multiply(q))}}if(this._pickingInfo.firstObj=null,(this._pickingInfo.pickObj||this._pickingInfo.shadowObjectId>=0)&&"lookat"===h&&this._pressX===a&&this._pressY===b){var r=2&this._lastButton?-1:1,s=this._pickingInfo.pickPos.subtract(this._from).length()/f,t=new x3dom.fields.SFMatrix4f;t.setValues(this.getViewMatrix()),t=t.inverse();var u=t.e3();u.subtract(t.e2());var v=t.e1();e=this._pickingInfo.pickPos.subtract(u);var w=e.length();e=e.normalize();var x=u.addScaled(e,w),y=e.cross(v).normalize();e=y.cross(v).normalize(),0>r&&(s=2*(.5+w+s));var z=x.addScaled(e,s);t=x3dom.fields.SFMatrix4f.lookAt(z,x,v),t=t.inverse(),s=z.subtract(u).length();var A=Math.max(.5,Math.log((1+s)/g._vf.speed));this.animateTo(t,this._scene.getViewpoint(),A)}this._dx=0,this._dy=0,this._lastX=a,this._lastY=b,this._lastButton=c,this._isMoving=!1},x3dom.Viewarea.prototype.onMouseOver=function(a,b){this._dx=0,this._dy=0,this._lastButton=0,this._isMoving=!1,this._lastX=a,this._lastY=b,this._deltaT=0},x3dom.Viewarea.prototype.onMouseOut=function(a,b){this._dx=0,this._dy=0,this._lastButton=0,this._isMoving=!1,this._lastX=a,this._lastY=b,this._deltaT=0},x3dom.Viewarea.prototype.onDoubleClick=function(){if("true"!==this._doc.properties.getProperty("disableDoubleClick","false")){var a=this._scene.getNavigationInfo();if("none"!=a.getType()){var b=this._scene._vf.pickMode.toLowerCase();if("color"!=b&&"texcoord"!=b){var c=this._scene.getViewpoint();c._vf.centerOfRotation?c._vf.centerOfRotation.setValues(this._pick):c._centerOfRotation.setValues(this._pick),x3dom.debug.logInfo("New center of Rotation:  "+this._pick);var d=this.getViewMatrix().inverse(),e=d.e3(),f=this._pick,g=d.e1(),h=d.e0().cross(g).normalize(),i=h.dot(this._pick.subtract(e));e=f.addScaled(h,-i),d=x3dom.fields.SFMatrix4f.lookAt(e,f,g),x3dom.debug.logInfo("New camera position:  "+e),this.animateTo(d.inverse(),c)}}}},x3dom.Viewarea.prototype.handleMoveEvt=function(a,b,c){if(this.prepareEvents(a,b,c,"onmousemove"),this._pickingInfo.pickObj!==this._pickingInfo.lastObj){if(this._pickingInfo.lastObj){var d=this._pickingInfo.pickObj;this._pickingInfo.pickObj=this._pickingInfo.lastObj,this.prepareEvents(a,b,c,"onmouseout"),this._pickingInfo.pickObj=d}this._pickingInfo.pickObj&&this.prepareEvents(a,b,c,"onmouseover"),this._pickingInfo.lastObj=this._pickingInfo.pickObj}},x3dom.Viewarea.prototype.onMove=function(a,b,c){this.handleMoveEvt(a,b,c),(this._lastX<0||this._lastY<0)&&(this._lastX=a,this._lastY=b),this._dx=a-this._lastX,this._dy=b-this._lastY,this._lastX=a,this._lastY=b},x3dom.Viewarea.prototype.onMoveView=function(a,b){var c=this._scene.getNavigationInfo(),d=this._scene.getViewpoint();if("examine"===c.getType()){if(a){var e=this._scene._lastMax.subtract(this._scene._lastMin).length();e=(e<x3dom.fields.Eps?1:e)*c._vf.speed,a=a.multiply(e),this._movement=this._movement.add(a),this._transMat=d.getViewMatrix().inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(d.getViewMatrix())}if(b){var f=d.getCenterOfRotation(),g=this.getViewMatrix();g.setTranslate(new x3dom.fields.SFVec3f(0,0,0)),this._rotMat=this._rotMat.mult(x3dom.fields.SFMatrix4f.translation(f)).mult(g.inverse()).mult(b).mult(g).mult(x3dom.fields.SFMatrix4f.translation(f.negate()))}this._isMoving=!0}},x3dom.Viewarea.prototype.onDrag=function(a,b,c){this.handleMoveEvt(a,b,c);var d=this._scene.getNavigationInfo(),e=d.getType(),f=d.getExplorationMode();if("none"!==e&&0!=f){var g,h,i,j,k=this._scene.getViewpoint(),l=a-this._lastX,m=b-this._lastY,n=null;if(c=(f&c)!=c?f:c,"examine"===e){if(1&c){i=2*m*Math.PI/this._width,j=2*l*Math.PI/this._height,n=this.getViewMatrix();var o=x3dom.fields.SFMatrix4f.rotationX(i),p=x3dom.fields.SFMatrix4f.rotationY(j),q=k.getCenterOfRotation();n.setTranslate(new x3dom.fields.SFVec3f(0,0,0)),this._rotMat=this._rotMat.mult(x3dom.fields.SFMatrix4f.translation(q)).mult(n.inverse()).mult(o).mult(p).mult(n).mult(x3dom.fields.SFMatrix4f.translation(q.negate()))}4&c&&(g=this._scene._lastMax.subtract(this._scene._lastMin).length(),g=(g<x3dom.fields.Eps?1:g)*d._vf.speed,h=new x3dom.fields.SFVec3f(g*l/this._width,g*-m/this._height,0),this._movement=this._movement.add(h),n=this.getViewpointMatrix().mult(this._transMat),this._transMat=n.inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(n)),2&c&&(g=this._scene._lastMax.subtract(this._scene._lastMin).length(),g=(g<x3dom.fields.Eps?1:g)*d._vf.speed,h=new x3dom.fields.SFVec3f(0,0,g*(l+m)/this._height),this._movement=this._movement.add(h),n=this.getViewpointMatrix().mult(this._transMat),this._transMat=n.inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(n)),this._isMoving=!0}else if("turntable"===e){if(1&c){i=2*m*Math.PI/this._height,j=2*l*Math.PI/this._width,this._up=this._flyMat.e1(),this._from=this._flyMat.e3();var r=this._from.subtract(this._at),s=Math.atan2(r.x,r.z),t=Math.atan2(Math.sqrt(r.x*r.x+r.z*r.z),r.y);s-=Math.min(j,.1),t-=Math.min(i,.1);var u=d.getTypeParams();t=Math.max(u[2],Math.min(u[3],t));var v=r.length(),w=v*Math.sin(t);r.x=w*Math.sin(s),r.y=v*Math.cos(t),r.z=w*Math.cos(s),r=this._at.add(r),t-=Math.PI/2;var x=Math.sin(t),y=Math.cos(t),z=new x3dom.fields.SFVec3f(x*Math.sin(s),y,x*Math.cos(s));z.y<0&&(z=z.negate()),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(r,this._at,z),k.setView(this._flyMat.inverse())}else if(2&c){g=this._scene._lastMax.subtract(this._scene._lastMin).length(),g=(g<x3dom.fields.Eps?1:g)*d._vf.speed,this._up=this._flyMat.e1(),this._from=this._flyMat.e3();var A=this._from.subtract(this._at),B=A.length(),C=-g*(l+m)/this._height,D=Math.max(B+C,1);this._from=this._at.addScaled(A.normalize(),D),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,this._up),k.setView(this._flyMat.inverse())}this._isMoving=!0}this._dx=l,this._dy=m,this._lastX=a,this._lastY=b}},x3dom.Viewarea.prototype.prepareEvents=function(a,b,c,d){var e=this._scene._vf.pickMode.toLowerCase(),f=0==e.indexOf("idbuf")||"color"==e||"texcoord"==e;if(f){var g=this._pickingInfo.pickObj;g&&(this._pick.setValues(this._pickingInfo.pickPos),this._pickNorm.setValues(this._pickingInfo.pickNorm),this.checkEvents(g,a,b,c,d),"onclick"===d&&(g._xmlNode&&x3dom.debug.logInfo('Hit "'+g._xmlNode.localName+"/ "+g._DEF+'"'),x3dom.debug.logInfo("Ray hit at position "+this._pick)))}},x3dom.Viewarea.prototype.getRenderMode=function(){return this._points},x3dom.Viewarea.prototype.getShadowedLights=function(){for(var a=[],b=0,c=this.getLights(),d=0;d<c.length;d++)c[d]._vf.shadowIntensity>0&&(a[b]=c[d],b++);return a},x3dom.Viewarea.prototype.getShadowSplitDepths=function(a,b,c,d,e){var f,g=[],h=this._scene.getViewpoint(),i=h.getNear(),j=h.getFar();g[0]=i,i+=c*(j-i)/10;for(var k=1;a>k;k++)f=i*Math.pow(j/i,k/a),g[k]=b*f+(1-b)*(i+k/(a*(i-j)));if(g[a]=j,!d)return g;for(var l=[],m=0;a>=m;m++)l[m]=e.multFullMatrixPnt(new x3dom.fields.SFVec3f(0,0,-g[m])).z;return l},x3dom.Viewarea.prototype.getLightCropMatrix=function(a){var b=x3dom.fields.SFVec3f.copy(this._scene._lastMin),c=x3dom.fields.SFVec3f.copy(this._scene._lastMax),d=[];d[0]=new x3dom.fields.SFVec3f(b.x,b.y,b.z),d[1]=new x3dom.fields.SFVec3f(b.x,b.y,c.z),d[2]=new x3dom.fields.SFVec3f(b.x,c.y,b.z),d[3]=new x3dom.fields.SFVec3f(b.x,c.y,c.z),d[4]=new x3dom.fields.SFVec3f(c.x,b.y,b.z),d[5]=new x3dom.fields.SFVec3f(c.x,b.y,c.z),d[6]=new x3dom.fields.SFVec3f(c.x,c.y,b.z),d[7]=new x3dom.fields.SFVec3f(c.x,c.y,c.z);var e;for(e=0;8>e;e++)d[e]=a.multFullMatrixPnt(d[e]);var f=x3dom.fields.SFVec3f.copy(d[0]),g=x3dom.fields.SFVec3f.copy(d[0]);for(e=1;8>e;e++)f.z=Math.min(d[e].z,f.z),g.z=Math.max(d[e].z,g.z);var h=2/(g.z-f.z),i=-(h*(g.z+f.z))/2,j=x3dom.fields.SFMatrix4f.identity();return j._22=h,j._23=i,j},x3dom.Viewarea.prototype.getLightFittingMatrix=function(a,b,c,d){function e(a,b){var c=a.x,d=a.y,e=a.z,f=b.x,g=b.y,h=b.z;c>1||-1>f?(c=-1,f=1):(c=Math.max(c,-1),f=Math.min(f,1)),d>1||-1>g?(d=-1,g=1):(d=Math.max(d,-1),g=Math.min(g,1)),e>1||-1>h?(e=-1,h=1):(e=Math.max(e,-1),h=Math.min(h,1));var i=new x3dom.fields.SFVec3f(c,d,e),j=new x3dom.fields.SFVec3f(f,g,h);return new x3dom.fields.BoxVolume(i,j)}var f=this.getViewMatrix(),g=d.mult(f),h=g.inverse(),i=[];i[0]=new x3dom.fields.SFVec3f(-1,-1,c),i[1]=new x3dom.fields.SFVec3f(-1,-1,b),i[2]=new x3dom.fields.SFVec3f(-1,1,c),i[3]=new x3dom.fields.SFVec3f(-1,1,b),i[4]=new x3dom.fields.SFVec3f(1,-1,c),i[5]=new x3dom.fields.SFVec3f(1,-1,b),i[6]=new x3dom.fields.SFVec3f(1,1,c),i[7]=new x3dom.fields.SFVec3f(1,1,b);var j;for(j=0;8>j;j++)i[j]=h.multFullMatrixPnt(i[j]),i[j]=a.multFullMatrixPnt(i[j]);var k=x3dom.fields.SFVec3f.copy(i[0]),l=x3dom.fields.SFVec3f.copy(i[0]);for(j=1;8>j;j++)k.x=Math.min(i[j].x,k.x),k.y=Math.min(i[j].y,k.y),k.z=Math.min(i[j].z,k.z),l.x=Math.max(i[j].x,l.x),l.y=Math.max(i[j].y,l.y),l.z=Math.max(i[j].z,l.z);var m=e(k,l),n=2/(m.max.x-m.min.x),o=2/(m.max.y-m.min.y),p=-(n*(m.max.x+m.min.x))/2,q=-(o*(m.max.y+m.min.y))/2,r=x3dom.fields.SFMatrix4f.identity();return r._00=n,r._11=o,r._03=p,r._13=q,r},x3dom.Mesh=function(a){this._parent=a,this._vol=new x3dom.fields.BoxVolume,this._invalidate=!0,this._numFaces=0,this._numCoords=0,this._primType="TRIANGLES",this._positions=[],this._normals=[],this._texCoords=[],this._colors=[],this._indices=[],this._positions[0]=[],this._normals[0]=[],this._texCoords[0]=[],this._colors[0]=[],this._indices[0]=[]},x3dom.Mesh.prototype._dynamicFields={},x3dom.Mesh.prototype._numPosComponents=3,x3dom.Mesh.prototype._numTexComponents=2,x3dom.Mesh.prototype._numColComponents=3,x3dom.Mesh.prototype._numNormComponents=3,x3dom.Mesh.prototype._lit=!0,x3dom.Mesh.prototype._vol=null,x3dom.Mesh.prototype._invalidate=!0,x3dom.Mesh.prototype._numFaces=0,x3dom.Mesh.prototype._numCoords=0,x3dom.Mesh.prototype.setMeshData=function(a,b,c,d,e){this._positions[0]=a,this._normals[0]=b,this._texCoords[0]=c,this._colors[0]=d,this._indices[0]=e,this._invalidate=!0,this._numFaces=this._indices[0].length/3,this._numCoords=this._positions[0].length/3},x3dom.Mesh.prototype.getVolume=function(){if(1==this._invalidate&&!this._vol.isValid()){var a=this._positions[0],b=a.length;if(b>3){var c=new x3dom.fields.SFVec3f(a[0],a[1],a[2]);this._vol.setBounds(c,c);for(var d=3;b>d;d+=3)this._vol.min.x>a[d]&&(this._vol.min.x=a[d]),this._vol.min.y>a[d+1]&&(this._vol.min.y=a[d+1]),this._vol.min.z>a[d+2]&&(this._vol.min.z=a[d+2]),this._vol.max.x<a[d]&&(this._vol.max.x=a[d]),this._vol.max.y<a[d+1]&&(this._vol.max.y=a[d+1]),this._vol.max.z<a[d+2]&&(this._vol.max.z=a[d+2]);this._invalidate=!1}}return this._vol},x3dom.Mesh.prototype.invalidate=function(){this._invalidate=!0,this._vol.invalidate()},x3dom.Mesh.prototype.isValid=function(){return this._vol.isValid()},x3dom.Mesh.prototype.getCenter=function(){return this.getVolume().getCenter()},x3dom.Mesh.prototype.getDiameter=function(){return this.getVolume().getDiameter()},x3dom.Mesh.prototype.doIntersect=function(a){var b=this.getVolume(),c=a.intersect(b.min,b.max);return c&&a.enter<a.dist&&(a.dist=a.enter,a.hitObject=this._parent,a.hitPoint=a.pos.add(a.dir.multiply(a.enter))),c},x3dom.Mesh.prototype.calcNormals=function(a,b){void 0===b&&(b=!0);var c,d,e,f,g=this._multiIndIndices&&this._multiIndIndices.length,h=g?this._multiIndIndices:this._indices[0],i=this._positions[0],j=[],k=[],l=i.length,m=null,n=void 0!==this._posSize&&this._posSize>l?this._posSize/3:l/3;for(n=3*(n-Math.floor(n)>0?Math.floor(n+1):n),c=0;n>c;++c)k[c]=[];for(n=h.length,c=0;n>c;c+=3){var o,p,q,r;g?(o=3*c,p=3*(c+1),q=3*(c+2),r=new x3dom.fields.SFVec3f(i[p],i[p+1],i[p+2]),e=new x3dom.fields.SFVec3f(i[o],i[o+1],i[o+2]).subtract(r),f=r.subtract(new x3dom.fields.SFVec3f(i[q],i[q+1],i[q+2]))):(o=3*h[c],p=3*h[c+1],q=3*h[c+2],r=new x3dom.fields.SFVec3f(i[p],i[p+1],i[p+2]),e=new x3dom.fields.SFVec3f(i[o],i[o+1],i[o+2]).subtract(r),f=r.subtract(new x3dom.fields.SFVec3f(i[q],i[q+1],i[q+2])),o=3*c,p=3*(c+1),q=3*(c+2)),m=e.cross(f).normalize(),b||(m=m.negate()),a<=x3dom.fields.Eps?(j[o]=j[p]=j[q]=m.x,j[o+1]=j[p+1]=j[q+1]=m.y,j[o+2]=j[p+2]=j[q+2]=m.z):(k[h[c]].push(m),k[h[c+1]].push(m),k[h[c+2]].push(m))}if(a>x3dom.fields.Eps)for(c=0;l>c;c+=3){var s,t=c/3;for(s=g?k[h[t]]:k[t],n=s.length,m=new x3dom.fields.SFVec3f(0,0,0),d=0;n>d;++d)m=m.add(s[d]);m=m.normalize(),j[c]=m.x,j[c+1]=m.y,j[c+2]=m.z}this._normals[0]=j},x3dom.Mesh.prototype.splitMesh=function(a,b){var c,d;c=void 0===typeof a?3:a,void 0===typeof b&&(b=!1);var e=x3dom.Utils.maxIndexableCoords;if(e=Math.floor(e/c)*c,!(this._positions[0].length/3<=e)||b){d=b?this._multiIndIndices&&this._multiIndIndices.length:!1;var f=this._positions[0],g=this._normals[0],h=this._texCoords[0],i=this._colors[0],j=d?this._multiIndIndices:this._indices[0],k=0;do{this._positions[k]=[],this._normals[k]=[],this._texCoords[k]=[],this._colors[k]=[],this._indices[k]=[];var l=j.length-(k+1)*e>=0;if(this._indices[k]=l?j.slice(k*e,(k+1)*e):j.slice(k*e),d)for(var m=0,n=this._indices[k].length;n>m;m++)this._indices[k][m]=m;else if(k)for(var o=k*e,m=0,n=this._indices[k].length;n>m;m++)this._indices[k][m]-=o;this._positions[k]=l?f.slice(3*k*e,3*(k+1)*e):f.slice(3*k*e),g.length&&(this._normals[k]=l?g.slice(3*k*e,3*(k+1)*e):g.slice(3*k*e)),h.length&&(this._texCoords[k]=l?h.slice(k*e*this._numTexComponents,this._numTexComponents*(k+1)*e):h.slice(k*e*this._numTexComponents)),i.length&&(this._colors[k]=l?i.slice(k*e*this._numColComponents,this._numColComponents*(k+1)*e):i.slice(k*e*this._numColComponents))}while(f.length>3*++k*e)}},x3dom.Mesh.prototype.calcTexCoords=function(a){if(this._texCoords[0]=[],"sphere-local"===a.toLowerCase())for(var b=0,c=0,d=this._normals[0].length;d>b;b+=3)this._texCoords[0][c++]=.5+this._normals[0][b]/2,this._texCoords[0][c++]=.5+this._normals[0][b+1]/2;else{var e=new x3dom.fields.SFVec3f(0,0,0),f=new x3dom.fields.SFVec3f(0,0,0),g=this.getVolume();g.getBounds(e,f);var h=f.subtract(e),i=0,j=1;h.x>=h.y?h.x>=h.z?(i=0,j=h.y>=h.z?1:2):(i=2,j=0):h.y>=h.z?(i=1,j=h.x>=h.z?0:2):(i=2,j=1);var k=1,l=1,m=0,n=0;switch(i){case 0:k=h.x,m=e.x;break;case 1:k=h.y,m=e.y;break;case 2:k=h.z,m=e.z}switch(j){case 0:l=h.x,n=e.x;break;case 1:l=h.y,n=e.y;break;case 2:l=h.z,n=e.z}for(var o=0,p=0,q=this._positions[0].length;q>o;o+=3)this._texCoords[0][p++]=(this._positions[0][o+i]-m)/k,this._texCoords[0][p++]=(this._positions[0][o+j]-n)/l}},"undefined"==typeof x3dom&&(x3dom={extend:function(a){function b(){}return b.prototype=a.prototype||a,new b},debug:{logInfo:function(a){console.log(a)},logWarning:function(a){console.warn(a)},logError:function(a){console.error(a)}}},Array.map||(Array.map=function(a,b,c){for(var d=a.length,e=[],f=0;d>f;f++)f in a&&(e[f]=b.call(c,a[f],f,a));return e}),console.log("Using x3dom fields.js as standalone math and/or base types library.")),x3dom.fields={},x3dom.fields.Eps=1e-6,x3dom.fields.SFMatrix4f=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){0===arguments.length?(this._00=1,this._01=0,this._02=0,this._03=0,this._10=0,this._11=1,this._12=0,this._13=0,this._20=0,this._21=0,this._22=1,this._23=0,this._30=0,this._31=0,this._32=0,this._33=1):(this._00=a,this._01=b,this._02=c,this._03=d,this._10=e,this._11=f,this._12=g,this._13=h,this._20=i,this._21=j,this._22=k,this._23=l,this._30=m,this._31=n,this._32=o,this._33=p)},x3dom.fields.SFMatrix4f.prototype.e0=function(){var a=new x3dom.fields.SFVec3f(this._00,this._10,this._20);return a.normalize()},x3dom.fields.SFMatrix4f.prototype.e1=function(){var a=new x3dom.fields.SFVec3f(this._01,this._11,this._21);return a.normalize()},x3dom.fields.SFMatrix4f.prototype.e2=function(){var a=new x3dom.fields.SFVec3f(this._02,this._12,this._22);return a.normalize()},x3dom.fields.SFMatrix4f.prototype.e3=function(){return new x3dom.fields.SFVec3f(this._03,this._13,this._23)},x3dom.fields.SFMatrix4f.copy=function(a){return new x3dom.fields.SFMatrix4f(a._00,a._01,a._02,a._03,a._10,a._11,a._12,a._13,a._20,a._21,a._22,a._23,a._30,a._31,a._32,a._33)},x3dom.fields.SFMatrix4f.identity=function(){return new x3dom.fields.SFMatrix4f(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},x3dom.fields.SFMatrix4f.zeroMatrix=function(){return new x3dom.fields.SFMatrix4f(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},x3dom.fields.SFMatrix4f.translation=function(a){return new x3dom.fields.SFMatrix4f(1,0,0,a.x,0,1,0,a.y,0,0,1,a.z,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationX=function(a){var b=Math.cos(a),c=Math.sin(a);return new x3dom.fields.SFMatrix4f(1,0,0,0,0,b,-c,0,0,c,b,0,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationY=function(a){var b=Math.cos(a),c=Math.sin(a);return new x3dom.fields.SFMatrix4f(b,0,c,0,0,1,0,0,-c,0,b,0,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationZ=function(a){var b=Math.cos(a),c=Math.sin(a);return new x3dom.fields.SFMatrix4f(b,-c,0,0,c,b,0,0,0,0,1,0,0,0,0,1)},x3dom.fields.SFMatrix4f.scale=function(a){return new x3dom.fields.SFMatrix4f(a.x,0,0,0,0,a.y,0,0,0,0,a.z,0,0,0,0,1)},x3dom.fields.SFMatrix4f.lookAt=function(a,b,c){var d=a.subtract(b).normalize(),e=c.normalize().cross(d);if(e.dot(e)<x3dom.fields.Eps)return x3dom.debug.logWarning("View matrix is linearly dependent."),x3dom.fields.SFMatrix4f.translation(a);var f=d.cross(e.normalize()).normalize(),g=x3dom.fields.SFMatrix4f.identity();return g.setValue(e,f,d,a),g},x3dom.fields.SFMatrix4f.perspective=function(a,b,c,d){var e=1/Math.tan(a/2);return new x3dom.fields.SFMatrix4f(e/b,0,0,0,0,e,0,0,0,0,(c+d)/(c-d),2*c*d/(c-d),0,0,-1,0)},x3dom.fields.SFMatrix4f.ortho=function(a,b,c,d,e,f,g){var h=(b-a)/2,i=(d-c)/2,j=f-e;return void 0===g&&(g=1),h/i>g?i=h/g:h=i*g,a=-h,b=h,c=-i,d=i,h*=2,i*=2,new x3dom.fields.SFMatrix4f(2/h,0,0,-(b+a)/h,0,2/i,0,-(d+c)/i,0,0,-2/j,-(f+e)/j,0,0,0,1)},x3dom.fields.SFMatrix4f.prototype.setTranslate=function(a){this._03=a.x,this._13=a.y,this._23=a.z},x3dom.fields.SFMatrix4f.prototype.setScale=function(a){this._00=a.x,this._11=a.y,this._22=a.z},x3dom.fields.SFMatrix4f.prototype.setRotate=function(a){var b=a.x*a.x,c=a.x*a.y,d=a.x*a.z,e=a.y*a.y,f=a.y*a.z,g=a.z*a.z,h=a.w*a.x,i=a.w*a.y,j=a.w*a.z;this._00=1-2*(e+g),this._01=2*(c-j),this._02=2*(d+i),this._10=2*(c+j),this._11=1-2*(b+g),this._12=2*(f-h),this._20=2*(d-i),this._21=2*(f+h),this._22=1-2*(b+e)},x3dom.fields.SFMatrix4f.parseRotation=function(a){var b=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(a),c=+b[1],d=+b[2],e=+b[3],f=+b[4],g=Math.sqrt(c*c+d*d+e*e);0===g?(c=1,d=e=0):(c/=g,d/=g,e/=g);var h=Math.cos(f),i=Math.sin(f),j=1-h;return new x3dom.fields.SFMatrix4f(j*c*c+h,j*c*d+i*e,j*c*e-i*d,0,j*c*d-i*e,j*d*d+h,j*d*e+i*c,0,j*c*e+i*d,j*d*e-i*c,j*e*e+h,0,0,0,0,1).transpose()},x3dom.fields.SFMatrix4f.parse=function(a){var b=!1,c=/matrix.*\((.+)\)/;c.exec(a)&&(a=RegExp.$1,b=!0);var d=Array.map(a.split(/[,\s]+/),function(a){return+a});return d.length>=16?b?new x3dom.fields.SFMatrix4f(d[0],d[4],d[8],d[12],d[1],d[5],d[9],d[13],d[2],d[6],d[10],d[14],d[3],d[7],d[11],d[15]):new x3dom.fields.SFMatrix4f(d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9],d[10],d[11],d[12],d[13],d[14],d[15]):6===d.length?new x3dom.fields.SFMatrix4f(d[0],d[1],0,d[4],d[2],d[3],0,d[5],0,0,1,0,0,0,0,1):(x3dom.debug.logWarning("SFMatrix4f - can't parse string: "+a),x3dom.fields.SFMatrix4f.identity())},x3dom.fields.SFMatrix4f.prototype.mult=function(a){return new x3dom.fields.SFMatrix4f(this._00*a._00+this._01*a._10+this._02*a._20+this._03*a._30,this._00*a._01+this._01*a._11+this._02*a._21+this._03*a._31,this._00*a._02+this._01*a._12+this._02*a._22+this._03*a._32,this._00*a._03+this._01*a._13+this._02*a._23+this._03*a._33,this._10*a._00+this._11*a._10+this._12*a._20+this._13*a._30,this._10*a._01+this._11*a._11+this._12*a._21+this._13*a._31,this._10*a._02+this._11*a._12+this._12*a._22+this._13*a._32,this._10*a._03+this._11*a._13+this._12*a._23+this._13*a._33,this._20*a._00+this._21*a._10+this._22*a._20+this._23*a._30,this._20*a._01+this._21*a._11+this._22*a._21+this._23*a._31,this._20*a._02+this._21*a._12+this._22*a._22+this._23*a._32,this._20*a._03+this._21*a._13+this._22*a._23+this._23*a._33,this._30*a._00+this._31*a._10+this._32*a._20+this._33*a._30,this._30*a._01+this._31*a._11+this._32*a._21+this._33*a._31,this._30*a._02+this._31*a._12+this._32*a._22+this._33*a._32,this._30*a._03+this._31*a._13+this._32*a._23+this._33*a._33)},x3dom.fields.SFMatrix4f.prototype.multMatrixPnt=function(a){return new x3dom.fields.SFVec3f(this._00*a.x+this._01*a.y+this._02*a.z+this._03,this._10*a.x+this._11*a.y+this._12*a.z+this._13,this._20*a.x+this._21*a.y+this._22*a.z+this._23)},x3dom.fields.SFMatrix4f.prototype.multMatrixVec=function(a){return new x3dom.fields.SFVec3f(this._00*a.x+this._01*a.y+this._02*a.z,this._10*a.x+this._11*a.y+this._12*a.z,this._20*a.x+this._21*a.y+this._22*a.z)},x3dom.fields.SFMatrix4f.prototype.multFullMatrixPnt=function(a){var b=this._30*a.x+this._31*a.y+this._32*a.z+this._33;return b&&(b=1/b),new x3dom.fields.SFVec3f((this._00*a.x+this._01*a.y+this._02*a.z+this._03)*b,(this._10*a.x+this._11*a.y+this._12*a.z+this._13)*b,(this._20*a.x+this._21*a.y+this._22*a.z+this._23)*b)},x3dom.fields.SFMatrix4f.prototype.transpose=function(){return new x3dom.fields.SFMatrix4f(this._00,this._10,this._20,this._30,this._01,this._11,this._21,this._31,this._02,this._12,this._22,this._32,this._03,this._13,this._23,this._33)},x3dom.fields.SFMatrix4f.prototype.negate=function(){return new x3dom.fields.SFMatrix4f(-this._00,-this._01,-this._02,-this._03,-this._10,-this._11,-this._12,-this._13,-this._20,-this._21,-this._22,-this._23,-this._30,-this._31,-this._32,-this._33)},x3dom.fields.SFMatrix4f.prototype.multiply=function(a){return new x3dom.fields.SFMatrix4f(a*this._00,a*this._01,a*this._02,a*this._03,a*this._10,a*this._11,a*this._12,a*this._13,a*this._20,a*this._21,a*this._22,a*this._23,a*this._30,a*this._31,a*this._32,a*this._33)},x3dom.fields.SFMatrix4f.prototype.add=function(a){return new x3dom.fields.SFMatrix4f(this._00+a._00,this._01+a._01,this._02+a._02,this._03+a._03,this._10+a._10,this._11+a._11,this._12+a._12,this._13+a._13,this._20+a._20,this._21+a._21,this._22+a._22,this._23+a._23,this._30+a._30,this._31+a._31,this._32+a._32,this._33+a._33)},x3dom.fields.SFMatrix4f.prototype.addScaled=function(a,b){return new x3dom.fields.SFMatrix4f(this._00+b*a._00,this._01+b*a._01,this._02+b*a._02,this._03+b*a._03,this._10+b*a._10,this._11+b*a._11,this._12+b*a._12,this._13+b*a._13,this._20+b*a._20,this._21+b*a._21,this._22+b*a._22,this._23+b*a._23,this._30+b*a._30,this._31+b*a._31,this._32+b*a._32,this._33+b*a._33)},x3dom.fields.SFMatrix4f.prototype.setValues=function(a){this._00=a._00,this._01=a._01,this._02=a._02,this._03=a._03,this._10=a._10,this._11=a._11,this._12=a._12,this._13=a._13,this._20=a._20,this._21=a._21,this._22=a._22,this._23=a._23,this._30=a._30,this._31=a._31,this._32=a._32,this._33=a._33},x3dom.fields.SFMatrix4f.prototype.setValue=function(a,b,c,d){this._00=a.x,this._01=b.x,this._02=c.x,this._10=a.y,this._11=b.y,this._12=c.y,this._20=a.z,this._21=b.z,this._22=c.z,this._30=0,this._31=0,this._32=0,arguments.length>3&&(this._03=d.x,this._13=d.y,this._23=d.z,this._33=1)},x3dom.fields.SFMatrix4f.prototype.setFromArray=function(a){this._00=a[0],this._01=a[4],this._02=a[8],this._03=a[12],this._10=a[1],this._11=a[5],this._12=a[9],this._13=a[13],this._20=a[2],this._21=a[6],this._22=a[10],this._23=a[14],this._30=a[3],this._31=a[7],this._32=a[11],this._33=a[15]},x3dom.fields.SFMatrix4f.prototype.toGL=function(){return[this._00,this._10,this._20,this._30,this._01,this._11,this._21,this._31,this._02,this._12,this._22,this._32,this._03,this._13,this._23,this._33]},x3dom.fields.SFMatrix4f.prototype.at=function(a,b){var c="_"+a+b;return this[c]},x3dom.fields.SFMatrix4f.prototype.sqrt=function(){for(var a=x3dom.fields.SFMatrix4f.identity(),b=x3dom.fields.SFMatrix4f.copy(this),c=0;6>c;c++){var d=b.inverse(),e=0==c?x3dom.fields.SFMatrix4f.identity():a.inverse(),f=b.det(),g=a.det(),h=Math.abs(Math.pow(f*g,-.125)),i=1/h;b=b.multiply(h),b=b.addScaled(e,i),b=b.multiply(.5),a=a.multiply(h),a=a.addScaled(d,i),a=a.multiply(.5)}return b},x3dom.fields.SFMatrix4f.prototype.normInfinity=function(){var a=0,b=0;return(a=Math.abs(this._00))>b&&(b=a),(a=Math.abs(this._01))>b&&(b=a),(a=Math.abs(this._02))>b&&(b=a),(a=Math.abs(this._03))>b&&(b=a),(a=Math.abs(this._10))>b&&(b=a),(a=Math.abs(this._11))>b&&(b=a),(a=Math.abs(this._12))>b&&(b=a),(a=Math.abs(this._13))>b&&(b=a),(a=Math.abs(this._20))>b&&(b=a),(a=Math.abs(this._21))>b&&(b=a),(a=Math.abs(this._22))>b&&(b=a),(a=Math.abs(this._23))>b&&(b=a),(a=Math.abs(this._30))>b&&(b=a),(a=Math.abs(this._31))>b&&(b=a),(a=Math.abs(this._32))>b&&(b=a),(a=Math.abs(this._33))>b&&(b=a),b},x3dom.fields.SFMatrix4f.prototype.norm1_3x3=function(){var a=Math.abs(this._00)+Math.abs(this._10)+Math.abs(this._20),b=0;return(b=Math.abs(this._01)+Math.abs(this._11)+Math.abs(this._21))>a&&(a=b),(b=Math.abs(this._02)+Math.abs(this._12)+Math.abs(this._22))>a&&(a=b),a},x3dom.fields.SFMatrix4f.prototype.normInf_3x3=function(){var a=Math.abs(this._00)+Math.abs(this._01)+Math.abs(this._02),b=0;return(b=Math.abs(this._10)+Math.abs(this._11)+Math.abs(this._12))>a&&(a=b),(b=Math.abs(this._20)+Math.abs(this._21)+Math.abs(this._22))>a&&(a=b),a},x3dom.fields.SFMatrix4f.prototype.adjointT_3x3=function(){var a=x3dom.fields.SFMatrix4f.identity();return a._00=this._11*this._22-this._12*this._21,a._01=this._12*this._20-this._10*this._22,a._02=this._10*this._21-this._11*this._20,a._10=this._21*this._02-this._22*this._01,a._11=this._22*this._00-this._20*this._02,a._12=this._20*this._01-this._21*this._00,a._20=this._01*this._12-this._02*this._11,a._21=this._02*this._10-this._00*this._12,a._22=this._00*this._11-this._01*this._10,a},x3dom.fields.SFMatrix4f.prototype.equals=function(a){var b=1e-12;return Math.abs(this._00-a._00)<b&&Math.abs(this._01-a._01)<b&&Math.abs(this._02-a._02)<b&&Math.abs(this._03-a._03)<b&&Math.abs(this._10-a._10)<b&&Math.abs(this._11-a._11)<b&&Math.abs(this._12-a._12)<b&&Math.abs(this._13-a._13)<b&&Math.abs(this._20-a._20)<b&&Math.abs(this._21-a._21)<b&&Math.abs(this._22-a._22)<b&&Math.abs(this._23-a._23)<b&&Math.abs(this._30-a._30)<b&&Math.abs(this._31-a._31)<b&&Math.abs(this._32-a._32)<b&&Math.abs(this._33-a._33)<b},x3dom.fields.SFMatrix4f.prototype.getTransform=function(a,b,c,d,e){var f=null;if(arguments.length>4){f=x3dom.fields.SFMatrix4f.translation(e.negate()),f=f.mult(this);var g=x3dom.fields.SFMatrix4f.translation(e);
f=f.mult(g)}else f=x3dom.fields.SFMatrix4f.copy(this);var h=f.decompose(a,b,c,d);c.setValues(c.multiply(h))},x3dom.fields.SFMatrix4f.prototype.decompose=function(a,b,c,d){var e=x3dom.fields.SFMatrix4f.copy(this),f=x3dom.fields.SFMatrix4f.identity(),g=x3dom.fields.SFMatrix4f.identity(),h=x3dom.fields.SFMatrix4f.identity();a.x=e._03,a.y=e._13,a.z=e._23,e._03=0,e._13=0,e._23=0,e._30=0,e._31=0,e._32=0;var i=e.polarDecompose(f,g),j=1;return 0>i&&(f=f.negate(),j=-1),b.setValue(f),g.spectralDecompose(h,c),d.setValue(h),j},x3dom.fields.SFMatrix4f.prototype.polarDecompose=function(a,b){var c,d,e,f,g,h=1e-12,i=this.transpose(),j=x3dom.fields.SFMatrix4f.identity(),k=i.norm1_3x3(),l=i.normInf_3x3();do{if(c=i.adjointT_3x3(),g=i._00*c._00+i._01*c._01+i._02*c._02,0==g){x3dom.debug.logWarning("polarDecompose: Mk_det == 0.0");break}d=c.norm1_3x3(),e=c.normInf_3x3();var m=Math.sqrt(Math.sqrt(d*e/(k*l))/Math.abs(g)),n=.5*m,o=.5/(m*g);j.setValues(i),i=i.multiply(n),i=i.addScaled(c,o),j=j.addScaled(i,-1),f=j.norm1_3x3(),k=i.norm1_3x3(),l=i.normInf_3x3()}while(f>k*h);a.setValues(i.transpose()),b.setValues(i.mult(this));for(var p=0;3>p;++p)for(var q=p;3>q;++q)b["_"+q+p]=.5*(b["_"+q+p]+b["_"+p+q]),b["_"+p+q]=.5*(b["_"+q+p]+b["_"+p+q]);return g},x3dom.fields.SFMatrix4f.prototype.spectralDecompose=function(a,b){for(var c=[1,2,0],d=20,e=[this._00,this._11,this._22],f=[this._12,this._20,this._01],g=0;d>g;++g){var h=Math.abs(f[0])+Math.abs(f[1])+Math.abs(f[2]);if(0==h)break;for(var i=2;i>=0;--i){var j=c[i],k=c[j],l=Math.abs(f[i]),m=100*l;if(l>0){var n=0,o=e[k]-e[j],p=Math.abs(o);if(p+m==p)n=f[i]/o;else{var q=.5*o/f[i];n=1/(Math.abs(q)+Math.sqrt(q*q+1)),n=0>q?-n:n}var r=1/Math.sqrt(n*n+1),s=n*r,t=s/(r+1),u=n*f[i];f[i]=0,e[j]-=u,e[k]+=u;var v=f[k];f[k]-=s*(f[j]+t*v),f[j]+=s*(v-t*f[j]);for(var w=2;w>=0;--w){var x=a["_"+w+j],y=a["_"+w+k];a["_"+w+j]-=s*(y+t*x),a["_"+w+k]+=s*(x-t*y)}}}}b.x=e[0],b.y=e[1],b.z=e[2]},x3dom.fields.SFMatrix4f.prototype.log=function(){var a=12,b=1e-12,c=x3dom.fields.SFMatrix4f.copy(this),d=x3dom.fields.SFMatrix4f.copy(this);d._00-=1,d._11-=1,d._22-=1,d._33-=1;for(var e=0;d.normInfinity()>.5;)c=c.sqrt(),d.setValues(c),d._00-=1,d._11-=1,d._22-=1,d._33-=1,e++;c._00-=1,c._11-=1,c._22-=1,c._33-=1,c=c.negate(),d.setValues(c);for(var f=x3dom.fields.SFMatrix4f.copy(c),g=1;d.normInfinity()>b&&a>g;)d=d.mult(c),g++,f=f.addScaled(d,1/g);return f.multiply(-(1<<e))},x3dom.fields.SFMatrix4f.prototype.exp=function(){var a=6,b=x3dom.fields.SFMatrix4f.copy(this),c=x3dom.fields.SFMatrix4f.identity(),d=x3dom.fields.SFMatrix4f.identity(),e=x3dom.fields.SFMatrix4f.identity(),f=0,g=1,h=1+parseInt(Math.log(b.normInfinity()/.693));for(0>h&&(h=0),b=b.multiply(1/(1<<h)),f=1;a>=f;f++)g*=(a-f+1)/(f*(2*a-f+1)),e=b.mult(e),d=d.addScaled(e,g),c=f%2?c.addScaled(e,-g):c.addScaled(e,g);for(e=c.inverse().mult(d),f=0;h>f;f++)e=e.mult(e);return e},x3dom.fields.SFMatrix4f.prototype.det3=function(a,b,c,d,e,f,g,h,i){return a*e*i+b*f*g+c*d*h-a*f*h-b*d*i-c*e*g},x3dom.fields.SFMatrix4f.prototype.det=function(){var a=this._00,b=this._10,c=this._20,d=this._30,e=this._01,f=this._11,g=this._21,h=this._31,i=this._02,j=this._12,k=this._22,l=this._32,m=this._03,n=this._13,o=this._23,p=this._33;return a*this.det3(f,j,n,g,k,o,h,l,p)-b*this.det3(e,i,m,g,k,o,h,l,p)+c*this.det3(e,i,m,f,j,n,h,l,p)-d*this.det3(e,i,m,f,j,n,g,k,o)},x3dom.fields.SFMatrix4f.prototype.inverse=function(){var a=this._00,b=this._10,c=this._20,d=this._30,e=this._01,f=this._11,g=this._21,h=this._31,i=this._02,j=this._12,k=this._22,l=this._32,m=this._03,n=this._13,o=this._23,p=this._33,q=this.det();return 0==q?(x3dom.debug.logWarning("Invert matrix: singular matrix, no inverse!"),x3dom.fields.SFMatrix4f.identity()):(q=1/q,new x3dom.fields.SFMatrix4f(+this.det3(f,j,n,g,k,o,h,l,p)*q,-this.det3(e,i,m,g,k,o,h,l,p)*q,+this.det3(e,i,m,f,j,n,h,l,p)*q,-this.det3(e,i,m,f,j,n,g,k,o)*q,-this.det3(b,j,n,c,k,o,d,l,p)*q,+this.det3(a,i,m,c,k,o,d,l,p)*q,-this.det3(a,i,m,b,j,n,d,l,p)*q,+this.det3(a,i,m,b,j,n,c,k,o)*q,+this.det3(b,f,n,c,g,o,d,h,p)*q,-this.det3(a,e,m,c,g,o,d,h,p)*q,+this.det3(a,e,m,b,f,n,d,h,p)*q,-this.det3(a,e,m,b,f,n,c,g,o)*q,-this.det3(b,f,j,c,g,k,d,h,l)*q,+this.det3(a,e,i,c,g,k,d,h,l)*q,-this.det3(a,e,i,b,f,j,d,h,l)*q,+this.det3(a,e,i,b,f,j,c,g,k)*q))},x3dom.fields.SFMatrix4f.prototype.getEulerAngles=function(){var a,b,c,d,e,f,g,h,i,j,k;return 1!=Math.abs(this._20)?(a=-Math.asin(this._20),b=Math.PI-a,j=Math.cos(a),k=Math.cos(b),g=Math.atan2(this._21/j,this._22/j),h=Math.atan2(this._21/k,this._22/k),d=Math.atan2(this._10/j,this._00/j),e=Math.atan2(this._10/k,this._00/k),[g,a,d,h,b,e]):(f=0,-1==this._20?(c=Math.PI/2,i=f+Math.atan2(this._01,this._02)):(c=-(Math.PI/2),i=-f+Math.atan2(-this._01,-this._02)),[i,c,f,i,c,f])},x3dom.fields.SFMatrix4f.prototype.toString=function(){return"\n"+this._00.toFixed(6)+", "+this._01.toFixed(6)+", "+this._02.toFixed(6)+", "+this._03.toFixed(6)+", \n"+this._10.toFixed(6)+", "+this._11.toFixed(6)+", "+this._12.toFixed(6)+", "+this._13.toFixed(6)+", \n"+this._20.toFixed(6)+", "+this._21.toFixed(6)+", "+this._22.toFixed(6)+", "+this._23.toFixed(6)+", \n"+this._30.toFixed(6)+", "+this._31.toFixed(6)+", "+this._32.toFixed(6)+", "+this._33.toFixed(6)},x3dom.fields.SFMatrix4f.prototype.setValueByStr=function(a){var b=!1,c=/matrix.*\((.+)\)/;c.exec(a)&&(a=RegExp.$1,b=!0);var d=Array.map(a.split(/[,\s]+/),function(a){return+a});return d.length>=16?b?(this._00=d[0],this._01=d[4],this._02=d[8],this._03=d[12],this._10=d[1],this._11=d[5],this._12=d[9],this._13=d[13],this._20=d[2],this._21=d[6],this._22=d[10],this._23=d[14],this._30=d[3],this._31=d[7],this._32=d[11],this._33=d[15]):(this._00=d[0],this._01=d[1],this._02=d[2],this._03=d[3],this._10=d[4],this._11=d[5],this._12=d[6],this._13=d[7],this._20=d[8],this._21=d[9],this._22=d[10],this._23=d[11],this._30=d[12],this._31=d[13],this._32=d[14],this._33=d[15]):6===d.length?(this._00=d[0],this._01=d[1],this._02=0,this._03=d[4],this._10=d[2],this._11=d[3],this._12=0,this._13=d[5],this._20=0,this._21=0,this._22=1,this._23=0,this._30=0,this._31=0,this._32=0,this._33=1):x3dom.debug.logWarning("SFMatrix4f - can't parse string: "+a),this},x3dom.fields.SFVec2f=function(a,b){0===arguments.length?(this.x=0,this.y=0):(this.x=a,this.y=b)},x3dom.fields.SFVec2f.copy=function(a){return new x3dom.fields.SFVec2f(a.x,a.y)},x3dom.fields.SFVec2f.parse=function(a){var b=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);return new x3dom.fields.SFVec2f(+b[1],+b[2])},x3dom.fields.SFVec2f.prototype.setValues=function(a){this.x=a.x,this.y=a.y},x3dom.fields.SFVec2f.prototype.at=function(a){switch(a){case 0:return this.x;case 1:return this.y;default:return this.x}},x3dom.fields.SFVec2f.prototype.add=function(a){return new x3dom.fields.SFVec2f(this.x+a.x,this.y+a.y)},x3dom.fields.SFVec2f.prototype.subtract=function(a){return new x3dom.fields.SFVec2f(this.x-a.x,this.y-a.y)},x3dom.fields.SFVec2f.prototype.negate=function(){return new x3dom.fields.SFVec2f(-this.x,-this.y)},x3dom.fields.SFVec2f.prototype.dot=function(a){return this.x*a.x+this.y*a.y},x3dom.fields.SFVec2f.prototype.reflect=function(a){var b=2*this.dot(a);return new x3dom.fields.SFVec2f(this.x-b*a.x,this.y-b*a.y)},x3dom.fields.SFVec2f.prototype.normalize=function(){var a=this.length();return a&&(a=1/a),new x3dom.fields.SFVec2f(this.x*a,this.y*a)},x3dom.fields.SFVec2f.prototype.multComponents=function(a){return new x3dom.fields.SFVec2f(this.x*a.x,this.y*a.y)},x3dom.fields.SFVec2f.prototype.multiply=function(a){return new x3dom.fields.SFVec2f(this.x*a,this.y*a)},x3dom.fields.SFVec2f.prototype.divide=function(a){var b=a?1/a:1;return new x3dom.fields.SFVec2f(this.x*b,this.y*b)},x3dom.fields.SFVec2f.prototype.equals=function(a,b){return Math.abs(this.x-a.x)<b&&Math.abs(this.y-a.y)<b},x3dom.fields.SFVec2f.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},x3dom.fields.SFVec2f.prototype.toGL=function(){return[this.x,this.y]},x3dom.fields.SFVec2f.prototype.toString=function(){return this.x+" "+this.y},x3dom.fields.SFVec2f.prototype.setValueByStr=function(a){var b=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);return this.x=+b[1],this.y=+b[2],this},x3dom.fields.SFVec3f=function(a,b,c){0===arguments.length?(this.x=0,this.y=0,this.z=0):(this.x=a,this.y=b,this.z=c)},x3dom.fields.SFVec3f.NullVector=new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.SFVec3f.OneVector=new x3dom.fields.SFVec3f(1,1,1),x3dom.fields.SFVec3f.copy=function(a){return new x3dom.fields.SFVec3f(a.x,a.y,a.z)},x3dom.fields.SFVec3f.MIN=function(){return new x3dom.fields.SFVec3f(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE)},x3dom.fields.SFVec3f.MAX=function(){return new x3dom.fields.SFVec3f(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},x3dom.fields.SFVec3f.parse=function(a){try{var b=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);return new x3dom.fields.SFVec3f(+b[1],+b[2],+b[3])}catch(c){var d=x3dom.fields.SFColor.colorParse(a);return new x3dom.fields.SFVec3f(d.r,d.g,d.b)}},x3dom.fields.SFVec3f.prototype.setValues=function(a){this.x=a.x,this.y=a.y,this.z=a.z},x3dom.fields.SFVec3f.prototype.at=function(a){switch(a){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:return this.x}},x3dom.fields.SFVec3f.prototype.add=function(a){return new x3dom.fields.SFVec3f(this.x+a.x,this.y+a.y,this.z+a.z)},x3dom.fields.SFVec3f.prototype.addScaled=function(a,b){return new x3dom.fields.SFVec3f(this.x+b*a.x,this.y+b*a.y,this.z+b*a.z)},x3dom.fields.SFVec3f.prototype.subtract=function(a){return new x3dom.fields.SFVec3f(this.x-a.x,this.y-a.y,this.z-a.z)},x3dom.fields.SFVec3f.prototype.negate=function(){return new x3dom.fields.SFVec3f(-this.x,-this.y,-this.z)},x3dom.fields.SFVec3f.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},x3dom.fields.SFVec3f.prototype.cross=function(a){return new x3dom.fields.SFVec3f(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)},x3dom.fields.SFVec3f.prototype.reflect=function(a){var b=2*this.dot(a);return new x3dom.fields.SFVec3f(this.x-b*a.x,this.y-b*a.y,this.z-b*a.z)},x3dom.fields.SFVec3f.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},x3dom.fields.SFVec3f.prototype.normalize=function(){var a=this.length();return a&&(a=1/a),new x3dom.fields.SFVec3f(this.x*a,this.y*a,this.z*a)},x3dom.fields.SFVec3f.prototype.multComponents=function(a){return new x3dom.fields.SFVec3f(this.x*a.x,this.y*a.y,this.z*a.z)},x3dom.fields.SFVec3f.prototype.multiply=function(a){return new x3dom.fields.SFVec3f(this.x*a,this.y*a,this.z*a)},x3dom.fields.SFVec3f.prototype.divide=function(a){var b=a?1/a:1;return new x3dom.fields.SFVec3f(this.x*b,this.y*b,this.z*b)},x3dom.fields.SFVec3f.prototype.equals=function(a,b){return Math.abs(this.x-a.x)<b&&Math.abs(this.y-a.y)<b&&Math.abs(this.z-a.z)<b},x3dom.fields.SFVec3f.prototype.toGL=function(){return[this.x,this.y,this.z]},x3dom.fields.SFVec3f.prototype.toString=function(){return this.x+" "+this.y+" "+this.z},x3dom.fields.SFVec3f.prototype.setValueByStr=function(a){try{var b=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);this.x=+b[1],this.y=+b[2],this.z=+b[3]}catch(c){var d=x3dom.fields.SFColor.colorParse(a);this.x=d.r,this.y=d.g,this.z=d.b}return this},x3dom.fields.SFVec4f=function(a,b,c,d){0===arguments.length?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x=a,this.y=b,this.z=c,this.w=d)},x3dom.fields.SFVec4f.copy=function(a){return new x3dom.fields.SFVec4f(a.x,a.y,a.z,a.w)},x3dom.fields.SFVec4f.parse=function(a){var b=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);return new x3dom.fields.SFVec4f(+b[1],+b[2],+b[3],+b[4])},x3dom.fields.SFVec4f.prototype.setValueByStr=function(a){var b=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);return this.x=+b[1],this.y=+b[2],this.z=+b[3],this.w=+b[4],this},x3dom.fields.SFVec4f.prototype.toGL=function(){return[this.x,this.y,this.z,this.w]},x3dom.fields.SFVec4f.prototype.toString=function(){return this.x+" "+this.y+" "+this.z+" "+this.w},x3dom.fields.Quaternion=function(a,b,c,d){0===arguments.length?(this.x=0,this.y=0,this.z=1,this.w=0):(this.x=a,this.y=b,this.z=c,this.w=d)},x3dom.fields.Quaternion.copy=function(a){return new x3dom.fields.Quaternion(a.x,a.y,a.z,a.w)},x3dom.fields.Quaternion.prototype.multiply=function(a){return new x3dom.fields.Quaternion(this.w*a.x+this.x*a.w+this.y*a.z-this.z*a.y,this.w*a.y+this.y*a.w+this.z*a.x-this.x*a.z,this.w*a.z+this.z*a.w+this.x*a.y-this.y*a.x,this.w*a.w-this.x*a.x-this.y*a.y-this.z*a.z)},x3dom.fields.Quaternion.parseAxisAngle=function(a){var b=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);return x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+b[1],+b[2],+b[3]),+b[4])},x3dom.fields.Quaternion.axisAngle=function(a,b){var c=a.length();if(c>x3dom.fields.Eps){var d=Math.sin(b/2)/c,e=Math.cos(b/2);return new x3dom.fields.Quaternion(a.x*d,a.y*d,a.z*d,e)}return new x3dom.fields.Quaternion(0,0,0,1)},x3dom.fields.Quaternion.prototype.toMatrix=function(){var a=this.x*this.x,b=this.x*this.y,c=this.x*this.z,d=this.y*this.y,e=this.y*this.z,f=this.z*this.z,g=this.w*this.x,h=this.w*this.y,i=this.w*this.z;return new x3dom.fields.SFMatrix4f(1-2*(d+f),2*(b-i),2*(c+h),0,2*(b+i),1-2*(a+f),2*(e-g),0,2*(c-h),2*(e+g),1-2*(a+d),0,0,0,0,1)},x3dom.fields.Quaternion.prototype.toAxisAngle=function(){var a=0,b=0,c=0,d=0,e=0,f=this;return this.w>1&&(f=x3dom.fields.Quaternion.normalize(this)),e=2*Math.acos(f.w),d=Math.sqrt(1-f.w*f.w),0==d?(a=f.x,b=f.y,c=f.z):(a=f.x/d,b=f.y/d,c=f.z/d),[new x3dom.fields.SFVec3f(a,b,c),e]},x3dom.fields.Quaternion.prototype.angle=function(){return 2*Math.acos(this.w)},x3dom.fields.Quaternion.prototype.setValue=function(a){var b,c=1,d=[0,0,0],e=0,f=0,g=0,h=[1,2,0];if(b=a._00+a._11+a._22,b>0?(c=Math.sqrt(b+1),this.w=.5*c,c=.5/c,this.x=(a._21-a._12)*c,this.y=(a._02-a._20)*c,this.z=(a._10-a._01)*c):(e=a._11>a._00?1:0,a._22>a.at(e,e)&&(e=2),f=h[e],g=h[f],c=Math.sqrt(a.at(e,e)-(a.at(f,f)+a.at(g,g))+1),d[e]=.5*c,c=.5/c,this.w=(a.at(g,f)-a.at(f,g))*c,d[f]=(a.at(f,e)+a.at(e,f))*c,d[g]=(a.at(g,e)+a.at(e,g))*c,this.x=d[0],this.y=d[1],this.z=d[2]),this.w>1||this.w<-1){var i=1+100*x3dom.fields.Eps;(this.w>i||this.w<-i)&&x3dom.debug.logInfo("MatToQuat: BUG: |quat[4]| ("+this.w+") >> 1.0 !"),this.w=this.w>1?1:-1}},x3dom.fields.Quaternion.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z+this.w*a.w},x3dom.fields.Quaternion.prototype.add=function(a){return new x3dom.fields.Quaternion(this.x+a.x,this.y+a.y,this.z+a.z,this.w+a.w)},x3dom.fields.Quaternion.prototype.subtract=function(a){return new x3dom.fields.Quaternion(this.x-a.x,this.y-a.y,this.z-a.z,this.w-a.w)},x3dom.fields.Quaternion.prototype.setValues=function(a){this.x=a.x,this.y=a.y,this.z=a.z,this.w=a.w},x3dom.fields.Quaternion.prototype.equals=function(a,b){return this.dot(a)>=1-b},x3dom.fields.Quaternion.prototype.multScalar=function(a){return new x3dom.fields.Quaternion(this.x*a,this.y*a,this.z*a,this.w*a)},x3dom.fields.Quaternion.prototype.normalize=function(a){var b=this.dot(a),c=1;return b&&(c=1/Math.sqrt(b)),new x3dom.fields.Quaternion(this.x*c,this.y*c,this.z*c,this.w*c)},x3dom.fields.Quaternion.prototype.negate=function(){return new x3dom.fields.Quaternion(-this.x,-this.y,-this.z,-this.w)},x3dom.fields.Quaternion.prototype.inverse=function(){return new x3dom.fields.Quaternion(-this.x,-this.y,-this.z,this.w)},x3dom.fields.Quaternion.prototype.slerp=function(a,b){var c,d=this.dot(a);0>d?(d=-d,c=a.negate()):c=new x3dom.fields.Quaternion(a.x,a.y,a.z,a.w);var e,f;if(1-d>1e-5){var g=Math.acos(d),h=Math.sin(g);e=Math.sin((1-b)*g)/h,f=Math.sin(b*g)/h}else e=1-b,f=b;return this.multScalar(e).add(c.multScalar(f))},x3dom.fields.Quaternion.rotateFromTo=function(a,b){var c=a.normalize(),d=b.normalize(),e=c.dot(d);if(e>.99999)return new x3dom.fields.Quaternion(0,0,0,1);if(-.99999>e){var f=new x3dom.fields.SFVec3f(1,0,0),g=c.cross(f);return g.length()<1e-5&&(f.x=0,f.y=1,f.z=0,g=c.cross(f)),g=g.normalize(),x3dom.fields.Quaternion.axisAngle(g,Math.PI)}var h=a.cross(b);h=h.normalize();var i=Math.sqrt(.5*(1-e));return h=h.multiply(i),i=Math.sqrt(.5*(1+e)),new x3dom.fields.Quaternion(h.x,h.y,h.z,i)},x3dom.fields.Quaternion.prototype.toGL=function(){var a=this.toAxisAngle();return[a[0].x,a[0].y,a[0].z,a[1]]},x3dom.fields.Quaternion.prototype.toString=function(){return this.x+" "+this.y+" "+this.z+", "+this.w},x3dom.fields.Quaternion.prototype.setValueByStr=function(a){var b=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a),c=x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+b[1],+b[2],+b[3]),+b[4]);return this.x=c.x,this.y=c.y,this.z=c.z,this.w=c.w,this},x3dom.fields.SFColor=function(a,b,c){0===arguments.length?(this.r=0,this.g=0,this.b=0):(this.r=a,this.g=b,this.b=c)},x3dom.fields.SFColor.parse=function(a){try{var b=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);return new x3dom.fields.SFColor(+b[1],+b[2],+b[3])}catch(c){return x3dom.fields.SFColor.colorParse(a)}},x3dom.fields.SFColor.prototype.setHSV=function(){x3dom.debug.logWarning("SFColor.setHSV() NYI")},x3dom.fields.SFColor.prototype.getHSV=function(){var a=0,b=0,c=0;return x3dom.debug.logWarning("SFColor.getHSV() NYI"),[a,b,c]},x3dom.fields.SFColor.prototype.setValues=function(a){this.r=a.r,this.g=a.g,this.b=a.b},x3dom.fields.SFColor.prototype.equals=function(a,b){return Math.abs(this.r-a.r)<b&&Math.abs(this.g-a.g)<b&&Math.abs(this.b-a.b)<b},x3dom.fields.SFColor.prototype.add=function(a){return new x3dom.fields.SFColor(this.r+a.r,this.g+a.g,this.b+a.b)},x3dom.fields.SFColor.prototype.subtract=function(a){return new x3dom.fields.SFColor(this.r-a.r,this.g-a.g,this.b-a.b)},x3dom.fields.SFColor.prototype.multiply=function(a){return new x3dom.fields.SFColor(this.r*a,this.g*a,this.b*a)},x3dom.fields.SFColor.prototype.toGL=function(){return[this.r,this.g,this.b]},x3dom.fields.SFColor.prototype.toString=function(){return this.r+" "+this.g+" "+this.b},x3dom.fields.SFColor.prototype.setValueByStr=function(a){try{var b=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);this.r=+b[1],this.g=+b[2],this.b=+b[3]}catch(c){var d=x3dom.fields.SFColor.colorParse(a);this.r=d.r,this.g=d.g,this.b=d.b}return this},x3dom.fields.SFColor.colorParse=function(a){var b=0,c=0,d=0,e={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};if(e[a]&&(a="#"+e[a]),a.substr&&"#"===a.substr(0,1)){a=a.substr(1);var f=a.length;6===f?(b=parseInt("0x"+a.substr(0,2),16)/255,c=parseInt("0x"+a.substr(2,2),16)/255,d=parseInt("0x"+a.substr(4,2),16)/255):3===f&&(b=parseInt("0x"+a.substr(0,1),16)/15,c=parseInt("0x"+a.substr(1,1),16)/15,d=parseInt("0x"+a.substr(2,1),16)/15)}return new x3dom.fields.SFColor(b,c,d)},x3dom.fields.SFColorRGBA=function(a,b,c,d){0===arguments.length?(this.r=0,this.g=0,this.b=0,this.a=1):(this.r=a,this.g=b,this.b=c,this.a=d)},x3dom.fields.SFColorRGBA.parse=function(a){try{var b=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(a);return new x3dom.fields.SFColorRGBA(+b[1],+b[2],+b[3],+b[4])}catch(c){return x3dom.fields.SFColorRGBA.colorParse(a)}},x3dom.fields.SFColorRGBA.prototype.setValues=function(a){this.r=a.r,this.g=a.g,this.b=a.b,this.a=a.a},x3dom.fields.SFColorRGBA.prototype.equals=function(a,b){return Math.abs(this.r-a.r)<b&&Math.abs(this.g-a.g)<b&&Math.abs(this.b-a.b)<b&&Math.abs(this.a-a.a)<b},x3dom.fields.SFColorRGBA.prototype.toGL=function(){return[this.r,this.g,this.b,this.a]},x3dom.fields.SFColorRGBA.prototype.toString=function(){return this.r+" "+this.g+" "+this.b+" "+this.a},x3dom.fields.SFColorRGBA.prototype.setValueByStr=function(a){try{var b=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(a);this.r=+b[1],this.g=+b[2],this.b=+b[3],this.a=+b[4]}catch(c){var d=x3dom.fields.SFColorRGBA.colorParse(a);this.r=d.r,this.g=d.g,this.b=d.b,this.a=d.a}return this},x3dom.fields.SFImage=function(a,b,c,d){if(0!==arguments.length&&d&&d.map){this.width=a,this.height=b,this.comp=c;var e=this.array;d.map(function(a){e.push(a)},this.array)}else this.width=0,this.height=0,this.comp=0,this.array=[]},x3dom.fields.SFImage.parse=function(a){var b=new x3dom.fields.SFImage;return b.setValueByStr(a),b},x3dom.fields.SFImage.prototype.setValueByStr=function(a){var b=a.match(/(\w+)/g),c=b.length,d=0,e="0123456789ABCDEF";if(this.array=[],!(c>2))return this.width=0,this.height=0,this.comp=0,void 0;this.width=+b[0],this.height=+b[1],this.comp=+b[2],d=2*this.comp;var f,g;for(g=3;c>g;g++)if(b[g].substr){if("x"!==b[g].substr(1,1).toLowerCase()){for(var h="",i=parseInt(b[g],10);0!==i;)h=e.charAt(i%16)+h,i>>=4;for(f=h.length;h.length<d;)h="0"+h;b[g]="0x"+h}if("x"===b[g].substr(1,1).toLowerCase()){b[g]=b[g].substr(2),f=b[g].length;var j,k,l,m;f===d&&(1===this.comp?(j=parseInt("0x"+b[g].substr(0,2),16),this.array.push(j)):2===this.comp?(j=parseInt("0x"+b[g].substr(0,2),16),k=parseInt("0x"+b[g].substr(2,2),16),this.array.push(j,k)):3===this.comp?(j=parseInt("0x"+b[g].substr(0,2),16),k=parseInt("0x"+b[g].substr(2,2),16),l=parseInt("0x"+b[g].substr(4,2),16),this.array.push(j,k,l)):4===this.comp&&(j=parseInt("0x"+b[g].substr(0,2),16),k=parseInt("0x"+b[g].substr(2,2),16),l=parseInt("0x"+b[g].substr(4,2),16),m=parseInt("0x"+b[g].substr(6,2),16),this.array.push(j,k,l,m)))}}},x3dom.fields.SFImage.prototype.toGL=function(){var a=[];return Array.map(this.array,function(b){a.push(b)}),a},x3dom.fields.MFColor=function(a){if(0===arguments.length);else{var b=this;a.map(function(a){b.push(a)},this)}},x3dom.fields.MFColor.prototype=x3dom.extend([]),x3dom.fields.MFColor.parse=function(a){for(var b=a.match(/([+\-0-9eE\.]+)/g),c=[],d=0,e=b?b.length:0;e>d;d+=3)c.push(new x3dom.fields.SFColor(+b[d+0],+b[d+1],+b[d+2]));return new x3dom.fields.MFColor(c)},x3dom.fields.MFColor.prototype.setValueByStr=function(a){for(;this.length;)this.pop();for(var b=a.match(/([+\-0-9eE\.]+)/g),c=0,d=b?b.length:0;d>c;c+=3)this.push(new x3dom.fields.SFColor(+b[c+0],+b[c+1],+b[c+2]))},x3dom.fields.MFColor.prototype.toGL=function(){var a=[];return Array.map(this,function(b){a.push(b.r),a.push(b.g),a.push(b.b)}),a},x3dom.fields.MFColorRGBA=function(a){if(0===arguments.length);else{var b=this;a.map(function(a){b.push(a)},this)}},x3dom.fields.MFColorRGBA.prototype=x3dom.extend([]),x3dom.fields.MFColorRGBA.parse=function(a){for(var b=a.match(/([+\-0-9eE\.]+)/g),c=[],d=0,e=b?b.length:0;e>d;d+=4)c.push(new x3dom.fields.SFColorRGBA(+b[d+0],+b[d+1],+b[d+2],+b[d+3]));return new x3dom.fields.MFColorRGBA(c)},x3dom.fields.MFColorRGBA.prototype.setValueByStr=function(a){for(;this.length;)this.pop();for(var b=a.match(/([+\-0-9eE\.]+)/g),c=0,d=b?b.length:0;d>c;c+=4)this.push(new x3dom.fields.SFColor(+b[c+0],+b[c+1],+b[c+2],+b[c+3]))},x3dom.fields.MFColorRGBA.prototype.toGL=function(){var a=[];return Array.map(this,function(b){a.push(b.r),a.push(b.g),a.push(b.b),a.push(b.a)}),a},x3dom.fields.MFRotation=function(a){if(0===arguments.length);else{var b=this;a.map(function(a){b.push(a)},this)}},x3dom.fields.MFRotation.prototype=x3dom.extend([]),x3dom.fields.MFRotation.parse=function(a){for(var b=a.match(/([+\-0-9eE\.]+)/g),c=[],d=0,e=b?b.length:0;e>d;d+=4)c.push(x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+b[d+0],+b[d+1],+b[d+2]),+b[d+3]));return new x3dom.fields.MFRotation(c)},x3dom.fields.MFRotation.prototype.setValueByStr=function(a){for(;this.length;)this.pop();for(var b=a.match(/([+\-0-9eE\.]+)/g),c=0,d=b?b.length:0;d>c;c+=4)this.push(x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+b[c+0],+b[c+1],+b[c+2]),+b[c+3]))},x3dom.fields.MFRotation.prototype.toGL=function(){var a=[];return Array.map(this,function(b){var c=b.toAxisAngle();a.push(c[0].x),a.push(c[0].y),a.push(c[0].z),a.push(c[1])}),a},x3dom.fields.MFVec3f=function(a){if(0===arguments.length);else{var b=this;a.map(function(a){b.push(a)},this)}},x3dom.fields.MFVec3f.copy=function(a){var b=new x3dom.fields.MFVec3f;return a.map(function(a){b.push(x3dom.fields.SFVec3f.copy(a))},this),b},x3dom.fields.MFVec3f.prototype=x3dom.extend([]),x3dom.fields.MFVec3f.parse=function(a){for(var b=a.match(/([+\-0-9eE\.]+)/g),c=[],d=0,e=b?b.length:0;e>d;d+=3)c.push(new x3dom.fields.SFVec3f(+b[d+0],+b[d+1],+b[d+2]));return new x3dom.fields.MFVec3f(c)},x3dom.fields.MFVec3f.prototype.setValueByStr=function(a){for(;this.length;)this.pop();for(var b=a.match(/([+\-0-9eE\.]+)/g),c=0,d=b?b.length:0;d>c;c+=3)this.push(new x3dom.fields.SFVec3f(+b[c+0],+b[c+1],+b[c+2]))},x3dom.fields.MFVec3f.prototype.toGL=function(){var a=[];return Array.map(this,function(b){a.push(b.x),a.push(b.y),a.push(b.z)}),a},x3dom.fields.MFVec2f=function(a){if(0===arguments.length);else{var b=this;a.map(function(a){b.push(a)},this)}},x3dom.fields.MFVec2f.prototype=x3dom.extend([]),x3dom.fields.MFVec2f.parse=function(a){for(var b=a.match(/([+\-0-9eE\.]+)/g),c=[],d=0,e=b?b.length:0;e>d;d+=2)c.push(new x3dom.fields.SFVec2f(+b[d+0],+b[d+1]));return new x3dom.fields.MFVec2f(c)},x3dom.fields.MFVec2f.prototype.setValueByStr=function(a){for(;this.length;)this.pop();for(var b=a.match(/([+\-0-9eE\.]+)/g),c=0,d=b?b.length:0;d>c;c+=2)this.push(new x3dom.fields.SFVec2f(+b[c+0],+b[c+1]))},x3dom.fields.MFVec2f.prototype.toGL=function(){var a=[];return Array.map(this,function(b){a.push(b.x),a.push(b.y)}),a},x3dom.fields.MFInt32=function(a){if(0===arguments.length);else if(a&&a.map){var b=this;a.map(function(a){b.push(a)},this)}},x3dom.fields.MFInt32.prototype=x3dom.extend([]),x3dom.fields.MFInt32.parse=function(a){for(var b=a.match(/([+\-]?\d+\s*){1},?\s*/g),c=[],d=0,e=b?b.length:0;e>d;++d)c.push(parseInt(b[d],10));return new x3dom.fields.MFInt32(c)},x3dom.fields.MFInt32.prototype.setValueByStr=function(a){for(;this.length;)this.pop();for(var b=a.match(/([+\-]?\d+\s*){1},?\s*/g),c=0,d=b?b.length:0;d>c;++c)this.push(parseInt(b[c],10))},x3dom.fields.MFInt32.prototype.toGL=function(){var a=[];return Array.map(this,function(b){a.push(b)}),a},x3dom.fields.MFFloat=function(a){if(0===arguments.length);else if(a&&a.map){var b=this;a.map(function(a){b.push(a)},this)}},x3dom.fields.MFFloat.prototype=x3dom.extend([]),x3dom.fields.MFFloat.parse=function(a){for(var b=a.match(/([+\-0-9eE\.]+)/g),c=[],d=0,e=b?b.length:0;e>d;d++)c.push(+b[d]);return new x3dom.fields.MFFloat(c)},x3dom.fields.MFFloat.prototype.setValueByStr=function(a){for(;this.length;)this.pop();for(var b=a.match(/([+\-0-9eE\.]+)/g),c=0,d=b?b.length:0;d>c;c++)this.push(+b[c])},x3dom.fields.MFFloat.prototype.toGL=function(){var a=[];return Array.map(this,function(b){a.push(b)}),a},x3dom.fields.MFBoolean=function(a){if(0===arguments.length);else if(a&&a.map){var b=this;a.map(function(a){b.push(a)},this)}},x3dom.fields.MFBoolean.prototype=x3dom.extend([]),x3dom.fields.MFBoolean.parse=function(){var a=[];return new x3dom.fields.MFBoolean(a)},x3dom.fields.MFBoolean.prototype.setValueByStr=function(){for(;this.length;)this.pop()},x3dom.fields.MFBoolean.prototype.toGL=function(){var a=[];return Array.map(this,function(b){a.push(b)}),a},x3dom.fields.MFString=function(a){if(0===arguments.length);else if(a&&a.map){var b=this;a.map(function(a){b.push(a)},this)}},x3dom.fields.MFString.parse=function(a){var b=[];if(a.length&&'"'==a[0])for(var c,d=/"((?:[^\\"]|\\\\|\\")*)"/g;c=d.exec(a);){var e=c[1].replace(/\\([\\"])/,"$1");void 0!==e&&b.push(e)}else b.push(a);return new x3dom.fields.MFString(b)},x3dom.fields.MFString.prototype=x3dom.extend([]),x3dom.fields.MFString.prototype.setValueByStr=function(a){for(var b=this;b.length;)b.pop();if(a.length&&'"'==a[0])for(var c,d=/"((?:[^\\"]|\\\\|\\")*)"/g;c=d.exec(a);){var e=c[1].replace(/\\([\\"])/,"$1");void 0!==e&&b.push(e)}else b.push(a);return this},x3dom.fields.MFString.prototype.toString=function(){for(var a="",b=0;b<this.length;b++)a=a+this[b]+" ";return a},x3dom.fields.SFNode=function(a){this.type=a,this.node=null},x3dom.fields.SFNode.prototype.hasLink=function(a){return a?this.node===a:this.node},x3dom.fields.SFNode.prototype.addLink=function(a){return this.node=a,!0},x3dom.fields.SFNode.prototype.rmLink=function(a){return this.node===a?(this.node=null,!0):!1},x3dom.fields.MFNode=function(a){this.type=a,this.nodes=[]},x3dom.fields.MFNode.prototype.hasLink=function(a){if(!a)return this.length>0;for(var b=0,c=this.nodes.length;c>b;b++)if(this.nodes[b]===a)return!0;return!1},x3dom.fields.MFNode.prototype.addLink=function(a){return this.nodes.push(a),!0},x3dom.fields.MFNode.prototype.rmLink=function(a){for(var b=0,c=this.nodes.length;c>b;b++)if(this.nodes[b]===a)return this.nodes.splice(b,1),!0;
return!1},x3dom.fields.MFNode.prototype.length=function(){return this.nodes.length},x3dom.fields.Line=function(a,b){if(0===arguments.length)this.pos=new x3dom.fields.SFVec3f(0,0,0),this.dir=new x3dom.fields.SFVec3f(0,0,1);else{this.pos=new x3dom.fields.SFVec3f(a.x,a.y,a.z);var c=b.length();c&&(c=1/c),this.dir=new x3dom.fields.SFVec3f(b.x*c,b.y*c,b.z*c)}this.enter=0,this.exit=0,this.hitObject=null,this.hitPoint={},this.dist=Number.MAX_VALUE},x3dom.fields.Line.prototype.toString=function(){return"Line: ["+this.pos.toString()+"; "+this.dir.toString()+"]"},x3dom.fields.Line.prototype.intersect=function(a,b){var c,d,e,f=0,g=Number.MAX_VALUE;if(this.dir.x>x3dom.fields.Eps)c=1/this.dir.x,d=(a.x-this.pos.x)*c,e=(b.x-this.pos.x)*c,g>e&&(g=e),d>f&&(f=d);else if(this.dir.x<-x3dom.fields.Eps)c=1/this.dir.x,d=(b.x-this.pos.x)*c,e=(a.x-this.pos.x)*c,g>e&&(g=e),d>f&&(f=d);else if(this.pos.x<a.x||this.pos.x>b.x)return!1;if(this.dir.y>x3dom.fields.Eps){if(c=1/this.dir.y,d=(a.y-this.pos.y)*c,e=(b.y-this.pos.y)*c,g>e&&(g=e),d>f&&(f=d),f-g>=x3dom.fields.Eps)return!1}else if(this.dir.y<-x3dom.fields.Eps){if(c=1/this.dir.y,d=(b.y-this.pos.y)*c,e=(a.y-this.pos.y)*c,g>e&&(g=e),d>f&&(f=d),f-g>=x3dom.fields.Eps)return!1}else if(this.pos.y<a.y||this.pos.y>b.y)return!1;if(this.dir.z>x3dom.fields.Eps)c=1/this.dir.z,d=(a.z-this.pos.z)*c,e=(b.z-this.pos.z)*c,g>e&&(g=e),d>f&&(f=d);else if(this.dir.z<-x3dom.fields.Eps)c=1/this.dir.z,d=(b.z-this.pos.z)*c,e=(a.z-this.pos.z)*c,g>e&&(g=e),d>f&&(f=d);else if(this.pos.z<a.z||this.pos.z>b.z)return!1;return this.enter=f,this.exit=g,f-g<x3dom.fields.Eps},x3dom.fields.BoxVolume=function(a,b){arguments.length<2?(this.min=new x3dom.fields.SFVec3f(0,0,0),this.max=new x3dom.fields.SFVec3f(0,0,0),this.valid=!1):(this.min=x3dom.fields.SFVec3f.copy(a),this.max=x3dom.fields.SFVec3f.copy(b),this.valid=!0),this.updateInternals()},x3dom.fields.BoxVolume.copy=function(a){return new x3dom.fields.BoxVolume(a.min,a.max)},x3dom.fields.BoxVolume.prototype.updateInternals=function(){this.radialVec=this.max.subtract(this.min).multiply(.5),this.center=this.min.add(this.radialVec),this.diameter=2*this.radialVec.length()},x3dom.fields.BoxVolume.prototype.setBounds=function(a,b){this.min.setValues(a),this.max.setValues(b),this.updateInternals(),this.valid=!0},x3dom.fields.BoxVolume.prototype.setBoundsByCenterSize=function(a,b){var c=b.multiply(.5);this.min=a.subtract(c),this.max=a.add(c),this.updateInternals(),this.valid=!0},x3dom.fields.BoxVolume.prototype.extendBounds=function(a,b){this.valid?(this.min.x>a.x&&(this.min.x=a.x),this.min.y>a.y&&(this.min.y=a.y),this.min.z>a.z&&(this.min.z=a.z),this.max.x<b.x&&(this.max.x=b.x),this.max.y<b.y&&(this.max.y=b.y),this.max.z<b.z&&(this.max.z=b.z),this.updateInternals()):this.setBounds(a,b)},x3dom.fields.BoxVolume.prototype.getBounds=function(a,b){a.setValues(this.min),b.setValues(this.max)},x3dom.fields.BoxVolume.prototype.getRadialVec=function(){return this.radialVec},x3dom.fields.BoxVolume.prototype.invalidate=function(){this.valid=!1},x3dom.fields.BoxVolume.prototype.isValid=function(){return this.valid},x3dom.fields.BoxVolume.prototype.getCenter=function(){return this.center},x3dom.fields.BoxVolume.prototype.getDiameter=function(){return this.diameter},x3dom.fields.BoxVolume.prototype.transform=function(a){var b,c,d,e,f,g;b=e=a._03,c=f=a._13,d=g=a._23;var h=this.max.x*a._00,i=this.min.x*a._00;h>=i?(e+=h,b+=i):(e+=i,b+=h),h=this.max.y*a._01,i=this.min.y*a._01,h>=i?(e+=h,b+=i):(e+=i,b+=h),h=this.max.z*a._02,i=this.min.z*a._02,h>=i?(e+=h,b+=i):(e+=i,b+=h),h=this.max.x*a._10,i=this.min.x*a._10,h>=i?(f+=h,c+=i):(f+=i,c+=h),h=this.max.y*a._11,i=this.min.y*a._11,h>=i?(f+=h,c+=i):(f+=i,c+=h),h=this.max.z*a._12,i=this.min.z*a._12,h>=i?(f+=h,c+=i):(f+=i,c+=h),h=this.max.x*a._20,i=this.min.x*a._20,h>=i?(g+=h,d+=i):(g+=i,d+=h),h=this.max.y*a._21,i=this.min.y*a._21,h>=i?(g+=h,d+=i):(g+=i,d+=h),h=this.max.z*a._22,i=this.min.z*a._22,h>=i?(g+=h,d+=i):(g+=i,d+=h),this.min.x=b,this.min.y=c,this.min.z=d,this.max.x=e,this.max.y=f,this.max.z=g,this.updateInternals()},x3dom.fields.BoxVolume.prototype.transformFrom=function(a,b){var c,d,e,f,g,h;c=f=a._03,d=g=a._13,e=h=a._23;var i=b.max.x*a._00,j=b.min.x*a._00;i>=j?(f+=i,c+=j):(f+=j,c+=i),i=b.max.y*a._01,j=b.min.y*a._01,i>=j?(f+=i,c+=j):(f+=j,c+=i),i=b.max.z*a._02,j=b.min.z*a._02,i>=j?(f+=i,c+=j):(f+=j,c+=i),i=b.max.x*a._10,j=b.min.x*a._10,i>=j?(g+=i,d+=j):(g+=j,d+=i),i=b.max.y*a._11,j=b.min.y*a._11,i>=j?(g+=i,d+=j):(g+=j,d+=i),i=b.max.z*a._12,j=b.min.z*a._12,i>=j?(g+=i,d+=j):(g+=j,d+=i),i=b.max.x*a._20,j=b.min.x*a._20,i>=j?(h+=i,e+=j):(h+=j,e+=i),i=b.max.y*a._21,j=b.min.y*a._21,i>=j?(h+=i,e+=j):(h+=j,e+=i),i=b.max.z*a._22,j=b.min.z*a._22,i>=j?(h+=i,e+=j):(h+=j,e+=i),this.min.x=c,this.min.y=d,this.min.z=e,this.max.x=f,this.max.y=g,this.max.z=h,this.updateInternals(),this.valid=!0},x3dom.fields.FrustumVolume=function(a){if(this.planeNormals=[],this.planeDistances=[],this.directionIndex=[],0!==arguments.length){for(var b=[],c=0;6>c;c++)this.planeNormals[c]=new x3dom.fields.SFVec3f(0,0,0),this.planeDistances[c]=0,this.directionIndex[c]=0,b[c]=new x3dom.fields.SFVec4f(0,0,0,0);for(b[0].x=a._30-a._00,b[0].y=a._31-a._01,b[0].z=a._32-a._02,b[0].w=a._33-a._03,b[1].x=a._30+a._00,b[1].y=a._31+a._01,b[1].z=a._32+a._02,b[1].w=a._33+a._03,b[2].x=a._30+a._10,b[2].y=a._31+a._11,b[2].z=a._32+a._12,b[2].w=a._33+a._13,b[3].x=a._30-a._10,b[3].y=a._31-a._11,b[3].z=a._32-a._12,b[3].w=a._33-a._13,b[4].x=a._30+a._20,b[4].y=a._31+a._21,b[4].z=a._32+a._22,b[4].w=a._33+a._23,b[5].x=a._30-a._20,b[5].y=a._31-a._21,b[5].z=a._32-a._22,b[5].w=a._33-a._23,c=0;6>c;c++){var d=Math.sqrt(b[c].x*b[c].x+b[c].y*b[c].y+b[c].z*b[c].z);b[c].x/=d,b[c].y/=d,b[c].z/=d,b[c].w/=-d}var e=function(a){var b=0;return a.x>0&&(b|=1),a.y>0&&(b|=2),a.z>0&&(b|=4),b};this.planeNormals[3].setValues(b[0]),this.planeDistances[3]=b[0].w,this.directionIndex[3]=e(this.planeNormals[3]),this.planeNormals[2].setValues(b[1]),this.planeDistances[2]=b[1].w,this.directionIndex[2]=e(this.planeNormals[2]),this.planeNormals[5].setValues(b[2]),this.planeDistances[5]=b[2].w,this.directionIndex[5]=e(this.planeNormals[5]),this.planeNormals[4].setValues(b[3]),this.planeDistances[4]=b[3].w,this.directionIndex[4]=e(this.planeNormals[4]),this.planeNormals[0].setValues(b[4]),this.planeDistances[0]=b[4].w,this.directionIndex[0]=e(this.planeNormals[0]),this.planeNormals[1].setValues(b[5]),this.planeDistances[1]=b[5].w,this.directionIndex[1]=e(this.planeNormals[1])}},x3dom.fields.FrustumVolume.prototype.intersect=function(a,b){if(this.planeNormals.length<6)return x3dom.debug.logWarning("FrustumVolume not initialized!"),!1;var c=this,d=a.min,e=a.max,f=function(a){var b=new x3dom.fields.SFVec3f(0,0,0);return b.x=1&a?d.x:e.x,b.y=2&a?d.y:e.y,b.z=4&a?d.z:e.z,b},g=function(a,b){var d=c.planeNormals[a].dot(b)-c.planeDistances[a];return d>=0},h=function(a){var b=f(c.directionIndex[a]);return g(a,b)},i=function(a){var b=f(7^c.directionIndex[a]);return!g(a,b)},j=1;0>b&&(b=0);for(var k=0;6>k;k++,j<<=1)if(0==(b&j)){if(i(k))return-1;h(k)&&(b|=j)}return b},x3dom.NodeNameSpace=function(a,b){this.name=a,this.doc=b,this.baseURL="",this.defMap={},this.parent=null,this.childSpaces=[]},x3dom.NodeNameSpace.prototype.addNode=function(a,b){this.defMap[b]=a,a._nameSpace=this},x3dom.NodeNameSpace.prototype.removeNode=function(a){var b=a?this.defMap[a]:null;b&&(delete this.defMap[a],b._nameSpace=null)},x3dom.NodeNameSpace.prototype.getNamedNode=function(a){return this.defMap[a]},x3dom.NodeNameSpace.prototype.getNamedElement=function(a){var b=this.defMap[a];return b?b._xmlNode:null},x3dom.NodeNameSpace.prototype.addSpace=function(a){this.childSpaces.push(a),a.parent=this},x3dom.NodeNameSpace.prototype.removeSpace=function(a){a.parent=null;for(var b=0;b<this.childSpaces.length;b++)this.childSpaces[b]==a&&this.childSpaces.splice(b,1)},x3dom.NodeNameSpace.prototype.setBaseURL=function(a){var b=a.lastIndexOf("/");this.baseURL=b>=0?a.substr(0,b+1):"",x3dom.debug.logInfo("setBaseURL: "+this.baseURL)},x3dom.NodeNameSpace.prototype.getURL=function(a){return void 0!==a&&a.length?"/"===a[0]||a.indexOf(":")>=0?a:this.baseURL+a:""},x3dom.hasElementAttribute=function(a){var b=this.__hasAttribute(a);return!b&&a&&(b=this.__hasAttribute(a.toLowerCase())),b},x3dom.getElementAttribute=function(a){var b=this.__getAttribute(a);return!b&&a&&(b=this.__getAttribute(a.toLowerCase())),b||!this._x3domNode?b:this._x3domNode._vf[a]},x3dom.setElementAttribute=function(a,b){this.__setAttribute(a,b);var c=this._x3domNode;c&&(c.updateField(a,b),c._nameSpace.doc.needRender=!0)},x3dom.NodeNameSpace.prototype.setupTree=function(a){var b=null;if(x3dom.isX3DElement(a)){if(a._x3domNode)return x3dom.debug.logWarning("Tree is already initialized"),null;if(void 0===a.tagName||a.__addEventListener||a.__removeEventListener||(a.__addEventListener=a.addEventListener,a.addEventListener=function(a,b,c){this._x3domNode._listeners[a]||(this._x3domNode._listeners[a]=[]),this._x3domNode._listeners[a].push(b),this.__addEventListener(a,b,c)},a.__removeEventListener=a.removeEventListener,a.removeEventListener=function(a,b,c){var d=this._x3domNode._listeners[a];if(d)for(var e=0;e<d.length;e++)d[e]==b&&d.splice(e,1);this.__removeEventListener(a,b,c)}),a.hasAttribute("USE")){if(b=this.defMap[a.getAttribute("USE")],!b){var c=a.getAttribute("USE").split("__");if(c.length>=2){for(var d=this;d;)d.name==c[0]&&(b=d.defMap[c[1]]),d=b?null:d.parent;b||(b=null,x3dom.debug.logWarning("Could not USE: "+a.getAttribute("USE")))}}return b&&(a._x3domNode=b),b}if("route"===a.localName.toLowerCase()){var e=a,f=this.defMap[e.getAttribute("fromNode")],g=this.defMap[e.getAttribute("toNode")];return f&&g?(f.setupRoute(e.getAttribute("fromField"),g,e.getAttribute("toField")),e._nodeNameSpace=this,null):(x3dom.debug.logWarning("Broken route - can't find all DEFs for "+e.getAttribute("fromNode")+" -> "+e.getAttribute("toNode")),null)}var h=x3dom.nodeTypesLC[a.localName.toLowerCase()];if(void 0!==h){x3dom.userAgentFeature.supportsDOMAttrModified===!1&&a instanceof Element&&(a.setAttribute&&!a.__setAttribute&&(a.__setAttribute=a.setAttribute,a.setAttribute=x3dom.setElementAttribute),a.getAttribute&&!a.__getAttribute&&(a.__getAttribute=a.getAttribute,a.getAttribute=x3dom.getElementAttribute),a.hasAttribute&&!a.__hasAttribute&&(a.__hasAttribute=a.hasAttribute,a.hasAttribute=x3dom.hasElementAttribute));var i={doc:this.doc,xmlNode:a,nameSpace:this};b=new h(i),a.hasAttribute("DEF")?(b._DEF=a.getAttribute("DEF"),this.defMap[b._DEF]=b):a.hasAttribute("id")&&(b._DEF=a.getAttribute("id"),this.defMap[b._DEF]=b),void 0===a.highlight&&(a.highlight=function(a,b){var c=x3dom.fields.SFColor.parse(b);this._x3domNode.highlight(a,c),this._x3domNode._nameSpace.doc.needRender=!0}),b._xmlNode=a,a._x3domNode=b;var j=this;return Array.forEach(a.childNodes,function(a){var c=j.setupTree(a);c&&b.addChild(c,a.getAttribute("containerField"))}),b.nodeChanged(),b}x3dom.debug.logWarning("Unrecognised X3D element &lt;"+a.localName+"&gt;.")}else a.localName&&(x3dom.debug.logWarning("Unrecognised X3D element &lt;"+a.localName+"&gt;."),b=null);return b},x3dom.registerNodeType("X3DNode","Core",defineClass(null,function(a){this._xmlNode=null,this._DEF=null,this._nameSpace=a&&a.nameSpace?a.nameSpace:null,this._vf={},this._vfFieldTypes={},this._cf={},this._cfFieldTypes={},this._fieldWatchers={},this._routes={},this._listeners={},this._parentNodes=[],this._childNodes=[],this.addField_SFNode("metadata",x3dom.nodeTypes.X3DMetadataObject)},{type:function(){return this.constructor},typeName:function(){return this.constructor._typeName},addChild:function(a,b){if(a){var c=null;if(b)c=this._cf[b];else for(var d in this._cf)if(this._cf.hasOwnProperty(d)){var e=this._cf[d];if(x3dom.isa(a,e.type)){c=e;break}}if(c&&c.addLink(a))return a._parentNodes.push(this),this._childNodes.push(a),a.parentAdded(this),!0}return!1},removeChild:function(a){if(a)for(var b in this._cf)if(this._cf.hasOwnProperty(b)){var c=this._cf[b];if(c.rmLink(a)){for(var d=a._parentNodes.length-1;d>=0;d--)a._parentNodes[d]===this&&(a._parentNodes.splice(d,1),a.parentRemoved(this));for(var e=this._childNodes.length-1;e>=0;e--)if(this._childNodes[e]===a)return this._childNodes.splice(e,1),!0}}return!1},parentAdded:function(){},parentRemoved:function(){for(var a=0,b=this._childNodes.length;b>a;a++)this._childNodes[a]&&this._childNodes[a].parentRemoved(this)},getCurrentTransform:function(){return this._parentNodes.length>=1?this.transformMatrix(this._parentNodes[0].getCurrentTransform()):x3dom.fields.SFMatrix4f.identity()},transformMatrix:function(a){return a},getVolume:function(){return null},invalidateVolume:function(){},invalidateCache:function(){},volumeValid:function(){return!1},collectDrawableObjects:function(){},highlight:function(a,b){this._vf.hasOwnProperty("diffuseColor")&&(a?(void 0===this._actDiffuseColor&&(this._actDiffuseColor=new x3dom.fields.SFColor,this._highlightOn=!1),this._highlightOn||(this._actDiffuseColor.setValues(this._vf.diffuseColor),this._highlightOn=!0),this._vf.diffuseColor.setValues(b)):void 0!==this._actDiffuseColor&&(this._vf.diffuseColor.setValues(this._actDiffuseColor),this._highlightOn=!1,delete this._actDiffuseColor));for(var c=0,d=this._childNodes.length;d>c;c++)this._childNodes[c]&&this._childNodes[c].highlight(a,b)},findX3DDoc:function(){return this._nameSpace.doc},doIntersect:function(a){for(var b=!1,c=0;c<this._childNodes.length;c++)this._childNodes[c]&&(b=this._childNodes[c].doIntersect(a)||b);return b},postMessage:function(a,b){this._vf[a]=b;var c=this._fieldWatchers[a],d=this;c&&Array.forEach(c,function(a){a.call(d,b)})},updateField:function(a,b){var c=this._vf[a];if(void 0===c){var d="set_";if(0==a.indexOf(d)){var e=a.substr(d.length,a.length-1);void 0!==this._vf[e]&&(a=e,c=this._vf[a])}void 0===c&&(c={},this._vf[a]=c)}if(null!==c){try{this._vf[a].setValueByStr(b)}catch(f){try{switch((typeof this._vf[a]).toString()){case"number":this._vf[a]="number"==typeof b?b:+b;break;case"boolean":this._vf[a]="boolean"==typeof b?b:"true"==b.toLowerCase();break;case"string":this._vf[a]=b}}catch(g){x3dom.debug.logError("updateField: setValueByStr() NYI for "+typeof c)}}this.fieldChanged(a)}},setupRoute:function(a,b,c){var d,e,f="set_",g="_changed";this._vf[a]||(d=a.indexOf(f),0===d?(e=a.substr(f.length,a.length-1),this._vf[e]&&(a=e)):(d=a.indexOf(g),d>0&&(e=a.substr(0,a.length-g.length),this._vf[e]&&(a=e)))),b._vf[c]||(d=c.indexOf(f),0===d?(e=c.substr(f.length,c.length-1),b._vf[e]&&(c=e)):(d=c.indexOf(g),d>0&&(e=c.substr(0,c.length-g.length),b._vf[e]&&(c=e))));var h=this._DEF+"&"+a+"&"+b._DEF+"&"+c;this._routes[h]||(this._fieldWatchers[a]||(this._fieldWatchers[a]=[]),this._fieldWatchers[a].push(function(a){b.postMessage(c,a)}),b._fieldWatchers[c]||(b._fieldWatchers[c]=[]),b._fieldWatchers[c].push(function(a){b._vf[c]=a,b.fieldChanged(c)}),this._routes[h]={from:this._fieldWatchers[a].length-1,to:b._fieldWatchers[c].length-1})},removeRoute:function(a,b,c){var d,e,f="set_",g="_changed";this._vf[a]||(d=a.indexOf(f),0===d?(e=a.substr(f.length,a.length-1),this._vf[e]&&(a=e)):(d=a.indexOf(g),d>0&&(e=a.substr(0,a.length-g.length),this._vf[e]&&(a=e)))),b._vf[c]||(d=c.indexOf(f),0===d?(e=c.substr(f.length,c.length-1),b._vf[e]&&(c=e)):(d=c.indexOf(g),d>0&&(e=c.substr(0,c.length-g.length),b._vf[e]&&(c=e))));var h=this._DEF+"&"+a+"&"+b._DEF+"&"+c;this._routes[h]&&(this._fieldWatchers[a].splice(this._routes[h].from,1),b._fieldWatchers[c].splice(this._routes[h].to,1),delete this._routes[h])},fieldChanged:function(){},nodeChanged:function(){},callEvtHandler:function(a,b){var c=this;if(!c._xmlNode)return b.cancelBubble;try{var d=c._xmlNode[a];if(b.target=c._xmlNode,"function"==typeof d)d.call(c._xmlNode,b);else{var e=c._xmlNode.getAttribute(a),f=new Function("event",e);f.call(c._xmlNode,b)}var g=c._listeners[b.type];if(g)for(var h=0;h<g.length;h++)g[h].call(c._xmlNode,b)}catch(i){x3dom.debug.logException(i)}return b.cancelBubble},initSetter:function(a,b){if(a.__defineSetter__&&a.__defineGetter__?(a.__defineSetter__(b,function(c){a.setAttribute(b,c)}),a.__defineGetter__(b,function(){return a.getAttribute(b)})):Object.defineProperty(a,b,{set:function(c){a.setAttribute(b,c)},get:function(){return a.getAttribute(b)},configurable:!0,enumerable:!0}),this._vf[b]&&!a.attributes[b]&&!a.attributes[b.toLowerCase()]){var c="";try{c=this._vf[b].toGL?this._vf[b].toGL().toString():this._vf[b].toString()}catch(d){c=this._vf[b].toString()}c||(c=""),a.setAttribute(b,c)}},addField_SFInt32:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?parseInt(a.xmlNode.getAttribute(b),10):c,a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFInt32"},addField_SFFloat:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?+a.xmlNode.getAttribute(b):c,a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFFloat"},addField_SFDouble:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?+a.xmlNode.getAttribute(b):c,a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFDouble"},addField_SFTime:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?+a.xmlNode.getAttribute(b):c,a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFTime"},addField_SFBool:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?"true"===a.xmlNode.getAttribute(b).toLowerCase():c,a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFBool"},addField_SFString:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?a.xmlNode.getAttribute(b):c,a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFString"},addField_SFColor:function(a,b,c,d,e){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.SFColor.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.SFColor(c,d,e),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFColor"},addField_SFColorRGBA:function(a,b,c,d,e,f){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.SFColorRGBA.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.SFColorRGBA(c,d,e,f),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFColorRGBA"},addField_SFVec2f:function(a,b,c,d){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.SFVec2f.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.SFVec2f(c,d),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFVec2f"},addField_SFVec3f:function(a,b,c,d,e){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.SFVec3f.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.SFVec3f(c,d,e),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFVec3f"},addField_SFVec3d:function(a,b,c,d,e){this.addField_SFVec3f(a,b,c,d,e),this._vfFieldTypes[b]="SFVec3d"},addField_SFRotation:function(a,b,c,d,e,f){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.Quaternion.parseAxisAngle(a.xmlNode.getAttribute(b)):x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(c,d,e),f),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFRotation"},addField_SFMatrix4f:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.SFMatrix4f.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.SFMatrix4f(c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFMatrix4f"},addField_SFImage:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.SFImage.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.SFImage(c),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="SFImage"},addField_MFString:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.MFString.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.MFString(c),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="MFString"},addField_MFBoolean:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.MFBoolean.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.MFBoolean(c),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="MFBoolean"},addField_MFInt32:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.MFInt32.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.MFInt32(c),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="MFInt32"},addField_MFFloat:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.MFFloat.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.MFFloat(c),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="MFFloat"},addField_MFDouble:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.MFFloat.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.MFFloat(c),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="MFDouble"},addField_MFColor:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.MFColor.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.MFColor(c),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="MFColor"},addField_MFColorRGBA:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.MFColorRGBA.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.MFColorRGBA(c),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="MFColorRGBA"},addField_MFVec2f:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.MFVec2f.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.MFVec2f(c),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="MFVec2f"},addField_MFVec3f:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.MFVec3f.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.MFVec3f(c),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="MFVec3f"},addField_MFVec3d:function(a,b,c){this.addField_MFVec3f(a,b,c),this._vfFieldTypes[b]="MFVec3d"},addField_MFRotation:function(a,b,c){this._vf[b]=a&&a.xmlNode&&a.xmlNode.hasAttribute(b)?x3dom.fields.MFRotation.parse(a.xmlNode.getAttribute(b)):new x3dom.fields.MFRotation(c),a&&a.xmlNode&&this.initSetter(a.xmlNode,b),this._vfFieldTypes[b]="MFRotation"},addField_SFNode:function(a,b){this._cf[a]=new x3dom.fields.SFNode(b),this._cfFieldTypes[a]="SFNode"},addField_MFNode:function(a,b){this._cf[a]=new x3dom.fields.MFNode(b),this._cfFieldTypes[a]="MFNode"}})),x3dom.registerNodeType("X3DMetadataObject","Core",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DMetadataObject.superClass.call(this,a),this.addField_SFString(a,"name",""),this.addField_SFString(a,"reference","")})),x3dom.registerNodeType("MetadataBoolean","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(a){x3dom.nodeTypes.MetadataBoolean.superClass.call(this,a),this.addField_MFBoolean(a,"value",[])})),x3dom.registerNodeType("MetadataDouble","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(a){x3dom.nodeTypes.MetadataDouble.superClass.call(this,a),this.addField_MFDouble(a,"value",[])})),x3dom.registerNodeType("MetadataFloat","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(a){x3dom.nodeTypes.MetadataFloat.superClass.call(this,a),this.addField_MFFloat(a,"value",[])})),x3dom.registerNodeType("MetadataInteger","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(a){x3dom.nodeTypes.MetadataInteger.superClass.call(this,a),this.addField_MFInt32(a,"value",[])})),x3dom.registerNodeType("MetadataSet","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(a){x3dom.nodeTypes.MetadataSet.superClass.call(this,a),this.addField_MFNode("value",x3dom.nodeTypes.X3DMetadataObject)})),x3dom.registerNodeType("MetadataString","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(a){x3dom.nodeTypes.MetadataString.superClass.call(this,a),this.addField_MFString(a,"value",[])})),x3dom.registerNodeType("Field","Core",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.Field.superClass.call(this,a),this.addField_SFString(a,"name",""),this.addField_SFString(a,"type",""),this.addField_SFString(a,"value","")},{fieldChanged:function(a){var b=this;"value"===a&&Array.forEach(this._parentNodes,function(a){a.fieldChanged(b._vf.name)})}})),x3dom.registerNodeType("X3DChildNode","Core",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DChildNode.superClass.call(this,a)})),x3dom.registerNodeType("X3DBindableNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DBindableNode.superClass.call(this,a),this.addField_SFBool(a,"bind",!1),this.addField_SFString(a,"description",""),this.addField_SFBool(a,"isActive",!1),this._autoGen=a&&a.autoGen?!0:!1,this._autoGen&&(this._vf.description="default"+this.constructor.superClass._typeName),this._stack=null},{bind:function(a){this._stack?a?this._stack.push(this):this._stack.pop(this):x3dom.debug.logError("No BindStack in "+this.typeName()+"Bindable")},activate:function(){this.postMessage("isActive",!0),x3dom.debug.logInfo("activate "+this.typeName()+"Bindable "+this._DEF+"/"+this._vf.description)},deactivate:function(){this.postMessage("isActive",!1),x3dom.debug.logInfo("deactivate "+this.typeName()+"Bindable "+this._DEF+"/"+this._vf.description)},fieldChanged:function(a){a.indexOf("bind")>=0&&this.bind(this._vf.bind)},nodeChanged:function(){this._stack=this._nameSpace.doc._bindableBag.addBindable(this)}})),x3dom.registerNodeType("X3DInfoNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DInfoNode.superClass.call(this,a)})),x3dom.registerNodeType("WorldInfo","Core",defineClass(x3dom.nodeTypes.X3DInfoNode,function(a){x3dom.nodeTypes.WorldInfo.superClass.call(this,a),this.addField_MFString(a,"info",[]),this.addField_SFString(a,"title",""),x3dom.debug.logInfo(this._vf.info),x3dom.debug.logInfo(this._vf.title)})),x3dom.registerNodeType("X3DBoundedNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DBoundedNode.superClass.call(this,a),this.addField_SFBool(a,"render",!0),this.addField_SFVec3f(a,"bboxCenter",0,0,0),this.addField_SFVec3f(a,"bboxSize",-1,-1,-1),this._graph={boundedNode:this,localMatrix:x3dom.fields.SFMatrix4f.identity(),globalMatrix:null,volume:new x3dom.fields.BoxVolume,worldVolume:new x3dom.fields.BoxVolume,center:new x3dom.fields.SFVec3f(0,0,0),coverage:-1}},{fieldChanged:function(a){this._vf.hasOwnProperty(a)&&this.invalidateVolume()},nodeChanged:function(){this.invalidateVolume()},parentAdded:function(){this.invalidateVolume()},getVolume:function(){var a=this._graph.volume;if(!this.volumeValid()&&this._vf.render)for(var b=0,c=this._childNodes.length;c>b;b++){var d=this._childNodes[b];if(d&&d._vf.render===!0){var e=d.getVolume();e&&e.isValid()&&a.extendBounds(e.min,e.max)}}return a},invalidateVolume:function(){var a=this._graph;a.volume.invalidate(),a.worldVolume.invalidate(),a.globalMatrix=null;for(var b=0,c=this._parentNodes.length;c>b;b++){var d=this._parentNodes[b];d&&d.volumeValid()&&d.invalidateVolume()}},invalidateCache:function(){var a=this._graph;a.worldVolume.invalidate(),a.globalMatrix=null},cacheInvalid:function(){return null==this._graph.globalMatrix||!this._graph.worldVolume.isValid()},volumeValid:function(){return this._graph.volume.isValid()},graphState:function(){return this._graph},forceUpdateCoverage:function(){return!1}})),x3dom.registerNodeType("X3DSensorNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DSensorNode.superClass.call(this,a)})),x3dom.registerNodeType("Param","Core",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.Param.superClass.call(this,a),x3dom.debug.logWarning('DEPRECATED: Param element needs to be child of X3D element [<a href="http://x3dom.org/docs/latest/configuration.html">DOCS</a>]')})),x3dom.registerNodeType("X3DGroupingNode","Grouping",defineClass(x3dom.nodeTypes.X3DBoundedNode,function(a){x3dom.nodeTypes.X3DGroupingNode.superClass.call(this,a),this.addField_MFNode("children",x3dom.nodeTypes.X3DChildNode)},{collectDrawableObjects:function(a,b,c,d,e){if(c&&this._parentNodes.length>1&&(c=!1),c&&(d=d||this.cacheInvalid())&&this.invalidateCache(),e=b.cull(a,this.graphState(),c,e),!(0>=e)){var f,g;c?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(a)),g=this._graph.globalMatrix):g=this.transformMatrix(a);for(var h=0,i=this._childNodes.length;i>h;h++)(f=this._childNodes[h])&&f.collectDrawableObjects(g,b,c,d,e)}}})),x3dom.registerNodeType("Switch","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Switch.superClass.call(this,a),this.addField_SFInt32(a,"whichChoice",-1)},{fieldChanged:function(a){"whichChoice"==a&&this.invalidateVolume()},getVolume:function(){var a=this._graph.volume;if(!this.volumeValid()&&this._vf.render&&this._vf.whichChoice>=0&&this._vf.whichChoice<this._childNodes.length){var b=this._childNodes[this._vf.whichChoice],c=b&&b._vf.render===!0?b.getVolume():null;c&&c.isValid()&&a.extendBounds(c.min,c.max)}return a},collectDrawableObjects:function(a,b,c,d,e){if(c&&this._parentNodes.length>1&&(c=!1),c&&(d=d||this.cacheInvalid())&&this.invalidateCache(),!(this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length||(e=b.cull(a,this.graphState(),c,e))<=0)){var f,g;c?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(a)),g=this._graph.globalMatrix):g=this.transformMatrix(a),(f=this._childNodes[this._vf.whichChoice])&&f.collectDrawableObjects(g,b,c,d,e)}},doIntersect:function(a){if(this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length)return!1;var b=this._childNodes[this._vf.whichChoice];return b?b.doIntersect(a):!1}})),x3dom.registerNodeType("X3DTransformNode","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.X3DTransformNode.superClass.call(this,a),a?a.doc._nodeBag.trans.push(this):x3dom.debug.logWarning("X3DTransformNode: No runtime context found!"),this._trafo=null,this._needCssStyleUpdates=!0},{tick:function(){if(this._xmlNode&&(this._xmlNode.ontransform||this._xmlNode.hasAttribute("ontransform")||this._listeners.transform)){var a=this.getCurrentTransform(),b={target:this._xmlNode,type:"transform",worldX:a._03,worldY:a._13,worldZ:a._23,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};this.callEvtHandler("ontransform",b)}if(this._needCssStyleUpdates){var c=x3dom.getStyle(this._xmlNode,"-webkit-transform")||x3dom.getStyle(this._xmlNode,"-moz-transform");if(c&&"none"!=c)return this._trafo.setValueByStr(c),this.invalidateVolume(),!0;this._needCssStyleUpdates=!1}return!1},transformMatrix:function(a){return a.mult(this._trafo)},getVolume:function(){var a=this._graph.volume;if(!this.volumeValid()&&this._vf.render){this._graph.localMatrix=this._trafo;for(var b=0,c=this._childNodes.length;c>b;b++){var d=this._childNodes[b];if(d&&d._vf.render===!0){var e=d.getVolume();e&&e.isValid()&&a.extendBounds(e.min,e.max)}}a.isValid()&&a.transform(this._trafo)}return a},doIntersect:function(a){var b=!1,c=this._trafo.inverse(),d=new x3dom.fields.SFVec3f(a.pos.x,a.pos.y,a.pos.z),e=new x3dom.fields.SFVec3f(a.dir.x,a.dir.y,a.dir.z);a.pos=c.multMatrixPnt(a.pos),a.dir=c.multMatrixVec(a.dir),a.hitObject&&(a.dist*=a.dir.length());for(var f=0;f<this._childNodes.length;f++)this._childNodes[f]&&(b=this._childNodes[f].doIntersect(a)||b);return a.pos.setValues(d),a.dir.setValues(e),b&&(a.hitPoint=this._trafo.multMatrixPnt(a.hitPoint),a.dist*=a.dir.length()),b},parentRemoved:function(){var a,b;if(0==this._parentNodes.length){var c=this.findX3DDoc();for(a=0,b=c._nodeBag.trans.length;b>a;a++)c._nodeBag.trans[a]===this&&c._nodeBag.trans.splice(a,1)}for(a=0,b=this._childNodes.length;b>a;a++)this._childNodes[a]&&this._childNodes[a].parentRemoved(this)}})),x3dom.registerNodeType("Transform","Grouping",defineClass(x3dom.nodeTypes.X3DTransformNode,function(a){x3dom.nodeTypes.Transform.superClass.call(this,a),this.addField_SFVec3f(a,"center",0,0,0),this.addField_SFVec3f(a,"translation",0,0,0),this.addField_SFRotation(a,"rotation",0,0,1,0),this.addField_SFVec3f(a,"scale",1,1,1),this.addField_SFRotation(a,"scaleOrientation",0,0,1,0),this._trafo=x3dom.fields.SFMatrix4f.translation(this._vf.translation.add(this._vf.center)).mult(this._vf.rotation.toMatrix()).mult(this._vf.scaleOrientation.toMatrix()).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(this._vf.scaleOrientation.toMatrix().inverse()).mult(x3dom.fields.SFMatrix4f.translation(this._vf.center.negate()))
},{fieldChanged:function(a){"center"==a||"translation"==a||"rotation"==a||"scale"==a||"scaleOrientation"==a?(this._trafo=x3dom.fields.SFMatrix4f.translation(this._vf.translation.add(this._vf.center)).mult(this._vf.rotation.toMatrix()).mult(this._vf.scaleOrientation.toMatrix()).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(this._vf.scaleOrientation.toMatrix().inverse()).mult(x3dom.fields.SFMatrix4f.translation(this._vf.center.negate())),this.invalidateVolume()):"render"==a&&this.invalidateVolume()}})),x3dom.registerNodeType("MatrixTransform","Grouping",defineClass(x3dom.nodeTypes.X3DTransformNode,function(a){x3dom.nodeTypes.MatrixTransform.superClass.call(this,a),this.addField_SFMatrix4f(a,"matrix",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._trafo=this._vf.matrix.transpose()},{fieldChanged:function(a){"matrix"==a?(this._trafo=this._vf.matrix.transpose(),this.invalidateVolume()):"render"==a&&this.invalidateVolume()}})),x3dom.registerNodeType("Group","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Group.superClass.call(this,a)})),x3dom.registerNodeType("Block","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Block.superClass.call(this,a),this.addField_MFString(a,"nameSpaceName",[])})),x3dom.registerNodeType("StaticGroup","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.StaticGroup.superClass.call(this,a),this.addField_SFBool(a,"debug",!1),this.addField_SFBool(a,"showDebugBoxVolumes",!1),this.addField_SFString(a,"bvhType","jsBIH"),this.addField_SFInt32(a,"maxObjectsPerNode",1),this.addField_SFInt32(a,"maxDepth",-1),this.addField_SFFloat(a,"minRelativeBBoxSize",.01),this.needBvhRebuild=!0,this.drawableCollection=null,this.bvh=null},{getMaxDepth:function(){return-1==this._vf.maxDepth?"jsBIH"==this._vf.bvhType?50:4:this._vf.maxDepth},collectDrawableObjects:function(a,b,c,d,e){if(c&&this._parentNodes.length>1&&(c=!1),c&&(d=d||this.cacheInvalid())&&this.invalidateCache(),e=b.cull(a,this.graphState(),c,e),!(0>=e)){var f,g;if(c?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(a)),g=this._graph.globalMatrix):g=this.transformMatrix(a),this.needBvhRebuild){var h={viewArea:b.viewarea,sortTrans:b.sortTrans,viewMatrix:b.viewMatrix,projMatrix:b.projMatrix,sceneMatrix:b.sceneMatrix,frustumCulling:!1,smallFeatureThreshold:0,context:b.context};this.drawableCollection=new x3dom.DrawableCollection(h);var i,j=this._childNodes.length;for(i=0;j>i;i++)(f=this._childNodes[i])&&f.collectDrawableObjects(g,this.drawableCollection,c,d,e);this.drawableCollection.concat();var k=this._nameSpace.doc._scene,l=new x3dom.bvh.Settings(this._vf.debug,this._vf.showDebugBoxVolumes,this._vf.bvhType,this._vf.maxObjectsPerNode,this.getMaxDepth(),this._vf.minRelativeBBoxSize);for(this.bvh="jsBIH"==this._vf.bvhType?new x3dom.bvh.BIH(k,l):new x3dom.bvh.Culler(this.drawableCollection,k,l),(this._vf.debug||this._vf.showDebugBoxVolumes)&&(this.bvh=new x3dom.bvh.DebugDecorator(this.bvh,k,l)),j=this.drawableCollection.length,i=0;j>i;i++)this.bvh.addDrawable(this.drawableCollection.get(i));this.bvh.compile(),this._vf.debug&&this.bvh.showCompileStats(),this.needBvhRebuild=!1}x3dom.Utils.startMeasure("bvhTraverse"),this.bvh.collectDrawables(b);var m=x3dom.Utils.stopMeasure("bvhTraverse");this._nameSpace.doc.ctx.x3dElem.runtime.addMeasurement("BVH",m),this.bvh.showTraverseStats(this._nameSpace.doc.ctx.x3dElem.runtime)}}})),x3dom.registerNodeType("RemoteSelectionGroup","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.RemoteSelectionGroup.superClass.call(this,a),this.addField_MFString(a,"url",["ws://localhost:35668/cstreams/0"]),this.addField_MFString(a,"label",[]),this.addField_SFInt32(a,"maxRenderedIds",-1),this.addField_SFBool(a,"reconnect",!0),this.addField_SFFloat(a,"scaleRenderedIdsOnMove",1),this.addField_SFBool(a,"enableCulling",!0),this.addField_MFString(a,"invisibleNodes",[]),this._idList=[],this._websocket=null,this._nameObjMap={},this._createTime=[],this._visibleList=[],a?this.initializeSocket():x3dom.debug.logWarning("RemoteSelectionGroup: No runtime context found!")},{initializeSocket:function(){var a=this;if("WebSocket"in window){var b="ws://localhost:35668/cstreams/0";this._vf.url.length&&this._vf.url[0].length&&(b=this._vf.url[0]),this._websocket=new WebSocket(b),this._websocket._lastMsg=null,this._websocket._lastData="",this._websocket.onopen=function(){x3dom.debug.logInfo("WS Connected");var b=a._nameSpace.doc._viewarea.getViewMatrix();this._lastMsg=b.toGL().toString(),b=a._nameSpace.doc._viewarea.getProjectionMatrix(),this._lastMsg+=","+b.toGL().toString(),this.send(this._lastMsg),x3dom.debug.logInfo("WS Sent: "+this._lastMsg),this._lastMsg="",this._lastData=""},this._websocket.onclose=function(){x3dom.debug.logInfo("WS Disconnected"),a._vf.reconnect&&window.setTimeout(function(){a.initializeSocket()},2e3)},this._websocket.onmessage=function(b){if(a._vf.maxRenderedIds<0)a._idList=x3dom.fields.MFString.parse(b.data);else if(a._vf.maxRenderedIds>0){a._idList=[];for(var c=x3dom.fields.MFString.parse(b.data),d=Math.min(c.length,Math.abs(a._vf.maxRenderedIds)),e=0;d>e;++e)a._idList[e]=c[e]}0!=a._vf.maxRenderedIds&&this._lastData!=b.data&&(this._lastData=b.data,a._nameSpace.doc.needRender=!0,a.invalidateVolume())},this._websocket.onerror=function(a){x3dom.debug.logError(a.data)},this._websocket.updateCamera=function(){var b=a._nameSpace.doc._viewarea.getViewMatrix(),c=b.toGL().toString();b=a._nameSpace.doc._viewarea.getProjectionMatrix(),c+=","+b.toGL().toString(),null!=this._lastMsg&&this._lastMsg!=c&&(this._lastMsg=c,this.send(c))}}else x3dom.debug.logError("Browser has no WebSocket support!")},nodeChanged:function(){var a=this._vf.label.length;this._nameObjMap={},this._createTime=new Array(a),this._visibleList=new Array(a);for(var b=0;a>b;++b){var c=this._childNodes[b];c&&x3dom.isa(c,x3dom.nodeTypes.X3DShapeNode)?(this._nameObjMap[this._vf.label[b]]={shape:c,pos:b},this._visibleList[b]=!0):(this._visibleList[b]=!1,x3dom.debug.logError("Invalid children: "+this._vf.label[b])),this._createTime[b]=0}this.invalidateVolume(),x3dom.debug.logInfo("RemoteSelectionGroup has "+a+" entries.")},fieldChanged:function(a){if("url"==a)this._websocket&&(this._websocket.close(),this._websocket=null),this.initializeSocket();else if("invisibleNodes"==a){for(var b=0,c=this._vf.label.length;c>b;++b){var d=this._childNodes[b];if(d&&x3dom.isa(d,x3dom.nodeTypes.X3DShapeNode)){this._visibleList[b]=!0;for(var e=0,f=this._vf.invisibleNodes.length;f>e;++e){var g=this._vf.invisibleNodes[e],h=g.lastIndexOf("*"),i=!1;if(h>0&&(g=g.substring(0,h),i=!0),!(g.length<=1)&&(i&&0==this._vf.label[b].indexOf(g)||this._vf.label[b]==g)){this._visibleList[b]=!1;break}}}else this._visibleList[b]=!1}this.invalidateVolume()}else"render"==a&&this.invalidateVolume()},getNumRenderedObjects:function(a,b){var c=a;if(this._vf.maxRenderedIds>0){var d=Math.max(this._vf.maxRenderedIds,16),e=1;b&&(e=Math.min(this._vf.scaleRenderedIdsOnMove,1)),d=Math.max(Math.round(e*d),0),c=Math.min(c,d)}return c},collectDrawableObjects:function(a,b,c,d,e){if(c&&this._parentNodes.length>1&&(c=!1),c&&(d=d||this.cacheInvalid())&&this.invalidateCache(),e=b.cull(a,this.graphState(),c,e),!(0>=e)){var f,g,h=this._nameSpace.doc._viewarea,i=h.isMovingOrAnimating(),j=(new Date).getTime(),k=1e4,l=this._childNodes.length;if(this._vf.enableCulling){if(this._websocket&&this._websocket.updateCamera(),this._vf.label.length){for(g=this.getNumRenderedObjects(this._idList.length,i),f=0;g>f;f++){var m=this._nameObjMap[this._idList[f]];m&&m.shape?(m.shape.collectDrawableObjects(a,b,c,d,e),this._createTime[m.pos]=j):x3dom.debug.logError("Invalid label: "+this._idList[f])}for(f=0;f<this._childNodes.length;f++)this._childNodes[f]&&!i&&this._createTime[f]>0&&j-this._createTime[f]>k&&this._childNodes[f]._cleanupGLObjects&&(this._childNodes[f]._cleanupGLObjects(!0),this._createTime[f]=0)}}else{g=this.getNumRenderedObjects(l,i);var n=0;for(f=0;l>f;f++){var o=this._childNodes[f];if(o){var p=!0;this._visibleList[f]&&g>n&&o.collectDrawableObjects(a,b,c,d,e)&&(this._createTime[f]=j,n++,p=!1),p&&!i&&this._createTime[f]>0&&j-this._createTime[f]>k&&o._cleanupGLObjects&&(o._cleanupGLObjects(!0),this._createTime[f]=0)}}}}}})),x3dom.registerNodeType("Scene","Core",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Scene.superClass.call(this,a),this.addField_SFString(a,"pickMode","idBuf"),this.addField_SFBool(a,"doPickPass",!0),this.addField_SFString(a,"shadowObjectIdMapping",""),this._lastMin=new x3dom.fields.SFVec3f(0,0,0),this._lastMax=new x3dom.fields.SFVec3f(1,1,1),this._shadowIdMap=null,this.loadMapping()},{fieldChanged:function(a){"shadowObjectIdMapping"==a&&this.loadMapping()},updateVolume:function(){var a=this.getVolume();a.isValid()&&(this._lastMin=x3dom.fields.SFVec3f.copy(a.min),this._lastMax=x3dom.fields.SFVec3f.copy(a.max))},loadMapping:function(){if(this._shadowIdMap=null,0!=this._vf.shadowObjectIdMapping.length){var that=this,xhr=new XMLHttpRequest;xhr.open("GET",encodeURI(this._nameSpace.getURL(this._vf.shadowObjectIdMapping)),!0),xhr.send(),xhr.onload=function(){that._shadowIdMap=eval("("+xhr.response+")")}}}})),x3dom.BindableStack=function(a,b,c,d){this._doc=a,this._type=b,this._defaultType=c,this._defaultRoot=null,this._getter=d,this._bindBag=[],this._bindStack=[]},x3dom.BindableStack.prototype.top=function(){return this._bindStack.length>0?this._bindStack[this._bindStack.length-1]:null},x3dom.BindableStack.prototype.push=function(a){var b=this.top();b!==a&&(b&&b.deactivate(),this._bindStack.push(a),a.activate(b))},x3dom.BindableStack.prototype.replaceTop=function(a){var b=this.top();b!==a&&b&&(b.deactivate(),this._bindStack[this._bindStack.length-1]=a,a.activate(b))},x3dom.BindableStack.prototype.pop=function(a){var b;return a&&(b=this.top(),a!==b)?null:(b=this._bindStack.pop(),b&&b.deactivate(),b)},x3dom.BindableStack.prototype.switchTo=function(a){var b=this.getActive(),c=this._bindBag.length,d=0,e=0,f=-1;if(!(1>=c)){switch(a){case"first":d=this._bindBag[0];break;case"last":d=this._bindBag[c-1];break;default:for(e=0;c>e;e++)if(this._bindBag[e]==b){f=e;break}if(f>=0)for(e=f;!d&&(e="next"==a?c-1>e?e+1:0:e>0?e-1:c-1,e!=f);)this._bindBag[e]._vf.description.length>=0&&(d=this._bindBag[e])}d?this.replaceTop(d):x3dom.debug.logWarning("Cannot switch bindable; no other bindable with description found.")}},x3dom.BindableStack.prototype.getActive=function(){if(0===this._bindStack.length){if(0===this._bindBag.length)if(this._defaultRoot){x3dom.debug.logInfo("create new "+this._defaultType._typeName+" for "+this._type._typeName+"-stack");var a=new this._defaultType({doc:this._doc,nameSpace:this._defaultRoot._nameSpace,autoGen:!0});this._defaultRoot.addChild(a),a.nodeChanged()}else x3dom.debug.logError("stack without defaultRoot");else x3dom.debug.logInfo("activate first "+this._type._typeName+" for "+this._type._typeName+"-stack");this._bindStack.push(this._bindBag[0]),this._bindBag[0].activate()}return this._bindStack[this._bindStack.length-1]},x3dom.BindableBag=function(a){this._stacks=[],this.addType("X3DViewpointNode","Viewpoint","getViewpoint",a),this.addType("X3DNavigationInfoNode","NavigationInfo","getNavigationInfo",a),this.addType("X3DBackgroundNode","Background","getBackground",a),this.addType("X3DFogNode","Fog","getFog",a),this.addType("X3DEnvironmentNode","Environment","getEnvironment",a)},x3dom.BindableBag.prototype.addType=function(a,b,c,d){var e=x3dom.nodeTypes[a],f=x3dom.nodeTypes[b];if(e&&f){var g=new x3dom.BindableStack(d,e,f,c);this._stacks.push(g)}else x3dom.debug.logWarning("Invalid Bindable type/defaultType: "+a+"/"+f)},x3dom.BindableBag.prototype.setRefNode=function(a){Array.forEach(this._stacks,function(b){b._defaultRoot=a,a[b._getter]=function(){return b.getActive()}})},x3dom.BindableBag.prototype.addBindable=function(a){for(var b=0,c=this._stacks.length;c>b;b++){var d=this._stacks[b];if(x3dom.isa(a,d._type)){x3dom.debug.logInfo("register "+a.typeName()+"Bindable "+a._DEF+"/"+a._vf.description),d._bindBag.push(a);var e=d.top();if(e&&e._autoGen){d.replaceTop(a);for(var f=0,g=d._bindBag.length;g>f;f++)if(d._bindBag[f]===e){d._bindBag.splice(f,1);break}d._defaultRoot.removeChild(e)}return d}}return x3dom.debug.logError(a.typeName()+" is not a valid bindable"),null},x3dom.registerNodeType("X3DGeometryNode","Rendering",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DGeometryNode.superClass.call(this,a),this.addField_SFBool(a,"solid",!0),this.addField_SFBool(a,"ccw",!0),this.addField_SFBool(a,"useGeoCache",!0),this._mesh=new x3dom.Mesh(this)},{getVolume:function(){return this._mesh.getVolume()},invalidateVolume:function(){this._mesh.invalidate()},getCenter:function(){return this._mesh.getCenter()},getDiameter:function(){return this._mesh.getDiameter()},doIntersect:function(a){return this._mesh.doIntersect(a)},forceUpdateCoverage:function(){return!1},hasIndexOffset:function(){return!1},getColorTexture:function(){return null},getColorTextureURL:function(){return null},parentAdded:function(a){x3dom.isa(a,x3dom.nodeTypes.X3DShapeNode)&&(a._cleanupGLObjects&&a._cleanupGLObjects(!0),a.setAllDirty(),a.invalidateVolume())}})),x3dom.registerNodeType("Mesh","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.Mesh.superClass.call(this,a),this.addField_SFString(a,"primType","triangle"),this.addField_MFInt32(a,"index",[]),this.addField_MFNode("vertexAttributes",x3dom.nodeTypes.X3DVertexAttributeNode)},{nodeChanged:function(){var a,b=(new Date).getTime(),c=this._cf.vertexAttributes.nodes.length;for(a=0;c>a;a++){var d=this._cf.vertexAttributes.nodes[a]._vf.name;switch(d.toLowerCase()){case"position":this._mesh._positions[0]=this._cf.vertexAttributes.nodes[a]._vf.value.toGL();break;case"normal":this._mesh._normals[0]=this._cf.vertexAttributes.nodes[a]._vf.value.toGL();break;case"texcoord":this._mesh._texCoords[0]=this._cf.vertexAttributes.nodes[a]._vf.value.toGL();break;case"color":this._mesh._colors[0]=this._cf.vertexAttributes.nodes[a]._vf.value.toGL();break;default:this._mesh._dynamicFields[d]={},this._mesh._dynamicFields[d].numComponents=this._cf.vertexAttributes.nodes[a]._vf.numComponents,this._mesh._dynamicFields[d].value=this._cf.vertexAttributes.nodes[a]._vf.value.toGL()}}this._mesh._indices[0]=this._vf.index.toGL(),this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3;var e=(new Date).getTime()-b;x3dom.debug.logWarning("Mesh load time: "+e+" ms")}})),x3dom.registerNodeType("PointSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.PointSet.superClass.call(this,a),this.addField_SFNode("coord",x3dom.nodeTypes.Coordinate),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this._mesh._primType="POINTS"},{nodeChanged:function(){var a=(new Date).getTime(),b=this._cf.coord.node;x3dom.debug.assert(b);var c=b._vf.point,d=3,e=this._cf.color.node,f=new x3dom.fields.MFColor;e&&(f=e._vf.color,x3dom.debug.assert(c.length==f.length),x3dom.isa(e,x3dom.nodeTypes.ColorRGBA)&&(d=4)),this._mesh._numColComponents=d,this._mesh._lit=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=c.toGL(),this._mesh._colors[0]=f.toGL(),this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,(new Date).getTime()-a},fieldChanged:function(a){var b=null;"coord"==a?(b=this._cf.coord.node._vf.point,this._mesh._positions[0]=b.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()})):"color"==a&&(b=this._cf.color.node._vf.color,this._mesh._colors[0]=b.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0}))}})),x3dom.registerNodeType("X3DComposedGeometryNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.X3DComposedGeometryNode.superClass.call(this,a),this.addField_SFBool(a,"colorPerVertex",!0),this.addField_SFBool(a,"normalPerVertex",!0),this.addField_SFString(a,"normalUpdateMode","fast"),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("normal",x3dom.nodeTypes.Normal),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode)},{handleAttribs:function(){var a,b=this._cf.attrib.nodes.length;for(a=0;b>a;a++){var c=this._cf.attrib.nodes[a]._vf.name;switch(c.toLowerCase()){case"position":this._mesh._positions[0]=this._cf.attrib.nodes[a]._vf.value.toGL();break;case"normal":this._mesh._normals[0]=this._cf.attrib.nodes[a]._vf.value.toGL();break;case"texcoord":this._mesh._texCoords[0]=this._cf.attrib.nodes[a]._vf.value.toGL();break;case"color":this._mesh._colors[0]=this._cf.attrib.nodes[a]._vf.value.toGL();break;default:this._mesh._dynamicFields[c]={},this._mesh._dynamicFields[c].numComponents=this._cf.attrib.nodes[a]._vf.numComponents,this._mesh._dynamicFields[c].value=this._cf.attrib.nodes[a]._vf.value.toGL()}}}})),x3dom.registerNodeType("LineSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.LineSet.superClass.call(this,a),this.addField_MFInt32(a,"vertexCount",[]),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this._mesh._primType="LINES"},{nodeChanged:function(){var a=this._cf.coord.node;x3dom.debug.assert(a);var b=a.getPoints();this._mesh._positions[0]=b.toGL();var c=this._cf.color.node;if(c){var d=c._vf.color;this._mesh._colors[0]=d.toGL();var e=3;x3dom.isa(c,x3dom.nodeTypes.ColorRGBA)&&(e=4)}var f=0;this._mesh._indices[0]=[];for(var g=0,h=this._vf.vertexCount.length;h>g;g++){var i=this._vf.vertexCount[g];if(2>i){x3dom.debug.logError("LineSet.vertexCount must not be smaller than 2!");break}for(var j=i-2;j>=0;j--)this._mesh._indices[0].push(f++,f),0==j&&f++}},fieldChanged:function(a){if("coord"==a){var b=this._cf.coord.node.getPoints();this._mesh._positions[0]=b.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()})}else if("color"==a){var c=this._cf.color.node._vf.color;this._mesh._colors[0]=c.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0})}}})),x3dom.registerNodeType("IndexedLineSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.IndexedLineSet.superClass.call(this,a),this.addField_SFBool(a,"colorPerVertex",!0),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_MFInt32(a,"coordIndex",[]),this.addField_MFInt32(a,"colorIndex",[]),this._mesh._primType="LINES"},{nodeChanged:function(){var a=(new Date).getTime(),b=this._vf.coordIndex,c=this._vf.colorIndex,d=!1,e=!1,f=this._vf.colorPerVertex;c.length>0&&(e=!0);var g,h,i=this._cf.coord.node;x3dom.debug.assert(i),g=i.getPoints();var j=3,k=this._cf.color.node;k?(d=!0,h=k._vf.color,x3dom.isa(k,x3dom.nodeTypes.ColorRGBA)&&(j=4)):d=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._colors[0]=[];var l,m,n,o,p,q,r,s;if(d&&e||g.length>x3dom.Utils.maxIndexableCoords){for(m=0,n=0,o=0,l=0;l<b.length;++l)if(-1!==b[l])switch(e&&x3dom.debug.assert(-1!=c[l]),m){case 0:p=+b[l],r=e&&f?+c[l]:p,m=1;break;case 1:q=+b[l],s=e&&f?+c[l]:e&&!f?+c[o]:q,this._mesh._indices[0].push(n++,n++),this._mesh._positions[0].push(g[p].x),this._mesh._positions[0].push(g[p].y),this._mesh._positions[0].push(g[p].z),this._mesh._positions[0].push(g[q].x),this._mesh._positions[0].push(g[q].y),this._mesh._positions[0].push(g[q].z),d&&(f||(r=s),this._mesh._colors[0].push(h[r].r),this._mesh._colors[0].push(h[r].g),this._mesh._colors[0].push(h[r].b),this._mesh._colors[0].push(h[s].r),this._mesh._colors[0].push(h[s].g),this._mesh._colors[0].push(h[s].b)),m=2,o++;break;case 2:p=q,r=s,q=+b[l],s=e&&f?+c[l]:e&&!f?+c[o]:q,this._mesh._indices[0].push(n++,n++),this._mesh._positions[0].push(g[p].x),this._mesh._positions[0].push(g[p].y),this._mesh._positions[0].push(g[p].z),this._mesh._positions[0].push(g[q].x),this._mesh._positions[0].push(g[q].y),this._mesh._positions[0].push(g[q].z),d&&(f||(r=s),this._mesh._colors[0].push(h[r].r),this._mesh._colors[0].push(h[r].g),this._mesh._colors[0].push(h[r].b),this._mesh._colors[0].push(h[s].r),this._mesh._colors[0].push(h[s].g),this._mesh._colors[0].push(h[s].b)),o++}else m=0;g.length>x3dom.Utils.maxIndexableCoords&&this._mesh.splitMesh(2)}else{var t=b.length;for(m=0,l=0;t>l;++l)if(-1!=b[l])switch(m){case 0:p=+b[l],m=1;break;case 1:q=+b[l],m=2,this._mesh._indices[0].push(p,q);break;case 2:p=q,q=+b[l],this._mesh._indices[0].push(p,q)}else m=0;this._mesh._positions[0]=g.toGL(),d&&(this._mesh._colors[0]=h.toGL(),this._mesh._numColComponents=j)}for(this.invalidateVolume(),this._mesh._numCoords=0,l=0;l<this._mesh._indices.length;l++)this._mesh._numCoords+=this._mesh._positions[l].length/3;(new Date).getTime()-a},fieldChanged:function(a){var b=null;if("coord"==a)b=this._cf.coord.node._vf.point,this._mesh._positions[0]=b.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()});else if("color"==a)b=this._cf.color.node._vf.color,this._mesh._colors[0]=b.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0});else if("coordIndex"==a){this._mesh._indices[0]=[];for(var c,d,e=this._vf.coordIndex,f=0,g=0,h=e.length;h>g;++g)if(-1==e[g])f=0;else switch(f){case 0:c=+e[g],f=1;break;case 1:d=+e[g],f=2,this._mesh._indices[0].push(c,d);break;case 2:c=d,d=+e[g],this._mesh._indices[0].push(c,d)}this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.indexes=!0,a.invalidateVolume()})}}})),x3dom.registerNodeType("IndexedTriangleSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(a){x3dom.nodeTypes.IndexedTriangleSet.superClass.call(this,a),this.addField_MFInt32(a,"index",[])},{nodeChanged:function(){var a=(new Date).getTime();this.handleAttribs();var b,c,d,e,f=this._vf.colorPerVertex,g=this._vf.normalPerVertex,h=this._vf.index,i=!1,j=!1,k=!1,l=this._cf.coord.node;x3dom.debug.assert(l),b=l._vf.point;var m=this._cf.normal.node;m?(i=!0,c=m._vf.vector):i=!1;var n="",o=2,p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]),p?p._vf.point?(j=!0,d=p._vf.point,x3dom.isa(p,x3dom.nodeTypes.TextureCoordinate3D)&&(o=3)):p._vf.mode&&(n=p._vf.mode):j=!1;var q=3,r=this._cf.color.node;r?(k=!0,e=r._vf.color,x3dom.isa(r,x3dom.nodeTypes.ColorRGBA)&&(q=4)):k=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];for(var s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I;b.length%3>0;)b.push(b.length-1);if(w=b.length,!g||w>x3dom.Utils.maxIndexableCoords){for(t=0,u=0,v=0,this._mesh._multiIndIndices=[],this._mesh._posSize=b.length,s=0;s<h.length;++s)switch(s>0&&0===s%3&&(t=0,v++),t){case 0:x=+h[s],g?A=x:g||(A=v),D=x,f?G=x:f||(G=v),t=1;break;case 1:y=+h[s],g?B=y:g||(B=v),E=y,f?H=y:f||(H=v),t=2;break;case 2:z=+h[s],g?C=z:g||(C=v),F=z,f?I=z:f||(I=v),t=3,this._mesh._indices[0].push(u++,u++,u++),this._mesh._positions[0].push(b[x].x),this._mesh._positions[0].push(b[x].y),this._mesh._positions[0].push(b[x].z),this._mesh._positions[0].push(b[y].x),this._mesh._positions[0].push(b[y].y),this._mesh._positions[0].push(b[y].z),this._mesh._positions[0].push(b[z].x),this._mesh._positions[0].push(b[z].y),this._mesh._positions[0].push(b[z].z),i?(this._mesh._normals[0].push(c[A].x),this._mesh._normals[0].push(c[A].y),this._mesh._normals[0].push(c[A].z),this._mesh._normals[0].push(c[B].x),this._mesh._normals[0].push(c[B].y),this._mesh._normals[0].push(c[B].z),this._mesh._normals[0].push(c[C].x),this._mesh._normals[0].push(c[C].y),this._mesh._normals[0].push(c[C].z)):this._mesh._multiIndIndices.push(x,y,z),k&&(this._mesh._colors[0].push(e[G].r),this._mesh._colors[0].push(e[G].g),this._mesh._colors[0].push(e[G].b),4===q&&this._mesh._colors[0].push(e[G].a),this._mesh._colors[0].push(e[H].r),this._mesh._colors[0].push(e[H].g),this._mesh._colors[0].push(e[H].b),4===q&&this._mesh._colors[0].push(e[H].a),this._mesh._colors[0].push(e[I].r),this._mesh._colors[0].push(e[I].g),this._mesh._colors[0].push(e[I].b),4===q&&this._mesh._colors[0].push(e[I].a)),j&&(this._mesh._texCoords[0].push(d[D].x),this._mesh._texCoords[0].push(d[D].y),3===o&&this._mesh._texCoords[0].push(d[D].z),this._mesh._texCoords[0].push(d[E].x),this._mesh._texCoords[0].push(d[E].y),3===o&&this._mesh._texCoords[0].push(d[E].z),this._mesh._texCoords[0].push(d[F].x),this._mesh._texCoords[0].push(d[F].y),3===o&&this._mesh._texCoords[0].push(d[F].z))}i||this._mesh.calcNormals(g?Math.PI:0),j||this._mesh.calcTexCoords(n),this._mesh.splitMesh()}else{for(v=0,s=0;s<h.length;s++)s>0&&0===s%3&&v++,this._mesh._indices[0].push(h[s]),!g&&i&&(this._mesh._normals[0].push(c[v].x),this._mesh._normals[0].push(c[v].y),this._mesh._normals[0].push(c[v].z)),!f&&k&&(this._mesh._colors[0].push(e[v].r),this._mesh._colors[0].push(e[v].g),this._mesh._colors[0].push(e[v].b),4===q&&this._mesh._colors[0].push(e[v].a));this._mesh._positions[0]=b.toGL(),i?this._mesh._normals[0]=c.toGL():this._mesh.calcNormals(g?Math.PI:0),j?(this._mesh._texCoords[0]=d.toGL(),this._mesh._numTexComponents=o):this._mesh.calcTexCoords(n),k&&f&&(this._mesh._colors[0]=e.toGL(),this._mesh._numColComponents=q)}for(this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,s=0;s<this._mesh._indices.length;s++)this._mesh._numFaces+=this._mesh._indices[s].length/3,this._mesh._numCoords+=this._mesh._positions[s].length/3;(new Date).getTime()-a},fieldChanged:function(a){var b=this._cf.coord.node._vf.point;if(b.length>x3dom.Utils.maxIndexableCoords)return x3dom.debug.logWarning("IndexedTriangleSet: fieldChanged with too many coordinates not yet implemented!"),void 0;if("coord"==a)this._mesh._positions[0]=b.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()});else if("color"==a){if(b=this._cf.color.node._vf.color,this._vf.colorPerVertex)this._mesh._colors[0]=b.toGL();else if(!this._vf.colorPerVertex){var c=0,d=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(d=4),this._mesh._colors[0]=[];for(var e=this._vf.index,f=0;f<e.length;++f)f>0&&0===f%3&&c++,this._mesh._colors[0].push(b[c].r),this._mesh._colors[0].push(b[c].g),this._mesh._colors[0].push(b[c].b),4===d&&this._mesh._colors[0].push(b[c].a)}Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0})}else if("normal"==a){if(b=this._cf.normal.node._vf.vector,this._vf.normalPerVertex)this._mesh._normals[0]=b.toGL();else if(!this._vf.normalPerVertex){var e=this._vf.index;this._mesh._normals[0]=[];for(var c=0,f=0;f<e.length;++f)f>0&&0===f%3&&c++,this._mesh._normals[0].push(b[c].x),this._mesh._normals[0].push(b[c].y),this._mesh._normals[0].push(b[c].z)}Array.forEach(this._parentNodes,function(a){a._dirty.normals=!0})}else if("texCoord"==a){var g=this._cf.texCoord.node;x3dom.isa(g,x3dom.nodeTypes.MultiTextureCoordinate)&&g._cf.texCoord.nodes.length&&(g=g._cf.texCoord.nodes[0]),b=g._vf.point,this._mesh._texCoords[0]=b.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.texcoords=!0})}}})),x3dom.registerNodeType("IndexedTriangleStripSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(a){x3dom.nodeTypes.IndexedTriangleStripSet.superClass.call(this,a),this.addField_MFInt32(a,"index",[]),this._hasIndexOffset=!1,this._indexOffset=null},{hasIndexOffset:function(){return this._hasIndexOffset},nodeChanged:function(){this.handleAttribs();var a,b,c,d,e=!1,f=!1,g=!1,h=this._vf.colorPerVertex,i=this._vf.normalPerVertex,j=this._vf.index,k=this._cf.coord.node;x3dom.debug.assert(k),a=k._vf.point;var l=this._cf.normal.node;l?(e=!0,b=l._vf.vector):e=!1;var m="",n=2,o=this._cf.texCoord.node;x3dom.isa(o,x3dom.nodeTypes.MultiTextureCoordinate)&&o._cf.texCoord.nodes.length&&(o=o._cf.texCoord.nodes[0]),o?o._vf.point?(f=!0,c=o._vf.point,x3dom.isa(o,x3dom.nodeTypes.TextureCoordinate3D)&&(n=3)):o._vf.mode&&(m=o._vf.mode):f=!1,this._mesh._numTexComponents=n;var p=3,q=this._cf.color.node;q?(g=!0,d=q._vf.color,x3dom.isa(q,x3dom.nodeTypes.ColorRGBA)&&(p=4)):g=!1,this._mesh._numColComponents=p,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[],this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0;var r=0,s=0;if(e&&a.length<=x3dom.Utils.maxIndexableCoords){this._hasIndexOffset=!0,this._indexOffset=[],this._mesh._primType="TRIANGLESTRIP";var t=[0];for(I=0;I<j.length;I++)-1==j[I]?(r++,t.push(this._mesh._indices[0].length)):(this._mesh._indices[0].push(+j[I]),i||(this._mesh._normals[0].push(b[r].x),this._mesh._normals[0].push(b[r].y),this._mesh._normals[0].push(b[r].z)),h||(this._mesh._colors[0].push(d[r].r),this._mesh._colors[0].push(d[r].g),this._mesh._colors[0].push(d[r].b),4===p&&this._mesh._colors[0].push(d[r].a)));for(this._mesh._positions[0]=a.toGL(),i&&(this._mesh._normals[0]=b.toGL()),f?(this._mesh._texCoords[0]=c.toGL(),this._mesh._numTexComponents=n):x3dom.debug.logWarning("IndexedTriangleStripSet: no texCoords given and won't calculate!"),g&&(h&&(this._mesh._colors[0]=d.toGL()),this._mesh._numColComponents=p),I=1;I<t.length;I++){var u=t[I]-t[I-1];this._indexOffset.push({count:u,offset:2*t[I-1]}),this._mesh._numFaces+=u-2}this._mesh._numCoords=this._mesh._positions[0].length/3}else{this._hasIndexOffset=!1;for(var v,w,x,y,z,A,B,C,D,E,F,G,H=!1,I=1;I<j.length-2;++I)-1!=j[I+1]?(H?(v=j[I],w=j[I-1],x=j[I+1]):(v=j[I-1],w=j[I],x=j[I+1]),H=!H,i?(y=v,z=w,A=x):i||(y=z=A=r),B=v,C=w,D=x,h?(E=v,F=w,G=x):h||(E=F=G=r),this._mesh._indices[0].push(s++,s++,s++),this._mesh._positions[0].push(a[v].x),this._mesh._positions[0].push(a[v].y),this._mesh._positions[0].push(a[v].z),this._mesh._positions[0].push(a[w].x),this._mesh._positions[0].push(a[w].y),this._mesh._positions[0].push(a[w].z),this._mesh._positions[0].push(a[x].x),this._mesh._positions[0].push(a[x].y),this._mesh._positions[0].push(a[x].z),e&&(this._mesh._normals[0].push(b[y].x),this._mesh._normals[0].push(b[y].y),this._mesh._normals[0].push(b[y].z),this._mesh._normals[0].push(b[z].x),this._mesh._normals[0].push(b[z].y),this._mesh._normals[0].push(b[z].z),this._mesh._normals[0].push(b[A].x),this._mesh._normals[0].push(b[A].y),this._mesh._normals[0].push(b[A].z)),g&&(this._mesh._colors[0].push(d[E].r),this._mesh._colors[0].push(d[E].g),this._mesh._colors[0].push(d[E].b),4===p&&this._mesh._colors[0].push(d[E].a),this._mesh._colors[0].push(d[F].r),this._mesh._colors[0].push(d[F].g),this._mesh._colors[0].push(d[F].b),4===p&&this._mesh._colors[0].push(d[F].a),this._mesh._colors[0].push(d[G].r),this._mesh._colors[0].push(d[G].g),this._mesh._colors[0].push(d[G].b),4===p&&this._mesh._colors[0].push(d[G].a)),f&&(this._mesh._texCoords[0].push(c[B].x),this._mesh._texCoords[0].push(c[B].y),3===n&&this._mesh._texCoords[0].push(c[B].z),this._mesh._texCoords[0].push(c[C].x),this._mesh._texCoords[0].push(c[C].y),3===n&&this._mesh._texCoords[0].push(c[C].z),this._mesh._texCoords[0].push(c[D].x),this._mesh._texCoords[0].push(c[D].y),3===n&&this._mesh._texCoords[0].push(c[D].z))):(I+=2,r++);for(e||this._mesh.calcNormals(Math.PI),f||this._mesh.calcTexCoords(m),this._mesh.splitMesh(),this.invalidateVolume(),I=0;I<this._mesh._indices.length;I++)this._mesh._numFaces+=this._mesh._indices[I].length/3,this._mesh._numCoords+=this._mesh._positions[I].length/3}},fieldChanged:function(a){if("coord"!=a&&"normal"!=a&&"texCoord"!=a&&"color"!=a)return x3dom.debug.logWarning("IndexedTriangleStripSet: fieldChanged for "+a+" not yet implemented!"),void 0;
var b=this._cf.coord.node._vf.point;if(null===this._cf.normal.node||b.length>x3dom.Utils.maxIndexableCoords){if("coord"==a){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var c,d,e,f,g=!1,h=!1,i=!1,j=this._vf.colorPerVertex,k=this._vf.normalPerVertex,l=this._vf.index,m=this._cf.coord.node;x3dom.debug.assert(m),c=m._vf.point;var n=this._cf.normal.node;n?(g=!0,d=n._vf.vector):g=!1;var o="",p=2,q=this._cf.texCoord.node;x3dom.isa(q,x3dom.nodeTypes.MultiTextureCoordinate)&&q._cf.texCoord.nodes.length&&(q=q._cf.texCoord.nodes[0]),q?q._vf.point?(h=!0,e=q._vf.point,x3dom.isa(q,x3dom.nodeTypes.TextureCoordinate3D)&&(p=3)):q._vf.mode&&(o=q._vf.mode):h=!1,this._mesh._numTexComponents=p;var r=3,s=this._cf.color.node;s?(i=!0,f=s._vf.color,x3dom.isa(s,x3dom.nodeTypes.ColorRGBA)&&(r=4)):i=!1,this._mesh._numColComponents=r,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var t,u,v,w,x,y,z,A,B,C,D,E,F=0,G=0,H=!1;if(g||h||i){for(var I=1;I<l.length-2;++I)-1!=l[I+1]?(H?(t=l[I],u=l[I-1],v=l[I+1]):(t=l[I-1],u=l[I],v=l[I+1]),H=!H,k?(w=t,x=u,y=v):k||(w=x=y=F),z=t,A=u,B=v,j?(C=t,D=u,E=v):j||(C=D=E=F),this._mesh._indices[0].push(G++,G++,G++),this._mesh._positions[0].push(c[t].x),this._mesh._positions[0].push(c[t].y),this._mesh._positions[0].push(c[t].z),this._mesh._positions[0].push(c[u].x),this._mesh._positions[0].push(c[u].y),this._mesh._positions[0].push(c[u].z),this._mesh._positions[0].push(c[v].x),this._mesh._positions[0].push(c[v].y),this._mesh._positions[0].push(c[v].z),g&&(this._mesh._normals[0].push(d[w].x),this._mesh._normals[0].push(d[w].y),this._mesh._normals[0].push(d[w].z),this._mesh._normals[0].push(d[x].x),this._mesh._normals[0].push(d[x].y),this._mesh._normals[0].push(d[x].z),this._mesh._normals[0].push(d[y].x),this._mesh._normals[0].push(d[y].y),this._mesh._normals[0].push(d[y].z)),i&&(this._mesh._colors[0].push(f[C].r),this._mesh._colors[0].push(f[C].g),this._mesh._colors[0].push(f[C].b),4===r&&this._mesh._colors[0].push(f[C].a),this._mesh._colors[0].push(f[D].r),this._mesh._colors[0].push(f[D].g),this._mesh._colors[0].push(f[D].b),4===r&&this._mesh._colors[0].push(f[D].a),this._mesh._colors[0].push(f[E].r),this._mesh._colors[0].push(f[E].g),this._mesh._colors[0].push(f[E].b),4===r&&this._mesh._colors[0].push(f[E].a)),h&&(this._mesh._texCoords[0].push(e[z].x),this._mesh._texCoords[0].push(e[z].y),3===p&&this._mesh._texCoords[0].push(e[z].z),this._mesh._texCoords[0].push(e[A].x),this._mesh._texCoords[0].push(e[A].y),3===p&&this._mesh._texCoords[0].push(e[A].z),this._mesh._texCoords[0].push(e[B].x),this._mesh._texCoords[0].push(e[B].y),3===p&&this._mesh._texCoords[0].push(e[B].z))):(I+=2,F++);g||this._mesh.calcNormals(Math.PI),h||this._mesh.calcTexCoords(o),this._mesh.splitMesh()}else{for(var H=!1,I=1;I<l.length;++I)-1!=l[I+1]?(H?(this._mesh._indices[0].push(l[I]),this._mesh._indices[0].push(l[I-1]),this._mesh._indices[0].push(l[I+1])):(this._mesh._indices[0].push(l[I-1]),this._mesh._indices[0].push(l[I]),this._mesh._indices[0].push(l[I+1])),H=!H):I+=2;this._mesh._positions[0]=c.toGL(),g?this._mesh._normals[0]=d.toGL():this._mesh.calcNormals(Math.PI),h?(this._mesh._texCoords[0]=e.toGL(),this._mesh._numTexComponents=p):this._mesh.calcTexCoords(o),i&&(this._mesh._colors[0]=f.toGL(),this._mesh._numColComponents=r)}for(this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,I=0;I<this._mesh._indices.length;I++)this._mesh._numFaces+=this._mesh._indices[I].length/3,this._mesh._numCoords+=this._mesh._positions[I].length/3;Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()})}else if("color"==a){var J=this._cf.color.node._vf.color,F=0,C=D=E=0,r=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(r=4),this._mesh._colors[0]=[];var l=this._vf.index,H=!1;for(I=1;I<l.length-2;++I)-1!=l[I+1]?(this._vf.colorPerVertex?(H?(C=l[I],D=l[I-1],E=l[I+1]):(C=l[I-1],D=l[I],E=l[I+1]),H=!H):this._vf.colorPerVertex||(C=D=E=F),this._mesh._colors[0].push(J[C].r),this._mesh._colors[0].push(J[C].g),this._mesh._colors[0].push(J[C].b),4===r&&this._mesh._colors[0].push(J[C].a),this._mesh._colors[0].push(J[D].r),this._mesh._colors[0].push(J[D].g),this._mesh._colors[0].push(J[D].b),4===r&&this._mesh._colors[0].push(J[D].a),this._mesh._colors[0].push(J[E].r),this._mesh._colors[0].push(J[E].g),this._mesh._colors[0].push(J[E].b),4===r&&this._mesh._colors[0].push(J[E].a)):(I+=2,F++);Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0})}else if("normal"==a){var K=this._cf.normal.node._vf.vector,F=0,w=x=y=0;this._mesh._normals[0]=[];var l=this._vf.index,H=!1;for(I=1;I<l.length-2;++I)-1!=l[I+1]?(this._vf.normalPerVertex?(H?(w=l[I],x=l[I-1],y=l[I+1]):(w=l[I-1],x=l[I],y=l[I+1]),H=!H):this._vf.normalPerVertex||(w=x=y=F),this._mesh._normals[0].push(K[w].x),this._mesh._normals[0].push(K[w].y),this._mesh._normals[0].push(K[w].z),this._mesh._normals[0].push(K[x].x),this._mesh._normals[0].push(K[x].y),this._mesh._normals[0].push(K[x].z),this._mesh._normals[0].push(K[y].x),this._mesh._normals[0].push(K[y].y),this._mesh._normals[0].push(K[y].z)):(I+=2,F++);Array.forEach(this._parentNodes,function(a){a._dirty.normals=!0})}else if("texCoord"==a){var q=this._cf.texCoord.node;x3dom.isa(q,x3dom.nodeTypes.MultiTextureCoordinate)&&q._cf.texCoord.nodes.length&&(q=q._cf.texCoord.nodes[0]);var L=q._vf.point,z=A=B=0,p=2;x3dom.isa(q,x3dom.nodeTypes.TextureCoordinate3D)&&(p=3),this._mesh._texCoords[0]=[];var l=this._vf.index,H=!1;for(I=1;I<l.length-2;++I)-1!=l[I+1]?(H?(z=l[I],A=l[I-1],B=l[I+1]):(z=l[I-1],A=l[I],B=l[I+1]),H=!H,this._mesh._texCoords[0].push(L[z].x),this._mesh._texCoords[0].push(L[z].y),3===p&&this._mesh._texCoords[0].push(L[z].z),this._mesh._texCoords[0].push(L[A].x),this._mesh._texCoords[0].push(L[A].y),3===p&&this._mesh._texCoords[0].tex(J[A].z),this._mesh._texCoords[0].push(L[B].x),this._mesh._texCoords[0].push(L[B].y),3===p&&this._mesh._texCoords[0].push(L[B].z)):I+=2;Array.forEach(this._parentNodes,function(a){a._dirty.texcoords=!0})}}else if("coord"==a)this._mesh._positions[0]=b.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()});else if("color"==a){if(b=this._cf.color.node._vf.color,this._vf.colorPerVertex)this._mesh._colors[0]=b.toGL();else if(!this._vf.colorPerVertex){var F=0,r=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(r=4),this._mesh._colors[0]=[];var l=this._vf.index;for(I=0;I<l.length;++I)-1!=l[I]?(this._mesh._colors[0].push(b[F].r),this._mesh._colors[0].push(b[F].g),this._mesh._colors[0].push(b[F].b),4===r&&this._mesh._colors[0].push(b[F].a)):F++}Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0})}else if("normal"==a){if(b=this._cf.normal.node._vf.vector,this._vf.normalPerVertex)this._mesh._normals[0]=b.toGL();else if(!this._vf.normalPerVertex){var l=this._vf.index;this._mesh._normals[0]=[];var F=0;for(I=0;I<l.length;++I)-1!=l[I]?(this._mesh._normals[0].push(b[F].x),this._mesh._normals[0].push(b[F].y),this._mesh._normals[0].push(b[F].z)):F++}Array.forEach(this._parentNodes,function(a){a._dirty.normals=!0})}else if("texCoord"==a){var q=this._cf.texCoord.node;x3dom.isa(q,x3dom.nodeTypes.MultiTextureCoordinate)&&q._cf.texCoord.nodes.length&&(q=q._cf.texCoord.nodes[0]),b=q._vf.point,this._mesh._texCoords[0]=b.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.texcoords=!0})}}})),x3dom.registerNodeType("X3DGeometricPropertyNode","Rendering",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DGeometricPropertyNode.superClass.call(this,a)})),x3dom.registerNodeType("X3DCoordinateNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.X3DCoordinateNode.superClass.call(this,a)},{fieldChanged:function(a){("coord"===a||"point"===a)&&Array.forEach(this._parentNodes,function(a){a.fieldChanged("coord")})},parentAdded:function(a){a._mesh&&a._cf.coord.node!==this&&a.fieldChanged("coord")}})),x3dom.registerNodeType("Coordinate","Rendering",defineClass(x3dom.nodeTypes.X3DCoordinateNode,function(a){x3dom.nodeTypes.Coordinate.superClass.call(this,a),this.addField_MFVec3f(a,"point",[])},{getPoints:function(){return this._vf.point}})),x3dom.registerNodeType("Normal","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.Normal.superClass.call(this,a),this.addField_MFVec3f(a,"vector",[])},{fieldChanged:function(a){("normal"===a||"vector"===a)&&Array.forEach(this._parentNodes,function(a){a.fieldChanged("normal")})},parentAdded:function(a){a._mesh&&a._cf.normal.node!==this&&a.fieldChanged("normal")}})),x3dom.registerNodeType("X3DColorNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.X3DColorNode.superClass.call(this,a)},{fieldChanged:function(a){"color"===a&&Array.forEach(this._parentNodes,function(a){a.fieldChanged("color")})},parentAdded:function(a){a._mesh&&a._cf.color.node!==this&&a.fieldChanged("color")}})),x3dom.registerNodeType("Color","Rendering",defineClass(x3dom.nodeTypes.X3DColorNode,function(a){x3dom.nodeTypes.Color.superClass.call(this,a),this.addField_MFColor(a,"color",[])})),x3dom.registerNodeType("ColorRGBA","Rendering",defineClass(x3dom.nodeTypes.X3DColorNode,function(a){x3dom.nodeTypes.ColorRGBA.superClass.call(this,a),this.addField_MFColorRGBA(a,"color",[])})),x3dom.registerNodeType("X3DAppearanceNode","Shape",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DAppearanceNode.superClass.call(this,a)})),x3dom.registerNodeType("Appearance","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceNode,function(a){x3dom.nodeTypes.Appearance.superClass.call(this,a),this.addField_SFNode("material",x3dom.nodeTypes.X3DMaterialNode),this.addField_SFNode("texture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("textureTransform",x3dom.nodeTypes.X3DTextureTransformNode),this.addField_SFNode("lineProperties",x3dom.nodeTypes.LineProperties),this.addField_SFNode("colorMaskMode",x3dom.nodeTypes.ColorMaskMode),this.addField_SFNode("blendMode",x3dom.nodeTypes.BlendMode),this.addField_SFNode("depthMode",x3dom.nodeTypes.DepthMode),this.addField_MFNode("shaders",x3dom.nodeTypes.X3DShaderNode),this.addField_SFString(a,"sortType","auto"),this.addField_SFInt32(a,"sortKey",0),this._shader=null},{nodeChanged:function(){!this._cf.material.node,this._cf.shaders.nodes.length&&(this._shader=this._cf.shaders.nodes[0]),this.checkSortType()},checkSortType:function(){"auto"==this._vf.sortType&&(this._vf.sortType=this._cf.material.node&&this._cf.material.node._vf.transparency>0?"transparent":this._cf.texture.node&&this._cf.texture.node._vf.url.length?this._cf.texture.node._vf.url[0].toLowerCase().indexOf(".png")>=0?"transparent":"opaque":"opaque")},texTransformMatrix:function(){return null===this._cf.textureTransform.node?x3dom.fields.SFMatrix4f.identity():this._cf.textureTransform.node.texTransformMatrix()},parentAdded:function(a){this!=x3dom.nodeTypes.Appearance._defaultNode&&a.setAppDirty()}})),x3dom.nodeTypes.Appearance.defaultNode=function(){return x3dom.nodeTypes.Appearance._defaultNode||(x3dom.nodeTypes.Appearance._defaultNode=new x3dom.nodeTypes.Appearance,x3dom.nodeTypes.Appearance._defaultNode.nodeChanged()),x3dom.nodeTypes.Appearance._defaultNode},x3dom.registerNodeType("X3DAppearanceChildNode","Shape",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DAppearanceChildNode.superClass.call(this,a)})),x3dom.registerNodeType("BlendMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.BlendMode.superClass.call(this,a),this.addField_SFString(a,"srcFactor","src_alpha"),this.addField_SFString(a,"destFactor","one_minus_src_alpha"),this.addField_SFColor(a,"color",1,1,1),this.addField_SFFloat(a,"colorTransparency",0),this.addField_SFString(a,"alphaFunc","none"),this.addField_SFFloat(a,"alphaFuncValue",0),this.addField_SFString(a,"equation","none")})),x3dom.registerNodeType("DepthMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.DepthMode.superClass.call(this,a),this.addField_SFBool(a,"enableDepthTest",!0),this.addField_SFString(a,"depthFunc","none"),this.addField_SFBool(a,"readOnly",!1),this.addField_SFFloat(a,"zNearRange",-1),this.addField_SFFloat(a,"zFarRange",-1)})),x3dom.registerNodeType("ColorMaskMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.ColorMaskMode.superClass.call(this,a),this.addField_SFBool(a,"maskR",!0),this.addField_SFBool(a,"maskG",!0),this.addField_SFBool(a,"maskB",!0),this.addField_SFBool(a,"maskA",!0)})),x3dom.registerNodeType("LineProperties","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.LineProperties.superClass.call(this,a),this.addField_SFBool(a,"applied",!0),this.addField_SFInt32(a,"linetype",1),this.addField_SFFloat(a,"linewidthScaleFactor",0)})),x3dom.registerNodeType("X3DMaterialNode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.X3DMaterialNode.superClass.call(this,a),this.addField_SFFloat(a,"ambientIntensity",.2),this.addField_SFColor(a,"diffuseColor",.8,.8,.8),this.addField_SFColor(a,"emissiveColor",0,0,0),this.addField_SFFloat(a,"shininess",.2),this.addField_SFColor(a,"specularColor",0,0,0),this.addField_SFFloat(a,"transparency",0)})),x3dom.registerNodeType("Material","Shape",defineClass(x3dom.nodeTypes.X3DMaterialNode,function(a){x3dom.nodeTypes.Material.superClass.call(this,a)},{fieldChanged:function(a){("ambientIntensity"==a||"diffuseColor"==a||"emissiveColor"==a||"shininess"==a||"specularColor"==a||"transparency"==a)&&Array.forEach(this._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){a._dirty.material=!0}),a.checkSortType()})}})),x3dom.nodeTypes.Material.defaultNode=function(){return x3dom.nodeTypes.Material._defaultNode||(x3dom.nodeTypes.Material._defaultNode=new x3dom.nodeTypes.Material,x3dom.nodeTypes.Material._defaultNode.nodeChanged()),x3dom.nodeTypes.Material._defaultNode},x3dom.registerNodeType("TwoSidedMaterial","Shape",defineClass(x3dom.nodeTypes.X3DMaterialNode,function(a){x3dom.nodeTypes.TwoSidedMaterial.superClass.call(this,a),this.addField_SFFloat(a,"backAmbientIntensity",.2),this.addField_SFColor(a,"backDiffuseColor",.8,.8,.8),this.addField_SFColor(a,"backEmissiveColor",0,0,0),this.addField_SFFloat(a,"backShininess",.2),this.addField_SFColor(a,"backSpecularColor",0,0,0),this.addField_SFFloat(a,"backTransparency",0),this.addField_SFBool(a,"separateBackColor",!1)},{fieldChanged:function(a){("ambientIntensity"==a||"diffuseColor"==a||"emissiveColor"==a||"shininess"==a||"specularColor"==a||"transparency"==a||"backAmbientIntensity"==a||"backDiffuseColor"==a||"backEmissiveColor"==a||"backShininess"==a||"backSpecularColor"==a||"backTransparency"==a||"separateBackColor"==a)&&Array.forEach(this._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){a._dirty.material=!0}),a.checkSortType()})}})),x3dom.registerNodeType("X3DShapeNode","Shape",defineClass(x3dom.nodeTypes.X3DBoundedNode,function(a){x3dom.nodeTypes.X3DShapeNode.superClass.call(this,a),this.addField_SFBool(a,"isPickable",!0),this.addField_SFNode("appearance",x3dom.nodeTypes.X3DAppearanceNode),this.addField_SFNode("geometry",x3dom.nodeTypes.X3DGeometryNode),this._objectID=0,this._shaderProperties=null,this._cleanupGLObjects=null,this._dirty={positions:!0,normals:!0,texcoords:!0,colors:!0,indexes:!0,texture:!0,material:!0,text:!0,shader:!0},this._coordStrideOffset=[0,0],this._normalStrideOffset=[0,0],this._texCoordStrideOffset=[0,0],this._colorStrideOffset=[0,0],this._tessellationProperties=[]},{collectDrawableObjects:function(a,b,c,d,e){var f=this.graphState();return c&&this._parentNodes.length>1&&(c=!1),c&&(d=d||this.cacheInvalid())&&this.invalidateCache(),!this._cf.geometry.node||b.cull(a,f,c,e)<=0?!1:(c&&!this._graph.globalMatrix&&(this._graph.globalMatrix=a),b.addShape(this,a,f),!0)},getVolume:function(){var a=this._graph.volume;if(!this.volumeValid()&&this._vf.render){var b=this._cf.geometry.node,c=b?b.getVolume():null;c&&c.isValid()&&a.extendBounds(c.min,c.max)}return a},getCenter:function(){var a=this._cf.geometry.node;return a?a.getCenter():new x3dom.fields.SFVec3f(0,0,0)},getDiameter:function(){var a=this._cf.geometry.node;return a?a.getDiameter():0},doIntersect:function(a){return this._cf.geometry.node.doIntersect(a)},forceUpdateCoverage:function(){var a=this._cf.geometry.node;return a?a.forceUpdateCoverage():!1},tessellationProperties:function(){var a=this._cf.geometry.node;return a&&a._indexOffset?a._indexOffset:this._tessellationProperties},isSolid:function(){return this._cf.geometry.node._vf.solid},isCCW:function(){return this._cf.geometry.node._vf.ccw},parentRemoved:function(a){for(var b=0,c=this._childNodes.length;c>b;b++){var d=this._childNodes[b];d&&d.parentRemoved(this)}a&&a.invalidateVolume(),this._parentNodes.length>0&&this.invalidateVolume(),this._cleanupGLObjects&&this._cleanupGLObjects()},unsetDirty:function(){this._dirty.positions=!1,this._dirty.normals=!1,this._dirty.texcoords=!1,this._dirty.colors=!1,this._dirty.indexes=!1,this._dirty.texture=!1,this._dirty.material=!1,this._dirty.text=!1,this._dirty.shader=!1},unsetGeoDirty:function(){this._dirty.positions=!1,this._dirty.normals=!1,this._dirty.texcoords=!1,this._dirty.colors=!1,this._dirty.indexes=!1},setAllDirty:function(){this._dirty.positions=!0,this._dirty.normals=!0,this._dirty.texcoords=!0,this._dirty.colors=!0,this._dirty.indexes=!0,this._dirty.texture=!0,this._dirty.material=!0,this._dirty.text=!0,this._dirty.shader=!0,this.invalidateVolume()},setAppDirty:function(){this._dirty.texture=!0,this._dirty.material=!0,this._dirty.shader=!0},setGeoDirty:function(){this._dirty.positions=!0,this._dirty.normals=!0,this._dirty.texcoords=!0,this._dirty.colors=!0,this._dirty.indexes=!0,this.invalidateVolume()},getShaderProperties:function(a){return(null==this._shaderProperties||1==this._dirty.shader||void 0!==this._webgl&&this._webgl.dirtyLighting!=x3dom.Utils.checkDirtyLighting(a))&&(this._shaderProperties=x3dom.Utils.generateProperties(a,this),this._dirty.shader=!1,void 0!==this._webgl&&(this._webgl.dirtyLighting=x3dom.Utils.checkDirtyLighting(a))),this._shaderProperties},getTextures:function(){var a=[],b=this._cf.appearance.node;if(b){var c=b._cf.texture.node;c&&(x3dom.isa(c,x3dom.nodeTypes.MultiTexture)?a=a.concat(c.getTextures()):a.push(c));var d=b._cf.shaders.nodes[0];d&&x3dom.isa(d,x3dom.nodeTypes.CommonSurfaceShader)&&(a=a.concat(d.getTextures()))}var e=this._cf.geometry.node;return e&&(x3dom.isa(e,x3dom.nodeTypes.ImageGeometry)?a=a.concat(e.getTextures()):x3dom.isa(e,x3dom.nodeTypes.Text)&&(a=a.concat(e))),a}})),x3dom.registerNodeType("Shape","Shape",defineClass(x3dom.nodeTypes.X3DShapeNode,function(a){x3dom.nodeTypes.Shape.superClass.call(this,a)},{nodeChanged:function(){!this._cf.appearance.node,this._cf.geometry.node?this._objectID||(this._objectID=++x3dom.nodeTypes.Shape.objectID,x3dom.nodeTypes.Shape.idMap.nodeID[this._objectID]=this):this._DEF&&x3dom.debug.logError("No geometry given in Shape/"+this._DEF),this.invalidateVolume()}})),x3dom.nodeTypes.Shape.objectID=0,x3dom.nodeTypes.Shape.idMap={nodeID:{},remove:function(a){for(var b in this.nodeID)if(this.nodeID.hasOwnProperty(b)){var c=this.nodeID[b];c._objectID&&a._objectID&&c._objectID===a._objectID&&(delete this.nodeID[b],x3dom.debug.logInfo("Unreg "+c._objectID))}}},x3dom.registerNodeType("X3DLightNode","Lighting",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DLightNode.superClass.call(this,a),a?a.doc._nodeBag.lights.push(this):x3dom.debug.logWarning("X3DLightNode: No runtime context found!"),this._lightID=0,this._dirty=!0,this.addField_SFFloat(a,"ambientIntensity",0),this.addField_SFColor(a,"color",1,1,1),this.addField_SFFloat(a,"intensity",1),this.addField_SFBool(a,"global",!1),this.addField_SFBool(a,"on",!0),this.addField_SFFloat(a,"shadowIntensity",0),this.addField_SFInt32(a,"shadowMapSize",1024),this.addField_SFInt32(a,"shadowFilterSize",0),this.addField_SFFloat(a,"shadowOffset",0),this.addField_SFFloat(a,"zNear",-1),this.addField_SFFloat(a,"zFar",-1)},{getViewMatrix:function(){return x3dom.fields.SFMatrix4f.identity},nodeChanged:function(){this._lightID||(this._lightID=++x3dom.nodeTypes.X3DLightNode.lightID)},fieldChanged:function(a){this._vf.hasOwnProperty(a)&&(this._dirty=!0)},parentRemoved:function(){if(0===this._parentNodes.length)for(var a=this.findX3DDoc(),b=0,c=a._nodeBag.lights.length;c>b;b++)a._nodeBag.lights[b]===this&&a._nodeBag.lights.splice(b,1)}})),x3dom.nodeTypes.X3DLightNode.lightID=0,x3dom.registerNodeType("DirectionalLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(a){x3dom.nodeTypes.DirectionalLight.superClass.call(this,a),this.addField_SFVec3f(a,"direction",0,0,-1),this.addField_SFInt32(a,"shadowCascades",1),this.addField_SFFloat(a,"shadowSplitFactor",1),this.addField_SFFloat(a,"shadowSplitOffset",.1)},{getViewMatrix:function(a){var b=this.getCurrentTransform().multMatrixVec(this._vf.direction).normalize(),c=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),b);return c.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(a.negate()))}})),x3dom.registerNodeType("PointLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(a){x3dom.nodeTypes.PointLight.superClass.call(this,a),this.addField_SFVec3f(a,"attenuation",1,0,0),this.addField_SFVec3f(a,"location",0,0,0),this.addField_SFFloat(a,"radius",100),this._vf.global=!0},{getViewMatrix:function(a){var b=this.getCurrentTransform().multMatrixPnt(this._vf.location),c=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),a);return c.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(b.negate()))}})),x3dom.registerNodeType("SpotLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(a){x3dom.nodeTypes.SpotLight.superClass.call(this,a),this.addField_SFVec3f(a,"direction",0,0,-1),this.addField_SFVec3f(a,"attenuation",1,0,0),this.addField_SFVec3f(a,"location",0,0,0),this.addField_SFFloat(a,"radius",100),this.addField_SFFloat(a,"beamWidth",1.5707963),this.addField_SFFloat(a,"cutOffAngle",1.5707963),this.addField_SFInt32(a,"shadowCascades",1),this.addField_SFFloat(a,"shadowSplitFactor",1),this.addField_SFFloat(a,"shadowSplitOffset",.1),this._vf.global=!0},{getViewMatrix:function(){var a=this.getCurrentTransform().multMatrixPnt(this._vf.location),b=this.getCurrentTransform().multMatrixVec(this._vf.direction).normalize(),c=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),b);return c.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(a.negate()))}})),x3dom.registerNodeType("X3DFollowerNode","Followers",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DFollowerNode.superClass.call(this,a),a?a.doc._nodeBag.followers.push(this):x3dom.debug.logWarning("X3DFollowerNode: No runtime context found!"),this.addField_SFBool(a,"isActive",!1),this._eps=x3dom.fields.Eps},{parentRemoved:function(){if(0===this._parentNodes.length)for(var a=this.findX3DDoc(),b=0,c=a._nodeBag.followers.length;c>b;b++)a._nodeBag.followers[b]===this&&a._nodeBag.followers.splice(b,1)},tick:function(){return!1},stepResponse:function(a){return 0>=a?0:a>=this._vf.duration?1:this.stepResponseCore(a/this._vf.duration)},stepResponseCore:function(a){return.5-.5*Math.cos(a*Math.PI)}})),x3dom.registerNodeType("X3DChaserNode","Followers",defineClass(x3dom.nodeTypes.X3DFollowerNode,function(a){x3dom.nodeTypes.X3DChaserNode.superClass.call(this,a),this.addField_SFTime(a,"duration",1),this._initDone=!1,this._stepTime=0,this._currTime=0,this._bufferEndTime=0,this._numSupports=60})),x3dom.registerNodeType("X3DDamperNode","Followers",defineClass(x3dom.nodeTypes.X3DFollowerNode,function(a){x3dom.nodeTypes.X3DDamperNode.superClass.call(this,a),this.addField_SFTime(a,"tau",.3),this.addField_SFFloat(a,"tolerance",-1),this.addField_SFInt32(a,"order",3),this._eps=this._vf.tolerance<0?this._eps:this._vf.tolerance,this._lastTick=0})),x3dom.registerNodeType("ColorChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(a){x3dom.nodeTypes.ColorChaser.superClass.call(this,a),this.addField_SFColor(a,"initialDestination",.8,.8,.8),this.addField_SFColor(a,"initialValue",.8,.8,.8),this.addField_SFColor(a,"value",0,0,0),this.addField_SFColor(a,"destination",0,0,0),this._buffer=new x3dom.fields.MFColor,this._previousValue=new x3dom.fields.SFColor(0,0,0),this._value=new x3dom.fields.SFColor(0,0,0),this.initialize()},{fieldChanged:function(a){if(a.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(a.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var b=1;b<this._buffer.length;b++)this._buffer[b].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var a=1;a<this._buffer.length;a++)this._buffer[a]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var b=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==b&&this.postMessage("isActive",b)}},tick:function(a){if(this.initialize(),this._currTime=a,!this._bufferEndTime)return this._bufferEndTime=a,this._value=this._vf.initialValue,this.postMessage("value",this._value),!0;var b=this.updateBuffer(a),c=this._previousValue,d=this._buffer[this._buffer.length-1].subtract(this._previousValue),e=d.multiply(this.stepResponse((this._buffer.length-1+b)*this._stepTime));c=c.add(e);for(var f=this._buffer.length-2;f>=0;f--)d=this._buffer[f].subtract(this._buffer[f+1]),e=d.multiply(this.stepResponse((f+b)*this._stepTime)),c=c.add(e);return c.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(c),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(a){var b,c,d,e=(a-this._bufferEndTime)/this._stepTime;if(e>=1){if(c=Math.floor(e),e-=c,c<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-c],b=this._buffer.length-1;b>=c;b--)this._buffer[b]=this._buffer[b-c];for(b=0;c>b;b++)d=b/c,this._buffer[b]=this._buffer[c].multiply(d).add(this._vf.destination.multiply(1-d))}else for(this._previousValue=c==this._buffer.length?this._buffer[0]:this._vf.destination,b=0;b<this._buffer.length;b++)this._buffer[b]=this._vf.destination;this._bufferEndTime+=c*this._stepTime}return e}})),x3dom.registerNodeType("ColorDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.ColorDamper.superClass.call(this,a),this.addField_SFColor(a,"initialDestination",.8,.8,.8),this.addField_SFColor(a,"initialValue",.8,.8,.8),this.addField_SFColor(a,"value",0,0,0),this.addField_SFColor(a,"destination",0,0,0),this._value0=new x3dom.fields.SFColor(0,0,0),this._value1=new x3dom.fields.SFColor(0,0,0),this._value2=new x3dom.fields.SFColor(0,0,0),this._value3=new x3dom.fields.SFColor(0,0,0),this._value4=new x3dom.fields.SFColor(0,0,0),this._value5=new x3dom.fields.SFColor(0,0,0),this.initialize()},{fieldChanged:function(a){"tolerance"===a?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:a.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):a.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var a=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==a&&this.postMessage("isActive",a)},distance:function(a,b){var c=a.subtract(b);return Math.sqrt(c.r*c.r+c.g*c.g+c.b*c.b)},tick:function(a){if(!this._lastTick)return this._lastTick=a,!1;var b=a-this._lastTick,c=Math.exp(-b/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(c)):new x3dom.fields.SFColor(this._value0.r,this._value0.g,this._value0.b),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(c)):new x3dom.fields.SFColor(this._value1.r,this._value1.g,this._value1.b),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(c)):new x3dom.fields.SFColor(this._value2.r,this._value2.g,this._value2.b),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(c)):new x3dom.fields.SFColor(this._value3.r,this._value3.g,this._value3.b),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(c)):new x3dom.fields.SFColor(this._value4.r,this._value4.g,this._value4.b);var d=this.distance(this._value1,this._value0);if(this._vf.order>1){var e=this.distance(this._value2,this._value1);e>d&&(d=e)}if(this._vf.order>2){var f=this.distance(this._value3,this._value2);f>d&&(d=f)}if(this._vf.order>3){var g=this.distance(this._value4,this._value3);g>d&&(d=g)}if(this._vf.order>4){var h=this.distance(this._value5,this._value4);h>d&&(d=h)}return d<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=a,!0)}})),x3dom.registerNodeType("OrientationChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(a){x3dom.nodeTypes.OrientationChaser.superClass.call(this,a),this.addField_SFRotation(a,"initialDestination",0,1,0,0),this.addField_SFRotation(a,"initialValue",0,1,0,0),this.addField_SFRotation(a,"value",0,1,0,0),this.addField_SFRotation(a,"destination",0,1,0,0),this._numSupports=30,this._buffer=new x3dom.fields.MFRotation,this._previousValue=new x3dom.fields.Quaternion(0,1,0,0),this._value=new x3dom.fields.Quaternion(0,1,0,0),this.initialize()},{fieldChanged:function(a){if(a.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(a.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var b=1;b<this._buffer.length;b++)this._buffer[b].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=x3dom.fields.Quaternion.copy(this._vf.initialDestination),this._buffer.length=this._numSupports,this._buffer[0]=x3dom.fields.Quaternion.copy(this._vf.initialDestination);for(var a=1;a<this._buffer.length;a++)this._buffer[a]=x3dom.fields.Quaternion.copy(this._vf.initialValue);this._previousValue=x3dom.fields.Quaternion.copy(this._vf.initialValue),this._stepTime=this._vf.duration/this._numSupports;var b=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==b&&this.postMessage("isActive",b)}},tick:function(a){if(this.initialize(),this._currTime=a,!this._bufferEndTime)return this._bufferEndTime=a,this._value=x3dom.fields.Quaternion.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;
var b=this.updateBuffer(a),c=x3dom.fields.Quaternion.copy(this._previousValue),d=this._previousValue.inverse().multiply(this._buffer[this._buffer.length-1]);c=c.slerp(c.multiply(d),this.stepResponse((this._buffer.length-1+b)*this._stepTime));for(var e=this._buffer.length-2;e>=0;e--)d=this._buffer[e+1].inverse().multiply(this._buffer[e]),c=c.slerp(c.multiply(d),this.stepResponse((e+b)*this._stepTime));return c.equals(this._value,this._eps)?this.postMessage("isActive",!1):(c=c.normalize(c),this._value.setValues(c),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(a){var b,c,d,e=(a-this._bufferEndTime)/this._stepTime;if(e>=1){if(c=Math.floor(e),e-=c,c<this._buffer.length){for(this._previousValue=x3dom.fields.Quaternion.copy(this._buffer[this._buffer.length-c]),b=this._buffer.length-1;b>=c;b--)this._buffer[b]=x3dom.fields.Quaternion.copy(this._buffer[b-c]);for(b=0;c>b;b++)d=b/c,this._buffer[b]=this._vf.destination.slerp(this._buffer[c],d)}else for(this._previousValue=x3dom.fields.Quaternion.copy(c==this._buffer.length?this._buffer[0]:this._vf.destination),b=0;b<this._buffer.length;b++)this._buffer[b]=x3dom.fields.Quaternion.copy(this._vf.destination);this._bufferEndTime+=c*this._stepTime}return e}})),x3dom.registerNodeType("OrientationDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.OrientationDamper.superClass.call(this,a),this.addField_SFRotation(a,"initialDestination",0,1,0,0),this.addField_SFRotation(a,"initialValue",0,1,0,0),this.addField_SFRotation(a,"value",0,1,0,0),this.addField_SFRotation(a,"destination",0,1,0,0),this._value0=new x3dom.fields.Quaternion(0,1,0,0),this._value1=new x3dom.fields.Quaternion(0,1,0,0),this._value2=new x3dom.fields.Quaternion(0,1,0,0),this._value3=new x3dom.fields.Quaternion(0,1,0,0),this._value4=new x3dom.fields.Quaternion(0,1,0,0),this._value5=new x3dom.fields.Quaternion(0,1,0,0),this.initialize()},{fieldChanged:function(a){"tolerance"===a?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:a.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):a.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var a=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==a&&this.postMessage("isActive",a)},tick:function(a){if(!this._lastTick)return this._lastTick=a,!1;var b=a-this._lastTick,c=Math.exp(-b/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.slerp(this._value1,c):new x3dom.fields.Quaternion(this._value0.x,this._value0.y,this._value0.z,this._value0.w),this._value2=this._vf.order>1&&this._vf.tau?this._value1.slerp(this._value2,c):new x3dom.fields.Quaternion(this._value1.x,this._value1.y,this._value1.z,this._value1.w),this._value3=this._vf.order>2&&this._vf.tau?this._value2.slerp(this._value3,c):new x3dom.fields.Quaternion(this._value2.x,this._value2.y,this._value2.z,this._value2.w),this._value4=this._vf.order>3&&this._vf.tau?this._value3.slerp(this._value4,c):new x3dom.fields.Quaternion(this._value3.x,this._value3.y,this._value3.z,this._value3.w),this._value5=this._vf.order>4&&this._vf.tau?this._value4.slerp(this._value5,c):new x3dom.fields.Quaternion(this._value4.x,this._value4.y,this._value4.z,this._value4.w);var d=Math.abs(this._value1.inverse().multiply(this._value0).angle());if(this._vf.order>1){var e=Math.abs(this._value2.inverse().multiply(this._value1).angle());e>d&&(d=e)}if(this._vf.order>2){var f=Math.abs(this._value3.inverse().multiply(this._value2).angle());f>d&&(d=f)}if(this._vf.order>3){var g=Math.abs(this._value4.inverse().multiply(this._value3).angle());g>d&&(d=g)}if(this._vf.order>4){var h=Math.abs(this._value5.inverse().multiply(this._value4).angle());h>d&&(d=h)}return d<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=a,!0)}})),x3dom.registerNodeType("PositionChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(a){x3dom.nodeTypes.PositionChaser.superClass.call(this,a),this.addField_SFVec3f(a,"initialDestination",0,0,0),this.addField_SFVec3f(a,"initialValue",0,0,0),this.addField_SFVec3f(a,"value",0,0,0),this.addField_SFVec3f(a,"destination",0,0,0),this._buffer=new x3dom.fields.MFVec3f,this._previousValue=new x3dom.fields.SFVec3f(0,0,0),this._value=new x3dom.fields.SFVec3f(0,0,0),this.initialize()},{fieldChanged:function(a){if(a.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(a.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var b=1;b<this._buffer.length;b++)this._buffer[b].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=x3dom.fields.SFVec3f.copy(this._vf.initialDestination),this._buffer.length=this._numSupports,this._buffer[0]=x3dom.fields.SFVec3f.copy(this._vf.initialDestination);for(var a=1;a<this._buffer.length;a++)this._buffer[a]=x3dom.fields.SFVec3f.copy(this._vf.initialValue);this._previousValue=x3dom.fields.SFVec3f.copy(this._vf.initialValue),this._stepTime=this._vf.duration/this._numSupports;var b=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==b&&this.postMessage("isActive",b)}},tick:function(a){if(this.initialize(),this._currTime=a,!this._bufferEndTime)return this._bufferEndTime=a,this._value=x3dom.fields.SFVec3f.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;var b=this.updateBuffer(a),c=x3dom.fields.SFVec3f.copy(this._previousValue),d=this._buffer[this._buffer.length-1].subtract(this._previousValue),e=d.multiply(this.stepResponse((this._buffer.length-1+b)*this._stepTime));c=c.add(e);for(var f=this._buffer.length-2;f>=0;f--)d=this._buffer[f].subtract(this._buffer[f+1]),e=d.multiply(this.stepResponse((f+b)*this._stepTime)),c=c.add(e);return c.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(c),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(a){var b,c,d,e=(a-this._bufferEndTime)/this._stepTime;if(e>=1){if(c=Math.floor(e),e-=c,c<this._buffer.length){for(this._previousValue=x3dom.fields.SFVec3f.copy(this._buffer[this._buffer.length-c]),b=this._buffer.length-1;b>=c;b--)this._buffer[b]=x3dom.fields.SFVec3f.copy(this._buffer[b-c]);for(b=0;c>b;b++)d=b/c,this._buffer[b]=this._buffer[c].multiply(d).add(this._vf.destination.multiply(1-d))}else for(this._previousValue=x3dom.fields.SFVec3f.copy(c==this._buffer.length?this._buffer[0]:this._vf.destination),b=0;b<this._buffer.length;b++)this._buffer[b]=x3dom.fields.SFVec3f.copy(this._vf.destination);this._bufferEndTime+=c*this._stepTime}return e}})),x3dom.registerNodeType("PositionChaser2D","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(a){x3dom.nodeTypes.PositionChaser2D.superClass.call(this,a),this.addField_SFVec2f(a,"initialDestination",0,0),this.addField_SFVec2f(a,"initialValue",0,0),this.addField_SFVec2f(a,"value",0,0),this.addField_SFVec2f(a,"destination",0,0),this._buffer=new x3dom.fields.MFVec2f,this._previousValue=new x3dom.fields.SFVec2f(0,0),this._value=new x3dom.fields.SFVec2f(0,0),this.initialize()},{fieldChanged:function(a){if(a.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(a.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var b=1;b<this._buffer.length;b++)this._buffer[b].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=x3dom.fields.SFVec2f.copy(this._vf.initialDestination),this._buffer.length=this._numSupports,this._buffer[0]=x3dom.fields.SFVec2f.copy(this._vf.initialDestination);for(var a=1;a<this._buffer.length;a++)this._buffer[a]=x3dom.fields.SFVec2f.copy(this._vf.initialValue);this._previousValue=x3dom.fields.SFVec2f.copy(this._vf.initialValue),this._stepTime=this._vf.duration/this._numSupports;var b=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==b&&this.postMessage("isActive",b)}},tick:function(a){if(this.initialize(),this._currTime=a,!this._bufferEndTime)return this._bufferEndTime=a,this._value=x3dom.fields.SFVec2f.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;var b=this.updateBuffer(a),c=x3dom.fields.SFVec2f.copy(this._previousValue),d=this._buffer[this._buffer.length-1].subtract(this._previousValue),e=d.multiply(this.stepResponse((this._buffer.length-1+b)*this._stepTime));c=c.add(e);for(var f=this._buffer.length-2;f>=0;f--)d=this._buffer[f].subtract(this._buffer[f+1]),e=d.multiply(this.stepResponse((f+b)*this._stepTime)),c=c.add(e);return c.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(c),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(a){var b,c,d,e=(a-this._bufferEndTime)/this._stepTime;if(e>=1){if(c=Math.floor(e),e-=c,c<this._buffer.length){for(this._previousValue=x3dom.fields.SFVec2f.copy(this._buffer[this._buffer.length-c]),b=this._buffer.length-1;b>=c;b--)this._buffer[b]=x3dom.fields.SFVec2f.copy(this._buffer[b-c]);for(b=0;c>b;b++)d=b/c,this._buffer[b]=this._buffer[c].multiply(d).add(this._vf.destination.multiply(1-d))}else for(this._previousValue=x3dom.fields.SFVec2f.copy(c==this._buffer.length?this._buffer[0]:this._vf.destination),b=0;b<this._buffer.length;b++)this._buffer[b]=x3dom.fields.SFVec2f.copy(this._vf.destination);this._bufferEndTime+=c*this._stepTime}return e}})),x3dom.registerNodeType("PositionDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.PositionDamper.superClass.call(this,a),this.addField_SFVec3f(a,"initialDestination",0,0,0),this.addField_SFVec3f(a,"initialValue",0,0,0),this.addField_SFVec3f(a,"value",0,0,0),this.addField_SFVec3f(a,"destination",0,0,0),this._value0=new x3dom.fields.SFVec3f(0,0,0),this._value1=new x3dom.fields.SFVec3f(0,0,0),this._value2=new x3dom.fields.SFVec3f(0,0,0),this._value3=new x3dom.fields.SFVec3f(0,0,0),this._value4=new x3dom.fields.SFVec3f(0,0,0),this._value5=new x3dom.fields.SFVec3f(0,0,0),this.initialize()},{fieldChanged:function(a){"tolerance"===a?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:a.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):a.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var a=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==a&&this.postMessage("isActive",a)},tick:function(a){if(!this._lastTick)return this._lastTick=a,!1;var b=a-this._lastTick,c=Math.exp(-b/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(c)):new x3dom.fields.SFVec3f(this._value0.x,this._value0.y,this._value0.z),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(c)):new x3dom.fields.SFVec3f(this._value1.x,this._value1.y,this._value1.z),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(c)):new x3dom.fields.SFVec3f(this._value2.x,this._value2.y,this._value2.z),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(c)):new x3dom.fields.SFVec3f(this._value3.x,this._value3.y,this._value3.z),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(c)):new x3dom.fields.SFVec3f(this._value4.x,this._value4.y,this._value4.z);var d=this._value1.subtract(this._value0).length();if(this._vf.order>1){var e=this._value2.subtract(this._value1).length();e>d&&(d=e)}if(this._vf.order>2){var f=this._value3.subtract(this._value2).length();f>d&&(d=f)}if(this._vf.order>3){var g=this._value4.subtract(this._value3).length();g>d&&(d=g)}if(this._vf.order>4){var h=this._value5.subtract(this._value4).length();h>d&&(d=h)}return d<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=a,!0)}})),x3dom.registerNodeType("PositionDamper2D","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.PositionDamper2D.superClass.call(this,a),this.addField_SFVec2f(a,"initialDestination",0,0),this.addField_SFVec2f(a,"initialValue",0,0),this.addField_SFVec2f(a,"value",0,0),this.addField_SFVec2f(a,"destination",0,0),this._value0=new x3dom.fields.SFVec2f(0,0),this._value1=new x3dom.fields.SFVec2f(0,0),this._value2=new x3dom.fields.SFVec2f(0,0),this._value3=new x3dom.fields.SFVec2f(0,0),this._value4=new x3dom.fields.SFVec2f(0,0),this._value5=new x3dom.fields.SFVec2f(0,0),this.initialize()},{fieldChanged:function(a){"tolerance"===a?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:a.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):a.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var a=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==a&&this.postMessage("isActive",a)},tick:function(a){if(!this._lastTick)return this._lastTick=a,!1;var b=a-this._lastTick,c=Math.exp(-b/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(c)):new x3dom.fields.SFVec2f(this._value0.x,this._value0.y,this._value0.z),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(c)):new x3dom.fields.SFVec2f(this._value1.x,this._value1.y,this._value1.z),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(c)):new x3dom.fields.SFVec2f(this._value2.x,this._value2.y,this._value2.z),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(c)):new x3dom.fields.SFVec2f(this._value3.x,this._value3.y,this._value3.z),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(c)):new x3dom.fields.SFVec2f(this._value4.x,this._value4.y,this._value4.z);var d=this._value1.subtract(this._value0).length();if(this._vf.order>1){var e=this._value2.subtract(this._value1).length();e>d&&(d=e)}if(this._vf.order>2){var f=this._value3.subtract(this._value2).length();f>d&&(d=f)}if(this._vf.order>3){var g=this._value4.subtract(this._value3).length();g>d&&(d=g)}if(this._vf.order>4){var h=this._value5.subtract(this._value4).length();h>d&&(d=h)}return d<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=a,!0)}})),x3dom.registerNodeType("ScalarChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(a){x3dom.nodeTypes.ScalarChaser.superClass.call(this,a),this.addField_SFFloat(a,"initialDestination",0),this.addField_SFFloat(a,"initialValue",0),this.addField_SFFloat(a,"value",0),this.addField_SFFloat(a,"destination",0),this._buffer=[],this._previousValue=0,this._value=0,this.initialize()},{fieldChanged:function(a){if(a.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(a.indexOf("value")>=0){this.initialize(),this._previousValue=this._vf.value;for(var b=1;b<this._buffer.length;b++)this._buffer[b]=this._vf.value;this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var a=1;a<this._buffer.length;a++)this._buffer[a]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var b=Math.abs(this._buffer[0]-this._buffer[1])>this._eps;this._vf.isActive!==b&&this.postMessage("isActive",b)}},tick:function(a){if(this.initialize(),this._currTime=a,!this._bufferEndTime)return this._bufferEndTime=a,this._value=this._vf.initialValue,this.postMessage("value",this._value),!0;var b=this.updateBuffer(a),c=this._previousValue,d=this._buffer[this._buffer.length-1]-this._previousValue,e=d*this.stepResponse((this._buffer.length-1+b)*this._stepTime);c+=e;for(var f=this._buffer.length-2;f>=0;f--)d=this._buffer[f]-this._buffer[f+1],e=d*this.stepResponse((f+b)*this._stepTime),c+=e;return Math.abs(c-this._value)>this._eps?(this._value=c,this.postMessage("value",this._value)):this.postMessage("isActive",!1),this._vf.isActive},updateBuffer:function(a){var b,c,d,e=(a-this._bufferEndTime)/this._stepTime;if(e>=1){if(c=Math.floor(e),e-=c,c<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-c],b=this._buffer.length-1;b>=c;b--)this._buffer[b]=this._buffer[b-c];for(b=0;c>b;b++)d=b/c,this._buffer[b]=this._buffer[c]*d+this._vf.destination*(1-d)}else for(this._previousValue=c==this._buffer.length?this._buffer[0]:this._vf.destination,b=0;b<this._buffer.length;b++)this._buffer[b]=this._vf.destination;this._bufferEndTime+=c*this._stepTime}return e}})),x3dom.registerNodeType("ScalarDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.ScalarDamper.superClass.call(this,a),this.addField_SFFloat(a,"initialDestination",0),this.addField_SFFloat(a,"initialValue",0),this.addField_SFFloat(a,"value",0),this.addField_SFFloat(a,"destination",0),this._value0=0,this._value1=0,this._value2=0,this._value3=0,this._value4=0,this._value5=0,this.initialize()},{fieldChanged:function(a){"tolerance"===a?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:a.indexOf("destination")>=0?Math.abs(this._value0-this._vf.destination)>this._eps&&(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):a.indexOf("value")>=0&&(this._value1=this._vf.value,this._value2=this._vf.value,this._value3=this._vf.value,this._value4=this._vf.value,this._value5=this._vf.value,this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0=this._vf.initialDestination,this._value1=this._vf.initialValue,this._value2=this._vf.initialValue,this._value3=this._vf.initialValue,this._value4=this._vf.initialValue,this._value5=this._vf.initialValue,this._lastTick=0;var a=Math.abs(this._value0-this._value1)>this._eps;this._vf.isActive!==a&&this.postMessage("isActive",a)},tick:function(a){if(!this._lastTick)return this._lastTick=a,!1;var b=a-this._lastTick,c=Math.exp(-b/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0+c*(this._value1-this._value0):this._value0,this._value2=this._vf.order>1&&this._vf.tau?this._value1+c*(this._value2-this._value1):this._value1,this._value3=this._vf.order>2&&this._vf.tau?this._value2+c*(this._value3-this._value2):this._value2,this._value4=this._vf.order>3&&this._vf.tau?this._value3+c*(this._value4-this._value3):this._value3,this._value5=this._vf.order>4&&this._vf.tau?this._value4+c*(this._value5-this._value4):this._value4;var d=Math.abs(this._value1-this._value0);if(this._vf.order>1){var e=Math.abs(this._value2-this._value1);e>d&&(d=e)}if(this._vf.order>2){var f=Math.abs(this._value3-this._value2);f>d&&(d=f)}if(this._vf.order>3){var g=Math.abs(this._value4-this._value3);g>d&&(d=g)}if(this._vf.order>4){var h=Math.abs(this._value5-this._value4);h>d&&(d=h)}return d<=this._eps?(this._value1=this._value0,this._value2=this._value0,this._value3=this._value0,this._value4=this._value0,this._value5=this._value0,this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=a,!0)}})),x3dom.registerNodeType("CoordinateDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.CoordinateDamper.superClass.call(this,a),this.addField_MFVec3f(a,"initialDestination",[]),this.addField_MFVec3f(a,"initialValue",[]),this.addField_MFVec3f(a,"value",[]),this.addField_MFVec3f(a,"destination",[]),x3dom.debug.logWarning("CoordinateDamper NYI")})),x3dom.registerNodeType("TexCoordDamper2D","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.TexCoordDamper2D.superClass.call(this,a),this.addField_MFVec2f(a,"initialDestination",[]),this.addField_MFVec2f(a,"initialValue",[]),this.addField_MFVec2f(a,"value",[]),this.addField_MFVec2f(a,"destination",[]),x3dom.debug.logWarning("TexCoordDamper2D NYI")})),x3dom.registerNodeType("X3DInterpolatorNode","Interpolation",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DInterpolatorNode.superClass.call(this,a),this.addField_MFFloat(a,"key",[]),this.addField_SFFloat(a,"set_fraction",0)},{linearInterp:function(a,b){if(a<=this._vf.key[0])return this._vf.keyValue[0];if(a>=this._vf.key[this._vf.key.length-1])return this._vf.keyValue[this._vf.key.length-1];for(var c=0;c<this._vf.key.length-1;++c)if(this._vf.key[c]<a&&a<=this._vf.key[c+1])return b(this._vf.keyValue[c],this._vf.keyValue[c+1],(a-this._vf.key[c])/(this._vf.key[c+1]-this._vf.key[c]));return this._vf.keyValue[0]}})),x3dom.registerNodeType("OrientationInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){x3dom.nodeTypes.OrientationInterpolator.superClass.call(this,a),this.addField_MFRotation(a,"keyValue",[])},{fieldChanged:function(a){if("set_fraction"===a){var b=this.linearInterp(this._vf.set_fraction,function(a,b,c){return a.slerp(b,c)});this.postMessage("value_changed",b)}}})),x3dom.registerNodeType("PositionInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){x3dom.nodeTypes.PositionInterpolator.superClass.call(this,a),this.addField_MFVec3f(a,"keyValue",[])},{fieldChanged:function(a){if("set_fraction"===a){var b=this.linearInterp(this._vf.set_fraction,function(a,b,c){return a.multiply(1-c).add(b.multiply(c))});this.postMessage("value_changed",b)}}})),x3dom.registerNodeType("NormalInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){x3dom.nodeTypes.NormalInterpolator.superClass.call(this,a),this.addField_MFVec3f(a,"keyValue",[])},{fieldChanged:function(a){if("set_fraction"===a){var b=this.linearInterp(this._vf.set_fraction,function(a,b,c){return a.multiply(1-c).add(b.multiply(c)).normalize()});this.postMessage("value_changed",b)}}})),x3dom.registerNodeType("ColorInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){x3dom.nodeTypes.ColorInterpolator.superClass.call(this,a),this.addField_MFColor(a,"keyValue",[])},{fieldChanged:function(a){if("set_fraction"===a){var b=this.linearInterp(this._vf.set_fraction,function(a,b,c){return a.multiply(1-c).add(b.multiply(c))});this.postMessage("value_changed",b)}}})),x3dom.registerNodeType("ScalarInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){x3dom.nodeTypes.ScalarInterpolator.superClass.call(this,a),this.addField_MFFloat(a,"keyValue",[])},{fieldChanged:function(a){if("set_fraction"===a){var b=this.linearInterp(this._vf.set_fraction,function(a,b,c){return(1-c)*a+c*b});this.postMessage("value_changed",b)}}})),x3dom.registerNodeType("CoordinateInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){if(x3dom.nodeTypes.CoordinateInterpolator.superClass.call(this,a),this.addField_MFVec3f(a,"keyValue",[]),a&&a.xmlNode.hasAttribute("keyValue")){this._vf.keyValue=[];for(var b=x3dom.fields.MFVec3f.parse(a.xmlNode.getAttribute("keyValue")),c=this._vf.key.length>0?this._vf.key.length:1,d=b.length/c,e=0;c>e;e++){for(var f=new x3dom.fields.MFVec3f,g=0;d>g;g++)f.push(b[e*d+g]);this._vf.keyValue.push(f)}}},{fieldChanged:function(a){if("set_fraction"===a){var b=this.linearInterp(this._vf.set_fraction,function(a,b,c){for(var d=new x3dom.fields.MFVec3f,e=0;e<a.length;e++)d.push(a[e].multiply(1-c).add(b[e].multiply(c)));return d});this.postMessage("value_changed",b)}}})),x3dom.registerNodeType("TimeSensor","Time",defineClass(x3dom.nodeTypes.X3DSensorNode,function(a){x3dom.nodeTypes.TimeSensor.superClass.call(this,a),a?a.doc._nodeBag.timer.push(this):x3dom.debug.logWarning("TimeSensor: No runtime context found!"),this.addField_SFTime(a,"cycleInterval",1),this.addField_SFBool(a,"enabled",!0),this.addField_SFBool(a,"loop",!1),this.addField_SFTime(a,"startTime",0),this.addField_SFTime(a,"stopTime",0),this.addField_SFTime(a,"pauseTime",0),this.addField_SFTime(a,"resumeTime",0),this.addField_SFTime(a,"cycleTime",0),this.addField_SFTime(a,"elapsedTime",0),this.addField_SFFloat(a,"fraction_changed",0),this.addField_SFBool(a,"isActive",!1),this.addField_SFBool(a,"isPaused",!1),this.addField_SFTime(a,"time",0),this.addField_SFBool(a,"first",!0),this.addField_SFFloat(a,"firstCycle",0),this._prevCycle=-1,this._lastTime=0,this._cycleStopTime=0,this._activatedTime=0,this._vf.startTime>0&&this._updateCycleStopTime(),this._backupStartTime=this._vf.startTime,this._backupStopTime=this._vf.stopTime,this._backupCycleInterval=this._vf.cycleInterval},{tick:function(a){if(!this._vf.enabled)return this._lastTime=a,!1;var b=this._vf.cycleInterval>0&&a>=this._vf.startTime&&(a<this._vf.stopTime||this._vf.stopTime<=this._vf.startTime)&&(1==this._vf.loop||0==this._vf.loop&&a<this._cycleStopTime);if(b&&!this._vf.isActive&&(this.postMessage("isActive",!0),this._activatedTime=a),b||this._vf.isActive){this.postMessage("elapsedTime",a-this._activatedTime);var c=a>=this._vf.pauseTime&&this._vf.pauseTime>this._vf.resumeTime;if(c&&!this._vf.isPaused?(this.postMessage("isPaused",!0),this.postMessage("pauseTime",a)):!c&&this._vf.isPaused&&(this.postMessage("isPaused",!1),this.postMessage("resumeTime",a)),!c){var d=this._getCycleAt(a),e=Math.floor(d),f=this._vf.startTime+e*this._vf.cycleInterval,g=0;this._vf.stopTime>this._vf.startTime&&this._lastTime<this._vf.stopTime&&a>=this._vf.stopTime?g=this._vf.stopTime:this._lastTime<f&&a>=f&&(g=f),g>0&&(a=g,d=this._getCycleAt(a),e=Math.floor(d));var h=d-e;h<x3dom.fields.Eps&&(h=this._lastTime<this._vf.startTime?0:1,this.postMessage("cycleTime",a)),this.postMessage("fraction_changed",h),this.postMessage("time",a)}}return!b&&this._vf.isActive&&this.postMessage("isActive",!1),this._lastTime=a,!0},fieldChanged:function(a){if("enabled"==a)!this._vf.enabled&&this._vf.isActive&&this.postMessage("isActive",!1);else if("startTime"==a){if(this._vf.isActive)return this._vf.startTime=this._backupStartTime,void 0;this._backupStartTime=this._vf.startTime,this._updateCycleStopTime()}else if("stopTime"==a){if(this._vf.isActive&&this._vf.stopTime<=this._vf.startTime)return this._vf.stopTime=this._backupStopTime,void 0;this._backupStopTime=this._vf.stopTime}else if("cycleInterval"==a){if(this._vf.isActive)return this._vf.cycleInterval=this._backupCycleInterval,void 0;this._backupCycleInterval=this._vf.cycleInterval,this._updateCycleStopTime()}else"loop"==a&&this._updateCycleStopTime()},parentRemoved:function(){if(0===this._parentNodes.length)for(var a=this.findX3DDoc(),b=0,c=a._nodeBag.timer.length;c>b;b++)a._nodeBag.timer[b]===this&&a._nodeBag.timer.splice(b,1)},_getCycleAt:function(a){return Math.max(0,a-this._vf.startTime)/this._vf.cycleInterval},_updateCycleStopTime:function(){if(0==this._vf.loop){var a=(new Date).getTime()/1e3,b=Math.floor(this._getCycleAt(a))+1;this._cycleStopTime=this._vf.startTime+b*this._vf.cycleInterval}else this._cycleStopTime=0}})),x3dom.registerNodeType("X3DTimeDependentNode","Time",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DTimeDependentNode.superClass.call(this,a),this.addField_SFBool(a,"loop",!1)})),x3dom.registerNodeType("Anchor","Networking",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Anchor.superClass.call(this,a),this.addField_MFString(a,"url",[]),this.addField_MFString(a,"parameter",[])},{doIntersect:function(a){for(var b=!1,c=0;c<this._childNodes.length;c++)this._childNodes[c]&&(b=this._childNodes[c].doIntersect(a)||b);return b},handleTouch:function(){var a=this._vf.url.length?this._vf.url[0]:"",b=a.search("#"),c="";b>=0&&(c=a.slice(b+1));var d=this._vf.parameter.length?this._vf.parameter[0]:"",e=d.search("target="),f="";e>=0&&(f=d.slice(e+7)),x3dom.debug.logInfo("Anchor url="+a+", target="+f+", #viewpoint="+c),0==f.length||"_blank"==f?window.open(this._nameSpace.getURL(a),f):window.location=this._nameSpace.getURL(a)}})),x3dom.registerNodeType("Inline","Networking",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Inline.superClass.call(this,a),this.addField_MFString(a,"url",[]),this.addField_SFBool(a,"load",!0),this.addField_MFString(a,"nameSpaceName",[]),this.addField_SFBool(a,"mapDEFToID",!1),this.count=0,this.numRetries=x3dom.nodeTypes.Inline.MaximumRetries},{fieldChanged:function(a){if("url"==a){if(0!=this._vf.nameSpaceName.length){var b=this._xmlNode;if(b&&b.hasChildNodes())for(;b.childNodes.length>=1;)b.removeChild(b.firstChild)}this.nodeChanged()}else"render"==a&&this.invalidateVolume()},fireEvents:function(a){if(this._xmlNode&&(this._xmlNode["on"+a]||this._xmlNode.hasAttribute("on"+a)||this._listeners[a])){var b={target:this._xmlNode,type:a,error:"error"==a?"XMLHttpRequest Error":"",cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0
}};try{var c=this._xmlNode["on"+a];if("function"==typeof c)c.call(this._xmlNode,b);else{var d=this._xmlNode.getAttribute("on"+a),e=new Function("event",d);e.call(this._xmlNode,b)}var f=this._listeners[a];if(f)for(var g=0;g<f.length;g++)f[g].call(this._xmlNode,b)}catch(h){x3dom.debug.logException(h)}}},nodeChanged:function(){var a=this,b=new window.XMLHttpRequest;if(b.overrideMimeType&&b.overrideMimeType("text/xml"),b.onreadystatechange=function(){if(4!=b.readyState)return b;if(b.status===x3dom.nodeTypes.Inline.AwaitTranscoding&&a.count<a.numRetries){a.count++;var c=+b.getResponseHeader("Refresh")||5;return x3dom.debug.logInfo("Statuscode "+b.status+" and send new request in "+c+" sec."),window.setTimeout(function(){a._nameSpace.doc.downloadCount-=1,a.nodeChanged()},1e3*c),b}if(200!==b.status&&0!==b.status)return a.fireEvents("error"),x3dom.debug.logError("XHR status: "+b.status+" - XMLHttpRequest requires web server running!"),a._nameSpace.doc.downloadCount-=1,a.count=0,b;(200==b.status||0==b.status)&&(a.count=0),x3dom.debug.logInfo("Inline: downloading "+a._vf.url[0]+" done.");var d=null,e=null,f=null,g=null;if(g="Microsoft Internet Explorer"!=navigator.appName?b.responseXML:(new DOMParser).parseFromString(b.responseText,"text/xml"),void 0!==g&&null!==g?d=g.getElementsByTagName("Scene")[0]||g.getElementsByTagName("scene")[0]:a.fireEvents("error"),d){var h=0!=a._vf.nameSpaceName.length?a._vf.nameSpaceName.toString().replace(" ",""):"";f=new x3dom.NodeNameSpace(h,a._nameSpace.doc);var i=a._vf.url.length?a._vf.url[0]:"";"/"===i[0]||i.indexOf(":")>=0?f.setBaseURL(i):f.setBaseURL(a._nameSpace.baseURL+i),e=f.setupTree(d),a._nameSpace.addSpace(f),0!=a._vf.nameSpaceName.length&&Array.forEach(d.childNodes,function(b){b instanceof Element&&(setNamespace(a._vf.nameSpaceName,b,a._vf.mapDEFToID),a._xmlNode.appendChild(b))})}else g&&g.localName?x3dom.debug.logError("No Scene in "+g.localName):x3dom.debug.logError("No Scene in resource");var j=x3dom.getGlobal();for(a._childNodes.length>0&&a._childNodes[0]&&a._childNodes[0]._nameSpace&&a._nameSpace.removeSpace(a._childNodes[0]._nameSpace);0!==a._childNodes.length;)j._remover=a.removeChild(a._childNodes[0]);if(delete j._remover,e){a.addChild(e),a.invalidateVolume(),a._nameSpace.doc.downloadCount-=1,a._nameSpace.doc.needRender=!0,x3dom.debug.logInfo("Inline: added "+a._vf.url[0]+" to scene.");var k=a._nameSpace.doc._scene;k&&(k.invalidateVolume(),window.setTimeout(function(){a.invalidateVolume(),k.updateVolume(),a._nameSpace.doc.needRender=!0},1e3)),a.fireEvents("load")}return e=null,f=null,d=null,g=null,b},this._vf.url.length&&this._vf.url[0].length){var c=this._nameSpace.getURL(this._vf.url[0]);"blob:"!==c.substr(0,5)&&(c=encodeURI(c)),b.open("GET",c,!0),this._nameSpace.doc.downloadCount+=1;try{b.send(null)}catch(d){this.fireEvents("error"),x3dom.debug.logError(this._vf.url[0]+": "+d)}}}})),x3dom.nodeTypes.Inline.AwaitTranscoding=202,x3dom.nodeTypes.Inline.MaximumRetries=15,x3dom.registerNodeType("X3DBackgroundNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(a){x3dom.nodeTypes.X3DBackgroundNode.superClass.call(this,a),this.addField_SFBool(a,"withCredentials",!1),this._dirty=!0},{getSkyColor:function(){return new x3dom.fields.SFColor(0,0,0)},getTransparency:function(){return 0},getTexUrl:function(){return[]}})),x3dom.registerNodeType("X3DFogNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(a){x3dom.nodeTypes.X3DFogNode.superClass.call(this,a)},{})),x3dom.registerNodeType("Fog","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DFogNode,function(a){x3dom.nodeTypes.Fog.superClass.call(this,a),this.addField_SFColor(a,"color",1,1,1),this.addField_SFString(a,"fogType","LINEAR"),this.addField_SFFloat(a,"visibilityRange",0)},{})),x3dom.registerNodeType("Background","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBackgroundNode,function(a){x3dom.nodeTypes.Background.superClass.call(this,a);var b=a&&a.autoGen?1:0;this.addField_MFColor(a,"skyColor",[new x3dom.fields.SFColor(0,0,0)]),this.addField_MFFloat(a,"skyAngle",[]),this.addField_MFColor(a,"groundColor",[]),this.addField_MFFloat(a,"groundAngle",[]),this.addField_SFFloat(a,"transparency",b),this.addField_MFString(a,"backUrl",[]),this.addField_MFString(a,"bottomUrl",[]),this.addField_MFString(a,"frontUrl",[]),this.addField_MFString(a,"leftUrl",[]),this.addField_MFString(a,"rightUrl",[]),this.addField_MFString(a,"topUrl",[])},{fieldChanged:function(a){a.indexOf("Url")>0||"transparency"==a||a.search("sky")>=0||a.search("ground")>=0?this._dirty=!0:a.indexOf("bind")>=0&&this.bind(this._vf.bind)},getSkyColor:function(){return this._vf.skyColor},getGroundColor:function(){return this._vf.groundColor},getTransparency:function(){return this._vf.transparency},getTexUrl:function(){return[this._nameSpace.getURL(this._vf.backUrl[0]),this._nameSpace.getURL(this._vf.frontUrl[0]),this._nameSpace.getURL(this._vf.bottomUrl[0]),this._nameSpace.getURL(this._vf.topUrl[0]),this._nameSpace.getURL(this._vf.leftUrl[0]),this._nameSpace.getURL(this._vf.rightUrl[0])]}})),x3dom.registerNodeType("X3DEnvironmentNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(a){x3dom.nodeTypes.X3DEnvironmentNode.superClass.call(this,a)})),x3dom.registerNodeType("Environment","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DEnvironmentNode,function(a){x3dom.nodeTypes.Environment.superClass.call(this,a),this.addField_SFBool(a,"sortTrans",!0),this.addField_SFBool(a,"shadowExcludeTransparentObjects",!1),this.addField_SFString(a,"gammaCorrectionDefault","linear"),this.addField_SFBool(a,"frustumCulling",!0),this.addField_SFBool(a,"smallFeatureCulling",!1),this.addField_SFFloat(a,"smallFeatureThreshold",1),this.addField_SFBool(a,"occlusionCulling",!1),this.addField_SFFloat(a,"occlusionVisibilityThreshold",0),this.addField_SFBool(a,"lowPriorityCulling",!1),this.addField_SFFloat(a,"lowPriorityThreshold",1),this.addField_SFBool(a,"tessellationDetailCulling",!1),this.addField_SFFloat(a,"tessellationErrorThreshold",0),this.addField_SFBool(a,"enableARC",!1),this.addField_SFFloat(a,"minFrameRate",1),this.addField_SFFloat(a,"maxFrameRate",62.5),this.addField_SFFloat(a,"userDataFactor",-1),this.addField_SFFloat(a,"smallFeatureFactor",-1),this.addField_SFFloat(a,"occlusionVisibilityFactor",-1),this.addField_SFFloat(a,"lowPriorityFactor",-1),this.addField_SFFloat(a,"tessellationErrorFactor",-1),this._validGammaCorrectionTypes=["none","fastlinear","linear"],this.checkSanity()},{checkSanity:function(){var a=function(a,b,c,d){return a&&b==d?c:a||b==d?b:d};this._smallFeatureThreshold=a(this._vf.smallFeatureCulling,this._vf.smallFeatureThreshold,10,0),this._lowPriorityThreshold=a(this._vf.lowPriorityCulling,this._vf.lowPriorityThreshold,.5,1),this._occlusionVisibilityThreshold=a(this._vf.occlusionCulling,this._vf.occlusionVisibilityThreshold,1,0),this._tessellationErrorThreshold=a(this._vf.tessellationDetailCulling,this._vf.tessellationErrorThreshold,1,0);var b=function(a,b){return a=a.toLowerCase(),b._validGammaCorrectionTypes.indexOf(a)>-1?a:(x3dom.debug.logWarning(a+" gammaCorrectionDefault may only be linear (default), fastLinear, or none"),"linear")};this._vf.gammaCorrectionDefault=b(this._vf.gammaCorrectionDefault,this)}})),x3dom.registerNodeType("X3DViewpointNode","Navigation",defineClass(x3dom.nodeTypes.X3DBindableNode,function(a){if(x3dom.nodeTypes.X3DViewpointNode.superClass.call(this,a),a&&a.xmlNode){var b=a.xmlNode;b.resetView||b.getFieldOfView||b.getNear||b.getFar||(b.resetView=function(){var a=this._x3domNode;a.resetView(),a._nameSpace.doc.needRender=!0},b.getFieldOfView=function(){return this._x3domNode.getFieldOfView()},b.getNear=function(){return this._x3domNode.getNear()},b.getFar=function(){return this._x3domNode.getFar()})}},{activate:function(a){var b=this._nameSpace.doc._viewarea;a&&b.animateTo(this,a._autoGen?null:a),b._needNavigationMatrixUpdate=!0,x3dom.nodeTypes.X3DBindableNode.prototype.activate.call(this,a)},deactivate:function(a){x3dom.nodeTypes.X3DBindableNode.prototype.deactivate.call(this,a)},getTransformation:function(){return this.getCurrentTransform()},getCenterOfRotation:function(){return new x3dom.fields.SFVec3f(0,0,0)},getFieldOfView:function(){return 1.57079633},setView:function(a){var b=this.getCurrentTransform();this._viewMatrix=a.mult(b)},resetView:function(){},getNear:function(){return.1},getFar:function(){return 1e4},getImgPlaneHeightAtDistOne:function(){return 2},getViewMatrix:function(){return null},getProjectionMatrix:function(){return null}})),x3dom.registerNodeType("Viewpoint","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(a){x3dom.nodeTypes.Viewpoint.superClass.call(this,a),this.addField_SFFloat(a,"fieldOfView",.785398),this.addField_SFVec3f(a,"position",0,0,10),this.addField_SFRotation(a,"orientation",0,0,0,1),this.addField_SFVec3f(a,"centerOfRotation",0,0,0),this.addField_SFFloat(a,"zNear",-1),this.addField_SFFloat(a,"zFar",-1),this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()).inverse(),this._projMatrix=null,this._lastAspect=1,this._zRatio=1e4,this._zNear=this._vf.zNear,this._zFar=this._vf.zFar,this._imgPlaneHeightAtDistOne=2*Math.tan(this._vf.fieldOfView/2)},{fieldChanged:function(a){"position"==a||"orientation"==a?this.resetView():"fieldOfView"==a||"zNear"==a||"zFar"==a?(this._projMatrix=null,this._zNear=this._vf.zNear,this._zFar=this._vf.zFar,this._imgPlaneHeightAtDistOne=2*Math.tan(this._vf.fieldOfView/2)):a.indexOf("bind")>=0&&this.bind(this._vf.bind)},getCenterOfRotation:function(){return this._vf.centerOfRotation},getViewMatrix:function(){return this._viewMatrix},getFieldOfView:function(){return this._vf.fieldOfView},resetView:function(){this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()).inverse()},getNear:function(){return this._zNear},getFar:function(){return this._zFar},getImgPlaneHeightAtDistOne:function(){return this._imgPlaneHeightAtDistOne},getProjectionMatrix:function(a){var b=this._vf.fieldOfView,c=this._vf.zFar,d=this._vf.zNear;if(0>=d||0>=c){var e=.8,f=1.2,g=this._nameSpace.doc._viewarea,h=g._scene,i=x3dom.fields.SFVec3f.copy(h._lastMin),j=x3dom.fields.SFVec3f.copy(h._lastMax),k=j.subtract(i),l=k.length()/2,m=g.getViewMatrix().inverse(),n=m.e3(),o=new x3dom.fields.SFVec3f(0,0,0),p=new x3dom.fields.SFVec3f(1,1,1),q=new x3dom.fields.Quaternion(0,0,1,0),r=new x3dom.fields.Quaternion(0,0,1,0);m.getTransform(o,q,p,r);var s=p.x,t=p.x;t<p.y&&(t=p.y),s>p.y&&(s=p.y),t<p.z&&(t=p.z),s>p.z&&(s=p.z),t>1?e/=t:s>x3dom.fields.Eps&&1>s&&(f/=s);var u=i.add(k.multiply(.5)),v=n.subtract(u).length();l?(d=v>l?(v-l)*e:0,c=(v+l)*f):(d=.1,c=1e5);var w=c/this._zRatio;d=Math.max(d,Math.max(x3dom.fields.Eps,w)),c>this._vf.zNear&&this._vf.zNear>0&&(d=this._vf.zNear),this._vf.zFar>d&&(c=this._vf.zFar),d>=c&&(c=d+1)}if(null==this._projMatrix)this._projMatrix=x3dom.fields.SFMatrix4f.perspective(b,a,d,c);else if(this._zNear!=d||this._zFar!=c){var x=d-c;this._projMatrix._22=(d+c)/x,this._projMatrix._23=2*d*c/x}else this._lastAspect!=a&&(this._projMatrix._00=1/Math.tan(b/2)/a);return this._zNear=d,this._zFar=c,this._lastAspect=a,this._projMatrix}})),x3dom.registerNodeType("OrthoViewpoint","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(a){x3dom.nodeTypes.OrthoViewpoint.superClass.call(this,a),this.addField_MFFloat(a,"fieldOfView",[-1,-1,1,1]),this.addField_SFVec3f(a,"position",0,0,10),this.addField_SFRotation(a,"orientation",0,0,0,1),this.addField_SFVec3f(a,"centerOfRotation",0,0,0),this.addField_SFFloat(a,"zNear",.1),this.addField_SFFloat(a,"zFar",1e4),this._viewMatrix=null,this._projMatrix=null,this._lastAspect=1,this.resetView()},{fieldChanged:function(a){"position"==a||"orientation"==a?this.resetView():"fieldOfView"==a||"zNear"==a||"zFar"==a?(this._projMatrix=null,this.resetView()):a.indexOf("bind")>=0&&this.bind(this._vf.bind)},getCenterOfRotation:function(){return this._vf.centerOfRotation},getViewMatrix:function(){return this._viewMatrix},resetView:function(){var a=x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f((this._vf.fieldOfView[0]+this._vf.fieldOfView[2])/2,(this._vf.fieldOfView[1]+this._vf.fieldOfView[3])/2,0));this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()),this._viewMatrix=this._viewMatrix.mult(a).inverse()},getNear:function(){return this._vf.zNear},getFar:function(){return this._vf.zFar},getProjectionMatrix:function(a){if(null==this._projMatrix||this._lastAspect!=a){var b=this.getNear(),c=this.getFar(),d=this._vf.fieldOfView[0],e=this._vf.fieldOfView[1],f=this._vf.fieldOfView[2],g=this._vf.fieldOfView[3];this._projMatrix=x3dom.fields.SFMatrix4f.ortho(d,f,e,g,b,c,a)}return this._lastAspect=a,this._projMatrix}})),x3dom.registerNodeType("Viewfrustum","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(a){x3dom.nodeTypes.Viewfrustum.superClass.call(this,a),this.addField_SFMatrix4f(a,"modelview",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this.addField_SFMatrix4f(a,"projection",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._viewMatrix=this._vf.modelview.transpose().inverse(),this._projMatrix=this._vf.projection.transpose(),this._centerOfRotation=new x3dom.fields.SFVec3f(0,0,0)},{fieldChanged:function(a){"modelview"==a?this.resetView():"projection"==a?this._projMatrix=this._vf.projection.transpose():a.indexOf("bind")>=0&&this.bind(this._vf.bind)},getCenterOfRotation:function(){return this._centerOfRotation},getViewMatrix:function(){return this._viewMatrix},getFieldOfView:function(){return 2*Math.atan(1/this._projMatrix._11)},getImgPlaneHeightAtDistOne:function(){return 2/this._projMatrix._11},resetView:function(){this._viewMatrix=this._vf.modelview.transpose().inverse(),this._centerOfRotation=new x3dom.fields.SFVec3f(0,0,0)},getProjectionMatrix:function(){return this._projMatrix}})),x3dom.registerNodeType("X3DNavigationInfoNode","Navigation",defineClass(x3dom.nodeTypes.X3DBindableNode,function(a){x3dom.nodeTypes.X3DNavigationInfoNode.superClass.call(this,a)})),x3dom.registerNodeType("NavigationInfo","Navigation",defineClass(x3dom.nodeTypes.X3DNavigationInfoNode,function(a){x3dom.nodeTypes.NavigationInfo.superClass.call(this,a),this.addField_SFBool(a,"headlight",!0),this.addField_MFString(a,"type",["EXAMINE","ANY"]),this.addField_MFFloat(a,"typeParams",[-.4,60,.05,2.8]),this.addField_SFString(a,"explorationMode","all"),this.addField_MFFloat(a,"avatarSize",[.25,1.6,.75]),this.addField_SFFloat(a,"visibilityLimit",0),this.addField_SFFloat(a,"speed",1),this.addField_SFTime(a,"transitionTime",1),this.addField_MFString(a,"transitionType",["LINEAR"]),this._validTypes=["none","examine","turntable","fly","freefly","lookat","lookaround","walk","game","helicopter","any"],this._heliUpdated=!1;var b=this.checkType(this.getType());x3dom.debug.logInfo("NavType: "+b)},{fieldChanged:function(a){if("typeParams"==a)this._heliUpdated=!1;else if("type"==a){var b=this.checkType(this.getType());switch(b){case"game":this._nameSpace.doc._viewarea.initMouseState();break;case"helicopter":this._heliUpdated=!1}this._vf.type[0]=b,x3dom.debug.logInfo("Switch to "+b+" mode.")}},setType:function(a,b){var c=this.checkType(a.toLowerCase()),d=this.checkType(this.getType());switch(c){case"game":d!==c&&(b?b.initMouseState():this._nameSpace.doc._viewarea.initMouseState());break;case"helicopter":d!==c&&(this._heliUpdated=!1)}this._vf.type[0]=c,x3dom.debug.logInfo("Switch to "+c+" mode.")},getType:function(){var a=this._vf.type[0].toLowerCase();return a.length<=1?a="none":"any"==a&&(a="examine"),a},getTypeParams:function(){var a=this._vf.typeParams.length,b=a>=1?this._vf.typeParams[0]:-.4,c=a>=2?this._vf.typeParams[1]:60,d=a>=3?this._vf.typeParams[2]:x3dom.fields.Eps,e=a>=4?this._vf.typeParams[3]:Math.PI-x3dom.fields.Eps;return[b,c,d,e]},setTypeParams:function(a){for(var b=0;b<a.length;b++)this._vf.typeParams[b]=a[b]},checkType:function(a){return this._validTypes.indexOf(a)>-1?a:(x3dom.debug.logWarning(a+" is no valid navigation type, use one of "+this._validTypes.toString()),"examine")},getExplorationMode:function(){switch(this._vf.explorationMode.toLowerCase()){case"all":return 7;case"rotate":return 1;case"zoom":return 2;case"pan":return 4;case"none":return 0;default:return 7}}})),x3dom.registerNodeType("Billboard","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Billboard.superClass.call(this,a),this.addField_SFVec3f(a,"axisOfRotation",0,1,0),this._eye=new x3dom.fields.SFVec3f(0,0,0),this._eyeViewUp=new x3dom.fields.SFVec3f(0,0,0),this._eyeLook=new x3dom.fields.SFVec3f(0,0,0)},{collectDrawableObjects:function(a,b,c,d,e){if(c&&this._parentNodes.length>1&&(c=!1),c&&(d=d||this.cacheInvalid())&&this.invalidateCache(),e=b.cull(a,this.graphState(),c,e),!(0>=e)){c=!1;var f=this.getVolume(),g=x3dom.fields.SFVec3f.MAX(),h=x3dom.fields.SFVec3f.MIN();f.getBounds(g,h);var i=b.viewMatrix,j=new x3dom.fields.SFVec3f(0,0,0);j=i.inverse().multMatrixPnt(j);var k=i.mult(a);this._eye=a.inverse().multMatrixPnt(j),this._eyeViewUp=new x3dom.fields.SFVec3f(k._10,k._11,k._12),this._eyeLook=new x3dom.fields.SFVec3f(k._20,k._21,k._22);var l=x3dom.fields.SFMatrix4f.identity(),m=h.add(g).multiply(.5),n=this._eye.subtract(m);if(this._vf.axisOfRotation.equals(new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.Eps)){var o=x3dom.fields.Quaternion.rotateFromTo(n,new x3dom.fields.SFVec3f(0,0,1));l=o.toMatrix().transpose();var p=l.multMatrixPnt(new x3dom.fields.SFVec3f(0,1,0)).normalize(),q=l.multMatrixPnt(new x3dom.fields.SFVec3f(0,0,1)).normalize();if(!this._eyeViewUp.equals(new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.Eps)){var r=x3dom.fields.Quaternion.rotateFromTo(this._eyeLook,q),s=r.toMatrix().transpose().multMatrixVec(p),t=x3dom.fields.Quaternion.rotateFromTo(this._eyeViewUp,s);l=r.toMatrix().transpose().mult(l),l=t.toMatrix().transpose().mult(l)}}else{var u=this._vf.axisOfRotation.cross(n).normalize();this._eye.z<0&&(u=u.multiply(-1));var v=Math.asin(u.dot(new x3dom.fields.SFVec3f(0,0,1)));this._eye.z<0&&(v+=Math.PI),l=x3dom.fields.SFMatrix4f.parseRotation(this._vf.axisOfRotation.x+", "+this._vf.axisOfRotation.y+", "+this._vf.axisOfRotation.z+", "+-1*v)}for(var w=this.transformMatrix(a.mult(l)),x=0,y=this._childNodes.length;y>x;x++){var z=this._childNodes[x];z&&z.collectDrawableObjects(w,b,c,d,e)}}}})),x3dom.registerNodeType("Collision","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Collision.superClass.call(this,a),this.addField_SFBool(a,"enabled",!0),this.addField_SFNode("proxy",x3dom.nodeTypes.X3DGroupingNode)},{collectDrawableObjects:function(a,b,c,d,e){if(c&&this._parentNodes.length>1&&(c=!1),c&&(d=d||this.cacheInvalid())&&this.invalidateCache(),e=b.cull(a,this.graphState(),c,e),!(0>=e)){var f,g;c?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(a)),g=this._graph.globalMatrix):g=this.transformMatrix(a);for(var h=0,i=this._childNodes.length;i>h;h++)(f=this._childNodes[h])&&f!==this._cf.proxy.node&&f.collectDrawableObjects(g,b,c,d,e)}}})),x3dom.registerNodeType("X3DLODNode","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.X3DLODNode.superClass.call(this,a),this.addField_SFBool(a,"forceTransitions",!1),this.addField_SFVec3f(a,"center",0,0,0),this._eye=new x3dom.fields.SFVec3f(0,0,0)},{collectDrawableObjects:function(a,b,c,d,e){c&&this._parentNodes.length>1&&(c=!1),c&&(d=d||this.cacheInvalid())&&this.invalidateCache(),e=b.cull(a,this.graphState(),c,e),0>=e||(c=!1,this.visitChildren(a,b,c,d,e))},visitChildren:function(){}})),x3dom.registerNodeType("LOD","Navigation",defineClass(x3dom.nodeTypes.X3DLODNode,function(a){x3dom.nodeTypes.LOD.superClass.call(this,a),this.addField_MFFloat(a,"range",[]),this._lastRangePos=-1},{visitChildren:function(a,b,c,d,e){var f=0,g=this._childNodes.length,h=this.getVolume(),i=x3dom.fields.SFVec3f.MAX(),j=x3dom.fields.SFVec3f.MIN();h.getBounds(i,j);var k=b.viewMatrix,l=new x3dom.fields.SFVec3f(0,0,0);l=k.inverse().multMatrixPnt(l),this._eye=a.inverse().multMatrixPnt(l);for(var m=j.add(i).multiply(.5).add(this._vf.center),n=m.subtract(this._eye).length();f<this._vf.range.length&&n>this._vf.range[f];)f++;f&&f>=g&&(f=g-1),this._lastRangePos=f;var o=this._childNodes[f];if(g&&o){var p=this.transformMatrix(a);o.collectDrawableObjects(p,b,c,d,e)}},getVolume:function(){var a=this._graph.volume;if(!this.volumeValid()&&this._vf.render){var b,c;if(this._lastRangePos>=0)b=this._childNodes[this._lastRangePos],c=b&&b._vf.render===!0?b.getVolume():null,c&&c.isValid()&&a.extendBounds(c.min,c.max);else for(var d=0,e=this._childNodes.length;e>d;d++)(b=this._childNodes[d])&&b._vf.render===!0&&(c=b.getVolume(),c&&c.isValid()&&a.extendBounds(c.min,c.max))}return a},nodeChanged:function(){this.invalidateVolume()},fieldChanged:function(a){("render"==a||"center"==a||"range"==a)&&this.invalidateVolume()}})),x3dom.registerNodeType("DynamicLOD","Navigation",defineClass(x3dom.nodeTypes.X3DLODNode,function(a){x3dom.nodeTypes.DynamicLOD.superClass.call(this,a),this.addField_SFFloat(a,"subScale",.5),this.addField_SFVec2f(a,"size",2,2),this.addField_SFVec2f(a,"subdivision",1,1),this.addField_SFNode("root",x3dom.nodeTypes.X3DShapeNode),this.addField_SFString(a,"urlHead","http://r"),this.addField_SFString(a,"urlCenter",".ortho.tiles.virtualearth.net/tiles/h"),this.addField_SFString(a,"urlTail",".png?g=-1"),this.rootGeometry=new x3dom.nodeTypes.Plane(a),this.level=0,this.quadrant=4,this.cell=""},{nodeChanged:function(){var a=this._cf.root.node;null!=a&&null==a._cf.geometry.node&&(this.rootGeometry._vf.size.setValues(this._vf.size),this.rootGeometry._vf.subdivision.setValues(this._vf.subdivision),this.rootGeometry._vf.center.setValues(this._vf.center),this.rootGeometry.fieldChanged("subdivision"),this._cf.root.node.addChild(this.rootGeometry),this.rootGeometry.nodeChanged(),this._cf.root.node.nodeChanged(),this._nameSpace.doc.needRender=!0)},visitChildren:function(a,b,c,d,e){var f=this._cf.root.node;if(null!=f){var g=b.viewMatrix,h=new x3dom.fields.SFVec3f(0,0,0);h=g.inverse().multMatrixPnt(h),this._eye=a.inverse().multMatrixPnt(h);var i,j=this._vf.center.subtract(this._eye).length();if(j>x3dom.fields.Eps&&j*this._vf.subScale<=this._vf.size.length())if(this._childNodes.length<=1){var k=new Array(new x3dom.fields.SFVec3f(-.25*this._vf.size.x,.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(.25*this._vf.size.x,.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(-.25*this._vf.size.x,-.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(.25*this._vf.size.x,-.25*this._vf.size.y,0));for(i=0;4>i;i++){var l=new x3dom.nodeTypes.DynamicLOD;l._nameSpace=this._nameSpace,l._eye.setValues(this._eye),l.level=this.level+1,l.quadrant=i,l.cell=this.cell+i,l._vf.urlHead=this._vf.urlHead,l._vf.urlCenter=this._vf.urlCenter,l._vf.urlTail=this._vf.urlTail,l._vf.center=this._vf.center.add(k[i]),l._vf.size=this._vf.size.multiply(.5),l._vf.subdivision.setValues(this._vf.subdivision);var m=new x3dom.nodeTypes.Appearance,n=new x3dom.nodeTypes.ImageTexture;n._nameSpace=this._nameSpace,n._vf.url[0]=this._vf.urlHead+l.quadrant+this._vf.urlCenter+l.cell+this._vf.urlTail,m.addChild(n),n.nodeChanged();var o=new x3dom.nodeTypes.Shape;o._nameSpace=this._nameSpace,o.addChild(m),m.nodeChanged(),l.addChild(o,"root"),o.nodeChanged(),this.addChild(l),l.nodeChanged()}}else for(i=1;i<this._childNodes.length;i++)this._childNodes[i].collectDrawableObjects(a,b,c,d,e);else f.collectDrawableObjects(a,b,c,d,e)}},getVolume:function(){var a=this._graph.volume;return a.isValid()||(a.min.setValues(this._vf.center),a.min.x-=.5*this._vf.size.x,a.min.y-=.5*this._vf.size.y,a.min.z-=x3dom.fields.Eps,a.max.setValues(this._vf.center),a.max.x+=.5*this._vf.size.x,a.max.y+=.5*this._vf.size.y,a.max.z+=x3dom.fields.Eps),a}})),x3dom.registerNodeType("X3DFontStyleNode","Text",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DFontStyleNode.superClass.call(this,a)})),x3dom.registerNodeType("FontStyle","Text",defineClass(x3dom.nodeTypes.X3DFontStyleNode,function(a){x3dom.nodeTypes.FontStyle.superClass.call(this,a),this.addField_MFString(a,"family",["SERIF"]),this.addField_SFBool(a,"horizontal",!0),this.addField_MFString(a,"justify",["BEGIN"]),this.addField_SFString(a,"language",""),this.addField_SFBool(a,"leftToRight",!0),this.addField_SFFloat(a,"size",1),this.addField_SFFloat(a,"spacing",1),this.addField_SFString(a,"style","PLAIN"),this.addField_SFBool(a,"topToBottom",!0)},{fieldChanged:function(a){("family"==a||"horizontal"==a||"justify"==a||"language"==a||"leftToRight"==a||"size"==a||"spacing"==a||"style"==a||"topToBottom"==a)&&Array.forEach(this._parentNodes,function(b){b.fieldChanged(a)})}})),x3dom.nodeTypes.FontStyle.defaultNode=function(){return x3dom.nodeTypes.FontStyle._defaultNode||(x3dom.nodeTypes.FontStyle._defaultNode=new x3dom.nodeTypes.FontStyle,x3dom.nodeTypes.FontStyle._defaultNode.nodeChanged()),x3dom.nodeTypes.FontStyle._defaultNode},x3dom.registerNodeType("Text","Text",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.Text.superClass.call(this,a),this.addField_MFString(a,"string",[]),this.addField_MFFloat(a,"length",[]),this.addField_SFFloat(a,"maxExtent",0),this.addField_SFNode("fontStyle",x3dom.nodeTypes.X3DFontStyleNode),this._mesh._positions[0]=[],this._mesh._normals[0]=[0,0,1,0,0,1,0,0,1,0,0,1],this._mesh._texCoords[0]=[0,0,1,0,1,1,0,1],this._mesh._colors[0]=[],this._mesh._indices[0]=[0,1,2,2,3,0],this._mesh._invalidate=!0,this._mesh._numFaces=2,this._mesh._numCoords=4},{nodeChanged:function(){this._cf.fontStyle.node||this.addChild(x3dom.nodeTypes.FontStyle.defaultNode()),this.invalidateVolume()},fieldChanged:function(a){("string"==a||"length"==a||"maxExtent"==a)&&(this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a.setAllDirty()}))}})),x3dom.registerNodeType("X3DSoundNode","Sound",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DSoundNode.superClass.call(this,a)})),x3dom.registerNodeType("Sound","Sound",defineClass(x3dom.nodeTypes.X3DSoundNode,function(a){x3dom.nodeTypes.Sound.superClass.call(this,a),this.addField_SFNode("source",x3dom.nodeTypes.X3DSoundSourceNode)},{nodeChanged:function(){if(!this._cf.source.node&&this._xmlNode){x3dom.debug.logInfo("No AudioClip child node given, searching for &lt;audio&gt; elements...");try{Array.forEach(this._xmlNode.childNodes,function(a){if(1===a.nodeType&&(x3dom.debug.logInfo("### Found &lt;"+a.nodeName+"&gt; tag."),"audio"===a.localName.toLowerCase())){var b=a.getAttribute("loop");b=b?"loop"===b.toLowerCase():!1;var c=a.cloneNode(!1);a.parentNode.removeChild(a),a=null,"Microsoft Internet Explorer"!=navigator.appName&&document.body.appendChild(c);var d=function(){c.play()},e=function(){b&&c.play()};c.addEventListener("canplaythrough",d,!0),c.addEventListener("ended",e,!0)}})}catch(a){x3dom.debug.logException(a)}}}})),x3dom.registerNodeType("X3DSoundSourceNode","Sound",defineClass(x3dom.nodeTypes.X3DTimeDependentNode,function(a){x3dom.nodeTypes.X3DSoundSourceNode.superClass.call(this,a)})),x3dom.registerNodeType("AudioClip","Sound",defineClass(x3dom.nodeTypes.X3DSoundSourceNode,function(a){x3dom.nodeTypes.AudioClip.superClass.call(this,a),this.addField_MFString(a,"url",[]),this.addField_SFBool(a,"enabled",!0),this.addField_SFBool(a,"loop",!1),this._audio=null},{nodeChanged:function(){this._audio=document.createElement("audio"),this._audio.setAttribute("autobuffer","true"),"Microsoft Internet Explorer"!=navigator.appName&&document.body.appendChild(this._audio);for(var a=0;a<this._vf.url.length;a++){var b=this._nameSpace.getURL(this._vf.url[a]);x3dom.debug.logInfo("Adding sound file: "+b);var c=document.createElement("source");c.setAttribute("src",b),this._audio.appendChild(c)}var d=this,e=function(){d._audio.play()},f=function(){d._vf.loop===!0&&d._audio.play()};this._audio.addEventListener("canplaythrough",e,!0),this._audio.addEventListener("ended",f,!0)},fieldChanged:function(a){if("enabled"===a)this._vf.enabled===!0?this._audio.play():this._audio.pause();else if("loop"===a)this._vf.loop===!0&&this._audio.play();else if("url"===a){for(this._audio.pause();this._audio.hasChildNodes();)this._audio.removeChild(this._audio.firstChild);for(var b=0;b<this._vf.url.length;b++){var c=this._nameSpace.getURL(this._vf.url[b]);x3dom.debug.logInfo("Adding sound file: "+c);var d=document.createElement("source");d.setAttribute("src",c),this._audio.appendChild(d)}}}})),x3dom.registerNodeType("X3DTextureTransformNode","Texturing",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.X3DTextureTransformNode.superClass.call(this,a)})),x3dom.registerNodeType("TextureTransform","Texturing",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(a){x3dom.nodeTypes.TextureTransform.superClass.call(this,a),this.addField_SFVec2f(a,"center",0,0),this.addField_SFFloat(a,"rotation",0),this.addField_SFVec2f(a,"scale",1,1),this.addField_SFVec2f(a,"translation",0,0);var b=new x3dom.fields.SFVec3f(-this._vf.center.x,-this._vf.center.y,1),c=new x3dom.fields.SFVec3f(this._vf.center.x,this._vf.center.y,0),d=new x3dom.fields.SFVec3f(this._vf.translation.x,this._vf.translation.y,0),e=new x3dom.fields.SFVec3f(this._vf.scale.x,this._vf.scale.y,0);this._trafo=x3dom.fields.SFMatrix4f.translation(b).mult(x3dom.fields.SFMatrix4f.scale(e)).mult(x3dom.fields.SFMatrix4f.rotationZ(this._vf.rotation)).mult(x3dom.fields.SFMatrix4f.translation(c.add(d)))},{fieldChanged:function(a){if("center"==a||"rotation"==a||"scale"==a||"translation"==a){var b=new x3dom.fields.SFVec3f(-this._vf.center.x,-this._vf.center.y,1),c=new x3dom.fields.SFVec3f(this._vf.center.x,this._vf.center.y,0),d=new x3dom.fields.SFVec3f(this._vf.translation.x,this._vf.translation.y,0),e=new x3dom.fields.SFVec3f(this._vf.scale.x,this._vf.scale.y,0);this._trafo=x3dom.fields.SFMatrix4f.translation(b).mult(x3dom.fields.SFMatrix4f.scale(e)).mult(x3dom.fields.SFMatrix4f.rotationZ(this._vf.rotation)).mult(x3dom.fields.SFMatrix4f.translation(c.add(d)))}},texTransformMatrix:function(){return this._trafo}})),x3dom.registerNodeType("TextureProperties","Texturing",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.TextureProperties.superClass.call(this,a),this.addField_SFFloat(a,"anisotropicDegree",1),this.addField_SFColorRGBA(a,"borderColor",0,0,0,0),this.addField_SFInt32(a,"borderWidth",0),this.addField_SFString(a,"boundaryModeS","REPEAT"),this.addField_SFString(a,"boundaryModeT","REPEAT"),this.addField_SFString(a,"boundaryModeR","REPEAT"),this.addField_SFString(a,"magnificationFilter","FASTEST"),this.addField_SFString(a,"minificationFilter","FASTEST"),this.addField_SFString(a,"textureCompression","FASTEST"),this.addField_SFFloat(a,"texturePriority",0),this.addField_SFBool(a,"generateMipMaps",!1)},{fieldChanged:function(a){this._vf.hasOwnProperty(a)&&(Array.forEach(this._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){a._dirty.texture=!0})})}),this._nameSpace.doc.needRender=!0)}})),x3dom.registerNodeType("X3DTextureNode","Texturing",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.X3DTextureNode.superClass.call(this,a),this.addField_SFInt32(a,"origChannelCount",0),this.addField_MFString(a,"url",[]),this.addField_SFBool(a,"repeatS",!0),this.addField_SFBool(a,"repeatT",!0),this.addField_SFBool(a,"scale",!0),this.addField_SFBool(a,"withCredentials",!1),this.addField_SFNode("textureProperties",x3dom.nodeTypes.TextureProperties),this._needPerFrameUpdate=!1,this._isCanvas=!1,this._type="diffuseMap",this._blending=1==this._vf.origChannelCount||2==this._vf.origChannelCount},{invalidateGLObject:function(){Array.forEach(this._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){a._dirty.texture=!0})}),this._nameSpace.doc.needRender=!0},parentAdded:function(a){Array.forEach(a._parentNodes,function(a){a._dirty.texture=!0})},parentRemoved:function(a){Array.forEach(a._parentNodes,function(a){a._dirty.texture=!0
})},fieldChanged:function(a){if("url"==a||"origChannelCount"==a||"repeatS"==a||"repeatT"==a||"scale"==a||"withCredentials"==a){var b=this;Array.forEach(this._parentNodes,function(a){if(x3dom.isa(a,x3dom.nodeTypes.X3DAppearanceNode))a.nodeChanged(),Array.forEach(a._parentNodes,function(a){a._dirty.texture=!0});else if(x3dom.isa(a,x3dom.nodeTypes.ImageGeometry)){var c=null;b._xmlNode&&b._xmlNode.hasAttribute("containerField")&&(c=b._xmlNode.getAttribute("containerField"),a._dirty[c]=!0)}})}},getTexture:function(a){return 0===a?this:null},size:function(){return 1}})),x3dom.registerNodeType("MultiTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.MultiTexture.superClass.call(this,a),this.addField_MFNode("texture",x3dom.nodeTypes.X3DTextureNode)},{getTexture:function(a){return a>=0&&a<this._cf.texture.nodes.length?this._cf.texture.nodes[a]:null},getTextures:function(){return this._cf.texture.nodes},size:function(){return this._cf.texture.nodes.length}})),x3dom.registerNodeType("Texture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.Texture.superClass.call(this,a),this.addField_SFBool(a,"hideChildren",!0),this._video=null,this._intervalID=0,this._canvas=null},{nodeChanged:function(){if(!this._vf.url.length&&this._xmlNode){x3dom.debug.logInfo("No Texture URL given, searching for &lt;img&gt; elements...");var a=this;try{Array.forEach(this._xmlNode.childNodes,function(b){if(1===b.nodeType){var c=b.getAttribute("src");if(c){if(a._vf.url.push(c),x3dom.debug.logInfo(a._vf.url[a._vf.url.length-1]),"video"===b.localName){a._needPerFrameUpdate=!0,a._video=document.createElement("video"),a._video.setAttribute("autobuffer","true");var d=document.getElementsByTagName("body")[0];d.appendChild(a._video),a._video.style.display="none"}}else"canvas"===b.localName.toLowerCase()&&(a._needPerFrameUpdate=!0,a._isCanvas=!0,a._canvas=b);b.style&&a._vf.hideChildren&&(b.style.display="none",b.style.visibility="hidden"),x3dom.debug.logInfo("### Found &lt;"+b.nodeName+"&gt; tag.")}})}catch(b){x3dom.debug.logException(b)}}}})),x3dom.registerNodeType("RenderedTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.RenderedTexture.superClass.call(this,a),a?a.doc._nodeBag.renderTextures.push(this):x3dom.debug.logWarning("RenderedTexture: No runtime context found!"),this.addField_SFNode("viewpoint",x3dom.nodeTypes.X3DViewpointNode),this.addField_SFNode("background",x3dom.nodeTypes.X3DBackgroundNode),this.addField_SFNode("fog",x3dom.nodeTypes.X3DFogNode),this.addField_SFNode("scene",x3dom.nodeTypes.X3DNode),this.addField_MFNode("excludeNodes",x3dom.nodeTypes.X3DNode),this.addField_MFInt32(a,"dimensions",[128,128,4]),this.addField_SFString(a,"update","NONE"),this.addField_SFBool(a,"showNormals",!1),this.addField_SFString(a,"stereoMode","NONE"),this.addField_SFFloat(a,"interpupillaryDistance",.064),this.hScreenSize=.14976,this.vScreenSize=.09356,this.vScreenCenter=this.vScreenSize/2,this.eyeToScreenDistance=.041,this.lensSeparationDistance=.0635,this.distortionK=[1,.22,.24,0],this.lensCenter=1-2*this.lensSeparationDistance/this.hScreenSize,x3dom.debug.assert(this._vf.dimensions.length>=3),this._clearParents=!0,this._needRenderUpdate=!0},{nodeChanged:function(){this._clearParents=!0,this._needRenderUpdate=!0},fieldChanged:function(a){switch(a){case"excludeNodes":this._clearParents=!0;break;case"update":("NEXT_FRAME_ONLY"==this._vf.update.toUpperCase()||"ALWAYS"==this._vf.update.toUpperCase())&&(this._needRenderUpdate=!0)}},getViewMatrix:function(){if(this._clearParents&&this._cf.excludeNodes.nodes.length){var a=this;Array.forEach(this._cf.excludeNodes.nodes,function(b){for(var c=0,d=b._parentNodes.length;d>c;c++)b._parentNodes[c]===a&&(b._parentNodes.splice(c,1),b.parentRemoved(a))}),this._clearParents=!1}var b=this._nameSpace.doc._scene.getViewpoint(),c=this._cf.viewpoint.node,d=null;if(null===c||c===b)d=this._nameSpace.doc._viewarea.getViewMatrix();else{var e=c.getCurrentTransform();d=e.mult(c.getViewMatrix())}var f=this._vf.stereoMode.toUpperCase();if("NONE"!=f){var g=this._vf.interpupillaryDistance/2;"RIGHT_EYE"==f&&(g=-g);var h=new x3dom.fields.SFMatrix4f(1,0,0,g,0,1,0,0,0,0,1,0,0,0,0,1);d=h.mult(d)}return d},getProjectionMatrix:function(){var a,b=this._nameSpace.doc,c=b._scene.getViewpoint(),d=this._cf.viewpoint.node,e=null,f=this._vf.dimensions[0],g=this._vf.dimensions[1],h=this._vf.stereoMode.toUpperCase(),i="NONE"!=h;if(null===d||d===c?(e=x3dom.fields.SFMatrix4f.copy(b._viewarea.getProjectionMatrix()),i?(a=2*Math.atan(this.vScreenSize/(2*this.eyeToScreenDistance)),a=1/Math.tan(a/2)):a=1/Math.tan(c._vf.fieldOfView/2),e._00=a/(f/g),e._11=a):e=d.getProjectionMatrix(f/g),i){var j=this.lensCenter;"RIGHT_EYE"==h&&(j=-j);var k=new x3dom.fields.SFMatrix4f(1,0,0,j,0,1,0,0,0,0,1,0,0,0,0,1);e=k.mult(e)}return e},getWCtoCCMatrix:function(){var a=this.getViewMatrix(),b=this.getProjectionMatrix();return b.mult(a)},parentRemoved:function(){if(0===this._parentNodes.length)for(var a=this.findX3DDoc(),b=0,c=a._nodeBag.renderTextures.length;c>b;b++)a._nodeBag.renderTextures[b]===this&&a._nodeBag.renderTextures.splice(b,1);this._cf.scene.node&&this._cf.scene.node.parentRemoved(this)}})),x3dom.registerNodeType("PixelTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.PixelTexture.superClass.call(this,a),this.addField_SFImage(a,"image",0,0,0)},{fieldChanged:function(a){"image"==a&&this.invalidateGLObject()}})),x3dom.registerNodeType("ImageTexture","Texturing",defineClass(x3dom.nodeTypes.Texture,function(a){x3dom.nodeTypes.ImageTexture.superClass.call(this,a)})),x3dom.registerNodeType("MovieTexture","Texturing",defineClass(x3dom.nodeTypes.Texture,function(a){x3dom.nodeTypes.MovieTexture.superClass.call(this,a),this.addField_SFBool(a,"loop",!1),this.addField_SFFloat(a,"speed",1),this.addField_SFTime(a,"pauseTime",0),this.addField_SFFloat(a,"pitch",1),this.addField_SFTime(a,"resumeTime",0),this.addField_SFTime(a,"startTime",0),this.addField_SFTime(a,"stopTime",0)})),x3dom.registerNodeType("X3DEnvironmentTextureNode","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.X3DEnvironmentTextureNode.superClass.call(this,a)},{getTexUrl:function(){return[]},getTexSize:function(){return-1}})),x3dom.registerNodeType("ComposedCubeMapTexture","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DEnvironmentTextureNode,function(a){x3dom.nodeTypes.ComposedCubeMapTexture.superClass.call(this,a),this.addField_SFNode("back",x3dom.nodeTypes.Texture),this.addField_SFNode("front",x3dom.nodeTypes.Texture),this.addField_SFNode("bottom",x3dom.nodeTypes.Texture),this.addField_SFNode("top",x3dom.nodeTypes.Texture),this.addField_SFNode("left",x3dom.nodeTypes.Texture),this.addField_SFNode("right",x3dom.nodeTypes.Texture),this._type="cubeMap"},{getTexUrl:function(){return[this._nameSpace.getURL(this._cf.back.node._vf.url[0]),this._nameSpace.getURL(this._cf.front.node._vf.url[0]),this._nameSpace.getURL(this._cf.bottom.node._vf.url[0]),this._nameSpace.getURL(this._cf.top.node._vf.url[0]),this._nameSpace.getURL(this._cf.left.node._vf.url[0]),this._nameSpace.getURL(this._cf.right.node._vf.url[0])]}})),x3dom.registerNodeType("GeneratedCubeMapTexture","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DEnvironmentTextureNode,function(a){x3dom.nodeTypes.GeneratedCubeMapTexture.superClass.call(this,a),this.addField_SFInt32(a,"size",128),this.addField_SFString(a,"update","NONE"),this._type="cubeMap",x3dom.debug.logWarning("GeneratedCubeMapTexture NYI")},{getTexSize:function(){return this._vf.size}})),x3dom.registerNodeType("X3DTextureCoordinateNode","Texturing",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.X3DTextureCoordinateNode.superClass.call(this,a)},{fieldChanged:function(a){("texCoord"===a||"point"===a||"parameter"===a||"mode"===a)&&Array.forEach(this._parentNodes,function(a){a.fieldChanged("texCoord")})},parentAdded:function(a){a._mesh&&a._cf.texCoord.node!==this&&a.fieldChanged("texCoord")}})),x3dom.registerNodeType("TextureCoordinate","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(a){x3dom.nodeTypes.TextureCoordinate.superClass.call(this,a),this.addField_MFVec2f(a,"point",[])})),x3dom.registerNodeType("TextureCoordinateGenerator","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(a){x3dom.nodeTypes.TextureCoordinateGenerator.superClass.call(this,a),this.addField_SFString(a,"mode","SPHERE"),this.addField_MFFloat(a,"parameter",[])})),x3dom.registerNodeType("MultiTextureCoordinate","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(a){x3dom.nodeTypes.MultiTextureCoordinate.superClass.call(this,a),this.addField_MFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode)})),x3dom.registerNodeType("Uniform","Shaders",defineClass(x3dom.nodeTypes.Field,function(a){x3dom.nodeTypes.Uniform.superClass.call(this,a)})),x3dom.registerNodeType("SurfaceShaderTexture","Shaders",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.SurfaceShaderTexture.superClass.call(this,a),this.addField_SFInt32(a,"textureCoordinatesId",0),this.addField_SFString(a,"channelMask","DEFAULT"),this.addField_SFBool(a,"isSRGB",!1),this.addField_SFNode("texture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("textureTransform",x3dom.nodeTypes.X3DTextureTransformNode)})),x3dom.registerNodeType("X3DShaderNode","Shaders",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.X3DShaderNode.superClass.call(this,a),this.addField_SFString(a,"language","")})),x3dom.registerNodeType("CommonSurfaceShader","Shaders",defineClass(x3dom.nodeTypes.X3DShaderNode,function(a){x3dom.nodeTypes.CommonSurfaceShader.superClass.call(this,a),this.addField_SFInt32(a,"tangentTextureCoordinatesId",-1),this.addField_SFInt32(a,"binormalTextureCoordinatesId",-1),this.addField_SFVec3f(a,"emissiveFactor",0,0,0),this.addField_SFInt32(a,"emissiveTextureId",-1),this.addField_SFInt32(a,"emissiveTextureCoordinatesId",0),this.addField_SFString(a,"emissiveTextureChannelMask","rgb"),this.addField_SFVec3f(a,"ambientFactor",.2,.2,.2),this.addField_SFInt32(a,"ambientTextureId",-1),this.addField_SFInt32(a,"ambientTextureCoordinatesId",0),this.addField_SFString(a,"ambientTextureChannelMask","rgb"),this.addField_SFVec3f(a,"diffuseFactor",.8,.8,.8),this.addField_SFInt32(a,"diffuseTextureId",-1),this.addField_SFInt32(a,"diffuseTextureCoordinatesId",0),this.addField_SFString(a,"diffuseTextureChannelMask","rgb"),this.addField_SFVec3f(a,"specularFactor",0,0,0),this.addField_SFInt32(a,"specularTextureId",-1),this.addField_SFInt32(a,"specularTextureCoordinatesId",0),this.addField_SFString(a,"specularTextureChannelMask","rgb"),this.addField_SFFloat(a,"shininessFactor",.2),this.addField_SFInt32(a,"shininessTextureId",-1),this.addField_SFInt32(a,"shininessTextureCoordinatesId",0),this.addField_SFString(a,"shininessTextureChannelMask","a"),this.addField_SFString(a,"normalFormat","UNORM"),this.addField_SFString(a,"normalSpace","TANGENT"),this.addField_SFInt32(a,"normalTextureId",-1),this.addField_SFInt32(a,"normalTextureCoordinatesId",0),this.addField_SFString(a,"normalTextureChannelMask","rgb"),this.addField_SFVec3f(a,"reflectionFactor",0,0,0),this.addField_SFInt32(a,"reflectionTextureId",-1),this.addField_SFInt32(a,"reflectionTextureCoordinatesId",0),this.addField_SFString(a,"reflectionTextureChannelMask","rgb"),this.addField_SFVec3f(a,"transmissionFactor",0,0,0),this.addField_SFInt32(a,"transmissionTextureId",-1),this.addField_SFInt32(a,"transmissionTextureCoordinatesId",0),this.addField_SFString(a,"transmissionTextureChannelMask","rgb"),this.addField_SFVec3f(a,"environmentFactor",1,1,1),this.addField_SFInt32(a,"environmentTextureId",-1),this.addField_SFInt32(a,"environmentTextureCoordinatesId",0),this.addField_SFString(a,"environmentTextureChannelMask","rgb"),this.addField_SFFloat(a,"relativeIndexOfRefraction",1),this.addField_SFFloat(a,"fresnelBlend",0),this.addField_SFString(a,"displacementAxis","y"),this.addField_SFFloat(a,"displacementFactor",255),this.addField_SFInt32(a,"displacementTextureId",-1),this.addField_SFInt32(a,"displacementTextureCoordinatesId",0),this.addField_SFNode("emissiveTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("ambientTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("diffuseTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("specularTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("shininessTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("normalTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("reflectionTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("transmissionTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("environmentTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("displacementTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("diffuseDisplacementTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFVec3f(a,"normalScale",2,2,2),this.addField_SFVec3f(a,"normalBias",-1,-1,-1),this.addField_SFFloat(a,"alphaFactor",1),this.addField_SFBool(a,"invertAlphaTexture",!1),this.addField_SFInt32(a,"alphaTextureId",-1),this.addField_SFInt32(a,"alphaTextureCoordinatesId",0),this.addField_SFString(a,"alphaTextureChannelMask","a"),this.addField_SFNode("alphaTexture",x3dom.nodeTypes.X3DTextureNode),this._dirty={}},{getDiffuseMap:function(){return this._cf.diffuseTexture.node?(this._cf.diffuseTexture.node._cf.texture.node._type="diffuseMap",this._cf.diffuseTexture.node._cf.texture.node):null},getNormalMap:function(){return this._cf.normalTexture.node?(this._cf.normalTexture.node._cf.texture.node._type="normalMap",this._cf.normalTexture.node._cf.texture.node):null},getAmbientMap:function(){return this._cf.ambientTexture.node?(this._cf.ambientTexture.node._cf.texture.node._type="ambientMap",this._cf.ambientTexture.node._cf.texture.node):null},getSpecularMap:function(){return this._cf.specularTexture.node?(this._cf.specularTexture.node._cf.texture.node._type="specularMap",this._cf.specularTexture.node._cf.texture.node):null},getShininessMap:function(){return this._cf.shininessTexture.node?(this._cf.shininessTexture.node._cf.texture.node._type="shininessMap",this._cf.shininessTexture.node._cf.texture.node):null},getAlphaMap:function(){return this._cf.alphaTexture.node?(this._cf.alphaTexture.node._cf.texture.node._type="alphaMap",this._cf.alphaTexture.node._cf.texture.node):null},getDisplacementMap:function(){return this._cf.displacementTexture.node?(this._cf.displacementTexture.node._cf.texture.node._type="displacementMap",this._cf.displacementTexture.node._cf.texture.node):null},getDiffuseDisplacementMap:function(){return this._cf.diffuseDisplacementTexture.node?(this._cf.diffuseDisplacementTexture.node._cf.texture.node._type="diffuseDisplacementMap",this._cf.diffuseDisplacementTexture.node._cf.texture.node):null},getTextures:function(){var a=[],b=this.getDiffuseMap();b&&a.push(b);var c=this.getNormalMap();c&&a.push(c);var d=this.getSpecularMap();d&&a.push(d);var e=this.getDisplacementMap();e&&a.push(e);var f=this.getDiffuseDisplacementMap();return f&&a.push(f),a}})),x3dom.registerNodeType("ComposedShader","Shaders",defineClass(x3dom.nodeTypes.X3DShaderNode,function(a){x3dom.nodeTypes.ComposedShader.superClass.call(this,a),this.addField_MFNode("fields",x3dom.nodeTypes.Field),this.addField_MFNode("parts",x3dom.nodeTypes.ShaderPart),this._vertex=null,this._fragment=null,x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown||(x3dom.debug.logInfo("Current ComposedShader node implementation limitations:\nVertex attributes (if given in the standard X3D fields 'coord', 'color', 'normal', 'texCoord'), matrices and texture are provided as follows...\n(see also <a href='http://x3dom.org/x3dom/doc/help/composedShader.html'>http://x3dom.org/x3dom/doc/help/composedShader.html</a>)\n    attribute vec3 position;\n    attribute vec3 normal;\n    attribute vec2 texcoord;\n    attribute vec3 color;\n    uniform mat4 modelViewProjectionMatrix;\n    uniform mat4 modelViewMatrix;\n    uniform mat4 normalMatrix;\n    uniform mat4 viewMatrix;\n    uniform sampler2D tex;\n"),x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown=!0)},{nodeChanged:function(){var a,b=this._cf.parts.nodes.length;for(a=0;b>a;a++)"vertex"==this._cf.parts.nodes[a]._vf.type.toLowerCase()?this._vertex=this._cf.parts.nodes[a]:"fragment"==this._cf.parts.nodes[a]._vf.type.toLowerCase()&&(this._fragment=this._cf.parts.nodes[a]);var c={};for(b=this._cf.fields.nodes.length,a=0;b>a;a++){var d=this._cf.fields.nodes[a]._vf.name;c.xmlNode=this._cf.fields.nodes[a]._xmlNode;var e=!1;(void 0===c.xmlNode||null===c.xmlNode)&&(c.xmlNode=document.createElement("field"),e=!0),c.xmlNode.setAttribute(d,this._cf.fields.nodes[a]._vf.value);var f="this.addField_"+this._cf.fields.nodes[a]._vf.type+"(ctx, name);",g=new Function("ctx","name",f);g.call(this,c,d),e&&(c.xmlNode=null)}Array.forEach(this._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){a._cleanupGLObjects&&a._cleanupGLObjects(),a.setAllDirty()})})},fieldChanged:function(a){var b,c=this._cf.fields.nodes.length;for(b=0;c>b;b++){var d=this._cf.fields.nodes[b]._vf.name;if(d===a){var e=this._cf.fields.nodes[b]._vf.value;try{this._vf[d].setValueByStr(e)}catch(f){try{switch((typeof this._vf[d]).toString()){case"number":this._vf[d]=+e;break;case"boolean":this._vf[d]="true"===e.toLowerCase();break;case"string":this._vf[d]=e}}catch(g){x3dom.debug.logError("setValueByStr() NYI for "+typeof this._vf[d])}}break}}"url"===d&&Array.forEach(this._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){a._dirty.shader=!0})})},parentAdded:function(a){a.nodeChanged()}})),x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown=!1,x3dom.registerNodeType("ShaderPart","Shaders",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.ShaderPart.superClass.call(this,a),this.addField_MFString(a,"url",[]),this.addField_SFString(a,"type","VERTEX"),x3dom.debug.assert("vertex"==this._vf.type.toLowerCase()||"fragment"==this._vf.type.toLowerCase())},{nodeChanged:function(){var a={};if(a.xmlNode=this._xmlNode,void 0!==a.xmlNode&&null!==a.xmlNode){var b=this;if(b._vf.url.length&&-1==b._vf.url[0].indexOf("\n")){var c=new XMLHttpRequest;c.open("GET",encodeURI(b._nameSpace.getURL(b._vf.url[0])),!1),c.onload=function(){b._vf.url=new x3dom.fields.MFString([]),b._vf.url.push(c.response)},c.onerror=function(){x3dom.debug.logError("Could not load file '"+b._vf.url[0]+"'.")},c.send(null)}else{b._vf.url.length&&(b._vf.url=new x3dom.fields.MFString([]));try{b._vf.url.push(a.xmlNode.childNodes[1].nodeValue),a.xmlNode.removeChild(a.xmlNode.childNodes[1])}catch(d){Array.forEach(a.xmlNode.childNodes,function(a){3===a.nodeType?b._vf.url.push(a.nodeValue):4===a.nodeType&&b._vf.url.push(a.data),a.parentNode.removeChild(a)})}}}Array.forEach(this._parentNodes,function(a){a.nodeChanged()})},fieldChanged:function(a){"url"===a&&Array.forEach(this._parentNodes,function(a){a.fieldChanged("url")})},parentAdded:function(a){a.nodeChanged()}})),x3dom.registerNodeType("X3DVertexAttributeNode","Shaders",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.X3DVertexAttributeNode.superClass.call(this,a),this.addField_SFString(a,"name","")})),x3dom.registerNodeType("FloatVertexAttribute","Shaders",defineClass(x3dom.nodeTypes.X3DVertexAttributeNode,function(a){x3dom.nodeTypes.FloatVertexAttribute.superClass.call(this,a),this.addField_SFInt32(a,"numComponents",4),this.addField_MFFloat(a,"value",[])})),x3dom.registerNodeType("X3DSpatialGeometryNode","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.X3DSpatialGeometryNode.superClass.call(this,a)})),x3dom.registerNodeType("Plane","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Plane.superClass.call(this,a),this.addField_SFVec2f(a,"size",2,2),this.addField_SFVec2f(a,"subdivision",1,1),this.addField_SFVec3f(a,"center",0,0,0),this.addField_MFString(a,"primType",["TRIANGLES"]),this._vf.primType.length&&(this._mesh._primType=this._vf.primType[0]);var b=this._vf.size.x,c=this._vf.size.y,d=this._vf.subdivision.x,e=this._vf.subdivision.y,f="Plane_"+b+"-"+c+"-"+d+"-"+e+"-"+this._vf.center.x+"-"+this._vf.center.y+"-"+this._vf.center.z;if(a&&this._vf.useGeoCache&&void 0!==x3dom.geoCache[f])this._mesh=x3dom.geoCache[f];else{var g=0,h=0,i=b/d,j=c/e;for(b/=2,c/=2,h=0;e>=h;h++)for(g=0;d>=g;g++)this._mesh._positions[0].push(this._vf.center.x+g*i-b),this._mesh._positions[0].push(this._vf.center.y+h*j-c),this._mesh._positions[0].push(this._vf.center.z),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(g/d),this._mesh._texCoords[0].push(h/e);for(h=1;e>=h;h++)for(g=0;d>g;g++)this._mesh._indices[0].push((h-1)*(d+1)+g),this._mesh._indices[0].push((h-1)*(d+1)+g+1),this._mesh._indices[0].push(h*(d+1)+g),this._mesh._indices[0].push(h*(d+1)+g),this._mesh._indices[0].push((h-1)*(d+1)+g+1),this._mesh._indices[0].push(h*(d+1)+g+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[f]=this._mesh}},{fieldChanged:function(a){if("size"==a||"center"==a){this._mesh._positions[0]=[];var b=this._vf.size.x,c=this._vf.size.y,d=this._vf.subdivision.x,e=this._vf.subdivision.y,f=0,g=0,h=b/d,i=c/e;for(b/=2,c/=2,g=0;e>=g;g++)for(f=0;d>=f;f++)this._mesh._positions[0].push(this._vf.center.x+f*h-b),this._mesh._positions[0].push(this._vf.center.y+g*i-c),this._mesh._positions[0].push(this._vf.center.z);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()})}else if("subdivision"==a){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var b=this._vf.size.x,c=this._vf.size.y,d=this._vf.subdivision.x,e=this._vf.subdivision.y,f=0,g=0,h=b/d,i=c/e;for(b/=2,c/=2,g=0;e>=g;g++)for(f=0;d>=f;f++)this._mesh._positions[0].push(this._vf.center.x+f*h-b),this._mesh._positions[0].push(this._vf.center.y+g*i-c),this._mesh._positions[0].push(this._vf.center.z),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(f/d),this._mesh._texCoords[0].push(g/e);for(g=1;e>=g;g++)for(f=0;d>f;f++)this._mesh._indices[0].push((g-1)*(d+1)+f),this._mesh._indices[0].push((g-1)*(d+1)+f+1),this._mesh._indices[0].push(g*(d+1)+f),this._mesh._indices[0].push(g*(d+1)+f),this._mesh._indices[0].push((g-1)*(d+1)+f+1),this._mesh._indices[0].push(g*(d+1)+f+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()})}}})),x3dom.registerNodeType("Box","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Box.superClass.call(this,a),this.addField_SFVec3f(a,"size",2,2,2),this.addField_SFBool(a,"hasHelperColors",!1);var b=this._vf.size.x,c=this._vf.size.y,d=this._vf.size.z,e="Box_"+b+"-"+c+"-"+d;this._vf.useGeoCache&&void 0!==x3dom.geoCache[e]?this._mesh=x3dom.geoCache[e]:(b/=2,c/=2,d/=2,this._mesh._positions[0]=[-b,-c,-d,-b,c,-d,b,c,-d,b,-c,-d,-b,-c,d,-b,c,d,b,c,d,b,-c,d,-b,-c,-d,-b,-c,d,-b,c,d,-b,c,-d,b,-c,-d,b,-c,d,b,c,d,b,c,-d,-b,c,-d,-b,c,d,b,c,d,b,c,-d,-b,-c,-d,-b,-c,d,b,-c,d,b,-c,-d],this._mesh._normals[0]=[0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],this._mesh._texCoords[0]=[1,0,1,1,0,1,0,0,0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,1,1,0,0,0,0,1,1,1,0,1,0,0,1,0,1,1,0,0,0,1,1,1,1,0],this._vf.hasHelperColors&&(this._mesh._colors[0]=[0,0,0,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,1,1,1,1,0,1,0,0,0,0,0,1,0,1,1,0,1,0,1,0,0,1,0,1,1,1,1,1,1,0,0,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,0,1,1,0,0]),this._mesh._indices[0]=[0,1,2,2,3,0,4,7,5,5,7,6,8,9,10,10,11,8,12,14,13,14,12,15,16,17,18,18,19,16,20,22,21,22,20,23],this._mesh._invalidate=!0,this._mesh._numFaces=12,this._mesh._numCoords=24,x3dom.geoCache[e]=this._mesh)},{fieldChanged:function(a){if("size"===a){var b=this._vf.size.x/2,c=this._vf.size.y/2,d=this._vf.size.z/2;this._mesh._positions[0]=[-b,-c,-d,-b,c,-d,b,c,-d,b,-c,-d,-b,-c,d,-b,c,d,b,c,d,b,-c,d,-b,-c,-d,-b,-c,d,-b,c,d,-b,c,-d,b,-c,-d,b,-c,d,b,c,d,b,c,-d,-b,c,-d,-b,c,d,b,c,d,b,c,-d,-b,-c,-d,-b,-c,d,b,-c,d,b,-c,-d],this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()})}else"hasHelperColors"===a&&(this._mesh._colors[0]=this._vf.hasHelperColors?[0,0,0,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,1,1,1,1,0,1,0,0,0,0,0,1,0,1,1,0,1,0,1,0,0,1,0,1,1,1,1,1,1,0,0,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,0,1,1,0,0]:[],Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0}))}})),x3dom.registerNodeType("Sphere","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Sphere.superClass.call(this,a),this.addField_SFFloat(a,"radius",a?1:1e4),this.addField_SFVec2f(a,"subdivision",24,24);var b=1,c=this._vf.radius,d=this._vf.subdivision.x,e=this._vf.subdivision.y,f="Sphere_"+c+"-"+d+"-"+e;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[f])this._mesh=x3dom.geoCache[f];else{if(a&&(b=a.doc.properties.getProperty("PrimitiveQuality","Medium")),x3dom.Utils.isNumber(b))b=parseFloat(b);else switch(b.toLowerCase()){case"low":b=.3;break;case"medium":b=.5;break;case"high":b=1}this._quality=b;var g,h,i,j,k,l,m,n,o,p,q,r,s,t=Math.floor(d*b),u=Math.floor(e*b);for(g=0;t>=g;g++)for(i=g*Math.PI/t,j=Math.sin(i),k=Math.cos(i),h=0;u>=h;h++)l=2*h*Math.PI/u,m=Math.sin(l),n=Math.cos(l),o=-n*j,p=-k,q=-m*j,r=.25-h/u,s=g/t,this._mesh._positions[0].push(c*o),this._mesh._positions[0].push(c*p),this._mesh._positions[0].push(c*q),this._mesh._normals[0].push(o),this._mesh._normals[0].push(p),this._mesh._normals[0].push(q),this._mesh._texCoords[0].push(r),this._mesh._texCoords[0].push(s);var v,w;for(g=0;t>g;g++)for(h=0;u>h;h++)v=g*(u+1)+h,w=v+u+1,this._mesh._indices[0].push(v),this._mesh._indices[0].push(w),this._mesh._indices[0].push(v+1),this._mesh._indices[0].push(w),this._mesh._indices[0].push(w+1),this._mesh._indices[0].push(v+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[f]=this._mesh}},{fieldChanged:function(a){if("radius"===a){this._mesh._positions[0]=[];var b,c,d,e,f,g,h,i,j,k,l,m=this._vf.radius,n=this._vf.subdivision.x,o=this._vf.subdivision.y,p=this._quality,q=Math.floor(n*p),r=Math.floor(o*p);for(b=0;q>=b;b++)for(d=b*Math.PI/q,e=Math.sin(d),f=Math.cos(d),c=0;r>=c;c++)g=2*c*Math.PI/r,h=Math.sin(g),i=Math.cos(g),j=-i*e,k=-f,l=-h*e,this._mesh._positions[0].push(m*j),this._mesh._positions[0].push(m*k),this._mesh._positions[0].push(m*l);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()})}else if("subdivision"===a){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var b,c,d,e,f,g,h,i,j,k,l,s,t,m=this._vf.radius,n=this._vf.subdivision.x,o=this._vf.subdivision.y,p=this._quality,q=Math.floor(n*p),r=Math.floor(o*p);for(b=0;q>=b;b++)for(d=b*Math.PI/q,e=Math.sin(d),f=Math.cos(d),c=0;r>=c;c++)g=2*c*Math.PI/r,h=Math.sin(g),i=Math.cos(g),j=-i*e,k=-f,l=-h*e,s=.25-c/r,t=b/q,this._mesh._positions[0].push(m*j),this._mesh._positions[0].push(m*k),this._mesh._positions[0].push(m*l),this._mesh._normals[0].push(j),this._mesh._normals[0].push(k),this._mesh._normals[0].push(l),this._mesh._texCoords[0].push(s),this._mesh._texCoords[0].push(t);var u,v;for(b=0;q>b;b++)for(c=0;r>c;c++)u=b*(r+1)+c,v=u+r+1,this._mesh._indices[0].push(u),this._mesh._indices[0].push(v),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(v),this._mesh._indices[0].push(v+1),this._mesh._indices[0].push(u+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()})}}})),x3dom.registerNodeType("Torus","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Torus.superClass.call(this,a);var b=2*Math.PI;this.addField_SFFloat(a,"innerRadius",.5),this.addField_SFFloat(a,"outerRadius",1),this.addField_SFFloat(a,"angle",b),this.addField_SFBool(a,"caps",!0),this.addField_SFVec2f(a,"subdivision",24,24),this.addField_SFBool(a,"insideOutsideRadius",!1),this._vf.angle<0?this._vf.angle=0:this._vf.angle>b&&(this._vf.angle=b),this._origCCW=this._vf.ccw;var c=this._vf.innerRadius,d=this._vf.outerRadius;if(1==this._vf.insideOutsideRadius){if(c>d){var e=c;c=d,d=e}var f=(d-c)/2;d=c+f,c=f,this._vf.ccw=!this._origCCW}var g=this._vf.subdivision.x,h=this._vf.subdivision.y;g=Math.max(3,Math.round(this._vf.angle/b*g));var i="Torus_"+c+"_"+d+"_"+this._vf.angle+"_"+this._vf.subdivision+"-"+this._vf.caps;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[i])this._mesh=x3dom.geoCache[i];else{var j,k,l,m,n,o,p,q,r,s=this._vf.angle/g,t=b/h;for(j=0,l=0;g>=j;j++,l+=s)for(n=Math.cos(l),o=Math.sin(l),k=0,m=0;h>=k;k++,m+=t)p=Math.cos(m),q=Math.sin(m),r=d+c*p,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(n*r,c*q,-o*r),this._mesh._normals[0].push(n*p,q,-o*p)):(this._mesh._positions[0].push(n*r,-o*r,c*q),this._mesh._normals[0].push(n*p,-o*p,q)),this._mesh._texCoords[0].push(-j/g,k/h);for(j=0;h>j;j++)for(k=0;g>k;k++)this._mesh._indices[0].push(k*(h+1)+j),this._mesh._indices[0].push(k*(h+1)+j+1),this._mesh._indices[0].push((k+1)*(h+1)+j),this._mesh._indices[0].push(k*(h+1)+j+1),this._mesh._indices[0].push((k+1)*(h+1)+j+1),this._mesh._indices[0].push((k+1)*(h+1)+j);if(this._vf.angle<b&&1==this._vf.caps){var u=this._mesh._positions[0].length/3;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(d,0,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(d,0,0),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(.5,.5),k=0,m=0;h>=k;k++,m+=t)p=Math.cos(m),q=Math.sin(m),r=d+c*p,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(r,q*c,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(r,0,q*c),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(.5*(1+p),.5*(1-q)),k>0&&(this._mesh._indices[0].push(u),this._mesh._indices[0].push(u+k),this._mesh._indices[0].push(u+k-1)),k==h&&(this._mesh._indices[0].push(u),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+k));n=Math.cos(this._vf.angle),o=Math.sin(this._vf.angle),u=this._mesh._positions[0].length/3;var v=-o,w=-n;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(n*d,0,-o*d),this._mesh._normals[0].push(v,0,w)):(this._mesh._positions[0].push(n*d,-o*d,0),this._mesh._normals[0].push(v,w,0)),this._mesh._texCoords[0].push(.5,.5),k=0,m=0;h>=k;k++,m+=t)p=Math.cos(m),q=Math.sin(m),r=d+c*p,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(n*r,q*c,-o*r),this._mesh._normals[0].push(v,0,w)):(this._mesh._positions[0].push(n*r,-o*r,q*c),this._mesh._normals[0].push(v,w,0)),this._mesh._texCoords[0].push(1-.5*(1+p),.5*(1-q)),k>0&&(this._mesh._indices[0].push(u),this._mesh._indices[0].push(u+k-1),this._mesh._indices[0].push(u+k)),k==h&&(this._mesh._indices[0].push(u),this._mesh._indices[0].push(u+k),this._mesh._indices[0].push(u+1))}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[i]=this._mesh}},{fieldChanged:function(a){if("innerRadius"==a||"outerRadius"==a||"subdivision"==a||"angle"==a||"insideOutsideRadius"==a||"caps"==a){var b=2*Math.PI;
this._vf.angle<0?this._vf.angle=0:this._vf.angle>b&&(this._vf.angle=b);var c=this._vf.innerRadius,d=this._vf.outerRadius;if(1==this._vf.insideOutsideRadius){if(c>d){var e=c;c=d,d=e}var f=(d-c)/2;d=c+f,c=f,this._vf.ccw=!this._origCCW}else this._vf.ccw=this._origCCW;var g=this._vf.subdivision.x,h=this._vf.subdivision.y;g=Math.max(3,Math.round(this._vf.angle/b*g));var i,j,k,l,m,n,o,p,q,r=this._vf.angle/g,s=b/h;for(this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[],i=0,k=0;g>=i;i++,k+=r)for(m=Math.cos(k),n=Math.sin(k),j=0,l=0;h>=j;j++,l+=s)o=Math.cos(l),p=Math.sin(l),q=d+c*o,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(m*q,c*p,-n*q),this._mesh._normals[0].push(m*o,p,-n*o)):(this._mesh._positions[0].push(m*q,-n*q,c*p),this._mesh._normals[0].push(m*o,-n*o,p)),this._mesh._texCoords[0].push(-i/g,j/h);for(i=0;h>i;i++)for(j=0;g>j;j++)this._mesh._indices[0].push(j*(h+1)+i),this._mesh._indices[0].push(j*(h+1)+i+1),this._mesh._indices[0].push((j+1)*(h+1)+i),this._mesh._indices[0].push(j*(h+1)+i+1),this._mesh._indices[0].push((j+1)*(h+1)+i+1),this._mesh._indices[0].push((j+1)*(h+1)+i);if(this._vf.angle<b&&1==this._vf.caps){var t=this._mesh._positions[0].length/3;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(d,0,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(d,0,0),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(.5,.5),j=0,l=0;h>=j;j++,l+=s)o=Math.cos(l),p=Math.sin(l),q=d+c*o,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(q,p*c,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(q,0,p*c),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(.5*(1+o),.5*(1-p)),j>0&&(this._mesh._indices[0].push(t),this._mesh._indices[0].push(t+j),this._mesh._indices[0].push(t+j-1)),j==h&&(this._mesh._indices[0].push(t),this._mesh._indices[0].push(t+1),this._mesh._indices[0].push(t+j));m=Math.cos(this._vf.angle),n=Math.sin(this._vf.angle),t=this._mesh._positions[0].length/3;var u=-n,v=-m;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(m*d,0,-n*d),this._mesh._normals[0].push(u,0,v)):(this._mesh._positions[0].push(m*d,-n*d,0),this._mesh._normals[0].push(u,v,0)),this._mesh._texCoords[0].push(.5,.5),j=0,l=0;h>=j;j++,l+=s)o=Math.cos(l),p=Math.sin(l),q=d+c*o,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(m*q,p*c,-n*q),this._mesh._normals[0].push(u,0,v)):(this._mesh._positions[0].push(m*q,-n*q,p*c),this._mesh._normals[0].push(u,v,0)),this._mesh._texCoords[0].push(1-.5*(1+o),.5*(1-p)),j>0&&(this._mesh._indices[0].push(t),this._mesh._indices[0].push(t+j-1),this._mesh._indices[0].push(t+j)),j==h&&(this._mesh._indices[0].push(t),this._mesh._indices[0].push(t+j),this._mesh._indices[0].push(t+1))}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()})}}})),x3dom.registerNodeType("Cone","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Cone.superClass.call(this,a),this.addField_SFFloat(a,"bottomRadius",1),this.addField_SFFloat(a,"topRadius",0),this.addField_SFFloat(a,"height",2),this.addField_SFBool(a,"bottom",!0),this.addField_SFBool(a,"side",!0),this.addField_SFBool(a,"top",!0),this.addField_SFFloat(a,"subdivision",32);var b="Cone_"+this._vf.bottomRadius+"_"+this._vf.height+"_"+this._vf.top+"_"+this._vf.bottom+"_"+this._vf.side+"_"+this._vf.topRadius+"_"+this._vf.subdivision;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[b])this._mesh=x3dom.geoCache[b];else{var c,d,e,f,g,h=this._vf.bottomRadius,i=this._vf.height,j=this._vf.topRadius,k=this._vf.subdivision,l=2*Math.PI/k,m=(h-j)/i,n=1/Math.sqrt(1+m*m),o=0,p=0;if(this._vf.side&&i>0){var q=0,r=0;for(o=0,p=0;k>=o;o++)c=o*l,d=Math.sin(c),e=-Math.cos(c),j>x3dom.fields.Eps&&(q=d*j,r=e*j),this._mesh._positions[0].push(q,i/2,r),this._mesh._normals[0].push(d/n,m/n,e/n),this._mesh._texCoords[0].push(1-o/k,1),this._mesh._positions[0].push(d*h,-i/2,e*h),this._mesh._normals[0].push(d/n,m/n,e/n),this._mesh._texCoords[0].push(1-o/k,0),o>0&&(this._mesh._indices[0].push(p),this._mesh._indices[0].push(p+2),this._mesh._indices[0].push(p+1),this._mesh._indices[0].push(p+1),this._mesh._indices[0].push(p+2),this._mesh._indices[0].push(p+3),p+=2)}if(this._vf.bottom&&h>0){for(g=this._mesh._positions[0].length/3,o=k-1;o>=0;o--)c=o*l,d=h*Math.sin(c),e=-h*Math.cos(c),this._mesh._positions[0].push(d,-i/2,e),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(d/h/2+.5,e/h/2+.5);for(f=g+1,o=2;k>o;o++)this._mesh._indices[0].push(f),this._mesh._indices[0].push(g),f=g+o,this._mesh._indices[0].push(f)}if(this._vf.top&&j>x3dom.fields.Eps){for(g=this._mesh._positions[0].length/3,o=k-1;o>=0;o--)c=o*l,d=j*Math.sin(c),e=-j*Math.cos(c),this._mesh._positions[0].push(d,i/2,e),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(d/j/2+.5,1-e/j/2+.5);for(f=g+1,o=2;k>o;o++)this._mesh._indices[0].push(g),this._mesh._indices[0].push(f),f=g+o,this._mesh._indices[0].push(f)}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[b]=this._mesh}},{fieldChanged:function(a){if("bottomRadius"==a||"topRadius"==a||"height"==a||"subdivision"==a||"bottom"==a||"top"==a||"side"==a){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var b,c,d,e,f,g=this._vf.bottomRadius,h=this._vf.height,i=this._vf.topRadius,j=this._vf.subdivision,k=2*Math.PI/j,l=(g-i)/h,m=1/Math.sqrt(1+l*l),n=0,o=0;if(this._vf.side&&h>0){var p=0,q=0;for(n=0,o=0;j>=n;n++)b=n*k,c=Math.sin(b),d=-Math.cos(b),i>x3dom.fields.Eps&&(p=c*i,q=d*i),this._mesh._positions[0].push(p,h/2,q),this._mesh._normals[0].push(c/m,l/m,d/m),this._mesh._texCoords[0].push(1-n/j,1),this._mesh._positions[0].push(c*g,-h/2,d*g),this._mesh._normals[0].push(c/m,l/m,d/m),this._mesh._texCoords[0].push(1-n/j,0),n>0&&(this._mesh._indices[0].push(o),this._mesh._indices[0].push(o+2),this._mesh._indices[0].push(o+1),this._mesh._indices[0].push(o+1),this._mesh._indices[0].push(o+2),this._mesh._indices[0].push(o+3),o+=2)}if(this._vf.bottom&&g>0){for(f=this._mesh._positions[0].length/3,n=j-1;n>=0;n--)b=n*k,c=g*Math.sin(b),d=-g*Math.cos(b),this._mesh._positions[0].push(c,-h/2,d),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(c/g/2+.5,d/g/2+.5);for(e=f+1,n=2;j>n;n++)this._mesh._indices[0].push(e),this._mesh._indices[0].push(f),e=f+n,this._mesh._indices[0].push(e)}if(this._vf.top&&i>x3dom.fields.Eps){for(f=this._mesh._positions[0].length/3,n=j-1;n>=0;n--)b=n*k,c=i*Math.sin(b),d=-i*Math.cos(b),this._mesh._positions[0].push(c,h/2,d),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(c/i/2+.5,1-d/i/2+.5);for(e=f+1,n=2;j>n;n++)this._mesh._indices[0].push(f),this._mesh._indices[0].push(e),e=f+n,this._mesh._indices[0].push(e)}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()})}}})),x3dom.registerNodeType("Cylinder","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Cylinder.superClass.call(this,a),this.addField_SFFloat(a,"radius",1),this.addField_SFFloat(a,"height",2),this.addField_SFBool(a,"bottom",!0),this.addField_SFBool(a,"top",!0),this.addField_SFFloat(a,"subdivision",32),this.addField_SFBool(a,"side",!0);var b=this._vf.subdivision,c="Cylinder_"+this._vf.radius+"_"+this._vf.height+"_"+this._vf.bottom+"_"+this._vf.top+"_"+this._vf.side+"_"+this._vf.subdivision;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[c])this._mesh=x3dom.geoCache[c];else{var d,e,f,g,h,i=this._vf.radius,j=this._vf.height/2,k=2*Math.PI/b;if(this._vf.side)for(g=0,h=0;b>=g;g++)d=g*k,e=Math.sin(d),f=-Math.cos(d),this._mesh._positions[0].push(e*i,-j,f*i),this._mesh._normals[0].push(e,0,f),this._mesh._texCoords[0].push(1-g/b,0),this._mesh._positions[0].push(e*i,j,f*i),this._mesh._normals[0].push(e,0,f),this._mesh._texCoords[0].push(1-g/b,1),g>0&&(this._mesh._indices[0].push(h),this._mesh._indices[0].push(h+1),this._mesh._indices[0].push(h+2),this._mesh._indices[0].push(h+2),this._mesh._indices[0].push(h+1),this._mesh._indices[0].push(h+3),h+=2);if(i>0){var l,m=this._mesh._positions[0].length/3;if(this._vf.top){for(g=b-1;g>=0;g--)d=g*k,e=i*Math.sin(d),f=-i*Math.cos(d),this._mesh._positions[0].push(e,j,f),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(e/i/2+.5,-f/i/2+.5);for(l=m+1,g=2;b>g;g++)this._mesh._indices[0].push(m),this._mesh._indices[0].push(l),l=m+g,this._mesh._indices[0].push(l);m=this._mesh._positions[0].length/3}if(this._vf.bottom){for(g=b-1;g>=0;g--)d=g*k,e=i*Math.sin(d),f=-i*Math.cos(d),this._mesh._positions[0].push(e,-j,f),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(e/i/2+.5,f/i/2+.5);for(l=m+1,g=2;b>g;g++)this._mesh._indices[0].push(l),this._mesh._indices[0].push(m),l=m+g,this._mesh._indices[0].push(l)}}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[c]=this._mesh}},{fieldChanged:function(a){if("radius"===a||"height"===a){this._mesh._positions[0]=[];var b,c,d,e,f=this._vf.radius,g=this._vf.height/2,h=this._vf.subdivision,i=2*Math.PI/h;if(this._vf.side)for(e=0;h>=e;e++)b=e*i,c=Math.sin(b),d=-Math.cos(b),this._mesh._positions[0].push(c*f,-g,d*f),this._mesh._positions[0].push(c*f,g,d*f);if(f>0){var j,k=this._mesh._positions[0].length/3;if(this._vf.top)for(e=h-1;e>=0;e--)b=e*i,c=f*Math.sin(b),d=-f*Math.cos(b),this._mesh._positions[0].push(c,g,d)}if(this._vf.bottom)for(e=h-1;e>=0;e--)b=e*i,c=f*Math.sin(b),d=-f*Math.cos(b),this._mesh._positions[0].push(c,-g,d);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()})}else if("subdivision"===a||"bottom"===a||"top"===a||"side"===a){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var b,c,d,e,f=this._vf.radius,g=this._vf.height/2,h=this._vf.subdivision,i=2*Math.PI/h,l=0;if(this._vf.side)for(e=0,l=0;h>=e;e++)b=e*i,c=Math.sin(b),d=-Math.cos(b),this._mesh._positions[0].push(c*f,-g,d*f),this._mesh._normals[0].push(c,0,d),this._mesh._texCoords[0].push(1-e/h,0),this._mesh._positions[0].push(c*f,g,d*f),this._mesh._normals[0].push(c,0,d),this._mesh._texCoords[0].push(1-e/h,1),e>0&&(this._mesh._indices[0].push(l+0),this._mesh._indices[0].push(l+1),this._mesh._indices[0].push(l+2),this._mesh._indices[0].push(l+2),this._mesh._indices[0].push(l+1),this._mesh._indices[0].push(l+3),l+=2);if(f>0){var j,k=this._mesh._positions[0].length/3;if(this._vf.top){for(e=h-1;e>=0;e--)b=e*i,c=f*Math.sin(b),d=-f*Math.cos(b),this._mesh._positions[0].push(c,g,d),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(c/f/2+.5,-d/f/2+.5);for(j=k+1,e=2;h>e;e++)this._mesh._indices[0].push(k),this._mesh._indices[0].push(j),j=k+e,this._mesh._indices[0].push(j);k=this._mesh._positions[0].length/3}if(this._vf.bottom){for(e=h-1;e>=0;e--)b=e*i,c=f*Math.sin(b),d=-f*Math.cos(b),this._mesh._positions[0].push(c,-g,d),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(c/f/2+.5,d/f/2+.5);for(j=k+1,e=2;h>e;e++)this._mesh._indices[0].push(j),this._mesh._indices[0].push(k),j=k+e,this._mesh._indices[0].push(j)}}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()})}}})),x3dom.registerNodeType("X3DBinaryContainerGeometryNode","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.X3DBinaryContainerGeometryNode.superClass.call(this,a),this.addField_SFVec3f(a,"position",0,0,0),this.addField_SFVec3f(a,"size",1,1,1),this.addField_MFInt32(a,"vertexCount",[0]),this.addField_MFString(a,"primType",["TRIANGLES"]),this._mesh._invalidate=!1,this._mesh._numCoords=0,this._mesh._numFaces=0,this._diameter=this._vf.size.length()},{getMin:function(){var a=this._mesh._vol;return a.isValid()||a.setBoundsByCenterSize(this._vf.position,this._vf.size),a.min},getMax:function(){var a=this._mesh._vol;return a.isValid()||a.setBoundsByCenterSize(this._vf.position,this._vf.size),a.max},getVolume:function(){var a=this._mesh._vol;return a.isValid()||a.setBoundsByCenterSize(this._vf.position,this._vf.size),a},invalidateVolume:function(){},getCenter:function(){return this._vf.position},getDiameter:function(){return this._diameter}})),x3dom.registerNodeType("BinaryGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(a){x3dom.nodeTypes.BinaryGeometry.superClass.call(this,a),this.addField_SFString(a,"index",""),this.addField_SFString(a,"coord",""),this.addField_SFString(a,"normal",""),this.addField_SFString(a,"texCoord",""),this.addField_SFString(a,"color",""),this.addField_SFString(a,"tangent",""),this.addField_SFString(a,"binormal",""),this.addField_SFString(a,"indexType","Uint16"),this.addField_SFString(a,"coordType","Float32"),this.addField_SFString(a,"normalType","Float32"),this.addField_SFString(a,"texCoordType","Float32"),this.addField_SFString(a,"colorType","Float32"),this.addField_SFString(a,"tangentType","Float32"),this.addField_SFString(a,"binormalType","Float32"),this.addField_SFBool(a,"normalAsSphericalCoordinates",!1),this.addField_SFBool(a,"rgbaColors",!1),this.addField_SFInt32(a,"numTexCoordComponents",2),this.addField_SFBool(a,"normalPerVertex",!0),this.addField_SFBool(a,"idsPerVertex",!1),this._hasStrideOffset=!1,this._mesh._numPosComponents=this._vf.normalAsSphericalCoordinates?4:3,this._mesh._numTexComponents=this._vf.numTexCoordComponents,this._mesh._numColComponents=this._vf.rgbaColors?4:3,this._mesh._numNormComponents=this._vf.normalAsSphericalCoordinates?2:3,this._vertexCountSum=0;for(var b=0;b<this._vf.vertexCount.length;++b)this._vertexCountSum+=this._vf.vertexCount[b]},{parentAdded:function(a){var b,c,d,e;b=this._vf.coord.lastIndexOf("#"),c=this._vf.coord.lastIndexOf("+"),b>=0&&c>=0?(d=+this._vf.coord.substring(++b,c),e=+this._vf.coord.substring(c),a._coordStrideOffset=[e,d],this._hasStrideOffset=!0,0==d/8-Math.floor(d/8)&&(this._mesh._numPosComponents=4)):c>=0&&(e=+this._vf.coord.substring(c),a._coordStrideOffset=[e,0],0==e/8-Math.floor(e/8)&&(this._mesh._numPosComponents=4)),b=this._vf.normal.lastIndexOf("#"),c=this._vf.normal.lastIndexOf("+"),b>=0&&c>=0?(d=+this._vf.normal.substring(++b,c),e=+this._vf.normal.substring(c),a._normalStrideOffset=[e,d]):c>=0&&(e=+this._vf.normal.substring(c),a._normalStrideOffset=[e,0]),b=this._vf.texCoord.lastIndexOf("#"),c=this._vf.texCoord.lastIndexOf("+"),b>=0&&c>=0?(d=+this._vf.texCoord.substring(++b,c),e=+this._vf.texCoord.substring(c),a._texCoordStrideOffset=[e,d]):c>=0&&(e=+this._vf.texCoord.substring(c),a._texCoordStrideOffset=[e,0]),b=this._vf.color.lastIndexOf("#"),c=this._vf.color.lastIndexOf("+"),b>=0&&c>=0?(d=+this._vf.color.substring(++b,c),e=+this._vf.color.substring(c),a._colorStrideOffset=[e,d]):c>=0&&(e=+this._vf.color.substring(c),a._colorStrideOffset=[e,0]),"Uint16"==this._vf.indexType||x3dom.caps.INDEX_UINT||x3dom.debug.logWarning("Index type "+this._vf.indexType+" problematic")},doIntersect:function(a){var b=this.getMin(),c=this.getMax(),d=a.intersect(b,c);return d&&a.enter<a.dist?(a.dist=a.enter,a.hitObject=this,a.hitPoint=a.pos.add(a.dir.multiply(a.enter)),!0):!1},getPrecisionMax:function(a){switch(this._vf[a]){case"Int8":return 127;case"Uint8":return 255;case"Int16":return 32767;case"Uint16":return 65535;case"Int32":return 2147483647;case"Uint32":return 4294967295;case"Float32":case"Float64":default:return 1}}})),x3dom.registerNodeType("PopGeometryLevel","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.PopGeometryLevel.superClass.call(this,a),this.addField_SFString(a,"src",""),this.addField_SFInt32(a,"numIndices",0),this.addField_SFInt32(a,"vertexDataBufferOffset",0)},{getSrc:function(){return this._vf.src},getNumIndices:function(){return this._vf.numIndices},getVertexDataBufferOffset:function(){return this._vf.vertexDataBufferOffset}})),x3dom.registerNodeType("PopGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(a){x3dom.nodeTypes.PopGeometry.superClass.call(this,a),this.addField_SFVec3f(a,"tightSize",1,1,1),this.addField_SFVec3f(a,"maxBBSize",1,1,1),this.addField_SFVec3f(a,"bbMinModF",0,0,0),this.addField_SFVec3f(a,"bbMaxModF",1,1,1),this.addField_SFVec3f(a,"bbMin",0,0,0),this.addField_SFVec3f(a,"bbShiftVec",0,0,0),this._vf.bbMinModF.x>this._vf.bbMaxModF.x&&(this._vf.bbShiftVec.x=1),this._vf.bbMinModF.y>this._vf.bbMaxModF.y&&(this._vf.bbShiftVec.y=1),this._vf.bbMinModF.z>this._vf.bbMaxModF.z&&(this._vf.bbShiftVec.z=1),this.addField_MFNode("levels",x3dom.nodeTypes.PopGeometryLevel),this.addField_SFInt32(a,"attributeStride",0),this.addField_SFInt32(a,"positionOffset",0),this.addField_SFInt32(a,"normalOffset",0),this.addField_SFInt32(a,"texcoordOffset",0),this.addField_SFInt32(a,"colorOffset",0),this.addField_SFInt32(a,"numAnchorVertices",0),this.addField_SFInt32(a,"positionPrecision",2),this.addField_SFInt32(a,"normalPrecision",1),this.addField_SFInt32(a,"texcoordPrecision",2),this.addField_SFInt32(a,"colorPrecision",1),this.addField_SFInt32(a,"minPrecisionLevel",-1),this.addField_SFInt32(a,"maxPrecisionLevel",-1),this.addField_SFFloat(a,"precisionFactor",1),this.addField_SFString(a,"coordType","Uint16"),this.addField_SFString(a,"normalType","Uint8"),this.addField_SFString(a,"texCoordType","Uint16"),this.addField_SFString(a,"colorType","Uint8"),this.addField_SFInt32(a,"vertexBufferSize",0),this.addField_SFBool(a,"indexedRendering",!1),this.addField_SFBool(a,"sphericalNormals",!1),this.addField_MFInt32(a,"originalVertexCount",[0]);for(var b=0;b<this._vf.vertexCount.length;++b)this._vf.originalVertexCount[b]=this._vf.vertexCount[b];this._vf.maxBBSize=x3dom.fields.SFVec3f.copy(this._vf.size),this._vf.size=this._vf.tightSize,this._diameter=this._vf.size.length(),this._bbMinBySize=[Math.floor(this._vf.bbMin.x/this._vf.maxBBSize.x),Math.floor(this._vf.bbMin.y/this._vf.maxBBSize.y),Math.floor(this._vf.bbMin.z/this._vf.maxBBSize.z)],this._volRadius=this._vf.size.length()/2,this._volLargestRadius=this._vf.maxBBSize.length()/2,this._mesh._numPosComponents=this._vf.sphericalNormals?4:3,this._mesh._numNormComponents=this._vf.sphericalNormals?2:3,this._mesh._numTexComponents=2,this._mesh._numColComponents=3,x3dom.nodeTypes.PopGeometry.numTotalVerts+=this.getVertexCount(),x3dom.nodeTypes.PopGeometry.numTotalTris+=(this.hasIndex()?this.getTotalNumberOfIndices():this.getVertexCount())/3},{forceUpdateCoverage:function(){return!0},getBBoxShiftVec:function(){return this._vf.bbShiftVec},getBBoxSize:function(){return this._vf.size},hasIndex:function(){return this._vf.indexedRendering},getTotalNumberOfIndices:function(){if(this._vf.indexedRendering){for(var a=0,b=0;b<this._vf.originalVertexCount.length;++b)a+=this._vf.originalVertexCount[b];return a}return 0},getVertexCount:function(){for(var a=0,b=0;b<this._vf.originalVertexCount.length;++b)a+=this._vf.originalVertexCount[b];return a},adaptVertexCount:function(a){for(var b=0,c=0;c<this._vf.originalVertexCount.length;++c){if(!(this._vf.originalVertexCount[c]+b<=a)){this._vf.vertexCount[c]=a-b;break}this._vf.vertexCount[c]=this._vf.originalVertexCount[c],b+=this._vf.originalVertexCount[c]}},hasNormal:function(){return 0!=this._vf.normalOffset&&!this._vf.sphericalNormals},hasTexCoord:function(){return 0!=this._vf.texcoordOffset},hasColor:function(){return 0!=this._vf.colorOffset},getPositionPrecision:function(){return this._vf.positionPrecision},getNormalPrecision:function(){return this._vf.normalPrecision},getTexCoordPrecision:function(){return this._vf.texcoordPrecision},getColorPrecision:function(){return this._vf.colorPrecision},getAttributeStride:function(){return this._vf.attributeStride},getPositionOffset:function(){return this._vf.positionOffset},getNormalOffset:function(){return this._vf.normalOffset},getTexCoordOffset:function(){return this._vf.texcoordOffset},getColorOffset:function(){return this._vf.colorOffset},getBufferTypeStringFromByteCount:function(a){switch(a){case 1:return"Uint8";case 2:return"Uint16";default:return 0}},getDataURLs:function(){for(var a=[],b=0;b<this._cf.levels.nodes.length;++b)a.push(this._cf.levels.nodes[b].getSrc());return a},getNumIndicesByLevel:function(a){return this._cf.levels.nodes[a].getNumIndices()},getNumLevels:function(){return this._cf.levels.nodes.length},getVertexDataBufferOffset:function(a){return this._cf.levels.nodes[a].getVertexDataBufferOffset()},getPrecisionMax:function(a){switch(this._vf[a]){case"Uint8":return 255;case"Uint16":return 65535;default:return 1}}})),x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor=1,x3dom.nodeTypes.PopGeometry.PrecisionFactorOnMove=1,x3dom.nodeTypes.PopGeometry.numRenderedVerts=0,x3dom.nodeTypes.PopGeometry.numRenderedTris=0,x3dom.nodeTypes.PopGeometry.numTotalVerts=0,x3dom.nodeTypes.PopGeometry.numTotalTris=0,x3dom.nodeTypes.PopGeometry.powLUT=[32768,16384,8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1],x3dom.registerNodeType("BitLODGeoComponent","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.BitLODGeoComponent.superClass.call(this,a),this.addField_SFString(a,"src",""),this.addField_MFInt32(a,"format",[]),this.addField_MFString(a,"attrib",[]),this._attribShift=[],this._attribShiftDec=[],this._mask=[],this._bitsPerComponent=0},{nodeChanged:function(){for(var a=0;a<this._vf.format.length;a++)this._bitsPerComponent+=this._vf.format[a]},getSrc:function(){return this._vf.src},getFormat:function(){return this._vf.format},getAttrib:function(a){return this._vf.attrib[a]},getNumAttribs:function(){return this._vf.attrib.length}})),x3dom.registerNodeType("BitLODGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(a){x3dom.nodeTypes.BitLODGeometry.superClass.call(this,a),this.addField_SFString(a,"index",""),this.addField_SFBool(a,"usesVLCIndices",!1),this.addField_SFBool(a,"clientSideNormals",!1),this.addField_SFBool(a,"normalAsSphericalCoordinates",!1),this.addField_SFBool(a,"normalPerVertex",!0),this.addField_MFNode("components",x3dom.nodeTypes.BitLODGeoComponent),this.addField_SFString(a,"coordType","Uint16"),this.addField_SFString(a,"normalType","Uint16"),this.addField_SFString(a,"texCoordType","Uint16"),this.addField_SFString(a,"colorType","Uint16"),this._hasStrideOffset=!1,this._mesh._numTexComponents=2,this._mesh._numColComponents=3,this._vf.clientSideNormals=!1,this._vf.normalPerVertex=!this._vf.clientSideNormals,this._vf.normalAsSphericalCoordinates=this._vf.normalPerVertex,this._mesh._numNormComponents=this._vf.normalAsSphericalCoordinates?2:3},{parentAdded:function(a){a._coordStrideOffset=[12,0],a._normalStrideOffset=[12,8],a._texCoordStrideOffset=[4,0],a._colorStrideOffset=[6,0]},hasIndex:function(){return this._vf.index.length?!0:!1},usesVLCIndices:function(){return 1==this._vf.usesVLCIndices},usesClientSideNormals:function(){return 1==this._vf.clientSideNormals},hasColor:function(){for(var a=0;a<this.getNumComponents();a++)for(var b=0;b<this.getComponent(a).getNumAttribs();b++)if("color3"==this.getComponent(a).getAttrib(b))return!0;return!1},hasTexCoord:function(){for(var a=0;a<this.getNumComponents();a++)for(var b=0;b<this.getComponent(a).getNumAttribs();b++)if("texcoord2"==this.getComponent(a).getAttrib(b))return!0;return!1},getCoordNormalURLs:function(){for(var a=[],b=0;b<this.getNumComponents();b++)for(var c=0;c<this.getComponent(b).getNumAttribs();c++)"coord3"==this.getComponent(b).getAttrib(c)&&a.push(this.getComponent(b).getSrc());return a},getTexCoordURLs:function(){for(var a=[],b=0;b<this.getNumComponents();b++)for(var c=0;c<this.getComponent(b).getNumAttribs();c++)"texcoord2"==this.getComponent(b).getAttrib(c)&&a.push(this.getComponent(b).getSrc());return a},getColorURLs:function(){for(var a=[],b=0;b<this.getNumComponents();b++)for(var c=0;c<this.getComponent(b).getNumAttribs();c++)"color3"==this.getComponent(b).getAttrib(c)&&a.push(this.getComponent(b).getSrc());return a},getNumPrimTypes:function(){return this._vf.primType.length},getPrimType:function(a){return a<this.getNumPrimTypes()?this._vf.primType[a].toUpperCase():""},getNumVertexCounts:function(){return this._vf.vertexCount.length},getVertexCount:function(a){return a<this.getNumVertexCounts()?this._vf.vertexCount[a]:0},setVertexCount:function(a,b){this._vf.vertexCount[a]=b},getNumComponents:function(){return this._cf.components.nodes.length},getComponent:function(a){return this._cf.components.nodes[a]},getComponentsURLs:function(){for(var a=[],b=0;b<this._cf.components.nodes.length;b++)a[b]=this._cf.components.nodes[b].getSrc();return a},getComponentFormats:function(){for(var a=[],b=0;b<this._cf.components.nodes.length;b++)a[b]=this._cf.components.nodes[b]._vf.format;return a},getComponentAttribs:function(){for(var a=[],b=0;b<this._cf.components.nodes.length;b++)a[b]=this._cf.components.nodes[b]._vf.attrib;return a},getNumVertices:function(){for(var a=0,b=0;b<this._vf.vertexCount.length;b++)a+=this._vf.vertexCount[b];return a},getAttribType:function(a){switch(a){case 8:return"Uint8";case 16:return"Uint16";case 32:return"Float32";default:return 0}},getPrecisionMax:function(a){switch(this._vf[a]){case"Int8":return 127;case"Uint8":return 255-(Math.pow(2,8-this.loadedLevels)-1);case"Int16":return 32767;case"Uint16":return"normalType"===a?65535-(Math.pow(2,16-this.loadedLevels)-1):65535-(Math.pow(2,16-2*this.loadedLevels)-1);case"Int32":return 2147483647;case"Uint32":return 4294967295;case"Float32":case"Float64":default:return 1}}})),x3dom.registerNodeType("ImageGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(a){if(x3dom.nodeTypes.ImageGeometry.superClass.call(this,a),this.addField_SFVec2f(a,"implicitMeshSize",256,256),this.addField_SFInt32(a,"numColorComponents",3),this.addField_SFInt32(a,"numTexCoordComponents",2),this.addField_SFNode("index",x3dom.nodeTypes.X3DTextureNode),this.addField_MFNode("coord",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("normal",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DTextureNode),this._mesh._numColComponents=this._vf.numColorComponents,this._mesh._numTexComponents=this._vf.numTexCoordComponents,0==this._vf.implicitMeshSize.y&&(this._vf.implicitMeshSize.y=this._vf.implicitMeshSize.x),"webgl"==x3dom.caps.BACKEND&&x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS>0){var b="ImageGeometry_"+this._vf.implicitMeshSize.x+"_"+this._vf.implicitMeshSize.y;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[b])this._mesh=x3dom.geoCache[b];else{for(var c=0;c<this._vf.implicitMeshSize.y;c++)for(var d=0;d<this._vf.implicitMeshSize.x;d++)this._mesh._positions[0].push(d/this._vf.implicitMeshSize.x,c/this._vf.implicitMeshSize.y,0);this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[b]=this._mesh}}this._vol=new x3dom.fields.BoxVolume,this._dirty={coord:!0,normal:!0,texCoord:!0,color:!0,index:!0}},{setGeoDirty:function(){this._dirty.coord=!0,this._dirty.normal=!0,this._dirty.texCoords=!0,this._dirty.color=!0,this._dirty.index=!0},unsetGeoDirty:function(){this._dirty.coord=!1,this._dirty.normal=!1,this._dirty.texCoords=!1,this._dirty.color=!1,this._dirty.index=!1},nodeChanged:function(){Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a._dirty.normals=!0,a._dirty.texcoords=!0,a._dirty.colors=!0}),this._vol.invalidate()},fieldChanged:function(a){"index"==a||"coord"==a||"normal"==a||"texCoord"==a||"color"==a?(this._dirty[a]=!0,this._vol.invalidate()):"implicitMeshSize"==a&&this._vol.invalidate()},getMin:function(){var a=this._vol;return a.isValid()||a.setBoundsByCenterSize(this._vf.position,this._vf.size),a.min},getMax:function(){var a=this._vol;return a.isValid()||a.setBoundsByCenterSize(this._vf.position,this._vf.size),a.max},getVolume:function(){var a=this._vol;return a.isValid()||a.setBoundsByCenterSize(this._vf.position,this._vf.size),a},numCoordinateTextures:function(){return this._cf.coord.nodes.length},getIndexTexture:function(){return this._cf.index.node?(this._cf.index.node._type="IG_index",this._cf.index.node):null},getIndexTextureURL:function(){return this._cf.index.node?this._cf.index.node._vf.url:null},getCoordinateTexture:function(a){return this._cf.coord.nodes[a]?(this._cf.coord.nodes[a]._type="IG_coords"+a,this._cf.coord.nodes[a]):null},getCoordinateTextureURL:function(a){return this._cf.coord.nodes[a]?this._cf.coord.nodes[a]._vf.url:null},getCoordinateTextureURLs:function(){for(var a=[],b=0;b<this._cf.coord.nodes.length;b++)a.push(this._cf.coord.nodes[b]._vf.url);return a},getNormalTexture:function(){return this._cf.normal.node?(this._cf.normal.node._type="IG_normals",this._cf.normal.node):null},getNormalTextureURL:function(){return this._cf.normal.node?this._cf.normal.node._vf.url:null},getTexCoordTexture:function(){return this._cf.texCoord.node?(this._cf.texCoord.node._type="IG_texCoords",this._cf.texCoord.node):null},getTexCoordTextureURL:function(){return this._cf.texCoord.node?this._cf.texCoord.node._vf.url:null},getColorTexture:function(){return this._cf.color.node?(this._cf.color.node._type="IG_colors",this._cf.color.node):null},getColorTextureURL:function(){return this._cf.color.node?this._cf.color.node._vf.url:null},getTextures:function(){var a=[],b=this.getIndexTexture();for(b&&a.push(b),i=0;i<this.numCoordinateTextures();i++){var c=this.getCoordinateTexture(i);c&&a.push(c)}var d=this.getNormalTexture();d&&a.push(d);var e=this.getTexCoordTexture();e&&a.push(e);var f=this.getColorTexture();return f&&a.push(f),a}})),x3dom.registerNodeType("IndexedFaceSet","Geometry3D",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(a){x3dom.nodeTypes.IndexedFaceSet.superClass.call(this,a),this.addField_SFFloat(a,"creaseAngle",0),this.addField_SFBool(a,"convex",!0),this.addField_MFInt32(a,"coordIndex",[]),this.addField_MFInt32(a,"normalIndex",[]),this.addField_MFInt32(a,"colorIndex",[]),this.addField_MFInt32(a,"texCoordIndex",[])},{nodeChanged:function(){(new Date).getTime(),this.handleAttribs();var a=this._vf.coordIndex;a.length&&-1!=a[a.length-1]&&(a.push(-1),x3dom.debug.logWarning("Last index value should be -1."));var b=this._vf.normalIndex,c=this._vf.texCoordIndex,d=this._vf.colorIndex,e=!1,f=!1,g=!1,h=!1,i=!1,j=!1,k=this._vf.colorPerVertex,l=this._vf.normalPerVertex;b.length>0&&(f=!0),c.length>0&&(h=!0),d.length>0&&(j=!0);var m,n,o,p,q=this._cf.coord.node;x3dom.debug.assert(q),m=q.getPoints();var r=this._cf.normal.node;r?(e=!0,n=r._vf.vector):e=!1;var s="",t=2,u=this._cf.texCoord.node;x3dom.isa(u,x3dom.nodeTypes.MultiTextureCoordinate)&&u._cf.texCoord.nodes.length&&(u=u._cf.texCoord.nodes[0]),u?u._vf.point?(g=!0,o=u._vf.point,x3dom.isa(u,x3dom.nodeTypes.TextureCoordinate3D)&&(t=3)):u._vf.mode&&(s=u._vf.mode):g=!1,this._mesh._numTexComponents=t;var v=3,w=this._cf.color.node;w?(i=!0,p=w._vf.color,x3dom.isa(w,x3dom.nodeTypes.ColorRGBA)&&(v=4)):i=!1,this._mesh._numColComponents=v,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N;if(this._vf.creaseAngle<=x3dom.fields.Eps||m.length>x3dom.Utils.maxIndexableCoords||e&&f||g&&h||i&&j){if(this._vf.creaseAngle<=x3dom.fields.Eps&&x3dom.debug.logWarning("Fallback to inefficient multi-index mode since creaseAngle=0."),this._vf.convex)for(z=0,A=0,B=0,this._mesh._multiIndIndices=[],this._mesh._posSize=m.length,x=0;x<a.length;++x)if(-1!=a[x])switch(f&&x3dom.debug.assert(-1!=b[x]),h&&x3dom.debug.assert(-1!=c[x]),j&&x3dom.debug.assert(-1!=d[x]),z){case 0:C=+a[x],F=f&&l?+b[x]:f&&!l?+b[B]:l?C:B,I=h?+c[x]:C,L=j&&k?+d[x]:j&&!k?+d[B]:k?C:B,z=1;
break;case 1:D=+a[x],G=f&&l?+b[x]:f&&!l?+b[B]:l?D:B,J=h?+c[x]:D,M=j&&k?+d[x]:j&&!k?+d[B]:k?D:B,z=2;break;case 2:E=+a[x],H=f&&l?+b[x]:f&&!l?+b[B]:l?E:B,K=h?+c[x]:E,N=j&&k?+d[x]:j&&!k?+d[B]:k?E:B,z=3,this._mesh._positions[0].push(m[C].x),this._mesh._positions[0].push(m[C].y),this._mesh._positions[0].push(m[C].z),this._mesh._positions[0].push(m[D].x),this._mesh._positions[0].push(m[D].y),this._mesh._positions[0].push(m[D].z),this._mesh._positions[0].push(m[E].x),this._mesh._positions[0].push(m[E].y),this._mesh._positions[0].push(m[E].z),e&&(this._mesh._normals[0].push(n[F].x),this._mesh._normals[0].push(n[F].y),this._mesh._normals[0].push(n[F].z),this._mesh._normals[0].push(n[G].x),this._mesh._normals[0].push(n[G].y),this._mesh._normals[0].push(n[G].z),this._mesh._normals[0].push(n[H].x),this._mesh._normals[0].push(n[H].y),this._mesh._normals[0].push(n[H].z)),this._mesh._multiIndIndices.push(C,D,E),i&&(this._mesh._colors[0].push(p[L].r),this._mesh._colors[0].push(p[L].g),this._mesh._colors[0].push(p[L].b),4===v&&this._mesh._colors[0].push(p[L].a),this._mesh._colors[0].push(p[M].r),this._mesh._colors[0].push(p[M].g),this._mesh._colors[0].push(p[M].b),4===v&&this._mesh._colors[0].push(p[M].a),this._mesh._colors[0].push(p[N].r),this._mesh._colors[0].push(p[N].g),this._mesh._colors[0].push(p[N].b),4===v&&this._mesh._colors[0].push(p[N].a)),g&&(this._mesh._texCoords[0].push(o[I].x),this._mesh._texCoords[0].push(o[I].y),3===t&&this._mesh._texCoords[0].push(o[I].z),this._mesh._texCoords[0].push(o[J].x),this._mesh._texCoords[0].push(o[J].y),3===t&&this._mesh._texCoords[0].push(o[J].z),this._mesh._texCoords[0].push(o[K].x),this._mesh._texCoords[0].push(o[K].y),3===t&&this._mesh._texCoords[0].push(o[K].z));break;case 3:D=E,J=K,l&&(G=H),k&&(M=N),E=+a[x],f&&l?H=+b[x]:f&&!l||(H=l?E:B),K=h?+c[x]:E,j&&k?N=+d[x]:j&&!k||(N=k?E:B),this._mesh._positions[0].push(m[C].x),this._mesh._positions[0].push(m[C].y),this._mesh._positions[0].push(m[C].z),this._mesh._positions[0].push(m[D].x),this._mesh._positions[0].push(m[D].y),this._mesh._positions[0].push(m[D].z),this._mesh._positions[0].push(m[E].x),this._mesh._positions[0].push(m[E].y),this._mesh._positions[0].push(m[E].z),e&&(this._mesh._normals[0].push(n[F].x),this._mesh._normals[0].push(n[F].y),this._mesh._normals[0].push(n[F].z),this._mesh._normals[0].push(n[G].x),this._mesh._normals[0].push(n[G].y),this._mesh._normals[0].push(n[G].z),this._mesh._normals[0].push(n[H].x),this._mesh._normals[0].push(n[H].y),this._mesh._normals[0].push(n[H].z)),this._mesh._multiIndIndices.push(C,D,E),i&&(this._mesh._colors[0].push(p[L].r),this._mesh._colors[0].push(p[L].g),this._mesh._colors[0].push(p[L].b),4===v&&this._mesh._colors[0].push(p[L].a),this._mesh._colors[0].push(p[M].r),this._mesh._colors[0].push(p[M].g),this._mesh._colors[0].push(p[M].b),4===v&&this._mesh._colors[0].push(p[M].a),this._mesh._colors[0].push(p[N].r),this._mesh._colors[0].push(p[N].g),this._mesh._colors[0].push(p[N].b),4===v&&this._mesh._colors[0].push(p[N].a)),g&&(this._mesh._texCoords[0].push(o[I].x),this._mesh._texCoords[0].push(o[I].y),3===t&&this._mesh._texCoords[0].push(o[I].z),this._mesh._texCoords[0].push(o[J].x),this._mesh._texCoords[0].push(o[J].y),3===t&&this._mesh._texCoords[0].push(o[J].z),this._mesh._texCoords[0].push(o[K].x),this._mesh._texCoords[0].push(o[K].y),3===t&&this._mesh._texCoords[0].push(o[K].z))}else z=0,B++;else{var O=new x3dom.DoublyLinkedList,P={};for(A=0,B=0,x=0;x<a.length;++x)if(-1!=a[x])e&&(P.normals=f&&l?n[b[x]]:f&&!l?n[b[B]]:n[a[x]]),i&&(P.colors=j&&k?p[d[x]]:j&&!k?p[d[B]]:k?p[a[x]]:p[B]),g&&(P.texCoords=h?o[c[x]]:o[a[x]]),O.appendNode(new x3dom.DoublyLinkedList.ListNode(m[a[x]],a[x],P.normals,P.colors,P.texCoords));else{var Q=x3dom.EarClipping.getMultiIndexes(O);for(y=0;y<Q.indices.length;y++)this._mesh._indices[0].push(A),A++,this._mesh._positions[0].push(Q.point[y].x,Q.point[y].y,Q.point[y].z),e&&this._mesh._normals[0].push(Q.normals[y].x,Q.normals[y].y,Q.normals[y].z),i&&(this._mesh._colors[0].push(Q.colors[y].r,Q.colors[y].g,Q.colors[y].b),4===v&&this._mesh._colors[0].push(Q.colors[y].a)),g&&(this._mesh._texCoords[0].push(Q.texCoords[y].x,Q.texCoords[y].y),3===t&&this._mesh._texCoords[0].push(Q.texCoords[y].z));O=new x3dom.DoublyLinkedList,B++}this._mesh.splitMesh()}e||this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),g||this._mesh.calcTexCoords(s)}else{if(z=0,this._vf.convex)for(x=0;x<a.length;++x)if(-1!=a[x])switch(z){case 0:F=+a[x],z=1;break;case 1:G=+a[x],z=2;break;case 2:H=+a[x],z=3,this._mesh._indices[0].push(F,G,H);break;case 3:G=H,H=+a[x],this._mesh._indices[0].push(F,G,H)}else z=0;else for(O=new x3dom.DoublyLinkedList,x=0;x<a.length;++x)if(-1!=a[x])O.appendNode(new x3dom.DoublyLinkedList.ListNode(m[a[x]],a[x]));else{var R=x3dom.EarClipping.getIndexes(O);for(y=0;y<R.length;y++)this._mesh._indices[0].push(R[y]);O=new x3dom.DoublyLinkedList}this._mesh._positions[0]=m.toGL(),e?this._mesh._normals[0]=n.toGL():this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),g?(this._mesh._texCoords[0]=o.toGL(),this._mesh._numTexComponents=t):this._mesh.calcTexCoords(s),i&&(this._mesh._colors[0]=p.toGL(),this._mesh._numColComponents=v)}for(this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,x=0;x<this._mesh._positions.length;x++){var S=this._mesh._indices[x].length,T=this._mesh._positions[x].length/3;this._mesh._numCoords+=T,this._mesh._numFaces+=S>0?S/3:T/3}},fieldChanged:function(a){if("coord"!=a&&"normal"!=a&&"texCoord"!=a&&"color"!=a&&"coordIndex"!=a)return x3dom.debug.logWarning("IndexedFaceSet: fieldChanged for "+a+" not yet implemented!"),void 0;var b=this._cf.coord.node._vf.point,c=b.length,d=this._cf.texCoord.node;if(x3dom.isa(d,x3dom.nodeTypes.MultiTextureCoordinate)&&d._cf.texCoord.nodes.length&&(d=d._cf.texCoord.nodes[0]),(this._vf.creaseAngle<=x3dom.fields.Eps||c>x3dom.Utils.maxIndexableCoords||this._vf.normalIndex.length>0&&this._cf.normal.node||this._vf.texCoordIndex.length>0&&d||this._vf.colorIndex.length>0&&this._cf.color.node)&&this._mesh._multiIndIndices){var e=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase();if(c=this._mesh._multiIndIndices.length,this._mesh._positions[0]=[],this._mesh._indices[0]=[],"coord"==a&&c){for(e&&(this._mesh._normals[0]=[]),K=0;c>K;K+=3){var f=this._mesh._multiIndIndices[K],g=this._mesh._multiIndIndices[K+1],h=this._mesh._multiIndIndices[K+2],i=b[f],j=b[g],k=b[h];if(this._mesh._positions[0].push(i.x,i.y,i.z),this._mesh._positions[0].push(j.x,j.y,j.z),this._mesh._positions[0].push(k.x,k.y,k.z),e){var l=i.subtract(j),m=j.subtract(k),n=l.cross(m).normalize();this._vf.ccw||(n=n.negate()),this._mesh._normals[0].push(n.x,n.y,n.z),this._mesh._normals[0].push(n.x,n.y,n.z),this._mesh._normals[0].push(n.x,n.y,n.z)}}return this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,e&&(a._dirty.normals=!0)}),void 0}this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var o=this._vf.coordIndex,p=this._vf.normalIndex,q=this._vf.texCoordIndex,r=this._vf.colorIndex,s=!1,t=!1,u=!1,v=!1,w=!1,x=!1,y=this._vf.colorPerVertex,z=this._vf.normalPerVertex;p.length>0&&(t=!0),q.length>0&&(v=!0),r.length>0&&(x=!0);var A,B,C,D,E=this._cf.coord.node;x3dom.debug.assert(E),A=E.getPoints();var F=this._cf.normal.node;F?(s=!0,B=F._vf.vector):s=!1;var G="",H=2;d=this._cf.texCoord.node,x3dom.isa(d,x3dom.nodeTypes.MultiTextureCoordinate)&&d._cf.texCoord.nodes.length&&(d=d._cf.texCoord.nodes[0]),d?d._vf.point?(u=!0,C=d._vf.point,x3dom.isa(d,x3dom.nodeTypes.TextureCoordinate3D)&&(H=3)):d._vf.mode&&(G=d._vf.mode):u=!1,this._mesh._numTexComponents=H;var I=3,J=this._cf.color.node;J?(w=!0,D=J._vf.color,x3dom.isa(J,x3dom.nodeTypes.ColorRGBA)&&(I=4)):w=!1,this._mesh._numColComponents=I;var K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$;if(this._vf.convex)for(M=0,N=0,O=0,this._mesh._multiIndIndices=[],this._mesh._posSize=A.length,K=0;K<o.length;++K)if(-1!=o[K])switch(t&&x3dom.debug.assert(-1!=p[K]),v&&x3dom.debug.assert(-1!=q[K]),x&&x3dom.debug.assert(-1!=r[K]),M){case 0:P=+o[K],S=t&&z?+p[K]:t&&!z?+p[O]:z?P:O,V=v?+q[K]:P,Y=x&&y?+r[K]:x&&!y?+r[O]:y?P:O,M=1;break;case 1:Q=+o[K],T=t&&z?+p[K]:t&&!z?+p[O]:z?Q:O,W=v?+q[K]:Q,Z=x&&y?+r[K]:x&&!y?+r[O]:y?Q:O,M=2;break;case 2:R=+o[K],U=t&&z?+p[K]:t&&!z?+p[O]:z?R:O,X=v?+q[K]:R,$=x&&y?+r[K]:x&&!y?+r[O]:y?R:O,M=3,this._mesh._positions[0].push(A[P].x),this._mesh._positions[0].push(A[P].y),this._mesh._positions[0].push(A[P].z),this._mesh._positions[0].push(A[Q].x),this._mesh._positions[0].push(A[Q].y),this._mesh._positions[0].push(A[Q].z),this._mesh._positions[0].push(A[R].x),this._mesh._positions[0].push(A[R].y),this._mesh._positions[0].push(A[R].z),s&&(this._mesh._normals[0].push(B[S].x),this._mesh._normals[0].push(B[S].y),this._mesh._normals[0].push(B[S].z),this._mesh._normals[0].push(B[T].x),this._mesh._normals[0].push(B[T].y),this._mesh._normals[0].push(B[T].z),this._mesh._normals[0].push(B[U].x),this._mesh._normals[0].push(B[U].y),this._mesh._normals[0].push(B[U].z)),this._mesh._multiIndIndices.push(P,Q,R),w&&(this._mesh._colors[0].push(D[Y].r),this._mesh._colors[0].push(D[Y].g),this._mesh._colors[0].push(D[Y].b),4===I&&this._mesh._colors[0].push(D[Y].a),this._mesh._colors[0].push(D[Z].r),this._mesh._colors[0].push(D[Z].g),this._mesh._colors[0].push(D[Z].b),4===I&&this._mesh._colors[0].push(D[Z].a),this._mesh._colors[0].push(D[$].r),this._mesh._colors[0].push(D[$].g),this._mesh._colors[0].push(D[$].b),4===I&&this._mesh._colors[0].push(D[$].a)),u&&(this._mesh._texCoords[0].push(C[V].x),this._mesh._texCoords[0].push(C[V].y),3===H&&this._mesh._texCoords[0].push(C[V].z),this._mesh._texCoords[0].push(C[W].x),this._mesh._texCoords[0].push(C[W].y),3===H&&this._mesh._texCoords[0].push(C[W].z),this._mesh._texCoords[0].push(C[X].x),this._mesh._texCoords[0].push(C[X].y),3===H&&this._mesh._texCoords[0].push(C[X].z));break;case 3:Q=R,W=X,z&&(T=U),y&&(Z=$),R=+o[K],t&&z?U=+p[K]:t&&!z||(U=z?R:O),X=v?+q[K]:R,x&&y?$=+r[K]:x&&!y||($=y?R:O),this._mesh._positions[0].push(A[P].x),this._mesh._positions[0].push(A[P].y),this._mesh._positions[0].push(A[P].z),this._mesh._positions[0].push(A[Q].x),this._mesh._positions[0].push(A[Q].y),this._mesh._positions[0].push(A[Q].z),this._mesh._positions[0].push(A[R].x),this._mesh._positions[0].push(A[R].y),this._mesh._positions[0].push(A[R].z),s&&(this._mesh._normals[0].push(B[S].x),this._mesh._normals[0].push(B[S].y),this._mesh._normals[0].push(B[S].z),this._mesh._normals[0].push(B[T].x),this._mesh._normals[0].push(B[T].y),this._mesh._normals[0].push(B[T].z),this._mesh._normals[0].push(B[U].x),this._mesh._normals[0].push(B[U].y),this._mesh._normals[0].push(B[U].z)),this._mesh._multiIndIndices.push(P,Q,R),w&&(this._mesh._colors[0].push(D[Y].r),this._mesh._colors[0].push(D[Y].g),this._mesh._colors[0].push(D[Y].b),4===I&&this._mesh._colors[0].push(D[Y].a),this._mesh._colors[0].push(D[Z].r),this._mesh._colors[0].push(D[Z].g),this._mesh._colors[0].push(D[Z].b),4===I&&this._mesh._colors[0].push(D[Z].a),this._mesh._colors[0].push(D[$].r),this._mesh._colors[0].push(D[$].g),this._mesh._colors[0].push(D[$].b),4===I&&this._mesh._colors[0].push(D[$].a)),u&&(this._mesh._texCoords[0].push(C[V].x),this._mesh._texCoords[0].push(C[V].y),3===H&&this._mesh._texCoords[0].push(C[V].z),this._mesh._texCoords[0].push(C[W].x),this._mesh._texCoords[0].push(C[W].y),3===H&&this._mesh._texCoords[0].push(C[W].z),this._mesh._texCoords[0].push(C[X].x),this._mesh._texCoords[0].push(C[X].y),3===H&&this._mesh._texCoords[0].push(C[X].z))}else M=0,O++;else{var _=new x3dom.DoublyLinkedList,ab={};for(N=0,O=0,K=0;K<o.length;++K)if(-1!=o[K])s&&(ab.normals=t&&z?B[p[K]]:t&&!z?B[p[O]]:B[o[K]]),w&&(ab.colors=x&&y?D[r[K]]:x&&!y?D[r[O]]:D[o[K]]),u&&(ab.texCoords=v?C[q[K]]:C[o[K]]),_.appendNode(new x3dom.DoublyLinkedList.ListNode(A[o[K]],o[K],ab.normals,ab.colors,ab.texCoords));else{var bb=x3dom.EarClipping.getMultiIndexes(_);for(L=0;L<bb.indices.length;L++)this._mesh._indices[0].push(N),N++,this._mesh._positions[0].push(bb.point[L].x,bb.point[L].y,bb.point[L].z),s&&this._mesh._normals[0].push(bb.normals[L].x,bb.normals[L].y,bb.normals[L].z),w&&(this._mesh._colors[0].push(bb.colors[L].r,bb.colors[L].g,bb.colors[L].b),4===I&&this._mesh._colors[0].push(bb.colors[L].a)),u&&(this._mesh._texCoords[0].push(bb.texCoords[L].x,bb.texCoords[L].y),3===H&&this._mesh._texCoords[0].push(bb.texCoords[L].z));_=new x3dom.DoublyLinkedList,O++}this._mesh.splitMesh()}for(s||this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),u||this._mesh.calcTexCoords(G),this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,K=0;K<this._mesh._positions.length;K++){var cb=this._mesh._indices[K].length,db=this._mesh._positions[K].length/3;this._mesh._numCoords+=db,this._mesh._numFaces+=cb>0?cb/3:db/3}Array.forEach(this._parentNodes,function(a){a.setGeoDirty()})}else if("coord"==a){var e=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase();this._mesh._positions[0]=b.toGL(),e&&this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,e&&(a._dirty.normals=!0),a.invalidateVolume()})}else if("color"==a)b=this._cf.color.node._vf.color,this._mesh._colors[0]=b.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0});else if("normal"==a)b=this._cf.normal.node._vf.vector,this._mesh._normals[0]=b.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.normals=!0});else if("texCoord"==a)d=this._cf.texCoord.node,x3dom.isa(d,x3dom.nodeTypes.MultiTextureCoordinate)&&d._cf.texCoord.nodes.length&&(d=d._cf.texCoord.nodes[0]),b=d._vf.point,this._mesh._texCoords[0]=b.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.texcoords=!0});else if("coordIndex"==a){for(e=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase(),o=this._vf.coordIndex,M=0,c=o.length,this._mesh._indices[0]=[],K=0;c>K;++K)if(-1==o[K])M=0;else switch(M){case 0:P=+o[K],M=1;break;case 1:Q=+o[K],M=2;break;case 2:R=+o[K],M=3,this._mesh._indices[0].push(P,Q,R);break;case 3:Q=R,R=+o[K],this._mesh._indices[0].push(P,Q,R)}e&&this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),Array.forEach(this._parentNodes,function(a){a._dirty.indexes=!0,e&&(a._dirty.normals=!0)})}}})),x3dom.registerNodeType("X3DTexture3DNode","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.X3DTexture3DNode.superClass.call(this,a)})),x3dom.registerNodeType("ComposedTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,function(a){x3dom.nodeTypes.ComposedTexture3D.superClass.call(this,a),this.addField_MFNode("texture",x3dom.nodeTypes.X3DTexture3DNode)})),x3dom.registerNodeType("ImageTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,function(a){x3dom.nodeTypes.ImageTexture3D.superClass.call(this,a)})),x3dom.registerNodeType("PixelTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,function(a){x3dom.nodeTypes.PixelTexture3D.superClass.call(this,a)})),x3dom.registerNodeType("TextureCoordinate3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(a){x3dom.nodeTypes.TextureCoordinate3D.superClass.call(this,a),this.addField_MFVec3f(a,"point",[])})),x3dom.registerNodeType("TextureTransform3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(a){x3dom.nodeTypes.TextureTransform3D.superClass.call(this,a),this.addField_SFVec3f(a,"center",0,0,0),this.addField_SFRotation(a,"rotation",0,0,1,0),this.addField_SFVec3f(a,"scale",1,1,1),this.addField_SFVec3f(a,"translation",0,0,0),this.addField_SFRotation(a,"scaleOrientation",0,0,1,0)})),x3dom.registerNodeType("TextureTransformMatrix3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(a){x3dom.nodeTypes.TextureTransformMatrix3D.superClass.call(this,a),this.addField_SFMatrix4f(a,"matrix",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)})),x3dom.registerNodeType("ImageTextureAtlas","Texturing",defineClass(x3dom.nodeTypes.Texture,function(a){x3dom.nodeTypes.ImageTextureAtlas.superClass.call(this,a),this.addField_SFInt32(a,"numberOfSlices",0),this.addField_SFInt32(a,"slicesOverX",0),this.addField_SFInt32(a,"slicesOverY",0)})),x3dom.registerNodeType("GeoCoordinate","Geospatial",defineClass(x3dom.nodeTypes.X3DCoordinateNode,function(a){x3dom.nodeTypes.GeoCoordinate.superClass.call(this,a),this.addField_MFVec3f(a,"point",[]),this.addField_MFString(a,"geoSystem",["GD","WE"]),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.GeoOrigin)},{elipsoideParameters:{AA:["Airy 1830","6377563.396","299.3249646"],AM:["Modified Airy","6377340.189","299.3249646"],AN:["Australian National","6378160","298.25"],BN:["Bessel 1841 (Namibia)","6377483.865","299.1528128"],BR:["Bessel 1841 (Ethiopia Indonesia...)","6377397.155","299.1528128"],CC:["Clarke 1866","6378206.4","294.9786982"],CD:["Clarke 1880","6378249.145","293.465"],EA:["Everest (India 1830)","6377276.345","300.8017"],EB:["Everest (Sabah & Sarawak)","6377298.556","300.8017"],EC:["Everest (India 1956)","6377301.243","300.8017"],ED:["Everest (W. Malaysia 1969)","6377295.664","300.8017"],EE:["Everest (W. Malaysia & Singapore 1948)","6377304.063","300.8017"],EF:["Everest (Pakistan)","6377309.613","300.8017"],FA:["Modified Fischer 1960","6378155","298.3"],HE:["Helmert 1906","6378200","298.3"],HO:["Hough 1960","6378270","297"],ID:["Indonesian 1974","6378160","298.247"],IN:["International 1924","6378388","297"],KA:["Krassovsky 1940","6378245","298.3"],RF:["Geodetic Reference System 1980 (GRS 80)","6378137","298.257222101"],SA:["South American 1969","6378160","298.25"],WD:["WGS 72","6378135","298.26"],WE:["WGS 84","6378137","298.257223563"]},fieldChanged:function(a){("point"==a||"geoSystem"==a)&&Array.forEach(this._parentNodes,function(a){a.fieldChanged("coord")})},isLogitudeFirst:function(a){for(var b=0;b<a.length;++b)if("longitude_first"==a[b])return!0;return!1},getElipsoide:function(a){for(var b=0;b<a.length;++b){var c=a[b];if(this.elipsoideParameters[c])return this.elipsoideParameters[c]}return this.elipsoideParameters.WE},getReferenceFrame:function(a){for(var b=0;b<a.length;++b){var c=a[b];if("GD"==c||"GDC"==c)return"GD";if("GC"==c||"GCC"==c)return"GC";if("UTM"==c)return"UTM";x3dom.debug.logError("Unknown GEO system: ["+a+"]")}return this.elipsoideParameters.WE},UTMtoGC:function(){x3dom.debug.logError("Not implemented GeoCoordinate: UTM")},GDtoGC:function(a,b){for(var c=new x3dom.fields.MFVec3f,d=this.getElipsoide(a),e=d[1],f=d[2],g=this.isLogitudeFirst(a),h=e,i=e*e,j=1/f,k=h*(1-j),l=k*k,m=j*(2-j),n=.25*m,o=.017453292519943295,p=0;p<b.length;++p){var q=new x3dom.fields.SFVec3f,r=o*(1==g?b[p].y:b[p].x),s=o*(1==g?b[p].x:b[p].y),t=Math.sin(r),u=t*t,v=Math.cos(r),w=h/(.25-n*u+.249998608869975+(.25-n*u)/(.25-n*u+.249998608869975)),x=w+b[p].z;q.x=x*v*Math.cos(s),q.y=x*v*Math.sin(s),q.z=(l/i*w+b[p].z)*t,c.push(q)}return c},GEOtoGC:function(a,b,c){var d=this.getReferenceFrame(a);if("GD"==d)return this.GDtoGC(a,c);if("UTM"==d)return this.UTMtoGC(a,c);if("GC"==d){if(b.node){for(var e=new x3dom.fields.MFVec3f,f=0;f<c.length;++f){var g=new x3dom.fields.SFVec3f;g.x=c[f].x,g.y=c[f].y,g.z=c[f].z,e.push(g)}return e}return c}return x3dom.debug.logError("Unknown geoSystem: "+a[0]),new x3dom.fields.MFVec3f},OriginToGC:function(a){var b=a.node._vf.geoCoords,c=a.node._vf.geoSystem,d=new x3dom.fields.SFVec3f;d.x=b.x,d.y=b.y,d.z=b.z;var e=new x3dom.fields.MFVec3f;e.push(d);var f=this.GEOtoGC(c,a,e);return f[0]},GEOtoX3D:function(a,b,c){var d=this.GEOtoGC(a,b,c);if(b.node){var e=this.OriginToGC(b),f=x3dom.fields.SFMatrix4f.translation(e);f=f.inverse();for(var g=0;g<c.length;++g)d[g]=f.multMatrixPnt(d[g])}return d},getPoints:function(){return this.GEOtoX3D(this._vf.geoSystem,this._cf.geoOrigin,this._vf.point)}})),x3dom.registerNodeType("GeoElevationGrid","Geospatial",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.GeoElevationGrid.superClass.call(this,a),this.addField_MFString(a,"geoSystem",["GD","WE"]),this.addField_SFVec3d(a,"geoGridOrigin",0,0,0),this.addField_MFDouble(a,"height",0,0),this.addField_SFBool(a,"ccw",!0),this.addField_SFDouble(a,"creaseAngle",0),this.addField_SFInt32(a,"xDimension",0),this.addField_SFDouble(a,"xSpacing",1),this.addField_SFFloat(a,"yScale",1),this.addField_SFInt32(a,"zDimension",0),this.addField_SFDouble(a,"zSpacing",1),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.GeoOrigin),this.addField_SFBool(a,"lit",!0)},{nodeChanged:function(){var a=this._vf.geoSystem,b=this._cf.geoOrigin,c=this._vf.height,d=this._vf.yScale,e=this._vf.xDimension,f=this._vf.zDimension,g=this._vf.xSpacing,h=this._vf.zSpacing,i=this._vf.geoGridOrigin;c.length!==e*f&&x3dom.debug.logError("GeoElevationGrid: height.length("+c.length+") != x/zDimension("+e+"*"+f+")");for(var j=x3dom.nodeTypes.GeoCoordinate.prototype.isLogitudeFirst(a),k=this._vf.ccw,l=1/(e-1),m=1/(f-1),n=new x3dom.fields.MFVec3f,o=new x3dom.fields.MFVec2f,p=0;f>p;++p)for(var q=0;e>q;++q){var r=new x3dom.fields.SFVec2f(q*l,p*m);o.push(r);var s=new x3dom.fields.SFVec3f;j?(s.x=q*g,s.y=p*h):(s.x=p*h,s.y=q*g),s.z=c[p*e+q]*d,s=s.add(i),n.push(s)}for(var t=new x3dom.fields.MFInt32,p=0;f-1>p;p++)for(var q=0;e-1>q;q++){var u=q+p*e,v=q+p*e+1,w=q+(p+1)*e+1,x=q+(p+1)*e;k?(t.push(u),t.push(v),t.push(w),t.push(u),t.push(w),t.push(x)):(t.push(u),t.push(x),t.push(w),t.push(u),t.push(w),t.push(v))}var y=x3dom.nodeTypes.GeoCoordinate.prototype.GEOtoX3D(a,b,n);if(this._vf.creaseAngle<=x3dom.fields.Eps){var z=this;!function(){var a=new x3dom.fields.MFInt32,b=new x3dom.fields.MFVec3f,c=new x3dom.fields.MFVec3f;z.generateNonIndexedTriangleData(t,y,null,o,null,b,null,c,null);for(var d=0;d<b.length;++d)a.push(d);z._mesh._indices[0]=a.toGL(),z._mesh._positions[0]=b.toGL(),z._mesh._texCoords[0]=c.toGL()}(),this._mesh.calcNormals(0)}else this._mesh._indices[0]=t.toGL(),this._mesh._positions[0]=y.toGL(),this._mesh._texCoords[0]=o.toGL(),this._mesh.calcNormals(Math.PI);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},generateNonIndexedTriangleData:function(a,b,c,d,e,f,g,h,i){for(var j=0;j<a.length;j+=3){var k=a[j],l=a[j+1],m=a[j+2];if(b){var n=new x3dom.fields.SFVec3f,o=new x3dom.fields.SFVec3f,p=new x3dom.fields.SFVec3f;n.setValues(b[k]),o.setValues(b[l]),p.setValues(b[m]),f.push(n),f.push(o),f.push(p)}if(c){var q=new x3dom.fields.SFVec3f,r=new x3dom.fields.SFVec3f,s=new x3dom.fields.SFVec3f;q.setValues(c[k]),r.setValues(c[l]),s.setValues(c[m]),g.push(q),g.push(r),g.push(s)}if(d){var t=new x3dom.fields.SFVec2f,u=new x3dom.fields.SFVec2f,v=new x3dom.fields.SFVec2f;t.setValues(d[k]),u.setValues(d[l]),u.setValues(d[m]),h.push(t),h.push(u),h.push(v)}if(e){var w=new x3dom.fields.SFVec3f,x=new x3dom.fields.SFVec3f,y=new x3dom.fields.SFVec3f;w.setValues(d[k]),x.setValues(d[l]),x.setValues(d[m]),i.push(w),i.push(x),i.push(y)}}}})),x3dom.registerNodeType("GeoLOD","Geospatial",defineClass(x3dom.nodeTypes.X3DLODNode,function(a){x3dom.nodeTypes.GeoLOD.superClass.call(this,a),this.addField_MFString(a,"geoSystem",["GD","WE"]),this.addField_MFString(a,"rootUrl",[]),this.addField_MFString(a,"child1Url",[]),this.addField_MFString(a,"child2Url",[]),this.addField_MFString(a,"child3Url",[]),this.addField_MFString(a,"child4Url",[]),this.addField_SFFloat(a,"range",10),this.addField_SFString(a,"referenceBindableDescription",[]),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.X3DChildNode),this.addField_SFNode("rootNode",x3dom.nodeTypes.X3DChildNode),this.addField_SFNode("privateChild1Node",x3dom.nodeTypes.X3DChildNode),this.addField_SFNode("privateChild2Node",x3dom.nodeTypes.X3DChildNode),this.addField_SFNode("privateChild3Node",x3dom.nodeTypes.X3DChildNode),this.addField_SFNode("privateChild4Node",x3dom.nodeTypes.X3DChildNode),this.addField_SFNode("privateRootNode",x3dom.nodeTypes.X3DChildNode)})),x3dom.registerNodeType("GeoLocation","Geospatial",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.GeoLocation.superClass.call(this,a),this.addField_MFString(a,"geoSystem",["GD","WE"]),this.addField_SFVec3d(a,"geoCoords",0,0,0),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.X3DChildNode)})),x3dom.registerNodeType("GeoMetadata","Geospatial",defineClass(x3dom.nodeTypes.X3DInfoNode,function(a){x3dom.nodeTypes.GeoMetadata.superClass.call(this,a),this.addField_MFString(a,"url",[]),this.addField_MFNode("data",x3dom.nodeTypes.X3DInfoNode),this.addField_MFString(a,"summary",[])})),x3dom.registerNodeType("GeoOrigin","Geospatial",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.GeoOrigin.superClass.call(this,a),this.addField_MFString(a,"geoSystem",["GD","WE"]),this.addField_SFVec3d(a,"geoCoords",0,0,0),this.addField_SFBool(a,"rotateYUp",!1)})),x3dom.registerNodeType("GeoPositionInterpolator","Geospatial",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){x3dom.nodeTypes.GeoPositionInterpolator.superClass.call(this,a),this.addField_MFString(a,"geoSystem",["GD","WE"]),this.addField_MFVec3d(a,"keyValue",[]),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.X3DInterpolatorNode)})),x3dom.registerNodeType("GeoTransform","Geospatial",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.GeoTransform.superClass.call(this,a),this.addField_SFVec3d(a,"geoCenter",0,0,0),this.addField_SFRotation(a,"rotation",0,0,1,0),this.addField_SFVec3f(a,"scale",1,1,1),this.addField_SFRotation(a,"scaleOrientation",0,0,1,0),this.addField_SFVec3f(a,"translation",0,0,0),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.Transform),this.addField_MFString(a,"geoSystem",["GD","WE"])})),x3dom.registerNodeType("GeoViewpoint","Geospatial",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(a){x3dom.nodeTypes.GeoViewpoint.superClass.call(this,a),this.addField_MFString(a,"geoSystem",["GD","WE"]),this.addField_SFFloat(a,"fieldOfView",.785398),this.addField_SFRotation(a,"orientation",0,0,1,0),this.addField_SFVec3d(a,"position",0,0,1e5),this.addField_SFBool(a,"headlight",!0),this.addField_MFString(a,"navType","EXAMINE"),this.addField_SFFloat(a,"speedFactor",1),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.X3DViewpointNode)})),x3dom.registerNodeType("X3DPlanarGeometryNode","Geometry2D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.X3DPlanarGeometryNode.superClass.call(this,a)})),x3dom.registerNodeType("Arc2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,function(a){x3dom.nodeTypes.Arc2D.superClass.call(this,a),this.addField_SFFloat(a,"radius",1),this.addField_SFFloat(a,"startAngle",0),this.addField_SFFloat(a,"endAngle",1.570796),this.addField_SFFloat(a,"subdivision",32),this._mesh._primType="LINES";var b=this._vf.radius,c=this._vf.startAngle,d=this._vf.endAngle,e=2*Math.PI;c-=Math.floor(c/e)*e,d-=Math.floor(d/e)*e,c>=d&&(d+=e);var f="Arc2D_"+b+c+d;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[f])this._mesh=x3dom.geoCache[f];else{for(var g=this._vf.subdivision,h=(d-c)/g,i=c,j=0;g+1>=j;j++){var k=Math.cos(i)*b,l=Math.sin(i)*b;this._mesh._positions[0].push(k),this._mesh._positions[0].push(l),this._mesh._positions[0].push(0),i+=h}for(var m=0;g>m;m++)this._mesh._indices[0].push(m),this._mesh._indices[0].push(m+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[f]=this._mesh}},{fieldChanged:function(a){if("radius"==a||"subdivision"==a||"startAngle"==a||"endAngle"==a){this._mesh._positions[0]=[],this._mesh._indices[0]=[];var b=this._vf.radius,c=this._vf.startAngle,d=this._vf.endAngle,e=this._vf.subdivision,f=2*Math.PI;c-=Math.floor(c/f)*f,d-=Math.floor(d/f)*f,c>=d&&(d+=f);for(var g=(d-c)/e,h=c,i=0;e+1>=i;i++){var j=Math.cos(h)*b,k=Math.sin(h)*b;this._mesh._positions[0].push(j),this._mesh._positions[0].push(k),this._mesh._positions[0].push(0),h+=g}for(var l=0;e>l;l++)this._mesh._indices[0].push(l),this._mesh._indices[0].push(l+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a._dirty.indexes=!0,a.invalidateVolume()})}}})),x3dom.registerNodeType("ArcClose2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,function(a){x3dom.nodeTypes.ArcClose2D.superClass.call(this,a),this.addField_SFString(a,"closureType","PIE"),this.addField_SFFloat(a,"radius",1),this.addField_SFFloat(a,"startAngle",0),this.addField_SFFloat(a,"endAngle",1.570796),this.addField_SFFloat(a,"subdivision",32);var b=this._vf.radius,c=this._vf.startAngle,d=this._vf.endAngle,e=this._vf.subdivision,f=2*Math.PI;c-=Math.floor(c/f)*f,d-=Math.floor(d/f)*f,c>=d&&(d+=f);var g="ArcClose2D_"+b+c+d+this._vf.closureType;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[g])this._mesh=x3dom.geoCache[g];else{var h=(d-c)/e,i=c;if("PIE"==this._vf.closureType.toUpperCase()){this._mesh._positions[0].push(0),this._mesh._positions[0].push(0),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(.5),this._mesh._texCoords[0].push(.5);for(var j=0;e>=j;j++){var k=Math.cos(i)*b,l=Math.sin(i)*b;this._mesh._positions[0].push(k),this._mesh._positions[0].push(l),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((k+b)/(2*b)),this._mesh._texCoords[0].push((l+b)/(2*b)),i+=h}for(var m=1;e>=m;m++)this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(0),this._mesh._indices[0].push(m)}else{for(var j=0;e>=j;j++){var k=Math.cos(i)*b,l=Math.sin(i)*b;this._mesh._positions[0].push(k),this._mesh._positions[0].push(l),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((k+b)/(2*b)),this._mesh._texCoords[0].push((l+b)/(2*b)),i+=h}var k=(this._mesh._positions[0][0]+this._mesh._positions[0][this._mesh._positions[0].length-3])/2,l=(this._mesh._positions[0][1]+this._mesh._positions[0][this._mesh._positions[0].length-2])/2;this._mesh._positions[0].push(k),this._mesh._positions[0].push(l),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((k+b)/(2*b)),this._mesh._texCoords[0].push((l+b)/(2*b));for(var m=0;e>m;m++)this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(e+1),this._mesh._indices[0].push(m)}this._mesh._numTexComponents=2,this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[g]=this._mesh}},{fieldChanged:function(a){var b=this._vf.radius,c=this._vf.startAngle,d=this._vf.endAngle,e=this._vf.subdivision,f=2*Math.PI;c-=Math.floor(c/f)*f,d-=Math.floor(d/f)*f,c>=d&&(d+=f);var g=(d-c)/e,h=c;if("radius"===a){if(this._mesh._positions[0]=[],"PIE"==this._vf.closureType.toUpperCase()){this._mesh._positions[0].push(0),this._mesh._positions[0].push(0),this._mesh._positions[0].push(0);for(var i=0;e>=i;i++){var j=Math.cos(h)*b,k=Math.sin(h)*b;this._mesh._positions[0].push(j),this._mesh._positions[0].push(k),this._mesh._positions[0].push(0),h+=g}}else{for(var i=0;e>=i;i++){var j=Math.cos(h)*b,k=Math.sin(h)*b;this._mesh._positions[0].push(j),this._mesh._positions[0].push(k),this._mesh._positions[0].push(0),h+=g}var j=(this._mesh._positions[0][0]+this._mesh._positions[0][this._mesh._positions[0].length-3])/2,k=(this._mesh._positions[0][1]+this._mesh._positions[0][this._mesh._positions[0].length-2])/2;this._mesh._positions[0].push(j),this._mesh._positions[0].push(k),this._mesh._positions[0].push(0)}this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()})}else if("closureType"==a||"subdivision"==a||"startAngle"==a||"endAngle"==a){if(this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],"PIE"==this._vf.closureType.toUpperCase()){this._mesh._positions[0].push(0),this._mesh._positions[0].push(0),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(.5),this._mesh._texCoords[0].push(.5);
for(var i=0;e>=i;i++){var j=Math.cos(h)*b,k=Math.sin(h)*b;this._mesh._positions[0].push(j),this._mesh._positions[0].push(k),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((j+b)/(2*b)),this._mesh._texCoords[0].push((k+b)/(2*b)),h+=g}for(var l=1;e>=l;l++)this._mesh._indices[0].push(l+1),this._mesh._indices[0].push(0),this._mesh._indices[0].push(l)}else{for(var i=0;e>=i;i++){var j=Math.cos(h)*b,k=Math.sin(h)*b;this._mesh._positions[0].push(j),this._mesh._positions[0].push(k),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((j+b)/(2*b)),this._mesh._texCoords[0].push((k+b)/(2*b)),h+=g}var j=(this._mesh._positions[0][0]+this._mesh._positions[0][this._mesh._positions[0].length-3])/2,k=(this._mesh._positions[0][1]+this._mesh._positions[0][this._mesh._positions[0].length-2])/2;this._mesh._positions[0].push(j),this._mesh._positions[0].push(k),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((j+b)/(2*b)),this._mesh._texCoords[0].push((k+b)/(2*b));for(var l=0;e>l;l++)this._mesh._indices[0].push(l+1),this._mesh._indices[0].push(e+1),this._mesh._indices[0].push(l)}this._mesh._numTexComponents=2,this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a.setAllDirty()})}}})),x3dom.registerNodeType("Circle2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,function(a){x3dom.nodeTypes.Circle2D.superClass.call(this,a),this.addField_SFFloat(a,"radius",1),this.addField_SFFloat(a,"subdivision",32),this._mesh._primType="LINES";var b=this._vf.radius,c="Circle2D_"+b;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[c])this._mesh=x3dom.geoCache[c];else{for(var d=this._vf.subdivision,e=0;d>=e;e++){var f=e*(2*Math.PI/d),g=Math.cos(f)*b,h=Math.sin(f)*b;this._mesh._positions[0].push(g),this._mesh._positions[0].push(h),this._mesh._positions[0].push(0)}for(e=0;d>e;e++)this._mesh._indices[0].push(e),e+1==d?this._mesh._indices[0].push(0):this._mesh._indices[0].push(e+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[c]=this._mesh}},{fieldChanged:function(a){if("radius"==a||"subdivision"==a){var b=this._vf.radius,c=this._vf.subdivision;this._mesh._positions[0]=[],this._mesh._indices[0]=[];for(var d=0;c>=d;d++){var e=d*(2*Math.PI/c),f=Math.cos(e)*b,g=Math.sin(e)*b;this._mesh._positions[0].push(f),this._mesh._positions[0].push(g),this._mesh._positions[0].push(0)}for(d=0;c>d;d++)this._mesh._indices[0].push(d),d+1==c?this._mesh._indices[0].push(0):this._mesh._indices[0].push(d+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a._dirty.indexes=!0,a.invalidateVolume()})}}})),x3dom.registerNodeType("Disk2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,function(a){x3dom.nodeTypes.Disk2D.superClass.call(this,a),this.addField_SFFloat(a,"innerRadius",0),this.addField_SFFloat(a,"outerRadius",1),this.addField_SFFloat(a,"subdivision",32);var b=this._vf.innerRadius,c=this._vf.outerRadius,d="Disk2D_"+b+c;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[d])this._mesh=x3dom.geoCache[d];else{for(var e=this._vf.subdivision,f=0;e>=f;f++){var g=f*(2*Math.PI/e),h=Math.cos(g)*c,i=Math.sin(g)*c,j=Math.cos(g)*b,k=Math.sin(g)*b;this._mesh._positions[0].push(h),this._mesh._positions[0].push(i),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((h+c)/(2*c)),this._mesh._texCoords[0].push((i+c)/(2*c)),this._mesh._positions[0].push(j),this._mesh._positions[0].push(k),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((j+c)/(2*c)),this._mesh._texCoords[0].push((k+c)/(2*c))}for(f=0;2*e>f;f+=2)f==2*e-2?(this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f),this._mesh._indices[0].push(1),this._mesh._indices[0].push(1),this._mesh._indices[0].push(f),this._mesh._indices[0].push(0)):(this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f),this._mesh._indices[0].push(f+3),this._mesh._indices[0].push(f+3),this._mesh._indices[0].push(f),this._mesh._indices[0].push(f+2));this._mesh._numTexComponents=2,this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[d]=this._mesh}},{fieldChanged:function(a){if("innerRadius"==a||"outerRadius"==a||"subdivision"==a){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];for(var b=this._vf.innerRadius,c=this._vf.outerRadius,d=this._vf.subdivision,e=0;d>=e;e++){var f=e*(2*Math.PI/d),g=Math.cos(f)*c,h=Math.sin(f)*c,i=Math.cos(f)*b,j=Math.sin(f)*b;this._mesh._positions[0].push(g),this._mesh._positions[0].push(h),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((g+c)/(2*c)),this._mesh._texCoords[0].push((h+c)/(2*c)),this._mesh._positions[0].push(i),this._mesh._positions[0].push(j),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((i+c)/(2*c)),this._mesh._texCoords[0].push((j+c)/(2*c))}for(e=0;2*d>e;e+=2)e==2*d-2?(this._mesh._indices[0].push(e+1),this._mesh._indices[0].push(e),this._mesh._indices[0].push(1),this._mesh._indices[0].push(1),this._mesh._indices[0].push(e),this._mesh._indices[0].push(0)):(this._mesh._indices[0].push(e+1),this._mesh._indices[0].push(e),this._mesh._indices[0].push(e+3),this._mesh._indices[0].push(e+3),this._mesh._indices[0].push(e),this._mesh._indices[0].push(e+2));this._mesh._numTexComponents=2,this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a.setAllDirty()})}}})),x3dom.registerNodeType("Polyline2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,function(a){x3dom.nodeTypes.Polyline2D.superClass.call(this,a),this.addField_MFVec2f(a,"lineSegments",[]),this._mesh._primType="LINES";var b=0,c=0;this._vf.lineSegments.length&&(b=this._vf.lineSegments[0].x,c=this._vf.lineSegments[0].y);var d="Polyline2D_"+b+"-"+c;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[d])this._mesh=x3dom.geoCache[d];else{for(var e=0;e<this._vf.lineSegments.length;e++)b=this._vf.lineSegments[e].x,c=this._vf.lineSegments[e].y,this._mesh._positions[0].push(b),this._mesh._positions[0].push(c),this._mesh._positions[0].push(0);for(var f=0;f<this._vf.lineSegments.length-1;f++)this._mesh._indices[0].push(f),this._mesh._indices[0].push(f+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[d]=this._mesh}},{fieldChanged:function(a){if("lineSegments"==a){var b,c;this._mesh._positions[0]=[],this._mesh._indices[0]=[];for(var d=0;d<this._vf.lineSegments.length;d++)b=this._vf.lineSegments[d].x,c=this._vf.lineSegments[d].y,this._mesh._positions[0].push(b),this._mesh._positions[0].push(c),this._mesh._positions[0].push(0);for(var e=0;e<this._vf.lineSegments.length-1;e++)this._mesh._indices[0].push(e),this._mesh._indices[0].push(e+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a._dirty.indexes=!0,a.invalidateVolume()})}}})),x3dom.registerNodeType("Polypoint2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,function(a){x3dom.nodeTypes.Polypoint2D.superClass.call(this,a),this.addField_MFVec2f(a,"point",[]),this._mesh._primType="POINTS";var b=0,c=0;this._vf.point.length&&(b=this._vf.point[0].x,c=this._vf.point[0].y);var d="Polypoint2D_"+b+"-"+c;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[d])this._mesh=x3dom.geoCache[d];else{for(var e=0;e<this._vf.point.length;e++)b=this._vf.point[e].x,c=this._vf.point[e].y,this._mesh._positions[0].push(b),this._mesh._positions[0].push(c),this._mesh._positions[0].push(0);this._mesh._invalidate=!0,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[d]=this._mesh}},{fieldChanged:function(a){if("point"==a){this._mesh._positions[0]=[],this._mesh._indices[0]=[];for(var b=0;b<this._vf.point.length;b++){var c=this._vf.point[b].x,d=this._vf.point[b].y;this._mesh._positions[0].push(c),this._mesh._positions[0].push(d),this._mesh._positions[0].push(0)}this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()})}}})),x3dom.registerNodeType("Rectangle2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,function(a){x3dom.nodeTypes.Rectangle2D.superClass.call(this,a),this.addField_SFVec2f(a,"size",2,2),this.addField_SFVec2f(a,"subdivision",1,1);var b=this._vf.size.x,c=this._vf.size.y,d=this._vf.subdivision.x,e=this._vf.subdivision.y,f="Rectangle2D_"+b+"-"+c;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[f])this._mesh=x3dom.geoCache[f];else{var g=b/d,h=c/e;b/=2,c/=2;for(var i=0;d>=i;i++)for(var j=0;e>=j;j++)this._mesh._positions[0].push(i*g-b,j*h-c,0),this._mesh._normals[0].push(0,0,1),this._mesh._texCoords[0].push(i/d,j/e);for(var i=1;e>=i;i++)for(var j=0;d>j;j++)this._mesh._indices[0].push((i-1)*(d+1)+j+1),this._mesh._indices[0].push((i-1)*(d+1)+j),this._mesh._indices[0].push(i*(d+1)+j),this._mesh._indices[0].push((i-1)*(d+1)+j+1),this._mesh._indices[0].push(i*(d+1)+j),this._mesh._indices[0].push(i*(d+1)+j+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[f]=this._mesh}},{fieldChanged:function(a){if("size"==a){this._mesh._positions[0]=[];var b=this._vf.size,c=b.x/2,d=b.y/2,e=this._vf.subdivision.x,f=this._vf.subdivision.y,g=c/e,h=d/f;c/=2,d/=2;for(var i=0;e>=i;i++)for(var j=0;f>=j;j++)this._mesh._positions[0].push(i*g-c,j*h-d,0);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a.setAllDirty()})}else if("subdivision"==a){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var c=this._vf.size.x/2,d=this._vf.size.y/2,e=this._vf.subdivision.x,f=this._vf.subdivision.y,g=c/e,h=d/f;c/=2,d/=2;for(var i=0;e>=i;i++)for(var j=0;f>=j;j++)this._mesh._positions[0].push(i*g-c,j*h-d,0),this._mesh._normals[0].push(0,0,1),this._mesh._texCoords[0].push(i/e,j/f);for(var i=1;f>=i;i++)for(var j=0;e>j;j++)this._mesh._indices[0].push((i-1)*(e+1)+j+1),this._mesh._indices[0].push((i-1)*(e+1)+j),this._mesh._indices[0].push(i*(e+1)+j),this._mesh._indices[0].push((i-1)*(e+1)+j+1),this._mesh._indices[0].push(i*(e+1)+j),this._mesh._indices[0].push(i*(e+1)+j+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a.setAllDirty()})}}})),x3dom.registerNodeType("TriangleSet2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,function(a){x3dom.nodeTypes.TriangleSet2D.superClass.call(this,a),this.addField_MFVec2f(a,"vertices",[]),this.addField_MFVec2f(a,"lineSegments",[]);var b=0,c=0;this._vf.vertices.length&&(b=this._vf.vertices[0].x,c=this._vf.vertices[0].y);var d="TriangleSet2D_"+b+"-"+c;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[d])this._mesh=x3dom.geoCache[d];else{var e=0,f=0,g=0,h=0;this._vf.vertices.length&&(e=this._vf.vertices[0].x,f=this._vf.vertices[0].y,g=this._vf.vertices[0].x,h=this._vf.vertices[0].y);for(var i=0;i<this._vf.vertices.length;i++)this._vf.vertices[i].x<e&&(e=this._vf.vertices[i].x),this._vf.vertices[i].y<f&&(f=this._vf.vertices[i].y),this._vf.vertices[i].x>g&&(g=this._vf.vertices[i].x),this._vf.vertices[i].y>h&&(h=this._vf.vertices[i].y);for(var i=0;i<this._vf.vertices.length;i++)b=this._vf.vertices[i].x,c=this._vf.vertices[i].y,this._mesh._positions[0].push(b),this._mesh._positions[0].push(c),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((b-e)/(g-e)),this._mesh._texCoords[0].push((c-f)/(h-f));for(var j=0;j<this._vf.vertices.length;j+=3)this._mesh._indices[0].push(j),this._mesh._indices[0].push(j+2),this._mesh._indices[0].push(j+1);this._mesh._numTexComponents=2,this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[d]=this._mesh}},{fieldChanged:function(a){if("vertices"==a||"lineSegments"==a){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];for(var b=this._vf.vertices[0].x,c=this._vf.vertices[0].y,d=this._vf.vertices[0].x,e=this._vf.vertices[0].y,f=0;f<this._vf.vertices.length;f++)this._vf.vertices[f].x<b&&(b=this._vf.vertices[f].x),this._vf.vertices[f].y<c&&(c=this._vf.vertices[f].y),this._vf.vertices[f].x>d&&(d=this._vf.vertices[f].x),this._vf.vertices[f].y>e&&(e=this._vf.vertices[f].y);for(var f=0;f<this._vf.vertices.length;f++){var g=this._vf.vertices[f].x,h=this._vf.vertices[f].y;this._mesh._positions[0].push(g),this._mesh._positions[0].push(h),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((g-b)/(d-b)),this._mesh._texCoords[0].push((h-c)/(e-c))}for(var i=0;i<this._vf.vertices.length;i+=3)this._mesh._indices[0].push(i),this._mesh._indices[0].push(i+2),this._mesh._indices[0].push(i+1);this._mesh._numTexComponents=2,this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(a){a.setAllDirty()})}}})),x3dom.registerNodeType("X3DVolumeDataNode","VolumeRendering",defineClass(x3dom.nodeTypes.X3DShapeNode,function(a){x3dom.nodeTypes.X3DVolumeDataNode.superClass.call(this,a),this.addField_SFVec3f(a,"dimensions",1,1,1),this.addField_SFNode("voxels",x3dom.nodeTypes.Texture),x3dom.debug.logWarning("VolumeRendering component NYI!!!")},{getTextureSize:function(a){var b,c={w:0,h:0,valid:!1},d=this._webgl?this._webgl.texture:null,e=a&&d?d.length:0;for(b=0;e>b;b++)if(a==d[b].node&&d[b].texture){c.w=d[b].texture.width,c.h=d[b].texture.height,c.w&&c.h&&(c.valid=!0);break}return c}})),x3dom.registerNodeType("X3DVolumeRenderStyleNode","VolumeRendering",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DVolumeRenderStyleNode.superClass.call(this,a),this.addField_SFBool(a,"enabled",!0),this.preamble="#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n"},{vertexShaderText:function(){var a="attribute vec3 position;\nattribute vec3 color;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec3 vertexColor;\nvarying vec4 vertexPosition;\n\nvoid main()\n{\n  vertexColor = color;\n  vertexPosition = modelViewProjectionMatrix * vec4(position, 1.0);\n  gl_Position = vertexPosition;\n}";return a},defaultUniformsShaderText:function(a,b,c){var d="uniform sampler2D uBackCoord;\nuniform sampler2D uVolData;\nuniform mat4 normalMatrix;\nvarying vec3 vertexColor;\nvarying vec4 vertexPosition;\nconst float Steps = 60.0;\nconst float numberOfSlices = "+a.toPrecision(5)+";\n"+"const float slicesOverX = "+b.toPrecision(5)+";\n"+"const float slicesOverY = "+c.toPrecision(5)+";\n";return d},texture3DFunctionShaderText:"vec4 cTexture3D(sampler2D vol, vec3 volpos, float nS, float nX, float nY)\n{\n  float s1,s2;\n  float dx1,dy1;\n  float dx2,dy2;\n  vec2 texpos1,texpos2;\n  s1 = floor(volpos.z*nS);\n  s2 = s1+1.0;\n  dx1 = fract(s1/nX);\n  dy1 = floor(s1/nY)/nY;\n  dx2 = fract(s2/nX);\n  dy2 = floor(s2/nY)/nY;\n  texpos1.x = dx1+(volpos.x/nX);\n  texpos1.y = dy1+(volpos.y/nY);\n  texpos2.x = dx2+(volpos.x/nX);\n  texpos2.y = dy2+(volpos.y/nY);\n  return mix( texture2D(vol,texpos1), texture2D(vol,texpos2), (volpos.z*nS)-s1);\n}\n\n",lightEquationShaderText:"void lighting(in float lType, in vec3 lLocation, in vec3 lDirection, in vec3 lColor, in vec3 lAttenuation, in float lRadius, in float lIntensity, in float lAmbientIntensity, in float lBeamWidth, in float lCutOffAngle, in vec3 N, in vec3 V, inout vec3 ambient, inout vec3 diffuse, inout vec3 specular)\n{\n   vec3 L;\n   float spot = 1.0, attentuation = 0.0;\n   if(lType == 0.0) {\n       L = -normalize(lDirection);\n       V = normalize(V);\n       attentuation = 1.0;\n   } else{\n       L = (lLocation - (-V));\n       float d = length(L);\n       L = normalize(L);\n       V = normalize(V);\n       if(lRadius == 0.0 || d <= lRadius) {\n           attentuation = 1.0 / max(lAttenuation.x + lAttenuation.y * d + lAttenuation.z * (d * d), 1.0);\n       }\n       if(lType == 2.0) {\n           float spotAngle = acos(max(0.0, dot(-L, normalize(lDirection))));\n           if(spotAngle >= lCutOffAngle) spot = 0.0;\n           else if(spotAngle <= lBeamWidth) spot = 1.0;\n           else spot = (spotAngle - lCutOffAngle ) / (lBeamWidth - lCutOffAngle);\n       }\n   }\n   vec3  H = normalize( L + V );\n   float NdotL = max(0.0, dot(L, N));\n   float NdotH = max(0.0, dot(H, N));\n   float ambientFactor  = lAmbientIntensity;\n   float diffuseFactor  = lIntensity * NdotL;\n   float specularFactor = lIntensity * pow(NdotH,128.0);\n   ambient  += lColor * ambientFactor * attentuation * spot;\n   diffuse  += lColor * diffuseFactor * attentuation * spot;\n   specular += lColor * specularFactor * attentuation * spot;\n}\n",normalFunctionShaderText:function(){return this._cf.surfaceNormals.node?"vec4 getNormal(vec3 pos, float nS, float nX, float nY) {\n   vec4 n = cTexture3D(uSurfaceNormals, pos, nS, nX, nY);\n   n.xyz = (2.0*n.xyz)-1.0;\n   n.xyz = (normalMatrix * vec4(n.xyz, 0.0)).xyz;\n   n.a = length(n.xyz);\n   n.xyz = normalize(n.xyz);\n   return n;\n}\n\n":"vec4 getNormal(vec3 voxPos, float nS, float nX, float nY){\n   float v0 = cTexture3D(uVolData, voxPos + vec3(offset.x, 0, 0), nS, nX, nY).r;\n   float v1 = cTexture3D(uVolData, voxPos - vec3(offset.x, 0, 0), nS, nX, nY).r;\n   float v2 = cTexture3D(uVolData, voxPos + vec3(0, offset.y, 0), nS, nX, nY).r;\n   float v3 = cTexture3D(uVolData, voxPos - vec3(0, offset.y, 0), nS, nX, nY).r;\n   float v4 = cTexture3D(uVolData, voxPos + vec3(0, 0, offset.z), nS, nX, nY).r;\n   float v5 = cTexture3D(uVolData, voxPos - vec3(0, 0, offset.z), nS, nX, nY).r;\n   vec3 grad = (normalMatrix * vec4((v0-v1)/2.0, (v2-v3)/2.0, (v4-v5)/2.0, 0.0)).xyz;\n   return vec4(normalize(grad), length(grad));\n}\n\n"},defaultLoopFragmentShaderText:function(a,b){var c="void main()\n{\n  vec2 texC = vertexPosition.xy/vertexPosition.w;\n  texC = 0.5*texC + 0.5;\n  vec4 backColor = texture2D(uBackCoord,texC);\n  vec3 dir = backColor.rgb - vertexColor.rgb;\n  vec3 pos = vertexColor;\n  vec4 accum  = vec4(0.0, 0.0, 0.0, 0.0);\n  vec4 sample = vec4(0.0, 0.0, 0.0, 0.0);\n  vec4 value  = vec4(0.0, 0.0, 0.0, 0.0);\n";x3dom.nodeTypes.X3DLightNode.lightID>0&&(c+="  vec3 ambient = vec3(0.0, 0.0, 0.0);\n  vec3 diffuse = vec3(0.0, 0.0, 0.0);\n  vec3 specular = vec3(0.0, 0.0, 0.0);\n"),c+="  float cont = 0.0;\n  vec3 step = dir/Steps;\n",c+=x3dom.nodeTypes.X3DLightNode.lightID>0?"  float lightFactor = 1.0;\n":"  float lightFactor = 1.2;\n",c+="  float opacityFactor = 6.0;\n  for(float i = 0.0; i < Steps; i+=1.0)\n  {\n    value = cTexture3D(uVolData,pos,numberOfSlices,slicesOverX,slicesOverY);\n    value = vec4(value.rgb,(0.299*value.r)+(0.587*value.g)+(0.114*value.b));\n    vec4 grad = getNormal(pos,numberOfSlices,slicesOverX,slicesOverY);\n";for(var d=0;d<x3dom.nodeTypes.X3DLightNode.lightID;d++)c+="    lighting(light"+d+"_Type, "+"light"+d+"_Location, "+"light"+d+"_Direction, "+"light"+d+"_Color, "+"light"+d+"_Attenuation, "+"light"+d+"_Radius, "+"light"+d+"_Intensity, "+"light"+d+"_AmbientIntensity, "+"light"+d+"_BeamWidth, "+"light"+d+"_CutOffAngle, "+"grad.xyz, dir, ambient, diffuse, specular);\n";return c+=a,x3dom.nodeTypes.X3DLightNode.lightID>0&&(c+=b),c+="    //Process the volume sample\n    sample.a = value.a * opacityFactor * (1.0/Steps);\n    sample.rgb = value.rgb * sample.a * lightFactor ;\n    accum.rgb += (1.0 - accum.a) * sample.rgb;\n    accum.a += (1.0 - accum.a) * sample.a;\n    //advance the current position\n    pos.xyz += step;\n    //break if the position is greater than <1, 1, 1>\n    if(pos.x > 1.0 || pos.y > 1.0 || pos.z > 1.0 || accum.a>=1.0)\n      break;\n  }\n  gl_FragColor = accum;\n}"}})),x3dom.registerNodeType("X3DComposableVolumeRenderStyleNode","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeRenderStyleNode,function(a){x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode.superClass.call(this,a),this.addField_SFNode("surfaceNormals",x3dom.nodeTypes.X3DTexture3DNode)},{defaultUniformsShaderText:function(a,b,c){var d="uniform sampler2D uBackCoord;\nuniform sampler2D uVolData;\nuniform mat4 normalMatrix;\n";null!=this._cf.surfaceNormals.node&&(d+="uniform sampler2D uSurfaceNormals;\n"),d+="varying vec3 vertexColor;\nvarying vec4 vertexPosition;\nconst float Steps = 60.0;\nconst float numberOfSlices = "+a.toPrecision(5)+";\n"+"const float slicesOverX = "+b.toPrecision(5)+";\n"+"const float slicesOverY = "+c.toPrecision(5)+";\n"+"const vec3 offset = vec3(0.5/512.0, 0.5/512.0, 0.5/96.0);\n";for(var e=x3dom.nodeTypes.X3DLightNode.lightID,f=0;e>f;f++)d+="uniform float light"+f+"_On;\n"+"uniform float light"+f+"_Type;\n"+"uniform vec3  light"+f+"_Location;\n"+"uniform vec3  light"+f+"_Direction;\n"+"uniform vec3  light"+f+"_Color;\n"+"uniform vec3  light"+f+"_Attenuation;\n"+"uniform float light"+f+"_Radius;\n"+"uniform float light"+f+"_Intensity;\n"+"uniform float light"+f+"_AmbientIntensity;\n"+"uniform float light"+f+"_BeamWidth;\n"+"uniform float light"+f+"_CutOffAngle;\n"+"uniform float light"+f+"_ShadowIntensity;\n";return d}})),x3dom.registerNodeType("BlendedVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,function(a){x3dom.nodeTypes.BlendedVolumeStyle.superClass.call(this,a),this.addField_SFNode("renderStyle",x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode),this.addField_SFNode("voxels",x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode),this.addField_SFFloat(a,"weightConstant1",.5),this.addField_SFFloat(a,"weightConstant2",.5),this.addField_SFString(a,"weightFunction1","CONSTANT"),this.addField_SFString(a,"weightFunction2","CONSTANT"),this.addField_SFNode("weightTransferFunction1",x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode),this.addField_SFNode("weightTransferFunction2",x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode)})),x3dom.registerNodeType("BoundaryEnhancementVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,function(a){x3dom.nodeTypes.BoundaryEnhancementVolumeStyle.superClass.call(this,a),this.addField_SFFloat(a,"retainedOpacity",1),this.addField_SFFloat(a,"boundaryOpacity",0),this.addField_SFFloat(a,"opacityFactor",1)})),x3dom.registerNodeType("CartoonVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,function(a){x3dom.nodeTypes.CartoonVolumeStyle.superClass.call(this,a),this.addField_SFColor(a,"parallelColor",0,0,0),this.addField_SFColor(a,"orthogonalColor",1,1,1),this.addField_SFInt32(a,"colorSteps",4)})),x3dom.registerNodeType("ComposedVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,function(a){x3dom.nodeTypes.ComposedVolumeStyle.superClass.call(this,a),this.addField_SFBool(a,"ordered",!1),this.addField_MFNode("renderStyle",x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode)})),x3dom.registerNodeType("EdgeEnhancementVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,function(a){x3dom.nodeTypes.EdgeEnhancementVolumeStyle.superClass.call(this,a),this.addField_SFColor(a,"edgeColor",0,0,0),this.addField_SFFloat(a,"gradientThreshold",.4)})),x3dom.registerNodeType("ISOSurfaceVolumeData","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeDataNode,function(a){x3dom.nodeTypes.ISOSurfaceVolumeData.superClass.call(this,a),this.addField_MFNode("renderStyle",x3dom.nodeTypes.X3DVolumeRenderStyleNode),this.addField_SFNode("gradients",x3dom.nodeTypes.X3DTexture3DNode),this.addField_MFFloat(a,"surfaceValues",[]),this.addField_SFFloat(a,"contourStepSize",0),this.addField_SFFloat(a,"surfaceTolerance",0)})),x3dom.registerNodeType("MPRVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,function(a){x3dom.nodeTypes.MPRVolumeStyle.superClass.call(this,a),this.addField_SFVec3f(a,"originLine",1,1,0),this.addField_SFVec3f(a,"finalLine",0,1,0),this.addField_SFFloat(a,"positionLine",.2),this.uniformVec3fOriginLine=new x3dom.nodeTypes.Uniform(a),this.uniformVec3fFinalLine=new x3dom.nodeTypes.Uniform(a),this.uniformFloatPosition=new x3dom.nodeTypes.Uniform(a)},{fieldChanged:function(a){("originLine"==a||"finalLine"==a||"positionLine"==a)&&(this.uniformFloatPosition._vf.value=this._vf.positionLine,this.uniformFloatPosition.fieldChanged("value"))},uniforms:function(){var a=[];return this.uniformVec3fOriginLine._vf.name="originLine",this.uniformVec3fOriginLine._vf.type="SFVec3f",this.uniformVec3fOriginLine._vf.value=this._vf.originLine.toString(),a.push(this.uniformVec3fOriginLine),this.uniformVec3fFinalLine._vf.name="finalLine",this.uniformVec3fFinalLine._vf.type="SFVec3f",this.uniformVec3fFinalLine._vf.value=this._vf.finalLine.toString(),a.push(this.uniformVec3fFinalLine),this.uniformFloatPosition._vf.name="positionLine",this.uniformFloatPosition._vf.type="SFFloat",this.uniformFloatPosition._vf.value=this._vf.positionLine,a.push(this.uniformFloatPosition),a},styleUniformsShaderText:function(){return"uniform vec3 originLine;\nuniform vec3 finalLine;\nuniform float positionLine;\n"},fragmentShaderText:function(a,b,c){var d=this.preamble+this.defaultUniformsShaderText(a,b,c)+this.styleUniformsShaderText()+this.texture3DFunctionShaderText+"void main()\n"+"{\n"+"  vec2 texC = vertexPosition.xy/vertexPosition.w;\n"+"  texC = 0.5*texC + 0.5;\n"+"  vec4 backColor = texture2D(uBackCoord,texC);\n"+"  vec3 dir =  backColor.xyz -vertexColor.xyz;\n"+"  vec3 normalPlane = finalLine-originLine;\n"+"  vec3 pointLine = normalPlane*positionLine+originLine;\n"+"  float d = dot(pointLine-vertexColor.xyz,normalPlane)/dot(dir,normalPlane);\n"+"  vec4 color = vec4(0.0,0.0,0.0,0.0);\n"+"  vec3 pos = d*dir+vertexColor.rgb;\n"+"  if (!(pos.x > 1.0 || pos.y > 1.0 || pos.z > 1.0 || pos.x<0.0 || pos.y<0.0 || pos.z<0.0)){\n"+"    color = vec4(cTexture3D(uVolData,pos.rgb,numberOfSlices,slicesOverX,slicesOverY).rgb,1.0);\n"+"  }\n"+"  gl_FragColor = color;\n"+"}";return d}})),x3dom.registerNodeType("OpacityMapVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,function(a){x3dom.nodeTypes.OpacityMapVolumeStyle.superClass.call(this,a),this.addField_SFNode("transferFunction",x3dom.nodeTypes.Texture),this.addField_SFString(a,"type","simple"),this.addField_SFFloat(a,"opacityFactor",6),this.addField_SFFloat(a,"lightFactor",1.2),this.uniformFloatOpacityFactor=new x3dom.nodeTypes.Uniform(a),this.uniformFloatLightFactor=new x3dom.nodeTypes.Uniform(a),this.uniformSampler2DTransferFunction=new x3dom.nodeTypes.Uniform(a)},{uniforms:function(){var a=[];return this._cf.transferFunction.node&&(this.uniformSampler2DTransferFunction._vf.name="uTransferFunction",this.uniformSampler2DTransferFunction._vf.type="SFInt32",this.uniformSampler2DTransferFunction._vf.value=2,a.push(this.uniformSampler2DTransferFunction)),this.uniformFloatOpacityFactor._vf.name="uOpacityFactor",this.uniformFloatOpacityFactor._vf.type="SFFloat",this.uniformFloatOpacityFactor._vf.value=this._vf.opacityFactor,a.push(this.uniformFloatOpacityFactor),this.uniformFloatLightFactor._vf.name="uLightFactor",this.uniformFloatLightFactor._vf.type="SFFloat",this.uniformFloatLightFactor._vf.value=this._vf.lightFactor,a.push(this.uniformFloatLightFactor),a},textures:function(){var a=[],b=this._cf.transferFunction.node;return b&&(b._vf.repeatS=!1,b._vf.repeatT=!1,a.push(b)),a},styleUniformsShaderText:function(){var a="uniform float uOpacityFactor;\nuniform float uLightFactor;\n";return this._cf.transferFunction.node&&(a+="uniform sampler2D uTransferFunction;\n"),a},inlineStyleShaderText:function(){var a="    opacityFactor = uOpacityFactor;\n    lightFactor = uLightFactor;\n";return this._cf.transferFunction.node&&(a+="    value = texture2D(uTransferFunction,vec2(value.r,0.5));\n"),a},lightAssigment:function(){return"value.rgb = ambient*value.rgb + diffuse*value.rgb + specular;\n"},fragmentShaderText:function(a,b,c){var d=this.preamble+this.defaultUniformsShaderText(a,b,c)+this.styleUniformsShaderText()+this.texture3DFunctionShaderText+this.normalFunctionShaderText()+this.lightEquationShaderText+this.defaultLoopFragmentShaderText(this.inlineStyleShaderText(),this.lightAssigment());return d}})),x3dom.registerNodeType("ProjectionVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeRenderStyleNode,function(a){x3dom.nodeTypes.ProjectionVolumeStyle.superClass.call(this,a),this.addField_SFFloat(a,"intensityThreshold",0),this.addField_SFString(a,"type","MAX"),this.uniformIntensityThreshold=new x3dom.nodeTypes.Uniform(a),this.uniformType=new x3dom.nodeTypes.Uniform(a)},{uniforms:function(){var a=[],b={max:0,min:1,average:2};return this.uniformIntensityThreshold._vf.name="uIntensityThreshold",this.uniformIntensityThreshold._vf.type="SFFloat",this.uniformIntensityThreshold._vf.value=this._vf.intensityThreshold,a.push(this.uniformIntensityThreshold),this.uniformType._vf.name="uType",this.uniformType._vf.type="SFInt32",this.uniformType._vf.value=b[this._vf.type.toLowerCase()],a.push(this.uniformType),a},styleUniformsShaderText:function(){return"uniform int uType;\nuniform float uIntensityThreshold;\n"},fragmentShaderText:function(a,b,c){var d=this.preamble+this.defaultUniformsShaderText(a,b,c)+this.styleUniformsShaderText()+this.texture3DFunctionShaderText+"void main()\n"+"{\n"+"  vec2 texC = vertexPosition.xy/vertexPosition.w;\n"+"  texC = 0.5*texC + 0.5;\n"+"  vec4 backColor = texture2D(uBackCoord,texC);\n"+"  vec3 dir = backColor.rgb - vertexColor.rgb;\n"+"  vec3 pos = vertexColor;\n"+"  vec4 accum  = vec4(0.0, 0.0, 0.0, 0.0);\n"+"  vec4 sample = vec4(0.0, 0.0, 0.0, 0.0);\n"+"  vec4 value  = vec4(0.0, 0.0, 0.0, 0.0);\n"+"  vec4 color  = vec4(0.0);\n";switch(d+="max"===this._vf.type.toLowerCase()?"vec2 previous_value = vec2(0.0);\n":"vec2 previous_value = vec2(1.0);\n",d+="  float cont = 0.0;\n  vec3 step = dir/Steps;\n  const float lightFactor = 1.3;\n  const float opacityFactor = 3.0;\n  for(float i = 0.0; i < Steps; i+=1.0)\n  {\n    value = cTexture3D(uVolData,pos,numberOfSlices,slicesOverX,slicesOverY);\n    value = vec4(value.rgb,(0.299*value.r)+(0.587*value.g)+(0.114*value.b));\n    //Process the volume sample\n    sample.a = value.a * opacityFactor * (1.0/Steps);\n    sample.rgb = value.rgb * sample.a * lightFactor;\n    accum.a += (1.0-accum.a)*sample.a;\n",this._vf.type.toLowerCase()){case"max":d+="if(value.r > uIntensityThreshold && value.r <= previous_value.x){\n   break;\n}\ncolor.rgb = vec3(max(value.r, previous_value.x));\ncolor.a = (value.r > previous_value.x) ? accum.a : previous_value.y;\n";
break;case"min":d+="if(value.r < uIntensityThreshold && value.r >= previous_value.x){\n   break;\n}\ncolor.rgb = vec3(min(value.r, previous_value.x));\ncolor.a = (value.r < previous_value.x) ? accum.a : previous_value.y;\n";break;case"average":d+="color.rgb += (1.0 - accum.a) * sample.rgb;\ncolor.a = accum.a;\n"}return d+="    //update the previous value and keeping the accumulated alpha\n    previous_value.x = color.r;\n    previous_value.y = accum.a;\n    //advance the current position\n    pos.xyz += step;\n    //break if the position is greater than <1, 1, 1>\n    if(pos.x > 1.0 || pos.y > 1.0 || pos.z > 1.0 || accum.a>=1.0){\n","average"==this._vf.type.toLowerCase()&&(d+="     if((i > 0.0) && (i < Steps-1.0)){\ncolor.rgb = color.rgb/i;\n}\n"),d+="      break;\n    }\n }\n gl_FragColor = color;\n}"}})),x3dom.registerNodeType("SegmentedVolumeData","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeDataNode,function(a){x3dom.nodeTypes.SegmentedVolumeData.superClass.call(this,a),this.addField_MFNode("renderStyle",x3dom.nodeTypes.X3DVolumeDataNode),this.addField_SFNode("segmentIdentifiers",x3dom.nodeTypes.X3DVolumeDataNode),this.addField_MFBoolean(a,"segmentEnabled",[])})),x3dom.registerNodeType("ShadedVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,function(a){x3dom.nodeTypes.ShadedVolumeStyle.superClass.call(this,a),this.addField_SFNode("material",x3dom.nodeTypes.X3DMaterialNode),this.addField_SFBool(a,"lighting",!1),this.addField_SFBool(a,"shadows",!1),this.addField_SFString(a,"phaseFunction","Henyey-Greenstein")})),x3dom.registerNodeType("SilhouetteEnhancementVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,function(a){x3dom.nodeTypes.SilhouetteEnhancementVolumeStyle.superClass.call(this,a),this.addField_SFFloat(a,"silhouetteBoundaryOpacity",0),this.addField_SFFloat(a,"silhouetteRetainedOpacity",1),this.addField_SFFloat(a,"silhouetteSharpness",.5)})),x3dom.registerNodeType("StippleVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeRenderStyleNode,function(a){x3dom.nodeTypes.StippleVolumeStyle.superClass.call(this,a),this.addField_SFFloat(a,"distanceFactor",1),this.addField_SFFloat(a,"interiorFactor",1),this.addField_SFFloat(a,"lightingFactor",1),this.addField_SFFloat(a,"gradientThreshold",.4),this.addField_SFFloat(a,"gradientRetainedOpacity",1),this.addField_SFFloat(a,"gradientBoundaryOpacity",0),this.addField_SFFloat(a,"gradientOpacityFactor",1),this.addField_SFFloat(a,"silhouetteRetainedOpacity",1),this.addField_SFFloat(a,"silhouetteBoundaryOpacity",0),this.addField_SFFloat(a,"silhouetteOpacityFactor",1),this.addField_SFFloat(a,"resolutionFactor",1)})),x3dom.registerNodeType("ToneMappedVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,function(a){x3dom.nodeTypes.ToneMappedVolumeStyle.superClass.call(this,a),this.addField_SFColor(a,"coolColor",0,0,1),this.addField_SFColor(a,"warmColor",1,1,0)})),x3dom.registerNodeType("VolumeData","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeDataNode,function(a){x3dom.nodeTypes.VolumeData.superClass.call(this,a),this.addField_SFNode("renderStyle",x3dom.nodeTypes.X3DVolumeRenderStyleNode),this.vrcMultiTexture=new x3dom.nodeTypes.MultiTexture(a),this.vrcRenderTexture=new x3dom.nodeTypes.RenderedTexture(a),this.vrcVolumeTexture=null,this.vrcBackCubeShape=new x3dom.nodeTypes.Shape(a),this.vrcBackCubeAppearance=new x3dom.nodeTypes.Appearance,this.vrcBackCubeGeometry=new x3dom.nodeTypes.Box(a),this.vrcBackCubeShader=new x3dom.nodeTypes.ComposedShader(a),this.vrcBackCubeShaderVertex=new x3dom.nodeTypes.ShaderPart(a),this.vrcBackCubeShaderFragment=new x3dom.nodeTypes.ShaderPart(a),this.vrcFrontCubeShader=new x3dom.nodeTypes.ComposedShader(a),this.vrcFrontCubeShaderVertex=new x3dom.nodeTypes.ShaderPart(a),this.vrcFrontCubeShaderFragment=new x3dom.nodeTypes.ShaderPart(a),this.vrcFrontCubeShaderFieldBackCoord=new x3dom.nodeTypes.Field(a),this.vrcFrontCubeShaderFieldVolData=new x3dom.nodeTypes.Field(a)},{nodeChanged:function(){if(!this._cf.appearance.node){var a;if(this.addChild(x3dom.nodeTypes.Appearance.defaultNode()),this.vrcBackCubeShaderVertex._vf.type="vertex",this.vrcBackCubeShaderVertex._vf.url[0]="attribute vec3 position;\nattribute vec3 color;\nvarying vec3 fragColor;\nuniform mat4 modelViewProjectionMatrix;\n\nvoid main(void) {\n    fragColor = color;\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}\n",this.vrcBackCubeShaderFragment._vf.type="fragment",this.vrcBackCubeShaderFragment._vf.url[0]="#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying vec3 fragColor;\n\nvoid main(void) {\n    gl_FragColor = vec4(fragColor, 1.0);\n}\n",this.vrcBackCubeShader.addChild(this.vrcBackCubeShaderFragment,"parts"),this.vrcBackCubeShaderFragment.nodeChanged(),this.vrcBackCubeShader.addChild(this.vrcBackCubeShaderVertex,"parts"),this.vrcBackCubeShaderVertex.nodeChanged(),this.vrcBackCubeAppearance.addChild(this.vrcBackCubeShader),this.vrcBackCubeShader.nodeChanged(),this.vrcRenderTexture._vf.update="always",this.vrcRenderTexture._vf.dimensions=[500,500,4],this.vrcRenderTexture._vf.repeatS=!1,this.vrcRenderTexture._vf.repeatT=!1,this.vrcRenderTexture._nameSpace=this._nameSpace,this.vrcBackCubeGeometry._vf.size=new x3dom.fields.SFVec3f(this._vf.dimensions.x,this._vf.dimensions.y,this._vf.dimensions.z),this.vrcBackCubeGeometry._vf.ccw=!1,this.vrcBackCubeGeometry._vf.solid=!0,this.vrcBackCubeGeometry.fieldChanged("size"),this.vrcBackCubeShape.addChild(this.vrcBackCubeGeometry),this.vrcBackCubeGeometry.nodeChanged(),this.vrcBackCubeShape.addChild(this.vrcBackCubeAppearance),this.vrcBackCubeAppearance.nodeChanged(),this.vrcRenderTexture.addChild(this.vrcBackCubeShape,"scene"),this.vrcBackCubeShape.nodeChanged(),this.vrcVolumeTexture=this._cf.voxels.node,this.vrcVolumeTexture._vf.repeatS=!1,this.vrcVolumeTexture._vf.repeatT=!1,this.vrcMultiTexture._nameSpace=this._nameSpace,this.vrcMultiTexture.addChild(this.vrcRenderTexture,"texture"),this.vrcRenderTexture.nodeChanged(),this.vrcMultiTexture.addChild(this.vrcVolumeTexture,"texture"),this.vrcVolumeTexture.nodeChanged(),this._cf.renderStyle.node.textures){var b=this._cf.renderStyle.node.textures();for(a=0;a<b.length;a++)this.vrcMultiTexture.addChild(b[a],"texture"),this.vrcVolumeTexture.nodeChanged()}this._cf.appearance.node.addChild(this.vrcMultiTexture),this.vrcMultiTexture.nodeChanged(),this.vrcFrontCubeShaderVertex._vf.type="vertex",this.vrcFrontCubeShaderVertex._vf.url[0]=this._cf.renderStyle.node.vertexShaderText(),this.vrcFrontCubeShaderFragment._vf.type="fragment",this.vrcFrontCubeShaderFragment._vf.url[0]=this._cf.renderStyle.node.fragmentShaderText(this.vrcVolumeTexture._vf.numberOfSlices,this.vrcVolumeTexture._vf.slicesOverX,this.vrcVolumeTexture._vf.slicesOverY),this.vrcFrontCubeShader.addChild(this.vrcFrontCubeShaderVertex,"parts"),this.vrcFrontCubeShaderVertex.nodeChanged(),this.vrcFrontCubeShader.addChild(this.vrcFrontCubeShaderFragment,"parts"),this.vrcFrontCubeShaderFragment.nodeChanged(),this.vrcFrontCubeShaderFieldBackCoord._vf.name="uBackCoord",this.vrcFrontCubeShaderFieldBackCoord._vf.type="SFInt32",this.vrcFrontCubeShaderFieldBackCoord._vf.value=0,this.vrcFrontCubeShaderFieldVolData._vf.name="uVolData",this.vrcFrontCubeShaderFieldVolData._vf.type="SFInt32",this.vrcFrontCubeShaderFieldVolData._vf.value=1,this.vrcFrontCubeShader.addChild(this.vrcFrontCubeShaderFieldBackCoord,"fields"),this.vrcFrontCubeShaderFieldBackCoord.nodeChanged(),this.vrcFrontCubeShader.addChild(this.vrcFrontCubeShaderFieldVolData,"fields"),this.vrcFrontCubeShaderFieldVolData.nodeChanged();var c=this._cf.renderStyle.node.uniforms();for(a=0;a<c.length;a++)this.vrcFrontCubeShader.addChild(c[a],"fields");this._cf.appearance.node.addChild(this.vrcFrontCubeShader),this.vrcFrontCubeShader.nodeChanged(),this._cf.appearance.node.nodeChanged()}this._cf.geometry.node||(this.addChild(new x3dom.nodeTypes.Box),this._cf.geometry.node._vf.hasHelperColors=!0,this._cf.geometry.node._vf.size=new x3dom.fields.SFVec3f(this._vf.dimensions.x,this._vf.dimensions.y,this._vf.dimensions.z),this._cf.geometry.node.fieldChanged("hasHelperColors"),this._cf.geometry.node.fieldChanged("size"))}})),x3dom.registerNodeType("IndexedQuadSet","CADGeometry",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(a){x3dom.nodeTypes.IndexedQuadSet.superClass.call(this,a),this.addField_MFInt32(a,"index",[])},{nodeChanged:function(){var a=(new Date).getTime();this.handleAttribs();var b,c,d,e,f=this._vf.colorPerVertex,g=this._vf.normalPerVertex,h=this._vf.index,i=!1,j=!1,k=!1,l=this._cf.coord.node;x3dom.debug.assert(l),b=l._vf.point;var m=this._cf.normal.node;m?(i=!0,c=m._vf.vector):i=!1;var n="",o=2,p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]),p?p._vf.point?(j=!0,d=p._vf.point,x3dom.isa(p,x3dom.nodeTypes.TextureCoordinate3D)&&(o=3)):p._vf.mode&&(n=p._vf.mode):j=!1;var q=3,r=this._cf.color.node;r?(k=!0,e=r._vf.color,x3dom.isa(r,x3dom.nodeTypes.ColorRGBA)&&(q=4)):k=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];for(var s,t,u;b.length%4>0;)b.push(b.length-1);for(u=b.length,t=0,s=0;s<h.length;s++)s>0&&3===s%4?(t++,this._mesh._indices[0].push(h[s-3]),this._mesh._indices[0].push(h[s-1]),this._mesh._indices[0].push(h[s])):this._mesh._indices[0].push(h[s]),!g&&i&&(this._mesh._normals[0].push(c[t].x),this._mesh._normals[0].push(c[t].y),this._mesh._normals[0].push(c[t].z)),!f&&k&&(this._mesh._colors[0].push(e[t].r),this._mesh._colors[0].push(e[t].g),this._mesh._colors[0].push(e[t].b),4===q&&this._mesh._colors[0].push(e[t].a));for(this._mesh._positions[0]=b.toGL(),i?this._mesh._normals[0]=c.toGL():this._mesh.calcNormals(g?Math.PI:0),j?(this._mesh._texCoords[0]=d.toGL(),this._mesh._numTexComponents=o):this._mesh.calcTexCoords(n),k&&f&&(this._mesh._colors[0]=e.toGL(),this._mesh._numColComponents=q),this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,s=0;s<this._mesh._indices.length;s++)this._mesh._numFaces+=this._mesh._indices[s].length/3,this._mesh._numCoords+=this._mesh._positions[s].length/3;(new Date).getTime()-a},fieldChanged:function(a){var b=this._cf.coord.node._vf.point;if(b.length>x3dom.Utils.maxIndexableCoords)return x3dom.debug.logWarning("IndexedQuadSet: fieldChanged with too many coordinates not yet implemented!"),void 0;if("coord"==a)this._mesh._positions[0]=b.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()});else if("color"==a){if(b=this._cf.color.node._vf.color,this._vf.colorPerVertex)this._mesh._colors[0]=b.toGL();else if(!this._vf.colorPerVertex){var c=0,d=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(d=4),this._mesh._colors[0]=[];var e=this._vf.index;for(i=0;i<e.length;++i)i>0&&0===i%3&&c++,this._mesh._colors[0].push(b[c].r),this._mesh._colors[0].push(b[c].g),this._mesh._colors[0].push(b[c].b),4===d&&this._mesh._colors[0].push(b[c].a)}Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0})}else if("normal"==a){if(b=this._cf.normal.node._vf.vector,this._vf.normalPerVertex)this._mesh._normals[0]=b.toGL();else if(!this._vf.normalPerVertex){var e=this._vf.index;this._mesh._normals[0]=[];var c=0;for(i=0;i<e.length;++i)i>0&&0===i%3&&c++,this._mesh._normals[0].push(b[c].x),this._mesh._normals[0].push(b[c].y),this._mesh._normals[0].push(b[c].z)}Array.forEach(this._parentNodes,function(a){a._dirty.normals=!0})}else if("texCoord"==a){var f=this._cf.texCoord.node;x3dom.isa(f,x3dom.nodeTypes.MultiTextureCoordinate)&&f._cf.texCoord.nodes.length&&(f=f._cf.texCoord.nodes[0]),b=f._vf.point,this._mesh._texCoords[0]=b.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.texcoords=!0})}}})),x3dom.registerNodeType("QuadSet","CADGeometry",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(a){x3dom.nodeTypes.QuadSet.superClass.call(this,a)},{nodeChanged:function(){var a=(new Date).getTime();this.handleAttribs();var b,c,d,e,f=this._vf.colorPerVertex,g=this._vf.normalPerVertex,h=!1,i=!1,j=!1,k=this._cf.coord.node;x3dom.debug.assert(k),b=k._vf.point;var l=this._cf.normal.node;l?(h=!0,c=l._vf.vector):h=!1;var m="",n=2,o=this._cf.texCoord.node;x3dom.isa(o,x3dom.nodeTypes.MultiTextureCoordinate)&&o._cf.texCoord.nodes.length&&(o=o._cf.texCoord.nodes[0]),o?o._vf.point?(i=!0,d=o._vf.point,x3dom.isa(o,x3dom.nodeTypes.TextureCoordinate3D)&&(n=3)):o._vf.mode&&(m=o._vf.mode):i=!1;var p=3,q=this._cf.color.node;q?(j=!0,e=q._vf.color,x3dom.isa(q,x3dom.nodeTypes.ColorRGBA)&&(p=4)):j=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];for(var r,s,t;b.length%4>0;)b.push(b.length-1);for(t=b.length,s=0,r=0;r<b.length;r++)r>0&&3===r%4?(s++,this._mesh._indices[0].push(r-3),this._mesh._indices[0].push(r-1),this._mesh._indices[0].push(r)):this._mesh._indices[0].push(r),!g&&h&&(this._mesh._normals[0].push(c[s].x),this._mesh._normals[0].push(c[s].y),this._mesh._normals[0].push(c[s].z)),!f&&j&&(this._mesh._colors[0].push(e[s].r),this._mesh._colors[0].push(e[s].g),this._mesh._colors[0].push(e[s].b),4===p&&this._mesh._colors[0].push(e[s].a));for(this._mesh._positions[0]=b.toGL(),h?this._mesh._normals[0]=c.toGL():this._mesh.calcNormals(g?Math.PI:0),i?(this._mesh._texCoords[0]=d.toGL(),this._mesh._numTexComponents=n):this._mesh.calcTexCoords(m),j&&f&&(this._mesh._colors[0]=e.toGL(),this._mesh._numColComponents=p),this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,r=0;r<this._mesh._indices.length;r++)this._mesh._numFaces+=this._mesh._indices[r].length/3,this._mesh._numCoords+=this._mesh._positions[r].length/3;(new Date).getTime()-a},fieldChanged:function(a){var b=this._cf.coord.node._vf.point;if(b.length>x3dom.Utils.maxIndexableCoords)return x3dom.debug.logWarning("QuadSet: fieldChanged with too many coordinates not yet implemented!"),void 0;if("coord"==a)this._mesh._positions[0]=b.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,a.invalidateVolume()});else if("color"==a){if(b=this._cf.color.node._vf.color,this._vf.colorPerVertex)this._mesh._colors[0]=b.toGL();else if(!this._vf.colorPerVertex){var c=0,d=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(d=4),this._mesh._colors[0]=[];var e=this._vf.index;for(i=0;i<e.length;++i)i>0&&0===i%3&&c++,this._mesh._colors[0].push(b[c].r),this._mesh._colors[0].push(b[c].g),this._mesh._colors[0].push(b[c].b),4===d&&this._mesh._colors[0].push(b[c].a)}Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0})}else if("normal"==a){if(b=this._cf.normal.node._vf.vector,this._vf.normalPerVertex)this._mesh._normals[0]=b.toGL();else if(!this._vf.normalPerVertex){var e=this._vf.index;this._mesh._normals[0]=[];var c=0;for(i=0;i<e.length;++i)i>0&&0===i%3&&c++,this._mesh._normals[0].push(b[c].x),this._mesh._normals[0].push(b[c].y),this._mesh._normals[0].push(b[c].z)}Array.forEach(this._parentNodes,function(a){a._dirty.normals=!0})}else if("texCoord"==a){var f=this._cf.texCoord.node;x3dom.isa(f,x3dom.nodeTypes.MultiTextureCoordinate)&&f._cf.texCoord.nodes.length&&(f=f._cf.texCoord.nodes[0]),b=f._vf.point,this._mesh._texCoords[0]=b.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.texcoords=!0})}}})),x3dom.registerNodeType("CADLayer","CADGeometry",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.CADLayer.superClass.call(this,a),this.addField_SFString(a,"name","")})),x3dom.registerNodeType("CADAssembly","CADGeometry",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.CADAssembly.superClass.call(this,a),this.addField_SFString(a,"name","")})),x3dom.registerNodeType("CADPart","CADGeometry",defineClass(x3dom.nodeTypes.Transform,function(a){x3dom.nodeTypes.CADPart.superClass.call(this,a),this.addField_SFString(a,"name","")})),x3dom.registerNodeType("CADFace","CADGeometry",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.CADFace.superClass.call(this,a),this.addField_SFString(a,"name",""),this.addField_SFNode("shape",x3dom.nodeTypes.X3DShapeNode)},{getVolume:function(){var a=this._graph.volume;if(!this.volumeValid()&&this._vf.render){var b=this._cf.shape.node,c=b&&b._vf.render===!0?b.getVolume():null;c&&c.isValid()&&a.extendBounds(c.min,c.max)}return a},collectDrawableObjects:function(a,b,c,d,e){if(c&&this._parentNodes.length>1&&(c=!1),c&&(d=d||this.cacheInvalid())&&this.invalidateCache(),this._cf.shape.node&&!((e=b.cull(a,this.graphState(),c,e))<=0)){var f,g;c?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(a)),g=this._graph.globalMatrix):g=this.transformMatrix(a),(f=this._cf.shape.node)&&f.collectDrawableObjects(g,b,c,d,e)}}})),x3dom.registerNodeType("Patch","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Patch.superClass.call(this,a),this.addField_SFVec2f(a,"size",2,2),this.addField_SFVec2f(a,"subdivision",1,1),this.addField_SFVec3f(a,"center",0,0,0),this.addField_MFString(a,"primType",["TRIANGLES"]);var b=this._vf.size.x,c=this._vf.size.y,d=this._vf.subdivision.x,e=this._vf.subdivision.y;this._indexBufferTriangulationParts=[];var f=0,g=0,h=b/d/2,i=c/e/2;b/=2,c/=2;var j=2*d+1,k=2*e+1;for(g=0;2*e>=g;g++)for(f=0;2*d>=f;f++)this._mesh._positions[0].push(this._vf.center.x+f*h-b),this._mesh._positions[0].push(this._vf.center.y+g*i-c),this._mesh._positions[0].push(this._vf.center.z),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(f/(2*d)),this._mesh._texCoords[0].push(g/(2*e));for(g=0;k-2>g;g+=2)for(f=0;j-2>f;f+=2)this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+(g+2)*j);for(this._indexBufferTriangulationParts.push({offset:0,count:6*d*e}),g=0;k-2>g;g+=2)for(f=0;2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+1)*j),this._mesh._indices[0].push(f+(g+1)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(g=0;k-2>g;g+=2)for(f=2;j-2>f;f+=2)this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+(g+2)*j);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:6*d*e+9*e}),g=0;k-2>g;g+=2)for(f=j-3;j-2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+1)*j),this._mesh._indices[0].push(f+2+(g+1)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(g=0;k-2>g;g+=2)for(f=0;j-4>f;f+=2)this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+(g+2)*j);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:6*d*e+9*e}),g=2;k-2>g;g+=2)for(f=0;j-2>f;f+=2)this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+(g+2)*j);for(g=0;2>g;g+=2)for(f=0;j-2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+1+g*j),this._mesh._indices[0].push(f+1+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:6*d*e+9*d}),g=k-3;k-2>g;g+=2)for(f=0;j-2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+1+(g+2)*j),this._mesh._indices[0].push(f+1+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(g=0;k-4>g;g+=2)for(f=0;j-2>f;f+=2)this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+(g+2)*j);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:6*d*e+9*d}),g=k-3;k-2>g;g+=2)for(f=j-3;j-2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+1+(g+2)*j),this._mesh._indices[0].push(f+1+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+1)*j),this._mesh._indices[0].push(f+2+(g+1)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(g=0;k-4>g;g+=2)for(f=0;j-4>f;f+=2)this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+(g+2)*j);for(g=0;k-4>g;g+=2)for(f=j-3;j-2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+1)*j),this._mesh._indices[0].push(f+2+(g+1)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(g=k-3;k-2>g;g+=2)for(f=0;j-4>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+1+(g+2)*j),this._mesh._indices[0].push(f+1+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:6*d*e+9*d+9*(e-1)+3}),g=k-3;k-2>g;g+=2)for(f=0;2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+1)*j),this._mesh._indices[0].push(f+(g+1)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+1+(g+2)*j),this._mesh._indices[0].push(f+1+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(g=0;k-4>g;g+=2)for(f=2;j-2>f;f+=2)this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+(g+2)*j);for(g=k-3;k-2>g;g+=2)for(f=2;j-2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+1+(g+2)*j),this._mesh._indices[0].push(f+1+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(g=0;k-4>g;g+=2)for(f=0;2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+1)*j),this._mesh._indices[0].push(f+(g+1)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:6*d*e+9*d+9*(e-1)+3}),g=0;2>g;g+=2)for(f=0;2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+1)*j),this._mesh._indices[0].push(f+(g+1)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+1+g*j),this._mesh._indices[0].push(f+1+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(g=2;k-2>g;g+=2)for(f=2;j-2>f;f+=2)this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+(g+2)*j);for(g=2;k-2>g;g+=2)for(f=0;2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+1)*j),this._mesh._indices[0].push(f+(g+1)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(g=0;2>g;g+=2)for(f=2;j-2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+1+g*j),this._mesh._indices[0].push(f+1+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:6*d*e+9*d+9*(e-1)+3}),g=0;2>g;g+=2)for(f=j-3;j-2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+1)*j),this._mesh._indices[0].push(f+2+(g+1)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+1+g*j),this._mesh._indices[0].push(f+1+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(g=2;k-2>g;g+=2)for(f=0;j-4>f;f+=2)this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+(g+2)*j);for(g=2;k-2>g;g+=2)for(f=j-3;j-2>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+1)*j),this._mesh._indices[0].push(f+2+(g+1)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);for(g=0;2>g;g+=2)for(f=0;j-4>f;f+=2)this._mesh._indices[0].push(f+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+2+(g+2)*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+2+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+1+g*j),this._mesh._indices[0].push(f+1+g*j),this._mesh._indices[0].push(f+1+(g+1)*j),this._mesh._indices[0].push(f+g*j);
this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:6*d*e+9*d+9*(e-1)+3}),this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},{hasIndexOffset:function(){return!0},getTriangulationAttributes:function(a){return this._indexBufferTriangulationParts[a]}})),x3dom.registerNodeType("BVHRefiner","Navigation",defineClass(x3dom.nodeTypes.X3DLODNode,function(a){x3dom.nodeTypes.BVHRefiner.superClass.call(this,a),this.addField_SFFloat(a,"factor",1),this.addField_SFInt32(a,"maxDepth",3),this.addField_SFInt32(a,"minDepth",0),this.addField_SFInt32(a,"smoothLoading",1),this.addField_SFInt32(a,"interactionDepth",this._vf.maxDepth),this.addField_SFVec2f(a,"size",1,1),this.addField_SFVec3f(a,"octSize",1,1,1),this.addField_SFVec2f(a,"subdivision",1,1),this.addField_SFString(a,"url",""),this.addField_SFString(a,"elevationUrl",""),this.addField_SFString(a,"textureUrl",""),this.addField_SFString(a,"normalUrl",""),this.addField_SFString(a,"mode","3d"),this.addField_SFString(a,"subMode","wmts"),this.addField_SFString(a,"elevationFormat","png"),this.addField_SFString(a,"textureFormat","png"),this.addField_SFString(a,"normalFormat","png"),this.addField_SFFloat(a,"maxElevation",1),this.addField_SFBool(a,"useNormals",!0),this.addField_SFBool(a,"lit",!0),this.addField_SFInt32(a,"bvhCount",8),this.creationSmooth=0,this.togglePoints=!0,this.nodeProducer=new NodeProducer;for(var b=0,c=0;c<=this._vf.maxDepth;c++)b+=Math.pow(4,c);if(this.nodeList=new Array(b),"bin"===this._vf.mode)this.rootNode=new QuadtreeNodeBin(a,this,0,0,0,null);else if("3d"===this._vf.mode||"2d"===this._vf.mode){var d=new x3dom.nodeTypes.Plane(a);d._vf.subdivision.setValues(this._vf.subdivision),d.fieldChanged("subdivision"),d._vf.size.setValues(this._vf.size),"2d"===this._vf.mode?this.rootNode="wmts"===this._vf.subMode?new QuadtreeNode2dWMTS(a,this,0,0,x3dom.fields.SFMatrix4f.identity(),0,0,d):new QuadtreeNode2D(a,this,0,0,x3dom.fields.SFMatrix4f.identity(),0,0,d,"/",1):"32bit"===this._vf.subMode?this.rootNode=new QuadtreeNode3D_32bit(a,this,0,0,x3dom.fields.SFMatrix4f.identity(),0,0,d):(d=new x3dom.nodeTypes.Patch(a),this.rootNode=new QuadtreeNode3D(a,this,0,0,x3dom.fields.SFMatrix4f.identity(),0,0,d))}else"bvh"===this._vf.mode?this.rootNode=new BVHNode(a,this,0,"/",1,this._vf.bvhCount):x3dom.debug.logError("Error attribute mode. Value: '"+this._vf.mode+"' isn't conform. Please use type 'bin', '2d' or '3d'")},{visitChildren:function(a,b,c,d,e){var f=this._nameSpace.doc._x3dElem;"oct"===this._vf.mode?(f.runtime.isReady&&this.togglePoints&&(f.runtime.togglePoints(),this.togglePoints=!1,this.view=b.viewarea),this.creationSmooth++,c=!1,d=!0,this.rootNode.collectDrawables(a,b,c,d,e),this.view.isMovingOrAnimating()||0!==this.creationSmooth%this._vf.smoothLoading||this.nodeProducer.CreateNewNode()):(f.runtime.isReady&&this.togglePoints&&(this.view=f.runtime.canvas.doc._viewarea,this.togglePoints=!1),this.createChildren=0,this.creationSmooth++,c=!1,d=!0,this.rootNode.collectDrawables(a,b,c,d,e),this.view.isMovingOrAnimating()||0!==this.creationSmooth%this._vf.smoothLoading||this.nodeProducer.CreateNewNode())},getVolume:function(){var a=this._graph.volume;if(!this.volumeValid()&&this._vf.render){var b=this.rootNode.getVolume();b&&b.isValid()&&a.extendBounds(b.min,b.max)}return a}})),x3dom.registerNodeType("Snout","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Snout.superClass.call(this,a),this.addField_SFFloat(a,"dbottom",1),this.addField_SFFloat(a,"dtop",.5),this.addField_SFFloat(a,"height",1),this.addField_SFFloat(a,"xoff",.25),this.addField_SFFloat(a,"yoff",.25),this.addField_SFBool(a,"bottom",!0),this.addField_SFBool(a,"top",!0),this.addField_SFFloat(a,"subdivision",32),this.rebuildGeometry()},{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var a,b,c,d,e,f=this._vf.dbottom/2,g=this._vf.height,h=this._vf.dtop/2,i=this._vf.subdivision,j=2*Math.PI/i,k=(f-h)/g,l=1/Math.sqrt(1+k*k),m=0,n=0;if(g>0){var o=0,p=0;for(m=0,n=0;i>=m;m++)a=m*j,b=Math.sin(a),c=-Math.cos(a),h>x3dom.fields.Eps&&(o=b*h+this._vf.xoff,p=c*h+this._vf.yoff),this._mesh._positions[0].push(o,g/2,p),this._mesh._normals[0].push(b/l,k/l,c/l),this._mesh._texCoords[0].push(1-m/i,1),this._mesh._positions[0].push(b*f,-g/2,c*f),this._mesh._normals[0].push(b/l,k/l,c/l),this._mesh._texCoords[0].push(1-m/i,0),m>0&&(this._mesh._indices[0].push(n),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+3),n+=2)}if(f>0&&this._vf.bottom){for(e=this._mesh._positions[0].length/3,m=i-1;m>=0;m--)a=m*j,b=f*Math.sin(a),c=-f*Math.cos(a),this._mesh._positions[0].push(b,-g/2,c),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(b/f/2+.5,c/f/2+.5);for(d=e+1,m=2;i>m;m++)this._mesh._indices[0].push(d),this._mesh._indices[0].push(e),d=e+m,this._mesh._indices[0].push(d)}if(h>x3dom.fields.Eps&&this._vf.top){for(e=this._mesh._positions[0].length/3,m=i-1;m>=0;m--)a=m*j,b=h*Math.sin(a),c=-h*Math.cos(a),this._mesh._positions[0].push(b+this._vf.xoff,g/2,c+this._vf.yoff),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(b/h/2+.5,1-c/h/2+.5);for(d=e+1,m=2;i>m;m++)this._mesh._indices[0].push(e),this._mesh._indices[0].push(d),d=e+m,this._mesh._indices[0].push(d)}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(a){("dtop"==a||"dbottom"==a||"height"==a||"subdivision"==a||"xoff"==a||"yoff"==a||"bottom"==a||"top"==a)&&(this.rebuildGeometry(),Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()}))}})),x3dom.registerNodeType("Dish","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Dish.superClass.call(this,a),this.addField_SFFloat(a,"diameter",2),this.addField_SFFloat(a,"height",1),this.addField_SFFloat(a,"radius",this._vf.diameter/2),this.addField_SFBool(a,"bottom",!0),this.addField_SFVec2f(a,"subdivision",24,24),this.rebuildGeometry()},{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var a=2*Math.PI,b=Math.PI/2,c=this._vf.diameter/2,d=this._vf.radius;d=0==d||Math.abs(c-d)<=x3dom.fields.Eps?c:d;var e,f,g,h,i,j,k,l,m,n,o,p,q,r=Math.min(this._vf.height,d),s=d-r,t=c,u=d,v=c,w=this._vf.subdivision.x,x=this._vf.subdivision.y,y=b-Math.asin(1-r/d),z=Math.ceil(w/b*y),A=[],B=[];for(e=0;w>=e;e++){for(g=z==e?y:e*b/w,h=Math.sin(g),i=Math.cos(g),f=0;x>=f;f++)j=f*a/x,k=Math.sin(j),l=Math.cos(j),m=t*-l*h,n=u*i,o=v*-k*h,p=.25-f/x,q=e/w,this._mesh._positions[0].push(m,n-s,o),this._mesh._texCoords[0].push(p,q),this._mesh._normals[0].push(m/(t*t),n/(u*u),o/(v*v)),(e==w||z==e)&&(A.push(m,n-s,o),B.push(p,q));if(z==e)break}for(e=0;w>e&&z!=e;e++)for(f=0;x>f;f++){var C=e*(x+1)+f,D=C+x+1;this._mesh._indices[0].push(C+1),this._mesh._indices[0].push(D),this._mesh._indices[0].push(C),this._mesh._indices[0].push(C+1),this._mesh._indices[0].push(D+1),this._mesh._indices[0].push(D)}if(this._vf.bottom)for(var E=this._mesh._positions[0].length/3,F=E+1,G=0,H=A.length/3;H>G;G++){var I=3*G;this._mesh._positions[0].push(A[I]),this._mesh._positions[0].push(A[I+1]),this._mesh._positions[0].push(A[I+2]),I=2*G,this._mesh._texCoords[0].push(B[I]),this._mesh._texCoords[0].push(B[I+1]),this._mesh._normals[0].push(0,-1,0),G>=2&&(this._mesh._indices[0].push(E),this._mesh._indices[0].push(F),F=E+G,this._mesh._indices[0].push(F))}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(a){("radius"==a||"height"==a||"diameter"==a||"subdivision"==a||"bottom"==a)&&(this.rebuildGeometry(),Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()}))}})),x3dom.registerNodeType("Pyramid","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Pyramid.superClass.call(this,a),this.addField_SFFloat(a,"xbottom",1),this.addField_SFFloat(a,"ybottom",1),this.addField_SFFloat(a,"xtop",.5),this.addField_SFFloat(a,"ytop",.5),this.addField_SFFloat(a,"height",1),this.addField_SFFloat(a,"xoff",.25),this.addField_SFFloat(a,"yoff",.25);var b=this._vf.xtop/2,c=this._vf.ytop/2,d=this._vf.xbottom/2,e=this._vf.ybottom/2,f=this._vf.xoff,g=this._vf.yoff,h=this._vf.height/2;this._mesh._positions[0]=[-d,-h,-e,-b+f,h,-c+g,b+f,h,-c+g,d,-h,-e,-d,-h,e,-b+f,h,c+g,b+f,h,c+g,d,-h,e,-d,-h,-e,-d,-h,e,-b+f,h,c+g,-b+f,h,-c+g,d,-h,-e,d,-h,e,b+f,h,c+g,b+f,h,-c+g,-b+f,h,-c+g,-b+f,h,c+g,b+f,h,c+g,b+f,h,-c+g,-d,-h,-e,-d,-h,e,d,-h,e,d,-h,-e],this._mesh._texCoords[0]=[1,0,1,1,0,1,0,0,0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,1,1,0,0,0,0,1,1,1,0,1,0,0,1,0,1,1,0,0,0,1,1,1,1,0],this._mesh._indices[0]=[0,1,2,2,3,0,6,5,4,4,7,6,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20],this._mesh.calcNormals(Math.PI,this._vf.ccw),this._mesh._invalidate=!0,this._mesh._numFaces=12,this._mesh._numCoords=24},{fieldChanged:function(a){if("xbottom"==a||"ybottom"==a||"xtop"==a||"ytop"==a||"xoff"==a||"yoff"==a||"height"==a){var b=this._vf.xtop/2,c=this._vf.ytop/2,d=this._vf.xbottom/2,e=this._vf.ybottom/2,f=this._vf.xoff,g=this._vf.yoff,h=this._vf.height/2;this._mesh._positions[0]=[-d,-h,-e,-b+f,h,-c+g,b+f,h,-c+g,d,-h,-e,-d,-h,e,-b+f,h,c+g,b+f,h,c+g,d,-h,e,-d,-h,-e,-d,-h,e,-b+f,h,c+g,-b+f,h,-c+g,d,-h,-e,d,-h,e,b+f,h,c+g,b+f,h,-c+g,-b+f,h,-c+g,-b+f,h,c+g,b+f,h,c+g,b+f,h,-c+g,-d,-h,-e,-d,-h,e,d,-h,e,d,-h,-e],this._mesh._normals[0]=[],this._mesh.calcNormals(Math.PI,this._vf.ccw),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()})}}})),x3dom.registerNodeType("RectangularTorus","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.RectangularTorus.superClass.call(this,a),this.addField_SFFloat(a,"innerRadius",.5),this.addField_SFFloat(a,"outerRadius",1),this.addField_SFFloat(a,"height",1),this.addField_SFFloat(a,"angle",2*Math.PI),this.addField_SFBool(a,"caps",!0),this.addField_SFFloat(a,"subdivision",32),this._origCCW=this._vf.ccw,this.rebuildGeometry()},{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var a=2*Math.PI;if(this._vf.ccw=!this._origCCW,this._vf.angle<0?this._vf.angle=0:this._vf.angle>a&&(this._vf.angle=a),this._vf.innerRadius>this._vf.outerRadius){var b=this._vf.innerRadius;this._vf.innerRadius=this._vf.outerRadius,this._vf.outerRadius=b}var c,d,e,f,g,h,i,j=this._vf.innerRadius,k=this._vf.outerRadius,l=this._vf.height/2,m=this._vf.angle,n=this._vf.subdivision,o=m/n;for(g=0,f=0;n>=g;g++)c=g*o,h=Math.cos(c),i=-Math.sin(c),d=k*h,e=k*i,this._mesh._positions[0].push(d,-l,e),this._mesh._normals[0].push(h,0,i),this._mesh._positions[0].push(d,l,e),this._mesh._normals[0].push(h,0,i),g>0&&(this._mesh._indices[0].push(f),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+3),f+=2);for(g=0,f+=2;n>=g;g++)c=g*o,h=Math.cos(c),i=-Math.sin(c),d=j*h,e=j*i,this._mesh._positions[0].push(d,-l,e),this._mesh._normals[0].push(-h,0,-i),this._mesh._positions[0].push(d,l,e),this._mesh._normals[0].push(-h,0,-i),g>0&&(this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f),this._mesh._indices[0].push(f+3),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+2),f+=2);for(g=0,f+=2;n>=g;g++)c=g*o,h=Math.cos(c),i=-Math.sin(c),d=k*h,e=k*i,this._mesh._positions[0].push(d,l,e),this._mesh._normals[0].push(0,1,0),d=j*h,e=j*i,this._mesh._positions[0].push(d,l,e),this._mesh._normals[0].push(0,1,0),g>0&&(this._mesh._indices[0].push(f),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+3),f+=2);for(g=0,f+=2;n>=g;g++)c=g*o,h=Math.cos(c),i=-Math.sin(c),d=k*h,e=k*i,this._mesh._positions[0].push(d,-l,e),this._mesh._normals[0].push(0,-1,0),d=j*h,e=j*i,this._mesh._positions[0].push(d,-l,e),this._mesh._normals[0].push(0,-1,0),g>0&&(this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f),this._mesh._indices[0].push(f+3),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+2),f+=2);a>m&&1==this._vf.caps&&(f+=2,d=k,e=0,this._mesh._positions[0].push(d,l,e),this._mesh._normals[0].push(0,0,1),this._mesh._positions[0].push(d,-l,e),this._mesh._normals[0].push(0,0,1),d=j,e=0,this._mesh._positions[0].push(d,l,e),this._mesh._normals[0].push(0,0,1),this._mesh._positions[0].push(d,-l,e),this._mesh._normals[0].push(0,0,1),this._mesh._indices[0].push(f),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+3),f+=4,h=Math.cos(m),i=-Math.sin(m),d=k*h,e=k*i,this._mesh._positions[0].push(d,l,e),this._mesh._normals[0].push(i,0,-h),this._mesh._positions[0].push(d,-l,e),this._mesh._normals[0].push(i,0,-h),d=j*h,e=j*i,this._mesh._positions[0].push(d,l,e),this._mesh._normals[0].push(i,0,-h),this._mesh._positions[0].push(d,-l,e),this._mesh._normals[0].push(i,0,-h),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f),this._mesh._indices[0].push(f+3),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+2)),this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(a){("innerRadius"==a||"outerRadius"==a||"height"==a||"angle"==a||"subdivision"==a||"caps"==a)&&(this.rebuildGeometry(),Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()}))}})),x3dom.registerNodeType("SlopedCylinder","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.SlopedCylinder.superClass.call(this,a),this.addField_SFFloat(a,"radius",1),this.addField_SFFloat(a,"height",2),this.addField_SFBool(a,"bottom",!0),this.addField_SFBool(a,"top",!0),this.addField_SFFloat(a,"xtshear",.26179),this.addField_SFFloat(a,"ytshear",0),this.addField_SFFloat(a,"xbshear",.26179),this.addField_SFFloat(a,"ybshear",0),this.addField_SFFloat(a,"subdivision",32),this.rebuildGeometry()},{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var a,b,c,d,e,f,g=this._vf.xtshear,h=this._vf.ytshear,i=this._vf.xbshear,j=this._vf.ybshear,k=this._vf.subdivision,l=this._vf.radius,m=this._vf.height/2,n=2*Math.PI/k;for(e=0,f=0;k>=e;e++)a=e*n,b=Math.sin(a),d=-Math.cos(a),this._mesh._positions[0].push(b*l,-m+b*i+d*j,d*l),this._mesh._texCoords[0].push(1-e/k,0),this._mesh._positions[0].push(b*l,m+b*g+d*h,d*l),this._mesh._texCoords[0].push(1-e/k,1),e>0&&(this._mesh._indices[0].push(f),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+3),f+=2);var o,p;if(this._vf.top&&l>0){for(p=this._mesh._positions[0].length/3,e=k-1;e>=0;e--)f=6*e,b=this._mesh._positions[0][f+3],c=this._mesh._positions[0][f+4],d=this._mesh._positions[0][f+5],this._mesh._positions[0].push(b,c,d),this._mesh._texCoords[0].push(b/2+.5,-d/2+.5);for(o=p+1,e=2;k>e;e++)this._mesh._indices[0].push(p),this._mesh._indices[0].push(o),o=p+e,this._mesh._indices[0].push(o)}if(this._vf.bottom&&l>0){for(p=this._mesh._positions[0].length/3,e=k-1;e>=0;e--)f=6*e,b=this._mesh._positions[0][f],c=this._mesh._positions[0][f+1],d=this._mesh._positions[0][f+2],this._mesh._positions[0].push(b,c,d),this._mesh._texCoords[0].push(b/2+.5,d/2+.5);for(o=p+1,e=2;k>e;e++)this._mesh._indices[0].push(o),this._mesh._indices[0].push(p),o=p+e,this._mesh._indices[0].push(o)}this._mesh.calcNormals(Math.PI,this._vf.ccw);var q=new x3dom.fields.SFVec3f(this._mesh._normals[0][0],this._mesh._normals[0][1],this._mesh._normals[0][2]),r=new x3dom.fields.SFVec3f(this._mesh._normals[0][3],this._mesh._normals[0][4],this._mesh._normals[0][5]);f=6*k;var s=new x3dom.fields.SFVec3f(this._mesh._normals[0][f],this._mesh._normals[0][f+1],this._mesh._normals[0][f+2]),t=new x3dom.fields.SFVec3f(this._mesh._normals[0][f+3],this._mesh._normals[0][f+4],this._mesh._normals[0][f+5]),u=q.add(s).normalize(),v=r.add(t).normalize();this._mesh._normals[0][0]=u.x,this._mesh._normals[0][1]=u.y,this._mesh._normals[0][2]=u.z,this._mesh._normals[0][3]=v.x,this._mesh._normals[0][4]=v.y,this._mesh._normals[0][5]=v.z,this._mesh._normals[0][f]=u.x,this._mesh._normals[0][f+1]=u.y,this._mesh._normals[0][f+2]=u.z,this._mesh._normals[0][f+3]=v.x,this._mesh._normals[0][f+4]=v.y,this._mesh._normals[0][f+5]=v.z,this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(a){("xtshear"==a||"ytshear"==a||"xbshear"==a||"ybshear"==a||"radius"==a||"height"==a||"bottom"==a||"top"==a||"subdivision"==a)&&(this.rebuildGeometry(),Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()}))}})),x3dom.registerNodeType("Nozzle","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Nozzle.superClass.call(this,a),this.addField_SFFloat(a,"nozzleHeight",.1),this.addField_SFFloat(a,"nozzleRadius",.6),this.addField_SFFloat(a,"height",1),this.addField_SFFloat(a,"outerRadius",.5),this.addField_SFFloat(a,"innerRadius",.4),this.addField_SFFloat(a,"subdivision",32),this.rebuildGeometry()},{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var a=2*Math.PI,b=this._vf.subdivision,c=this._vf.height,d=c/2;if(this._vf.innerRadius>this._vf.outerRadius){var e=this._vf.innerRadius;this._vf.innerRadius=this._vf.outerRadius,this._vf.outerRadius=e}var f=this._vf.innerRadius,g=this._vf.outerRadius;this._vf.nozzleRadius<g&&(this._vf.nozzleRadius=g);var h=this._vf.nozzleRadius;this._vf.nozzleHeight>c&&(this._vf.nozzleHeight=c);var i,j,k,l,m,n,o,p,q=this._vf.nozzleHeight;for(j=a/b,n=0,m=0;b>=n;n++)i=n*j,o=Math.sin(i),p=-Math.cos(i),k=g*o,l=g*p,this._mesh._positions[0].push(k,-d,l),this._mesh._normals[0].push(o,0,p),this._mesh._positions[0].push(k,c-q-d,l),this._mesh._normals[0].push(o,0,p),n>0&&(this._mesh._indices[0].push(m),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+3),m+=2);for(n=0,m+=2;b>=n;n++)i=n*j,o=Math.sin(i),p=-Math.cos(i),k=f*o,l=f*p,this._mesh._positions[0].push(k,-d,l),this._mesh._normals[0].push(-o,0,-p),this._mesh._positions[0].push(k,c-q-d,l),this._mesh._normals[0].push(-o,0,-p),n>0&&(this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m),this._mesh._indices[0].push(m+3),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+2),m+=2);for(n=0,m+=2;b>=n;n++)i=n*j,o=Math.sin(i),p=-Math.cos(i),k=g*o,l=g*p,this._mesh._positions[0].push(k,-d,l),this._mesh._normals[0].push(0,-1,0),k=f*o,l=f*p,this._mesh._positions[0].push(k,-d,l),this._mesh._normals[0].push(0,-1,0),n>0&&(this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m),this._mesh._indices[0].push(m+3),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+2),m+=2);for(n=0,m+=2;b>=n;n++)i=n*j,o=Math.sin(i),p=-Math.cos(i),k=h*o,l=h*p,this._mesh._positions[0].push(k,c-q-d,l),this._mesh._normals[0].push(o,0,p),this._mesh._positions[0].push(k,d,l),this._mesh._normals[0].push(o,0,p),n>0&&(this._mesh._indices[0].push(m),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+3),m+=2);for(n=0,m+=2;b>=n;n++)i=n*j,o=Math.sin(i),p=-Math.cos(i),k=f*o,l=f*p,this._mesh._positions[0].push(k,c-q-d,l),this._mesh._normals[0].push(-o,0,-p),this._mesh._positions[0].push(k,d,l),this._mesh._normals[0].push(-o,0,-p),n>0&&(this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m),this._mesh._indices[0].push(m+3),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+2),m+=2);for(n=0,m+=2;b>=n;n++)i=n*j,o=Math.sin(i),p=-Math.cos(i),k=h*o,l=h*p,this._mesh._positions[0].push(k,c-q-d,l),this._mesh._normals[0].push(0,-1,0),k=g*o,l=g*p,this._mesh._positions[0].push(k,c-q-d,l),this._mesh._normals[0].push(0,-1,0),n>0&&(this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m),this._mesh._indices[0].push(m+3),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+2),m+=2);for(n=0,m+=2;b>=n;n++)i=n*j,o=Math.sin(i),p=-Math.cos(i),k=h*o,l=h*p,this._mesh._positions[0].push(k,d,l),this._mesh._normals[0].push(0,1,0),k=f*o,l=f*p,this._mesh._positions[0].push(k,d,l),this._mesh._normals[0].push(0,1,0),n>0&&(this._mesh._indices[0].push(m),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+3),m+=2);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(a){("nozzleHeight"==a||"nozzleRadius"==a||"height"==a||"outerRadius"==a||"innerRadius"==a||"subdivision"==a)&&(this.rebuildGeometry(),Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()}))}})),x3dom.registerNodeType("SolidOfRevolution","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.SolidOfRevolution.superClass.call(this,a),this.addField_SFFloat(a,"creaseAngle",0),this.addField_MFVec2f(a,"crossSection",[]),this.addField_SFFloat(a,"angle",2*Math.PI),this.addField_SFBool(a,"caps",!0),this.addField_SFFloat(a,"subdivision",32),this._origCCW=this._vf.ccw,this.rebuildGeometry()},{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var a=2*Math.PI;this._vf.angle<-a?this._vf.angle=-a:this._vf.angle>a&&(this._vf.angle=a);var b,c,d,e,f=this._vf.crossSection,g=this._vf.angle,h=this._vf.subdivision,i=f.length;if(1>i)return x3dom.debug.logWarning("SolidOfRevolution requires crossSection curve."),void 0;var j,k=i>2?f[0].equals(f[i-1],x3dom.fields.Eps):!1,l=a-Math.abs(g)<=x3dom.fields.Eps,m=g/h,n=[],o=[];this._vf.ccw=0>g?this._origCCW:!this._origCCW,k||(Math.abs(f[i-1].y)>x3dom.fields.Eps&&f.push(new x3dom.fields.SFVec2f(f[i-1].x,0)),Math.abs(f[0].y)>x3dom.fields.Eps&&f.unshift(new x3dom.fields.SFVec2f(f[0].x,0)),i=f.length);var p=null,q=null,r=null,s=[];for(c=0;i>c;c++)p&&(q&&(r=q),q=p),p=new x3dom.fields.SFVec3f(f[c].x,0,f[c].y),c>=2&&(j=p.subtract(q).normalize(),j=j.dot(q.subtract(r).normalize()),j=Math.abs(Math.cos(j)),j>this._vf.creaseAngle&&(o.push(x3dom.fields.SFVec3f.copy(q)),s.push(!0))),o.push(p),s.push(!1);for(i=o.length,b=0,j=0;h>=b;b++,j+=m){var t=x3dom.fields.SFMatrix4f.rotationX(j);for(c=0;i>c;c++)p=t.multMatrixPnt(o[c]),n.push(p),this._mesh._positions[0].push(p.x,p.y,p.z),b>0&&c>0&&(this._mesh._indices[0].push((b-1)*i+(c-1),(b-1)*i+c,b*i+c),this._mesh._indices[0].push(b*i+c,b*i+(c-1),(b-1)*i+(c-1)))}if(!l&&1==this._vf.caps){var u=new x3dom.DoublyLinkedList;for(e=this._mesh._positions[0].length/3,c=0,b=0;i>c;c++)s[c]||(u.appendNode(new x3dom.DoublyLinkedList.ListNode(n[c],b++)),p=n[c],this._mesh._positions[0].push(p.x,p.y,p.z));var v=x3dom.EarClipping.getIndexes(u);for(c=v.length-1;c>=0;c--)this._mesh._indices[0].push(e+v[c]);for(e=this._mesh._positions[0].length/3,c=0;i>c;c++)s[c]||(p=n[i*h+c],this._mesh._positions[0].push(p.x,p.y,p.z));for(c=0;c<v.length;c++)this._mesh._indices[0].push(e+v[c])}if(this._mesh.calcNormals(Math.PI,this._vf.ccw),l)for(e=3*i*h,c=0;i>c;c++)d=3*c,this._mesh._normals[0][e+d]=this._mesh._normals[0][d],this._mesh._normals[0][e+d+1]=this._mesh._normals[0][d+1],this._mesh._normals[0][e+d+2]=this._mesh._normals[0][d+2];this._mesh.calcTexCoords(""),this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(a){("crossSection"==a||"angle"==a||"caps"==a||"subdivision"==a||"creaseAngle"==a)&&(this.rebuildGeometry(),Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()}))}})),x3dom.registerNodeType("SphereSegment","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.SphereSegment.superClass.call(this,a),this.addField_SFFloat(a,"radius",1),this.addField_MFFloat(a,"longitude",[]),this.addField_MFFloat(a,"latitude",[]),this.addField_SFVec2f(a,"stepSize",1,1);var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q=this._vf.radius,r=this._vf.longitude,s=this._vf.latitude,t=r.length,u=s.length,v=u,w=t;for(d=0;v>=d;d++)for(f=(s[d]+90)*Math.PI/180,g=Math.sin(f),h=Math.cos(f),e=0;w>=e;e++)i=r[e]*Math.PI/180,j=Math.sin(i),k=Math.cos(i),l=-k*g,m=-h,n=-j*g,o=e/(w-1),p=d/(v-1),this._mesh._positions[0].push(q*l,q*m,q*n),this._mesh._normals[0].push(l,m,n),this._mesh._texCoords[0].push(o,p);for(d=0;v>d;d++)for(e=0;w>e;e++)b=d*(w+1)+e,c=b+w+1,this._mesh._indices[0].push(b),this._mesh._indices[0].push(c),this._mesh._indices[0].push(b+1),this._mesh._indices[0].push(c),this._mesh._indices[0].push(c+1),this._mesh._indices[0].push(b+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3})),x3dom.registerNodeType("ElevationGrid","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.ElevationGrid.superClass.call(this,a),this.addField_SFBool(a,"colorPerVertex",!0),this.addField_SFBool(a,"normalPerVertex",!0),this.addField_SFFloat(a,"creaseAngle",0),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("normal",x3dom.nodeTypes.Normal),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode),this.addField_MFFloat(a,"height",[]),this.addField_SFInt32(a,"xDimension",0),this.addField_SFFloat(a,"xSpacing",1),this.addField_SFInt32(a,"zDimension",0),this.addField_SFFloat(a,"zSpacing",1)},{nodeChanged:function(){this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var a=0,b=0,c=this._vf.xDimension-1,d=this._vf.zDimension-1,e=this._vf.height;x3dom.debug.assert(e.length===this._vf.xDimension*this._vf.zDimension);var f=null,g=null,h=null;this._cf.normal.node&&(f=this._cf.normal.node._vf.vector);var i=2,j=this._cf.texCoord.node;x3dom.isa(j,x3dom.nodeTypes.MultiTextureCoordinate)&&j._cf.texCoord.nodes.length&&(j=j._cf.texCoord.nodes[0]),j&&j._vf.point&&(g=j._vf.point,x3dom.isa(j,x3dom.nodeTypes.TextureCoordinate3D)&&(i=3));var k=3;this._cf.color.node&&(h=this._cf.color.node._vf.color,x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(k=4));var l=0;for(b=0;d>=b;b++)for(a=0;c>=a;a++)this._mesh._positions[0].push(a*this._vf.xSpacing),this._mesh._positions[0].push(e[l]),this._mesh._positions[0].push(b*this._vf.zSpacing),f&&(this._mesh._normals[0].push(f[l].x),this._mesh._normals[0].push(f[l].y),this._mesh._normals[0].push(f[l].z)),g?(this._mesh._texCoords[0].push(g[l].x),this._mesh._texCoords[0].push(g[l].y),3===i&&this._mesh._texCoords[0].push(g[l].z)):(this._mesh._texCoords[0].push(a/c),this._mesh._texCoords[0].push(b/d)),h&&(this._mesh._colors[0].push(h[l].r),this._mesh._colors[0].push(h[l].g),this._mesh._colors[0].push(h[l].b),4===k&&this._mesh._colors[0].push(h[l].a)),l++;for(b=1;d>=b;b++)for(a=0;c>a;a++)this._mesh._indices[0].push((b-1)*(c+1)+a),this._mesh._indices[0].push(b*(c+1)+a),this._mesh._indices[0].push((b-1)*(c+1)+a+1),this._mesh._indices[0].push(b*(c+1)+a),this._mesh._indices[0].push(b*(c+1)+a+1),this._mesh._indices[0].push((b-1)*(c+1)+a+1);f||this._mesh.calcNormals(Math.PI,this._vf.ccw),this.invalidateVolume(),this._mesh._numTexComponents=i,this._mesh._numColComponents=k,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(a){var b=null;if(this._cf.normal.node&&(b=this._cf.normal.node._vf.vector),"height"==a){var c,d=this._mesh._positions[0].length/3,e=this._vf.height;for(c=0;d>c;c++)this._mesh._positions[0][3*c+1]=e[c];b||(this._mesh._normals[0]=[],this._mesh.calcNormals(Math.PI,this._vf.ccw)),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0,b||(a._dirty.normals=!0),a.invalidateVolume()})}}})),x3dom.registerNodeType("Extrusion","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.Extrusion.superClass.call(this,a),this.addField_SFBool(a,"beginCap",!0),this.addField_SFBool(a,"endCap",!0),this.addField_SFBool(a,"convex",!0),this.addField_SFFloat(a,"creaseAngle",0),this.addField_MFVec2f(a,"crossSection",[new x3dom.fields.SFVec2f(1,1),new x3dom.fields.SFVec2f(1,-1),new x3dom.fields.SFVec2f(-1,-1),new x3dom.fields.SFVec2f(-1,1),new x3dom.fields.SFVec2f(1,1)]),this.addField_MFRotation(a,"orientation",[new x3dom.fields.Quaternion(0,0,0,1)]),this.addField_MFVec2f(a,"scale",[new x3dom.fields.SFVec2f(1,1)]),this.addField_MFVec3f(a,"spine",[new x3dom.fields.SFVec3f(0,0,0),new x3dom.fields.SFVec3f(0,1,0)]),this.addField_SFFloat(a,"height",0),this.rebuildGeometry()},{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var a,b,c,d,e,f=1,g=1,h=this._vf.spine,i=this._vf.scale,j=this._vf.orientation,k=this._vf.crossSection,l=[],m=0;d=h.length,c=k.length,this._vf.height>0&&(h[0]=new x3dom.fields.SFVec3f(0,0,0),h[1]=new x3dom.fields.SFVec3f(0,this._vf.height,0),d=2);var n,o,p,q=new x3dom.fields.SFVec3f(0,0,1);if(d>2)for(a=1;d-1>a;a++){var r=h[a+1].subtract(h[a]).cross(h[a-1].subtract(h[a]));if(r.length()>x3dom.fields.Eps){q=x3dom.fields.SFVec3f.copy(r.normalize());break}}var s=0,t=[0];for(a=1;d>a;a++){var u=h[a].subtract(h[a-1]).length();s+=u,t[a]=s}var v=0,w=[0],x=0,y=0,z=0,A=0;for(b=1;c>b;b++){var B=k[b].subtract(k[b-1]).length();v+=B,w[b]=v,1==b&&(x=y=k[b-1].x,z=A=k[b-1].y),x<k[b].x&&(x=k[b].x),y>k[b].x&&(y=k[b].x),z<k[b].y&&(z=k[b].y),A>k[b].y&&(A=k[b].y)}if(Math.abs(x-y)<Math.abs(z-A)){var C=x,D=y;x=z,y=A,z=C,A=D}var E=Math.abs(x-y),F=Math.abs(z-A),G=d>2?h[0].equals(h[h.length-1],x3dom.fields.Eps):!1;for(a=0;d>a;a++){for((e=i.length)>0&&(e>a?(f=i[a].x,g=i[a].y):(f=i[e-1].x,g=i[e-1].y)),b=0;c>b;b++){var H=new x3dom.fields.SFVec3f(k[b].x*f+h[a].x,h[a].y,k[b].y*g+h[a].z);if(d>2){0==a?(G?(o=h[1].subtract(h[d-2]),p=h[1].subtract(h[0]).cross(h[d-2].subtract(h[0]))):(o=h[1].subtract(h[0]),p=h[2].subtract(h[1]).cross(h[0].subtract(h[1]))),p.length()>x3dom.fields.Eps&&(q=x3dom.fields.SFVec3f.copy(p))):a==d-1?G?(o=h[1].subtract(h[d-2]),p=h[1].subtract(h[0]).cross(h[d-2].subtract(h[0]))):(o=h[d-1].subtract(h[d-2]),p=x3dom.fields.SFVec3f.copy(q)):(o=h[a+1].subtract(h[a-1]),p=o.cross(h[a-1].subtract(h[a]))),p.dot(q)<0&&(p=p.negate()),o=o.normalize(),p=p.normalize(),p.length()<=x3dom.fields.Eps&&(p=x3dom.fields.SFVec3f.copy(q)),0!=a&&(q=x3dom.fields.SFVec3f.copy(p)),n=o.cross(p).normalize();var I=x3dom.fields.SFMatrix4f.identity();I.setValue(n,o,p);var J=a<j.length?j[a].toMatrix():j.length>0?j[j.length-1].toMatrix():x3dom.fields.SFMatrix4f.identity();H=H.subtract(h[a]),H=I.multMatrixPnt(J.multMatrixPnt(H)),H=H.add(h[a])}if(H.crossSection=k[b],l.push(H),this._vf.creaseAngle<=x3dom.fields.Eps){if(a>0&&b>0){var K=(a-1)*c+(b-1);
this._mesh._positions[0].push(l[K].x,l[K].y,l[K].z),this._mesh._texCoords[0].push(w[b-1]/v,t[a-1]/s),K=(a-1)*c+b,this._mesh._positions[0].push(l[K].x,l[K].y,l[K].z),this._mesh._texCoords[0].push(w[b]/v,t[a-1]/s),K=a*c+b,this._mesh._positions[0].push(l[K].x,l[K].y,l[K].z),this._mesh._texCoords[0].push(w[b]/v,t[a]/s),this._mesh._indices[0].push(m++,m++,m++),this._mesh._positions[0].push(l[K].x,l[K].y,l[K].z),this._mesh._texCoords[0].push(w[b]/v,t[a]/s),K=a*c+(b-1),this._mesh._positions[0].push(l[K].x,l[K].y,l[K].z),this._mesh._texCoords[0].push(w[b-1]/v,t[a]/s),K=(a-1)*c+(b-1),this._mesh._positions[0].push(l[K].x,l[K].y,l[K].z),this._mesh._texCoords[0].push(w[b-1]/v,t[a-1]/s),this._mesh._indices[0].push(m++,m++,m++)}}else this._mesh._positions[0].push(H.x,H.y,H.z),this._mesh._texCoords[0].push(w[b]/v,t[a]/s),a>0&&b>0&&(this._mesh._indices[0].push((a-1)*c+(b-1),(a-1)*c+b,a*c+b),this._mesh._indices[0].push(a*c+b,a*c+(b-1),(a-1)*c+(b-1)))}if(a==d-1){var L,M,N,O,P;if(this._vf.beginCap){for(O=new x3dom.DoublyLinkedList,M=this._mesh._positions[0].length/3,b=0;c>b;b++)O.appendNode(new x3dom.DoublyLinkedList.ListNode(l[b],b)),this._vf.creaseAngle>x3dom.fields.Eps&&(L=l[b],this._mesh._positions[0].push(L.x,L.y,L.z),this._mesh._texCoords[0].push((L.crossSection.x-y)/E,(L.crossSection.y-A)/F));for(P=x3dom.EarClipping.getIndexes(O),b=P.length-1;b>=0;b--)this._vf.creaseAngle>x3dom.fields.Eps?this._mesh._indices[0].push(M+P[b]):(L=l[P[b]],this._mesh._positions[0].push(L.x,L.y,L.z),this._mesh._texCoords[0].push((L.crossSection.x-y)/E,(L.crossSection.y-A)/F),this._mesh._indices[0].push(m++))}if(this._vf.endCap){for(O=new x3dom.DoublyLinkedList,N=(d-1)*c,M=this._mesh._positions[0].length/3,b=0;c>b;b++)O.appendNode(new x3dom.DoublyLinkedList.ListNode(l[N+b],N+b)),this._vf.creaseAngle>x3dom.fields.Eps&&(L=l[N+b],this._mesh._positions[0].push(L.x,L.y,L.z),this._mesh._texCoords[0].push((L.crossSection.x-y)/E,(L.crossSection.y-A)/F));for(P=x3dom.EarClipping.getIndexes(O),b=0;b<P.length;b++)this._vf.creaseAngle>x3dom.fields.Eps?this._mesh._indices[0].push(M+(P[b]-N)):(L=l[P[b]],this._mesh._positions[0].push(L.x,L.y,L.z),this._mesh._texCoords[0].push((L.crossSection.x-y)/E,(L.crossSection.y-A)/F),this._mesh._indices[0].push(m++))}}}this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(a){("beginCap"==a||"endCap"==a||"crossSection"==a||"orientation"==a||"scale"==a||"spine"==a||"height"==a||"creaseAngle"==a)&&(this.rebuildGeometry(),Array.forEach(this._parentNodes,function(a){a.setAllDirty(),a.invalidateVolume()}))}})),x3dom.registerNodeType("HAnimDisplacer","H-Anim",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.HAnimDisplacer.superClass.call(this,a),this.addField_SFString(a,"name",""),this.addField_SFFloat(a,"weight",0),this.addField_MFInt32(a,"coordIndex",[]),this.addField_MFVec3f(a,"displacements",[]),x3dom.debug.logWarning("HAnimDisplacer NYI!")})),x3dom.registerNodeType("HAnimJoint","H-Anim",defineClass(x3dom.nodeTypes.Transform,function(a){x3dom.nodeTypes.HAnimJoint.superClass.call(this,a),this.addField_SFString(a,"name",""),this.addField_MFNode("displacers",x3dom.nodeTypes.HAnimDisplacer),this.addField_SFRotation(a,"limitOrientation",0,0,1,0),this.addField_MFFloat(a,"llimit",[]),this.addField_MFFloat(a,"ulimit",[]),this.addField_MFInt32(a,"skinCoordIndex",[]),this.addField_MFFloat(a,"skinCoordWeight",[])})),x3dom.registerNodeType("HAnimSegment","H-Anim",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.HAnimSegment.superClass.call(this,a),this.addField_SFString(a,"name",""),this.addField_SFVec3f(a,"centerOfMass",0,0,0),this.addField_SFFloat(a,"mass",0),this.addField_MFFloat(a,"momentsOfInertia",[0,0,0,0,0,0,0,0,0]),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_MFNode("displacers",x3dom.nodeTypes.HAnimDisplacer)},{})),x3dom.registerNodeType("HAnimSite","H-Anim",defineClass(x3dom.nodeTypes.Transform,function(a){x3dom.nodeTypes.HAnimSite.superClass.call(this,a),this.addField_SFString(a,"name","")})),x3dom.registerNodeType("HAnimHumanoid","H-Anim",defineClass(x3dom.nodeTypes.Transform,function(a){x3dom.nodeTypes.HAnimHumanoid.superClass.call(this,a),this.addField_SFString(a,"name",""),this.addField_SFString(a,"version",""),this.addField_MFString(a,"info",[]),this.addField_MFNode("joints",x3dom.nodeTypes.HAnimJoint),this.addField_MFNode("segments",x3dom.nodeTypes.HAnimSegment),this.addField_MFNode("sites",x3dom.nodeTypes.HAnimSite),this.addField_MFNode("skeleton",x3dom.nodeTypes.HAnimJoint),this.addField_MFNode("skin",x3dom.nodeTypes.X3DChildNode),this.addField_MFNode("skinCoord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_MFNode("skinNormal",x3dom.nodeTypes.X3DNormalNode),this.addField_MFNode("viewpoints",x3dom.nodeTypes.HAnimSite)},{})),x3dom.Moveable=function(a,b,c,d,e){this._x3domRoot=a,this._runtime=a.runtime,this._callback=c,this._gridSize=d?d:0,this._moveable=b,this._drag=!1,this._w=0,this._h=0,this._uPlane=null,this._vPlane=null,this._pPlane=null,this._isect=null,this._translationOffset=null,this._rotationOffset=null,this._scaleOffset=null,this._lastX=0,this._lastY=0,this._buttonState=0,this._mode=e&&e.length?e.toLowerCase():"translation",this._firstRay=null,this._matrixTrafo=null,this._navType="examine",this.attachHandlers()},x3dom.Moveable.prototype.setGridSize=function(a){this._gridSize=a},x3dom.Moveable.prototype.setMode=function(a){this._mode=a.toLowerCase()},x3dom.Moveable.prototype.attachHandlers=function(){this._moveable._iMove=this,this._x3domRoot._iMove||(this._x3domRoot._iMove=[]),this._x3domRoot._iMove.push(this),this._moveable.addEventListener("mousedown",this.start,!1),this._moveable.addEventListener("mouseover",this.over,!1),this._moveable.addEventListener("mouseout",this.out,!1),1==this._x3domRoot._iMove.length&&(this._x3domRoot.addEventListener("mouseup",this.stop,!1),this._x3domRoot.addEventListener("mouseout",this.stop,!1),this._x3domRoot.addEventListener("mousemove",this.move,!0),this._runtime.canvas.disableTouch||(this._x3domRoot.addEventListener("MozTouchDown",this.touchStartHandlerMoz,!1),this._x3domRoot.addEventListener("MozTouchMove",this.touchMoveHandlerMoz,!0),this._x3domRoot.addEventListener("MozTouchUp",this.touchEndHandlerMoz,!1),this._x3domRoot.addEventListener("touchstart",this.touchStartHandler,!1),this._x3domRoot.addEventListener("touchmove",this.touchMoveHandler,!0),this._x3domRoot.addEventListener("touchend",this.touchEndHandler,!1)))},x3dom.Moveable.prototype.detachHandlers=function(){var a=this._x3domRoot._iMove;if(a)for(var b=0,c=a.length;c>b;b++)if(a[b]==this){a.splice(b,1);break}this._moveable.removeEventListener("mousedown",this.start,!1),this._moveable.removeEventListener("mouseover",this.over,!1),this._moveable.removeEventListener("mouseout",this.out,!1),0==a.length&&(this._x3domRoot.removeEventListener("mouseup",this.stop,!1),this._x3domRoot.removeEventListener("mouseout",this.stop,!1),this._x3domRoot.removeEventListener("mousemove",this.move,!0),this._runtime.canvas.disableTouch||(this._x3domRoot.removeEventListener("MozTouchDown",this.touchStartHandlerMoz,!1),this._x3domRoot.removeEventListener("MozTouchMove",this.touchMoveHandlerMoz,!0),this._x3domRoot.removeEventListener("MozTouchUp",this.touchEndHandlerMoz,!1),this._x3domRoot.removeEventListener("touchstart",this.touchStartHandler,!1),this._x3domRoot.removeEventListener("touchmove",this.touchMoveHandler,!0),this._x3domRoot.removeEventListener("touchend",this.touchEndHandler,!1))),this._moveable._iMove&&delete this._moveable._iMove},x3dom.Moveable.prototype.calcViewPlane=function(a){this._w=this._runtime.getWidth(),this._h=this._runtime.getHeight();var b=this._runtime.getViewingRay(0,this._h-1),c=b.pos.add(b.dir);b=this._runtime.getViewingRay(this._w-1,this._h-1);var d=b.pos.add(b.dir);b=this._runtime.getViewingRay(0,0);var e=b.pos.add(b.dir);this._uPlane=d.subtract(c).normalize(),this._vPlane=e.subtract(c).normalize(),this._pPlane=0===arguments.length?c:x3dom.fields.SFVec3f.copy(a)},x3dom.Moveable.prototype.det=function(a){return a[0][0]*a[1][1]*a[2][2]+a[0][1]*a[1][2]*a[2][0]+a[0][2]*a[2][1]*a[1][0]-a[2][0]*a[1][1]*a[0][2]-a[0][0]*a[2][1]*a[1][2]-a[1][0]*a[0][1]*a[2][2]},x3dom.Moveable.prototype.translateXY=function(a){for(var b=null,c=[],d=[],e=0;3>e;e++)c[e]=[],d[e]=[],c[e][0]=this._uPlane.at(e),d[e][0]=c[e][0],c[e][1]=this._vPlane.at(e),d[e][1]=c[e][1],c[e][2]=a.pos.subtract(this._pPlane).at(e),d[e][2]=-a.dir.at(e);var f=this.det(d);if(0!==f){var g=this.det(c)/f;b=a.pos.addScaled(a.dir,g)}return b&&(this._isect&&(b=b.subtract(this._isect)),b=b.add(this._translationOffset)),b},x3dom.Moveable.prototype.translateZ=function(a,b){var c=this._runtime.getSceneBBox(),d=b<this._lastY?1:-1,e=d*c.max.subtract(c.min).length()/100;return this._translationOffset=this._translationOffset.addScaled(a.dir,e),this._translationOffset},x3dom.Moveable.prototype.rotate=function(a,b){var c=2*Math.PI,d=(b-this._lastY)*c/this._w,e=(a-this._lastX)*c/this._h,f=x3dom.fields.Quaternion.axisAngle(this._uPlane,d),g=f.toMatrix();this._rotationOffset=g.mult(this._rotationOffset),f=x3dom.fields.Quaternion.axisAngle(this._vPlane,e),g=f.toMatrix(),this._rotationOffset=g.mult(this._rotationOffset);var h=this._rotationOffset.mult(x3dom.fields.SFMatrix4f.scale(this._scaleOffset)),i=new x3dom.fields.Quaternion(0,0,1,0);return i.setValue(h),i},x3dom.Moveable.prototype.over=function(){var a=this._iMove;a._runtime.getCanvas().style.cursor="crosshair"},x3dom.Moveable.prototype.out=function(){var a=this._iMove;a._drag||(a._runtime.getCanvas().style.cursor="pointer")},x3dom.Moveable.prototype.start=function(a){var b=this._iMove;switch(b._mode){case"translation":b._buttonState=4==a.button?1:3&a.button;break;case"rotation":b._buttonState=4;break;case"all":default:b._buttonState=a.button}if(!b._drag&&b._buttonState){b._lastX=a.layerX,b._lastY=a.layerY,b._drag=!0,b._navType=b._runtime.navigationType(),b._runtime.noNav(),b._isect=new x3dom.fields.SFVec3f(a.worldX,a.worldY,a.worldZ),b.calcViewPlane(b._isect),b._firstRay=b._runtime.getViewingRay(a.layerX,a.layerY);var c=b._moveable.getAttribute("translation");if(b._matrixTrafo=null,c){b._translationOffset=x3dom.fields.SFVec3f.parse(c);var d=b._moveable.getAttribute("rotation");d=d?x3dom.fields.Quaternion.parseAxisAngle(d):new x3dom.fields.Quaternion(0,0,1,0),b._rotationOffset=d.toMatrix();var e=b._moveable.getAttribute("scale");b._scaleOffset=e?x3dom.fields.SFVec3f.parse(e):new x3dom.fields.SFVec3f(1,1,1)}else if(c=b._moveable.getAttribute("matrix")){b._matrixTrafo=x3dom.fields.SFMatrix4f.parse(c).transpose();var f=new x3dom.fields.SFVec3f(0,0,0),g=new x3dom.fields.SFVec3f(1,1,1),h=new x3dom.fields.Quaternion(0,0,1,0),i=new x3dom.fields.Quaternion(0,0,1,0);b._matrixTrafo.getTransform(f,h,g,i),b._translationOffset=f,b._rotationOffset=h.toMatrix(),b._scaleOffset=g}else b._translationOffset=new x3dom.fields.SFVec3f(0,0,0),b._rotationOffset=new x3dom.fields.SFMatrix4f,b._scaleOffset=new x3dom.fields.SFVec3f(1,1,1);b._runtime.getCanvas().style.cursor="crosshair"}},x3dom.Moveable.prototype.move=function(a){for(var b=0,c=this._iMove.length;c>b;b++){var d=this._iMove[b];if(d._drag){var e=d._runtime.mousePosition(a),f=d._runtime.getViewingRay(e[0],e[1]),g=null;if(g=2==d._buttonState?d.translateZ(d._firstRay,e[1]):1==d._buttonState?d.translateXY(f):d.rotate(e[0],e[1])){if(d._gridSize>0&&4!=d._buttonState){var h=d._gridSize*Math.round(g.x/d._gridSize),i=d._gridSize*Math.round(g.y/d._gridSize),j=d._gridSize*Math.round(g.z/d._gridSize);g=new x3dom.fields.SFVec3f(h,i,j)}d._matrixTrafo?(4==d._buttonState?d._matrixTrafo.setRotate(g):d._matrixTrafo.setTranslate(g),d._moveable.setAttribute("matrix",d._matrixTrafo.toGL().toString())):4==d._buttonState?d._moveable.setAttribute("rotation",g.toAxisAngle().toString()):d._moveable.setAttribute("translation",g.toString()),d._callback&&d._callback(d._moveable,g)}d._lastX=e[0],d._lastY=e[1]}}},x3dom.Moveable.prototype.stop=function(a){for(var b=0,c=this._iMove.length;c>b;b++){var d=this._iMove[b];if(d._drag){d._lastX=a.layerX,d._lastY=a.layerY,d._isect=null,d._drag=!1;var e=d._runtime.canvas.doc._scene.getNavigationInfo();e.setType(d._navType),d._runtime.getCanvas().style.cursor="pointer"}}},x3dom.Moveable.prototype.touchStartHandler=function(a){a.preventDefault()},x3dom.Moveable.prototype.touchStartHandlerMoz=function(a){a.preventDefault()},x3dom.Moveable.prototype.touchMoveHandler=function(a){a.preventDefault()},x3dom.Moveable.prototype.touchMoveHandlerMoz=function(a){a.preventDefault()},x3dom.Moveable.prototype.touchEndHandler=function(a){if(this._iMove.length){var b=this._iMove[0];b.stop.apply(b._x3domRoot,[a])}a.preventDefault()},x3dom.Moveable.prototype.touchEndHandlerMoz=function(a){if(this._iMove.length){var b=this._iMove[0];b.stop.apply(b._x3domRoot,[a])}a.preventDefault()},x3dom.docs={},x3dom.docs.specURLMap={CADGeometry:"CADGeometry.html",Core:"core.html",DIS:"dis.html",CubeMapTexturing:"env_texture.html",EnvironmentalEffects:"enveffects.html",EnvironmentalSensor:"envsensor.html",Followers:"followers.html",Geospatial:"geodata.html",Geometry2D:"geometry2D.html",Geometry3D:"geometry3D.html",Grouping:"group.html","H-Anim":"hanim.html",Interpolation:"interp.html",KeyDeviceSensor:"keyboard.html",Layering:"layering.html",Layout:"layout.html",Lighting:"lighting.html",Navigation:"navigation.html",Networking:"networking.html",NURBS:"nurbs.html",ParticleSystems:"particle_systems.html",Picking:"picking.html",PointingDeviceSensor:"pointingsensor.html",Rendering:"rendering.html",RigidBodyPhysics:"rigid_physics.html",Scripting:"scripting.html",Shaders:"shaders.html",Shape:"shape.html",Sound:"sound.html",Text:"text.html",Texturing3D:"texture3D.html",Texturing:"texturing.html",Time:"time.html",EventUtilities:"utils.html",VolumeRendering:"volume.html"},x3dom.docs.specBaseURL="http://www.web3d.org/x3d/specifications/ISO-IEC-19775-1.2-X3D-AbstractSpecification/Part01/components/",x3dom.docs.getNodeTreeInfo=function(){var a,b,c="",d=function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return!0;return!1},e=function(a,b){for(var d=0;b>d;d++)c+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";c+="<a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[x3dom.nodeTypes[a]._compName]+"#"+a+"' style='color:black; text-decoration:none; font-weight:bold;'>"+a+"</a> &nbsp; <a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[x3dom.nodeTypes[a]._compName]+"' style='color:black; text-decoration:none; font-style:italic;'>"+x3dom.nodeTypes[a]._compName+"</a><br/>";for(var d in x3dom.nodeTypes[a].childTypes[a])e(x3dom.nodeTypes[a].childTypes[a][d],b+1)};for(a in x3dom.nodeTypes){var b=x3dom.nodeTypes[a];for(void 0===b.childTypes&&(b.childTypes={});b.superClass;)void 0===b.superClass.childTypes[b.superClass._typeName]&&(b.superClass.childTypes[b.superClass._typeName]=[]),d(b.superClass.childTypes[b.superClass._typeName],b._typeName)||b.superClass.childTypes[b.superClass._typeName].push(b._typeName),b=b.superClass}return e("X3DNode",0),"<div class='x3dom-doc-nodes-tree'>"+c+"</div>"},x3dom.docs.getComponentInfo=function(){var a,b,c,d=[],e="";for(b in x3dom.components)d.push(b);d.sort();for(c in d){b=d[c],a=x3dom.components[b],e+="<h2><a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[b]+"' style='color:black; text-decoration:none; font-style:italic;'>"+b+"</a></h2>",e+="<ul style='list-style-type:circle;'>";for(var f in a)e+="<li><a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[b]+"#"+f+"' style='color:black; text-decoration:none; font-weight:bold;'>"+f+"</a></li>";e+="</ul>"}return e},x3dom.versionInfo={version:"1.6.0-dev",revision:"fa599b611f4a3dc0d32ecf6dd20fad6bf3390fee",date:"Tue Dec 10 16:10:30 2013 +0100"};