define(["virtualglobeviewer/GlobWeb","virtualglobeviewer/RenderContext","virtualglobeviewer/SceneGraph/SceneGraph","virtualglobeviewer/SceneGraph/Renderer","virtualglobeviewer/W3DSLayer","virtualglobeviewer/TileWireframeLayer","./glTFLoader","openlayers"],function(a,b,c,d,e,f,g){"use strict";function h(h){if(this.canvas=$(h.canvas),!this.canvas)return alert("[Globe::constructor] Please define a canvas element!. Aborting Globe construction..."),void 0;b.minNear=1e-4,this.globe=new a.Globe({canvas:h.canvas,lighting:!1,tileErrorTreshold:3,continuousRendering:!1,backgroundColor:[.2,.2,.2,1],shadersPath:"/bower_components/virtualglobeviewer/shaders/"}),this.aoiLayer=void 0,this.layerCache={},this.overlayLayers=[],this.navigation=new a.Navigation(this.globe,{inertia:!0});var i=new a.WCSElevationLayer({baseUrl:"http://data.eox.at/elevation?",coverage:"ACE2",version:"2.0.0"});this.globe.setBaseElevation(i);var j,k=this.globe.renderContext,l=Object.create(g);l.initWithPath("/data/vcurtains/vrvis-demo/vrvis-demo.json");var m=function(a,c){j=new d(k,c,{minNear:b.minNear,far:6,fov:45,enableAlphaBlending:!0}),k.addRenderer(j)};l.load({rootObj:new c.Node},m),new e({baseUrl:"http://localhost:9000/ows?",layer:"adm_aeolus",format:"model/gltf",matrixSet:"WGS84",opacity:.7}),this.globe.addLayer(new f({outline:!0}));var n=new a.WMSLayer({baseUrl:"http://demonstrator.telespazio.com/wmspub",layers:"BlueMarble"});this.globe.setBaseImagery(n)}var i=function(a,b){for(var c=a.getVertices(),d=[],e=0;e<c.length;++e){var f=[];f.push(c[e].x),f.push(c[e].y),f.push(b),d.push(f)}var f=[];return f.push(c[0].x),f.push(c[0].y),f.push(b),d.push(f),d};return h.prototype.addAreaOfInterest=function(b){if(this.aoiLayer||(this.aoiLayer=new a.VectorLayer({style:c,opacity:1}),this.globe.addLayer(this.aoiLayer)),b){var c=new a.FeatureStyle({fillColor:[1,.5,.1,.5],strokeColor:[1,.5,.1,1],extrude:!0,fill:!0}),d=3e4,e=i(b,d),f={geometry:{type:"Polygon",coordinates:e},properties:{style:c}};this.aoiLayer.addFeature(f)}},h.prototype.createCommonLayerOptionsFromModel=function(a){var b={};b.baseUrl=a.get("view").urls[0],b.style="",a.get("view").style&&(b.style=a.get("view").style);var c=a.get("view").id;return"WMS"===a.get("view").protocol?b.layers=c:b.layer=c,b.format=a.get("view").format||"image/jpeg",a.get("time")&&(b.time=a.get("time")),a.get("time")&&(b.time=a.get("time")),"image/png"===b.format&&(b.transparent=!0),b},h.prototype.addLayer=function(b,c){var d=this.layerCache[b.get("name")],e=void 0;if("undefined"==typeof d){var f=this.createCommonLayerOptionsFromModel(b);if("WMTS"===b.get("view").protocol){var g=_.extend(f,{matrixSet:b.get("view").matrixSet});e=new a.WMTSLayer(g)}else"WMS"===b.get("view").protocol&&(e=new a.WMSLayer(f));e.opacity(b.get("opacity")),d={model:b,layer:e,isBaseLayer:c},this.layerCache[b.get("name")]=d,console.log('[Globe.addLayer] added layer "'+b.get("name")+'" to the cache.')}else e=d.layer,console.log('[Globe.addLayer] retrieved layer "'+b.get("name")+'" from the cache.');c?this.globe.setBaseImagery(e):(this.globe.addLayer(e),this.overlayLayers.push(d))},h.prototype.sortOverlayLayers=function(){var a=_.sortBy(this.overlayLayers,function(a){return a.model.get("ordinal")});this.removeAllOverlays(),_.each(a,function(a){console.log("sort: adding layer with ordinal: "+a.model.get("ordinal")),this.addLayer(a.model,a.isBaseLayer)}.bind(this))},h.prototype.removeAllOverlays=function(){_.each(this.overlayLayers,function(a){this.globe.removeLayer(a.layer)}.bind(this)),this.overlayLayers.length=0},h.prototype.removeLayer=function(a,b){if(console.log("removeLayer: "+a.get("name")+" (baseLayer: "+b+")"),b)this.globe.setBaseImagery(null);else{var c=this.layerCache[a.get("name")];if("undefined"!=typeof c){this.globe.removeLayer(c.layer);var d=_.indexOf(this.overlayLayers,c);this.overlayLayers.splice(d,1)}}},h.prototype.clearCache=function(){this.layerCache={}},h.prototype.updateViewport=function(){this.globe.renderContext.canvas.width=this.canvas.width(),this.globe.renderContext.canvas.height=this.canvas.height(),this.globe.renderContext.updateViewDependentProperties(),this.globe.refresh()},h.prototype.zoomTo=function(a){this.navigation.zoomTo(a.center,a.distance,a.duration,a.tilt)},h.prototype.onOpacityChange=function(a,b){var c=this.layerCache[a];"undefined"!=typeof c&&c.layer.opacity(b)},h.prototype.dumpLayerConfig=function(){_.each(this.overlayLayers,function(a){console.log("-------------------------------------------------"),console.log("Layer: "+a.model.get("name")),console.log("   ordinal: "+a.model.get("ordinal")),console.log("   opacity: "+a.layer.opacity())}.bind(this))},h});