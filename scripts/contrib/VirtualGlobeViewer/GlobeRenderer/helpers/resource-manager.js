var global=window;!function(a,b){"object"==typeof exports?(module.exports=b(global),module.exports.ResourceManager=module.exports):"function"==typeof define&&define.amd?define([],function(){return b(a)}):b(a)}(this,function(a){"use strict";var b=Object.create(Object,{kind:{value:"multi-parts",writable:!0},range:{value:null,writable:!0},_requests:{value:null,writable:!0},requests:{get:function(){return this._requests},set:function(a){this._requests=a}},canMergeRequest:{value:function(a,b){var c=a.range[1]-a.range[0],d=this.range[1]-this.range[0];return c+d>b?!1:(a.range[0]===this.range[1]||a.range[1]===this.range[0])&&a.type===this.type}},mergeRequest:{value:function(a){0===this.requests.length?(this.requests.push(a),this.range=[a.range[0],a.range[1]]):a.range[0]===this.range[1]?(this.requests.push(a),this.range[1]=a.range[1]):a.range[1]===this.range[0]?(this.requests.unshift(a),this.range[0]=a.range[0]):console.log("ERROR: should not reach")}},mergeRequests:{value:function(a){if(this.range)if(a[0].range[1]<this.range[0])for(var b=a.length-1;b>=0;b--)this.mergeRequest(a[b]);else for(var b=0;b<a.length;b++)this.mergeRequest(a[b]);else a.forEach(function(a){this.mergeRequest(a)},this)}},id:{value:null,writable:!0},initWithRequests:{value:function(a){return this.requests=[],this.mergeRequests(a),this.id=a[0].id,this}}}),c=Object.create(Object,{_content:{value:null,writable:!0},content:{get:function(){return this._content},set:function(a){this._content=a}},_parent:{value:null,writable:!0},parent:{get:function(){return this._parent},set:function(a){this._parent=a}},_left:{value:null,writable:!0},left:{get:function(){return this._left},set:function(a){this._left=a}},_right:{value:null,writable:!0},right:{get:function(){return this._right},set:function(a){this._right=a}},_checkConsistency:{value:function(a){a.length>=50||(this.left&&this.left._checkConsistency(a),a.push(this.content.range),this.right&&this.right._checkConsistency(a))}},checkConsistency:{value:function(){var a=[];if(this._checkConsistency(a),a.length>1)for(var b=0;b<a.length-1;b++){var c=a[0],d=a[1];c[1]<=d[0]||console("ERROR: INCONSISTENCY CHECK Failed, ranges are not ordered in btree")}}},_collect:{value:function(a,b){this.left&&this.left._collect(a,b),a.length>=b||(a.push(this),this.right&&this.right._collect(a,b))}},collect:{value:function(a){var b=[];return this._collect(b,a),b}},insert:{value:function(a,b){if(a.range[1]<=this.content.range[0]){if(a.range[1]===this.content.range[0])return"multi-parts"===a.kind?this.content.mergeRequests(a.requests):this.content.mergeRequests(a),this.left&&this.content.canMergeRequest(this.left.content,b)&&(this.content.mergeRequests(this.left.content._requests),this.left.remove(this.left.content)),this.parent&&this.parent.content.canMergeRequest(this.content,b)&&(this.parent.content.mergeRequests(this.content._requests),this.remove(this.content)),null;if(this.left)return this.left.insert(a,b);var d=Object.create(c);return d.parent=this,d.content=a,this.left=d,d}if(a.range[0]>=this.content.range[1]){if(a.range[0]===this.content.range[1])return"multi-parts"===a.kind?this.content.mergeRequests(a.requests):this.content.mergeRequests(a),this.right&&this.content.canMergeRequest(this.right.content,b)&&(this.content.mergeRequests(this.right.content._requests),this.right.remove(this.right.content)),this.parent&&this.parent.content.canMergeRequest(this.content,b)&&(this.parent.content.mergeRequests(this.content._requests),this.remove(this.content)),null;if(this.right)return this.right.insert(a,b);var d=Object.create(c);return d.parent=this,d.content=a,this.right=d,d}console.log("ERROR: should not reach")}},contains:{value:function(a){return this.node===a?!0:this.left&&this.left.contains(a)?!0:this.right&&this.right.contains(a)?!0:!1}},min:{value:function(){for(var a=this;a.left;)a=a.left;return a}},_updateParentWithNode:{value:function(a){this.parent&&(this===this.parent.left?this.parent.left=a:this.parent.right=a),a&&(a.parent=this.parent)}},removeMin:{value:function(){this.parent;for(var a=this;a.left||a.right;)a.left&&(a=a.min()),a.right&&(a=a.right.min());return a._updateParentWithNode(null),a}},remove:{value:function(a){if(a.range[1]<=this.content.range[0])this.left.remove(a);else if(a.range[0]>=this.content.range[1])this.right.remove(a);else if(a===this.content)if(this.left&&this.right){var b=this.right.min();this.content=b.content,b._updateParentWithNode(b.right)}else this.left||this.right?this.left?this._updateParentWithNode(this.left):this._updateParentWithNode(this.right):this._updateParentWithNode(null)}}}),d=Object.create(Object,{MISSING_DESCRIPTION:{value:"MISSING_DESCRIPTION"},INVALID_PATH:{value:"INVALID_PATH"},INVALID_TYPE:{value:"INVALID_TYPE"},XMLHTTPREQUEST_STATUS_ERROR:{value:"XMLHTTPREQUEST_STATUS_ERROR"},NOT_FOUND:{value:"NOT_FOUND"},ARRAY_BUFFER:{value:"ArrayBuffer"},_resources:{value:null,writable:!0},_requestTrees:{value:null,writable:!0},requestTrees:{get:function(){return this._requestTrees}},_resourcesStatus:{value:null,writable:!0},_resourcesBeingProcessedCount:{value:0,writable:!0},_observers:{value:null,writable:!0},_maxConcurrentRequests:{value:1,writable:!0},observers:{get:function(){return this._observers},set:function(a){this._observers=a}},maxConcurrentRequests:{get:function(){return this._maxConcurrentRequests},set:function(a){this._maxConcurrentRequests=a}},reset:{value:function(){if(this._resourcesStatus){var a=Object.keys(this._resourcesStatus);a.forEach(function(a){var b=this._resourcesStatus[a];b&&b.xhr&&b.xhr.abort()},this)}this._resources={},this._requestTrees={},this._resourcesStatus={},this._resourcesBeingProcessedCount=0}},_bytesLimit:{value:5e5,writable:!0},bytesLimit:{get:function(){return this._bytesLimit},set:function(a){this._bytesLimit!==a&&(this._bytesLimit=a)}},_containsResource:{enumerable:!1,value:function(a){return this._resources[a]?!0:!1}},init:{value:function(a){this._requestTrees={},this._resources={},this._resourcesStatus={},this._observers=[],this._resourcesBeingProcessedCount=0,this._gltfData=a}},_getEntry:{value:function(a){return this._gltfData.getEntry(a)}},_storeResource:{enumerable:!1,value:function(a,b){return a?(this._containsResource[a]&&console.log("WARNING: resource:"+a+" is already stored, overriding"),this._resources[a]=b,void 0):(console.log("ERROR: entry does not contain id, cannot store"),void 0)}},_getResource:{enumerable:!1,value:function(a){return this._resources[a]}},_loadResource:{value:function(a,b){var c,e=this,f=a.path;if("multi-parts"===a.kind?(c=a.requests[0].type,f=a.requests[0].path):(c=a.type,f=a.path),!c)return b.handleError(d.INVALID_TYPE,null),void 0;if(!f)return b.handleError(d.INVALID_PATH),void 0;var g=new XMLHttpRequest;if(g.open("GET",f,!0),g.responseType=c===this.ARRAY_BUFFER?"arraybuffer":"text",a.range){var h="bytes="+a.range[0]+"-"+(a.range[1]-1);g.setRequestHeader("Range",h)}g.setRequestHeader("If-Modified-Since","Sat, 01 Jan 1970 00:00:00 GMT"),g.onload=function(){200==this.status||206==this.status?(e._resourcesBeingProcessedCount--,"multi-parts"===a.kind?a.requests.forEach(function(c){var d=this.response.slice(c.range[0]-a.range[0],c.range[1]-a.range[0]);b.resourceAvailable(e,c,d)},this):b.resourceAvailable(e,a,this.response)):b.handleError(d.XMLHTTPREQUEST_STATUS_ERROR,this.status)},g.send(null);var i=this._resourcesStatus[a.id];i&&(i.xhr=g)}},_processNextResource:{value:function(a){if(a){var b=!a.left&&!a.right;if(b)return this._handleRequest(a.content),!1;var c=a.removeMin();this._handleRequest(c.content)}return!0}},fireResourceAvailable:{value:function(a){this.observers&&this.observers.forEach(function(b){b.resourceAvailable&&b.resourceAvailable(a)},this)}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(a){var d=this._resourcesStatus[a.id],e=null,f=null,g=this.requestTrees?this.requestTrees[a.path]:null;if(d){if("loading"===d.status)return;e=d.node,f=d.status}if(this._resourcesBeingProcessedCount>=this.maxConcurrentRequests&&"ArrayBuffer"===a.type){if(!f){var h,i=null;if(h="multi-parts"===a.kind?Object.create(b).initWithRequests(a.requests):Object.create(b).initWithRequests([a]),g)i=g.insert(h,this.bytesLimit);else{var j=Object.create(c);j.content=h,this._requestTrees[a.path]=j,g=j,i=j}"multi-parts"===a.kind?a.requests.forEach(function(a){this._resourcesStatus[a.id]={status:"queued",node:i}},this):this._resourcesStatus[a.id]={status:"queued",node:i}}}else{var k=this,l={};"multi-parts"===a.kind?a.requests.forEach(function(a){this._resourcesStatus[a.id]={status:"loading"}},this):this._resourcesStatus[a.id]={status:"loading"},l.resourceAvailable=function(a,b,c){var d=b.delegate.convert(c,b.ctx);if(k._storeResource(b.id,d),b.delegate.resourceAvailable(d,b.ctx),delete k._resourcesStatus[b.id],k.fireResourceAvailable.call(k,b),k._resourcesBeingProcessedCount<k.maxConcurrentRequests){var e=a.requestTrees?a.requestTrees[b.path]:null;k._processNextResource(e)||e&&delete a.requestTrees[b.path]}},l.handleError=function(b,c){a.delegate.handleError(b,c)},k._resourcesBeingProcessedCount++,this._loadResource(a,l)}}},_elementSizeForGLType:{value:function(a){switch(a){case 5126:return Float32Array.BYTES_PER_ELEMENT;case 5123:return Uint16Array.BYTES_PER_ELEMENT;case 35664:return 2*Float32Array.BYTES_PER_ELEMENT;case 35665:return 3*Float32Array.BYTES_PER_ELEMENT;case 35666:return 4*Float32Array.BYTES_PER_ELEMENT;default:throw Error()}}},_handleWrappedBufferViewResourceLoading:{value:function(a,b,c){var d=this._getEntry(a.bufferView),e=this._getEntry(d.entryID).buffer,f=a.byteOffset+d.description.byteOffset,g=[f,this._elementSizeForGLType(a.type)*a.count+f];this._handleRequest({id:a.id,range:g,type:e.description.type,path:e.description.path,delegate:b,ctx:c,kind:"single-part"},null)}},shaderDelegate:{value:{handleError:function(a,b){console.log("ERROR:shaderDelegate:"+a+" :"+b)},convert:function(a){return a},resourceAvailable:function(a,b){if(b.sources[b.stage]=a,b.sources["x-shader/x-fragment"]&&b.sources["x-shader/x-vertex"]){var c=b.programCtx.delegate,d=c.convert(b.sources,b.programCtx.ctx);b.programCtx.resourceManager._storeResource(b.programCtx.id,d),c.resourceAvailable(d,b.programCtx.ctx)}}}},_handleProgramLoading:{value:function(a,b,c){var d={delegate:b,ctx:c,resourceManager:this,id:a.id},e={},f={stage:"x-shader/x-fragment",sources:e,programCtx:d},g={stage:"x-shader/x-vertex",sources:e,programCtx:d};this.getResource(a.description["x-shader/x-fragment"],this.shaderDelegate,f),this.getResource(a.description["x-shader/x-vertex"],this.shaderDelegate,g)}},_handleShaderLoading:{value:function(a,b,c){this._handleRequest({id:a.id,type:"text",path:a.description.path,delegate:b,ctx:c,kind:"single-part"},null)}},_handleImageLoading:{value:function(a,b,c){var d=this._resourcesStatus[a.id];if(!d||"loading"!==d.status){this._resourcesStatus[a.id]={status:"loading"};var e=this;if(a.description.path){var f=new Image;f.onload=function(){delete e._resourcesStatus[a.id],e._storeResource(a.id,f),b(f,a.id,c)},f.src=a.description.path}else a.description.image&&b(a.description.image,a.id,c)}}},_handleSampler2DLoading:{value:function(a,b,c){var d=this._resourcesStatus[a.id];if(!d||"loading"!==d.status){this._resourcesStatus[a.id]={status:"loading"};var e=this;a.description.image&&this._handleImageLoading(a.description.image,function(c,d,f){var g=f,h=b.convert(a,c);delete e._resourcesStatus[a.id],e._storeResource(a.id,h),b.resourceAvailable(h,g),e.fireResourceAvailable.call(e,a.id)},c)}}},getResource:{value:function(a,b,c){var d=this._getResource(a.id);return d?d:("program"===a.type?this._handleProgramLoading(a,b,c):"shader"===a.type?this._handleShaderLoading(a,b,c):"image"===a.type?this._handleImageLoading(a,b,c):"SAMPLER_2D"===a.type?this._handleSampler2DLoading(a,b,c):this._handleWrappedBufferViewResourceLoading(a,b,c),null)}},removeAllResources:{value:function(){this._resources={}}}});return a&&(a.ResourceManager=d),ResourceManager});